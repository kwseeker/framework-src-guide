<mxfile host="Electron" modified="2024-12-09T16:51:08.730Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="nkEk_-id_wXqa7EROPYD" version="21.6.5" type="device">
  <diagram name="第 1 页" id="Euxv3z7wh99awfAnfNUn">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="uPxwXOejs5hoWM0QN6wt-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;Mybatis 两级缓存工作原理&amp;nbsp;&lt;span style=&quot;font-weight: normal&quot;&gt;（3.5.9）&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;共有两级缓存，&lt;br&gt;一级缓存默认开启，默认作用范围是Session；&lt;br&gt;二级缓存默认关闭，作用范围是相同的命名空间(namespace)；&lt;/p&gt;&lt;p&gt;测试Demo: SpringBoot-Labs/mybatis/mybatis-cache。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="440" height="110" as="geometry" />
        </mxCell>
        <mxCell id="uPxwXOejs5hoWM0QN6wt-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uPxwXOejs5hoWM0QN6wt-2" target="uPxwXOejs5hoWM0QN6wt-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uPxwXOejs5hoWM0QN6wt-2" value="&lt;b&gt;CachingExecutor&lt;/b&gt;#&lt;b&gt;query&lt;/b&gt;(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uPxwXOejs5hoWM0QN6wt-3" target="yhzCpn97QrwA5I1gkQgs-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="730" y="240" />
              <mxPoint x="730" y="400" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-16" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-11" vertex="1" connectable="0">
          <mxGeometry x="0.8433" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uPxwXOejs5hoWM0QN6wt-3" target="yhzCpn97QrwA5I1gkQgs-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="730" y="240" />
              <mxPoint x="730" y="860" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-17" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-15" vertex="1" connectable="0">
          <mxGeometry x="0.9311" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uPxwXOejs5hoWM0QN6wt-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public &amp;lt;E&amp;gt; List&amp;lt;E&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;query&lt;/b&gt;(MappedStatement ms, Object parameterObject, &lt;br style=&quot;font-size: 10px;&quot;&gt;RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 参考MySQL整体流程图&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; BoundSql boundSql = ms.&lt;b style=&quot;font-size: 10px;&quot;&gt;getBoundSql&lt;/b&gt;(parameterObject);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 1 创建二级缓存的key&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; CacheKey key = this.&lt;b style=&quot;font-size: 10px;&quot;&gt;createCacheKey&lt;/b&gt;(ms, parameterObject, rowBounds, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 2 内部实现两级缓存操作&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b style=&quot;font-size: 10px;&quot;&gt;query&lt;/b&gt;(ms, parameterObject, rowBounds, resultHandler, key, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;BoundSql&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final String &lt;b style=&quot;font-size: 11px;&quot;&gt;sql&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final List&amp;lt;ParameterMapping&amp;gt; parameterMappings;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final Object parameterObject;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final Map&amp;lt;String, Object&amp;gt; additionalParameters;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final MetaObject metaParameters;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-480" y="160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;dashed=1;endArrow=block;endFill=1;fontSize=11;" parent="1" source="yhzCpn97QrwA5I1gkQgs-2" target="yhzCpn97QrwA5I1gkQgs-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;BaseExecutor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected Transaction &lt;b style=&quot;font-size: 11px;&quot;&gt;transaction&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected Executor wrapper;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ConcurrentLinkedQueue&amp;lt;DeferredLoad&amp;gt; deferredLoads;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected PerpetualCache localCache;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected PerpetualCache localOutputParameterCache;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected Configuration configuration;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected int queryStack;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean closed;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1440" y="280" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;fontSize=11;" parent="1" source="yhzCpn97QrwA5I1gkQgs-3" target="yhzCpn97QrwA5I1gkQgs-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;CachingExecutor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final Executor &lt;b style=&quot;font-size: 11px;&quot;&gt;delegate&lt;/b&gt;;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final TransactionalCacheManager &lt;b style=&quot;font-size: 11px;&quot;&gt;tcm&lt;/b&gt; = new TransactionalCacheManager();&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-960" y="160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;fontSize=11;" parent="1" source="yhzCpn97QrwA5I1gkQgs-4" target="yhzCpn97QrwA5I1gkQgs-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-4" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;SimpleExecutor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1440" y="520" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-7" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;Executor&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;接口方法分为SQL查询、更新（增删改）、事务（提交、回滚）、缓存（创建缓存Key、清理本地缓存&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial; font-size: 11px;&quot;&gt;）、连接等&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1440" y="160" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;CacheKey&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;参与Key生成的对象包括：MappedStatement.id（即Mapper方法）、RowBounds.offset、RowBounds.limit、 BoundSql.sql、OUT参数、环境配置ID&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int DEFAULT_MULTIPLIER = 37;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int DEFAULT_HASHCODE = 17;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final int multiplier;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// 由各个参与Key生成的对象hashCode计算生成&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;hashcode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long &lt;b style=&quot;font-size: 11px;&quot;&gt;checksum&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// 参与Key生成的对象数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;count&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// 参与Key生成的对象列表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private List&amp;lt;Object&amp;gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;updateList&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// hashcode:checksum:&amp;lt;所有参与key生成的对象的toString()返回的字符串&amp;gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String toString()&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="400" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-10" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 参与Key生成的对象包括：MappedStatement.id（即Mapper方法）、RowBounds.offset、RowBounds.limit、 BoundSql.sql、存储过程OUT参数、环境配置ID&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public CacheKey &lt;b&gt;createCacheKey&lt;/b&gt;(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp; if (closed) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; throw new ExecutorException(&quot;Executor was closed.&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CacheKey cacheKey = new &lt;b&gt;CacheKey&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(ms.getId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(rowBounds.getOffset());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(rowBounds.getLimit());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(boundSql.getSql());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;ParameterMapping&amp;gt; &lt;b&gt;parameterMappings&lt;/b&gt; = boundSql.getParameterMappings();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; TypeHandlerRegistry typeHandlerRegistry = ms.getConfiguration().getTypeHandlerRegistry();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; // mimic DefaultParameterHandler logic&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (ParameterMapping parameterMapping : &lt;b&gt;parameterMappings&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; if (parameterMapping.getMode() != &lt;b&gt;ParameterMode.OUT)&lt;/b&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Object value;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String propertyName = parameterMapping.getProperty();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (boundSql.hasAdditionalParameter(propertyName)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value = boundSql.getAdditionalParameter(propertyName);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else if (parameterObject == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value = null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value = parameterObject;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetaObject metaObject = configuration.newMetaObject(parameterObject);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value = metaObject.getValue(propertyName);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(value);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (configuration.getEnvironment() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; // issue #176&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; cacheKey.&lt;b&gt;update&lt;/b&gt;(configuration.getEnvironment().getId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return cacheKey;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="160" width="440" height="480" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-12" value="BaseExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="930" y="130" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-13" value="&lt;font color=&quot;#007fff&quot;&gt;举例：&lt;br&gt;&lt;b&gt;hashcode:checksum:MappedStatement.id:offset:limit:sql&lt;br&gt;&lt;/b&gt;-1868714736:4358584015:top.kwseeker.mybatis.cache.mapper.UserMapper.selectById:0:2147483647:SELECT id, username, password, create_time FROM users WHERE id = ?&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1210" y="160" width="810" height="50" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-14" target="yhzCpn97QrwA5I1gkQgs-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1210" y="860" />
              <mxPoint x="1210" y="710" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-28" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-27" vertex="1" connectable="0">
          <mxGeometry x="0.1463" y="-2" relative="1" as="geometry">
            <mxPoint x="8" y="-51" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-39" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-14" target="yhzCpn97QrwA5I1gkQgs-38" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1210" y="860" />
              <mxPoint x="1210" y="1030" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-40" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-39" vertex="1" connectable="0">
          <mxGeometry x="0.8262" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-117" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-14" target="yhzCpn97QrwA5I1gkQgs-118" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1241" y="1150" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1210" y="860" />
              <mxPoint x="1210" y="1160" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-120" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-117" vertex="1" connectable="0">
          <mxGeometry x="0.9058" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-14" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public &amp;lt;E&amp;gt; List&amp;lt;E&amp;gt; &lt;b&gt;query&lt;/b&gt;(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; throws SQLException {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px; background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 获取二级缓存对象，每个MappedStatement都有自己的二级缓存对象，Cache在MappedStatement Builder 初始化时指定，要么创建新的缓存对象（&amp;lt;cache/&amp;gt; 或 @CacheNamespace），要么引用其他的缓存对象&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;（&amp;lt;cache-ref/&amp;gt; 或 @CacheNamespaceRef）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Cache cache = &lt;b&gt;ms&lt;/b&gt;.&lt;b&gt;getCache&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 如果二级缓存不为空，且启用了二级缓存，先查二级缓存&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (cache != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这里是通过 MappedStatement.&lt;b&gt;flushCacheRequired&lt;/b&gt; 判断二级缓存是否需要清空, 是则清空缓存&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;flushCacheIfRequired&lt;/b&gt;(ms);&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ms.&lt;b&gt;isUseCache&lt;/b&gt;() &amp;amp;&amp;amp; resultHandler == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ensureNoOutParams(ms, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //1 使用 CacheKey 从二级缓存中查询缓存的结果&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @SuppressWarnings(&quot;unchecked&quot;)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;E&amp;gt; list = (List&amp;lt;E&amp;gt;) &lt;b&gt;tcm&lt;/b&gt;.&lt;b&gt;getObject&lt;/b&gt;(cache, key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (list == null) { &lt;font color=&quot;#007fff&quot;&gt;// 二级缓存中没有，执行后面逻辑，然后更新二级缓存&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; list = delegate.&lt;b&gt;query&lt;/b&gt;(ms, parameterObject, rowBounds, resultHandler, key, boundSql);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 2&amp;nbsp; 这一步缓存并没有将值直接放到&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;PerpetualCache， 而是先临时放到了 TransactionCache 的&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;entriesToAddOnCommit&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;tcm&lt;/b&gt;.&lt;b&gt;putObject&lt;/b&gt;(cache, key, list); // issue #578 and #116&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return list;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 3 没有开启二级缓存继续后面的逻辑（先查一级缓存，没有再执行SQL）&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return delegate.&lt;b&gt;query&lt;/b&gt;(ms, parameterObject, rowBounds, resultHandler, key, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="680" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="yhzCpn97QrwA5I1gkQgs-18" target="yhzCpn97QrwA5I1gkQgs-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="460" />
              <mxPoint x="1220" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-18" target="yhzCpn97QrwA5I1gkQgs-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-18" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;Cache cache = new &lt;b&gt;CacheBuilder&lt;/b&gt;(currentNamespace)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .implementation(valueOrDefault(typeClass, &lt;b&gt;PerpetualCache&lt;/b&gt;.class))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addDecorator(valueOrDefault(evictionClass, &lt;b&gt;LruCache&lt;/b&gt;.class))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .clearInterval(flushInterval)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .size(size)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .readWrite(readWrite)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .blocking(blocking)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .properties(props)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;build&lt;/b&gt;();&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="400" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-19" value="MapperBuilderAssistant" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1386" y="370" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-21" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;CacheBuilder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;缓存实例Builder&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Mapper类的全限定类名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;id&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 最终使用的缓存实例是经过多层装饰器模式装饰的，最内层实现缓存数据的存储，implementation 指定缓存的基本实现类（最内层实现类）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Class&amp;lt;? extends Cache&amp;gt; &lt;b&gt;implementation&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 通过装饰器模式拓展的功能实现类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;Class&amp;lt;? extends Cache&amp;gt;&amp;gt; &lt;b&gt;decorators&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer size;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Long clearInterval;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean readWrite;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Properties properties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean blocking;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Cache build()&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-960" y="400" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-22" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;public Cache build() {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; // 初始化时可能没有指定缓存的基本实现，就默认使用 &lt;b&gt;PerpetualCache.class&lt;/b&gt;, 如果装饰类也没有指定，则默认使用 &lt;b&gt;LruCache.class &lt;/b&gt;作为装饰类&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;setDefaultImplementations&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; Cache cache = &lt;b&gt;newBaseCacheInstance&lt;/b&gt;(implementation, id);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; setCacheProperties(cache);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; // issue #352, do not apply decorators to custom caches&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (&lt;b&gt;PerpetualCache&lt;/b&gt;.class.equals(cache.getClass())) { &lt;font color=&quot;#007fff&quot;&gt;//只有基础实现是&amp;nbsp;PerpetualCache，才使用装饰类装饰&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (Class&amp;lt;? extends Cache&amp;gt; decorator : &lt;b&gt;decorators&lt;/b&gt;) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cache = newCacheDecoratorInstance(decorator, cache);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setCacheProperties(cache);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cache = setStandardDecorators(cache);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (!&lt;b&gt;LoggingCache&lt;/b&gt;.class.isAssignableFrom(cache.getClass())) { &lt;font color=&quot;#007fff&quot;&gt;// 非PerpetualCache基础实现&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cache = new LoggingCache(cache);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return cache;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="400" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-24" value="CacheBuilder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1890" y="370" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-25" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;测试Demo中默认创建的缓存实例：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;如果没有对缓存配置做特殊定制，基本都是这样。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;cache = {&lt;b&gt;SynchronizedCache&lt;/b&gt;@6768}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;delegate = {&lt;b&gt;LoggingCache&lt;/b&gt;@6799}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; log = {Slf4jImpl@6800}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; delegate = {&lt;b&gt;SerializedCache&lt;/b&gt;@6801}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;delegate = {&lt;b&gt;LruCache&lt;/b&gt;@6802}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; delegate = {&lt;b&gt;PerpetualCache&lt;/b&gt;@6803}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;id = &quot;top.kwseeker.mybatis.cache.mapper.UserMapper&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;cache = {HashMap@6806}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; keyMap = {LruCache$1@6804}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; eldestKey = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; requests = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; hits = 0&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2170" y="400" width="280" height="180" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-26" target="yhzCpn97QrwA5I1gkQgs-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-26" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// getTransactionalCache 先查看是否已经为 cache 创建过 TransactionalCache，没有就创建&amp;nbsp;(就是在外面再装饰一层)，然后一层层查缓存&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;getTransactionalCache&lt;/b&gt;(cache).&lt;b&gt;getObject&lt;/b&gt;(key);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=10;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="680" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-29" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionalCache&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;功能：为了实现在commit后刷新到缓存，以及在rollback时清除对应的缓存，以避免出现脏读问题&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Cache &lt;b&gt;delegate&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//执行clear()后设置为true（clear()中只是清理临时缓存 entriesToAddOnCommit），用于标记commit时是否需要清理 delegate 的缓存&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;clearOnCommit&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 存储在commit后需要放到真正的缓存中的数据，此类的putObject其实是将值临时缓存到这里，并没有直接放到 PerpetualCache&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Object, Object&amp;gt; &lt;b&gt;entriesToAddOnCommit&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 未命中的缓存，在提交阶段也会存储到缓存中，值设置为空&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;Object&amp;gt; &lt;b&gt;entriesMissedInCache&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-960" y="1080" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-30" target="yhzCpn97QrwA5I1gkQgs-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-30" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionalCacheManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;事务缓存的容器，会为每个Cache实例创建一个对应的 &lt;b&gt;TransactionalCache&lt;/b&gt;，TransactionalCache 是在Cache最外边又装饰了一层&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Cache, TransactionalCache&amp;gt; &lt;b&gt;transactionalCaches&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-480" y="1080" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-31" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;Cache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-960" y="720" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-32" target="yhzCpn97QrwA5I1gkQgs-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-32" target="yhzCpn97QrwA5I1gkQgs-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-32" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;TransactionalCache&lt;/b&gt;#getObject(key)&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-34" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;SynchronziedCache&lt;/b&gt;#getObject(key).&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;...&amp;nbsp; 逐级查询 ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;PerpetualCache&lt;/b&gt;#getObject(key)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-36" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public Object getObject(Object key) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // issue #116&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Object object = &lt;b&gt;delegate&lt;/b&gt;.&lt;b&gt;getObject&lt;/b&gt;(key);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (object == null) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//缓存未命中&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entriesMissedInCache.add(key);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // issue #146&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (&lt;b&gt;clearOnCommit&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return object;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1960" y="680" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-43" target="yhzCpn97QrwA5I1gkQgs-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-38" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// getTransactionalCache 先查看是否已经为 cache 创建过 TransactionalCache，没有就创建&amp;nbsp;(就是在外面再装饰一层)，然后将结果缓存&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;getTransactionalCache&lt;/b&gt;(cache).&lt;b&gt;putObject&lt;/b&gt;(key, value);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=10;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1000" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-41" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;没有将值直接放到 PerpetualCache， 而是先临时放到了 TransactionCache 的 entriesToAddOnCommit&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;entriesToAddOnCommit&lt;/b&gt;.&lt;b&gt;put&lt;/b&gt;(key, object);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=10;fontSize=10;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-38" target="yhzCpn97QrwA5I1gkQgs-43" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1681" y="1030" as="sourcePoint" />
            <mxPoint x="1960" y="1030" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-43" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;TransactionalCache&lt;/b&gt;#putObject(key, value)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;将数据暂存到 TransactionCache 本地&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-45" target="yhzCpn97QrwA5I1gkQgs-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-45" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;TransactionalCache&lt;/b&gt;#&lt;b&gt;commit&lt;/b&gt;()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;真正执行数据缓存, 将 TransactionCache 暂存的数据最终保存到&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;PerpetualCache&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-46" target="yhzCpn97QrwA5I1gkQgs-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-46" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void commit() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; //update操作处理中会设置 clearOnCommit = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (clearOnCommit) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; delegate.clear();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;flushPendingEntries&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; reset();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=10;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1610" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-59" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-48" target="yhzCpn97QrwA5I1gkQgs-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-48" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;private void flushPendingEntries() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (Map.Entry&amp;lt;Object, Object&amp;gt; entry : &lt;b&gt;entriesToAddOnCommit&lt;/b&gt;.entrySet()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 这里才真正的将缓存数据写到 PerpetualCache 中&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;delegate&lt;/b&gt;.&lt;b&gt;putObject&lt;/b&gt;(entry.getKey(), entry.getValue());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (Object entry : &lt;b&gt;entriesMissedInCache&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!entriesToAddOnCommit.containsKey(entry)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; delegate.putObject(entry, null);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=10;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1600" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-55" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-50" target="yhzCpn97QrwA5I1gkQgs-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-50" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;SynchronziedCache&lt;/b&gt;#putObject(key, value)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-51" target="yhzCpn97QrwA5I1gkQgs-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-51" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;LoggingCache&lt;/b&gt;#putObject(key, value)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-57" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-52" target="yhzCpn97QrwA5I1gkQgs-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-52" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;SerializedCache&lt;/b&gt;#putObject(key, value)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-53" target="yhzCpn97QrwA5I1gkQgs-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-53" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;LruCache&lt;/b&gt;#putObject(key, value)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="2080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-54" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;PerpetualCache&lt;/b&gt;#putObject(key, value)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;真正的缓存数据容器&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=10;fontSize=10;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1720" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-60" target="yhzCpn97QrwA5I1gkQgs-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-60" value="&lt;b&gt;事务提交&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;非自动事务提交是在 CachingExecutor#query() 外面且是之后执行的，最终是怎么触发执行 TransactionalCache#commit()的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-61" target="yhzCpn97QrwA5I1gkQgs-65" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-61" value="commitTransactionAfterReturning(txInfo);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-63" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;在 commit() 中加断点查调用栈&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;commit&lt;/b&gt;:96, &lt;b style=&quot;font-size: 10px;&quot;&gt;TransactionalCache&lt;/b&gt; (org.apache.ibatis.cache.decorators)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;commit:45, TransactionalCacheManager (org.apache.ibatis.cache)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;commit:120, CachingExecutor (org.apache.ibatis.executor)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;commit:220, DefaultSqlSession (org.apache.ibatis.session.defaults)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;commit:214, DefaultSqlSession (org.apache.ibatis.session.defaults)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;beforeCommit:283, SqlSessionUtils$SqlSessionSynchronization (org.mybatis.spring)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;triggerBeforeCommit:97, TransactionSynchronizationUtils (org.springframework.transaction.support)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;triggerBeforeCommit&lt;/b&gt;:916, &lt;b style=&quot;font-size: 10px;&quot;&gt;AbstractPlatformTransactionManager&lt;/b&gt; (org.springframework.transaction.support)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;processCommit:727, AbstractPlatformTransactionManager (org.springframework.transaction.support)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;commit:711, AbstractPlatformTransactionManager (org.springframework.transaction.support)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;commitTransactionAfterReturning&lt;/b&gt;:654, &lt;b style=&quot;font-size: 10px;&quot;&gt;TransactionAspectSupport&lt;/b&gt; (org.springframework.transaction.interceptor)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;invokeWithinTransaction:407, TransactionAspectSupport (org.springframework.transaction.interceptor)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;invoke:119, &lt;b style=&quot;font-size: 10px;&quot;&gt;TransactionInterceptor&lt;/b&gt; (org.springframework.transaction.interceptor)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;proceed:763, CglibAopProxy$CglibMethodInvocation (org.springframework.aop.framework)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;intercept:708, CglibAopProxy$DynamicAdvisedInterceptor (org.springframework.aop.framework)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;updateById:-1, UserService$$EnhancerBySpringCGLIB$$21c4c479 (top.kwseeker.mybatis.cache.service)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;lambda$testCache$1:33, &lt;b style=&quot;font-size: 10px;&quot;&gt;UserServiceTest&lt;/b&gt; (top.kwseeker.mybatis.cache.service)&lt;/div&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="1820" width="540" height="240" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-64" value="spring-tx:TransactionAspectSupport" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="275" y="1590" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-65" target="yhzCpn97QrwA5I1gkQgs-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-65" value="&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Mybatis 事务缓存处理是在提交前一刻&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;b&gt;triggerBeforeCommit&lt;/b&gt;(status);&lt;br&gt;...&lt;br&gt;&lt;b&gt;doCommit&lt;/b&gt;(status);&lt;br&gt;..." style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-67" value="spring-tx:&lt;br&gt;AbstractPlatformTransactionManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="510" y="1580" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-68" target="yhzCpn97QrwA5I1gkQgs-71" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="980" y="1650" />
              <mxPoint x="980" y="1700" />
              <mxPoint x="260" y="1700" />
              <mxPoint x="260" y="1770" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-79" value="&lt;font color=&quot;#007fff&quot;&gt;回归到Mybatis的处理&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-72" vertex="1" connectable="0">
          <mxGeometry x="-0.0376" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-68" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// Mybatis 事务缓存处理通过实现 SpringTx&lt;/b&gt;&lt;br&gt;&lt;b&gt;的 TransactionSynchronization 拓展接口实现&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;b&gt;synchronization.beforeCommit(&lt;/b&gt;&lt;br&gt;&lt;b&gt;readOnly);&lt;/b&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-70" value="spring-tx:TransactionSynchronizationUtils" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="740" y="1590" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-71" target="yhzCpn97QrwA5I1gkQgs-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-71" value="&lt;b style=&quot;&quot;&gt;this.holder.getSqlSession().commit();&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-73" value="SqlSessionUtils" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="325" y="1710" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-74" target="yhzCpn97QrwA5I1gkQgs-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-74" value="executor.commit(&lt;br&gt;isCommitOrRollbackRequired(force));&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;executor 即 CachingExecutor 实例&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;所以Mybatis DefaultSqlSession 中的提交并不是真正的事务提交只是提交前置处理&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="521" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-76" value="DefaultSqlSession" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="561" y="1710" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-77" target="yhzCpn97QrwA5I1gkQgs-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1241" y="1770" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1220" y="1770" />
              <mxPoint x="1220" y="1670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-77" value="&lt;div&gt;public void commit() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (TransactionalCache txCache : &lt;b&gt;transactionalCaches&lt;/b&gt;.values()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; txCache.commit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="760" y="1740" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-82" value="TransactionalCacheManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="890" y="1710" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-84" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-84" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;SynchronizedCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;为了保证缓存访问的线程安全，在方法前面加了synchronized&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-280" y="840" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-92" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-85" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-740" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-85" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;LoggingCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于统计缓存命中率&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="840" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-91" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-86" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-740" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-86" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;SerializedCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-840" y="840" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-90" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-87" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-87" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;LruCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;使用LRU算法防止缓存内存溢出&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="840" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-89" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-88" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-88" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;PerpetualCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;真正存储缓存数据的实现，perpetual: 持久的&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// Mapper 类的全限定名，所以每个Mapper有一个Cache实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;id&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// Key: CacheKey实例， Value: 查询结果&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Object, Object&amp;gt; &lt;b&gt;cache&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1600" y="840" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-94" value="&lt;b&gt;问题总结：&lt;br&gt;&lt;br&gt;&lt;/b&gt;1.&amp;nbsp;为何两个事务中同时执行同一条查询语句使用二级缓存不会出现脏读？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从源码可知事务中查询语句的结果在事务提交前会被临时存储在 TransactionCache.entriesToAddOnCommit 中，&lt;br&gt;只有在提交前一刻才会真正迁移到真正的缓存对象（比如PerpetualCache）中；&lt;br&gt;且事务中查询二级缓存不会查 TransactionCache 中的临时存储；&lt;br&gt;所以事务提交前其他事务是不会看到这个事务未提交的数据。&lt;/font&gt;&lt;br&gt;&lt;br&gt;2.&amp;nbsp;二级缓存联表查询数据不一致问题产生的原因？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;因为一个命名空间中对某个表某条记录的写操作不会刷新另一个命名空间对此表同一条记录的查询缓存；&lt;br&gt;&lt;/b&gt;跨命名空间查询修改同一个表，当然是因为发生了联表操作（不过这里的联表不是说一定是join操作，&lt;br&gt;还可能是子查询、UNION）。&lt;/font&gt;&lt;br&gt;&lt;br&gt;3. 为什么说二级缓存是基于 namespace 的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从PerpetualCache源码看二级缓存是基于 &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;Mapper 类的全限定名&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;，&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;每个 Mapper 类有一个自己的缓存实例&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;; &lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;而Mapper类的全限定名在Mapper xml 文件中被称为 namespace;&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;比如：&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;lt;mapper &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;namespace&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;=&quot;org.apache.ibatis.submitted.rounding.Mapper&quot;&amp;gt;&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;br&gt;4. 注意写操作清除两级缓存是清除的&lt;b&gt;整个 Cache 实例的缓存&lt;/b&gt;，并不是只清除受到影响的某些 Statement 的查询缓存；&lt;br&gt;可能后者实现太复杂了，需要评估写操作到底会影响哪些语句的结果不是容易的事。&lt;br&gt;&lt;br&gt;5. 如何理解一级缓存默认是 Session 共享的&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;看 Mybatis 创建 Session 的源码可以看到每次创建 Session 都会新建 Executor 实例，而一级缓存是保存在 BaseExecutor&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;中的（一个字段），所以说每个 Session 都有自己的一级缓存实例，同一个 Session 对缓存的操作是操作的同一个一级缓存实例。&lt;/font&gt;&lt;br&gt;&lt;br&gt;6. SpringBoot 集成 Mybatis 为何非事务方式连续执行同一条查询两次第二次却不会命中一级缓存&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;一级缓存默认是同 Session 共享的，但是上面情况非事务方式连续执行两条查询，每条查询都创建了不同的Session,&lt;br&gt;即每条语句使用的不同的一级缓存。&lt;br&gt;参考Spring事务工作原理流程图，查看通过事务管理器中获取 SqlSession 的代码。&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="335" width="710" height="450" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-96" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-95" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-580" y="820" />
              <mxPoint x="-740" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-95" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;ScheduledCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;为了保证缓存访问的线程安全，在方法前面加了synchronized&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-700" y="960" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-98" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-97" target="yhzCpn97QrwA5I1gkQgs-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1000" y="940" />
              <mxPoint x="-860" y="940" />
              <mxPoint x="-860" y="820" />
              <mxPoint x="-740" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-97" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;FifoCache&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;使用FIFO算法防止缓存内存溢出&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="960" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-100" value="&lt;font color=&quot;#007fff&quot;&gt;CacheKey举例：&lt;br&gt;&lt;b&gt;hashcode:checksum:MappedStatement.id:offset:limit:sql&lt;br&gt;&lt;/b&gt;-1868714736:4358584015:top.kwseeker.mybatis.cache.mapper.UserMapper.selectById:0:2147483647&lt;br&gt;:SELECT id, username, password, create_time FROM users WHERE id = ?&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-480" y="685" width="480" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-101" target="yhzCpn97QrwA5I1gkQgs-102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-101" value="&lt;b&gt;CachingExecutor&lt;/b&gt;#&lt;b&gt;update&lt;/b&gt;(&lt;br&gt;MappedStatement ms, Object parameterObject)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2138" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-105" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-102" target="yhzCpn97QrwA5I1gkQgs-104" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-107" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="yhzCpn97QrwA5I1gkQgs-102" target="yhzCpn97QrwA5I1gkQgs-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-102" value="&lt;div&gt;public int update(MappedStatement ms, Object parameterObject) throws SQLException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;flushCacheIfRequired&lt;/b&gt;(ms);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return delegate.&lt;b&gt;update&lt;/b&gt;(ms, parameterObject);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="2128" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.75;entryDx=0;entryDy=0;dashed=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-104" target="yhzCpn97QrwA5I1gkQgs-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240.5" y="2240" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1240" y="2240" />
              <mxPoint x="1240" y="1685" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-115" value="&lt;font color=&quot;#007fff&quot;&gt;提交时执行PerpetualCache的清理&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yhzCpn97QrwA5I1gkQgs-114" vertex="1" connectable="0">
          <mxGeometry x="-0.8987" y="-1" relative="1" as="geometry">
            <mxPoint x="59" y="-5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-104" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 清理二级缓存，而且是清理的整个缓存，并不是只清理这个Statement的缓存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;private void flushCacheIfRequired(MappedStatement ms) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Cache cache = ms.&lt;b&gt;getCache&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (cache != null &amp;amp;&amp;amp; ms.isFlushCacheRequired()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// TransactionCache#clear() 仅仅是清理本地的临时缓存不会清理 PerpetualCache 中的缓存&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;// PerpetualCache 中的缓存真正清除是在当前事务提交的时候&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; tcm.&lt;b&gt;clear&lt;/b&gt;(cache);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="2128" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-106" target="yhzCpn97QrwA5I1gkQgs-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-106" value="&lt;div&gt;public int update(MappedStatement ms, Object parameter) throws SQLException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing an update&quot;).object(ms.getId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (closed) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new ExecutorException(&quot;Executor was closed.&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 清理一级缓存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;clearLocalCache&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return doUpdate(ms, parameter);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="2288" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-108" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 后面操作不涉及缓存&lt;/font&gt;&lt;/div&gt;&lt;div&gt;public int doUpdate(MappedStatement ms, Object parameter) throws SQLException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Statement stmt = null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Configuration configuration = ms.getConfiguration();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; stmt = prepareStatement(handler, ms.getStatementLog());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; return handler.update(stmt);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; closeStatement(stmt);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; }&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="2278" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-110" value="BaseExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="930" y="2258" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-111" value="SimpleExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1406" y="2248" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-112" value="&lt;font color=&quot;#007fff&quot;&gt;从后面流程可以看到，写操作只会清理自己这条语句所在命名空间对应的缓存实例;&amp;nbsp;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即便其他命名空间也可能查询这里修改的表，也不会刷新它们的缓存，这时就可能查询到过期的数据&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="2218" width="550" height="40" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-123" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="yhzCpn97QrwA5I1gkQgs-118" target="yhzCpn97QrwA5I1gkQgs-122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-118" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public &amp;lt;E&amp;gt; List&amp;lt;E&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;query&lt;/b&gt;(MappedStatement ms, Object parameterObject, &lt;br style=&quot;font-size: 10px;&quot;&gt;RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 参考MySQL整体流程图&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; BoundSql boundSql = ms.&lt;b style=&quot;font-size: 10px;&quot;&gt;getBoundSql&lt;/b&gt;(parameterObject);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 1 这次是创建一级缓存的key，两级缓存用的 CacheKey 是相同的&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; CacheKey key = this.&lt;b style=&quot;font-size: 10px;&quot;&gt;createCacheKey&lt;/b&gt;(ms, parameterObject, rowBounds, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 2 内部实现第一级缓存操作&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b style=&quot;font-size: 10px;&quot;&gt;query&lt;/b&gt;(ms, parameterObject, rowBounds, resultHandler, key, boundSql);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1100" width="439" height="120" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-119" value="BaseExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="450" y="130" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-121" value="CachingExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="925" y="650" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-125" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;fontColor=#007FFF;" parent="1" source="yhzCpn97QrwA5I1gkQgs-122" target="yhzCpn97QrwA5I1gkQgs-124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-122" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;public &amp;lt;E&amp;gt; List&amp;lt;E&amp;gt; &lt;b&gt;query&lt;/b&gt;(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing a query&quot;).object(ms.getId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (closed) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new ExecutorException(&quot;Executor was closed.&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (queryStack == 0 &amp;amp;&amp;amp; ms.isFlushCacheRequired()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;clearLocalCache&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;E&amp;gt; list;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queryStack++;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 先查询一级缓存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 一级缓存直接通过&amp;nbsp;PerpetualCache 直接实现，即本质就只是一个HashMap&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; list = resultHandler == null ? (List&amp;lt;E&amp;gt;) &lt;b&gt;localCache.getObject&lt;/b&gt;(key) : null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (list != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 1 内部更新一级缓存&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; list = &lt;b&gt;queryFromDatabase&lt;/b&gt;(ms, parameter, rowBounds, resultHandler, key, boundSql);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queryStack--;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (queryStack == 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (DeferredLoad deferredLoad : deferredLoads) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deferredLoad.load();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // issue #601&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deferredLoads.clear();&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// LocalCacheScope.STATEMENT SQL执行完毕立即清理，即这类型的缓存只用查询内部&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (configuration.&lt;b&gt;getLocalCacheScope&lt;/b&gt;() == LocalCacheScope.&lt;b&gt;STATEMENT&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // issue #482&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;clearLocalCache&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return list;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1100" width="440" height="480" as="geometry" />
        </mxCell>
        <mxCell id="yhzCpn97QrwA5I1gkQgs-124" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;private &amp;lt;E&amp;gt; List&amp;lt;E&amp;gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;localCache&lt;/b&gt;.&lt;b&gt;putObject&lt;/b&gt;(key, ExecutionPlaceholder.EXECUTION_PLACEHOLDER);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; List list;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; list = this.&lt;b&gt;doQuery&lt;/b&gt;(ms, parameter, rowBounds, resultHandler, boundSql);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// ？？？为何查询前先缓存占位符，查询完再清除&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.localCache.&lt;b&gt;removeObject&lt;/b&gt;(key);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 一级缓存写&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.localCache.&lt;b&gt;putObject&lt;/b&gt;(key, list);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (ms.getStatementType() == StatementType.CALLABLE) {&lt;font color=&quot;#007fff&quot;&gt; //如果是存储过程调用&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;localOutputParameterCache&lt;/b&gt;.putObject(key, parameter);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return list;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1100" width="439" height="240" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
