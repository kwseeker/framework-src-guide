<mxfile host="Electron" modified="2025-02-28T08:53:14.166Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="qyxt5nrXFakjnES6MME6" version="21.6.5" type="device">
  <diagram name="第 1 页" id="wWyYOEXiXQ54DeoDZmTa">
    <mxGraphModel dx="3867" dy="925" grid="1" gridSize="10" guides="0" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="y0gIganFQs9rjsJ_vc2o-265" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-263" target="y0gIganFQs9rjsJ_vc2o-225">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="1720" />
              <mxPoint x="1700" y="2990" />
              <mxPoint x="980" y="2990" />
              <mxPoint x="980" y="3040" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-257" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-245" target="y0gIganFQs9rjsJ_vc2o-256">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-258" value="热key规则访问次数统计" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-257">
          <mxGeometry x="0.9617" y="2" relative="1" as="geometry">
            <mxPoint x="58" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-128" value="&lt;div&gt;&lt;b&gt;while&lt;/b&gt; (true) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HotKeyModel model = QUEUE.take(); &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 阻塞读&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (model.&lt;b&gt;isRemove&lt;/b&gt;()) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;// key 热度统计删除, 会推送到所有client删除所有本地缓存&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iKeyListener.&lt;b&gt;removeKey&lt;/b&gt;(model, KeyEventOriginal.CLIENT);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// key 热度增量统计&lt;/b&gt;&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iKeyListener.&lt;b&gt;newKey&lt;/b&gt;(model, KeyEventOriginal.CLIENT);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; totalDealCount.increment();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;align=left;arcSize=4;" vertex="1" parent="1">
          <mxGeometry x="3640.18" y="1040" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;jd-hotkey 工作流程 (v0.0.4)&lt;/font&gt;&lt;/h1&gt;&lt;p&gt;包括 etcd 、dashboard、worker、client 模块；不仅仅可以做热key检测。&lt;br&gt;注意热key不一定是指 Redis的key, 而是说所有频繁访问的数据。&lt;br&gt;依赖关键组件：Netty、Guava、Caffeine、Etcd&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="550" height="100" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-2" target="y0gIganFQs9rjsJ_vc2o-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-2" target="y0gIganFQs9rjsJ_vc2o-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-2" target="y0gIganFQs9rjsJ_vc2o-19">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-178" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-2" target="y0gIganFQs9rjsJ_vc2o-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-2" value="&lt;b style=&quot;font-size: 12px;&quot;&gt;客户端&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;JdHotKeyStore&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;JdHotkey对外接口，提供了7个 public static 方法&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 判断某个key是否是热key，&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;会上报热度增量和规则访问增量&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static boolean &lt;b&gt;isHotKey&lt;/b&gt;(String key)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 从本地缓存获取key对应的缓存值, 不会上报热度增量和规则访问增量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static Object get(String key)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 如果是热key就设置对应的本地缓存ValueModel.value&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static void &lt;b&gt;smartSet&lt;/b&gt;(String key, Object value)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 强行设置key的本地缓存 ValueModel.value, 即便key不是热key, 不会将此key上报为热key&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static void forceSet(String key, Object value)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 从本地缓存获取key对应的缓存值，会上报热度增量和规则访问增量&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static Object &lt;b&gt;getValue&lt;/b&gt;(String key, KeyType keyType)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static Object &lt;b&gt;getValue&lt;/b&gt;(String key)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static void &lt;b&gt;remove&lt;/b&gt;(String key)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="80" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-4" target="y0gIganFQs9rjsJ_vc2o-11">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="730" y="150" />
              <mxPoint x="730" y="190" />
              <mxPoint x="510" y="190" />
              <mxPoint x="510" y="410" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-4" value="&lt;div&gt;public static Object &lt;b&gt;getValue&lt;/b&gt;(String key) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return getValue(key, null);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="520" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-6" target="y0gIganFQs9rjsJ_vc2o-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-6" target="y0gIganFQs9rjsJ_vc2o-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-6" value="&lt;b style=&quot;font-size: 12px;&quot;&gt;业务接口方法&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-9" value="&lt;div&gt;public static boolean &lt;b&gt;isHotKey&lt;/b&gt;(String key) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!inRule(key)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean isHot = &lt;b&gt;isHot&lt;/b&gt;(key);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!isHot) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyPusher.&lt;b&gt;push&lt;/b&gt;(key, null);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ValueModel valueModel = getValueSimple(key);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //判断是否过期时间小于1秒，小于1秒的话也发送&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isNearExpire(valueModel)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyPusher.push(key, null);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //统计计数&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyHandlerFactory.getCounter().collect(new KeyHotModel(key, isHot));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return isHot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="520" y="640" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" target="y0gIganFQs9rjsJ_vc2o-9" source="y0gIganFQs9rjsJ_vc2o-6">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="230" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="500" y="150" />
              <mxPoint x="500" y="780" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-11" target="y0gIganFQs9rjsJ_vc2o-23">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="410" />
              <mxPoint x="970" y="420" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-52" value="1/2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-24">
          <mxGeometry x="0.2852" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-11" target="y0gIganFQs9rjsJ_vc2o-51">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="410" />
              <mxPoint x="970" y="710" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-54" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-53">
          <mxGeometry x="-0.2056" y="3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-11" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public static Object &lt;b style=&quot;font-size: 10px;&quot;&gt;getValue&lt;/b&gt;(String key, KeyType keyType) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 判断在 worker 中是否有为这个key设置统计规则，没有的话说明不需要统计这个key&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!inRule(key)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// 没有设置统计规则，直接返回null&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Object userValue = null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 从本地缓存（默认是 Caffeine）中查询key对应值&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ValueModel value = &lt;b style=&quot;font-size: 10px;&quot;&gt;getValueSimple&lt;/b&gt;(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (value == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 1 上报热度增量（+1）&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyPusher.&lt;b style=&quot;font-size: 10px;&quot;&gt;push&lt;/b&gt;(key, keyType);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isNearExpire(value)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;//2 临近过期了，也上报热度增量（+1）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyPusher.&lt;b style=&quot;font-size: 10px;&quot;&gt;push&lt;/b&gt;(key, keyType);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Object object = value.getValue();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //如果是默认值，也返回null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (object instanceof Integer &amp;amp;&amp;amp; Constant.MAGIC_NUMBER == (int) object) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; userValue = null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; userValue = object;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 3 实际是上报key对应规则某个时间点（s）访问增量，包括热key命中增量和规则总访问增量&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 用于控制台（dashboard）统计规则热key命中率&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyHandlerFactory.&lt;b style=&quot;font-size: 10px;&quot;&gt;getCounter&lt;/b&gt;().&lt;b style=&quot;font-size: 10px;&quot;&gt;collect&lt;/b&gt;(new &lt;b style=&quot;font-size: 10px;&quot;&gt;KeyHotModel&lt;/b&gt;(key, value != null));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return userValue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="520" y="200" width="440" height="420" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-16" target="y0gIganFQs9rjsJ_vc2o-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-57" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-16" target="y0gIganFQs9rjsJ_vc2o-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-210" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-16" target="y0gIganFQs9rjsJ_vc2o-62">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-211" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-16" target="y0gIganFQs9rjsJ_vc2o-63">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-212" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-16" target="y0gIganFQs9rjsJ_vc2o-64">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-16" value="&lt;b style=&quot;font-size: 12px;&quot;&gt;线程池定时任务&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="990" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-180" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-18" target="y0gIganFQs9rjsJ_vc2o-179">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-18" value="&lt;b style=&quot;font-size: 12px;&quot;&gt;Netty Client&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-214" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-19" target="y0gIganFQs9rjsJ_vc2o-213">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-19" value="&lt;b style=&quot;font-size: 12px;&quot;&gt;Guava EventBus&lt;/b&gt;&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;registEventBus() 中初始化&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="2480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-15" value="&lt;div&gt;&lt;b&gt;关键问题&lt;/b&gt;：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;1.&amp;nbsp; 为何引入本地缓存 Caffeine ?&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;因为 jd-hotkey 客户端使用本地缓存存储热key，只是选择了Caffeine。另外也可以在检测到热key后为Caffeine缓存赋值作为业务缓存。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;另外worker也需要记录下刚检测出来的热key, 避免并发情况下重复检测和重复热key推送，是借助 Caffeine 存储的。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;border-color: var(--border-color); color: rgb(51, 0, 51);&quot;&gt;2. 热key探测实现流程&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;参考右边 getValue() 方法的处理流程&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;注意热key探测出来后，推送回客户端 Caffeine 本地缓存中值是默认值&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;MAGIC_NUMBER， 不是业务实际的值。&lt;/font&gt;&lt;div&gt;&lt;span style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;border-color: var(--border-color); color: rgb(51, 0, 51);&quot;&gt;3. 规则命中率统计流程，CounterConsumer 中规定 map size &amp;gt;= 300 才会向 Etcd 推送规则命中率数据，这里size 300 的含义到底是什么？&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;参考右边 getValue() 方法的处理流程&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;size 300 的含义并非访问300次规则对应的key，也不是官方注释说的300s, 而是积累达到300个KeyCountModel, 从 KeyCountModel 创建过程可以看到&lt;br&gt;同一个规则同一秒内的多次访问是统计到一个 KeyCountModel 实例中的，所以要积累300个KeyCountModel, 可以是一个规则每秒都有访问且连续访问了300s,或者多个规则各自连续访问总时间达到300s(比如有3个规则，都连续访问了100s也会上报规则命中率统计数据)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;KeyCountModel{ruleKey=&#39;key#**#2025-02-28 16:19:34&#39;, totalHitCount=351, hotHitCount=0, createTime=0}&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;4. 热key探测规则发布原理&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;规则发布是通过Dashboard&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;/rule/save 接口&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;进行发布，会保存到 Etcd, Worker 通过监听机制同步更新到本地，Client 通过定时任务定期拉取同步到本地。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;b&gt;5. 官方列举的一些应用场景应该怎么实现？&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;mysql热数据本地缓存&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;redis热数据本地缓存&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;黑名单用户本地缓存&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;这三种场景，使用 isHotKey() smartSet() 即可，前两种场景检测到key是热key后，使用 smartSet() 将值写入本地缓存。第三种场景甚至不需要 smartSet()。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;爬虫用户限流&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;以用户ID为key进行热key检测，用户访问资源时先判断用户ID对应key是否是热key, 是直接返回。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;接口、用户维度限流&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;同上，接口维度限流就是将接口作为key, 比如 请求方式+路由+入参。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;单机接口、用户维度限流&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;集群用户维度限流&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;集群接口维度限流&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;不管单机还是集群，热度统计都是将所有客户端访问增量聚合到同一个Worker进行统计的，统计完成还会推送到所有客户端，所以单机和集群是一样支持的。&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="200" width="400" height="720" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-22" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ValueModel&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;本地缓存存储数据类型&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private long createTime = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;// 本地缓存时间，单位毫秒&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int duration;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用户实际存放的value，默认值是 Constant.MAGIC_NUMBER&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private Object value;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="120" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-23" target="y0gIganFQs9rjsJ_vc2o-40">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="420" />
              <mxPoint x="1450" y="600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-42" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-41">
          <mxGeometry x="-0.8" relative="1" as="geometry">
            <mxPoint x="9" y="168" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-23" value="&lt;div&gt;public static void &lt;b&gt;push&lt;/b&gt;(String key, KeyType keyType, int count, boolean remove) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (keyType == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; keyType = KeyType.&lt;b&gt;REDIS_KEY&lt;/b&gt;;&lt;font color=&quot;#007fff&quot;&gt; //默认当作 Redis Key&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; LongAdder adderCnt = new LongAdder();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; adderCnt.add(count);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HotKeyModel hotKeyModel = new HotKeyModel();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setAppName(Context.APP_NAME);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setKeyType(keyType);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setCount(adderCnt);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setRemove(remove);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setKey(key);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (remove) { &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 调用 JdHotKeyStore#remove() 才会为 true， 所以这里是删除热key统计的处理&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//如果是删除key，就直接发到etcd去，不用做聚合。但是有点问题现在，这个删除只能删手工添加的key，不能删worker探测出来的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //因为各个client都在监听手工添加的那个path，没监听自动探测的path。所以如果手工的那个path下，没有该key，那么是删除不了的。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //删不了，就达不到集群监听删除事件的效果，怎么办呢？可以通过新增的方式，新增一个热key，然后删除它&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; EtcdConfigFactory.configCenter().putAndGrant(HotKeyPathTool.keyPath(hotKeyModel), Constant.DEFAULT_DELETE_VALUE, 1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; EtcdConfigFactory.configCenter().delete(HotKeyPathTool.keyPath(hotKeyModel));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //也删worker探测的目录&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; EtcdConfigFactory.configCenter().delete(HotKeyPathTool.keyRecordPath(hotKeyModel));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } &lt;b&gt;else&lt;/b&gt; { &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 这里是上报热key热度增量的处理&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //如果key是规则内的要被探测的key，就积累等待传送&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (KeyRuleHolder.isKeyInRule(key)) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //1 为了减少 Netty 请求次数，积攒起来，每隔半秒发送一次&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyHandlerFactory.&lt;b&gt;getCollector&lt;/b&gt;().&lt;b&gt;collect&lt;/b&gt;(hotKeyModel);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1000" y="200" width="440" height="440" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-25" value="HotKeyPusher" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1170" y="170" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-26" target="y0gIganFQs9rjsJ_vc2o-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-26" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HotKeyModel&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;key热度增量&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private long createTime = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;// 本地缓存时间，单位毫秒&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int duration;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用户实际存放的value，默认值是 Constant.MAGIC_NUMBER&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private Object value;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-440" y="560" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BaseModel&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(51, 0, 51); background-color: initial;&quot;&gt;private String &lt;b&gt;id&lt;/b&gt; = IdGenerater.generateId();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private long &lt;b&gt;createTime&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String &lt;b&gt;key&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 该key出现的数量，如果一次一发那就是1，累积多次发那就是count&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 使用 LongAdder 解决 多线程计数不准确的问题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;@JSONField(serializeUsing = LongAdderSerializer.class)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private LongAdder &lt;b&gt;count&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-440" y="360" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-29" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyType （E）&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Key类型&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;REDIS_KEY,&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 统计目标key是 Redis KEY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;REQUEST_PATH,&amp;nbsp; &amp;nbsp;// 统计目标key是请求路径&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;BLACK_LIST,&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 是黑名单&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;OTHER&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 其他类型&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="360" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-30" target="y0gIganFQs9rjsJ_vc2o-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-30" value="hotkey-pusher-service-executor&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;批量推送热度增量，默认每0.5s 从 TurnKeyCollector 中读取一次热度增量推送到 worker&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="990" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-32" target="y0gIganFQs9rjsJ_vc2o-33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-32" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyHandlerFactory&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private static final &lt;b&gt;DefaultKeyHandler&lt;/b&gt; iKeyHandler = new DefaultKeyHandler();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="-880" y="560" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-33" target="y0gIganFQs9rjsJ_vc2o-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-38" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-33" target="y0gIganFQs9rjsJ_vc2o-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-33" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultKeyHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private &lt;b&gt;IKeyPusher&lt;/b&gt; iKeyPusher = new NettyKeyPusher();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private &lt;b&gt;IKeyCollector&lt;/b&gt;&amp;lt;HotKeyModel, HotKeyModel&amp;gt; iKeyCollector = new TurnKeyCollector();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private &lt;b&gt;IKeyCollector&lt;/b&gt;&amp;lt;KeyHotModel, KeyCountModel&amp;gt; iKeyCounter = new TurnCountCollector();&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="560" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-35" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;IKeyCollector&amp;lt;T, V&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;就是一个缓冲，用于减少 Netty 请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;List&amp;lt;V&amp;gt; lockAndGetResult();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;void collect(T t);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;void finishOnce();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="580" width="400" height="140" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-37" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;IKeyPusher&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;void send(String appName, List&amp;lt;HotKeyModel&amp;gt; list);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;void sendCount(String appName, List&amp;lt;KeyCountModel&amp;gt; list);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="390" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-39" target="y0gIganFQs9rjsJ_vc2o-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-39" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TurnKeyCollector &lt;/b&gt;implements IKeyCollector&amp;lt;HotKeyModel, HotKeyModel&amp;gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;热度增量聚合容器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这里之所以需要两个CHM, 是因为通过 IKeyPusher 发送时Map不能写入，而 Collector 还必须继续接收数据，所以新接收的数据只能写入到另一个Map&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private ConcurrentHashMap&amp;lt;String, HotKeyModel&amp;gt; &lt;b&gt;map0&lt;/b&gt; = new &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private ConcurrentHashMap&amp;lt;String, HotKeyModel&amp;gt; &lt;b&gt;map1&lt;/b&gt; = new &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于切换 Map&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private AtomicLong atomicLong = new AtomicLong(0);&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-2200" y="560" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-40" target="y0gIganFQs9rjsJ_vc2o-43">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="600" />
              <mxPoint x="1700" y="920" />
              <mxPoint x="1220" y="920" />
              <mxPoint x="1220" y="990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-49" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-48">
          <mxGeometry x="0.9351" y="2" relative="1" as="geometry">
            <mxPoint x="-2" y="-10" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-40" value="collect 就是将这0.5秒内的key的热度增量聚合保存到&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;TurnKeyCollector&lt;/b&gt; 的&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ConcurrentHashMap&lt;/b&gt;&amp;lt;String, HotKeyModel&amp;gt;&amp;nbsp; &lt;b&gt;map0&lt;/b&gt; &lt;b&gt;map1&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1480" y="570" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-43" target="y0gIganFQs9rjsJ_vc2o-67">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-43" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; IKeyCollector&amp;lt;HotKeyModel, HotKeyModel&amp;gt; collectHK = KeyHandlerFactory.getCollector();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;hotKeyModels&lt;/b&gt; = collectHK.&lt;b style=&quot;font-size: 10px;&quot;&gt;lockAndGetResult&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if(CollectionUtil.isNotEmpty(hotKeyModels)){&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // APP_NAME 是应用名，比如&amp;nbsp;spring.application.name 的值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyHandlerFactory.&lt;b style=&quot;font-size: 10px;&quot;&gt;getPusher&lt;/b&gt;().&lt;b style=&quot;font-size: 10px;&quot;&gt;send&lt;/b&gt;(Context.&lt;b&gt;APP_NAME&lt;/b&gt;, hotKeyModels);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; collectHK.finishOnce();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="960" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-46" target="y0gIganFQs9rjsJ_vc2o-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-46" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyKeyPusher&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;借助Netty客户端向worker推送热度增量、&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-2200" y="360" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-50" value="&lt;font color=&quot;#007fff&quot;&gt;一个map在被发送时，&lt;br&gt;需要使用另一个map接收collect()新传入的数据&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1480" y="530" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-51" target="y0gIganFQs9rjsJ_vc2o-58">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1690" y="710" />
              <mxPoint x="1690" y="1320" />
              <mxPoint x="1220" y="1320" />
              <mxPoint x="1220" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-61" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-60">
          <mxGeometry x="0.934" relative="1" as="geometry">
            <mxPoint y="-10" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-51" value="collect 就是将这10秒内的热key缓存命中次数聚合保存到 &lt;b style=&quot;font-size: 11px;&quot;&gt;TurnCountCollector&lt;/b&gt;&amp;nbsp;的&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ConcurrentHashMap&lt;/b&gt;&amp;lt;String, HitCount&amp;gt;&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;HIT_MAP_0&lt;/b&gt;&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;HIT_MAP_1&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1480" y="680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyHotModel&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String key;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private boolean isHot;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-440" y="760" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-56" target="y0gIganFQs9rjsJ_vc2o-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-56" value="hotkey-count-pusher-service-executor&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;默认每10s, 通过NettyKeyPusher&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;往worker推送一次&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-58" target="y0gIganFQs9rjsJ_vc2o-69">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-58" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; IKeyCollector&amp;lt;KeyHotModel, KeyCountModel&amp;gt; collectHK = KeyHandlerFactory.getCounter();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;KeyCountModel&amp;gt; &lt;b&gt;keyCountModels&lt;/b&gt; = collectHK.&lt;b&gt;lockAndGetResult&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if(CollectionUtil.isNotEmpty(keyCountModels)){&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyHandlerFactory.&lt;b&gt;getPusher&lt;/b&gt;().&lt;b&gt;sendCount&lt;/b&gt;(Context.APP_NAME, keyCountModels);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; collectHK.finishOnce();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="760" y="1330" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-62" value="worker-retry-connector-service-executor&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;每30s, 检查一下是否有连接异常的，&lt;br&gt;对异常的连接进行重连&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-63" value="&lt;font style=&quot;font-size: 10px&quot;&gt;newSingleThreadScheduledExecutor&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#3399ff&quot;&gt;每30s, 拉取一下worker信息&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="1560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-261" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-64" target="y0gIganFQs9rjsJ_vc2o-260">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-64" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;EtcdStarter#fetchRule()&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#3399ff&quot;&gt;每5s, 拉取一下rule规则信息, 拉取成功后关闭定时任务，否则定期重试&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="1639" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-65" value="PushSchedulerStarter" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="910" y="930" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-66" value="PushSchedulerStarter" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="910" y="1300" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=2.7;entryDy=0;entryPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-67" target="y0gIganFQs9rjsJ_vc2o-76">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1720" y="1222" />
              <mxPoint x="1720" y="1190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-166" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-77">
          <mxGeometry x="0.7388" y="-2" relative="1" as="geometry">
            <mxPoint x="-246" y="28" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-67" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;public void &lt;b&gt;send&lt;/b&gt;(String appName, List&amp;lt;HotKeyModel&amp;gt; list) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //积攒了半秒的key集合，按照hash分发到不同的worker&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long now = System.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Map&amp;lt;Channel, List&amp;lt;HotKeyModel&amp;gt;&amp;gt; map = new HashMap&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 分组&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for(HotKeyModel model : list) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; model.setCreateTime(now);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 这里实现负载均衡, 策略是对 key “哈希取模”， 所以一个 key 的热度增量总是会推送到同一个Worker&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Channel channel = WorkerInfoHolder.&lt;b&gt;chooseChannel&lt;/b&gt;(model.getKey());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (channel == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; newList = map.computeIfAbsent(channel, k -&amp;gt; new ArrayList&amp;lt;&amp;gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; newList.add(model);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 批量发送&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (Channel channel : map.keySet()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; batch = map.get(channel);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyMsg hotKeyMsg = new &lt;b&gt;HotKeyMsg&lt;/b&gt;(MessageType.REQUEST_NEW_KEY, Context.APP_NAME);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hotKeyMsg.setHotKeyModels(batch);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;channel&lt;/b&gt;.&lt;b&gt;writeAndFlush&lt;/b&gt;(hotKeyMsg).sync();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 记录错误日志 ...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1240" y="960" width="440" height="350" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-239" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=2.7;entryDy=0;entryPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-69" target="y0gIganFQs9rjsJ_vc2o-76">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1720" y="1390" />
              <mxPoint x="1720" y="1190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-240" value="5" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-239">
          <mxGeometry x="-0.8503" y="-1" relative="1" as="geometry">
            <mxPoint x="-9" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-69" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 类似 send()， 同样先选择 Worker, 然后按Channel将数据分组最后批量发送&amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;Channel channel = WorkerInfoHolder.&lt;b&gt;chooseChannel&lt;/b&gt;(model.getRuleKey());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;HotKeyMsg hotKeyMsg = new &lt;b&gt;HotKeyMsg&lt;/b&gt;(MessageType.REQUEST_HIT_COUNT, Context.APP_NAME);&lt;/div&gt;&lt;div&gt;hotKeyMsg.setKeyCountModels(batch);&lt;/div&gt;&lt;div&gt;channel.&lt;b&gt;writeAndFlush&lt;/b&gt;(hotKeyMsg).sync();&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1330" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-71" target="y0gIganFQs9rjsJ_vc2o-73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-71" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;WorkerInfoHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;客户端存储 Worker 集群信息的容器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private static final List&amp;lt;Server&amp;gt; WORKER_HOLDER = new &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="920" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-72" value="NettyKeyPusher" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1405" y="930" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-73" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;WorkerInfoHolder&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;$Server&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Worker 服务器信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String address;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private Channel channel;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-880" y="920" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-80" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-75" target="y0gIganFQs9rjsJ_vc2o-79">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-75" value="&lt;b&gt;Worker&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SpringBoot 应用&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2440.18" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-103" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" target="y0gIganFQs9rjsJ_vc2o-85">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2160" y="1180" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="2460" y="1180" />
              <mxPoint x="2460" y="390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-167" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-103">
          <mxGeometry x="-0.9702" y="-1" relative="1" as="geometry">
            <mxPoint x="280" y="-31" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-206" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" target="y0gIganFQs9rjsJ_vc2o-202">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2000" y="1200" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="2000" y="1200" />
              <mxPoint x="1740" y="1200" />
              <mxPoint x="1740" y="2320" />
              <mxPoint x="750" y="2320" />
              <mxPoint x="750" y="2345" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-207" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-206">
          <mxGeometry x="-0.9871" y="3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-76" value="" style="strokeWidth=1;outlineConnect=0;dashed=0;align=center;html=1;fontSize=8;shape=mxgraph.eip.messageChannel;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;fontColor=#3399FF;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1170" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-78" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;Netty Channel&lt;br&gt;客户端与每个连接Worker都会维持一个连接&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1210" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-79" target="y0gIganFQs9rjsJ_vc2o-81">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-79" value="&lt;b&gt;NodesServerStarter&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;配置并启动 Netty 服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2680.18" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-81" target="y0gIganFQs9rjsJ_vc2o-86">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-81" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;AsyncPool.asyncDo(() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; NodesServer nodesServer = new NodesServer();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; nodesServer.setClientChangeListener(iClientChangeListener);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; nodesServer.setMessageFilters(messageFilters);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nodesServer.&lt;b style=&quot;font-size: 10px;&quot;&gt;startNettyServer&lt;/b&gt;(port);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.printStackTrace();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="120" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-83" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NodesServer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Worker 的 Netty 服务器节点&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 监听Netty客户端连接断开事件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private IClientChangeListener &lt;b&gt;clientChangeListener&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 没有定义多个ChannelHandler, 只定义了一个名为 NodeServerHandler 的 ChannelHandler，内部包含由多个 INettyMsgFilter 组成的责任链，用于处理客户端 Netty 请求&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private List&amp;lt;INettyMsgFilter&amp;gt; &lt;b&gt;messageFilters&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="920" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-92" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-85" target="y0gIganFQs9rjsJ_vc2o-94">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2920.18" y="390" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-85" value="&lt;b&gt;NodesServerHandler&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;Netty 客户端请求处理器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2680.18" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-89" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-86" target="y0gIganFQs9rjsJ_vc2o-88">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-86" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;ServerBootstrap bootstrap = new ServerBootstrap();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;bootstrap.group(bossGroup, workerGroup)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .channel(NioServerSocketChannel.class)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .handler(new LoggingHandler(LogLevel.INFO))&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .option(ChannelOption.SO_BACKLOG, 1024)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .childOption(ChannelOption.SO_KEEPALIVE, true)&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //出来网络io事件，如记录日志、对消息编解码等&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .childHandler(new &lt;b&gt;ChildChannelHandler&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//绑定端口，同步等待成功&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ChannelFuture future = bootstrap.bind(port).sync();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;Runtime.getRuntime().addShutdownHook(new Thread(() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; bossGroup.shutdownGracefully (1000, 3000, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; workerGroup.shutdownGracefully (1000, 3000, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//等待服务器监听端口关闭&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;future.channel().closeFuture().sync();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="3400.18" y="120" width="440" height="220" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-116" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-88" target="y0gIganFQs9rjsJ_vc2o-85">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4340.18" y="230" />
              <mxPoint x="4340.18" y="350" />
              <mxPoint x="2780.18" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-88" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;ch.pipeline()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new DelimiterBasedFrameDecoder(Constant.MAX_LENGTH, delimiter))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new &lt;b&gt;MsgDecoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new &lt;b&gt;MsgEncoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;serverHandler&lt;/b&gt;);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="3880.18" y="180" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-262" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-90" target="y0gIganFQs9rjsJ_vc2o-163">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-274" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-90" target="y0gIganFQs9rjsJ_vc2o-267">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-313" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-90" target="y0gIganFQs9rjsJ_vc2o-309">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-314" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-90" target="y0gIganFQs9rjsJ_vc2o-310">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-90" value="&lt;b&gt;EtcdStarter&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;Etcd客户端，作为配置中心&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2680.18" y="2130" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-94" target="y0gIganFQs9rjsJ_vc2o-97">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-94" value="HeartBeatFilter&lt;br&gt;&lt;font color=&quot;#3399ff&quot; style=&quot;font-size: 10px&quot;&gt;处理 MessageType.&lt;b&gt;PING&lt;/b&gt;&lt;br&gt;用于&lt;b&gt;维持连接&lt;/b&gt;，返回 &lt;b&gt;PONG&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-106" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-97" target="y0gIganFQs9rjsJ_vc2o-100">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-110" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-97" target="y0gIganFQs9rjsJ_vc2o-109">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-97" value="AppNameFilter&lt;br&gt;&lt;font style=&quot;font-size: 10px&quot; color=&quot;#3399ff&quot;&gt;处理MessageType.&lt;b&gt;APP_NAME&lt;/b&gt;&lt;br&gt;用于&lt;b&gt;注册新的客户端&lt;br&gt;&lt;/b&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-107" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-100" target="y0gIganFQs9rjsJ_vc2o-102">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-100" target="y0gIganFQs9rjsJ_vc2o-114">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-117" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-115">
          <mxGeometry x="0.0184" y="-4" relative="1" as="geometry">
            <mxPoint y="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-100" value="HotKeyFilter&lt;br&gt;&lt;font style=&quot;font-size: 9px&quot; color=&quot;#3399ff&quot;&gt;处理MessageType.&lt;b&gt;REQUEST_NEW_KEY&lt;/b&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-248" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-102" target="y0gIganFQs9rjsJ_vc2o-247">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-102" value="KeyCounterFilter&lt;br&gt;&lt;font color=&quot;#3399ff&quot; style=&quot;font-size: 9px&quot;&gt;处理MessageType.&lt;b&gt;REQUEST_HIT_COUNT&lt;/b&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-104" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;这里用责任链感觉并不合适, 不是多步骤处理，&lt;br&gt;更适合写成分发器的方式&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2680.18" y="440" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-109" target="y0gIganFQs9rjsJ_vc2o-111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-109" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;clientEventListener.newClient(&lt;br style=&quot;font-size: 10px;&quot;&gt;appName, NettyIpUtil.clientIp(ctx), ctx);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-175" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-111" target="y0gIganFQs9rjsJ_vc2o-174">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-111" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//内部创建&amp;nbsp;DefaultChannelGroup&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;AppInfo appInfo = new AppInfo(appName);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ClientInfoHolder.&lt;b&gt;apps&lt;/b&gt;.add(appInfo);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 将当前通信的 channel 加入到 DefaultChannelGroup 实例&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;appInfo.&lt;b&gt;add&lt;/b&gt;(ctx);&lt;/div&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left;" vertex="1" parent="1">
          <mxGeometry x="3400.18" y="440" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-173" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-113" target="y0gIganFQs9rjsJ_vc2o-172">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-113" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientInfoHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Worker 存储连接的客户端信息的容器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;public static List&amp;lt;AppInfo&amp;gt; &lt;b&gt;apps&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="1120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-114" target="y0gIganFQs9rjsJ_vc2o-118">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-114" value="publishMsg(message, ctx);" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-121" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-118" target="y0gIganFQs9rjsJ_vc2o-120">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-118" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;private void publishMsg(HotKeyMsg message, ChannelHandlerContext ctx) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; models = message.getHotKeyModels();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (HotKeyModel model : models) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 热key探测规则：白名单key不处理&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (WhiteListHolder.contains(model.getKey())) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long timeOut = now - model.getCreateTime();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (timeOut &amp;gt; 1000) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 超时记录日志 ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 生产者消费者模式，实现批量统计&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; keyProducer.&lt;b&gt;push&lt;/b&gt;(model, now);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;arcSize=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="3400.18" y="520" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-131" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-120" target="y0gIganFQs9rjsJ_vc2o-128">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4090.1800000000003" y="620" />
              <mxPoint x="4090.1800000000003" y="1090" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-132" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-131">
          <mxGeometry x="0.6762" y="2" relative="1" as="geometry">
            <mxPoint x="-12" y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-120" value="&lt;div style=&quot;&quot;&gt;QUEUE.put(model);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;上报的key热度增量，暂存在 DispatcherConfig.QUEUE 中，由异步任务拉取后批量统计&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;arcSize=12;align=left;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="3880.18" y="590" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-122" value="KeyProducer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3935.18" y="560" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-125" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-123" target="y0gIganFQs9rjsJ_vc2o-124">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-238" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-123" target="y0gIganFQs9rjsJ_vc2o-162">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-123" value="&lt;b&gt;线程池异步任务&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2680.18" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-127" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-124" target="y0gIganFQs9rjsJ_vc2o-126">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-124" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;@Bean&lt;/div&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;DispatcherConfig#consumer()&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=center;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-129" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-126" target="y0gIganFQs9rjsJ_vc2o-128">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-126" value="&lt;div&gt;for (int i = 0; i &amp;lt; &lt;b&gt;nowCount&lt;/b&gt;; i++) { &lt;font color=&quot;#007fff&quot;&gt;// nowCount 是配置的统计key热度的线程数量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; KeyConsumer keyConsumer = new KeyConsumer();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; keyConsumer.setKeyListener(iKeyListener);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; consumerList.add(keyConsumer);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; threadPoolExecutor.&lt;b&gt;submit&lt;/b&gt;(keyConsumer::&lt;b&gt;beginConsume&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="1040" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-128" target="y0gIganFQs9rjsJ_vc2o-133">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4100.18" y="1140" />
              <mxPoint x="4100.18" y="890" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-138" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-128" target="y0gIganFQs9rjsJ_vc2o-137">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-133" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public void &lt;b style=&quot;font-size: 10px;&quot;&gt;removeKey&lt;/b&gt;(HotKeyModel hotKeyModel, KeyEventOriginal original) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // Worker中key热度统计的键名： AppName-KeyType-KeyName&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String key = &lt;b&gt;buildKey&lt;/b&gt;(hotKeyModel);&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;hotCache&lt;/b&gt;.&lt;b&gt;invalidate&lt;/b&gt;(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; CaffeineCacheHolder.getCache(hotKeyModel.getAppName()).&lt;b&gt;invalidate&lt;/b&gt;(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //推送所有client删除&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; hotKeyModel.setCreateTime(SystemClock.now());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (IPusher pusher : iPushers) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pusher.&lt;b&gt;remove&lt;/b&gt;(hotKeyModel);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="4120.18" y="820" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-135" value="&lt;b&gt;KeyListener&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="4280.18" y="790" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-136" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyListener&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;Worker 中实现key热度统计和删除&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;// 使用本地缓存存储检测出的热key， AppName-KeyType-KeyName -&amp;gt; 1&lt;/b&gt;&lt;br&gt;// value 固定写1，只是用于填充，没有什么意义&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;@Resource(name = &quot;hotKeyCache&quot;)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private Cache&amp;lt;String, Object&amp;gt; &lt;b&gt;hotCache&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;@Resource&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private List&amp;lt;IPusher&amp;gt; &lt;b&gt;iPushers&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1120" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-137" target="y0gIganFQs9rjsJ_vc2o-140">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-143" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-137" target="y0gIganFQs9rjsJ_vc2o-141">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-151" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-137" target="y0gIganFQs9rjsJ_vc2o-150">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-152" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-151">
          <mxGeometry x="0.9011" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-156" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-137" target="y0gIganFQs9rjsJ_vc2o-154">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-157" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-156">
          <mxGeometry x="0.9189" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-137" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public void &lt;b&gt;newKey&lt;/b&gt;(HotKeyModel hotKeyModel, KeyEventOriginal original) {&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // Worker中key热度统计的键名： AppName-KeyType-KeyName&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; String key = &lt;b&gt;buildKey&lt;/b&gt;(hotKeyModel);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 已经是热key了，不需要继续统计&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Object o = hotCache.&lt;b&gt;getIfPresent&lt;/b&gt;(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (o != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//********** watch here ************//&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //该方法会被InitConstant.threadCount个线程同时调用，存在多线程问题&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //下面的那句addCount是加了锁的，代表给Key累加数量时是原子性的，不会发生多加、少加的情况，到了设定的阈值一定会hot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //譬如阈值是2，如果多个线程累加，在没hot前，hot的状态肯定是对的，譬如thread1 加1，thread2加1，那么thread2会hot返回true，开启推送&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //但是极端情况下，譬如阈值是10，当前是9，thread1走到这里时，加1，返回true，thread2也走到这里，加1，此时是11，返回true，问题来了&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //该key会走下面的else两次，也就是2次推送。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //所以出现问题的原因是hotCache.getIfPresent(key)这一句在并发情况下，没return掉，放了两个key+1到addCount这一步时，会有问题&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //测试代码在TestBlockQueue类，直接运行可以看到会同时hot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //那么该问题用解决吗，NO，不需要解决，1 首先要发生的条件极其苛刻，很难触发，以京东这样高的并发量，线上我也没见过触发连续2次推送同一个key的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //2 即便触发了，后果也是可以接受的，2次推送而已，毫无影响，客户端无感知。但是如果非要解决，就要对slidingWindow实例加锁了，必然有一些开销&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //所以只要保证key数量不多计算就可以，少计算了没事。因为热key必然频率高，漏计几次没事。但非热key，多计算了，被干成了热key就不对了&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 通过 hotKeyModel 中的 appName 获取对应的 Caffeine Cache 实例，然后从 Cache 中获取 key 对应的滑动窗口对象&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;SlidingWindow&lt;/b&gt; &lt;b&gt;slidingWindow&lt;/b&gt; = &lt;b&gt;checkWindow&lt;/b&gt;(hotKeyModel, key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;//1 添加热度值增量并结合热度规则判断是否是热key&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean hot = slidingWindow.&lt;b&gt;addCount&lt;/b&gt;(hotKeyModel.getCount());&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!hot) { &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 不是热key&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 更新Cache中key对应的滑动窗口，cache会自动刷新过期时间&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CaffeineCacheHolder.&lt;b&gt;getCache&lt;/b&gt;(hotKeyModel.getAppName()).&lt;b&gt;put&lt;/b&gt;(key, slidingWindow);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else { &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是热key&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hotCache.put(key, 1);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //删掉该key的滑动窗口，即不需要继续统计&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CaffeineCacheHolder.getCache(hotKeyModel.getAppName()).invalidate(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hotKeyModel.setCreateTime(SystemClock.now());&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 日志 ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //2 分别推送到各client和etcd&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (IPusher pusher : iPushers) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pusher.&lt;b&gt;push&lt;/b&gt;(hotKeyModel);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="4120.18" y="980" width="440" height="580" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-139" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CaffeineCacheHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Worker 中统计key热度默认是通过 Caffeine 保存热度计数的&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// AppName -&amp;gt; Cache, 会为每个应用单独设置一个 Caffeine Cache 实例，没有指明 AppName 的会使用 default 对应的 Cache 实例&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#330033&quot;&gt;private static final Map&amp;lt;&lt;b&gt;String&lt;/b&gt;, &lt;b&gt;Cache&lt;/b&gt;&amp;lt;String, Object&amp;gt;&amp;gt; &lt;b&gt;CACHE_MAP&lt;/b&gt; = new &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private static final String DEFAULT = &quot;default&quot;;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="1320" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-140" value="CaffeineCacheHolder.CACHE_MAP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="4600.18" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-141" value="KeyRuleHolder.RULE_MAP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="4600.18" y="1300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-146" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-144" target="y0gIganFQs9rjsJ_vc2o-145">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-144" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyRuleHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;热key判断规则，每个key可以有多个规则&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// key (AppName-KeyType-KeyName)&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;-&amp;gt; List&amp;lt;KeyRule&amp;gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private static final Map&amp;lt;String, List&amp;lt;KeyRule&amp;gt;&amp;gt; &lt;b&gt;RULE_MAP&lt;/b&gt; = new &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1320" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-145" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;KeyRule&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;热key判断规则&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String &lt;b&gt;key&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// key 是否是前缀， 比如 key 值为 “goods”, 如果是前缀的话，这个规则适用于所有以 goods 为前缀的key, 如果不是前缀，只适用于 goods 这个key&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private boolean &lt;b&gt;prefix&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 即 &lt;b&gt;interval&lt;/b&gt; 秒之内被访问累积达到 &lt;b&gt;threshold&lt;/b&gt; 的key 为热key&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;interval&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;threshold&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 热key在本地以及 ETCD 中缓存的时间，单位秒，默认60s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int&amp;nbsp;&lt;/font&gt;&lt;b&gt;duration&lt;/b&gt;&lt;font color=&quot;#330033&quot;&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 规则描述&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String desc;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1320" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-148" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SlidingWindow&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;热key统计的滑动窗口实现（双指针循环队列），一个滑动窗口包含多个时间片&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//循环队列，就是装多个窗口用，该数量是windowSize的2倍&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//统计窗口周期内每个时间片通过的数量&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private AtomicLong[] &lt;b&gt;timeSlices&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//队列的总长度&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;timeSliceSize&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//每个时间片的时长，以毫秒为单位，timeMillsPerSlice = 1000 / windowSize * 窗口周期（duration）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;timeMillisPerSlice&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//共有多少个时间片（即窗口周期分成多少份），&lt;br&gt;探测时间&amp;lt;=5s 设置5, &amp;gt;5s 且 &amp;lt;=600s 设置10，&amp;gt;600s 设置 600&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;windowSize&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//在一个完整窗口周期内允许热 key 阈值&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private int &lt;b&gt;threshold&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这两个值其实就是滑动窗口的两个指针&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//该滑窗的起始创建时间，也就是第一个数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private long &lt;b&gt;beginTimestamp&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最后一个数据的时间戳&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private long &lt;b&gt;lastAddTimestamp&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="1520" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-149" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;没看明白这里为何要把循环队列的长度设置为时间片个数的两倍，&lt;br&gt;感觉没必要，循环队列的长度和时间片个数相同应该也是可以的&lt;br&gt;&lt;br&gt;&lt;b&gt;另外这个滑动窗口实现其实可以更简洁，beginTImestamp 和&lt;br&gt;&lt;/b&gt;lastAddTimestamp 没必要，&lt;br&gt;可以参考 &lt;b&gt;Sentinel 限流规则中滑动窗口&lt;/b&gt;的实现&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-750" y="1520" width="310" height="100" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-159" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-150" target="y0gIganFQs9rjsJ_vc2o-158">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-150" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public void push(HotKeyModel model) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; hotKeyStoreQueue.offer(model);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="4600.18" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-153" value="AppServerPusher" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="4640.18" y="1370" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-161" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-154" target="y0gIganFQs9rjsJ_vc2o-160">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-154" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public void push(HotKeyModel model) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; hotKeyStoreQueue.offer(model);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="4600.18" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-155" value="DashboardPusher" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="4640.18" y="1470" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-272" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-158" target="y0gIganFQs9rjsJ_vc2o-164">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-273" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-272">
          <mxGeometry x="0.974" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-158" value="&lt;div style=&quot;&quot;&gt;AppServerPusher.hotKeyStoreQueue&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;fontSize=10;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="4840.18" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-277" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-160" target="y0gIganFQs9rjsJ_vc2o-275">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5070.18" y="1530" />
              <mxPoint x="5070.18" y="2390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-278" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-277">
          <mxGeometry x="0.979" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-160" value="&lt;div style=&quot;&quot;&gt;DashboardPusher.hotKeyStoreQueue&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;fontSize=10;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="4840.18" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-242" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-162" target="y0gIganFQs9rjsJ_vc2o-241">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-162" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;@Bean&lt;/div&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;CounterConfig#counterConsumer()&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=center;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-165" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-163" target="y0gIganFQs9rjsJ_vc2o-164">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-163" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;@PostConstruct&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;AppServerPusher#batchPushToClient()&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一个异步任务，批量将检测出来的热key推送到客户端&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="2130" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-169" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-164" target="y0gIganFQs9rjsJ_vc2o-168">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-164" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;AsyncPool.asyncDo(() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; while (true) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; tempModels = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //每10ms推送一次，Guava 此方法用于阻塞地从hotKeyStoreQueue中读取10个元素到 tempModels, 如果超时（10ms）立即返回, 基于 JDK&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;drainTo 方法实现&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Queues.&lt;b&gt;drain&lt;/b&gt;(hotKeyStoreQueue, tempModels, 10, 10, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Map&amp;lt;String, List&amp;lt;HotKeyModel&amp;gt;&amp;gt; allAppHotKeyModels = new HashMap&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //拆分出每个app的热key集合，按app分堆&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //遍历所有app，分别进行推送&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (AppInfo appInfo : ClientInfoHolder.apps) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; list = allAppHotKeyModels.get(appInfo.getAppName());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HotKeyMsg hotKeyMsg = new &lt;b&gt;HotKeyMsg&lt;/b&gt;(MessageType.&lt;b&gt;RESPONSE_NEW_KEY&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hotKeyMsg.setHotKeyModels(list);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //整个app全部发送&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; appInfo.&lt;b&gt;groupPush&lt;/b&gt;(hotKeyMsg);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; allAppHotKeyModels = null;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.printStackTrace();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="2000" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-176" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-168" target="y0gIganFQs9rjsJ_vc2o-76">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1920" y="1190" as="targetPoint" />
            <mxPoint x="3412.7" y="1470" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="3860" y="2160" />
              <mxPoint x="3860" y="1980" />
              <mxPoint x="2460" y="1980" />
              <mxPoint x="2460" y="1190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-177" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-176">
          <mxGeometry x="0.6659" y="-2" relative="1" as="geometry">
            <mxPoint y="-126" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-168" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void groupPush(Object object) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 发送HotKeyMsg将热key推送到所有客户端实例&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;channelGroup&lt;/b&gt;.&lt;b&gt;writeAndFlush&lt;/b&gt;(object);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="3640.18" y="2130" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-170" value="AppInfo" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3710.18" y="2098" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-172" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AppInfo&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Worker 存储连接的客户端信息的容器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String &lt;b&gt;appName&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private &lt;b&gt;ChannelGroup&lt;/b&gt; &lt;b&gt;channelGroup&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-174" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;新客户端信息维护在&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;ClientInfoHolder.&lt;b style=&quot;font-size: 10px;&quot;&gt;apps&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="3880.18" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-182" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-179" target="y0gIganFQs9rjsJ_vc2o-181">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-179" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;private NettyClient() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (bootstrap == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bootstrap = initBootstrap();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="520" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-186" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-181" target="y0gIganFQs9rjsJ_vc2o-185">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="2010" />
              <mxPoint x="1220" y="2080" />
              <mxPoint x="500" y="2080" />
              <mxPoint x="500" y="2120" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-181" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;ch.pipeline()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new DelimiterBasedFrameDecoder(Constant.MAX_LENGTH, delimiter))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new MsgDecoder())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new MsgEncoder())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//30秒没消息时，就发心跳包过去&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(new IdleStateHandler(0, 0, 30))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;nettyClientHandler&lt;/b&gt;);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="760" y="1960" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-188" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-185" target="y0gIganFQs9rjsJ_vc2o-190">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="760" y="2120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-193" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-185" target="y0gIganFQs9rjsJ_vc2o-192">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-199" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-185" target="y0gIganFQs9rjsJ_vc2o-196">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-203" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-185" target="y0gIganFQs9rjsJ_vc2o-202">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-185" value="NettyClientHandler" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="2090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-189" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" source="y0gIganFQs9rjsJ_vc2o-190" target="y0gIganFQs9rjsJ_vc2o-191" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-190" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;userEventTriggered(...)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#3399ff&quot; style=&quot;font-size: 10px;&quot;&gt;监听到 ALL_IDLE事件，发送PING维持连接&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-191" value="ctx.&lt;b&gt;writeAndFlush&lt;/b&gt;(new HotKeyMsg(MessageType.&lt;b&gt;PING&lt;/b&gt;, Context.APP_NAME));" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-195" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-192" target="y0gIganFQs9rjsJ_vc2o-194">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-192" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;userEventTriggered(...)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#3399ff&quot; style=&quot;font-size: 10px;&quot;&gt;连接建立后，发送 APP_NAME 向 Worker 注册客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2170" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-194" value="ctx.writeAndFlush(new HotKeyMsg(MessageType.&lt;b style=&quot;font-size: 10px;&quot;&gt;APP_NAME&lt;/b&gt;, Context.APP_NAME));" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2170" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-198" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-196" target="y0gIganFQs9rjsJ_vc2o-197">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-196" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;channelInactive(...)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#3399ff&quot; style=&quot;font-size: 10px;&quot;&gt;连接断开后&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-201" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-197" target="y0gIganFQs9rjsJ_vc2o-200">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-197" value="notifyWorkerChange(ctx.channel());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-237" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-200" target="y0gIganFQs9rjsJ_vc2o-218">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1470" y="2280" />
              <mxPoint x="1470" y="2610" />
              <mxPoint x="980" y="2610" />
              <mxPoint x="980" y="2655" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-200" value="&lt;b&gt;EventBusCenter&lt;/b&gt;.getInstance().&lt;b&gt;post&lt;/b&gt;(new &lt;b&gt;ChannelInactiveEvent&lt;/b&gt;(channel));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;向 EventBus 发送事件&amp;nbsp;ChannelInactiveEvent&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-205" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-202" target="y0gIganFQs9rjsJ_vc2o-204">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-202" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;channelRead0(...)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#3399ff&quot;&gt;读取到Worker数据&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2330" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-224" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-204" target="y0gIganFQs9rjsJ_vc2o-221">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="2395" />
              <mxPoint x="1460" y="2780" />
              <mxPoint x="980" y="2780" />
              <mxPoint x="980" y="2840" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-204" value="&lt;div&gt;if (MessageType.PONG == msg.getMessageType()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ... 仅仅打印下日志 ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (MessageType.&lt;b&gt;RESPONSE_NEW_KEY&lt;/b&gt; == msg.getMessageType()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (HotKeyModel model : msg.getHotKeyModels()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;EventBusCenter&lt;/b&gt;.getInstance().&lt;b&gt;post&lt;/b&gt;(new &lt;b&gt;ReceiveNewKeyEvent&lt;/b&gt;(model));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;align=left;arcSize=4;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2330" width="440" height="130" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-209" value="&lt;font color=&quot;#007fff&quot;&gt;线程池定时任务和后面的组件均是&lt;br&gt;由 &lt;b&gt;ClientStarter&lt;/b&gt;#&lt;b&gt;startPipeline&lt;/b&gt;() 初始化&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="280" y="1060" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-216" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-213" target="y0gIganFQs9rjsJ_vc2o-215">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-217" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-216">
          <mxGeometry x="-0.0524" y="-3" relative="1" as="geometry">
            <mxPoint y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-219" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-213" target="y0gIganFQs9rjsJ_vc2o-218">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="2540" />
              <mxPoint x="970" y="2690" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-220" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-219">
          <mxGeometry x="0.817" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-222" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-213" target="y0gIganFQs9rjsJ_vc2o-221">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="2540" />
              <mxPoint x="970" y="2880" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-223" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-222">
          <mxGeometry x="0.9165" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-226" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-213" target="y0gIganFQs9rjsJ_vc2o-225">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="2540" />
              <mxPoint x="970" y="3080" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-227" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-226">
          <mxGeometry x="0.9423" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-213" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;private void registEventBus() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //1 WorkerChangeSubscriber 监听两种事件 WorkerInfoChangeEvent、ChannelInactiveEvent&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; EventBusCenter.register(new &lt;b style=&quot;font-size: 10px;&quot;&gt;WorkerChangeSubscriber&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //2 ReceiveNewKeySubscribe 监听 ReceiveNewKeyEvent&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; EventBusCenter.register(new &lt;b style=&quot;font-size: 10px;&quot;&gt;ReceiveNewKeySubscribe&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //3 KeyRuleHolder 监听&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; EventBusCenter.register(new &lt;b style=&quot;font-size: 10px;&quot;&gt;KeyRuleHolder&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="520" y="2480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-215" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;@Subscribe&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public void connectAll(&lt;b style=&quot;font-size: 10px;&quot;&gt;WorkerInfoChangeEvent&lt;/b&gt; event) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;String&amp;gt; addresses = event.getAddresses();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (addresses == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addresses = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; WorkerInfoHolder.&lt;b style=&quot;font-size: 10px;&quot;&gt;mergeAndConnectNew&lt;/b&gt;(addresses);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-218" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;@Subscribe&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public void channelInactive(&lt;b style=&quot;font-size: 10px;&quot;&gt;ChannelInactiveEvent&lt;/b&gt; inactiveEvent) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //获取断线的channel&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Channel channel = inactiveEvent.getChannel();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; InetSocketAddress socketAddress = (InetSocketAddress) channel&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;.remoteAddress();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String address = socketAddress.getHostName() + &quot;:&quot; + &lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;socketAddress.getPort();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; WorkerInfoHolder.&lt;b style=&quot;font-size: 10px;&quot;&gt;dealChannelInactive&lt;/b&gt;(address);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2620" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-229" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-221" target="y0gIganFQs9rjsJ_vc2o-228">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-221" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;@Subscribe&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public void newKeyComing(&lt;b&gt;ReceiveNewKeyEvent&lt;/b&gt; event) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; HotKeyModel hotKeyModel = event.getModel();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (hotKeyModel == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (receiveNewKeyListener != null) {&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; receiveNewKeyListener.&lt;b style=&quot;font-size: 10px;&quot;&gt;newKey&lt;/b&gt;(hotKeyModel);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2800" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-225" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;@Subscribe&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public void ruleChange(&lt;b&gt;KeyRuleInfoChangeEvent&lt;/b&gt; event) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; JdLogger.info(getClass(), &quot;new rules info is :&quot; + event.getKeyRules());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;KeyRule&amp;gt; ruleList = event.getKeyRules();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (ruleList == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 缓存热key规则到本地 &lt;b&gt;KeyRuleHolder&lt;/b&gt;.&lt;b&gt;KEY_RULES&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; putRules(ruleList);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1000" y="3000" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-232" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-228" target="y0gIganFQs9rjsJ_vc2o-231">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-228" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public void newKey(HotKeyModel hotKeyModel) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; long now = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //如果key到达时已经过去1秒了，记录一下。手工删除key时，没有CreateTime&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (hotKeyModel.isRemove()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //如果是删除事件，就直接删除, 即从本地缓存中删除&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;deleteKey&lt;/b&gt;(hotKeyModel.getKey());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //已经是热key了，又推过来同样的热key，做个日志记录，并刷新一下&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;addKey&lt;/b&gt;(hotKeyModel.getKey());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1480" y="2800" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-230" value="DefaultNewKeyListener" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1630" y="2770" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-236" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-231" target="y0gIganFQs9rjsJ_vc2o-235">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-231" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;private void addKey(String key) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //会检查key是否存在热key规则，可能之前存在现在删除了，所以需要再检查下&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ValueModel valueModel = ValueModel.defaultValue(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (valueModel == null) {&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//即没有对应的规则&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deleteKey(key);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp; //如果原来该key已经存在了，那么value就被重置，过期时间也会被重置。&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //如果原来不存在，就新增的热key, 即将 valueModel 加入本地缓存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //！！！注意这里 valueModel 中 value 存储的是默认值&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;MAGIC_NUMBER&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; JdHotKeyStore.&lt;b&gt;setValueDirectly&lt;/b&gt;(key, valueModel);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2800" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-235" value="&lt;b&gt;CaffeineCache.cache&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1960" y="3000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-244" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-241" target="y0gIganFQs9rjsJ_vc2o-243">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-241" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;div&gt;CounterConsumer counterConsumer = new &lt;b&gt;CounterConsumer&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;counterConsumer.&lt;b&gt;beginConsume&lt;/b&gt;(configCenter);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="1700" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-246" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-243" target="y0gIganFQs9rjsJ_vc2o-245">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-243" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Map&amp;lt;String, String&amp;gt; map = new HashMap&amp;lt;&amp;gt;(500);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; while (true) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyCountItem item = COUNTER_QUEUE.&lt;b&gt;take&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;&lt;b&gt;KeyCountModel&lt;/b&gt;&amp;gt; keyCountModels = item.getList();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String appName = item.getAppName();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (KeyCountModel keyCountModel : keyCountModels) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// rule + Constant.COUNT_DELIMITER + nowTime;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 比如：pin__#**#2020-10-23 21:11:22&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String ruleKey = keyCountModel.getRuleKey();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int hotHitCount = keyCountModel.getHotHitCount();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int totalHitCount = keyCountModel.getTotalHitCount();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//mapkey：ConfigConstant.keyHitCountPath + appName + &quot;/&quot; + IpUtils.getIp() + &quot;-&quot; + System.currentTimeMillis() +&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String &lt;b&gt;mapKey&lt;/b&gt; = appName + Constant.COUNT_DELIMITER + ruleKey;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (map.get(mapKey) == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; map.&lt;b&gt;put&lt;/b&gt;(&lt;b&gt;mapKey&lt;/b&gt;, hotHitCount + &quot;-&quot; + totalHitCount);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String[] counts = map.get(mapKey).split(&quot;-&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int hotCount = Integer.valueOf(counts[0]) + hotHitCount;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int totalCount = Integer.valueOf(counts[1]) + totalHitCount;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; map.&lt;b&gt;put&lt;/b&gt;(&lt;b&gt;mapKey&lt;/b&gt;, hotCount + &quot;-&quot; + totalCount);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //积累一批(300)key访问计数上报到 Etcd&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (&lt;b&gt;map.size() &amp;gt;= 300&lt;/b&gt;) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 比如&amp;nbsp;/jd/keyHitCount/sample/&amp;lt;ip&amp;gt;-&amp;lt;timestamp&amp;gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;configCenter&lt;/b&gt;.&lt;b&gt;putAndGrant&lt;/b&gt;(ConfigConstant.keyHitCountPath + appName + &quot;/&quot; + &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;IpUtils.getIp()&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;+ &quot;-&quot; + System.currentTimeMillis(),&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; FastJsonUtils.&lt;b&gt;convertObjectToJSON&lt;/b&gt;(map), 30);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; logger.info(&quot;key Hit count : &quot; + map);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; map.clear();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="3640.18" y="1500" width="440" height="460" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-245" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;div&gt;public long &lt;b&gt;putAndGrant&lt;/b&gt;(String key, String value, long ttl) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 存储到 Etcd&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; LeaseGrantResponse lease = &lt;b&gt;leaseClient&lt;/b&gt;.grant(ttl).sync();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;put&lt;/b&gt;(key, value, lease.getID());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return lease.getID();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#d5e8d4;strokeColor=#82b366;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="4120.18" y="1690" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-250" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-247" target="y0gIganFQs9rjsJ_vc2o-249">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-247" value="publishMsg(message.getAppName(), message, ctx);" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-252" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-249" target="y0gIganFQs9rjsJ_vc2o-251">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-249" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;private void publishMsg(String appName, HotKeyMsg message, ChannelHandlerContext ctx) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;KeyCountModel&amp;gt; models = message.getKeyCountModels();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long timeOut = SystemClock.now() - models.get(0).getCreateTime();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //超时5秒以上的就不统计了，因为client是每10秒发送一次，所以最迟15秒以后的就不处理了&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (timeOut &amp;gt; InitConstant.timeOut + 10000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; logger.warn(&quot;key count timeout &quot; + timeOut + &quot;, from ip : &quot; + NettyIpUtil.clientIp(ctx));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //将收到的key放入延时队列，15秒后进行累加并发送&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; COUNTER_QUEUE.&lt;b&gt;put&lt;/b&gt;(new KeyCountItem(appName, models.get(0).getCreateTime(), models));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.printStackTrace();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;arcSize=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="3400.18" y="760" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-254" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-251" target="y0gIganFQs9rjsJ_vc2o-243">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4110.18" y="860" />
              <mxPoint x="4110.18" y="1615" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-255" value="&lt;font color=&quot;#007fff&quot;&gt;读取&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-254">
          <mxGeometry x="0.8513" y="-1" relative="1" as="geometry">
            <mxPoint x="-9" y="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-251" value="&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;上报的key访问增量，暂存在 &lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;CounterConfig&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;.&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;COUNTER_QUEUE&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;&amp;nbsp;中，由异步任务拉取后批量统计&lt;/b&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fontSize=10;arcSize=12;align=left;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="3880.18" y="830" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-256" value="Etcd&lt;br&gt;(作为注册中心、配置中心、KV数据库)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#0050ef;fontColor=#ffffff;strokeColor=#001DBC;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1640" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-259" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;KeyCountModel&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//规则名+&amp;nbsp;#**#&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;+时间点，比如&amp;nbsp;pin_#**#2020-08-09 11:32:43&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#330033&quot;&gt;private String &lt;b&gt;ruleKey&lt;/b&gt;;&lt;br&gt;&lt;/font&gt;private int &lt;b&gt;totalHitCount&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;hotHitCount&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;createTime&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-880" y="760" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-264" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-260" target="y0gIganFQs9rjsJ_vc2o-263">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-282" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-260" target="y0gIganFQs9rjsJ_vc2o-281">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-260" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 1 从 Etcd 中拉取规则&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean success = &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;fetchRuleFromEtcd&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (success) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;//从Etcd拉取已存在的热key保存到本地缓存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;fetchExistHotKey&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; scheduledExecutorService.shutdown(); &lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#cc0066&quot;&gt;// 关闭定时任务，关闭后如果规则有更新怎么感知？&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="760" y="1639" width="440" height="121" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-263" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;List&amp;lt;KeyRule&amp;gt; ruleList = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//从etcd获取应用自己的rule， /jd/rules/&amp;lt;appName&amp;gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;String rules = configCenter.&lt;b&gt;get&lt;/b&gt;(ConfigConstant.rulePath + Context.APP_NAME);&lt;/div&gt;&lt;div&gt;if (StringUtil.isNullOrEmpty(rules)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; JdLogger.warn(getClass(), &quot;rule is empty&quot;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //会清空本地缓存队列&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;notifyRuleChange&lt;/b&gt;(ruleList);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;ruleList = FastJsonUtils.toList(rules, KeyRule.class);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 发送&amp;nbsp;KeyRuleInfoChangeEvent&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;notifyRuleChange&lt;/b&gt;(ruleList);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1640" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-276" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-267" target="y0gIganFQs9rjsJ_vc2o-275">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-267" value="&lt;div style=&quot;text-align: left;&quot;&gt;@PostConstruct&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 10px;&quot;&gt;&lt;b&gt;DashboardPusher&lt;/b&gt;#&lt;b style=&quot;font-size: 10px;&quot;&gt;uploadToDashboard&lt;/b&gt;()&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="2920.18" y="2410" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-280" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-275" target="y0gIganFQs9rjsJ_vc2o-279">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-275" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;AsyncPool.asyncDo(() -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; while (true) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //要么key达到1千个，要么达到1秒，就汇总上报给etcd一次&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HotKeyModel&amp;gt; tempModels = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Queues.&lt;b&gt;drain&lt;/b&gt;(hotKeyStoreQueue, tempModels, 1000, 1, TimeUnit.SECONDS);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (CollectionUtil.isEmpty(tempModels)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //将热key推到dashboard&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DashboardHolder.&lt;b&gt;flushToDashboard&lt;/b&gt;(FastJsonUtils.convertObjectToJSON(tempModels));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.printStackTrace();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="3160.18" y="2340" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-279" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;public static void flushToDashboard(String message) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HotKeyMsg hotKeyMsg = new &lt;b&gt;HotKeyMsg&lt;/b&gt;(MessageType.&lt;b&gt;REQUEST_HOT_KEY&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; hotKeyMsg.setBody(message);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 发送HotKeyMsg将热key推送到 Dashboard&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;channel&lt;/b&gt;.&lt;b&gt;writeAndFlush&lt;/b&gt;(MsgBuilder.buildByteBuf(hotKeyMsg));&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="3640.18" y="2400" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-283" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-281" target="y0gIganFQs9rjsJ_vc2o-221">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1690" y="1890" />
              <mxPoint x="1690" y="2780" />
              <mxPoint x="980" y="2780" />
              <mxPoint x="980" y="2840" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-281" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#cc0066&quot;&gt;// 这里的热key是在哪里写入Etcd的 ? Dashboard?&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;List&amp;lt;KeyValue&amp;gt; handKeyValues = &lt;b&gt;configCenter&lt;/b&gt;.getPrefix(ConfigConstant.hotKeyPath + Context.APP_NAME);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;for (KeyValue keyValue : &lt;b&gt;handKeyValues&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String key = keyValue.getKey().toStringUtf8().replace(ConfigConstant.hotKeyPath + Context.APP_NAME + &quot;/&quot;, &quot;&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HotKeyModel model = new HotKeyModel();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; model.setRemove(false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; model.setKey(key);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; EventBusCenter.getInstance().post(new &lt;b&gt;ReceiveNewKeyEvent&lt;/b&gt;(model));&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1820" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-304" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-284" target="y0gIganFQs9rjsJ_vc2o-303">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-284" value="&lt;b&gt;Dashboard&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SpringBoot Web 应用&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2440" y="3200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-287" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#3399FF;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-290" target="y0gIganFQs9rjsJ_vc2o-291">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-290" value="其他异步任务&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;和客户端的操作差不多&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2680" y="2740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-291" value="日志监听" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-294" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=14;fontColor=#3399FF;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-298" target="y0gIganFQs9rjsJ_vc2o-299">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-295" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=14;fontColor=#3399FF;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-298" target="y0gIganFQs9rjsJ_vc2o-300">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-296" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=14;fontColor=#3399FF;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-298" target="y0gIganFQs9rjsJ_vc2o-301">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-297" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=14;fontColor=#3399FF;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-298" target="y0gIganFQs9rjsJ_vc2o-302">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-298" value="其他定时任务&lt;br&gt;&lt;font style=&quot;font-size: 12px&quot; color=&quot;#3399ff&quot;&gt;和客户端的操作差不多&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2680" y="2820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-299" value="每分钟拉取更新一次&lt;br&gt;所有app的rule规则" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-300" value="每10s上报一次client的数量&lt;br&gt;并检查自己是否有新收到key（防止网络问题断连）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-301" value="每30s获取一下dashboard地址&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;属于服务注册与发现的功能&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-302" value="如果前面定时任务检查到一直没收到新key,可能网络断连，&lt;br&gt;就每5s上报自己的节点信息到etcd&lt;br&gt;&lt;font color=&quot;#3399ff&quot;&gt;属于服务注册与发现的功能&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2920" y="3060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-306" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-303" target="y0gIganFQs9rjsJ_vc2o-305">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-303" value="&lt;b&gt;Controller&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2680" y="3200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-308" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-305" target="y0gIganFQs9rjsJ_vc2o-307">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-305" value="/rule/save&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;规则发布接口&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="2920" y="3200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-311" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-307" target="y0gIganFQs9rjsJ_vc2o-256">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3580" y="3290" />
              <mxPoint x="3580" y="3180" />
              <mxPoint x="2440" y="3180" />
              <mxPoint x="2440" y="1685" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-312" value="热key规则" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="y0gIganFQs9rjsJ_vc2o-311">
          <mxGeometry x="0.935" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-307" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public int save(Rules rules) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String app = rules.getApp();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; KeyValue kv = configCenter.getKv(ConfigConstant.rulePath + app);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String from = null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (kv != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; from = kv.getValue().toStringUtf8();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String to = JSON.toJSONString(rules);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 存储到 Etcd，&amp;nbsp;/jd/rules/&amp;lt;appName&amp;gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;configCenter&lt;/b&gt;.&lt;b&gt;put&lt;/b&gt;(ConfigConstant.rulePath + app, rules.getRules());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 记录规则历史变更到 MySQL 表 hk_change_log&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;logMapper&lt;/b&gt;.&lt;b&gt;insertSelective&lt;/b&gt;(new ChangeLog(app, 1, from, to, rules.getUpdateUser(), app, SystemClock.nowDate()));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return 1;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="3160" y="3200" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-316" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="y0gIganFQs9rjsJ_vc2o-309" target="y0gIganFQs9rjsJ_vc2o-315">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-309" value="&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;@PostConstruct&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;watch()&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;异步任务，借助Etcd监听机制，监听热key规则变化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-310" value="@PostConstruct&lt;br style=&quot;font-size: 11px;&quot;&gt;watchWhiteList()&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;异步任务，监听key白名单变化，监听Etcd路径：&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;/jd/whiteList/&amp;lt;workerPath&amp;gt;&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="2920" y="2640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y0gIganFQs9rjsJ_vc2o-315" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; KvClient.WatchIterator watchIterator;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (isForSingle()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; watchIterator = configCenter.&lt;b style=&quot;font-size: 10px;&quot;&gt;watch&lt;/b&gt;(ConfigConstant.rulePath + workerPath);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else { &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// 监听路径 /jd/rules/&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; watchIterator = configCenter.&lt;b style=&quot;font-size: 10px;&quot;&gt;watchPrefix&lt;/b&gt;(ConfigConstant.rulePath);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; while (watchIterator.hasNext()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; WatchUpdate watchUpdate = watchIterator.next();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;Event&amp;gt; eventList = watchUpdate.getEvents();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; KeyValue keyValue = eventList.get(0).getKv();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 更新规则到Worker本地的 KeyRuleHolder 容器&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;ruleChange&lt;/b&gt;(keyValue);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="3160" y="2560" width="440" height="200" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
