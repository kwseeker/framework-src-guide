<mxfile host="Electron" modified="2024-04-13T15:52:11.747Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.7.5 Chrome/114.0.5735.289 Electron/25.8.1 Safari/537.36" etag="PdWmhGUVUnppjvHYmL1u" version="21.7.5" type="device">
  <diagram id="xTPt06P_XV9S53XWnKIQ" name="第 1 页">
    <mxGraphModel dx="2484" dy="632" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.361;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;exitPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-28" target="fPlDu5WqXSQ5xT3qjxxo-15">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1870" y="520" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1860" y="655" />
              <mxPoint x="1860" y="340" />
              <mxPoint x="1260" y="340" />
              <mxPoint x="1260" y="305" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-1" value="&lt;h1&gt;ReentrantLock 源码分析&lt;/h1&gt;&lt;p&gt;基于JDK8。&lt;br&gt;Demo:&amp;nbsp;ReentrantLockTest.java&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ReentrantLock默认是实现的非公平锁（NonfairSync), 这里主要展示非公平锁的加解锁流程&lt;/span&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="520" height="100" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-78" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-2" target="DbWMpIfpRNwdCwqWCdMp-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-2" value="ReentrantLock#&lt;b&gt;lock&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-76" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-3" target="DbWMpIfpRNwdCwqWCdMp-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-3" value="ReentrantLock#&lt;b&gt;unlock&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="460" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=open;endFill=0;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-7" target="DbWMpIfpRNwdCwqWCdMp-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="-280" y="1140" />
              <mxPoint x="-420" y="1140" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=open;endFill=0;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-7" target="DbWMpIfpRNwdCwqWCdMp-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-280" y="1140" />
              <mxPoint x="-140" y="1140" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-7" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;&lt;u&gt;ReentrantLock&lt;/u&gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;Sync sync;&amp;nbsp;&lt;/font&gt;&#x9;//NonfairSync or&amp;nbsp;FairSync，根据构造器传参数，决定是创建公平锁还是非公平锁&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1160" width="480" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=block;endFill=0;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-9" edge="1" target="fPlDu5WqXSQ5xT3qjxxo-6">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-260" y="1150" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-420" y="980" />
              <mxPoint x="-280" y="980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-9" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;&lt;u&gt;NonfairSync&lt;/u&gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;是 ReentrantLock 的内部类，&lt;br&gt;在Sync基础上又拓展了些方法&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;boolean initialTryLock()&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;boolean tryAcquire(int acquires)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1000" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=block;endFill=0;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-10" target="fPlDu5WqXSQ5xT3qjxxo-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
            <mxPoint x="-279.99999999999955" y="1070" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-140" y="980" />
              <mxPoint x="-280" y="980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-10" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;&lt;u&gt;FairSync&lt;/u&gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;是 ReentrantLock 的内部类，&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;在Sync基础上又拓展了些方法&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;boolean initialTryLock()&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#000000&quot; style=&quot;font-size: 12px;&quot;&gt;boolean tryAcquire(int acquires)&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-240" y="1000" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-19" target="DbWMpIfpRNwdCwqWCdMp-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-12" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;true&lt;br&gt;之前锁未占用&lt;br&gt;且当前线程抢占成功&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="DbWMpIfpRNwdCwqWCdMp-24">
          <mxGeometry x="-0.2657" y="1" relative="1" as="geometry">
            <mxPoint x="6" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-26" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;false&lt;br&gt;之前锁已经被占用&lt;br&gt;或者被其他线程抢占&lt;/font&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-19" target="DbWMpIfpRNwdCwqWCdMp-25" edge="1">
          <mxGeometry x="0.557" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="580" y="290" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-19" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;compareAndSetState(&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;0, 1)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;CAS修改AQS锁状态state,&amp;nbsp;&lt;br style=&quot;&quot;&gt;将未被占用改为已占用&lt;/font&gt;&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="DbWMpIfpRNwdCwqWCdMp-23" target="fPlDu5WqXSQ5xT3qjxxo-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-23" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;b&gt;setExclusiveOwnerThread&lt;/b&gt;(&lt;br style=&quot;font-size: 12px;&quot;&gt;Thread.currentThread());&lt;br style=&quot;font-size: 12px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 12px;&quot;&gt;因为ReentrantLock是排他锁，所以设置独占线程为当前线程&lt;/font&gt;&lt;br style=&quot;font-size: 12px;&quot;&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="800" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-25" target="DbWMpIfpRNwdCwqWCdMp-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-25" value="acquire(1)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;从后面流程看这里抢锁失败，并不会直接退出&lt;/span&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="800" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" edge="1" parent="1" source="DbWMpIfpRNwdCwqWCdMp-29" target="fPlDu5WqXSQ5xT3qjxxo-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-29" value="&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;div&gt;!&lt;b&gt;tryAcquire&lt;/b&gt;(arg)&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;amp;&amp;amp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;acquireQueued&lt;/b&gt;(addWaiter(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Node.EXCLUSIVE), arg)&lt;/div&gt;&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1040" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-31" target="DbWMpIfpRNwdCwqWCdMp-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-31" value="&lt;font style=&quot;font-size: 10px&quot;&gt;selfInterrupt()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;再次中断自己&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1280" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.991;exitY=0.35;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;exitPerimeter=0;" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-21" target="DbWMpIfpRNwdCwqWCdMp-23" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2060" y="248" />
              <mxPoint x="2060" y="120" />
              <mxPoint x="780" y="120" />
              <mxPoint x="780" y="190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-55" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&amp;nbsp;Thread.currentThread().&lt;b&gt;interrupt&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1520" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-75" target="DbWMpIfpRNwdCwqWCdMp-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-75" value="sync.release(1)" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="240" y="460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-77" target="DbWMpIfpRNwdCwqWCdMp-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-77" value="sync.&lt;b&gt;lock&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;非公平锁这里sync是NonfairSync&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="240" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-84" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-81" target="DbWMpIfpRNwdCwqWCdMp-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-39" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;解锁成功后&lt;br&gt;去队列唤醒下一个等待锁的线程&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="DbWMpIfpRNwdCwqWCdMp-84">
          <mxGeometry x="0.4475" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;dashed=1;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-81" target="DbWMpIfpRNwdCwqWCdMp-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-81" value="&lt;font style=&quot;font-size: 10px&quot;&gt;tryRelease(arg)&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="450" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-106" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-83" target="DbWMpIfpRNwdCwqWCdMp-105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-83" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;Node h = head;&lt;br&gt;if (h != null &amp;amp;&amp;amp; h.waitStatus != 0)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;&quot;&gt;unparkSuccessor&lt;/b&gt;(h)&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="840" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-88" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-85" target="DbWMpIfpRNwdCwqWCdMp-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-85" value="&lt;font style=&quot;font-size: 10px&quot;&gt;c = getState() - releases&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;锁占用状态（重入计数）&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="680" y="460" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-92" value="Y" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-87" target="DbWMpIfpRNwdCwqWCdMp-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-87" target="DbWMpIfpRNwdCwqWCdMp-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-87" value="&lt;font style=&quot;font-size: 8px&quot;&gt;Thread.currentThread() != getExclusiveOwnerThread()&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="680" y="540" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-91" value="&lt;font style=&quot;font-size: 10px&quot;&gt;throw new IllegalMonitorStateException()&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="880" y="540" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-100" value="Y" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-97" target="DbWMpIfpRNwdCwqWCdMp-99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-104" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="DbWMpIfpRNwdCwqWCdMp-97" target="DbWMpIfpRNwdCwqWCdMp-103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-97" value="&lt;font style=&quot;font-size: 10px&quot;&gt;c == 0&lt;br&gt;&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="720" y="620" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-99" value="&lt;div style=&quot;font-size: 10px&quot;&gt;free = true;&lt;span style=&quot;font-size: 9px&quot;&gt;&amp;nbsp;&lt;br&gt;setExclusiveOwnerThread(null)&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px&quot;&gt;c==0 真正地释放锁，&lt;br&gt;c!=0 只是减少锁重入计数&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="880" y="620" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-103" value="&lt;div style=&quot;font-size: 11px&quot;&gt;&lt;font style=&quot;font-size: 11px&quot;&gt;setState(c);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px&quot;&gt;&lt;font style=&quot;font-size: 11px&quot;&gt;return free;&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="680" y="700" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="DbWMpIfpRNwdCwqWCdMp-105" target="fPlDu5WqXSQ5xT3qjxxo-35">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1180" y="1030" as="targetPoint" />
            <Array as="points">
              <mxPoint x="880" y="1000" />
              <mxPoint x="1860" y="1000" />
              <mxPoint x="1860" y="795" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-41" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;unpark() 唤醒制定线程&lt;/b&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fPlDu5WqXSQ5xT3qjxxo-40">
          <mxGeometry x="-0.9571" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DbWMpIfpRNwdCwqWCdMp-105" value="&lt;div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;int ws = node.waitStatus;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;if (&lt;b&gt;ws &amp;lt; 0&lt;/b&gt;)&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; compareAndSetWaitStatus(node, ws, 0); &lt;font color=&quot;#007fff&quot;&gt;//修改当前节点waitStatus为默认状态&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;Node &lt;b&gt;s = node.next&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;if (s == null || s.waitStatus &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; s = null;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; //查下一个可被唤醒的节点&lt;/span&gt;&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 8px;&quot;&gt;（&lt;/span&gt;&lt;b style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;从队列尾部开始往前查，因为next可能被置为空，但是prev一直存在&lt;/font&gt;&lt;/b&gt;&lt;span style=&quot;font-size: 8px;&quot;&gt;）&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;for&lt;/b&gt; (Node t = tail; t != null &amp;amp;&amp;amp; t != node; t = t.prev)&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (t.waitStatus &amp;lt;= 0)&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s = t;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;if (s != null)&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&amp;nbsp; &amp;nbsp; LockSupport.&lt;b&gt;unpark&lt;/b&gt;(s.thread); &lt;font color=&quot;#007fff&quot;&gt;//总是唤醒链表中下一个可唤醒的节点&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="680" y="780" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-4" target="fPlDu5WqXSQ5xT3qjxxo-2">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-260" y="260" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 12px;&quot;&gt;&lt;b style=&quot;font-size: 12px;&quot;&gt;AbstractOwnableSynchronizer (A)&lt;/b&gt;&lt;br style=&quot;font-size: 12px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;用于&lt;b style=&quot;font-size: 12px;&quot;&gt;支持独占锁实现&lt;/b&gt;的同步器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;&lt;br style=&quot;font-size: 12px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//记录独占锁的线程（对于排他锁的实现会使用到这个成员变量，ReentrantLock）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;private transient Thread &lt;b style=&quot;font-size: 12px;&quot;&gt;exclusiveOwnerThread&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录独占锁的线程，线程成功抢占锁时记录&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final void setExclusiveOwnerThread(Thread thread)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Thread getExclusiveOwnerThread()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-520" y="40" width="480" height="180" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-3" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.002;exitY=0.43;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-4" target="fPlDu5WqXSQ5xT3qjxxo-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-4" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractQueuedSynchronizer (A)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;AQS核心就是一个&lt;b&gt;双向队列（CLH）&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Node status bits, also used as argument and return values&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;static final int WAITING&amp;nbsp; &amp;nbsp;= 1;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // must be 1&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;static final int CANCELLED = 0x80000000; // must be negative&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;static final int COND&amp;nbsp; &amp;nbsp; &amp;nbsp; = 2;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // in a condition wait&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//自旋超时时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;static final long &lt;b&gt;spinForTimeoutThreshold&lt;/b&gt; = 1000L;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//等待队列的头节点（等待队列中存放等待获取锁并被唤醒的线程）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private transient volatile &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;Node&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;head&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//等待队列的尾节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private transient volatile &lt;b&gt;Node&lt;/b&gt; &lt;b&gt;tail&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//锁状态，0：锁未被占用，1：锁被占用，&amp;gt;1:锁被重入占用（重入次数）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private volatile int &lt;b&gt;state&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CAS操作入口 及 各个属性的偏移量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final Unsafe &lt;b&gt;unsafe&lt;/b&gt; = Unsafe.getUnsafe();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final long stateOffset;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final long headOffset;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final long tailOffset;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final long waitStatusOffset; //Node.waitStatus的偏移量&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final long nextOffset;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-520" y="260" width="480" height="420" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 12px;&quot;&gt;&lt;b&gt;Node&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;CLH队列的节点，存储等待中的线程以及线程的状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//线程已经取消获取锁&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;static final int CANCELLED =&amp;nbsp; 1;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//继任者线程需要 unparking&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;static final int SIGNAL&amp;nbsp; &amp;nbsp; = -1;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//线程正在等待条件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;static final int CONDITION = -2;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//下个 acquireShared 需要无条件传播&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;static final int PROPAGATE = -3;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//节点线程的等待状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot;&gt;volatile int &lt;b&gt;waitStatus&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//prev next 说明是一个双向队列&lt;br style=&quot;font-size: 12px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;volatile Node &lt;b&gt;prev&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;volatile Node &lt;b&gt;next&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//等待中的线程&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;volatile Thread &lt;b&gt;thread&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px;&quot;&gt;Node &lt;b&gt;nextWaiter&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="260" width="320" height="340" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-6" target="fPlDu5WqXSQ5xT3qjxxo-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 12px;&quot;&gt;&lt;b&gt;Sync&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里的 Sync 是 ReentrantLock 的内部类，拓展了一些锁相关的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 8px; font-size: 12px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//非公平的尝试获取锁&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean tryLock()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void lock()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void lockInterruptibly()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;boolean tryLockNanos(long nanos)&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;boolean tryRelease(int releases)&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;boolean isHeldExclusively()&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;boolean isLocked()&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ConditionObject newCondition()&lt;br&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-520" y="720" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-9" value="NonfairSync" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="295" y="130" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-13" value="加锁成功&lt;br&gt;结束" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;" vertex="1" parent="1">
          <mxGeometry x="1040" y="160" width="60" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-18" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-15" target="fPlDu5WqXSQ5xT3qjxxo-17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-15" target="fPlDu5WqXSQ5xT3qjxxo-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-25" value="&lt;font color=&quot;#007fff&quot;&gt;tryAcquire() 成功则加锁成功直接退出&lt;br&gt;失败会继续执行&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fPlDu5WqXSQ5xT3qjxxo-24">
          <mxGeometry x="0.2146" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-15" value="&lt;font&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;tryAcquire(arg)&amp;nbsp;&lt;br&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px&quot; color=&quot;#007fff&quot;&gt;即仍然再尝试一次获取锁（或许前一刻还没释放锁现在就释放了），相当于自旋1次&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1280" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-17" target="fPlDu5WqXSQ5xT3qjxxo-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-17" value="&lt;font&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;nonfairTryAcquire(int acquires)&lt;/span&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1520" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-21" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;&quot;&gt;final Thread current = Thread.currentThread();&lt;/div&gt;&lt;div&gt;int c = &lt;b&gt;getState&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//锁未占&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (c == 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//通过CAS再次尝试抢占锁&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (&lt;b&gt;compareAndSetState&lt;/b&gt;(0, acquires)) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//加锁成功&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;setExclusiveOwnerThread&lt;/b&gt;(current);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//锁被自己重入占用&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;else if (current == getExclusiveOwnerThread()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //重入计数+acquires&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int nextc = c + acquires;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (nextc &amp;lt; 0) // overflow&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new Error(&quot;Maximum lock count exceeded&quot;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //重入加锁成功&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;setState&lt;/b&gt;(nextc);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//锁被其他线程占用&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return false;&lt;/div&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1760" y="150" width="280" height="280" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-23" target="fPlDu5WqXSQ5xT3qjxxo-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-23" target="DbWMpIfpRNwdCwqWCdMp-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-31" value="&lt;font color=&quot;#007fff&quot;&gt;走到这 acquireQueued() &lt;br&gt;一定返回了true，&lt;br&gt;即请求获取锁的线程被中断了&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fPlDu5WqXSQ5xT3qjxxo-30">
          <mxGeometry x="0.2301" y="2" relative="1" as="geometry">
            <mxPoint x="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-23" value="&lt;font&gt;acquireQueued(&lt;br&gt;addWaiter(Node.EXCLUSIVE), arg)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;就是先将当前线程入队CLH&lt;br&gt;然后按队列顺序尝试获取锁&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1280" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-26" target="fPlDu5WqXSQ5xT3qjxxo-28">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-26" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;addWaiter(Node.EXCLUSIVE)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;为当前线程在CLH中添加一个独占节点，并放到队尾（compareAndSetTail&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;），注意如果head == tail == null默认会创建一个空Node作为头节点&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1520" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;" edge="1" parent="1" source="fPlDu5WqXSQ5xT3qjxxo-28" target="fPlDu5WqXSQ5xT3qjxxo-35">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1840" y="795" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-28" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;boolean failed = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean interrupted = false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;for&lt;/b&gt; (;;) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//返回当前新增节点的前一个节点，前一个节点为空就抛&amp;nbsp;NullPointerException&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Node p = node.predecessor();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;//如果前一节点是head，说明轮到当前线程尝试获取锁了&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (p == head &amp;amp;&amp;amp; &lt;b style=&quot;font-size: 10px;&quot;&gt;tryAcquire&lt;/b&gt;(arg)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setHead(node); &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//node的线程加锁成功后设置为head&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; p.next = null; &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//下次GC可以回收head&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; failed = false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return &lt;b style=&quot;font-size: 10px;&quot;&gt;interrupted&lt;/b&gt;;&amp;nbsp;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//tryAcquire 成功的话lock()流程就结束了&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;//还轮不到当前线程抢占 || 轮到了但是当前线程尝试加锁失败&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;//这里 if 条件其实就是更新前置节点状态（也可能从队列中删除取消的线程节点）、以及决定是否挂起当前线程&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (shouldParkAfterFailedAcquire(p, node) &amp;amp;&amp;amp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;parkAndCheckInterrupt&lt;/b&gt;())&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//线程被中断&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;interrupted&lt;/b&gt; = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} finally {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (failed)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;cancelAcquire&lt;/b&gt;(node);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=3;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1520" y="540" width="320" height="320" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-35" value="&lt;div style=&quot;font-size: 11px&quot;&gt;&lt;font style=&quot;font-size: 11px&quot;&gt;LockSupport.&lt;b&gt;park&lt;/b&gt;(this);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px&quot;&gt;&lt;font style=&quot;font-size: 11px&quot;&gt;return Thread.&lt;b&gt;interrupted&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;先挂起当前线程等待唤醒，唤醒后判断下是否被中断&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1880" y="750" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-37" value="&lt;font color=&quot;#007fff&quot;&gt;因为中断是JVM在合适的时机执行的，前面 interrupted() 会读取并清除中断标志位，会导致线程不会被中断，&lt;br&gt;所以这里需要重新中断。&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1280" y="945" width="600" height="40" as="geometry" />
        </mxCell>
        <mxCell id="fPlDu5WqXSQ5xT3qjxxo-38" value="&lt;font color=&quot;#007fff&quot;&gt;可能系统还没来的及中断这个线程，就被唤醒了&lt;br&gt;需要判断下是否设置了中断，防止已经设置了中断还继续去获取锁&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2050" y="760" width="370" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
