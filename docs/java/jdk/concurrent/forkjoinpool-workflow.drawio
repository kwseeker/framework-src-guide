<mxfile host="Electron" modified="2024-02-15T14:32:50.040Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.7.5 Chrome/114.0.5735.289 Electron/25.8.1 Safari/537.36" etag="o-C5C8rh0JOJ5TuslrD2" version="21.7.5" type="device" pages="2">
  <diagram id="CkkpEGL-JcrP4vNnKdJq" name="第 1 页">
    <mxGraphModel dx="2637" dy="1118" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="Oymi44IFPG7ip9I0upf_-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;ForkJoinPool 原理&lt;/font&gt;&lt;/h1&gt;&lt;p style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;源码不是很好理解，有很多字段包含多种含义，一些方法有很多循环、条件判断、位运算，堆在一起，很难推测作者的真实用意，最好是复制一份代码加上日志和断点进行调试。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;&quot;&gt;预备知识：&lt;/b&gt;&lt;br&gt;1）最好先对ThreadPoolExecutor有个清晰的认识，方便理解ForkJoinPool；&lt;br&gt;2）ThreadLocalRandom.getProbe() 探针；参考java-relearn 或 参考网文：&lt;a style=&quot;&quot; href=&quot;https://aobing.blog.csdn.net/article/details/115450889&quot;&gt;https://aobing.blog.csdn.net/article/details/115450889&lt;/a&gt;&lt;br&gt;3）理解“UNSAFE CAS 自旋”并发同步操作，以及UNSAFE修改对象的方法和Java对象的内存结构，代码里面有大量这种操作；&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;基于测试：&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;java-async/async-future/ThreadExhaustionTest.java&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;java-async/async-future/ArraySumMain.java&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="600" height="160" as="geometry" />
        </mxCell>
        <mxCell id="a_vHJ03TcrBo9rNO5nsq-12" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;线程池一共下面6种运行状态&lt;br style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; RSLOCK&amp;nbsp; &amp;nbsp; &amp;nbsp;= 1;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; RSIGNAL&amp;nbsp; &amp;nbsp; = 1 &amp;lt;&amp;lt; 1;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; STARTED&amp;nbsp; &amp;nbsp; = 1 &amp;lt;&amp;lt; 2;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; STOP&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 29;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; TERMINATED = 1 &amp;lt;&amp;lt; 30;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int&amp;nbsp; SHUTDOWN&amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 31; //-2147483648&lt;/div&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1190" y="600" width="180" height="80" as="geometry" />
        </mxCell>
        <mxCell id="X0HKkTIcBq6q-AQzs4eG-13" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;任务往队列插入元素流程&lt;/b&gt;：&lt;br&gt;通过&lt;b&gt;UNSAFE&lt;/b&gt;将&lt;b&gt;ForkJoinTask&lt;/b&gt;插入数组q.top位置，然后更新q.top的值（+1）&lt;br&gt;&lt;br&gt;因为是用的UNSAFE往数组插入的元素，UNSAFE是靠偏移量指针（byte为单位）修改的&lt;br style=&quot;&quot;&gt;根据JVM中对象内存结构，需要先计算出其&lt;b&gt;偏移位置&lt;/b&gt;是&lt;br style=&quot;&quot;&gt;markword (8) + 压缩类型指针(4) + 数组长度(4) + top * 指针类型(4)&lt;br style=&quot;&quot;&gt;里面最内部的按位与操作是为了防止索引溢出&lt;br style=&quot;font-size: 6px;&quot;&gt;&lt;/span&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=6;fontColor=#3399FF;" parent="1" vertex="1">
          <mxGeometry x="2290" y="501" width="410" height="100" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ForkJoinPool&lt;/b&gt; extends AbstractExecutorService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于取ctl低16位，bit:0-15&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int &lt;b&gt;SMASK&lt;/b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; = 0xffff;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // short bits == max index&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int MAX_CAP&amp;nbsp; &amp;nbsp; &amp;nbsp; = 0x7fff;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // max #workers - 1&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int EVENMASK&amp;nbsp; &amp;nbsp; &amp;nbsp;= 0xfffe;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // even short bits&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SQMASK&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;= 0x007e;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // max 64 (even) slots&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// Masks and units for WorkQueue.scanState and ctl sp subfield&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SCANNING&amp;nbsp; &amp;nbsp; &amp;nbsp;= 1;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// false when running tasks&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 非与工作者线程绑定的工作队列的初始状态，为负数，表示未激活状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int INACTIVE&amp;nbsp; &amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 31;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// must be negative&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SS_SEQ&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 16;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// 版本计数单元，SEQ和后面的UNIT含义一样，“+1”&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Mode bits for ForkJoinPool.config and WorkQueue.config&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//工作队列的工作模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int MODE_MASK&amp;nbsp; &amp;nbsp; = 0xffff &amp;lt;&amp;lt; 16;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// int 的高16位记录工作模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int LIFO_QUEUE&amp;nbsp; &amp;nbsp;= 0;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int FIFO_QUEUE&amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 16;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SHARED_QUEUE = 1 &amp;lt;&amp;lt; 31;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// must be negative&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// static fields (initialized in static initializer below)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final RuntimePermission modifyThreadPermission;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final ForkJoinPool &lt;b&gt;common&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//common并行度，1~Max_CAP，默认为CPU核心数-1&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可以通过系统属性“java.util.concurrent.ForkJoinPool.common.parallelism”设置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int &lt;b&gt;commonParallelism&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int commonMaxSpares;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int poolNumberSequence;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// static configuration constants&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long IDLE_TIMEOUT = 2000L * 1000L * 1000L; // 2sec&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long TIMEOUT_SLOP = 20L * 1000L * 1000L;&amp;nbsp; // 20ms&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int DEFAULT_COMMON_MAX_SPARES = 256;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int SPINS&amp;nbsp; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int SEED_INCREMENT = 0x9e3779b9;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Lower and upper word masks&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long &lt;b&gt;SP_MASK&lt;/b&gt;&amp;nbsp; &amp;nbsp; = 0xffffffffL;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//低32位掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long &lt;b&gt;UC_MASK&lt;/b&gt;&amp;nbsp; &amp;nbsp; = ~SP_MASK; &lt;font color=&quot;#007fff&quot;&gt;//高32位掩码 0xffffffff00000000L&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Active counts&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; &lt;b&gt;AC_SHIFT&lt;/b&gt;&amp;nbsp; &amp;nbsp;= 48;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long AC_UNIT&amp;nbsp; &amp;nbsp; = 0x0001L &amp;lt;&amp;lt; AC_SHIFT; &lt;font color=&quot;#007fff&quot;&gt;//活跃线程数的计数单元,&quot;+1“操作&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long AC_MASK&amp;nbsp; &amp;nbsp; = 0xffffL &amp;lt;&amp;lt; AC_SHIFT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Total counts&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; &lt;b&gt;TC_SHIFT&lt;/b&gt;&amp;nbsp; &amp;nbsp;= 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long TC_UNIT&amp;nbsp; &amp;nbsp; = 0x0001L &amp;lt;&amp;lt; TC_SHIFT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long TC_MASK&amp;nbsp; &amp;nbsp; = 0xffffL &amp;lt;&amp;lt; TC_SHIFT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ctl 中索引为47的bit,控制是否可以继续创建工作者线程&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long &lt;b&gt;ADD_WORKER&lt;/b&gt; = 0x0001L &amp;lt;&amp;lt; (TC_SHIFT + 15); // sign&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// runState bits: SHUTDOWN must be negative, others arbitrary powers of two&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; RSLOCK&amp;nbsp; &amp;nbsp; &amp;nbsp;= 1;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//索引为0的bit是加锁标志位&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; RSIGNAL&amp;nbsp; &amp;nbsp; = 1 &amp;lt;&amp;lt; 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; STARTED&amp;nbsp; &amp;nbsp; = 1 &amp;lt;&amp;lt; 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; STOP&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 29;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; TERMINATED = 1 &amp;lt;&amp;lt; 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; SHUTDOWN&amp;nbsp; &amp;nbsp;= 1 &amp;lt;&amp;lt; 31;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Instance fields&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//控制参数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;高32位的前16位：&lt;b&gt;AC，活跃线程数&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//高32位的后16位：&lt;b&gt;TC，工作线程数&lt;/b&gt;（其中最高位作为&lt;b&gt;是否可以新建线程&lt;/b&gt;的标志）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//低32位的前16位：&lt;b&gt;SS，栈顶工作线程状态和版本数&lt;/b&gt;，第1位是线程状态：1:inactive, 0:active, 后15位表示版本号，防止ABA问题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//低32位的后16位：&lt;b&gt;ID，栈顶工作线程所在工作队列的索引&lt;/b&gt;，配合WorkQueue.stackPred组成栈&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即低32位记录空闲的栈顶工作线程信息，不为0即表示有空闲线程，每次提交任务如果不存在空闲的工作线程且ctl第47位不为0就会创建新线程执行提交的任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile long &lt;b&gt;ctl&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// main pool control&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//线程池运行状态，初始为0&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//第1位：运行状态锁标志位，防止其他线程并发修改运行状态，此bit为1则是加锁状态&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile int &lt;b&gt;runState&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// lockable status&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//低16位表示并行度，高16位表示任务队列模式（默认LIFO_QUEUE）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final int &lt;b&gt;config&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // parallelism, mode&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int indexSeed;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// to generate worker index&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//任务队列数组，即这里有多个队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile WorkQueue[] &lt;b&gt;workQueues&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp;// main registry&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//工作者线程工厂&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ForkJoinWorkerThreadFactory &lt;b&gt;factory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//未捕获异常处理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final UncaughtExceptionHandler ueh;&amp;nbsp; // per-worker UEH&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//工作者线程的命名前缀，默认 “ForkJoinPool.commonPool-worker-”&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final String &lt;b&gt;workerNamePrefix&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// to create worker name string&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile AtomicLong &lt;b&gt;stealCounter&lt;/b&gt;;&amp;nbsp; &amp;nbsp; // also used as sync monitor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final sun.misc.Unsafe U;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; ABASE;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int&amp;nbsp; ASHIFT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long CTL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long RUNSTATE;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long STEALCOUNTER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long PARKBLOCKER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QTOP;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QLOCK;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QSCANSTATE;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QPARKER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QCURRENTSTEAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long QCURRENTJOIN;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-480" y="200" width="440" height="1200" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-3" target="KyiJdkHfAW7Gcaq_ivn_-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-3" value="testSumTask2()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-4" target="KyiJdkHfAW7Gcaq_ivn_-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;fontSize=10;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-6" target="KyiJdkHfAW7Gcaq_ivn_-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="500" y="310" />
              <mxPoint x="500" y="230" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-4" value="SumTask2 task = new SumTask2(1, 100);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="froqMD3xnD5BCt7UT14n-27" target="KyiJdkHfAW7Gcaq_ivn_-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="380" y="360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-6" value="ForkJoinPool pool = new &lt;b&gt;ForkJoinPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="froqMD3xnD5BCt7UT14n-27" target="KyiJdkHfAW7Gcaq_ivn_-17" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="390" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-10" value="&lt;font style=&quot;&quot;&gt;System.out.println(sum.get());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;同步等待获取结果&lt;/font&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-12" target="KyiJdkHfAW7Gcaq_ivn_-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-12" value="&lt;div&gt;this(Math.min(MAX_CAP, Runtime.getRuntime()&lt;span style=&quot;background-color: initial;&quot;&gt;.availableProcessors()),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;defaultForkJoinWorkerThreadFactory, null, false);&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="510" y="200" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-14" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;this(checkParallelism(parallelism),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;checkFactory(factory),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;handler,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;asyncMode ? FIFO_QUEUE : &lt;b&gt;LIFO_QUEUE&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&quot;ForkJoinPool-&quot; + nextPoolId() + &quot;-worker-&quot;);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="760" y="200" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-16" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;parallelism 与 ctl:&amp;nbsp;&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;long np = (long)(-parallelism);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;this.ctl = ((np &amp;lt;&amp;lt; AC_SHIFT) &amp;amp; AC_MASK) | ((np &amp;lt;&amp;lt; TC_SHIFT) &amp;amp; TC_MASK);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即 this.ctl = ((np &amp;lt;&amp;lt; 48) &amp;amp; 0xffffL &amp;lt;&amp;lt; 48) | ((np &amp;lt;&amp;lt; 32) &amp;amp; 0xffffL &amp;lt;&amp;lt; 32);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;比如核心数8, commonPool parallelism=8-1=7, ctl = fff9fff900000000, 初始为负数&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;new ForkJoinPool() 的线程池的parallelism 和核心数一样。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#ea6b66&quot;&gt;这里为何要并行度取反？&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;结合后面 tryAddWorker() 的条件，如果没有空闲的工作者线程且ctl索引为47的位不为0才可以创建线程，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;以commonPool为例将并行度取反即 fff9，每次新建线程TC加“1”，加“7”之后索引为47的位将变为0，将不能创建新线程，推理可以创建7个工作者线程&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1010" y="200" width="680" height="120" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-17" target="KyiJdkHfAW7Gcaq_ivn_-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-17" value="&lt;b&gt;externalPush&lt;/b&gt;(job);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;任务提交的统一方法，其他&lt;b&gt;execute&lt;/b&gt;() &lt;b&gt;invoke&lt;/b&gt;() 等方法都是简单封装的这个方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-19" target="KyiJdkHfAW7Gcaq_ivn_-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-19" value="一个复杂的判断条件处理&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;暂略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-21" target="KyiJdkHfAW7Gcaq_ivn_-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-21" value="externalSubmit(task);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-23" target="KyiJdkHfAW7Gcaq_ivn_-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-23" value="&lt;b&gt;r = ThreadLocalRandom.getProbe();&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;线程探针&lt;/b&gt;未初始化就执行初始化并返回&lt;br&gt;用到其散列特性&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-25" target="KyiJdkHfAW7Gcaq_ivn_-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-25" value="for(::)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;一个提交操作可能涉及几次循环&lt;br&gt;&lt;/b&gt;任务提交到工作队列后返回&lt;br&gt;比如初始提交第一个任务：涉及工作队列数组初始化、创建工作队列、提交任务到队列&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="521" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1380" y="551" />
              <mxPoint x="1380" y="390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-32" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;(rs = runState) &amp;lt; 0&lt;br&gt;即关闭状态&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-31" vertex="1" connectable="0">
          <mxGeometry x="-0.0429" y="2" relative="1" as="geometry">
            <mxPoint x="82" y="12" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-33" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1380" y="551" />
              <mxPoint x="1380" y="470" />
              <mxPoint x="1560" y="470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-36" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;未启动或&lt;br&gt;任务队列未初始化&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-34" vertex="1" connectable="0">
          <mxGeometry x="0.453" y="-4" relative="1" as="geometry">
            <mxPoint x="-24" y="16" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-43" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-44" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;(q = ws[k = r &amp;amp; m &amp;amp; SQMASK]) != null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;即通过线程探针值选取的&lt;b&gt;偶数队列&lt;/b&gt;不为空&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;即队列已经创建了&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-43" vertex="1" connectable="0">
          <mxGeometry x="0.0346" y="-3" relative="1" as="geometry">
            <mxPoint x="7" y="26" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1380" y="551" />
              <mxPoint x="1380" y="810" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-47" value="&lt;font color=&quot;#007fff&quot;&gt;((rs = runState) &amp;amp; RSLOCK) == 0&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-46" vertex="1" connectable="0">
          <mxGeometry x="0.3214" y="-3" relative="1" as="geometry">
            <mxPoint x="66" y="7" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-51" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-50" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1380" y="551" />
              <mxPoint x="1380" y="890" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-27" target="KyiJdkHfAW7Gcaq_ivn_-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-27" value="线程池运行状态" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="521" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-29" value="tryTerminate(false, false);&lt;br&gt;throw new RejectedExecutionException();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="361" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-30" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;WorkQueue&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;任务队列，ForkJoinPool一共有大于等于并行度的2的指数幂×2个任务队列，存储ForkJoinTask类型任务，初始化容量是8192&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//初始化容量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int INITIAL_QUEUE_CAPACITY = 1 &amp;lt;&amp;lt; 13;&amp;nbsp; //8192&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最大容量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int MAXIMUM_QUEUE_CAPACITY = 1 &amp;lt;&amp;lt; 26; // 64M&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;lt;0未激活，为奇数时表示处于扫描状态，为偶数时表示为繁忙（看源码应该是正在执行队列中的任务）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从源码可以看到&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//1) 创建线程时会注册新的工作队列，scanState&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;记录此工作队列插入工作队列数组的索引，是奇数位置&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//2) 提交任务时，可能会创建工作队列并放在工作队列数组的偶数位置，且工作队列scanState初始为INACTIVE&lt;/font&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile int &lt;b&gt;scanState&lt;/b&gt;;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;// &amp;lt;0: inactive; odd:scanning&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//前一个工作队列在工作队列数组中的索引，单数索引工作队列中包含绑定的工作线程，&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;通过这个字段将工作者线程连接起来，从访问方式上看其实是组成一个&lt;b&gt;栈&lt;/b&gt;的结构，栈顶在ForkJoinPool ctl ID段，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;唤醒工作者线程时总是从栈顶开始唤醒&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;每一个线程在挂起时都会持有前一个等待线程所在工作队列的索引，由此构成一个等待的工作线程栈，栈顶是最新的等待的线程&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;stackPred&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// pool stack (ctl) predecessor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//偷取的任务数量，任务偷取并不是将任务存到这个工作队列而是直接由工作者线程执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;nsteals&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// number of steals&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//随机数种子&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;hint&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// randomization and stealer index hint&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//任务队列在队列数组中的索引以及队列模式（FIFO | FILO）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//高16位是队列模式（&lt;b&gt;LIFO&lt;/b&gt;:0&amp;lt;&amp;lt;16 FIFO: 1&amp;lt;&amp;lt;16），低16位是最近插入工作队列数组的索引位置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;config&lt;/b&gt;; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//队列锁，控制多个线程往队列中同步地提交任务&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile int &lt;b&gt;qlock&lt;/b&gt;;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// 1: locked, &amp;lt; 0: terminate; else 0&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//poll操作（即取任务）的下个位置索引，初始是规定容量的一半，即4096&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile int &lt;b&gt;base&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//push操作（即添加任务）的下个位置索引，初始是规定容量的一半，即4096&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;top&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//任务数组，创建队列时，数组为null，首次提交任务时才实例化数组&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;ForkJoinTask&amp;lt;?&amp;gt;[] &lt;b&gt;array&lt;/b&gt;; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ForkJoinPool &lt;b&gt;pool&lt;/b&gt;;&amp;nbsp; &amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// the containing pool (may be null)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//创建工作者线程时创建的工作队列，会使用owner保存绑定的ForkJoinWorkerThread&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ForkJoinWorkerThread &lt;b&gt;owner&lt;/b&gt;; // owning thread or null if shared&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile Thread &lt;b&gt;parker&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// == owner during call to park; else null&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile ForkJoinTask&amp;lt;?&amp;gt; &lt;b&gt;currentJoin&lt;/b&gt;;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// task being joined in awaitJoin&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前偷取的任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;volatile ForkJoinTask&amp;lt;?&amp;gt; &lt;b&gt;currentSteal&lt;/b&gt;; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// mainly used by helpStealer&amp;nbsp;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-960" y="200" width="440" height="560" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-33" target="KyiJdkHfAW7Gcaq_ivn_-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-33" value="工作队列数组初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在&lt;b&gt;RSLOCK&lt;/b&gt;锁同步下创建工作队列数组（工作队列仍为初始化），然后修改运行状态为STARTED&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-35" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1" vertex="1" connectable="0">
          <mxGeometry x="1430.0000000000005" y="430.0033333333335" as="geometry">
            <mxPoint x="-7" y="72" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-39" value="U.compareAndSwapObject(this, &lt;b&gt;STEALCOUNTER&lt;/b&gt;, null,new AtomicLong());&lt;br&gt;workQueues = new &lt;b&gt;WorkQueue&lt;/b&gt;[n];&lt;br&gt;ns = &lt;b&gt;STARTED&lt;/b&gt;;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;本地CPU核心数8,实际并行度是7, 最终创建的工作队列个数是16&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1800" y="430" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-41" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;&quot;&gt;RSLOCK锁的实现(lockRunState())&lt;/b&gt;&lt;b style=&quot;&quot;&gt;：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;借助UNSAFE CAS 接口实现&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;加锁：判断runState锁标志位是否加锁（1加锁0未加锁），已经加锁就自旋等待其他线程释放锁，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;未加锁则CAS修改标志位为1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;解锁：CAS修改标志位为0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;计算工作队列个数算法&lt;/b&gt;：&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;int p = 8; //比如并行度设置为8&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;int n = (p &amp;gt; 1) ? p - 1 : 1;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;n |= n &amp;gt;&amp;gt;&amp;gt; 1; n |= n &amp;gt;&amp;gt;&amp;gt; 2;&amp;nbsp; n |= n &amp;gt;&amp;gt;&amp;gt; 4;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;n |= n &amp;gt;&amp;gt;&amp;gt; 8; n |= n &amp;gt;&amp;gt;&amp;gt; 16; n = (n + 1) &amp;lt;&amp;lt; 1;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;写个测试跑一下, 参考测试用例：testGenerateWorkQueueArraySize()，或者用1024画一画&lt;br&gt;会很明显地看出就是求&lt;b style=&quot;&quot;&gt;大于等于并行度&lt;/b&gt;&lt;b style=&quot;&quot;&gt;的最小2的指数幂的2倍&lt;/b&gt;, &lt;br&gt;比如： 大于等于6的2的指数幂最小是8, 再乘以2就是16&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=8;fontColor=#3399FF;" parent="1" vertex="1">
          <mxGeometry x="2000" y="305" width="450" height="170" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-42" target="KyiJdkHfAW7Gcaq_ivn_-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-42" value="提交任务到队列&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在&lt;b&gt;队列锁qlock&lt;/b&gt;同步下提交&lt;br&gt;&lt;b&gt;其他分支都是为这个分支服务的&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1560" y="521" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-45" target="KyiJdkHfAW7Gcaq_ivn_-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-45" value="创建工作队列&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在&lt;b&gt;RSLOCK&lt;/b&gt;锁同步下创建工作队列&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-57" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-48" target="KyiJdkHfAW7Gcaq_ivn_-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-48" value="&lt;div&gt;q = new &lt;b&gt;WorkQueue&lt;/b&gt;(this, null);&lt;/div&gt;&lt;div&gt;q.hint = r;&lt;/div&gt;&lt;div&gt;q.config = k | &lt;b&gt;SHARED_QUEUE&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;q.&lt;b&gt;scanState&lt;/b&gt; = &lt;b&gt;INACTIVE&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;这里可以看到创建的是偶数索引的队列&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-50" value="move= true;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;走到这里基本都是因为取不到锁，需要尝试换一个工作队列提交&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-55" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-52" target="KyiJdkHfAW7Gcaq_ivn_-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-67" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-55" vertex="1" connectable="0">
          <mxGeometry x="-0.0125" y="1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-52" value="move == true ?" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="940" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-54" value="r = ThreadLocalRandom.advanceProbe(r);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;更新线程探针值&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-56" value="&lt;div&gt;if (rs &amp;gt; 0 &amp;amp;&amp;amp;&amp;nbsp; (ws = workQueues) != null &amp;amp;&amp;amp;&lt;/div&gt;&lt;div&gt;k &amp;lt; ws.length &amp;amp;&amp;amp; ws[k] == null)&lt;/div&gt;&lt;div&gt;&lt;b&gt;ws[k] = q;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;把工作队列注册到队列数组&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1800" y="860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-61" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-58" target="KyiJdkHfAW7Gcaq_ivn_-60" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-65" value="&lt;font color=&quot;#007fff&quot;&gt;成功&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-61" vertex="1" connectable="0">
          <mxGeometry x="-0.2" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-63" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-58" target="KyiJdkHfAW7Gcaq_ivn_-62" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-64" value="&lt;font color=&quot;#007fff&quot;&gt;失败&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-63" vertex="1" connectable="0">
          <mxGeometry x="0.0244" y="3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-58" value="if (q.&lt;b&gt;qlock&lt;/b&gt; == 0 &amp;amp;&amp;amp; U.&lt;b&gt;compareAndSwapInt&lt;/b&gt;(q, QLOCK, 0, 1)) {...}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;先尝试通过CAS获取队列锁 qlock&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="521" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-69" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-60" target="KyiJdkHfAW7Gcaq_ivn_-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-60" value="&lt;div&gt;if ((a != null &amp;amp;&amp;amp; a.length &amp;gt; s + 1 - q.base) ||&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; (a = q.&lt;b&gt;growArray&lt;/b&gt;()) != null) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //计算插入位置&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int j = (((a.length - 1) &amp;amp; s) &amp;lt;&amp;lt; ASHIFT) + ABASE;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; U.&lt;b&gt;putOrderedObject&lt;/b&gt;(a, j, task);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; U.&lt;b&gt;putOrderedInt&lt;/b&gt;(q, QTOP, s + 1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; submitted = true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;growArray() 实现q.array的初始化以及扩容&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2040" y="496.25" width="240" height="109.5" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-62" value="move = true;&amp;nbsp;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;方法最后面会更新线程探针值，下一次循环大概率会换一个工作队列&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-68" target="KyiJdkHfAW7Gcaq_ivn_-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-68" value="&lt;div&gt;finally:&lt;/div&gt;&lt;div&gt;U.compareAndSwapInt(q, QLOCK, 1, 0);&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;通过CAS释放队列锁 qlock&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2060" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-70" target="KyiJdkHfAW7Gcaq_ivn_-72" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2280" y="730" />
              <mxPoint x="2280" y="1020" />
              <mxPoint x="740" y="1020" />
              <mxPoint x="740" y="1070" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-70" value="if (submitted) {&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //ws是工作队列数组，q是任务插入的队列&lt;/font&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;signalWork&lt;/b&gt;(ws, q);&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;return&lt;/b&gt;; &lt;font color=&quot;#007fff&quot;&gt;//退出for(;;)&lt;/font&gt;&lt;br&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="2060" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-72" target="KyiJdkHfAW7Gcaq_ivn_-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-72" value="&lt;b&gt;signalWork&lt;/b&gt;(ws, q);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;唤醒工作者线程处理任务&lt;/b&gt;，首次执行会创建工作者线程并启动，当扫描到多个任务工作者线程还会唤醒其他线程帮忙处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="760" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-73" target="KyiJdkHfAW7Gcaq_ivn_-79" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240.0000000000005" y="1070" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-78" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;dashed=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-73" target="KyiJdkHfAW7Gcaq_ivn_-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="1040" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-73" value="while ((&lt;b&gt;c&lt;/b&gt; = &lt;b&gt;ctl&lt;/b&gt;) &amp;lt; 0L)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;和上面的&lt;b&gt;for(;;)&lt;/b&gt;类似，一个唤醒操作可能涉及&lt;b&gt;几次循环&lt;/b&gt;，由ctl初始化过程可知开始必定是负数&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-81" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-82" target="KyiJdkHfAW7Gcaq_ivn_-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-85" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-81" vertex="1" connectable="0">
          <mxGeometry x="-0.2922" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-79" target="KyiJdkHfAW7Gcaq_ivn_-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-16" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;有空闲线程&lt;br style=&quot;font-size: 10px;&quot;&gt;就用空闲线程处理&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" vertex="1" connectable="0" parent="KyiJdkHfAW7Gcaq_ivn_-91">
          <mxGeometry x="0.2033" relative="1" as="geometry">
            <mxPoint y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-15" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=1;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;entryX=0.77;entryY=-0.022;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-79" target="froqMD3xnD5BCt7UT14n-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-79" value="(sp = (int)c) == 0&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;long型的c转int&lt;br&gt;就是读取低32位&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1040" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-135" target="KyiJdkHfAW7Gcaq_ivn_-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-80" value="&amp;nbsp;&lt;b&gt;tryAddWorker&lt;/b&gt;(c);&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;ctl 低32位为0,且index=47的bit为1, 就新增工作者线程，&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;index=47的bit 控制是否可以新建工作者线程&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1560" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-79" target="KyiJdkHfAW7Gcaq_ivn_-82" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1360" y="1071" as="sourcePoint" />
            <mxPoint x="1560" y="1070" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-84" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-83" vertex="1" connectable="0">
          <mxGeometry x="0.0083" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-89" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-82" target="KyiJdkHfAW7Gcaq_ivn_-88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-17" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=1;exitDx=0;exitDy=0;entryX=0.775;entryY=-0.008;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-82" target="froqMD3xnD5BCt7UT14n-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-82" value="(c &amp;amp; &lt;font style=&quot;font-size: 9px;&quot;&gt;ADD_WORKER&lt;/font&gt;)&lt;br&gt;&amp;nbsp;!= 0L&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;ctl中索引为47的bit&lt;br&gt;不为0&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1400" y="1040" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-88" value="break;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;没有空闲线程且线程数量已达到最大值，不处理&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1400" y="1120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-90" target="KyiJdkHfAW7Gcaq_ivn_-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-96" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-95" vertex="1" connectable="0">
          <mxGeometry x="-0.1167" y="-2" relative="1" as="geometry">
            <mxPoint x="-7" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-90" target="KyiJdkHfAW7Gcaq_ivn_-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-90" value="ws == null&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;前面已经初始化的工作队列数组又变成null, 基本是线程池被关闭了&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1179" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-92" target="KyiJdkHfAW7Gcaq_ivn_-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-92" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;long &lt;b&gt;nc&lt;/b&gt; = ((AC_MASK &amp;amp; (c + AC_UNIT)) |&lt;/div&gt;&lt;div style=&quot;&quot;&gt;(TC_MASK &amp;amp; (c + TC_UNIT)));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;nc 是 &quot;new ctl&quot; 的意思，bit48-63 &quot;+1”，bit32-47也 “+1”，即用于&lt;b&gt;更新 ctl 活跃线程数和工作线程总数&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2040" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-94" value="break;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;直接退出&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1400" y="1187.5" width="120" height="42" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-99" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-97" target="KyiJdkHfAW7Gcaq_ivn_-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-100" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-99" vertex="1" connectable="0">
          <mxGeometry x="-0.766" y="-1" relative="1" as="geometry">
            <mxPoint x="-4" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-97" target="KyiJdkHfAW7Gcaq_ivn_-102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-97" value="ws.length &amp;lt;= &lt;br&gt;(i = sp &amp;amp; SMASK)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;sp是ctl低32位，取其低16位，即&lt;b&gt;i是栈顶工作队列的索引&lt;/b&gt;&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1261.5" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-106" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-102" target="KyiJdkHfAW7Gcaq_ivn_-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-107" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-106" vertex="1" connectable="0">
          <mxGeometry x="-0.9098" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-102" target="KyiJdkHfAW7Gcaq_ivn_-111" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1300.0000000000005" y="1485" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1300" y="1420" />
              <mxPoint x="1340" y="1420" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-110" value="&lt;font color=&quot;#007fff&quot;&gt;即&lt;b&gt;栈顶&lt;/b&gt;工作队列&lt;br&gt;和线程就绪&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-109" vertex="1" connectable="0">
          <mxGeometry x="-0.2671" y="-1" relative="1" as="geometry">
            <mxPoint x="15" y="19" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-102" value="(v = ws[i]) == null&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;基本是线程池正在关闭&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1340" width="120" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-104" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1220" y="1179" width="10" height="221" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-105" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;检查工作队列数组、工作队列是否正常&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1090" y="1274.5" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-111" target="KyiJdkHfAW7Gcaq_ivn_-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-111" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;//即 (sp + 1&amp;lt;&amp;lt;16) &amp;amp; ~(1&amp;lt;&amp;lt;31)，即修改线程状态为active，以及SS+“1”，更新版本号&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot;&gt;int &lt;b&gt;vs&lt;/b&gt; = (sp + SS_SEQ) &amp;amp; ~INACTIVE;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot;&gt;int d = sp - v.scanState; &lt;font color=&quot;#007fff&quot;&gt;//?&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot;&gt;long &lt;b&gt;nc&lt;/b&gt; = (UC_MASK &amp;amp; (c + AC_UNIT)) | (SP_MASK &amp;amp; v.stackPred);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;sp是ctl低32位，v 是ws[i]即栈顶工作队列&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;strokeColor=#000000;fontColor=#000000;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1462.5" width="200" height="97.5" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-121" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-118" target="KyiJdkHfAW7Gcaq_ivn_-122" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480.0000000000005" y="1612.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-123" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-121" vertex="1" connectable="0">
          <mxGeometry x="-0.1889" y="-1" relative="1" as="geometry">
            <mxPoint x="6" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-125" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-118" target="KyiJdkHfAW7Gcaq_ivn_-124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-118" value="d == 0 &amp;amp;&amp;amp; U.&lt;b&gt;compareAndSwapLong&lt;/b&gt;(&lt;br&gt;this, CTL, c, nc)" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;align=center;strokeColor=#000000;fontColor=#000000;rounded=1;arcSize=13;" parent="1" vertex="1">
          <mxGeometry x="1260" y="1580" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-122" value="&lt;font size=&quot;1&quot;&gt;v.scanState = vs;&lt;br&gt;if ((p = v.parker) != null)&lt;br&gt;U.&lt;b&gt;unpark&lt;/b&gt;(p);&lt;br&gt;break;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即唤醒队列的owner工作者线程&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1560" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-127" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-124" target="KyiJdkHfAW7Gcaq_ivn_-126" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-128" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KyiJdkHfAW7Gcaq_ivn_-127" vertex="1" connectable="0">
          <mxGeometry x="0.0132" relative="1" as="geometry">
            <mxPoint x="-20" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-124" value="q != null &amp;amp;&amp;amp; q.base == q.top&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;没有更多待执行的任务&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;align=center;strokeColor=#000000;fontColor=#000000;rounded=1;arcSize=13;" parent="1" vertex="1">
          <mxGeometry x="1260" y="1661" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-126" value="break;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;没有更多待执行的任务&lt;br&gt;就直接退出&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1600" y="1670" width="120" height="42" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-129" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;CAS锁&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1190" y="1595" width="50" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-131" target="KyiJdkHfAW7Gcaq_ivn_-133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-131" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;add = U.compareAndSwapLong(this, CTL, c, nc);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;lockRunState()锁同步下更新ctl&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2040" y="1121" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-133" target="KyiJdkHfAW7Gcaq_ivn_-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-133" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;if (add) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; createWorker();&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2040" y="1200.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-80" target="KyiJdkHfAW7Gcaq_ivn_-135" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1760" y="1070" as="sourcePoint" />
            <mxPoint x="2040" y="1070" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-135" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;do {...}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;while (((c = ctl) &amp;amp; ADD_WORKER) != 0L &amp;amp;&amp;amp; (int)c == 0)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;检查是否可以创建线程&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;(int)c == 0 即ctl低32位为0，是最初时的状态&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-137" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这里的意思是最初创建线程时，&lt;br&gt;&lt;b&gt;如果失败会一直自旋重试&lt;/b&gt;，&lt;br style=&quot;font-size: 10px;&quot;&gt;但是后面再创建线程就不会自旋重试了&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="1110" width="190" height="50" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-141" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-138" target="KyiJdkHfAW7Gcaq_ivn_-140" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-143" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-138" target="KyiJdkHfAW7Gcaq_ivn_-142" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-165" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=1;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#000000;dashed=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-138" target="KyiJdkHfAW7Gcaq_ivn_-164" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2260" y="1261" />
              <mxPoint x="2260" y="1780" />
              <mxPoint x="860" y="1780" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-138" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;wt = fac.&lt;b&gt;newThread&lt;/b&gt;(this);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;wt.&lt;b&gt;start&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 127, 255);&quot;&gt;使用ForkJoinWorkerThreadFactory创建工作者线程并启动，启动成功之后返回true&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2280" y="1200.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-140" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;deregisterWorker&lt;/b&gt;(wt, ex);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return false;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 127, 255);&quot;&gt;如果线程启动时出现异常，注销线程并返回false&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2280" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-147" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-142" target="KyiJdkHfAW7Gcaq_ivn_-146" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-142" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return new &lt;b&gt;ForkJoinWorkerThread&lt;/b&gt;(pool, null);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1200.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-145" value="CommonPoolForkJoinWorkerThreadFactory&lt;br&gt;（commonPool默认的线程工厂）" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2510" y="1165.5" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-150" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-146" target="KyiJdkHfAW7Gcaq_ivn_-149" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2980" y="1230" />
              <mxPoint x="2980" y="1360" />
              <mxPoint x="2020" y="1360" />
              <mxPoint x="2020" y="1411" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-146" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;super(&quot;aForkJoinWorkerThread&quot;);&lt;/div&gt;&lt;div&gt;U.&lt;b&gt;putOrderedObject&lt;/b&gt;(this, INHERITEDACCESSCONTROLCONTEXT, INNOCUOUS_ACC);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;pool&lt;/b&gt; = pool;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;workQueue&lt;/b&gt;=pool.&lt;b&gt;registerWorker&lt;/b&gt;(this);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1180" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-148" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ForkJoinWorkerThread &lt;/b&gt;extends Thread&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;ForkJoinPool 的工作者线程实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ForkJoinPool &lt;b&gt;pool&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // the pool this thread works in&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个工作队列是工作者线程初始化时创建的&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ForkJoinPool.WorkQueue &lt;b&gt;workQueue&lt;/b&gt;; // work-stealing mechanics&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final sun.misc.Unsafe U;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long THREADLOCALS;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long INHERITABLETHREADLOCALS;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long INHERITEDACCESSCONTROLCONTEXT;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-960" y="840" width="440" height="199" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-153" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-149" target="KyiJdkHfAW7Gcaq_ivn_-152" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-149" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;ForkJoinPool#&lt;b&gt;registerWorker&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ForkJoinWorkerThread wt)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;主要就是将工作者线程放到了工作队列的owner字段&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=14;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2040" y="1381.75" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-155" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-152" target="KyiJdkHfAW7Gcaq_ivn_-158" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2380.782608695653" y="1462.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-152" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;wt.&lt;b&gt;setDaemon&lt;/b&gt;(true);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;wt.&lt;b&gt;setUncaughtExceptionHandler&lt;/b&gt;(handler);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;WorkQueue w = new &lt;b&gt;WorkQueue&lt;/b&gt;(this, wt);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里可以看到&lt;b&gt;创建工作者线程的时候还创建了工作队列，这个工作队列是和线程绑定的&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=14;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2280.75" y="1381.25" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-157" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-158" target="KyiJdkHfAW7Gcaq_ivn_-156" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-156" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;wt.&lt;b&gt;setName&lt;/b&gt;(workerNamePrefix.concat(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;Integer.toString(i &amp;gt;&amp;gt;&amp;gt; 1)));&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;修改工作者线程名称，&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;ForkJoinPool-&quot; + nextPoolId() + &quot;-worker-&quot; + 任务队列索引&amp;gt;&amp;gt;&amp;gt;1&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=14;" parent="1" vertex="1">
          <mxGeometry x="2280.75" y="1721" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-158" target="KyiJdkHfAW7Gcaq_ivn_-161" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-158" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;锁同步控制下&lt;/div&gt;&lt;div style=&quot;&quot;&gt;将与工作者线程绑定的工作队列注册到线程池的工作队列数组中&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=14;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="2280.75" y="1551" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-160" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;创建工作者线程时会创建一个与线程绑定的工作队列，两者通过下面两个字段相互绑定：&lt;br style=&quot;font-size: 10px;&quot;&gt;ForkJoinWokerThread.workQueue;&lt;br style=&quot;font-size: 10px;&quot;&gt;WorkQueue.owner;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-960" y="775" width="410" height="50" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-176" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-161" target="KyiJdkHfAW7Gcaq_ivn_-174" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2700" y="1800" />
              <mxPoint x="1460" y="1800" />
              <mxPoint x="1460" y="1960" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-161" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;int i = 0;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // assign a pool index&lt;/div&gt;&lt;div&gt;int &lt;b&gt;mode&lt;/b&gt; = config &amp;amp; MODE_MASK;&lt;/div&gt;&lt;div&gt;int rs = lockRunState();&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WorkQueue[] ws; int n;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // skip if no array&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if ((&lt;b&gt;ws&lt;/b&gt; = workQueues) != null &amp;amp;&amp;amp; (n = ws.length) &amp;gt; 0) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //下面三行代码用于计算工作队列插入位置&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int s = indexSeed += SEED_INCREMENT;&amp;nbsp; // unlikely to collide&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int m = n - 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; i = ((s &amp;lt;&amp;lt; 1) | 1) &amp;amp; m;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//最后一位置1,即插入索引为奇数的位置, 初始值为3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ws[i] != null) {&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//此槽位已经有工作队列了&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int probes = 0;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// step by approx half n&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //从当前位置步进 (n&amp;gt;&amp;gt;&amp;gt;1) &amp;amp; EVENMASK + 2, 选择下一个奇数位置&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //直到找到空槽&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int step = (n &amp;lt;= 4) ? 2 : ((n &amp;gt;&amp;gt;&amp;gt; 1) &amp;amp; EVENMASK) + 2;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; while (ws[i = (i + step) &amp;amp; m] != null) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//试过所有奇数位置都没有空槽，就对工作队列进行扩容一倍&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (++probes &amp;gt;= n) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; workQueues = ws = Arrays.copyOf(ws, n &amp;lt;&amp;lt;= 1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; m = n - 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; probes = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.&lt;b&gt;hint&lt;/b&gt; = s;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 记录随机种子s&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.&lt;b&gt;config&lt;/b&gt; = i | mode;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 更新最近插入工作队列数组的奇数位置&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.&lt;b&gt;scanState&lt;/b&gt; = i;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // publication fence&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;ws[i] = w&lt;/b&gt;;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 将与工作者线程绑定的工作队列插入工作队列数组空槽&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; unlockRunState(rs, rs &amp;amp; ~RSLOCK);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1381.75" width="360" height="398.25" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-163" value="这里其实类似解决哈希冲突的&lt;b&gt;开放地址法（线性探测再哈希）&lt;/b&gt;&lt;br&gt;比如:队列数组length = 16, i = 1,&lt;br style=&quot;font-size: 10px;&quot;&gt;ws[1] 已经有工作队列的话，下次步进获取的奇数位置是11：&lt;br style=&quot;font-size: 10px;&quot;&gt;step = ((16&amp;gt;&amp;gt;&amp;gt;1 &amp;amp;&amp;nbsp;0xfffe) + 2 = 10;&lt;br style=&quot;font-size: 10px;&quot;&gt;i = (1 + 10) &amp;amp; 15 = 11;&lt;br style=&quot;font-size: 10px;&quot;&gt;下次步进：&lt;br style=&quot;font-size: 10px;&quot;&gt;5&lt;br style=&quot;font-size: 10px;&quot;&gt;15&lt;br style=&quot;font-size: 10px;&quot;&gt;9&lt;br style=&quot;font-size: 10px;&quot;&gt;3&lt;br style=&quot;font-size: 10px;&quot;&gt;13&lt;br style=&quot;font-size: 10px;&quot;&gt;7&lt;br style=&quot;font-size: 10px;&quot;&gt;1&lt;br style=&quot;font-size: 10px;&quot;&gt;11&lt;br style=&quot;font-size: 10px;&quot;&gt;5&lt;br style=&quot;font-size: 10px;&quot;&gt;..." style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2890" y="1455.87" width="290" height="210" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-167" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-164" target="KyiJdkHfAW7Gcaq_ivn_-166" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-164" value="&lt;div&gt;&lt;b&gt;ForkJoinPoolThread$run()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;工作者线程执行&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="760" y="1800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-169" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-166" target="KyiJdkHfAW7Gcaq_ivn_-168" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-166" value="onStart();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于拓展，默认是空的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-171" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-168" target="KyiJdkHfAW7Gcaq_ivn_-170" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-173" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-168" target="KyiJdkHfAW7Gcaq_ivn_-172" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-168" value="pool.&lt;b&gt;runWorker&lt;/b&gt;(workQueue);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;workQueue是和工作者线程绑定的工作队列&lt;br&gt;即&lt;b&gt;先扫描与本线程绑定的工作队列中的任务&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-170" value="finally:&lt;br&gt;onTermination(exception);&lt;br&gt;pool.deregisterWorker(this, exception);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即退出工作者线程的操作&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-175" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-172" target="KyiJdkHfAW7Gcaq_ivn_-174" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-172" value="w.growArray();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;前面只是创建了绑定的工作队列，但是并没有进行初始化，growArray是初始化或扩容，这里是初始化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-180" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-174" target="KyiJdkHfAW7Gcaq_ivn_-179" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-174" value="int seed = w.hint;&lt;br&gt;int r = (seed == 0) ? 1 : seed;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-179" target="nZumD_jCBZHTr2Y5oNFb-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KyiJdkHfAW7Gcaq_ivn_-179" value="for (ForkJoinTask&amp;lt;?&amp;gt; t;;)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-4" value="N" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-1" target="nZumD_jCBZHTr2Y5oNFb-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-1" target="nZumD_jCBZHTr2Y5oNFb-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-7" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="nZumD_jCBZHTr2Y5oNFb-6">
          <mxGeometry x="-0.0533" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-1" value="t != null" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1500" y="2140" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-3" target="nZumD_jCBZHTr2Y5oNFb-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-10" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="nZumD_jCBZHTr2Y5oNFb-9">
          <mxGeometry x="-0.1867" relative="1" as="geometry">
            <mxPoint x="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-3" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;被正常唤醒&lt;/font&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-3" target="NMrCZGO8tHE7oQIJTHmH-2">
          <mxGeometry x="0.408" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-3" target="froqMD3xnD5BCt7UT14n-9">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1620" y="2300" />
              <mxPoint x="1700" y="2300" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-3" value="!&lt;b&gt;awaitWork&lt;/b&gt;(w, r)&lt;br&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1500" y="2230" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-5" target="NMrCZGO8tHE7oQIJTHmH-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-5" value="w.runTask(t);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前工作线程执行扫描到的任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1720" y="2140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-8" value="break;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;被终止就直接退出循环&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1720" y="2230" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-11" target="nZumD_jCBZHTr2Y5oNFb-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="nZumD_jCBZHTr2Y5oNFb-11" value="t =&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;scan&lt;/b&gt;(w, r)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;扫描待执行的任务（工作窃取），&lt;b&gt;如果有多个待处理任务还会唤醒其他线程协助处理剩下的可执行任务&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="1480" y="2040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-9" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这部分逻辑细节有点复杂&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;不太适合画图&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#ff6666&quot;&gt;还有些细节没梳理完，&lt;br&gt;但是浪费太多时间了，先放一下&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=-0.005;entryY=0.264;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="nZumD_jCBZHTr2Y5oNFb-11" target="NMrCZGO8tHE7oQIJTHmH-8">
          <mxGeometry x="-0.0008" relative="1" as="geometry">
            <mxPoint x="1900" y="2070" as="sourcePoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-2" target="nZumD_jCBZHTr2Y5oNFb-11">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1440" y="2140" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-2" value="r ^= r &amp;lt;&amp;lt; 13; r ^= r &amp;gt;&amp;gt;&amp;gt; 17; r ^= r &amp;lt;&amp;lt; 5;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;求下次散列值&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="2320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-5" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;被终止&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1665" y="2260" width="50" height="30" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-8" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//通读这个方法的所有代码后可以知道，这个方法主要就是为了扫描工作队列数组获取一个待执行的ForkJoinTask任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//w 是与工作者线程绑定的工作队列，r 是w插入工作队列数组时的随机数种子&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;private ForkJoinTask&amp;lt;?&amp;gt; scan(ForkJoinPool.WorkQueue w, int r) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // m = ws.length-1 工作队列数组的长度是2次幂，m用于通过位运算实现取模运算&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ForkJoinPool.WorkQueue[] ws; int m;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 可能包含待执行任务的前提条件，这个条件不满足说明整个工作队列数组中都没有待执行的任务，直接返回空&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if ((ws = workQueues) != null &amp;amp;&amp;amp; (m = ws.length - 1) &amp;gt; 0 &amp;amp;&amp;amp; w != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // ss 初始值是w插入工作队列数组的索引, 是一个奇数，插入的第一个w scanState初始值为3&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int ss = w.scanState;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 结合后面 k = (k+1) &amp;amp; m, 用于实现如果ws[k]这个工作队列扫描不到待处理任务就遍历下一个工作队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// origin：遍历工作队列数组的初始索引值&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // k: 每次循环的索引值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // oldSum: 每遍历一圈更新一次，记录上次遍历一圈时的checkSum值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // checkSum: 每遍历一圈重置一下，累计某圈遍历中每次循环q.base值（poll指针的值）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int origin = r &amp;amp; m, k = origin, oldSum = 0, checkSum = 0;;) &lt;/b&gt;{&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinPool.WorkQueue q; ForkJoinTask&amp;lt;?&amp;gt;[] a; ForkJoinTask&amp;lt;?&amp;gt; t;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int b, n; long c;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //之前创建工作者线程的时候使用上面变量通过类似“开放地址法”的方法求过绑定的工作队列插入到工作队列数组的位置&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //这里其实是取模定位工作队列数组中的一个工作队列，获取的不一定是与当前工作者线程绑定的工作队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((q = ws[&lt;b&gt;k&lt;/b&gt;]) != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //q.base是poll指针用于取任务 q.top是push指针用于插入任务, 这里判断q中是否有待执行的任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((n = (b = q.base) - q.top) &amp;lt; 0 &amp;amp;&amp;amp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (a = q.array) != null) {&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; // 有待执行的任务&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //b取模a.length获取工作队列数组读索引，然后转成内存的相对偏移i&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;b&gt; long i = (((a.length - 1) &amp;amp; b) &amp;lt;&amp;lt; ASHIFT) + ABASE;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //UNSAFE通过偏移量读取这个位置的任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((t = ((ForkJoinTask&amp;lt;?&amp;gt;)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.getObjectVolatile(a, i))) != null &amp;amp;&amp;amp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; q.base == b) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//q.base是volatile类型，比较一下防止这个任务已经被其他线程读取，其实相当于乐观锁&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //值不等的话说明从上次读取q.base到这次读取q.base之间有其他线程修改了q.base, 这种情况不执行这个任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ss &amp;gt;= 0) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//判断与线程绑定的工作队列是否已经激活&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //先将任务从工作队列中移除，再唤醒工作者线程执行&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (U.compareAndSwapObject(a, i, t, null)) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; q.base = b + 1;&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//更新q.base用于下次取临近的下一个任务&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (n &amp;lt; -1)&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;//n是poll push指针的差值，&amp;lt;-1 说明有多个待处理的任务，等于-1即只有一个待处理任务&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //唤醒其他线程帮忙处理其他待执行的任务&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;signalWork&lt;/b&gt;(ws, q);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return t;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;//当前线程只取q.base处的任务处理&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 与线程绑定的工作队列没有激活，上次checkSum为0且当前遍历的工作队列没有激活&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (oldSum == 0 &amp;amp;&amp;amp;&amp;nbsp; &amp;nbsp;// try to activate&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.scanState &amp;lt; 0)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;tryRelease&lt;/b&gt;(c = ctl, ws[m &amp;amp; (int)c], AC_UNIT);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //下次循环准备&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ss &amp;lt; 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// refresh&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ss = w.scanState;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //多次移位异或操作，计算下个散列值（称随机值有点不恰当）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r ^= r &amp;lt;&amp;lt; 1; r ^= r &amp;gt;&amp;gt;&amp;gt; 3; r ^= r &amp;lt;&amp;lt; 10;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; origin = k = r &amp;amp; m;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// move and rescan&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oldSum = checkSum = 0;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //走到这说明当前工作队列中没有待执行任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSum += b;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //下次循环准备（k = (k + 1) &amp;amp; m）以及循环退出条件&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //如果k位置的工作队列为空则k++，继续循环扫描下一个工作队列，直到工作不为空或者遍历了所有工作队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //这里如果相等说明已经遍历了所有工作队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((k = (k + 1) &amp;amp; m) == origin) {&amp;nbsp; &amp;nbsp; // continue until stable&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //遍历所有工作队列后的处理，不一定退出循环&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((ss &amp;gt;= 0 || (ss == (ss = w.scanState))) &amp;amp;&amp;amp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oldSum == (oldSum = checkSum)) {&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp; //相等说明上一圈和这一圈所有工作队列poll指针都没有移动，即没有读取到可执行任务&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //绑定的工作队列未激活或被锁定才退出循环&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ss &amp;lt; 0 || w.qlock &amp;lt; 0)&amp;nbsp; &amp;nbsp; // already inactive&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;break&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int ns = ss | INACTIVE;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// try to inactivate&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long nc = ((SP_MASK &amp;amp; ns) |&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (UC_MASK &amp;amp; ((c = ctl) - AC_UNIT)));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.stackPred = (int)c;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// hold prev stack top&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putInt(w, QSCANSTATE, ns);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (U.compareAndSwapLong(this, CTL, c, nc))&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ss = ns;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.scanState = ss;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// back out&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSum = 0;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return null;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" vertex="1" parent="1">
          <mxGeometry x="2920" y="1820" width="600" height="940" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-10" target="NMrCZGO8tHE7oQIJTHmH-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-10" value="&lt;b&gt;scanState&lt;/b&gt; &amp;amp;= ~SCANNING;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SCANNING=1, 即将scanState最后一位置为0（scanState变为偶数），scanState为偶数表示繁忙&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-12" value="WorkQueue" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2020" y="2110" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-13" target="NMrCZGO8tHE7oQIJTHmH-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-13" target="NMrCZGO8tHE7oQIJTHmH-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-13" value="(&lt;b&gt;currentSteal&lt;/b&gt; = &lt;b&gt;task&lt;/b&gt;).&lt;b&gt;doExec&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;先执行偷取的任务&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-16" target="NMrCZGO8tHE7oQIJTHmH-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-23" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;3种&lt;br&gt;实现&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="NMrCZGO8tHE7oQIJTHmH-19">
          <mxGeometry x="-0.2444" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-16" value="s = status&lt;br&gt;completed = &lt;b&gt;exec&lt;/b&gt;();&lt;br&gt;if (completed)&amp;nbsp;&lt;br&gt;s = &lt;b&gt;setCompletion&lt;/b&gt;(NORMAL);&lt;br&gt;return s;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2200" y="2220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-18" target="froqMD3xnD5BCt7UT14n-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-18" value="&lt;div style=&quot;&quot;&gt;result = compute();&lt;/div&gt;&amp;nbsp; return true;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2440" y="2220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ForkJoinTask&lt;/b&gt;&amp;lt;V&amp;gt; implements Future&amp;lt;V&amp;gt;, Serializable&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ExceptionNode[] exceptionTable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ReentrantLock exceptionTableLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ReferenceQueue&amp;lt;Object&amp;gt; exceptionTableRefQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;volatile int &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;status&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;; // accessed directly by pool and workers&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int &lt;b&gt;DONE_MASK&lt;/b&gt;&amp;nbsp; &amp;nbsp;= 0xf0000000;&amp;nbsp; // mask out non-completion bits&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int NORMAL&amp;nbsp; &amp;nbsp; &amp;nbsp; = 0xf0000000;&amp;nbsp; // must be negative&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int CANCELLED&amp;nbsp; &amp;nbsp;= 0xc0000000;&amp;nbsp; // must be &amp;lt; NORMAL&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int EXCEPTIONAL = 0x80000000;&amp;nbsp; // must be &amp;lt; CANCELLED&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SIGNAL&amp;nbsp; &amp;nbsp; &amp;nbsp; = 0x00010000;&amp;nbsp; // must be &amp;gt;= 1 &amp;lt;&amp;lt; 16&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final int SMASK&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;= 0x0000ffff;&amp;nbsp; // short bits for tags&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final ForkJoinTask&amp;lt;V&amp;gt; fork()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final V join()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final V invoke()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static void invokeAll(ForkJoinTask&amp;lt;?&amp;gt; t1, ForkJoinTask&amp;lt;?&amp;gt; t2)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static void invokeAll(ForkJoinTask&amp;lt;?&amp;gt;... tasks)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final V get() throws InterruptedException, ExecutionException&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;......&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-480" y="1440.75" width="440" height="279.25" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-21" target="NMrCZGO8tHE7oQIJTHmH-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-21" value="U.&lt;b&gt;putOrderedObject&lt;/b&gt;(this, QCURRENTSTEAL, null);&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;将currentSteal设置为null，putOrderedObject这种方式不保证对其他线程立即可见，但相对currentSteal=null 有性能优势&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-23" target="NMrCZGO8tHE7oQIJTHmH-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-23" target="froqMD3xnD5BCt7UT14n-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-23" value="&lt;b&gt;execLocalTasks&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;再执行本地任务&lt;/b&gt;&lt;br&gt;读取删除并执行所有本地任务，本地任务即与当前工作者线程绑定的工作队列中的任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-25" value="从top指针开始向base指针遍历读取任务并执行&lt;br&gt;U.putOrderedInt(this, QTOP, s);&lt;br&gt;t.doExec();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2440" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-29" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-27" target="NMrCZGO8tHE7oQIJTHmH-25">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-32" value="FILO" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="NMrCZGO8tHE7oQIJTHmH-29">
          <mxGeometry x="0.1561" y="-3" relative="1" as="geometry">
            <mxPoint x="-5" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="NMrCZGO8tHE7oQIJTHmH-27" target="NMrCZGO8tHE7oQIJTHmH-30">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2390" y="2410" />
              <mxPoint x="2390" y="2490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-33" value="FIFO" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="NMrCZGO8tHE7oQIJTHmH-31">
          <mxGeometry x="0.5835" y="-2" relative="1" as="geometry">
            <mxPoint x="-1" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-27" value="队列模式" style="rhombus;whiteSpace=wrap;html=1;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="2220.75" y="2380" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NMrCZGO8tHE7oQIJTHmH-30" value="pollAndExecAll();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;同FILO只不过是从base指针到top指针遍历读取任务并执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2440" y="2460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;总结，主要流程：&lt;br style=&quot;font-size: 10px;&quot;&gt;扫描工作队列数组偷取待处理任务执行，&lt;br style=&quot;font-size: 10px;&quot;&gt;偷取的任务执行完毕执行与线程绑定的工作队列中的待处理任务；&lt;br style=&quot;font-size: 10px;&quot;&gt;如果任务为空则阻塞等待被唤醒&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1080" y="2125" width="310" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-2" target="froqMD3xnD5BCt7UT14n-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-2" value="&lt;div&gt;&lt;/div&gt;scanState |= SCANNING;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将scanState重置为SCANNING&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-4" target="froqMD3xnD5BCt7UT14n-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-4" value="&lt;div&gt;if (++nsteals &amp;lt; 0)&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; transferStealCount(pool);&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;更新与线程绑定的工作队列的偷取任务数量记录 nteals, 溢出后记录到ForkJoinPool.stealCounter上&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-6" value="&lt;div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (thread != null)&lt;/div&gt;thread.afterTopLevelExec();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;留作拓展，方法暂为空&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-9" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;先自旋等待因为可能有新的任务提交，自旋完毕&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;private boolean &lt;b&gt;awaitWork&lt;/b&gt;(WorkQueue w, int r) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 如果工作队列为空或者正在终止，则返回false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (w == null || w.qlock &amp;lt; 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // w.stackPred: 线程栈，前一个工作队列&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (int pred = w.stackPred, spins = SPINS, ss;;) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果工作队列的扫描状态大于等于0，表示有任务需要执行，跳出循环&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((ss = w.scanState) &amp;gt;= 0)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果自旋次数大于0，则继续自旋&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (spins &amp;gt; 0) {&amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 随机数混淆自旋次数&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r ^= r &amp;lt;&amp;lt; 6;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;r ^= r &amp;gt;&amp;gt;&amp;gt; 21;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;r ^= r &amp;lt;&amp;lt; 7;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果自旋次数用尽，随机查找其他工作队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (r &amp;gt;= 0 &amp;amp;&amp;amp; --spins == 0) {&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; WorkQueue v;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;WorkQueue[] ws;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;int s, j;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;AtomicLong sc;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果有前驱工作队列，且绑定的线程正在执行任务，则继续自旋&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (pred != 0 &amp;amp;&amp;amp; (ws = workQueues) != null &amp;amp;&amp;amp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (j = pred &amp;amp; SMASK) &amp;lt; ws.length &amp;amp;&amp;amp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (v = ws[j]) != null &amp;amp;&amp;amp;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (v.parker == null || v.scanState &amp;gt;= 0))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; spins = SPINS;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果工作队列已经处于终止状态，则返回false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (w.qlock &amp;lt; 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果当前线程&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;自旋次数用尽&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;未被中断&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (!Thread.interrupted()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long c, prevctl, parkTime, deadline;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int ac = (int)((c = ctl) &amp;gt;&amp;gt; AC_SHIFT) + (config &amp;amp; SMASK);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果活跃的工作线程数小于等于0，尝试&lt;b&gt;终止线程池&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((ac &amp;lt;= 0 &amp;amp;&amp;amp; tryTerminate(false, false)) ||&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (runState &amp;amp; STOP) != 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果活跃的工作线程数小于等于0且当前工作队列是最后一个等待任务的队列&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (ac &amp;lt;= 0 &amp;amp;&amp;amp; ss == (int)c) {&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 设置新的控制状态&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; prevctl = (UC_MASK &amp;amp; (c + AC_UNIT)) | (SP_MASK &amp;amp; pred);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int t = (short)(c &amp;gt;&amp;gt;&amp;gt; TC_SHIFT);&amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果当前线程数量大于2，则缩小线程池容量&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (t &amp;gt; 2 &amp;amp;&amp;amp; U.compareAndSwapLong(this, CTL, c, prevctl))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 否则计算等待超时时间&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; parkTime = IDLE_TIMEOUT * ((t &amp;gt;= 0) ? 1 : 1 - t);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deadline = System.nanoTime() + parkTime - TIMEOUT_SLOP;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; prevctl = parkTime = deadline = 0L;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //后面代码主要用于让工作者线程进入等待&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread wt = Thread.currentThread();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 模拟LockSupport的行为&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putObject(wt, PARKBLOCKER, this);&amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.parker = wt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果工作队列的扫描状态仍然小于0，并且控制状态没有发生变化，则进行等待&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (w.scanState &amp;lt; 0 &amp;amp;&amp;amp; ctl == c)&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.&lt;b&gt;park&lt;/b&gt;(false, parkTime);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putOrderedObject(w, QPARKER, null);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putObject(wt, PARKBLOCKER, null);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 如果工作队列的扫描状态大于等于0，则表示有任务执行，跳出循环&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (w.scanState &amp;gt;= 0)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (parkTime != 0L &amp;amp;&amp;amp; ctl == c &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deadline - System.nanoTime() &amp;lt;= 0L &amp;amp;&amp;amp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.compareAndSwapLong(this, CTL, c, prevctl))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" vertex="1" parent="1">
          <mxGeometry x="1480" y="2400" width="440" height="840" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-10" value="关键主题：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;ol style=&quot;&quot;&gt;&lt;li style=&quot;&quot;&gt;ForkJoinPool任务提交与处理流程？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;关键步骤简述：任务提交到偶数索引的工作队列，然后会唤醒空闲的工作者线程（ctl ID段）执行，如果没有空闲的工作者线程且工作者线程数量未达到上限，就新建工作者线程并注册到工作队列owner字段；&lt;br&gt;工作者线程启动或被唤醒后会扫描工作队列组读取待执行的任务（任务偷取），如果有多个待执行的任务就唤醒其他线程帮忙处理其他待执行任务，处理完偷取的任务，再遍历执行绑定的工作队列中的本地任务，所有任务执行完毕后，自旋扫描工作队列组中的任务，自旋完毕后，进入等待状态等下次被唤醒。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;ForkJoinPool到底会创建多少个工作者线程，多少个工作队列？任务阻塞有什么影响？&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;由源码可知每次提交任务，如果空闲线程为0且ctl ADD_WORKER位不为0就可以一直创建工作者线程，由于ctl位32-47记录工作者线程总数且代码中只有溢出时ADD_WORKER位才会变为0，而且TC初始值是-parallelism, 所以理论上最多&lt;b&gt;可以创建parallelism个工作者线程&lt;/b&gt;；parallelism最大可以设置为32767。&lt;br&gt;工作队列数量为大于等于并行度的最小2的指数幂的2倍，比如parallelism=8，会创建16个工作队列。&lt;br&gt;像测试中如果提交一批会一直阻塞的任务，如果阻塞任务数量不小于工作者线程数量，会导致所有工作者线程阻塞，之后提交的任务无法被处理。即ForkJoinPool线程也可能被耗尽。&lt;br&gt;&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;ctl各个位的含义&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;见UML图中注释。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;任务窃取的体现&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;工作者线程 scan() 会扫描所有工作队列直到找到待执行的任务并执行；ForkJoinTask join()&amp;nbsp;&lt;/font&gt;&lt;/li&gt;&lt;/ol&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="680" y="10" width="1420" height="170" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-12" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;任务提交是默认提交到索引为偶数的工作队列&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1390" y="605.75" width="260" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-13" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;ctl 低32位为0且第47bit不为0，&lt;br&gt;即不存在空闲线程，且工作者线程数量未达到并行度的值&lt;br&gt;就创建工作者线程&lt;br&gt;&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;shadow=0;" vertex="1" parent="1">
          <mxGeometry x="940" y="1119" width="320" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-14" value="ForkJoinTask" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2260" y="2190" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-20" target="NMrCZGO8tHE7oQIJTHmH-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RecursiveTask&amp;lt;V&amp;gt; （A）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;V result;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected abstract V compute();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-280" y="1760" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-22" value="以 RecursiveTask 为例" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2480" y="2190" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-29" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-24" target="froqMD3xnD5BCt7UT14n-26">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2760" y="2700" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2900" y="2250" />
              <mxPoint x="2900" y="3260" />
              <mxPoint x="740" y="3260" />
              <mxPoint x="740" y="3330" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-24" value="Xxx#compute()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;业务类实现compute()方法&lt;/font&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2680" y="2220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-26" target="froqMD3xnD5BCt7UT14n-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-26" value="Xxx#compute()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;业务类实现compute()方法&lt;/font&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="760" y="3300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="KyiJdkHfAW7Gcaq_ivn_-6" target="froqMD3xnD5BCt7UT14n-27">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="380" y="340" as="sourcePoint" />
            <mxPoint x="380" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-27" value="Future&amp;lt;Integer&amp;gt; sum = pool.&lt;b&gt;submit&lt;/b&gt;(task);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#dae8fc;strokeColor=#000000;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-30" target="froqMD3xnD5BCt7UT14n-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-30" target="froqMD3xnD5BCt7UT14n-40">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-30" value="&lt;div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;SumTask2 t1 = new SumTask2(low, mid);&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;SumTask2 t2 = new SumTask2(mid+1, high);&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;ForkJoinTask&amp;lt;Integer&amp;gt; f1 = t1.&lt;b&gt;fork&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;ForkJoinTask&amp;lt;Integer&amp;gt; f2 = t2.&lt;b&gt;fork&lt;/b&gt;();&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="3300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-35" target="froqMD3xnD5BCt7UT14n-52">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-35" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;return f1.&lt;b&gt;join&lt;/b&gt;() + f2.&lt;b&gt;join&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;调用join()方法时说明本线程已经暂时空闲了，会先尝试从工作队列pop等待的任务自己执行，如果任务已经被窃取，还会去窃取者那里偷取任务执行&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="1000" y="3540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-40" target="froqMD3xnD5BCt7UT14n-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-44" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="froqMD3xnD5BCt7UT14n-43">
          <mxGeometry x="-0.0485" y="-4" relative="1" as="geometry">
            <mxPoint x="12" y="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-40" target="froqMD3xnD5BCt7UT14n-45">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1440" y="3330" />
              <mxPoint x="1440" y="3410" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-48" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="froqMD3xnD5BCt7UT14n-47">
          <mxGeometry x="0.5636" y="-1" relative="1" as="geometry">
            <mxPoint x="11" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-40" value="(t = Thread.currentThread()) &lt;b&gt;instanceof&lt;/b&gt; ForkJoinWorkerThread" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1260" y="3300" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-42" target="froqMD3xnD5BCt7UT14n-49">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-42" value="((ForkJoinWorkerThread)t).workQueue&lt;br&gt;.&lt;b&gt;push&lt;/b&gt;(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前线程是ForkJoinWorkerThread就推送到与当前线程&lt;b&gt;绑定的工作队列&lt;/b&gt;中&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="3300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-45" value="ForkJoinPool.&lt;b&gt;common&lt;/b&gt;.&lt;b&gt;externalPush&lt;/b&gt;(this);&lt;br&gt;return this;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;非ForkJoinWorkerThread，就推送到common线程池的偶数索引的工作队列中&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1480" y="3380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-51" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-49" target="KyiJdkHfAW7Gcaq_ivn_-72">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="750" y="1078.1818181818182" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1940" y="3330" />
              <mxPoint x="1940" y="3250" />
              <mxPoint x="740" y="3250" />
              <mxPoint x="740" y="1085" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-49" value="p.&lt;b&gt;signalWork&lt;/b&gt;(p.workQueues, this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;唤醒其他线程继续&lt;b&gt;扫描并执行&lt;/b&gt;工作队列组中的可执行任务&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1720" y="3300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-55" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-52" target="froqMD3xnD5BCt7UT14n-54">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-52" target="froqMD3xnD5BCt7UT14n-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-52" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;if ((s = &lt;b&gt;doJoin&lt;/b&gt;() &amp;amp;&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;DONE_MASK) != &lt;font style=&quot;font-size: 9px;&quot;&gt;NORMAL&lt;/font&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;reportException(s);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="3540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-54" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;getRawResult&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;读取result字段&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="3620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-61" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-56" target="NMrCZGO8tHE7oQIJTHmH-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-56" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RecursiveAction（A）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected abstract void compute();&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="1760" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-58" target="froqMD3xnD5BCt7UT14n-65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-58" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;private int doJoin() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return (s = status) &amp;lt; 0 ?&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//任务是否已经完成&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s :&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//任务已经完成直接返回任务状态&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ? &lt;font color=&quot;#007fff&quot;&gt;//当前线程是否是ForkJoinWorkerThread?&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (w = (wt = (ForkJoinWorkerThread)t).workQueue).&lt;b&gt;tryUnpush&lt;/b&gt;(this) &lt;font color=&quot;#007fff&quot;&gt;//CAS从线程绑定的工作队列top指针处pop当前任务，这时有可能任务被其他线程偷去，导致pop失败&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;amp;&amp;amp; (s = &lt;b&gt;doExec&lt;/b&gt;()) &amp;lt; 0 ? &lt;font color=&quot;#007fff&quot;&gt;//pop成功直接在当前线程执行任务，然后判断任务是否完成&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; s&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; :&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; wt.pool.&lt;b&gt;awaitJoin&lt;/b&gt;(w, this, 0L)&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//如果任务已被其他线程窃取的处理, 主要就是循环等待任务执行完毕，可能还会帮助Stealer处理任务&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; :&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;externalAwaitDone&lt;/b&gt;();&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//非ForkJoinWorkerThread，pop&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1480" y="3470" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-60" value="ForkJoinTask" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1295" y="3510" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-62" value="&lt;font color=&quot;#007fff&quot;&gt;fork本质就是提交子任务&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1025" y="3360" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="froqMD3xnD5BCt7UT14n-65" target="froqMD3xnD5BCt7UT14n-68">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-65" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;final int &lt;b&gt;awaitJoin&lt;/b&gt;(WorkQueue w, ForkJoinTask&amp;lt;?&amp;gt; task, long deadline) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int s = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (task != null &amp;amp;&amp;amp; w != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt; prevJoin = w.currentJoin;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//记录当前join的任务到工作队列的currentJoin&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.&lt;b&gt;putOrderedObject&lt;/b&gt;(w, QCURRENTJOIN, task);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CountedCompleter&amp;lt;?&amp;gt; cc = (task instanceof CountedCompleter) ?&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (CountedCompleter&amp;lt;?&amp;gt;)task : null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;for (;;)&lt;/b&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((s = task.&lt;b&gt;status&lt;/b&gt;) &amp;lt; 0)&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//任务已经完成直接退出循环&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (cc != null)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;helpComplete&lt;/b&gt;(w, cc, 0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (&lt;b&gt;w.base == w.top&lt;/b&gt; || w.&lt;b&gt;tryRemoveAndExec&lt;/b&gt;(task))&lt;font color=&quot;#007fff&quot;&gt; //当前ForkJoinWorkerThread线程绑定的工作队列中的&lt;b&gt;本地任务已经执行完毕&lt;/b&gt; 或者 成功将任务从队列移除并执行（任务不是已被窃取了么为何还执行这个方法？）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;helpStealer&lt;/b&gt;(w, task);&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//帮助Stealer处理任务&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((s = task.status) &amp;lt; 0)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long ms, ns;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (deadline == 0L)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ms = 0L;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if ((ns = deadline - System.nanoTime()) &amp;lt;= 0L)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if ((ms = TimeUnit.NANOSECONDS.toMillis(ns)) &amp;lt;= 0L)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ms = 1L;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (&lt;b&gt;tryCompensate&lt;/b&gt;(w)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; task.internalWait(ms);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.&lt;b&gt;getAndAddLong&lt;/b&gt;(this, CTL, AC_UNIT); &lt;font color=&quot;#007fff&quot;&gt;// AC+&quot;1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putOrderedObject(w, QCURRENTJOIN, prevJoin);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return s;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" vertex="1" parent="1">
          <mxGeometry x="1960" y="3350" width="360" height="440" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-67" value="&lt;font color=&quot;#007fff&quot;&gt;这里可以看到会扫描工作队列组且是从工作队列base指针处窃取任务&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1690" y="2028" width="390" height="30" as="geometry" />
        </mxCell>
        <mxCell id="froqMD3xnD5BCt7UT14n-68" value="&lt;div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private void &lt;b&gt;helpStealer&lt;/b&gt;(WorkQueue w, ForkJoinTask&amp;lt;?&amp;gt; task) { &lt;font color=&quot;#007fff&quot;&gt;//w：当前工作者线程绑定的工作队列，task：join的任务&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WorkQueue[] ws = workQueues; &lt;font color=&quot;#007fff&quot;&gt;// ws工作队列数组的引用&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int oldSum = 0, checkSum, m;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (ws != null &amp;amp;&amp;amp; (&lt;b&gt;m&lt;/b&gt; = ws.length - 1) &amp;gt;= 0 &amp;amp;&amp;amp; w != null &amp;amp;&amp;amp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;task != null) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; do {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSum = 0;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 用于稳定性检查&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt; subtask;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; WorkQueue j = w, v;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// v 是子任务窃取者&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;descent: for (subtask = task; subtask.status &amp;gt;= 0; )&lt;/b&gt; { &lt;font color=&quot;#007fff&quot;&gt;// 从(j.hint|1)开始遍历奇数工作队列&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//这个循环就是为了遍历工作队列找窃取者&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int &lt;b&gt;h = j.hint | 1&lt;/b&gt;, k = 0, i; ; k += 2) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (k &amp;gt; m)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// 遍历完了都找不到窃取者&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break descent;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((v = &lt;b&gt;ws[i = (h + k) &amp;amp; m]&lt;/b&gt;) != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (v.currentSteal == subtask) { &lt;font color=&quot;#007fff&quot;&gt;// 找到了窃取者&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;b&gt; j.hint = i;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// hint记录窃取者的工作队列的索引&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSum += v.base;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//走到这里说明找到了窃取者&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (;;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt;[] a; int b;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSum += (b = v.base);&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt; &lt;b&gt;next&lt;/b&gt; = v.currentJoin;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (subtask.status &amp;lt; 0 || j.currentJoin != subtask ||&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;v.currentSteal != subtask) &lt;font color=&quot;#007fff&quot;&gt;// 当前线程join的任务已经执行完毕 或 当前线程绑定的工作队列join的任务不是subtask(什么情况下会变？) 或 窃取者的当前偷取的任务不是subtask&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break descent;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (b - v.top &amp;gt;= 0 || (a = v.array) == null) { &lt;font color=&quot;#007fff&quot;&gt;// 窃取者没有待执行的任务&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if ((subtask = next) == null)&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//窃取者join的任务为空&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break descent;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;j = v&lt;/b&gt;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// 跳到外层循环&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//获取窃取者base指针处的任务并执行&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int i = (((a.length - 1) &amp;amp; b) &amp;lt;&amp;lt; ASHIFT) + ABASE;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt; t = ((ForkJoinTask&amp;lt;?&amp;gt;)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;U.getObjectVolatile(a, i));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (v.base == b) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (t == null)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break descent;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (U.compareAndSwapObject(a, i, t, null)) {&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//将任务从窃取者的工作队列中删除&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; v.base = b + 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ForkJoinTask&amp;lt;?&amp;gt; ps = w.currentSteal;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int top = w.top;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; do {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.&lt;b&gt;putOrderedObject&lt;/b&gt;(w, QCURRENTSTEAL, t);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t.&lt;b&gt;doExec&lt;/b&gt;();&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 执行从窃取者那里窃取的任务&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } while (task.status &amp;gt;= 0 &amp;amp;&amp;amp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; w.top != top &amp;amp;&amp;amp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (t = w.pop()) != null);&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//这里循环是顺便将当前线程绑定的工作队列中的任务执行一下，执行从窃取者那窃取的任务也可能会fork子任务提交到当前线程绑定的工作队列，所以要执行一下&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; U.putOrderedObject(w, QCURRENTSTEAL, ps);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (w.base != w.top)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 不能进一步帮助&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } while (task.status &amp;gt;= 0 &amp;amp;&amp;amp; oldSum != (oldSum = checkSum)); &lt;font color=&quot;#007fff&quot;&gt;// join的任务未完成且上次循环有找到窃取者工作队列中待处理的任务就继续循环&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" vertex="1" parent="1">
          <mxGeometry x="2360" y="3350" width="540" height="770" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="35guh6oYoebX98XIw8Dt" name="第 2 页">
    <mxGraphModel dx="954" dy="727" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="BbAymJDytvaLM2xfuUxu-1" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="160" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-2" value="..." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="240" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-3" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-4" value="..." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="240" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-9" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="600" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-10" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="320" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-24" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="120" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-31" value="ws" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="80" y="90" width="40" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-32" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="160" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-33" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="200" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-52" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="BbAymJDytvaLM2xfuUxu-34" target="BbAymJDytvaLM2xfuUxu-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-34" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-35" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="280" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-36" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="320" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-37" value="..." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="520" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-38" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="600" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-43" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="BbAymJDytvaLM2xfuUxu-42" target="BbAymJDytvaLM2xfuUxu-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-42" value="k" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="10" y="125" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-48" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="360" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-49" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="400" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-70" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="BbAymJDytvaLM2xfuUxu-50" target="BbAymJDytvaLM2xfuUxu-60">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-50" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-51" value="null" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="480" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-54" value="ws 是工作队列数组，数组中奇数位置存储与工作者线程绑定的工作队列，偶数位置存储提交任务时创建的工作队列&lt;br&gt;（即任务是提交到偶数位置的工作队列）&lt;br&gt;工作队列默认长度8192，base 是poll指针用于取任务，top是push指针用于插入任务，任务插入和取出起点索引是4096&lt;br&gt;base &amp;lt; top 即包含待处理的任务，base、top是int类型，通过取模队列数组长度求真实的任务索引" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="720" height="70" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-72" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="BbAymJDytvaLM2xfuUxu-55" target="BbAymJDytvaLM2xfuUxu-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="o0kXhplBi4Yt7QeWtotR-1" value="取模" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="BbAymJDytvaLM2xfuUxu-72">
          <mxGeometry x="-0.2" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-55" value="base" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="325" y="170" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-56" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="360" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-57" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-58" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="440" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-59" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="240" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-60" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="160" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-61" value="..." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="440" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-62" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-63" value="..." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="440" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-64" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="600" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-65" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="320" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-66" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="360" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-67" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-68" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="440" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-69" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-73" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="BbAymJDytvaLM2xfuUxu-71" target="BbAymJDytvaLM2xfuUxu-57">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="o0kXhplBi4Yt7QeWtotR-2" value="取模" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="BbAymJDytvaLM2xfuUxu-73">
          <mxGeometry x="-0.25" y="3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-71" value="top" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="405" y="170" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BbAymJDytvaLM2xfuUxu-74" value="index= &lt;br&gt;4096" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="310" y="280" width="60" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
