<mxfile host="Electron" modified="2024-04-22T10:06:04.359Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="oIy7F38h892MK7jSsJ_V" version="21.6.5" type="device">
  <diagram id="h3seWhRiCq7StGXtS9yJ" name="第 1 页">
    <mxGraphModel dx="2950" dy="804" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="l43vFdsVM3XjgTu8qxaD-1" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="40" y="920" width="200" height="140" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-2" value="TLHolder.java" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="95" y="900" width="90" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-3" value="ThreadLocal&amp;lt;Integer&amp;gt; tc1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="60" y="940" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-4" value="ThreadLocal&amp;lt;Integer&amp;gt; tc2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="60" y="1000" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-5" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="40" y="1100" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-6" value="TLHolder2.java" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="90" y="1080" width="100" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-7" value="ThreadLocal&amp;lt;Integer&amp;gt; tc3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="60" y="1120" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-10" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="361.25" y="860" width="160" height="200" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-11" value="Thread 1" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="410" y="840" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-18" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="371.25" y="890" width="140" height="160" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-19" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span&gt;ThreadLocalMap&amp;nbsp;&lt;/span&gt;threadLocals&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="366.25" y="870" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-13" value="referent=tc1&lt;br&gt;value=v11" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="388.75" y="910" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-20" value="&lt;div&gt;referent=tc2&lt;/div&gt;&lt;div&gt;value=v12&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="388.75" y="950" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-21" value="&lt;div&gt;referent=tc3&lt;/div&gt;&lt;div&gt;value=v13&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="388.75" y="990" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-22" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="l43vFdsVM3XjgTu8qxaD-3" target="l43vFdsVM3XjgTu8qxaD-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-38" value="&lt;font style=&quot;font-size: 8px&quot;&gt;threadLocalHashCode1&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="l43vFdsVM3XjgTu8qxaD-22" vertex="1" connectable="0">
          <mxGeometry x="-0.1912" relative="1" as="geometry">
            <mxPoint x="12" y="-8" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-23" value="&lt;span style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#b9e0a5&quot;&gt;threadLocalHashCode2&lt;/font&gt;&lt;/span&gt;" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="l43vFdsVM3XjgTu8qxaD-4" target="l43vFdsVM3XjgTu8qxaD-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-24" value="&lt;font style=&quot;font-size: 8px&quot; color=&quot;#ffd966&quot;&gt;threadLocalHashCode3&lt;/font&gt;" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" source="l43vFdsVM3XjgTu8qxaD-7" target="l43vFdsVM3XjgTu8qxaD-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-25" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="360" y="1100" width="160" height="200" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-26" value="Thread 2" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="408.75" y="1080" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-27" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="370" y="1130" width="140" height="160" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-29" value="&lt;div&gt;referent=tc1&lt;/div&gt;&lt;div&gt;value=v21&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="387.5" y="1150" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-30" value="&lt;div&gt;referent=tc2&lt;/div&gt;&lt;div&gt;value=v22&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="387.5" y="1190" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-31" value="&lt;div&gt;referent=tc3&lt;/div&gt;&lt;div&gt;value=v23&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="387.5" y="1230" width="102.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-32" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="l43vFdsVM3XjgTu8qxaD-3" target="l43vFdsVM3XjgTu8qxaD-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-39" value="threadLocalHashCode1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=8;fontColor=#007FFF;" parent="l43vFdsVM3XjgTu8qxaD-32" vertex="1" connectable="0">
          <mxGeometry x="-0.0901" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-33" value="&lt;span style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#b9e0a5&quot;&gt;threadLocalHashCode2&lt;/font&gt;&lt;/span&gt;" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="l43vFdsVM3XjgTu8qxaD-4" target="l43vFdsVM3XjgTu8qxaD-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-34" value="&lt;span style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#ffd966&quot;&gt;threadLocalHashCode3&lt;/font&gt;&lt;/span&gt;" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" source="l43vFdsVM3XjgTu8qxaD-7" target="l43vFdsVM3XjgTu8qxaD-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-35" value="&lt;font style=&quot;font-size: 10px&quot;&gt;Entry&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="421.25" y="890" width="40" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-36" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span&gt;ThreadLocalMap&amp;nbsp;&lt;/span&gt;threadLocals&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="363.75" y="1110" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l43vFdsVM3XjgTu8qxaD-37" value="&lt;font style=&quot;font-size: 10px&quot;&gt;Entry&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="418.75" y="1130" width="40" height="20" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-2" target="OFWOy6sgKmJJG_9dfcx7-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TLHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;测试类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ThreadLocal&amp;lt;Integer&amp;gt; &lt;b&gt;tc&lt;/b&gt; = ThreadLocal.withInitial(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;() -&amp;gt; 0);&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public static int incrementAndGet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-400" y="80" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-4" target="OFWOy6sgKmJJG_9dfcx7-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-4" target="OFWOy6sgKmJJG_9dfcx7-48">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-4" value="TLHolder.incrementAndGet()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;线程每完成一个任务执行一下&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-5" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;ThreadLocal 实现原理&lt;br&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;br&gt;测试DEMO演示了一个借助ThreadLocal统计线程池各个核心线程完成任务的数量。&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="460" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ThreadLocal&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于计算ThreadLocalMap索引&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final int &lt;b&gt;threadLocalHashCode&lt;/b&gt; = nextHashCode();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static AtomicInteger &lt;b&gt;nextHashCode&lt;/b&gt; = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int HASH_INCREMENT = 0x61c88647;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-800" y="80" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-7" target="OFWOy6sgKmJJG_9dfcx7-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-7" target="OFWOy6sgKmJJG_9dfcx7-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-7" value="tc = ThreadLocal.withInitial(() -&amp;gt; 0);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建带初始化值初始化方法的ThreadLocal对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-9" value="return new SuppliedThreadLocal&amp;lt;&amp;gt;(supplier);" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-11" target="OFWOy6sgKmJJG_9dfcx7-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-11" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SuppliedThreadLocal&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;lt;T&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//只是拓展一个函数式初始值初始化方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Supplier&amp;lt;? extends T&amp;gt; supplier;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected T initialValue()&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-800" y="240" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-14" target="OFWOy6sgKmJJG_9dfcx7-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-14" target="OFWOy6sgKmJJG_9dfcx7-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-14" value="int count = tc.&lt;b&gt;get&lt;/b&gt;() + 1;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-16" target="OFWOy6sgKmJJG_9dfcx7-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-16" target="OFWOy6sgKmJJG_9dfcx7-40">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="521.25" y="515" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-16" value="tc.&lt;b&gt;set&lt;/b&gt;(count);" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-20" value="return count;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="585" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-22" target="OFWOy6sgKmJJG_9dfcx7-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-22" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;Thread t = Thread.currentThread();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;ThreadLocalMap map = &lt;b&gt;getMap&lt;/b&gt;(t);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;if (map != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //this 是 ThreadLocal 对象&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; ThreadLocalMap.Entry e = map.&lt;b&gt;getEntry&lt;/b&gt;(this);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; T result = (T)e.value;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return result;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// e == null, 就调用上面函数式方法设置初始值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;return setInitialValue();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="521.25" y="190" width="280" height="160" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-27" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.003;exitY=0.588;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-24" target="OFWOy6sgKmJJG_9dfcx7-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Thread&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private volatile String name;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; priority;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Thread&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;threadQ;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;eetop;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean&amp;nbsp; &amp;nbsp; &amp;nbsp;single_step;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是守护线程&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean&amp;nbsp; &amp;nbsp; &amp;nbsp;daemon = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean&amp;nbsp; &amp;nbsp; &amp;nbsp;stillborn = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//线程任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Runnable target;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ThreadGroup group;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ClassLoader contextClassLoader;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AccessControlContext inheritedAccessControlContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int threadInitNumber;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//线程本地变量的Map&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;ThreadLocal.ThreadLocalMap &lt;b&gt;threadLocals&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可继承的线程本地变量的Map&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;ThreadLocal.ThreadLocalMap &lt;b&gt;inheritableThreadLocals&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long stackSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long nativeParkEventPointer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Thread ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long tid;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于生成Thread ID&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static long threadSeqNumber;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile int threadStatus = 0;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;ThreadLocalMap getMap(Thread t)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-400" y="240" width="360" height="400" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-30" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-26" target="OFWOy6sgKmJJG_9dfcx7-28">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-26" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;ThreadLocalMap&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ThreadLocalMap初始容量&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final int INITIAL_CAPACITY = 16;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//哈希表&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Entry[] &lt;b&gt;table&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//实际元素个数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;size&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int threshold;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-800" y="360" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-28" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;Entry &lt;/b&gt;extends&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;WeakReference&amp;lt;ThreadLocal&amp;lt;?&amp;gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//KEY是 ThreadLocal&amp;lt;?&amp;gt; 的弱引用类型&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//VALUE&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Object value;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1200" y="360" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-31" target="OFWOy6sgKmJJG_9dfcx7-33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-31" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;div&gt;int i = key.&lt;b&gt;threadLocalHashCode&lt;/b&gt; &amp;amp; (table.length - 1);&lt;/div&gt;&lt;div&gt;Entry e = table[i];&lt;/div&gt;&lt;div&gt;if (e != null &amp;amp;&amp;amp; e.get() == key)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return e;&lt;/div&gt;&lt;div&gt;else&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //e == null 或者 哈希冲突&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;getEntryAfterMiss&lt;/b&gt;(key, i, e);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="840" y="220" width="280" height="100" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-33" target="OFWOy6sgKmJJG_9dfcx7-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-33" value="&lt;div style=&quot;&quot;&gt;getEntryAfterMiss(key, i, e);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=15;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1160" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-35" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;Entry[] tab = table;&lt;/div&gt;&lt;div&gt;int len = tab.length;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;while (e != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ThreadLocal&amp;lt;?&amp;gt; k = e.get();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (k == key)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return e;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (k == null) &lt;font color=&quot;#007fff&quot;&gt;//Entry中key是弱引用，可能被GC导致为null，此时说明Entry对象已经过期，需要删除&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;expungeStaleEntry&lt;/b&gt;(i); &lt;font color=&quot;#007fff&quot;&gt;//这个方法就是删除过期Entry, 对于线性探测算法就是&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面的元素往前移，把刚空出的位置再填上&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; else &lt;font color=&quot;#007fff&quot;&gt;//哈希冲突&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //深入内部实现可以看到用的是开放定址法的线性探测再哈希&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; i = &lt;b&gt;nextIndex&lt;/b&gt;(i, len);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; e = tab[i];&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return null;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1400" y="160" width="320" height="220" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-37" value="总结：&lt;br&gt;&lt;ol&gt;&lt;li&gt;ThreadLocal 本身用于计算哈希索引以及作为读写值的门面，本身不存储数据，数据存储在线程的 ThreadLocalMap 成员;&amp;nbsp;&lt;/li&gt;&lt;li&gt;ThreadLocalMap 以 ThreadLocal&amp;lt;?&amp;gt;&amp;gt; 弱引用类型作为 KEY，当ThreadLocal 对象强引用不存在后，下次GC KEY会变为 null, 意味着Entry过期，会在下次索引时清除（get set 等操作内部都会检查过期的KEY（包括其他ThreadLocal设置的过期的KEY），并进行清理）；&lt;/li&gt;&lt;li&gt;ThreadLocalMap 采用开放定址法的&lt;b&gt;线性探测再散列算法&lt;/b&gt;解决哈希冲突。&lt;/li&gt;&lt;li&gt;ThreadLocal 内存泄露问题 （以不手动清理的前提下讨论ThreadLocal为何会内存泄露）&lt;br&gt;这里的内存泄露是指不调用 remove(), ThreadLocalMap Entry 会内存泄露（包括Key Value），每次使用完后都调用remove()清理是没有内存泄露问题的，（都已经清了还怎么泄露）详细在Markdown中解析。&lt;br&gt;&lt;/li&gt;&lt;/ol&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="560" y="10" width="680" height="170" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-40" target="OFWOy6sgKmJJG_9dfcx7-43">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="840" y="530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-40" target="OFWOy6sgKmJJG_9dfcx7-44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-40" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Thread t = Thread.currentThread();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ThreadLocalMap map = getMap(t);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (map != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; map.set(this, value);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; createMap(t, value);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="521.25" y="475" width="280" height="110" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-43" target="OFWOy6sgKmJJG_9dfcx7-46">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-43" value="&lt;div style=&quot;&quot;&gt;map.set(this, value);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=15;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="840" y="460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-44" value="&lt;div style=&quot;&quot;&gt;createMap(t, value);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建Map并设置值，比较简单不细讲了&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=center;arcSize=15;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="840" y="540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-46" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;Entry[] tab = table;&lt;/div&gt;&lt;div&gt;int len = tab.length;&lt;/div&gt;&lt;div&gt;int i = key.threadLocalHashCode &amp;amp; (len-1);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个for循环处理值更新、哈希冲突&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (Entry e = tab[i];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e != null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e = tab[i = nextIndex(i, len)]) {&lt;font color=&quot;#007fff&quot;&gt; //冲突，线性探测再散列&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ThreadLocal&amp;lt;?&amp;gt; k = e.get();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (k == key) { /&lt;font color=&quot;#007fff&quot;&gt;/更新值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.value = value;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (k == null) { &lt;font color=&quot;#007fff&quot;&gt;//key已经过期&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;replaceStaleEntry&lt;/b&gt;(key, value, i);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//值不存在&lt;/font&gt;&lt;/div&gt;&lt;div&gt;tab[i] = new Entry(key, value);&lt;/div&gt;&lt;div&gt;int sz = ++size;&lt;/div&gt;&lt;div&gt;if (!&lt;b&gt;cleanSomeSlots&lt;/b&gt;(i, sz) &amp;amp;&amp;amp; sz &amp;gt;= threshold)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; rehash();&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1160" y="400" width="320" height="320" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-48" target="OFWOy6sgKmJJG_9dfcx7-50">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-48" value="TLHolder.remove()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用完之后必须手动清理下&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="710" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-50" target="OFWOy6sgKmJJG_9dfcx7-54">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="560.0000000000005" y="740" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-50" value="tc.&lt;b&gt;remove&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="710" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="OFWOy6sgKmJJG_9dfcx7-54" target="OFWOy6sgKmJJG_9dfcx7-55">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-54" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;ThreadLocalMap m = getMap(Thread.currentThread());&lt;/div&gt;&lt;div&gt;if (m != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; m.&lt;b&gt;remove&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=14;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="710" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-55" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;Entry[] tab = table;&lt;/div&gt;&lt;div&gt;int len = tab.length;&lt;/div&gt;&lt;div&gt;int i = key.threadLocalHashCode &amp;amp; (len-1);&lt;/div&gt;&lt;div&gt;for (Entry e = tab[i];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e != null;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e = tab[i = nextIndex(i, len)]) {&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//线性探测寻址&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (e.get() == key) {&lt;font color=&quot;#007fff&quot;&gt; //e.get()获取的是软引用内部的referent&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e.&lt;b&gt;clear&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;//将 referent 设置为 null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;expungeStaleEntry&lt;/b&gt;(i);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="840" y="650" width="240" height="180" as="geometry" />
        </mxCell>
        <mxCell id="OFWOy6sgKmJJG_9dfcx7-57" value="&lt;font color=&quot;#007fff&quot;&gt;不同线程操作同一个ThreadLocal对象，&lt;br&gt;实际操作的是是不同的ThreadLocalMap&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="40" y="840" width="230" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
