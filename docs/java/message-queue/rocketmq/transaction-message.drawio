<mxfile host="Electron" modified="2024-08-27T09:13:51.536Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="puKq1VALRMsDZWo-XtRE" version="21.6.5" type="device">
  <diagram name="第 1 页" id="eP_VPSl60hREy0Ga1Oz-">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="byvQvC30b8q6LA63B50w-49" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;发送成功的返回值&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;sendResult = {SendResult@3066}&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;sendStatus = {SendStatus@3072} &quot;SEND_OK&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;msgId = &quot;ACBE00011BD818B4AAC2847914F90000&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;messageQueue = {MessageQueue@3074} &quot;MessageQueue [topic=TopicTransfer, brokerName=broker-a, queueId=0]&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;queueOffset = 14&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b&gt;transactionId&lt;/b&gt; = &quot;ACBE00011BD818B4AAC2847914F90000&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;offsetMsgId = &quot;C0A8010600002A9F000000000000D9D7&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;regionId = &quot;DefaultRegion&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;traceOn = true&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;rawRespBody = null&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="670" y="900" width="500" height="130" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;RocketMQ 事务消息工作原理（5.2.0）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;结合官方事务消息交互流程进行理解。&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;事务消息处理流程也是涉及 生产者，Broker，消费者，这里只展示了生产者这部分逻辑，Broker 事务消息处理逻辑参考 rocketmq.drawio Broker 页，消费者面对事务消息和普通消息的处理完全一样。&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="660" height="110" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-2" target="byvQvC30b8q6LA63B50w-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-2" value="事务消息生产者" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-3" target="byvQvC30b8q6LA63B50w-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-7" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-6" vertex="1" connectable="0">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-8" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-6" vertex="1" connectable="0">
          <mxGeometry x="0.35" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-3" target="byvQvC30b8q6LA63B50w-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 1 创建事务消息生产者&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;TransactionMQProducer producer = new &lt;b&gt;TransactionMQProducer&lt;/b&gt;(PRODUCER_GROUP, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;Collections.singletonList(TOPIC));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;producer.&lt;b&gt;setNamesrvAddr&lt;/b&gt;(DEFAULT_NAMESRVADDR);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ExecutorService executorService = new ThreadPoolExecutor(2, 5, 100, TimeUnit.SECONDS,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new ArrayBlockingQueue&amp;lt;&amp;gt;(2000), r -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread thread = new Thread(r);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; thread.setName(&quot;client-transaction-msg-check-thread&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return thread;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;producer.&lt;b&gt;setExecutorService&lt;/b&gt;(executorService);&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// 用于检查本地事务执行状态&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;producer.&lt;b&gt;setTransactionListener&lt;/b&gt;(transactionListener);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=5;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-5" value="&lt;div style=&quot;&quot;&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 内部实现和普通的生产者是一样的&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;defaultMQProducerImpl = new &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;(this, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=12;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="210" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-10" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionMQProducer &lt;/b&gt;extends DefaultMQProducer&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;继承 DefaultMQProducer 并拓展了一些东西&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TransactionCheckListener &lt;b&gt;transactionCheckListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int checkThreadPoolMinSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int checkThreadPoolMaxSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int checkRequestHoldMax = 2000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService &lt;b&gt;executorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TransactionListener &lt;b&gt;transactionListener&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-560" y="160" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-11" target="byvQvC30b8q6LA63B50w-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-11" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;producer.start();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=15;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="360" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-13" target="byvQvC30b8q6LA63B50w-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-13" value="生产者发送事务消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-14" target="byvQvC30b8q6LA63B50w-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-14" value="Message msg = new Message(TOPIC, ...);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-16" target="byvQvC30b8q6LA63B50w-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-16" value="SendResult sendResult = producer&lt;br&gt;.&lt;b&gt;sendMessageInTransaction&lt;/b&gt;(msg, null);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-18" target="byvQvC30b8q6LA63B50w-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-18" value="msg.setTopic(NamespaceUtil.wrapNamespace(this.getNamespace(), msg.getTopic()));&lt;br&gt;return this.&lt;b&gt;defaultMQProducerImpl&lt;/b&gt;.&lt;b&gt;sendMessageInTransaction&lt;/b&gt;(msg, null, arg);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="720" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=0.998;exitY=0.15;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="byvQvC30b8q6LA63B50w-20" target="byvQvC30b8q6LA63B50w-35" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-34" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-32" vertex="1" connectable="0">
          <mxGeometry x="0.1658" y="2" relative="1" as="geometry">
            <mxPoint x="12" y="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.944;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="byvQvC30b8q6LA63B50w-20" target="byvQvC30b8q6LA63B50w-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-48" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-47" vertex="1" connectable="0">
          <mxGeometry x="0.708" y="-1" relative="1" as="geometry">
            <mxPoint x="9" y="-6" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-20" value="&lt;font color=&quot;#007fff&quot;&gt;// 做了一些成员字段的检查，忽略延迟发送参数（事务消息看来不支持延迟发送）&lt;br&gt;&lt;/font&gt;...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;// 往 Message properties Map 中添加了两组属性&amp;nbsp;TRAN_MSG: true,&amp;nbsp;PGROUP: xxx&lt;/font&gt;&lt;br&gt;MessageAccessor.putProperty(msg, MessageConst.&lt;b&gt;PROPERTY_TRANSACTION_PREPARED&lt;/b&gt;, &quot;true&quot;);&lt;br&gt;MessageAccessor.putProperty(msg, MessageConst.&lt;b&gt;PROPERTY_PRODUCER_GROUP&lt;/b&gt;, this.defaultMQProducer.getProducerGroup());&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 1 发送阶段和普通消息同步发送处理完全一样, 只是发送内容有少许差异（半事务消息发送）&lt;/font&gt;&lt;br&gt;&lt;/b&gt;sendResult = this.&lt;b&gt;send&lt;/b&gt;(msg);&lt;br&gt;&lt;br&gt;&lt;div&gt;LocalTransactionState localTransactionState = LocalTransactionState.&lt;b&gt;UNKNOW&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;Throwable localException = null;&lt;/div&gt;&lt;div&gt;switch (sendResult.getSendStatus()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;SEND_OK&lt;/b&gt;: {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sendResult.getTransactionId() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;msg&lt;/b&gt;.putUserProperty(&quot;__transactionId__&quot;, sendResult.getTransactionId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String transactionId = msg.getProperty(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null != transactionId &amp;amp;&amp;amp; !&quot;&quot;.equals(transactionId)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.&lt;b&gt;setTransactionId&lt;/b&gt;(transactionId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null != localTransactionListener) { //&lt;font color=&quot;#007fff&quot;&gt; 这个看一直是null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localTransactionState = localTransactionListener.&lt;b&gt;executeLocalTransaction&lt;/b&gt;(msg, arg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.debug(&quot;Used new transaction API&quot;);&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 2 半事务消息发送成功后执行本地事务，回调  localTransactionListener&lt;/b&gt;&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localTransactionState = transactionListener.&lt;b&gt;executeLocalTransaction&lt;/b&gt;(msg, arg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == localTransactionState) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localTransactionState = LocalTransactionState.UNKNOW;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localException = e;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;FLUSH_DISK_TIMEOUT&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;FLUSH_SLAVE_TIMEOUT&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;SLAVE_NOT_AVAILABLE&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localTransactionState = LocalTransactionState.&lt;b&gt;ROLLBACK_MESSAGE&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 即 UNKNOW&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;// &lt;b&gt;3 根据 SendResult 和 本地事务执行结果 做后续处理，结束事务&lt;/b&gt;&lt;br&gt;&lt;/font&gt;thisthis.&lt;b&gt;endTransaction&lt;/b&gt;(msg, sendResult, localTransactionState, localException);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;// SendResult 转成&amp;nbsp;TransactionSendResult 返回&lt;br&gt;&lt;/font&gt;return transactionSendResult;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1000" y="670" width="440" height="650" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-22" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1145" y="640" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;核心类，DefaultMQProducerImpl 实现的是一个MQ客户端（MQClientInstance）上的某一分组的消息生产者&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random &lt;b&gt;random&lt;/b&gt; = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 DefaultMQProducer 实例，对于事务消息，这里是 TransactionMQProducer 类型&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//主题消息发布信息表，即某个主题的消息应该发给哪些Broker节点&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//每个主题对应一个TopicPublishInfo&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* topic */, &lt;b&gt;TopicPublishInfo&lt;/b&gt;&amp;gt; &lt;b&gt;topicPublishInfoTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;EndTransactionHook&amp;gt; endTransactionHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; asyncSenderThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService defaultAsyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected BlockingQueue&amp;lt;Runnable&amp;gt; checkRequestQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 只有事务消息才会用到的线程池，对应&amp;nbsp;TransactionMQProducer executorSerivce&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于本地事务执行状态的检查&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ExecutorService &lt;b&gt;checkExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 这个实例是通过 MQClientManager 工厂创建的，同时也是当前DefautlMQProducerImpl 的容器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前 DefautlMQProducerImpl 只不过是 MQClientInstance 中的一个消息生产者（MQProducerInner&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;MQClientInstance&lt;/b&gt; &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ArrayList&amp;lt;CheckForbiddenHook&amp;gt; checkForbiddenHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQFaultStrategy &lt;b&gt;mqFaultStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService asyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// compression related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int compressLevel = Integer.parseInt(System.getProperty(MixAll.MESSAGE_COMPRESS_LEVEL, &quot;5&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompressionType compressType = CompressionType.of(System.getProperty(MixAll.MESSAGE_COMPRESS_TYPE, &quot;ZLIB&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Compressor compressor = CompressorFactory.getCompressor(compressType);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// backpressure related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendNum;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendSize;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="160" width="520" height="480" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-25" value="&lt;font color=&quot;#007fff&quot;&gt;DefaultMQProducerImpl 中执行事务消息相关的操作主要是通过 defaultMQProducer 引用 （TransactionMQProducer）获取事务消息组件&lt;br&gt;直接通过这个引用反向搜索事务相关的操作&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1000" y="600" width="750" height="40" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-26" target="byvQvC30b8q6LA63B50w-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-26" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 1 额外初始化事务环境&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.defaultMQProducerImpl&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;initTransactionEnv&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 和普通消息生产者启动流程一样&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;super.start();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=8;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-28" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;TransactionMQProducer producer = (TransactionMQProducer) this.defaultMQProducer;&lt;/div&gt;&lt;div&gt;if (producer.getExecutorService() != null) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 这里可以看到事务消息生产者中配置的线程池就是用作 checkExecutor, 如果没有配置会用默认配置&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;checkExecutor&lt;/b&gt; = producer.&lt;b&gt;getExecutorService&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.checkRequestQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;(producer.getCheckRequestHoldMax());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;checkExecutor&lt;/b&gt; = new &lt;b&gt;ThreadPoolExecutor&lt;/b&gt;(&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认配置的本地事务执行状态检查线程池&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; producer.getCheckThreadPoolMinSize(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; producer.getCheckThreadPoolMaxSize(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 1000 * 60,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; TimeUnit.MILLISECONDS,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.checkRequestQueue);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=7;align=left;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="360" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-35" target="byvQvC30b8q6LA63B50w-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-35" value="&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;&quot;&gt;sendDefaultImpl(...)&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=8;align=center;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-36" target="byvQvC30b8q6LA63B50w-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-36" value="&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;&quot;&gt;sendKernelImpl(...)&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=8;align=center;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-38" target="byvQvC30b8q6LA63B50w-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-45" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-43" vertex="1" connectable="0">
          <mxGeometry x="-0.0935" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-38" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 和普通消息的区别&lt;/font&gt;&lt;/div&gt;&lt;div&gt;final String tranMsg = &lt;br&gt;&amp;nbsp; &amp;nbsp; msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);&lt;/div&gt;&lt;div&gt;if (Boolean.parseBoolean(tranMsg)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;sysFlag&lt;/b&gt; |= MessageSysFlag.&lt;b&gt;TRANSACTION_PREPARED_TYPE&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;if (this.&lt;b&gt;hasSendMessageHook&lt;/b&gt;()) { &lt;font color=&quot;#007fff&quot;&gt;// 默认没有消息发送钩子&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (isTrans != null &amp;amp;&amp;amp; isTrans.equals(&quot;true&quot;)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context.setMsgType(MessageType.&lt;b&gt;Trans_Msg_Half&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.executeSendMessageHookBefore(context);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;sendResult = this.mQClientFactory.getMQClientAPIImpl().&lt;b&gt;sendMessage&lt;/b&gt;(...);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=4;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1960" y="640" width="440" height="230" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-42" value="向Broker发送请求的请求码：&lt;br&gt;RequestCode.&lt;b&gt;SEND_MESSAGE_V2&lt;/b&gt;" style="whiteSpace=wrap;html=1;fontSize=10;align=center;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2440" y="725" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-44" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;最终发往Broker的请求：&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;request = {RemotingCommand@3064}&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 9px;&quot;&gt;code&lt;/b&gt; = 310&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;language = {LanguageCode@3076} &quot;JAVA&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;version = 453&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;opaque = 6&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;flag = 0&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;remark = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;extFields = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 9px;&quot;&gt;customHeader&lt;/b&gt; = {SendMessageRequestHeaderV2@3077}&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; a = &quot;transfer_account_pg&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; b = &quot;TopicTransfer&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; c = &quot;TBW102&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; d = {Integer@3088} 4&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; e = {Integer@3089} 3&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; f = {Integer@3088} 4&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; g = {Long@3090} 1724663736223&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; h = {Integer@3091} 0&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&amp;nbsp; &lt;span style=&quot;font-size: 9px;&quot;&gt;i&lt;/span&gt; = &quot;TRAN_MSGtrueUNIQ_KEYACBE00010BE418B4AAC284731B9B0000WAITtruePGROUPtransfer_account_pg&quot;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; j = {Integer@3091} 0&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; k = {Boolean@3093} false&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; l = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; m = {Boolean@3093} false&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; n = &quot;broker-a&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; lo = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; ns = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; nsd = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; bname = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; oway = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;cachedHeader = null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;serializeTypeCurrentRPC = {SerializeType@3078} &quot;JSON&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 9px;&quot;&gt;body&lt;/b&gt; = {byte[36]@3079} [116, 114, 97, 110, 115, 102, 101, 114, 32, 98, 105, 108, 108, 32, 115, 101, 114, 105, 97, 108, 105, 122, 101, 100, 32, 99, 111, 110, 116, 101, 110, 116, 32, 46, 46, 46]&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;suspended = false&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;processTimer = null&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="2440" y="789" width="780" height="380" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.996;exitY=0.194;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="byvQvC30b8q6LA63B50w-46" target="byvQvC30b8q6LA63B50w-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.957;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="byvQvC30b8q6LA63B50w-46" target="byvQvC30b8q6LA63B50w-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-46" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;final MessageId id;&lt;/div&gt;&lt;div&gt;if (sendResult.getOffsetMsgId() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; id = MessageDecoder.decodeMessageId(sendResult.getMsgId());&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;String &lt;b&gt;transactionId&lt;/b&gt; = sendResult.getTransactionId();&lt;/div&gt;&lt;div&gt;final String destBrokerName = this.mQClientFactory.&lt;b&gt;getBrokerNameFromMessageQueue&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;defaultMQProducer.queueWithNamespace(sendResult.getMessageQueue()));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 从&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;brokerAddrTable 查询 broker IP地址信息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;final String brokerAddr = this.mQClientFactory.&lt;b&gt;findBrokerAddressInPublish&lt;/b&gt;(destBrokerName);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 装配事务消息结束请求&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;EndTransactionRequestHeader&lt;/b&gt; &lt;b&gt;requestHeader&lt;/b&gt; = new EndTransactionRequestHeader();&lt;/div&gt;&lt;div&gt;requestHeader.setTransactionId(transactionId);&lt;/div&gt;&lt;div&gt;requestHeader.setCommitLogOffset(id.getOffset());&lt;/div&gt;&lt;div&gt;requestHeader.setBrokerName(destBrokerName);&lt;/div&gt;&lt;div&gt;switch (localTransactionState) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;COMMIT_MESSAGE&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.&lt;b&gt;setCommitOrRollback&lt;/b&gt;(MessageSysFlag.&lt;b&gt;TRANSACTION_COMMIT_TYPE&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;ROLLBACK_MESSAGE&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setCommitOrRollback(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; MessageSysFlag.&lt;b&gt;TRANSACTION_ROLLBACK_TYPE&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;UNKNOW&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setCommitOrRollback(MessageSysFlag.&lt;b&gt;TRANSACTION_NOT_TYPE&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认没有钩子，暂略&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;doExecuteEndTransactionHook&lt;/b&gt;(msg, sendResult.getMsgId(), brokerAddr, localTransactionState, false);&lt;/div&gt;&lt;div&gt;requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());&lt;/div&gt;&lt;div&gt;requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());&lt;/div&gt;&lt;div&gt;requestHeader.setMsgId(sendResult.getMsgId());&lt;/div&gt;&lt;div&gt;String remark = localException != null ? (&quot;executeLocalTransactionBranch exception: &quot; + localException.toString()) : null;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//&amp;nbsp;即向Broker上报本地事务执行结果&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.mQClientFactory.getMQClientAPIImpl().&lt;b&gt;endTransactionOneway&lt;/b&gt;(brokerAddr,&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;requestHeader&lt;/b&gt;, remark,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;this.defaultMQProducer.getSendMsgTimeout());&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="900" width="440" height="500" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-55" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;if (topicEndPointsTable.get(mq.getTopic()) != null &amp;amp;&amp;amp;&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; !topicEndPointsTable.get(mq.getTopic()).isEmpty()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return topicEndPointsTable.get(mq.getTopic()).get(mq);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return mq.getBrokerName();&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=8;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1960" y="900" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-57" value="&lt;div style=&quot;&quot;&gt;向Broker发送OneWay请求&lt;b style=&quot;&quot;&gt; RequestCode.END_TRANSACTION&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;执行 COMMIT 或 Rollback&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=8;align=center;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-65" value="&lt;font color=&quot;#007fff&quot;&gt;参考 rocketmq.drawio&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2640" y="740" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-66" target="byvQvC30b8q6LA63B50w-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-66" value="事务消息生产者请求处理器&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;处理来自Broker的请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="1440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-67" target="byvQvC30b8q6LA63B50w-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-67" value="&lt;b&gt;ClientRemotingProcessor&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;处理请求码：&lt;br style=&quot;font-size: 10px;&quot;&gt;CHECK_TRANSACTION_STATE(39)&lt;br style=&quot;font-size: 10px;&quot;&gt;...&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.001;exitY=0.159;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="byvQvC30b8q6LA63B50w-69" target="byvQvC30b8q6LA63B50w-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-73" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="byvQvC30b8q6LA63B50w-72" vertex="1" connectable="0">
          <mxGeometry x="0.758" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-69" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;switch (request.getCode()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.&lt;b&gt;CHECK_TRANSACTION_STATE&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 1 检查事务消息本地事务执行状态&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;checkTransactionState&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.NOTIFY_CONSUMER_IDS_CHANGED:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.notifyConsumerIdsChanged(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.RESET_CONSUMER_CLIENT_OFFSET:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.resetOffset(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.GET_CONSUMER_STATUS_FROM_CLIENT:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.getConsumeStatus(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.GET_CONSUMER_RUNNING_INFO:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.getConsumerRunningInfo(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.CONSUME_MESSAGE_DIRECTLY:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.consumeMessageDirectly(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.receiveReplyMessage(ctx, request);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="520" y="1440" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="byvQvC30b8q6LA63B50w-71" target="byvQvC30b8q6LA63B50w-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-71" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;final CheckTransactionStateRequestHeader requestHeader =&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; (CheckTransactionStateRequestHeader) request.decodeCommandCustomHeader(CheckTransactionStateRequestHeader.class);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;final ByteBuffer byteBuffer = ByteBuffer.wrap(request.getBody());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;final MessageExt &lt;b&gt;messageExt&lt;/b&gt; = MessageDecoder.decode(byteBuffer);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (messageExt != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (StringUtils.isNotEmpty(this.mqClientFactory.getClientConfig().getNamespace())) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageExt.&lt;b&gt;setTopic&lt;/b&gt;(NamespaceUtil&lt;span style=&quot;background-color: initial;&quot;&gt;.withoutNamespace(messageExt.getTopic(), &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.mqClientFactory.getClientConfig().getNamespace()));&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; String &lt;b&gt;transactionId&lt;/b&gt; = messageExt.getProperty(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (null != transactionId &amp;amp;&amp;amp; !&quot;&quot;.equals(transactionId)) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageExt.&lt;b&gt;setTransactionId&lt;/b&gt;(transactionId);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; final String group = messageExt.getProperty(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;MessageConst.PROPERTY_PRODUCER_GROUP);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (group != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 一个业务服务，可能包含多个生产者、消费者，它们共用一个客户端实例，客户端实例中通过group分组保存各种生产者消费者列表&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MQProducerInner producer = this.mqClientFactory.&lt;b&gt;selectProducer&lt;/b&gt;(group);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (producer != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final String addr = RemotingHelper.parseChannelRemoteAddr(ctx.channel());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 本地事务执行状态检查&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; producer.&lt;b&gt;checkTransactionState&lt;/b&gt;(addr, messageExt, requestHeader);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; logger.debug(&quot;checkTransactionState, pick producer by group[{}] failed&quot;, group);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; logger.warn(&quot;checkTransactionState, pick producer group failed&quot;);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; logger.warn(&quot;checkTransactionState, decode message failed&quot;);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return null;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1440" width="440" height="440" as="geometry" />
        </mxCell>
        <mxCell id="WlkqvdQ92y4gZfxTumTO-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.815;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;exitPerimeter=0;" edge="1" parent="1" source="byvQvC30b8q6LA63B50w-74" target="byvQvC30b8q6LA63B50w-57">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="byvQvC30b8q6LA63B50w-74" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Runnable request = new Runnable() {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;TransactionCheckListener transactionCheckListener = &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DefaultMQProducerImpl.this.checkListener();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; TransactionListener transactionListener = getCheckListener();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;if (transactionCheckListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; localTransactionState = transactionCheckListener.&lt;b&gt;checkLocalTransactionState&lt;/b&gt;(message);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// 回调用户自定义的本地事务执行状态检查方法&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;localTransactionState = transactionListener.&lt;b&gt;checkLocalTransaction&lt;/b&gt;(message);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 根据本地事务执行状态，再次发送&amp;nbsp;RequestCode.END_TRANSACTION OneWay 请求&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;this.&lt;b&gt;processTransactionState&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;localTransactionState,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;group,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;exception);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;};&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;fontSize=10;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1440" width="440" height="200" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
