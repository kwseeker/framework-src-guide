<mxfile host="Electron" modified="2024-12-23T05:07:29.410Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="tMs3iPLyjgdnPanMSHWk" version="21.6.5" type="device">
  <diagram name="第 1 页" id="spDp2wQ0uD9LirAVXnKY">
    <mxGraphModel dx="3915" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-1" target="iDnAsxgB4rMRH4iJf6o4-15" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1810" y="820" />
              <mxPoint x="1810" y="4220" />
              <mxPoint x="380" y="4220" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-6" target="iDnAsxgB4rMRH4iJf6o4-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1820" y="4860" />
              <mxPoint x="380" y="4860" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-1" value="&lt;b&gt;RocketMQ MessageStore（消息存储服务）&lt;/b&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;读消息存储服务的源码前先浏览下《RocketMQ技术内幕》C4 可以帮助理解源码，这部分很值得仔细研究下，可以帮助理解分布式数据存储服务（比如数据库）的设计;&lt;br&gt;这部分源码实现位于 store 模块（3W多行代码，不包括测试）&lt;br&gt;RocketMQ 消息存储文件主要包括 &lt;b&gt;CommitLog 文件&lt;/b&gt;、&lt;b&gt;ConsumeQueue 文件&lt;/b&gt;（消费队列，用于消费时通过主题、队列ID查找消息）、&lt;b&gt;Index 文件&lt;/b&gt;（用于通过&lt;b&gt;消息唯一ID&lt;/b&gt;属性精确查找消息）；&lt;br&gt;消息提交后会存入 CommitLog 文件对应的文件缓冲，然后由 FlushCommitLogService 线程异步将CommitLog中的新消息写入文件；由 ReputMessageService 异步向 ConsumeQueue、IndexFile 中追加消息信息。&lt;br&gt;&lt;b&gt;前置知识&lt;/b&gt;：&lt;br&gt;1. NIO FileChannel ByteBuffer 原理和操作；&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="960" height="120" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-2" target="49yA2R5-UXcHH-bBDfTF-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="230" y="250" />
              <mxPoint x="230" y="250" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-2" value="消息存储服务初始化" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageStore (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消息存储服务接口，包含很多方法，这里主要关注读写&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default CompletableFuture&amp;lt;PutMessageResult&amp;gt; asyncPutMessage(final MessageExtBrokerInner msg)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default CompletableFuture&amp;lt;PutMessageResult&amp;gt; asyncPutMessages(final MessageExtBatch messageExtBatch)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;PutMessageResult putMessage(final MessageExtBrokerInner msg);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;PutMessageResult putMessages(final MessageExtBatch messageExtBatch);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GetMessageResult getMessage(final String group, final String topic, final int queueId,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; final long offset, final int maxMsgNums, final MessageFilter messageFilter);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GetMessageResult getMessage(final String group, final String topic, final int queueId,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; final long offset, final int maxMsgNums, final int maxTotalMsgSize, &lt;br&gt;&amp;nbsp; &amp;nbsp; final MessageFilter messageFilter);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;CompletableFuture&amp;lt;GetMessageResult&amp;gt; getMessageAsync(final String group, final String topic,&amp;nbsp; &amp;nbsp; &amp;nbsp;final int queueId,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;final long offset, final int maxMsgNums, final int maxTotalMsgSize, &lt;br&gt;&amp;nbsp; &amp;nbsp;final MessageFilter messageFilter);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TimerMessageStore getTimerMessageStore();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;...&lt;/b&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-520" y="120" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-6" target="49yA2R5-UXcHH-bBDfTF-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-280" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-42" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-6" target="49yA2R5-UXcHH-bBDfTF-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-6" target="KbcU_BMoqbZB4i3XPj1c-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMessageStore&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RocketMQ自己实现的一种存储服务，&lt;/b&gt;另外还借助 RocksDB 实现了 RocksDBMessageStore，另外在另一个模块还提供了分层实现（暂略）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final PerfCounter.Ticks perfs = new PerfCounter.Ticks(LOGGER);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageStoreConfig &lt;b&gt;messageStoreConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储消息的数据结构&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;CommitLog&lt;/b&gt; &lt;b&gt;commitLog&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ConsumQueue&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;ConsumeQueueStoreInterface&lt;/b&gt; &lt;b&gt;consumeQueueStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ConsumeQueue 文件刷盘线程，继承 ServiceThread&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;FlushConsumeQueueService&lt;/b&gt; &lt;b&gt;flushConsumeQueueService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final CleanCommitLogService &lt;b&gt;cleanCommitLogService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CleanConsumeQueueService &lt;b&gt;cleanConsumeQueueService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CorrectLogicOffsetService correctLogicOffsetService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;IndexService&lt;/b&gt; &lt;b&gt;indexService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MappedFile 分配服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;AllocateMappedFileService&lt;/b&gt; &lt;b&gt;allocateMappedFileService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog 消息分发&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;ReputMessageService&lt;/b&gt; &lt;b&gt;reputMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息存储高可用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;HAService&lt;/b&gt; &lt;b&gt;haService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// CompactionLog&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompactionStore compactionStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompactionService compactionService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final StoreStatsService storeStatsService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//消息堆内存缓存&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;TransientStorePool&lt;/b&gt; &lt;b&gt;transientStorePool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final RunningFlags runningFlags = new RunningFlags();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final SystemClock systemClock = new SystemClock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService scheduledExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BrokerStatsManager brokerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息拉取长轮询模式下的消息到达监听器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MessageArrivingListener&lt;/b&gt; &lt;b&gt;messageArrivingListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//broker配置属性&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;BrokerConfig&lt;/b&gt; &lt;b&gt;brokerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean shutdown = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean notifyMessageArriveInBatch = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件刷盘检测点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;StoreCheckpoint&lt;/b&gt; &lt;b&gt;storeCheckpoint&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TimerMessageStore timerMessageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog文件转发&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final LinkedList&amp;lt;&lt;b&gt;CommitLogDispatcher&lt;/b&gt;&amp;gt; &lt;b&gt;dispatcherList&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RandomAccessFile lockFile;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private FileLock lock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean shutDownNormal = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final static int MAX_PULL_MSG_SIZE = 128 * 1024 * 1024;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile int aliveReplicasNum = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Refer the MessageStore of MasterBroker in the same process.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// If current broker is master, this reference point to null or itself.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// If current broker is slave, this reference point to the store of master broker, and the two stores belong to&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// different broker groups.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MessageStore masterStoreInProcess = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long masterFlushedOffset = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long brokerInitMaxOffset = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;PutMessageHook&amp;gt; putMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private SendMessageBackHook sendMessageBackHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentSkipListMap&amp;lt;Integer /* level */, Long/* delay timeMillis */&amp;gt; delayLevelTable &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;=&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentSkipListMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int maxDelayLevel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger mappedPageHoldCount = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentLinkedQueue&amp;lt;BatchDispatchRequest&amp;gt; batchDispatchRequestQueue = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int dispatchRequestOrderlyQueueSize = 16;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DispatchRequestOrderlyQueue dispatchRequestOrderlyQueue = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DispatchRequestOrderlyQueue(dispatchRequestOrderlyQueueSize);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long stateMachineVersion = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private ConcurrentMap&amp;lt;String, TopicConfig&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;topicConfigTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledCleanQueueExecutorService&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ThreadUtils.newSingleThreadScheduledExecutor(new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ThreadFactoryImpl(&quot;StoreCleanQueueScheduledThread&quot;));&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-520" y="440" width="480" height="1040" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-7" target="49yA2R5-UXcHH-bBDfTF-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-7" value="BrokerController#&lt;br&gt;&lt;b&gt;initializeMessageStore()&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="280" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-12" target="49yA2R5-UXcHH-bBDfTF-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-12" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认的消息存储核心实现&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;defaultMessageStore&lt;/b&gt; = new &lt;b style=&quot;font-size: 9px;&quot;&gt;DefaultMessageStore&lt;/b&gt;(this.messageStoreConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.brokerStatsManager, this.messageArrivingListener, this.brokerConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; topicConfigManager.getTopicConfigTable());&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.brokerStats = new BrokerStats(defaultMessageStore);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageStorePluginContext context = new MessageStorePluginContext(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig, configuration);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果有&lt;b&gt;插件&lt;/b&gt;就使用装饰器模式封装 &lt;b&gt;defaultMessageStore&lt;/b&gt;，没有插件就直接返回 defaultMessageStore&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;messageStore&lt;/b&gt; = MessageStoreFactory.&lt;b&gt;build&lt;/b&gt;(context, &lt;b&gt;defaultMessageStore&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.messageStore.getDispatcherList().addFirst(new &lt;b&gt;CommitLogDispatcherCalcBitMap&lt;/b&gt;(this.brokerConfig, &lt;br&gt;&amp;nbsp; &amp;nbsp; this.consumerFilterManager));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageStoreConfig.isTimerWheelEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerCheckpoint = new TimerCheckpoint(BrokerPathConfigHelper.getTimerCheckPath(&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; TimerMetrics timerMetrics = new TimerMetrics(BrokerPathConfigHelper.getTimerMetricsPath(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //延迟消息存储&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore = new &lt;b&gt;TimerMessageStore&lt;/b&gt;(messageStore, messageStoreConfig, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;timerCheckpoint, timerMetrics, brokerStatsManager);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore.registerEscapeBridgeHook(msg -&amp;gt; escapeBridge.putMessage(msg));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.messageStore.setTimerMessageStore(this.timerMessageStore);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="520" y="120" width="440" height="260" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-75" target="49yA2R5-UXcHH-bBDfTF-20" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1210" y="150" />
              <mxPoint x="1210" y="150" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-81" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-82" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-84" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="iDnAsxgB4rMRH4iJf6o4-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-18" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;这里主要关注线程和线程池任务&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-20" target="49yA2R5-UXcHH-bBDfTF-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-20" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;scheduledCleanQueueExecutorService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建包含1个核心线程的计划任务线程池，线程名前缀 StoreCleanQueueScheduledThread&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-21" target="KbcU_BMoqbZB4i3XPj1c-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-21" value="DefaultMessageStore.this&lt;br&gt;.cleanQueueFilesPeriodically()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-23" target="49yA2R5-UXcHH-bBDfTF-24" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-23" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;AllocateMappedFileService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建一个非守护线程，线程名&lt;/div&gt;&lt;div&gt;AllocateMappedFileService&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-24" value="AllocateMappedFileService#run()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;轮询，阻塞等待获取&lt;br&gt;&amp;nbsp;requestQueue 中的分配请求，成功获取请求后&lt;b&gt;创建MappedFile文件和实例&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-25" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;IndexService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;每次创建Index文件都会创建一个守护线程，线程名FlushIndexFileThread，用于刷盘&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-26" target="KbcU_BMoqbZB4i3XPj1c-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-26" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ReputMessageService&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;ReputMessageService，这里&lt;b&gt;Reput&lt;/b&gt;其实是说将新消息在CommitLog的位置放到对应的ConsumeQueue MappedFile中&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-27" target="KbcU_BMoqbZB4i3XPj1c-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-27" value="&lt;div style=&quot;&quot;&gt;FlushConsumeQueueService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;FlushConsumeQueueService&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于ConsumeQueue刷盘&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-29" target="49yA2R5-UXcHH-bBDfTF-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-29" value="消息写入" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-31" target="49yA2R5-UXcHH-bBDfTF-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-31" value="DefaultMessageStore#&lt;br&gt;&lt;b&gt;asyncPutMessage&lt;/b&gt;(&lt;br&gt;MessageExtBrokerInner msg)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;异步写入&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="280" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-32" target="49yA2R5-UXcHH-bBDfTF-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-32" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//一些&lt;b&gt;钩子&lt;/b&gt;做一些检查、对批量、延迟消息做特殊处理，todo后面再看&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (PutMessageHook putMessageHook : putMessageHookList) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageResult handleResult = putMessageHook.&lt;b&gt;executeBeforePutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (handleResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(handleResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;long beginTime = this.getSystemClock().now();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 将消息异步写入 CommitLog 文件&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageResult&amp;gt; putResultFuture = this.&lt;b&gt;commitLog&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;asyncPutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;putResultFuture.thenAccept(result -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long elapsedTime = this.getSystemClock().now() - beginTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;storeStatsService&lt;/b&gt;.&lt;b&gt;setPutMessageEntireTimeMax&lt;/b&gt;(elapsedTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null == result || !result.isOk()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.storeStatsService.getPutMessageFailedTimes().&lt;b&gt;add&lt;/b&gt;(1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;return putResultFuture;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="520" y="1160" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="D7gBAZF-udVyIJwysne7-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-34" target="D7gBAZF-udVyIJwysne7-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-34" value="消息读取" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="3000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-50" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.401;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-49" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1740" y="1882" />
              <mxPoint x="1740" y="1760" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-52" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="49yA2R5-UXcHH-bBDfTF-50" vertex="1" connectable="0">
          <mxGeometry x="0.9696" relative="1" as="geometry">
            <mxPoint x="-7" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.001;exitY=0.55;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-55" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="49yA2R5-UXcHH-bBDfTF-54" vertex="1" connectable="0">
          <mxGeometry x="0.9654" y="2" relative="1" as="geometry">
            <mxPoint x="-6" y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-62" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" target="49yA2R5-UXcHH-bBDfTF-61" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1720" y="2950" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1720" y="2951" />
              <mxPoint x="1740" y="2951" />
              <mxPoint x="1740" y="2840" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-68" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="49yA2R5-UXcHH-bBDfTF-62" vertex="1" connectable="0">
          <mxGeometry x="0.8121" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.611;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-67" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="49yA2R5-UXcHH-bBDfTF-66" vertex="1" connectable="0">
          <mxGeometry x="0.0733" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-35" value="&lt;div&gt;...&lt;/div&gt;&lt;div&gt;AppendMessageResult result = null;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//根据配置和消息长度设置消息版本类型，V1、V2（支持更大的消息长度）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setVersion(MessageVersion.MESSAGE_VERSION_V2);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//判断并设置消息出生节点地址IPv6标志（如果是IPv6地址的话）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setBornHostV6Flag();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//判断并设置消息存储节点地址IPv6标志（如果是IPv6地址的话）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setStoreHostAddressV6Flag();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//从线程本地获取PutMessageThreadLocal实例，没有就new新建&lt;/font&gt;&lt;/div&gt;&lt;div&gt;PutMessageThreadLocal putMessageThreadLocal = this.putMessageThreadLocal.get();&lt;/div&gt;&lt;div&gt;updateMaxMessageSize(putMessageThreadLocal);&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//更新内部的MessageExtEncoder的缓冲容量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//主要是用于锁住主题队列，就是 &quot;&amp;lt;TopicName&amp;gt;-&amp;lt;queueId&amp;gt;&quot;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;String &lt;b&gt;topicQueueKey&lt;/b&gt; = &lt;b&gt;generateKey&lt;/b&gt;(putMessageThreadLocal.getKeyBuilder(), msg);&lt;/div&gt;&lt;div&gt;long elapsedTimeInLock = 0; &lt;font color=&quot;#007fff&quot;&gt;//检测耗时，耗时太长（500ms）会打印警告日志&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MappedFile unlockMappedFile = null;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取 MappedFiledQueue 中最后一个 MappedFile，因为消息是顺序写入MappedFile，一个文件写满会再新建一个文件&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//获取当前文件写偏移在所有历史消息中的偏移&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long currOffset;&lt;/div&gt;&lt;div&gt;if (mappedFile == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; currOffset = 0;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;currOffset = mappedFile.getFileFromOffset() + mappedFile.getWrotePosition();&lt;/b&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//需要确认副本同步写成功的次数，消息存储可能配置副本（Master节点的存储也属于副本之一），测试中没有配置副本，所以这里是1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int needAckNums = this.defaultMessageStore.getMessageStoreConfig().getInSyncReplicas();&lt;/div&gt;&lt;div&gt;boolean needHandleHA = needHandleHA(msg);&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp;//是否需要配置高可用，todo 后面看高可用实现原理再研究&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (needHandleHA &amp;amp;&amp;amp; this.defaultMessageStore.getBrokerConfig().isEnableControllerMode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.defaultMessageStore.getHaService().inSyncReplicasNums(currOffset) &amp;lt; this.defaultMessageStore.getMessageStoreConfig().getMinInSyncReplicas()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.IN_SYNC_REPLICAS_NOT_ENOUGH, null));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.defaultMessageStore.getMessageStoreConfig().isAllAckInSyncStateSet()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // -1 means all ack in SyncStateSet&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; needAckNums = MixAll.ALL_ACK_IN_SYNC_STATE_SET;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} else if (needHandleHA &amp;amp;&amp;amp; this.defaultMessageStore.getBrokerConfig().isEnableSlaveActingMaster()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int inSyncReplicas = Math.min(this.defaultMessageStore.getAliveReplicaNumInGroup(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMessageStore.getHaService().inSyncReplicasNums(currOffset));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; needAckNums = calcNeedAckNums(inSyncReplicas);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (needAckNums &amp;gt; inSyncReplicas) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Tell the producer, don&#39;t have enough slaves to handle the send request&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.IN_SYNC_REPLICAS_NOT_ENOUGH, null));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;topicQueueLock&lt;/b&gt;.lock(&lt;b&gt;topicQueueKey&lt;/b&gt;); &lt;font color=&quot;#007fff&quot;&gt;//锁住主题队列（topicQueueLock&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;内部是一组ReentrantLock）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; boolean needAssignOffset = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (defaultMessageStore.getMessageStoreConfig().isDuplicationEnable()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; defaultMessageStore.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; needAssignOffset = false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (needAssignOffset) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//1 对于可消费的消息，此方法内部会查找或创建对应的&amp;nbsp;ConsumeQueueInterface 实例，并调用&amp;nbsp;assignQueueOffset&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; defaultMessageStore.&lt;b&gt;assignOffset&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //使用 MessageExtEncoder 将消息写到本地的byteBuf缓冲，&lt;/b&gt;内部使用 Netty unpooledByteBufAllocator 分配的 ByteBuf 作为缓冲，编码格式依次是：&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //消息总长(4Bytes&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;)+消息版本魔数(4)+消息体CRC校验码(4)+队列ID(4)+消息Flag(4)+队列偏移(8)+物理偏移(8)+SYSFLAG(4)+BORNTIMESTAMP(8)&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;+BORNHOST(不定长)+STORETIMESTAMP(8)+STOREHOSTADDRESS(不定长)+RECONSUMETIMES(4)+PreparedTransactionOffset(8)+BODY+TOPIC&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;+PROPERTIES+CRC32&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageResult encodeResult = putMessageThreadLocal.getEncoder().&lt;b&gt;encode&lt;/b&gt;(msg); &lt;font color=&quot;#007fff&quot;&gt;//这里编码异常encodeResult才不为空&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (encodeResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(encodeResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//将前面的byteBuf转成NIO ByteBuffer，传给 &lt;b&gt;MessageExtBrokerInner&lt;/b&gt;.&lt;b&gt;encodedBuff&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; msg.&lt;b&gt;setEncodedBuff&lt;/b&gt;(putMessageThreadLocal.getEncoder().getEncoderBuffer());&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageContext putMessageContext = new PutMessageContext(topicQueueKey);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //多个线程需要顺序写入同一个文件，所以需要加锁&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;putMessageLock&lt;/b&gt;.lock(); //spin or ReentrantLock ,depending on store config&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.beginTimeInLock = beginLockTimestamp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!defaultMessageStore.getMessageStoreConfig().isDuplicationEnable()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setStoreTimestamp(beginLockTimestamp);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile || mappedFile.isFull()) { &lt;font color=&quot;#007fff&quot;&gt;//文件不存在（首次存储消息）或文件已满&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;//2 新建MappedFile&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = this.mappedFileQueue.&lt;b&gt;getLastMappedFile&lt;/b&gt;(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isCloseReadAhead()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setFileReadMode(mappedFile, LibC.MADV_RANDOM);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile) {&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp;//文件还是空说明新建文件失败，失败结束&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //3 向MappedFile中追加消息数据，主要是将 MessageExtBrokerInner.encodedBuf 内容写到 MappedFile.byteBuffer 或 mappedByteBuf&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//即这里只是写MappedFile缓冲，真正写文件是在后面借助 FlushCommitLogService 实现&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = &lt;b&gt;mappedFile&lt;/b&gt;.&lt;b&gt;appendMessage&lt;/b&gt;(msg, this.&lt;b&gt;appendMessageCallback&lt;/b&gt;, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch (result.getStatus()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;PUT_OK&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//存储成功&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;END_OF_FILE&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; unlockMappedFile = mappedFile;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Create a new file, re-write the message&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = this.mappedFileQueue.getLastMappedFile(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // XXX: warn and notify me&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;create mapped file2 error, topic: &quot; + msg.getTopic() + &quot; clientAddr: &quot; + msg.getBornHostString());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.CREATE_MAPPED_FILE_FAILED, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isCloseReadAhead()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setFileReadMode(mappedFile, LibC.MADV_RANDOM);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = mappedFile.appendMessage(msg, this.appendMessageCallback, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (AppendMessageStatus.PUT_OK.equals(result.getStatus())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;MESSAGE_SIZE_EXCEEDED&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;PROPERTIES_SIZE_EXCEEDED&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;UNKNOWN_ERROR&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elapsedTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageLock.unlock();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //写成功后更新偏移量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (AppendMessageStatus.PUT_OK.equals(result.getStatus())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMessageStore.&lt;b&gt;increaseOffset&lt;/b&gt;(msg, getMessageNum(msg));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} catch (RocksDBException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result));&lt;/div&gt;&lt;div&gt;} finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; topicQueueLock.unlock(topicQueueKey);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;if (null != unlockMappedFile &amp;amp;&amp;amp; this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.defaultMessageStore.unlockMappedFile(unlockMappedFile);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// Statistics&lt;/font&gt;&lt;/div&gt;&lt;div&gt;storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).add(result.getMsgNum());&lt;/div&gt;&lt;div&gt;storeStatsService.getSinglePutMessageTopicSizeTotal(topic).add(result.getWroteBytes());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 数据落盘（有同步落盘和异步落盘，默认使用异步落盘），内部通过唤醒 FlushCommitLogService 实现刷盘&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return handleDiskFlushAndHA(putMessageResult, msg, needAckNums, needHandleHA);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1160" width="720" height="1800" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-97" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-39" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CommitLog&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储消息的数据结构&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog中存储的内容类型有两种，MESSAGE、BLANK（剩余空间不足以存储新消息时）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final static int MESSAGE_MAGIC_CODE = -626843481;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final static int BLANK_MAGIC_CODE = -875286124;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//存储消息的MappedFile队列&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final MappedFileQueue &lt;b&gt;mappedFileQueue&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final DefaultMessageStore defaultMessageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//CommitLog 刷盘服务管理器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushManager &lt;b&gt;flushManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ColdDataCheckService coldDataCheckService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AppendMessageCallback appendMessageCallback;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ThreadLocal&amp;lt;&lt;b&gt;PutMessageThreadLocal&lt;/b&gt;&amp;gt; &lt;b&gt;putMessageThreadLocal&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//看源码其实就是最后的可读位置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long &lt;b&gt;confirmOffset&lt;/b&gt; = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long beginTimeInLock = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final PutMessageLock putMessageLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final TopicQueueLock topicQueueLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile Set&amp;lt;String&amp;gt; fullStorePaths = Collections.emptySet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushDiskWatcher flushDiskWatcher;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected int commitLogSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean enabledAppendPropCRC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final MultiDispatch multiDispatch;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="440" width="480" height="360" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-40" target="49yA2R5-UXcHH-bBDfTF-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-40" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MappedFileQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;存储消息的MappedFile队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路径 &amp;lt;storePath&amp;gt;/commitlog ，&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;lt;storePath&amp;gt;可以通过 broker.conf 设置，默认是${ROCKET_HOME}下store文件夹&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;protected final String &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;storePath&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单个文件大小，默认1G bytes&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final int &lt;b&gt;mappedFileSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件存满后会新建一个文件存储消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final CopyOnWriteArrayList&amp;lt;&lt;b&gt;MappedFile&lt;/b&gt;&amp;gt; &lt;b&gt;mappedFiles&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于创建 MappedFile 实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final AllocateMappedFileService &lt;b&gt;allocateMappedFileService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//刷盘指针，之前的数据都已经刷到磁盘&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;flushedWhere&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//数据提交指针，是ByteBuffer 的写指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;committedWhere&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long storeTimestamp = 0;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="440" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-43" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PutMessageThreadLocal&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;因为这个类实例是存储在线程本地的所以&lt;b&gt;对每个线程来说都有专属的MessageExtEncoder实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息编码器，MessageExtBrokerInner存入CommitLog需要此编码器序列化&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageExtEncoder &lt;b&gt;encoder&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于为生成主题队列的KEY，源码中主要是用于锁&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final StringBuilder &lt;b&gt;keyBuilder&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="760" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-45" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MappedFile (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;存储消息的文件接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路径 &amp;lt;storePath&amp;gt;/commitlog&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="120" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;dashed=1;endArrow=block;endFill=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-48" target="49yA2R5-UXcHH-bBDfTF-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1840" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-48" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMappedFile&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends AbstractMappedFile&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储消息的数据结构，包括写缓冲和文件对象&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int OS_PAGE_SIZE = 1024 * 4; &lt;font color=&quot;#007fff&quot;&gt;//操作系统每页大小，默认4KB&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final Unsafe UNSAFE = getUnsafe();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Method IS_LOADED_METHOD;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int UNSAFE_PAGE_SIZE = UNSAFE == null ? OS_PAGE_SIZE : UNSAFE.pageSize();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicInteger TOTAL_MAPPED_FILES = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; WROTE_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; COMMITTED_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; FLUSHED_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//相对于文件初始偏移的写偏移，即初始偏移+写偏移是消息在所有历史消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;wrotePosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ByteBuffer消息写指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;committedPosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//刷盘指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;flushedPosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前文件大小&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected int fileSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NIO磁盘文件通道&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected FileChannel fileChannel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//写缓冲，由消息中编码后的ByteBuf实例转换得到&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ByteBuffer &lt;b&gt;writeBuffer&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//堆外内存池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected TransientStorePool &lt;b&gt;transientStorePool&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件的名字（其实是文件全路径名），使用当前文件初始偏移命名，比如第一个文件&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;/home/arvin/mywork/github/rocketmq/data/store/commitlog/00000000000000000000&amp;nbsp;&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String &lt;b&gt;fileName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件初始偏移，即当前文件存储的第一条消息的在所有历史消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;fileFromOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//物理文件对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected File &lt;b&gt;file&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//物理文件对应的内存映射&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MappedByteBuffer &lt;b&gt;mappedByteBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件最后一次写数据的时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long &lt;b&gt;storeTimestamp&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是MappedFileQueue中第一个文件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean firstCreateInQueue = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long lastFlushTime = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MappedByteBuffer mappedByteBufferWaitToClean = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long swapMapTime = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long mappedByteBufferAccessCountSinceLastSwap = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;span style=&quot;background-color: initial;&quot;&gt;If this mapped file belongs to consume queue, this field stores store-timestamp of first message referenced&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;by this logical queue.&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long startTimestamp = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;span style=&quot;background-color: initial;&quot;&gt;If this mapped file belongs to consume queue, this field stores store-timestamp of last message referenced&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;by this logical queue.&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long stopTimestamp = -1;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="440" width="480" height="760" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-49" target="KbcU_BMoqbZB4i3XPj1c-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-49" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//先查找此 topic 此 queueId 的 ConsumeQueue是否存在，不存在则创建&lt;/font&gt;&lt;/div&gt;&lt;div&gt;ConsumeQueueInterface &lt;b&gt;consumeQueue&lt;/b&gt; = &lt;b&gt;findOrCreateConsumeQueue&lt;/b&gt;(msg.getTopic(),&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; msg.getQueueId());&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//为 msg&amp;nbsp;queueOffset 字段设置偏移量，通过 queueOffsetOperator计算出来的，&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;todo 这个偏移量做什么用的？消息在消费队列中的偏移？&lt;/font&gt;&lt;/div&gt;&lt;div&gt;consumeQueue.&lt;b&gt;assignQueueOffset&lt;/b&gt;(this.queueOffsetOperator, &lt;b&gt;msg&lt;/b&gt;);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="1760" y="1720" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-51" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeQueueStoreInterface&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息存储接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1400" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-53" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MappedFile mappedFile = null;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if (this.allocateMappedFileService != null) { &lt;font color=&quot;#007fff&quot;&gt;//默认会使用这个&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这里虽然是异步创建，但是每次都会将下下一个文件也创建好，下次再获取下下一个文件时早就存在了&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; mappedFile = this.&lt;b&gt;allocateMappedFileService&lt;/b&gt;.&lt;b&gt;putRequestAndReturnMappedFile&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;nextFilePath,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;nextNextFilePath, this.mappedFileSize);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = new &lt;b&gt;DefaultMappedFile&lt;/b&gt;(nextFilePath, this.mappedFileSize);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (IOException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;create mappedFile exception&quot;, e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (mappedFile != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.mappedFiles.isEmpty()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;mappedFile&lt;/b&gt;.&lt;b&gt;setFirstCreateInQueue&lt;/b&gt;(true);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;mappedFiles&lt;/b&gt;.add(mappedFile);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return mappedFile;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1760" y="1840" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-57" value="MappedFileQueue" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1925" y="1810" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-58" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;int currentPos = WROTE_POSITION_UPDATER.get(this); &lt;/span&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;//读取写偏移量 writePosition&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if (currentPos &amp;lt; this.fileSize) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;//优先使用writeBuffer，没有就使用 mappedByteBuffer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ByteBuffer byteBuffer = &lt;b&gt;appendMessageBuffer&lt;/b&gt;().slice();&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; byteBuffer.position(currentPos);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AppendMessageResult result;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (messageExt instanceof MessageExtBatch &amp;amp;&amp;amp; &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;!((MessageExtBatch) messageExt).isInnerBatch()) { &lt;font color=&quot;#007fff&quot;&gt;//批量消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = cb.&lt;b&gt;doAppend&lt;/b&gt;(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (MessageExtBatch) messageExt, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else if (messageExt instanceof MessageExtBrokerInner) { &lt;font color=&quot;#007fff&quot;&gt;//单条消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//内部就是将 MessageExtBrokerInner.encodedBuff 内容写到 MappedFile.byteBuffer 或 &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;mappedByteBuf&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = cb.&lt;b&gt;doAppend&lt;/b&gt;(this.getFileFromOffset(), &lt;b&gt;byteBuffer&lt;/b&gt;, this.fileSize - currentPos,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (MessageExtBrokerInner) messageExt, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WROTE_POSITION_UPDATER.&lt;b&gt;addAndGet&lt;/b&gt;(this, result.getWroteBytes());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.storeTimestamp = result.getStoreTimestamp();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return result;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1760" y="2120" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-61" target="49yA2R5-UXcHH-bBDfTF-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-61" value="&lt;div&gt;//&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageStatus&amp;gt; flushResultFuture = &lt;b&gt;handleDiskFlush&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; putMessageResult.getAppendMessageResult(), messageExt);&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageStatus&amp;gt; replicaResultFuture;&lt;/div&gt;&lt;div&gt;if (!needHandleHA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; replicaResultFuture = CompletableFuture.completedFuture(PutMessageStatus.PUT_OK);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; replicaResultFuture = handleHA(putMessageResult.getAppendMessageResult(), &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;putMessageResult, needAckNums);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return flushResultFuture.thenCombine(replicaResultFuture, (flushStatus, replicaStatus) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (flushStatus != PutMessageStatus.PUT_OK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult.setPutMessageStatus(flushStatus);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (replicaStatus != PutMessageStatus.PUT_OK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult.setPutMessageStatus(replicaStatus);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return putMessageResult;&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1760" y="2720" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="49yA2R5-UXcHH-bBDfTF-63" target="49yA2R5-UXcHH-bBDfTF-100" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2700" y="2840" />
              <mxPoint x="2700" y="1680" />
              <mxPoint x="1930" y="1680" />
              <mxPoint x="1930" y="600" />
              <mxPoint x="1700" y="600" />
              <mxPoint x="1700" y="565" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-63" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//同步刷盘&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (FlushDiskType.SYNC_FLUSH == CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步刷盘&lt;/font&gt;&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!CommitLog.this.defaultMessageStore.isTransientStorePoolEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//借助 CountDownLatch2 实现的等待唤醒，测试中这里实际是 CommitLog$FlushRealTimeService，&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;如果存储配置中 flushCommitLogTimed == true 这个方法相当于什么都没做&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;flushCommitLogService&lt;/b&gt;.&lt;b&gt;wakeup&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; commitRealTimeService.wakeup();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(PutMessageStatus.PUT_OK);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2240" y="2740" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-65" value="CommitLog$DefaultFlushManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2370" y="2710" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-69" target="49yA2R5-UXcHH-bBDfTF-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-69" value="消息存储服务启动" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-73" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-70" target="49yA2R5-UXcHH-bBDfTF-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-70" value="&lt;div&gt;BrokerController#&lt;/div&gt;&lt;div&gt;&lt;b&gt;startBasicService&lt;/b&gt;()()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="280" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-72" target="49yA2R5-UXcHH-bBDfTF-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-72" value="this.&lt;b&gt;messageStore&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-75" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;这里主要关注线程和线程池任务&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-77" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;StoreStatsService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建一个非守护线程，线程名&lt;/div&gt;&lt;div&gt;StoreStatsService&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-78" target="iDnAsxgB4rMRH4iJf6o4-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-78" value="&lt;div style=&quot;&quot;&gt;scheduledCleanQueueExecutorService&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-94" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-79" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;scheduledExecutorService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建包含1个核心线程的计划任务线程池，线程名前缀 StoreScheduledThread&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-83" target="49yA2R5-UXcHH-bBDfTF-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-83" value="&lt;div style=&quot;&quot;&gt;FlushCommitLogService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;可能使用的有3种实现，这里只看FlushRealTimeService&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-85" value="&lt;div style=&quot;&quot;&gt;FlushDiskWatcher&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="600" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-86" target="KbcU_BMoqbZB4i3XPj1c-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-86" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this&lt;br&gt;.cleanFilesPeriodically();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;周期性地删除CommitLog文件，每10s执行一次，删除过期、吊起的CommitLog文件&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-88" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this.checkSelf();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-92" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this&lt;br&gt;.&lt;b&gt;storeCheckpoint&lt;/b&gt;.flush();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;每秒保存一次checkpoint到文件&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-96" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;CommitLog$&lt;b&gt;DefaultFlushManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;CommitLog刷盘服务管理器, 提供了4种实现&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果是同步刷盘则创建 CommitLog$&lt;b&gt;GroupCommitService&lt;/b&gt;,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;异步刷盘则创建&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;CommitLog$&lt;/span&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;FlushRealTimeService&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushCommitLogService &lt;b&gt;flushCommitLogService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog$&lt;b&gt;CommitRealTimeService&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final FlushCommitLogService &lt;b&gt;commitRealTimeService&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1200" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-98" target="49yA2R5-UXcHH-bBDfTF-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-98" value="&lt;div style=&quot;&quot;&gt;CommitLog$FlushRealTimeService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名FlushRealTimeService&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1481" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-100" target="49yA2R5-UXcHH-bBDfTF-102" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="550" />
              <mxPoint x="1940" y="1430" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-100" value="&lt;div style=&quot;&quot;&gt;&lt;b&gt;FlushRealTimeService&lt;/b&gt;#run()&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部轮询执行CommitLog刷盘方法&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="49yA2R5-UXcHH-bBDfTF-102" target="49yA2R5-UXcHH-bBDfTF-104" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-102" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;while&lt;/b&gt; (!this.isStopped()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //flushCommitLogTimed： true（默认）表示每隔一段事件执行一次Flush，false 表示可以通过唤醒或超时触发一次Flush&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean &lt;b&gt;flushCommitLogTimed&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.isFlushCommitLogTimed();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //刷盘间隔（ms），如果可以通过唤醒执行刷盘interval就是超时唤醒时间&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;interval&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //每次刷盘数据阈值，默认至少积累4页才真正执行刷盘&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;flushPhysicQueueLeastPages&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getFlushCommitLogLeastPages();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这个表示每过一段时间即使数据未积累到4页也执行刷盘（默认10s）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;flushPhysicQueueThoroughInterval&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;CommitLog.this.defaultMessageStore&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getMessageStoreConfig()&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.getFlushCommitLogThoroughInterval();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; long currentTimeMillis = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (currentTimeMillis &amp;gt;= (this.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.lastFlushTimestamp = currentTimeMillis;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;flushPhysicQueueLeastPages&lt;/b&gt; = 0; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//改为0，即不限制数据量大小了，只要有待刷的数据就刷盘&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printFlushProgress = (printTimes++ % 10) == 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (flushCommitLogTimed) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.sleep(interval);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.waitForRunning(interval);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long begin = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //执行刷盘方法，里面到底有没有真的刷盘还有一些判断&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.mappedFileQueue.&lt;b&gt;flush&lt;/b&gt;(flushPhysicQueueLeastPages);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (storeTimestamp &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.defaultMessageStore.getStoreCheckpoint()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;setPhysicMsgTimestamp&lt;/b&gt;(storeTimestamp);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long past = System.currentTimeMillis() - begin;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.getMessageStore().getPerfCounter().&lt;b&gt;flowOnce&lt;/b&gt;(&quot;FLUSH_DATA_TIME_MS&quot;, (int) past);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1200" width="440" height="460" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="49yA2R5-UXcHH-bBDfTF-104" target="49yA2R5-UXcHH-bBDfTF-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-109" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="49yA2R5-UXcHH-bBDfTF-107" vertex="1" connectable="0">
          <mxGeometry x="-0.0136" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-104" value="&lt;div style=&quot;&quot;&gt;int offset = mappedFile&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.&lt;b&gt;flush&lt;/b&gt;(flushLeastPages);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里会检查积累的数据是否达到 flushLeastPages&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2440" y="1400" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-106" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (writeBuffer != null &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;|| this.fileChannel.position() != 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;fileChannel&lt;/b&gt;.force(false);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.force();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1390" width="199" height="80" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-1" value="&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;cleanCommitLogService&lt;/b&gt;.run();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-3" value="this.&lt;b&gt;correctLogicOffsetService&lt;/b&gt;.run();&lt;br&gt;this.&lt;b&gt;cleanConsumeQueueService&lt;/b&gt;.run();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-5" value="&lt;div style=&quot;&quot;&gt;&lt;b&gt;FlushConsumeQueueService&lt;/b&gt;#run()&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;轮询执行ConsumeQueue刷盘，被唤醒或超时后执行所有 ConsumeQueueInterface实例 flush() 方法&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1481" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-7" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ConsumeQueueService 刷盘规则和 CommitLog 类似&lt;br&gt;这里不再详细叙述了&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1685" y="450" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-8" target="49yA2R5-UXcHH-bBDfTF-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.844;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-8" target="KbcU_BMoqbZB4i3XPj1c-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractConsumeQueueStore&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息存储数据结构&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属DefaultMessageStore&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final DefaultMessageStore messageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final MessageStoreConfig messageStoreConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final QueueOffsetOperator queueOffsetOperator = new QueueOffsetOperator();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//topic -&amp;gt; queueId -&amp;gt; ConsumeQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//核心字段，即一个ConsumeQueueStore 存储当前Broker节点所有主题所有队列的ConsumeQueue&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;String/* topic */, ConcurrentMap&amp;lt;Integer/* queueId */, ConsumeQueueInterface&amp;gt;&amp;gt; &lt;b&gt;consumeQueueTable&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1560" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-10" target="KbcU_BMoqbZB4i3XPj1c-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-10" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeQueueStore&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;只是在AbstractCosumeQueueStore基础上拓展了些接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1800" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeQueueInterface&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息队列接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1400" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-14" target="KbcU_BMoqbZB4i3XPj1c-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息队列实现，并不存储消息本身，而是存储消息在CommitLog中的索引信息，每个索引信息长度20Bytes，记录一个消息在CommitLog中的偏移量、长度、tags哈希码&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//ConsumeQueue MappedFile 中存储的消息在 CommitLog 中索引信息的长度&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int CQ_STORE_UNIT_SIZE = 20;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int MSG_TAG_OFFSET_INDEX = 12;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageStore &lt;b&gt;messageStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即内部也是通过 MappedFile 存储消息消费位置信息的&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MappedFileQueue &lt;b&gt;mappedFileQueue&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前消息队列所属消息主题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;topic&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前消息队列的队列ID&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;queueId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//消息在CommitLog中索引信息的临时缓冲&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ByteBuffer &lt;b&gt;byteBufferIndex&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ConsumeQueue MappedFile文件存储绝对路径&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String storePath;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//6000000，大约6M&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int mappedFileSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从源码可以看出这里记录的其实是最新的消息在CommitLog中的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;maxPhysicOffset&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long minLogicOffset = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsumeQueueExt &lt;b&gt;consumeQueueExt&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1561" width="480" height="399" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-18" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;如果topic配置的队列类型是 CQType.&lt;b&gt;BatchCQ&lt;/b&gt;，则创建 &lt;b&gt;BatchConsumeQueue&lt;/b&gt; 实例， 否则创建&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;ConsumeQueue&lt;/b&gt; 实例&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="2240" y="1730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-25" target="KbcU_BMoqbZB4i3XPj1c-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-20" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;ReputMessageService&lt;/b&gt;#run()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;轮询，每间隔1ms循环一次&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;会遍历CommitLog中所有新消息将其在CommitLog中的索引信息加入 ConsumeQueue的MappedFIle&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1480" y="350" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-22" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;代码中先提交分配请求，请求由这个线程异步处理创建MappedFile，但是&lt;br style=&quot;font-size: 10px;&quot;&gt;请求提交后没有什么同步等待措施直接又执行获取MappedFile，还总是能获取成功；&lt;br style=&quot;font-size: 10px;&quot;&gt;主要是这里用了个技巧，创建一个文件时会提前将下一个文件也创建好，&lt;br style=&quot;font-size: 10px;&quot;&gt;下次获取下一个文件就直接返回即可且实际是创建的下下一个文件&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="260" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-23" target="KbcU_BMoqbZB4i3XPj1c-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-23" target="KbcU_BMoqbZB4i3XPj1c-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-38" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-23" target="KbcU_BMoqbZB4i3XPj1c-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-23" target="KbcU_BMoqbZB4i3XPj1c-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-96" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-23" target="KbcU_BMoqbZB4i3XPj1c-95" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2420" y="400" />
              <mxPoint x="2420" y="980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-97" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KbcU_BMoqbZB4i3XPj1c-96" vertex="1" connectable="0">
          <mxGeometry x="0.8418" y="2" relative="1" as="geometry">
            <mxPoint y="29" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-23" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//上次重放（reput）完成偏移如果小于最早的CommitLog文件的首条信息的迁移，说明重放落后好多&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//直接从最早的CommitLog文件的首条信息的偏移开始重放&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (this.reputFromOffset &amp;lt; DefaultMessageStore.this.commitLog.getMinOffset()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.reputFromOffset = DefaultMessageStore.this.commitLog.getMinOffset();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;for (boolean doNext = true; this.isCommitLogAvailable() &amp;amp;&amp;amp; doNext; ) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //读取从上次重放完成的位置开始到当前可读位置间所有数据（从MappedByteBuffer读取）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;SelectMappedBufferResult&lt;/b&gt; &lt;b&gt;result&lt;/b&gt; = DefaultMessageStore.this.commitLog.getData(reputFromOffset);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (result == null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.reputFromOffset = result.getStartOffset(); &lt;font color=&quot;#007fff&quot;&gt;//这一步多余吧，不至于不一致吧？&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;//将消息一个个解析出来（DispatchRequest），分发给所有CommitLogDispatcher执行&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int readSize = 0; readSize &amp;lt; result.getSize() &amp;amp;&amp;amp; reputFromOffset &amp;lt; DefaultMessageStore.this.getConfirmOffset() &amp;amp;&amp;amp; doNext; ) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DispatchRequest dispatchRequest = DefaultMessageStore.this.commitLog&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.checkMessageAndReturnSize(result.getByteBuffer(), false, false, false);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int size = dispatchRequest.getBufferSize() == -1 ? dispatchRequest.getMsgSize() : &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;dispatchRequest.getBufferSize();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (dispatchRequest.isSuccess()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (size &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//内部遍历 DefaultMessageStore 所有 CommitLogDispatcher dispatch() 方法&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //DefaultMessageStore初始化时注册了3个 CommitLogDispatcher:&amp;nbsp;&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;CommitLogDispatcherBuildConsumeQueue、CommitLogDispatcherBuildIndex&lt;/b&gt;、&lt;b&gt;CommitLogDispatcherCompaction&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;doDispatch&lt;/b&gt;(dispatchRequest);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!notifyMessageArriveInBatch) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;notifyMessageArriveIfNecessary&lt;/b&gt;(dispatchRequest);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.reputFromOffset += size;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; readSize += size;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else if (size == 0) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.reputFromOffset = DefaultMessageStore.this.commitLog.rollNextFile(this.reputFromOffset);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; readSize = result.getSize();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (RocksDBException e) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ERROR_LOG.info(...);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result.release();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; finishCommitLogDispatch();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1960" y="120" width="440" height="560" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-20" target="KbcU_BMoqbZB4i3XPj1c-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1680" y="390" as="sourcePoint" />
            <mxPoint x="1960" y="380" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-25" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore#doReput()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1720.5" y="360" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-28" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;抛一些问题：&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;1. MappedFile默认1GB，当剩余空间不足以存储新消息时，会填充BLANK类型数据占位；BLANK会占用掉所有剩余空间么？&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; 从源码看，每个MappedFile填满后都是1GB，推测会用BLANK填满剩余空间，有空验证下&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="500" width="560" height="140" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-29" target="KbcU_BMoqbZB4i3XPj1c-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-29" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;DefaultMessageStore$&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;CommitLogDispatcherBuildConsumeQueue&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;#dispatch()&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2440" y="200" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="xjM-dMiFs_clIyLdk_vj-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-31" target="xjM-dMiFs_clIyLdk_vj-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-31" value="&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;consumeQueueStore&lt;/b&gt;&lt;br&gt;.&lt;b&gt;putMessagePositionInfoWrapper&lt;/b&gt;(&lt;br&gt;dispatchRequest);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;非事务消息以及事务提交消息（可消费消息）&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2680" y="200" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-33" target="KbcU_BMoqbZB4i3XPj1c-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-44" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KbcU_BMoqbZB4i3XPj1c-43" vertex="1" connectable="0">
          <mxGeometry x="0.0081" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-33" value="consumeQueue&lt;br&gt;.&lt;b&gt;putMessagePositionInfoWrapper&lt;/b&gt;(request);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;后面可以看到写入到ConsumeQueue MappedFile的是长度为20bytes的消息索引信息（记录消息在CommitLog中的偏移量、长度、TAGS哈希码）&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fad7ac;strokeColor=#b46504;" parent="1" vertex="1">
          <mxGeometry x="2920.5" y="280" width="199" height="80" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-35" target="KbcU_BMoqbZB4i3XPj1c-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-35" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore$&lt;br&gt;&lt;b&gt;CommitLogDispatcherBuildIndex&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;#dispatch()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2440.5" y="480" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-37" value="&lt;div style=&quot;&quot;&gt;&lt;b&gt;CommitLogDispatcherCompaction&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;#dispatch()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;压缩服务，消息清理有两种方式，一种是压缩、一种是删除（默认），如果配置压缩，就会执行这里的逻辑，暂略&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2440.5" y="560" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-39" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;CommitLogDispatcherCalcBitMap#dispatch()&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2440" y="120" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-41" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DispatcherRequest&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息队列实现，并不存储消息本身，而是存储消息在CommitLog中的位置&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;topic&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;queueId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog中最新提交的消息在MappedFile中的偏移量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;commitLogOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//正在被分发的消息的长度&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;msgSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TAGS属性的hashcode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;tagsCode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long storeTimestamp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息在当前队列的偏移，即相对于当前消费队列第一个消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;consumeQueueOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String keys;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean success;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String uniqKey;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int sysFlag;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long preparedTransactionOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String, String&amp;gt; propertiesMap;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] &lt;b&gt;bitMap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int bufferSize = -1;//the buffer size maybe larger than the msg size if the message is wrapped by something&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// for batch consume queue&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long&amp;nbsp; msgBaseOffset = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private short batchSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long nextReputFromOffset = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String offsetId;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="1560" width="480" height="440" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-42" value="&lt;div&gt;this.&lt;b&gt;byteBufferIndex&lt;/b&gt;.flip(); &lt;font color=&quot;#007fff&quot;&gt;//相当于复位&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;byteBufferIndex&lt;/b&gt;.limit(CQ_STORE_UNIT_SIZE);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;byteBufferIndex&lt;/b&gt;.putLong(offset);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;byteBufferIndex&lt;/b&gt;.putInt(size);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;byteBufferIndex&lt;/b&gt;.putLong(tagsCode);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//计算逻辑偏移即当前索引信息在CQ MappedFile中插入的位置，因为前面还有其他消息的索引信息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;final long expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;&lt;/div&gt;&lt;div&gt;MappedFile mappedFile = this.&lt;b&gt;mappedFileQueue&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; .getLastMappedFile(expectLogicOffset);&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;this.setMaxPhysicOffset(offset + size);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//向ConsumeQueue MappedFile中追加消息在CommitLog中的索引信息，&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;原理参考下面往 CommitLog 中追加消息的流程&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return mappedFile.&lt;b&gt;appendMessage&lt;/b&gt;(this.byteBufferIndex.array());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="3160.5" y="230" width="360" height="180" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-45" target="KbcU_BMoqbZB4i3XPj1c-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-45" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this.indexService&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.buildIndex(request);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2680.5" y="480" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-47" target="KbcU_BMoqbZB4i3XPj1c-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-47" target="KbcU_BMoqbZB4i3XPj1c-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-47" value="&lt;div style=&quot;&quot;&gt;IndexFile indexFile = &lt;b&gt;retryGetAndCreateIndexFile&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;indexFile = &lt;b&gt;putKey&lt;/b&gt;(indexFile, msg, buildKey(topic, req.getUniqKey()));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;uniqKey是创建消息时生成的唯一ID&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;被当作索引Key，格式是 &amp;lt;TopicName&amp;gt;#UUID&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2920.5" y="470" width="199" height="80" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-49" value="IndexService" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2980" y="440" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-50" target="KbcU_BMoqbZB4i3XPj1c-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-50" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;IndexService&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//重试创建Index文件的次数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MAX_TRY_IDX_CREATE = 3;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属DefaultMessageStore&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMessageStore &lt;b&gt;defaultMessageStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;hashSlotNum&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;indexNum&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;storePath&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;IndexFile&amp;gt; &lt;b&gt;indexFileList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2040" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-51" target="KbcU_BMoqbZB4i3XPj1c-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-51" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;IndexFile&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;索引文件也是MappedFile实现的，存储结构：40bytes IndexHeader + hashSlotNum* hashSlotSize + indexNum * indexSize bytes 消息索引信息&lt;/b&gt;（存满的话是420M+40bytes）&lt;b&gt;；&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储的索引信息包括：消息唯一Key的哈希码、消息对应CommitLog的物理偏移、TimeDiff、下一个索引信息位置，每个索引信息长度也是20Bytes&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//每个索引槽的长度，默认4bytes&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int hashSlotSize = 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//每个索引信息长度&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;indexSize&lt;/b&gt; = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;invalidIndex&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//索引信息槽数量，默认5M个&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;hashSlotNum&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息索引最大数量，默认20M个&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;indexNum&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件存满的话总的大小（默认420M+40Bytes）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;fileTotalSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MappedFile &lt;b&gt;mappedFile&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MappedByteBuffer &lt;b&gt;mappedByteBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//索引文件的头信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final IndexHeader &lt;b&gt;indexHeader&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2040" width="480" height="320" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-52" value="&lt;div style=&quot;&quot;&gt;IndexService.this.&lt;b&gt;flush&lt;/b&gt;(...)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;新建索引文件的时候还会创建一个守护线程&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名 FlushIndexFileThread，用于Index文件刷盘&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3160.5" y="480" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;IndexHeader&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;索引文件头信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//头信息长度40bytes&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int INDEX_HEADER_SIZE = 40;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//0-7bits&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;beginTimestampIndex&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//7-15bits&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;endTimestampIndex&lt;/b&gt; = 8;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//16-23bits，索引文件第一个消息索引对应的CommitLog消息的物理偏移量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;beginPhyoffsetIndex&lt;/b&gt; = 16;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//24-32bits，索引文件最后一个消息索引对应的CommitLog消息的物理偏移量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;endPhyoffsetIndex&lt;/b&gt; = 24;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//32-35bits，索引文件hash槽数量，默认5M个&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;hashSlotcountIndex&lt;/b&gt; = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//36-39bits，记录索引信息的数量，也即消息的数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static int &lt;b&gt;indexCountIndex&lt;/b&gt; = 36;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ByteBuffer &lt;b&gt;byteBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong beginTimestamp = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong endTimestamp = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong beginPhyOffset = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong endPhyOffset = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger hashSlotCount = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger indexCount = new AtomicInteger(1);&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="2040" width="480" height="360" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-57" target="KbcU_BMoqbZB4i3XPj1c-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-57" value="&lt;div style=&quot;&quot;&gt;boolean ok =&amp;nbsp;indexFile.&lt;b&gt;putKey&lt;/b&gt;(&lt;b&gt;idxKey&lt;/b&gt;, msg.getCommitLogOffset(), msg.getStoreTimestamp());&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fad7ac;strokeColor=#b46504;" parent="1" vertex="1">
          <mxGeometry x="3160.5" y="560" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-59" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//对消息的唯一ID（uniqueKey）进行哈希取绝对值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int keyHash = indexKeyHashMethod(key);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//取模求消息索引对应的索引槽（默认5M个槽）位置&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int slotPos = keyHash % this.hashSlotNum;&amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//这里可以看到IndexFile存储结构：前40bytes存储IndexHeader信息，后面是&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int &lt;b&gt;absSlotPos&lt;/b&gt; = IndexHeader.INDEX_HEADER_SIZE + slotPos * hashSlotSize;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息索引槽有效性检查&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int slotValue = this.mappedByteBuffer.getInt(absSlotPos);&lt;/div&gt;&lt;div&gt;if (slotValue &amp;lt;= invalidIndex || slotValue &amp;gt; this.indexHeader.getIndexCount()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; slotValue = invalidIndex;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//TimeDiff 是此条消息存储时间相对于IndexService首条消息存储时间的秒数&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long timeDiff = storeTimestamp - this.indexHeader.getBeginTimestamp();&lt;/div&gt;&lt;div&gt;timeDiff = timeDiff / 1000;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//计算消息索引信息的位置，这里可以看到索引信息是顺序存储的&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int &lt;b&gt;absIndexPos&lt;/b&gt; =&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; IndexHeader.INDEX_HEADER_SIZE + this.hashSlotNum * hashSlotSize&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + this.indexHeader.getIndexCount() * indexSize;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//存储消息索引信息内容&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.putInt(absIndexPos, keyHash);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.putLong(absIndexPos + 4, phyOffset);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.putInt(absIndexPos + 4 + 8, (int) timeDiff);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.putInt(absIndexPos + 4 + 8 + 4, slotValue);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//记录消息索引信息加入索引文件后的IndexCount&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.putInt(&lt;b&gt;absSlotPos&lt;/b&gt;, this.indexHeader.getIndexCount());&lt;/div&gt;&lt;div&gt;if (this.indexHeader.getIndexCount() &amp;lt;= 1) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.indexHeader.setBeginPhyOffset(phyOffset);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.indexHeader.setBeginTimestamp(storeTimestamp);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (invalidIndex == slotValue) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.indexHeader.incHashSlotCount();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;this.indexHeader.incIndexCount();&lt;/div&gt;&lt;div&gt;this.indexHeader.setEndPhyOffset(phyOffset);&lt;/div&gt;&lt;div&gt;this.indexHeader.setEndTimestamp(storeTimestamp);&lt;/div&gt;&lt;div&gt;return true;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3400" y="480" width="440" height="460" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-61" value="Begin Timestamp&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2400" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-62" value="IndexFile存储结构：" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2370" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-63" value="End Timestamp&amp;nbsp; &amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1400" y="2400" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-64" value="Begin Physical Offset&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1240" y="2400" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-65" value="End Physical Offset&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1080" y="2400" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-66" value="Hash Slot Count&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-920" y="2400" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-67" value="Index Count&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-840" y="2400" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-68" value="某消息加入后IndexCount&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2440" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-69" value="&lt;div&gt;某消息加入后IndexCount&lt;/div&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="2440" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-70" value="&lt;div&gt;某消息加入后IndexCount&lt;/div&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-840" y="2440" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-71" value="..." style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;dashed=1;dashPattern=1 4;" parent="1" vertex="1">
          <mxGeometry x="-1400" y="2440" width="560" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-72" value="IndexHeader 40bytes" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-750" y="2405" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-73" value="用于计算消息索引信息位置 5M×4 bytes，即 20M bytes" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-750" y="2445" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-74" value="消息唯一key哈希（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2480" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-75" value="消息在CommitLog中的物理偏移&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="2480" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-76" value="Time Diff&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="2480" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-77" value="Next Index Pos&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1240" y="2480" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-79" value="消息唯一key哈希（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2520" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-80" value="消息在CommitLog中的物理偏移&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="2520" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-81" value="Time Diff&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="2520" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-82" value="Next Index Pos&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1240" y="2520" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-85" value="..." style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;dashed=1;dashPattern=1 4;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2560" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-86" value="消息唯一key哈希（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2600" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-87" value="消息在CommitLog中的物理偏移&lt;br style=&quot;font-size: 10px;&quot;&gt;（8 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="2600" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-88" value="Time Diff&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="2600" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-89" value="Next Index Pos&lt;br style=&quot;font-size: 10px;&quot;&gt;（4 Bytes）" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1240" y="2600" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-90" value="消息索引信息，最多 20M×20 bytes，即最多 400M bytes" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-750" y="2530" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-91" value="&lt;font color=&quot;#007fff&quot;&gt;这一行是某个消息的索引信息，消息索引信息是顺序存储的&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="2485" width="340" height="30" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-92" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-69" target="KbcU_BMoqbZB4i3XPj1c-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-83" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-77" target="KbcU_BMoqbZB4i3XPj1c-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-93" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;消息检索流程：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;1. 先对消息唯一Key哈希取绝对值，然后取模哈希槽数量（5M），去20MB空间中检索，获取消息加入索引文件后的IndexCount；&lt;br&gt;2. 通过IndexCount计算消息索引信息位置，去400MB空间中检索，获取消息的索引信息；&lt;br&gt;3. 通过消息的索引信息去CommitLog中检索消息内容。&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2640" width="590" height="60" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbcU_BMoqbZB4i3XPj1c-95" target="SYJajmfzgu2MGfnBpAsg-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KbcU_BMoqbZB4i3XPj1c-95" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore#&lt;br&gt;&lt;b&gt;notifyMessageArrivceIfNecessary&lt;/b&gt;()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2440" y="950" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-1" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;if (DefaultMessageStore.this.brokerConfig.isLongPollingEnable()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; DefaultMessageStore.this.messageArrivingListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;messageArrivingListener&lt;/b&gt;.&lt;b&gt;arriving&lt;/b&gt;(dispatchRequest.getTopic(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getTagsCode(), dispatchRequest.getStoreTimestamp(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getBitMap(), dispatchRequest.getPropertiesMap());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;reputMessageService&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;notifyMessageArrive4MultiQueue&lt;/b&gt;(dispatchRequest);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2680" y="910" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageArrivingListener (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;arriving&lt;/b&gt;(String topic, int queueId, long logicOffset, long tagsCode,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;long msgStoreTime, &lt;br&gt;&amp;nbsp; &amp;nbsp; byte[] filterBitMap, Map&amp;lt;String, String&amp;gt; properties);&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2720" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="SYJajmfzgu2MGfnBpAsg-6" target="SYJajmfzgu2MGfnBpAsg-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NotifyMessageArrivingListener&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullRequestHoldService &lt;b&gt;pullRequestHoldService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PopMessageProcessor &lt;b&gt;popMessageProcessor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NotificationProcessor &lt;b&gt;notificationProcessor&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2840" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="SYJajmfzgu2MGfnBpAsg-9" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;内部逻辑已经不属于 MessageStore 范畴了，&lt;br style=&quot;font-size: 10px;&quot;&gt;回到 rocketmq broker 中分析&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3130" y="960" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="D7gBAZF-udVyIJwysne7-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="D7gBAZF-udVyIJwysne7-1" target="D7gBAZF-udVyIJwysne7-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="D7gBAZF-udVyIJwysne7-1" value="DefaultMessageStore#&lt;b&gt;getMessage&lt;/b&gt;(&lt;br&gt;final String group, final String topic, final int queueId, final long &lt;b&gt;offset&lt;/b&gt;,&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final int &lt;b&gt;maxMsgNums&lt;/b&gt;, final int &lt;b&gt;maxTotalMsgSize&lt;/b&gt;, final MessageFilter messageFilter)&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;此方法是批量读取&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="280" y="2980" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="D7gBAZF-udVyIJwysne7-3" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;Optional&amp;lt;TopicConfig&amp;gt; topicConfig = getTopicConfig(topic);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;CleanupPolicy policy = CleanupPolicyUtils.getDeletePolicy(topicConfig);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TODO 后面研究下压缩策略到底是怎么压缩的，暂略&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (Objects.equals(policy, CleanupPolicy.COMPACTION) &amp;amp;&amp;amp; messageStoreConfig.isEnableCompaction()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return compactionStore.getMessage(group, topic, queueId, offset, maxMsgNums, maxTotalMsgSize);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long beginTime = this.getSystemClock().now();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//offset是消费偏移是从消费者端传进来的，消费者端则是从OffsetStore查询的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long nextBeginOffset = offset;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long minOffset = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long maxOffset = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;GetMessageResult &lt;b&gt;getResult&lt;/b&gt; = new &lt;b&gt;GetMessageResult&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;final long maxOffsetPy = this.commitLog.getMaxOffset();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从ConsumeQueue中查询topic queueId 的消息偏移信息&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;ConsumeQueueInterface consumeQueue = findConsumeQueue(topic, queueId);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (consumeQueue != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; minOffset = consumeQueue.getMinOffsetInQueue();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; maxOffset = consumeQueue.getMaxOffsetInQueue();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (maxOffset == 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(offset, 0);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (offset &amp;lt; minOffset) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.OFFSET_TOO_SMALL;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(offset, minOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (offset == maxOffset) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.OFFSET_OVERFLOW_ONE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(offset, offset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (offset &amp;gt; maxOffset) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(offset, maxOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final int maxFilterMessageSize = Math.max(this.messageStoreConfig.getMaxFilterMessageSize(), maxMsgNums * consumeQueue.getUnitSize());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final boolean diskFallRecorded = this.messageStoreConfig.isDiskFallRecorded();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long maxPullSize = Math.max(maxTotalMsgSize, 100);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//消息一条一条地读取，直到再没有可消费的消息或者读取数量或大小达到批量读取的限制&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; while (getResult.getBufferTotalSize() &amp;lt;= 0&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; nextBeginOffset &amp;lt; maxOffset&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; cqFileNum++ &amp;lt; this.messageStoreConfig.getTravelCqFileNumWhenGetMessage()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ReferredIterator&amp;lt;CqUnit&amp;gt; bufferConsumeQueue = null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bufferConsumeQueue = consumeQueue.iterateFrom(nextBeginOffset, maxMsgNums);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (bufferConsumeQueue == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.OFFSET_FOUND_NULL;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(nextBeginOffset, this.consumeQueueStore.rollNextFile(consumeQueue, nextBeginOffset));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.warn(&quot;consumer request topic: &quot; + topic + &quot;, offset: &quot; + offset + &quot;, minOffset: &quot; + minOffset + &quot;, maxOffset: &quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + maxOffset + &quot;, but access logic queue failed. Correct nextBeginOffset to &quot; + nextBeginOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long nextPhyFileStartOffset = Long.MIN_VALUE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; while (bufferConsumeQueue.hasNext()&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; nextBeginOffset &amp;lt; maxOffset) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... //这里代码也不少，不过从ConsumeQueue结构应该可以猜到做了啥&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SelectMappedBufferResult selectResult = this.commitLog.&lt;b&gt;getMessage&lt;/b&gt;(offsetPy, sizePy);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == selectResult) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (getResult.getBufferTotalSize() == 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.MESSAGE_WAS_REMOVING;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextPhyFileStartOffset = this.commitLog.&lt;b&gt;rollNextFile&lt;/b&gt;(offsetPy);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (messageStoreConfig.isColdDataFlowControlEnable() &amp;amp;&amp;amp; !MixAll.isSysConsumerGroupForNoColdReadLimit(group) &amp;amp;&amp;amp; !selectResult.isInCache()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getResult.setColdDataSum(getResult.getColdDataSum() + sizePy);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (messageFilter != null&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; !messageFilter.isMatchedByCommitLog(selectResult.getByteBuffer().slice(), null)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (getResult.getBufferTotalSize() == 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.NO_MATCHED_MESSAGE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // release...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; selectResult.release();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.storeStatsService.getGetMessageTransferredMsgCount().add(cqUnit.getBatchNum());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getResult.&lt;b&gt;addMessage&lt;/b&gt;(selectResult, cqUnit.getQueueOffset(), cqUnit.getBatchNum());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; status = GetMessageStatus.FOUND;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextPhyFileStartOffset = Long.MIN_VALUE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (RocksDBException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ERROR_LOG.error(...);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (bufferConsumeQueue != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bufferConsumeQueue.release();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (diskFallRecorded) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long fallBehind = maxOffsetPy - maxPhyOffsetPulling;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long diff = maxOffsetPy - maxPhyOffsetPulling;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getResult.setSuggestPullingFromSlave(diff &amp;gt; memory);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; nextBeginOffset = nextOffsetCorrection(offset, 0);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;getResult.setStatus(status);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;getResult.setNextBeginOffset(nextBeginOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;getResult.setMaxOffset(maxOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;getResult.setMinOffset(minOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return getResult;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=1;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="520" y="2980" width="680" height="1200" as="geometry" />
        </mxCell>
        <mxCell id="CM8DxB45Qn-yJO_kRbHL-1" value="&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;每个主题每个队列都有一个消费队列&lt;/font&gt;&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1645" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CM8DxB45Qn-yJO_kRbHL-2" value="&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;用于通过消息唯一ID（&amp;lt;TopicName&amp;gt;#UUID）属性&lt;/b&gt;&lt;b&gt;精确查找消息&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-520" y="2145" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-2" value="&lt;div style=&quot;&quot;&gt;PerfCounter.Ticks&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-4" target="iDnAsxgB4rMRH4iJf6o4-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-4" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.cleanQueueFilesPeriodically();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;周期性地删除 ConsumeQueue 文件&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-6" value="&lt;div style=&quot;&quot;&gt;this.correctLogicOffsetService.run();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;cleanConsumeQueueService&lt;/b&gt;.run();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-15" target="iDnAsxgB4rMRH4iJf6o4-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-15" value="&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;cleanCommitLogService&lt;/b&gt;.run();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="4240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-16" target="iDnAsxgB4rMRH4iJf6o4-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-16" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;cleanConsumeQueueService&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.run();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="4880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-17" target="iDnAsxgB4rMRH4iJf6o4-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-25" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iDnAsxgB4rMRH4iJf6o4-24" vertex="1" connectable="0">
          <mxGeometry x="-0.4318" y="-1" relative="1" as="geometry">
            <mxPoint x="18" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-17" target="iDnAsxgB4rMRH4iJf6o4-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="740" y="4270" />
              <mxPoint x="740" y="4350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-29" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iDnAsxgB4rMRH4iJf6o4-28" vertex="1" connectable="0">
          <mxGeometry x="0.7803" y="-3" relative="1" as="geometry">
            <mxPoint y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-17" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 删除 CommitLog&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;deleteExpiredFiles&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;reDeleteHangedFile&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="4240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-18" target="iDnAsxgB4rMRH4iJf6o4-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-18" target="iDnAsxgB4rMRH4iJf6o4-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-18" value="消息文件周期性清理" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="4240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-23" target="iDnAsxgB4rMRH4iJf6o4-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-1" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iDnAsxgB4rMRH4iJf6o4-31" vertex="1" connectable="0">
          <mxGeometry x="0.0452" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-23" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CommitLog 文件删除的3个充分条件：&lt;b&gt;到删除时间点、磁盘空间超过阈值、手动删除&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (&lt;b&gt;isTimeUp&lt;/b&gt; || &lt;b&gt;isUsageExceedsThreshold&lt;/b&gt; || &lt;b&gt;isManualDelete&lt;/b&gt;) {&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 9px;&quot;&gt;&#x9;&lt;/span&gt;deleteCount = DefaultMessageStore.this.commitLog&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;.&lt;b style=&quot;font-size: 9px;&quot;&gt;deleteExpiredFile&lt;/b&gt;(fileReservedTime, &lt;span style=&quot;white-space: pre; font-size: 9px;&quot;&gt;&#x9;&lt;/span&gt;deletePhysicFilesInterval,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;destroyMappedFileIntervalForcibly, cleanAtOnce, deleteFileBatchMax);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="4240" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-26" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this.commitLog.&lt;b&gt;retryDeleteFirstFile&lt;/b&gt;(destroyMappedFileIntervalForcibly)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;删除&amp;nbsp;mappedFiles 中第一个 MappedFile 文件&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="4320" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-30" target="iDnAsxgB4rMRH4iJf6o4-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-34" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iDnAsxgB4rMRH4iJf6o4-33" vertex="1" connectable="0">
          <mxGeometry x="0.8974" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-30" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public int deleteExpiredFileByTime(final long expiredTime,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final int deleteFilesInterval,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final long intervalForcibly,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final boolean cleanImmediately,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final int deleteFileBatchMax) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Object[] mfs = this.copyMappedFiles(0);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null == mfs)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return 0;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int mfsLength = mfs.length - 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int deleteCount = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;MappedFile&amp;gt; files = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int skipFileNum = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null != mfs) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //do check before deleting&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkSelf();&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i = 0; i &amp;lt; mfsLength; i++) {&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MappedFile mappedFile = (MappedFile) mfs[i];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long &lt;b&gt;liveMaxTimestamp&lt;/b&gt; = mappedFile.&lt;b&gt;getLastModifiedTimestamp&lt;/b&gt;() + expiredTime;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;// 即超过过期时间内没有修改，或者配置开启强制立即删除&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (System.currentTimeMillis() &amp;gt;= liveMaxTimestamp || cleanImmediately) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (skipFileNum &amp;gt; 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(&quot;Delete CommitLog {} but skip {} files&quot;, mappedFile.getFileName(), skipFileNum);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font style=&quot;background-color: initial; border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 关闭文件映射，删除磁盘文件&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (mappedFile.&lt;b&gt;destroy&lt;/b&gt;(intervalForcibly)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; files.add(mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deleteCount++;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (files.size() &amp;gt;= deleteFileBatchMax) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (deleteFilesInterval &amp;gt; 0 &amp;amp;&amp;amp; (i + 1) &amp;lt; mfsLength) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.sleep(deleteFilesInterval);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; skipFileNum++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //avoid deleting files in the middle&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;}&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //2 删除内存中 MappedFile 对象&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;deleteExpiredFile&lt;/b&gt;(files);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return deleteCount;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1240" y="4240" width="440" height="600" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-32" value="&lt;div style=&quot;&quot;&gt;this.shutdown(intervalForcibly);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (this.isCleanupOver()) {&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 删除文件前最后的检查，检查&lt;b&gt;是否还存在引用&lt;/b&gt;，都哪里保持着引用？对文件还进行读写的地方&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;/font&gt; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;fileChannel&lt;/b&gt;.&lt;b&gt;close&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean result = this.&lt;b&gt;file&lt;/b&gt;.&lt;b&gt;delete&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return false;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1720" y="4240" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-35" target="iDnAsxgB4rMRH4iJf6o4-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-35" value="&lt;div style=&quot;&quot;&gt;this.deleteExpiredFiles();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;删除 ConsumeQueue 和 IndexFile&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="4880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="iDnAsxgB4rMRH4iJf6o4-37" target="bjXPKm66hn7i3fsxoG0S-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-4" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="bjXPKm66hn7i3fsxoG0S-3" vertex="1" connectable="0">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-5" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="bjXPKm66hn7i3fsxoG0S-3" vertex="1" connectable="0">
          <mxGeometry x="0.8125" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iDnAsxgB4rMRH4iJf6o4-37" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 删除 CommitLog 之后对应的 ConsumeQueue IndexFile 中的过期数据也要删除&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long &lt;b&gt;minOffset&lt;/b&gt; = DefaultMessageStore.this.commitLog.&lt;b&gt;getMinOffset&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;if (minOffset &amp;gt; this.lastPhysicalMinOffset) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.lastPhysicalMinOffset = minOffset;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ConcurrentMap&amp;lt;String, ConcurrentMap&amp;lt;Integer, ConsumeQueueInterface&amp;gt;&amp;gt; tables = DefaultMessageStore.this.&lt;b&gt;getConsumeQueueTable&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;for&lt;/b&gt; (ConcurrentMap&amp;lt;Integer, ConsumeQueueInterface&amp;gt; maps : tables.values()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;for&lt;/b&gt; (ConsumeQueueInterface logic : maps.values()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //1 删除 ConsumeQueue 中过期数据&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int deleteCount = DefaultMessageStore.this.&lt;b&gt;consumeQueueStore&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;deleteExpiredFile&lt;/b&gt;(logic, minOffset);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (deleteCount &amp;gt; 0 &amp;amp;&amp;amp; deleteLogicsFilesInterval &amp;gt; 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.sleep(deleteLogicsFilesInterval);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (InterruptedException ignored) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 删除 Index File 中过期数据，和 ConsumeQueue 类似&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;indexService&lt;/b&gt;.&lt;b&gt;deleteExpiredFile&lt;/b&gt;(minOffset);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="760" y="4880" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-2" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;public int &lt;b&gt;deleteExpiredFileByOffset&lt;/b&gt;(long offset, int unitSize) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Object[] mfs = this.copyMappedFiles(0);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;MappedFile&amp;gt; files = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int deleteCount = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null != mfs) {&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int mfsLength = mfs.length - 1;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i = 0; i &amp;lt; mfsLength; i++) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean destroy;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MappedFile mappedFile = (MappedFile) mfs[i];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SelectMappedBufferResult result = mappedFile.selectMappedBuffer(this.mappedFileSize - unitSize);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (result != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long maxOffsetInLogicQueue = result.getByteBuffer().getLong();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result.release();&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 也是按文件删除的，文件中如果还有未过期数据是不会删除的&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; destroy = maxOffsetInLogicQueue &amp;lt; offset;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (destroy) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(&quot;physic min offset &quot; + offset + &quot;, logics in current mappedFile max offset &quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + maxOffsetInLogicQueue + &quot;, delete it&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else if (!mappedFile.isAvailable()) { // Handle hanged file.&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;Found a hanged consume queue file, attempting to delete it.&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; destroy = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;this being not executed forever.&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (destroy &amp;amp;&amp;amp; mappedFile.destroy(1000 * 60)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; files.add(mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; deleteCount++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;deleteExpiredFile&lt;/b&gt;(files);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return deleteCount;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1240" y="4880" width="440" height="540" as="geometry" />
        </mxCell>
        <mxCell id="bjXPKm66hn7i3fsxoG0S-6" value="MappedFileQueue" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1400" y="4858" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="xjM-dMiFs_clIyLdk_vj-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="xjM-dMiFs_clIyLdk_vj-1" target="KbcU_BMoqbZB4i3XPj1c-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xjM-dMiFs_clIyLdk_vj-1" value="ConsumeQueueInterface cq = this.&lt;b style=&quot;font-size: 10px;&quot;&gt;findOrCreateConsumeQueue&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;dispatchRequest.getTopic(), dispatchRequest.getQueueId());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;查找或创建 topic queueId 对应的消息队列&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2920.5" y="200" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
