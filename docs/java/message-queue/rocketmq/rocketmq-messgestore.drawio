<mxfile host="Electron" modified="2024-06-07T12:55:17.774Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="FHZLLFHA1bV-QfMvN_jH" version="21.6.5" type="device">
  <diagram name="第 1 页" id="spDp2wQ0uD9LirAVXnKY">
    <mxGraphModel dx="3543" dy="651" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="49yA2R5-UXcHH-bBDfTF-1" value="&lt;b&gt;RocketMQ MessageStore（消息存储服务）&lt;/b&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;读消息存储服务的源码前先浏览下《RocketMQ技术内幕》C4 可以帮助理解源码，这部分很值得仔细研究下，可以帮助理解分布式数据存储服务（比如数据库）的设计;&lt;br&gt;这部分源码实现位于 store 模块（3W多行代码，不包括测试）&lt;br&gt;RocketMQ 消息存储文件主要包括 CommitLog 文件、ConsumeQueue 文件（用于消费时通过主体查找消息）、Index 文件（用于通过属性查找消息）；&lt;br&gt;消息提交后会存入 CommitLog 文件，然后有线程会异步将CommitLog中的新消息&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="20" width="800" height="90" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-2" target="49yA2R5-UXcHH-bBDfTF-7">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="230" y="250" />
              <mxPoint x="230" y="250" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-2" value="消息存储服务初始化" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageStore (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消息存储服务接口，包含很多方法，这里主要关注读写&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default CompletableFuture&amp;lt;PutMessageResult&amp;gt; asyncPutMessage(final MessageExtBrokerInner msg)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default CompletableFuture&amp;lt;PutMessageResult&amp;gt; asyncPutMessages(final MessageExtBatch messageExtBatch)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;PutMessageResult putMessage(final MessageExtBrokerInner msg);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;PutMessageResult putMessages(final MessageExtBatch messageExtBatch);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GetMessageResult getMessage(final String group, final String topic, final int queueId,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; final long offset, final int maxMsgNums, final MessageFilter messageFilter);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GetMessageResult getMessage(final String group, final String topic, final int queueId,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; final long offset, final int maxMsgNums, final int maxTotalMsgSize, &lt;br&gt;&amp;nbsp; &amp;nbsp; final MessageFilter messageFilter);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;CompletableFuture&amp;lt;GetMessageResult&amp;gt; getMessageAsync(final String group, final String topic,&amp;nbsp; &amp;nbsp; &amp;nbsp;final int queueId,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;final long offset, final int maxMsgNums, final int maxTotalMsgSize, &lt;br&gt;&amp;nbsp; &amp;nbsp;final MessageFilter messageFilter);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TimerMessageStore getTimerMessageStore();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;...&lt;/b&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-520" y="120" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-6" target="49yA2R5-UXcHH-bBDfTF-3">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-280" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-42" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-6" target="49yA2R5-UXcHH-bBDfTF-39">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMessageStore&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RocketMQ自己实现的一种存储服务，&lt;/b&gt;另外还借助 RocksDB 实现了 RocksDBMessageStore，另外在另一个模块还提供了分层实现（暂略）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final PerfCounter.Ticks perfs = new PerfCounter.Ticks(LOGGER);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageStoreConfig &lt;b&gt;messageStoreConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储消息的数据结构&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;CommitLog&lt;/b&gt; &lt;b&gt;commitLog&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;ConsumeQueueStoreInterface&lt;/b&gt; &lt;b&gt;consumeQueueStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ConsumeQueue 文件刷盘线程，继承 ServiceThread&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;FlushConsumeQueueService&lt;/b&gt; &lt;b&gt;flushConsumeQueueService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final CleanCommitLogService &lt;b&gt;cleanCommitLogService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CleanConsumeQueueService &lt;b&gt;cleanConsumeQueueService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CorrectLogicOffsetService correctLogicOffsetService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;IndexService&lt;/b&gt; &lt;b&gt;indexService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MappedFile 分配服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;AllocateMappedFileService&lt;/b&gt; &lt;b&gt;allocateMappedFileService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog 消息分发&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;ReputMessageService&lt;/b&gt; &lt;b&gt;reputMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息存储高可用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;HAService&lt;/b&gt; &lt;b&gt;haService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// CompactionLog&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompactionStore compactionStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompactionService compactionService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final StoreStatsService storeStatsService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//消息堆内存缓存&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;TransientStorePool&lt;/b&gt; &lt;b&gt;transientStorePool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final RunningFlags runningFlags = new RunningFlags();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final SystemClock systemClock = new SystemClock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService scheduledExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BrokerStatsManager brokerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息拉取长轮询模式下的消息到达监听器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MessageArrivingListener&lt;/b&gt; &lt;b&gt;messageArrivingListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//broker配置属性&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;BrokerConfig&lt;/b&gt; &lt;b&gt;brokerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean shutdown = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean notifyMessageArriveInBatch = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件刷盘检测点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;StoreCheckpoint&lt;/b&gt; &lt;b&gt;storeCheckpoint&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TimerMessageStore timerMessageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog文件转发&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final LinkedList&amp;lt;&lt;b&gt;CommitLogDispatcher&lt;/b&gt;&amp;gt; &lt;b&gt;dispatcherList&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RandomAccessFile lockFile;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private FileLock lock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean shutDownNormal = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final static int MAX_PULL_MSG_SIZE = 128 * 1024 * 1024;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile int aliveReplicasNum = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Refer the MessageStore of MasterBroker in the same process.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// If current broker is master, this reference point to null or itself.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// If current broker is slave, this reference point to the store of master broker, and the two stores belong to&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// different broker groups.&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MessageStore masterStoreInProcess = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long masterFlushedOffset = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long brokerInitMaxOffset = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;PutMessageHook&amp;gt; putMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private SendMessageBackHook sendMessageBackHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentSkipListMap&amp;lt;Integer /* level */, Long/* delay timeMillis */&amp;gt; delayLevelTable &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;=&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentSkipListMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int maxDelayLevel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger mappedPageHoldCount = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentLinkedQueue&amp;lt;BatchDispatchRequest&amp;gt; batchDispatchRequestQueue = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int dispatchRequestOrderlyQueueSize = 16;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DispatchRequestOrderlyQueue dispatchRequestOrderlyQueue = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DispatchRequestOrderlyQueue(dispatchRequestOrderlyQueueSize);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long stateMachineVersion = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private ConcurrentMap&amp;lt;String, TopicConfig&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;topicConfigTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledCleanQueueExecutorService&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ThreadUtils.newSingleThreadScheduledExecutor(new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ThreadFactoryImpl(&quot;StoreCleanQueueScheduledThread&quot;));&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-520" y="440" width="480" height="1040" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-7" target="49yA2R5-UXcHH-bBDfTF-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-7" value="BrokerController#&lt;br&gt;&lt;b&gt;initializeMessageStore()&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-12" target="49yA2R5-UXcHH-bBDfTF-75">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-12" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认的消息存储核心实现&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;defaultMessageStore&lt;/b&gt; = new &lt;b style=&quot;font-size: 9px;&quot;&gt;DefaultMessageStore&lt;/b&gt;(this.messageStoreConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.brokerStatsManager, this.messageArrivingListener, this.brokerConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; topicConfigManager.getTopicConfigTable());&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.brokerStats = new BrokerStats(defaultMessageStore);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageStorePluginContext context = new MessageStorePluginContext(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig, configuration);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果有&lt;b&gt;插件&lt;/b&gt;就使用装饰器模式封装 &lt;b&gt;defaultMessageStore&lt;/b&gt;，没有插件就直接返回 defaultMessageStore&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;messageStore&lt;/b&gt; = MessageStoreFactory.&lt;b&gt;build&lt;/b&gt;(context, &lt;b&gt;defaultMessageStore&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.messageStore.getDispatcherList().addFirst(new &lt;b&gt;CommitLogDispatcherCalcBitMap&lt;/b&gt;(this.brokerConfig, &lt;br&gt;&amp;nbsp; &amp;nbsp; this.consumerFilterManager));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageStoreConfig.isTimerWheelEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerCheckpoint = new TimerCheckpoint(BrokerPathConfigHelper.getTimerCheckPath(&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; TimerMetrics timerMetrics = new TimerMetrics(BrokerPathConfigHelper.getTimerMetricsPath(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //延迟消息存储&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore = new &lt;b&gt;TimerMessageStore&lt;/b&gt;(messageStore, messageStoreConfig, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;timerCheckpoint, timerMetrics, brokerStatsManager);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore.registerEscapeBridgeHook(msg -&amp;gt; escapeBridge.putMessage(msg));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.messageStore.setTimerMessageStore(this.timerMessageStore);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="520" y="120" width="440" height="260" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-75" target="49yA2R5-UXcHH-bBDfTF-20">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1210" y="150" />
              <mxPoint x="1210" y="150" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-25">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-77">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-81" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-82" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-79">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-84" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-18" target="49yA2R5-UXcHH-bBDfTF-83">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-18" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;这里主要关注线程和线程池任务&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-20" target="49yA2R5-UXcHH-bBDfTF-21">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-20" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;scheduledCleanQueueExecutorService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建包含1个核心线程的计划任务线程池，线程名前缀 StoreCleanQueueScheduledThread&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-21" value="DefaultMessageStore.this&lt;br&gt;.cleanQueueFilesPeriodically()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-23" target="49yA2R5-UXcHH-bBDfTF-24">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-23" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;AllocateMappedFileService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建一个非守护线程，线程名&lt;/div&gt;&lt;div&gt;AllocateMappedFileService&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-24" value="AllocateMappedFileService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-25" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;IndexService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;每次创建Index文件都会创建一个守护线程，线程名FlushIndexFileThread，用于刷盘&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-26" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ReputMessageService&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;ReputMessageService&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-27" value="&lt;div style=&quot;&quot;&gt;FlushConsumeQueueService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;FlushConsumeQueueService&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于ConsumeQueue刷盘&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-29" target="49yA2R5-UXcHH-bBDfTF-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-29" value="消息写入" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-31" target="49yA2R5-UXcHH-bBDfTF-32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-31" value="DefaultMessageStore#&lt;br&gt;&lt;b&gt;asyncPutMessage&lt;/b&gt;(&lt;br&gt;MessageExtBrokerInner msg)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;异步写入&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-32" target="49yA2R5-UXcHH-bBDfTF-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-32" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//一些&lt;b&gt;钩子&lt;/b&gt;做一些检查、对批量、延迟消息做特殊处理，todo后面再看&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (PutMessageHook putMessageHook : putMessageHookList) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageResult handleResult = putMessageHook.&lt;b&gt;executeBeforePutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (handleResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(handleResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;long beginTime = this.getSystemClock().now();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 将消息异步写入 CommitLog 文件&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageResult&amp;gt; putResultFuture = this.&lt;b&gt;commitLog&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;asyncPutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;putResultFuture.thenAccept(result -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long elapsedTime = this.getSystemClock().now() - beginTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;storeStatsService&lt;/b&gt;.&lt;b&gt;setPutMessageEntireTimeMax&lt;/b&gt;(elapsedTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null == result || !result.isOk()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.storeStatsService.getPutMessageFailedTimes().&lt;b&gt;add&lt;/b&gt;(1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;return putResultFuture;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" vertex="1" parent="1">
          <mxGeometry x="520" y="1160" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-34" value="消息消费" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-50" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.401;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-49">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1740" y="1882" />
              <mxPoint x="1740" y="1760" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-52" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="49yA2R5-UXcHH-bBDfTF-50">
          <mxGeometry x="0.9696" relative="1" as="geometry">
            <mxPoint x="-7" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.001;exitY=0.55;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-55" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="49yA2R5-UXcHH-bBDfTF-54">
          <mxGeometry x="0.9654" y="2" relative="1" as="geometry">
            <mxPoint x="-6" y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-62" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" target="49yA2R5-UXcHH-bBDfTF-61">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1720" y="2950" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="1720" y="2951" />
              <mxPoint x="1740" y="2951" />
              <mxPoint x="1740" y="2840" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-68" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="49yA2R5-UXcHH-bBDfTF-62">
          <mxGeometry x="0.8121" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.611;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-35" target="49yA2R5-UXcHH-bBDfTF-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-67" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="49yA2R5-UXcHH-bBDfTF-66">
          <mxGeometry x="0.0733" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-35" value="&lt;div&gt;...&lt;/div&gt;&lt;div&gt;AppendMessageResult result = null;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//根据配置和消息长度设置消息版本类型，V1、V2（支持更大的消息长度）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setVersion(MessageVersion.MESSAGE_VERSION_V2);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//判断并设置消息出生节点地址IPv6标志（如果是IPv6地址的话）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setBornHostV6Flag();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//判断并设置消息存储节点地址IPv6标志（如果是IPv6地址的话）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;msg.setStoreHostAddressV6Flag();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//从线程本地获取PutMessageThreadLocal实例，没有就new新建&lt;/font&gt;&lt;/div&gt;&lt;div&gt;PutMessageThreadLocal putMessageThreadLocal = this.putMessageThreadLocal.get();&lt;/div&gt;&lt;div&gt;updateMaxMessageSize(putMessageThreadLocal);&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//更新内部的MessageExtEncoder的缓冲容量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//主要是用于锁住主题队列，就是 &quot;&amp;lt;TopicName&amp;gt;-&amp;lt;queueId&amp;gt;&quot;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;String &lt;b&gt;topicQueueKey&lt;/b&gt; = &lt;b&gt;generateKey&lt;/b&gt;(putMessageThreadLocal.getKeyBuilder(), msg);&lt;/div&gt;&lt;div&gt;long elapsedTimeInLock = 0; &lt;font color=&quot;#007fff&quot;&gt;//检测耗时，耗时太长（500ms）会打印警告日志&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MappedFile unlockMappedFile = null;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取 MappedFiledQueue 中最后一个 MappedFile，因为消息是顺序写入MappedFile，一个文件写满会再新建一个文件&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//获取当前文件写偏移在所有历史消息中的偏移&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long currOffset;&lt;/div&gt;&lt;div&gt;if (mappedFile == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; currOffset = 0;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;currOffset = mappedFile.getFileFromOffset() + mappedFile.getWrotePosition();&lt;/b&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//需要确认副本同步写成功的次数，消息存储可能配置副本（Master节点的存储也属于副本之一），测试中没有配置副本，所以这里是1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int needAckNums = this.defaultMessageStore.getMessageStoreConfig().getInSyncReplicas();&lt;/div&gt;&lt;div&gt;boolean needHandleHA = needHandleHA(msg);&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp;//是否需要配置高可用，todo 后面看高可用实现原理再研究&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (needHandleHA &amp;amp;&amp;amp; this.defaultMessageStore.getBrokerConfig().isEnableControllerMode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.defaultMessageStore.getHaService().inSyncReplicasNums(currOffset) &amp;lt; this.defaultMessageStore.getMessageStoreConfig().getMinInSyncReplicas()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.IN_SYNC_REPLICAS_NOT_ENOUGH, null));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.defaultMessageStore.getMessageStoreConfig().isAllAckInSyncStateSet()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // -1 means all ack in SyncStateSet&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; needAckNums = MixAll.ALL_ACK_IN_SYNC_STATE_SET;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} else if (needHandleHA &amp;amp;&amp;amp; this.defaultMessageStore.getBrokerConfig().isEnableSlaveActingMaster()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int inSyncReplicas = Math.min(this.defaultMessageStore.getAliveReplicaNumInGroup(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMessageStore.getHaService().inSyncReplicasNums(currOffset));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; needAckNums = calcNeedAckNums(inSyncReplicas);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (needAckNums &amp;gt; inSyncReplicas) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Tell the producer, don&#39;t have enough slaves to handle the send request&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.IN_SYNC_REPLICAS_NOT_ENOUGH, null));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;topicQueueLock&lt;/b&gt;.lock(&lt;b&gt;topicQueueKey&lt;/b&gt;); &lt;font color=&quot;#007fff&quot;&gt;//锁住主题队列（topicQueueLock&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;内部是一组ReentrantLock）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; boolean needAssignOffset = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (defaultMessageStore.getMessageStoreConfig().isDuplicationEnable()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; defaultMessageStore.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; needAssignOffset = false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (needAssignOffset) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//1 对于可消费的消息，此方法内部会查找对应的&amp;nbsp;ConsumeQueueInterface 实例，并调用&amp;nbsp;assignQueueOffset&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; defaultMessageStore.&lt;b&gt;assignOffset&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //使用 MessageExtEncoder 将消息写到本地的byteBuf缓冲，&lt;/b&gt;内部使用 Netty unpooledByteBufAllocator 分配的 ByteBuf 作为缓冲，编码格式依次是：&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //消息总长(4Bytes&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;)+消息版本魔数(4)+消息体CRC校验码(4)+队列ID(4)+消息Flag(4)+队列偏移(8)+物理偏移(8)+SYSFLAG(4)+BORNTIMESTAMP(8)&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;+BORNHOST(不定长)+STORETIMESTAMP(8)+STOREHOSTADDRESS(不定长)+RECONSUMETIMES(4)+PreparedTransactionOffset(8)+BODY+TOPIC&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;+PROPERTIES+CRC32&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageResult encodeResult = putMessageThreadLocal.getEncoder().&lt;b&gt;encode&lt;/b&gt;(msg); &lt;font color=&quot;#007fff&quot;&gt;//这里编码异常encodeResult才不为空&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (encodeResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(encodeResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//将前面的byteBuf转成NIO ByteBuffer，传给 &lt;b&gt;MessageExtBrokerInner&lt;/b&gt;.&lt;b&gt;encodedBuff&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; msg.&lt;b&gt;setEncodedBuff&lt;/b&gt;(putMessageThreadLocal.getEncoder().getEncoderBuffer());&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageContext putMessageContext = new PutMessageContext(topicQueueKey);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //多个线程需要顺序写入同一个文件，所以需要加锁&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;putMessageLock&lt;/b&gt;.lock(); //spin or ReentrantLock ,depending on store config&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.beginTimeInLock = beginLockTimestamp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!defaultMessageStore.getMessageStoreConfig().isDuplicationEnable()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setStoreTimestamp(beginLockTimestamp);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile || mappedFile.isFull()) { &lt;font color=&quot;#007fff&quot;&gt;//文件不存在（首次存储消息）或文件已满&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;//2 新建MappedFile&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = this.mappedFileQueue.&lt;b&gt;getLastMappedFile&lt;/b&gt;(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isCloseReadAhead()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setFileReadMode(mappedFile, LibC.MADV_RANDOM);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile) {&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp;//文件还是空说明新建文件失败，失败结束&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //3 向MappedFile中追加消息数据，主要是将 MessageExtBrokerInner.encodedBuf 内容写到 MappedFile.byteBuffer 或 mappedByteBuf&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//即这里只是写MappedFile缓冲，真正写文件是在后面借助 FlushCommitLogService 实现&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = &lt;b&gt;mappedFile&lt;/b&gt;.&lt;b&gt;appendMessage&lt;/b&gt;(msg, this.&lt;b&gt;appendMessageCallback&lt;/b&gt;, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch (result.getStatus()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;PUT_OK&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//存储成功&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;END_OF_FILE&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; unlockMappedFile = mappedFile;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Create a new file, re-write the message&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = this.mappedFileQueue.getLastMappedFile(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mappedFile) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // XXX: warn and notify me&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;create mapped file2 error, topic: &quot; + msg.getTopic() + &quot; clientAddr: &quot; + msg.getBornHostString());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.CREATE_MAPPED_FILE_FAILED, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isCloseReadAhead()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setFileReadMode(mappedFile, LibC.MADV_RANDOM);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = mappedFile.appendMessage(msg, this.appendMessageCallback, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (AppendMessageStatus.PUT_OK.equals(result.getStatus())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onCommitLogAppend(msg, result, mappedFile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;MESSAGE_SIZE_EXCEEDED&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;PROPERTIES_SIZE_EXCEEDED&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;UNKNOWN_ERROR&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elapsedTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeInLock = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageLock.unlock();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //写成功后更新偏移量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (AppendMessageStatus.PUT_OK.equals(result.getStatus())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMessageStore.&lt;b&gt;increaseOffset&lt;/b&gt;(msg, getMessageNum(msg));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} catch (RocksDBException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result));&lt;/div&gt;&lt;div&gt;} finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; topicQueueLock.unlock(topicQueueKey);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;if (null != unlockMappedFile &amp;amp;&amp;amp; this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.defaultMessageStore.unlockMappedFile(unlockMappedFile);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// Statistics&lt;/font&gt;&lt;/div&gt;&lt;div&gt;storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).add(result.getMsgNum());&lt;/div&gt;&lt;div&gt;storeStatsService.getSinglePutMessageTopicSizeTotal(topic).add(result.getWroteBytes());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 数据落盘（有同步落盘和异步落盘，默认使用异步落盘），内部通过唤醒 FlushCommitLogService 实现刷盘&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return handleDiskFlushAndHA(putMessageResult, msg, needAckNums, needHandleHA);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1160" width="720" height="1800" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-40">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-97" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-39" target="49yA2R5-UXcHH-bBDfTF-96">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-39" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CommitLog&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储消息的数据结构&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储消息的MappedFile队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final MappedFileQueue &lt;b&gt;mappedFileQueue&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final DefaultMessageStore defaultMessageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog 刷盘服务管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushManager &lt;b&gt;flushManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ColdDataCheckService coldDataCheckService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AppendMessageCallback appendMessageCallback;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ThreadLocal&amp;lt;&lt;b&gt;PutMessageThreadLocal&lt;/b&gt;&amp;gt; &lt;b&gt;putMessageThreadLocal&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long confirmOffset = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile long beginTimeInLock = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final PutMessageLock putMessageLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final TopicQueueLock topicQueueLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile Set&amp;lt;String&amp;gt; fullStorePaths = Collections.emptySet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushDiskWatcher flushDiskWatcher;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected int commitLogSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean enabledAppendPropCRC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final MultiDispatch multiDispatch;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1040" y="440" width="480" height="320" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-40" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MappedFileQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;存储消息的MappedFile队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路径 &amp;lt;storePath&amp;gt;/commitlog ，&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;lt;storePath&amp;gt;可以通过 broker.conf 设置，默认是${ROCKET_HOME}下store文件夹&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;protected final String &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;storePath&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单个文件大小，默认1G bytes&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final int &lt;b&gt;mappedFileSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件存满后会新建一个文件存储消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final CopyOnWriteArrayList&amp;lt;&lt;b&gt;MappedFile&lt;/b&gt;&amp;gt; &lt;b&gt;mappedFiles&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于创建 MappedFile 实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final AllocateMappedFileService &lt;b&gt;allocateMappedFileService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//刷盘指针，之前的数据都已经刷到磁盘&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;flushedWhere&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//数据提交指针，是ByteBuffer 的写指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;committedWhere&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long storeTimestamp = 0;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1560" y="440" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-43" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PutMessageThreadLocal&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;因为这个类实例是存储在线程本地的所以&lt;b&gt;对每个线程来说都有专属的MessageExtEncoder实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息编码器，MessageExtBrokerInner存入CommitLog需要此编码器序列化&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageExtEncoder &lt;b&gt;encoder&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于为生成主题队列的KEY，源码中主要是用于锁&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final StringBuilder &lt;b&gt;keyBuilder&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1560" y="760" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-45" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MappedFile (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;存储消息的文件接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路径 &amp;lt;storePath&amp;gt;/commitlog&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-2080" y="120" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;dashed=1;endArrow=block;endFill=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-48" target="49yA2R5-UXcHH-bBDfTF-45">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1840" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-48" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMappedFile&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends AbstractMappedFile&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储消息的数据结构，包括写缓冲和文件对象&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int OS_PAGE_SIZE = 1024 * 4; &lt;font color=&quot;#007fff&quot;&gt;//操作系统每页大小，默认4KB&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final Unsafe UNSAFE = getUnsafe();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Method IS_LOADED_METHOD;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final int UNSAFE_PAGE_SIZE = UNSAFE == null ? OS_PAGE_SIZE : UNSAFE.pageSize();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicInteger TOTAL_MAPPED_FILES = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; WROTE_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; COMMITTED_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final AtomicIntegerFieldUpdater&amp;lt;DefaultMappedFile&amp;gt; FLUSHED_POSITION_UPDATER;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//相对于文件初始偏移的写偏移，即初始偏移+写偏移是消息在所有历史消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;wrotePosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ByteBuffer消息写指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;committedPosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//刷盘指针&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile int &lt;b&gt;flushedPosition&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前文件大小&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected int fileSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NIO磁盘文件通道&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected FileChannel fileChannel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//写缓冲，由消息中编码后的ByteBuf实例转换得到&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ByteBuffer &lt;b&gt;writeBuffer&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//堆外内存池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected TransientStorePool &lt;b&gt;transientStorePool&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件的名字（其实是文件全路径名），使用当前文件初始偏移命名，比如第一个文件&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;/home/arvin/mywork/github/rocketmq/data/store/commitlog/00000000000000000000&amp;nbsp;&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String &lt;b&gt;fileName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件初始偏移，即当前文件存储的第一条消息的在所有历史消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long &lt;b&gt;fileFromOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//物理文件对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected File &lt;b&gt;file&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//物理文件对应的内存映射&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MappedByteBuffer &lt;b&gt;mappedByteBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//文件最后一次写数据的时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long &lt;b&gt;storeTimestamp&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是MappedFileQueue中第一个文件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean firstCreateInQueue = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long lastFlushTime = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MappedByteBuffer mappedByteBufferWaitToClean = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long swapMapTime = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected long mappedByteBufferAccessCountSinceLastSwap = 0L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;span style=&quot;background-color: initial;&quot;&gt;If this mapped file belongs to consume queue, this field stores store-timestamp of first message referenced&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;by this logical queue.&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long startTimestamp = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;span style=&quot;background-color: initial;&quot;&gt;If this mapped file belongs to consume queue, this field stores store-timestamp of last message referenced&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;by this logical queue.&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long stopTimestamp = -1;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-2080" y="440" width="480" height="760" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-49" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;ConsumeQueueInterface &lt;b&gt;consumeQueue&lt;/b&gt; = &lt;b&gt;findOrCreateConsumeQueue&lt;/b&gt;(msg.getTopic(),&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; msg.getQueueId());&lt;br&gt;&lt;/div&gt;&lt;div&gt;consumeQueue.&lt;b&gt;assignQueueOffset&lt;/b&gt;(this.queueOffsetOperator, msg);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1760" y="1720" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-51" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeQueueStoreInterface&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息存储数据结构&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1040" y="800" width="480" height="320" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-53" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;MappedFile mappedFile = null;&lt;/div&gt;&lt;div&gt;if (this.allocateMappedFileService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; mappedFile = this.&lt;b&gt;allocateMappedFileService&lt;/b&gt;.&lt;b&gt;putRequestAndReturnMappedFile&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;nextFilePath,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;nextNextFilePath, this.mappedFileSize);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappedFile = new &lt;b&gt;DefaultMappedFile&lt;/b&gt;(nextFilePath, this.mappedFileSize);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (IOException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;create mappedFile exception&quot;, e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (mappedFile != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (this.mappedFiles.isEmpty()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;mappedFile&lt;/b&gt;.&lt;b&gt;setFirstCreateInQueue&lt;/b&gt;(true);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;mappedFiles&lt;/b&gt;.add(mappedFile);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return mappedFile;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1760" y="1840" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-57" value="MappedFileQueue" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1925" y="1810" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-58" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;int currentPos = WROTE_POSITION_UPDATER.get(this); &lt;/span&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;//读取写偏移量 writePosition&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if (currentPos &amp;lt; this.fileSize) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;//优先使用writeBuffer，没有就使用 mappedByteBuffer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ByteBuffer byteBuffer = &lt;b&gt;appendMessageBuffer&lt;/b&gt;().slice();&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; byteBuffer.position(currentPos);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AppendMessageResult result;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (messageExt instanceof MessageExtBatch &amp;amp;&amp;amp; &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;!((MessageExtBatch) messageExt).isInnerBatch()) { &lt;font color=&quot;#007fff&quot;&gt;//批量消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = cb.&lt;b&gt;doAppend&lt;/b&gt;(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (MessageExtBatch) messageExt, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else if (messageExt instanceof MessageExtBrokerInner) { &lt;font color=&quot;#007fff&quot;&gt;//单条消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//内部就是将 MessageExtBrokerInner.encodedBuff 内容写到 MappedFile.byteBuffer 或 &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;mappedByteBuf&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = cb.&lt;b&gt;doAppend&lt;/b&gt;(this.getFileFromOffset(), &lt;b&gt;byteBuffer&lt;/b&gt;, this.fileSize - currentPos,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (MessageExtBrokerInner) messageExt, putMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WROTE_POSITION_UPDATER.&lt;b&gt;addAndGet&lt;/b&gt;(this, result.getWroteBytes());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.storeTimestamp = result.getStoreTimestamp();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return result;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1760" y="2120" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-61" target="49yA2R5-UXcHH-bBDfTF-63">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-61" value="&lt;div&gt;//&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageStatus&amp;gt; flushResultFuture = &lt;b&gt;handleDiskFlush&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; putMessageResult.getAppendMessageResult(), messageExt);&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageStatus&amp;gt; replicaResultFuture;&lt;/div&gt;&lt;div&gt;if (!needHandleHA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; replicaResultFuture = CompletableFuture.completedFuture(PutMessageStatus.PUT_OK);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; replicaResultFuture = handleHA(putMessageResult.getAppendMessageResult(), &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;putMessageResult, needAckNums);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return flushResultFuture.thenCombine(replicaResultFuture, (flushStatus, replicaStatus) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (flushStatus != PutMessageStatus.PUT_OK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult.setPutMessageStatus(flushStatus);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (replicaStatus != PutMessageStatus.PUT_OK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult.setPutMessageStatus(replicaStatus);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return putMessageResult;&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1760" y="2720" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-63" target="49yA2R5-UXcHH-bBDfTF-102">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2700" y="2840" />
              <mxPoint x="2700" y="800" />
              <mxPoint x="1940" y="800" />
              <mxPoint x="1940" y="550" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-63" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//同步刷盘&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (FlushDiskType.SYNC_FLUSH == CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步刷盘&lt;/font&gt;&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!CommitLog.this.defaultMessageStore.isTransientStorePoolEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//借助 CountDownLatch2 实现的等待唤醒，测试中这里实际是 CommitLog$FlushRealTimeService，&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;如果存储配置中 flushCommitLogTimed == true 这个方法相当于什么都名没做&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;flushCommitLogService&lt;/b&gt;.&lt;b&gt;wakeup&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; commitRealTimeService.wakeup();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(PutMessageStatus.PUT_OK);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2240" y="2740" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-65" value="CommitLog$DefaultFlushManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2370" y="2710" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-69" target="49yA2R5-UXcHH-bBDfTF-70">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-69" value="消息存储服务启动" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-73" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-70" target="49yA2R5-UXcHH-bBDfTF-72">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-70" value="&lt;div&gt;BrokerController#&lt;/div&gt;&lt;div&gt;&lt;b&gt;startBasicService&lt;/b&gt;()()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-72" target="49yA2R5-UXcHH-bBDfTF-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-72" value="this.&lt;b&gt;messageStore&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-75" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;这里主要关注线程和线程池任务&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-77" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;StoreStatsService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建一个非守护线程，线程名&lt;/div&gt;&lt;div&gt;StoreStatsService&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-78" value="&lt;div style=&quot;&quot;&gt;PerfCounter.Ticks&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-86">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-94" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-88">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-79" target="49yA2R5-UXcHH-bBDfTF-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-79" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;scheduledExecutorService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;div&gt;创建包含1个核心线程的计划任务线程池，线程名前缀 StoreScheduledThread&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1241" y="760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-83" target="49yA2R5-UXcHH-bBDfTF-98">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-83" value="&lt;div style=&quot;&quot;&gt;FlushCommitLogService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;可能使用的有3种实现，这里只看FlushRealTimeService&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1241" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-85" value="&lt;div style=&quot;&quot;&gt;FlushDiskWatcher&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1241" y="600" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-86" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this&lt;br&gt;.cleanFilesPeriodically();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-88" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this.checkSelf();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-92" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore.this&lt;br&gt;.storeCheckpoint.flush();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-96" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;CommitLog$&lt;b&gt;DefaultFlushManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;CommitLog刷盘服务管理器, 提供了4种实现&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果是同步刷盘则创建 CommitLog$&lt;b&gt;GroupCommitService&lt;/b&gt;,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;异步刷盘则创建&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;CommitLog$&lt;/span&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;FlushRealTimeService&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final FlushCommitLogService &lt;b&gt;flushCommitLogService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog$&lt;b&gt;CommitRealTimeService&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final FlushCommitLogService &lt;b&gt;commitRealTimeService&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1560" y="1200" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-98" target="49yA2R5-UXcHH-bBDfTF-100">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-98" value="&lt;div style=&quot;&quot;&gt;CommitLog$FlushRealTimeService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名FlushRealTimeService&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1481" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-100" target="49yA2R5-UXcHH-bBDfTF-102">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-100" value="&lt;div style=&quot;&quot;&gt;FlushRealTimeService#run()&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部轮询执行刷盘方法&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1720" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-105" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-102" target="49yA2R5-UXcHH-bBDfTF-104">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-102" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;while&lt;/b&gt; (!this.isStopped()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //flushCommitLogTimed： true（默认）表示每隔一段事件执行一次Flush，false 表示可以通过唤醒或超时触发一次Flush&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean &lt;b&gt;flushCommitLogTimed&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.isFlushCommitLogTimed();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //刷盘间隔（ms），如果可以通过唤醒执行刷盘interval就是超时唤醒时间&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;interval&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //每次刷盘数据阈值，默认至少积累4页才真正执行刷盘&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;flushPhysicQueueLeastPages&lt;/b&gt; = CommitLog.this.defaultMessageStore.getMessageStoreConfig()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getFlushCommitLogLeastPages();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这个表示每过一段时间即使数据未积累到4页也执行刷盘（默认10s）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;flushPhysicQueueThoroughInterval&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;CommitLog.this.defaultMessageStore&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getMessageStoreConfig()&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.getFlushCommitLogThoroughInterval();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; long currentTimeMillis = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (currentTimeMillis &amp;gt;= (this.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.lastFlushTimestamp = currentTimeMillis;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;flushPhysicQueueLeastPages&lt;/b&gt; = 0; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//改为0，即不限制数据量大小了，只要有待刷的数据就刷盘&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printFlushProgress = (printTimes++ % 10) == 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (flushCommitLogTimed) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.sleep(interval);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.waitForRunning(interval);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long begin = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //执行刷盘方法，里面到底有没有真的刷盘还有一些判断&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.mappedFileQueue.&lt;b&gt;flush&lt;/b&gt;(flushPhysicQueueLeastPages);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (storeTimestamp &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.defaultMessageStore.getStoreCheckpoint()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;setPhysicMsgTimestamp&lt;/b&gt;(storeTimestamp);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long past = System.currentTimeMillis() - begin;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommitLog.this.getMessageStore().getPerfCounter().&lt;b&gt;flowOnce&lt;/b&gt;(&quot;FLUSH_DATA_TIME_MS&quot;, (int) past);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;" vertex="1" parent="1">
          <mxGeometry x="1960" y="315" width="440" height="470" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="49yA2R5-UXcHH-bBDfTF-104" target="49yA2R5-UXcHH-bBDfTF-106">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-109" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="49yA2R5-UXcHH-bBDfTF-107">
          <mxGeometry x="-0.0136" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-104" value="&lt;div style=&quot;&quot;&gt;int offset = mappedFile&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.&lt;b&gt;flush&lt;/b&gt;(flushLeastPages);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里会检查积累的数据是否达到 flushLeastPages&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2440" y="520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="49yA2R5-UXcHH-bBDfTF-106" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (writeBuffer != null &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;|| this.fileChannel.position() != 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;fileChannel&lt;/b&gt;.force(false);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;mappedByteBuffer&lt;/b&gt;.force();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2680" y="510" width="199" height="80" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
