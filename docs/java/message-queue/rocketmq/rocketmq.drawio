<mxfile host="Electron" modified="2024-05-28T12:46:54.214Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="2v8r4eXyrYsOV9ig76cK" version="21.6.5" type="device" pages="4">
  <diagram name="Producer" id="6497DEjvEHfmiQGX_mvA">
    <mxGraphModel dx="3728" dy="764" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="jejXhYi2k6KOZK20mIr--1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;RocketMQ工作原理（5.2.0）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;测试代码：官方源码 example 模块，源码启动 NameServer、Broker参考MD文档；&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;这里流程图包含四部分：Producer、NameServer、Broker、Consumer；&lt;br&gt;这页展示&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;生产者(Producer)&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;发送消息的逻辑（包括同步监听确认消息）；其他部分在其他页面中展示；&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Producer 包括多种消息发送方式。&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;RocketMQ代码量也很大（30W），这里会忽略一些细节。&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="660" height="130" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--3" target="jejXhYi2k6KOZK20mIr--12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--3" value="生产者发送消息&lt;br&gt;同步发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--4" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;异步发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--5" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;批量发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;定时发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--7" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;顺序发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--8" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送单向消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--9" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送广播消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--12" target="jejXhYi2k6KOZK20mIr--17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--12" target="jejXhYi2k6KOZK20mIr--27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--12" value="DefaultMQProducer producer = new &lt;b&gt;DefaultMQProducer&lt;/b&gt;(&lt;font style=&quot;font-size: 9px;&quot;&gt;PRODUCER_GROUP&lt;/font&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--19">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.004;exitY=0.067;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="c61HgKpTzqy5PhA1b_MH-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducer&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;就死封装了一些额外配置信息的 DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个才是消息生产者的核心&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;protected final transient DefaultMQProducerImpl &lt;b&gt;defaultMQProducerImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private final Set&amp;lt;Integer&amp;gt; retryResponseCodes = new CopyOnWriteArraySet&amp;lt;&amp;gt;(Arrays.asList(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.TOPIC_NOT_EXIST,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SERVICE_NOT_AVAILABLE,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SYSTEM_ERROR,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_PERMISSION,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_BUYER_ID,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NOT_IN_CURRENT_UNIT&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 生产者组概念上聚合了完全相同角色的所有生产者实例，特别是在涉及事务消息时尤为重要。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 对于非事务性消息，只要每个进程是唯一的就可以。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 有关更多讨论，请参见 https://rocketmq.apache.org/docs/introduction/02concepts。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b&gt;producerGroup&lt;/b&gt;; // 生产者组&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 需要为事务生产者初始化的主题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private List&amp;lt;String&amp;gt; &lt;b&gt;topics&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 仅用于测试或演示程序&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认主题创建的队列数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private volatile int defaultTopicQueueNums = 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 发送消息的超时时间。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int sendMsgTimeout = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 压缩消息体阈值，即，默认情况下，大于4k的消息体将被压缩。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int compressMsgBodyOverHowmuch = 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在同步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendAsyncFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在发送失败时内部是否重试另一个代理。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean retryAnotherBrokerWhenNotStoreOK = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 允许的最大消息体大小（以字节为单位）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int maxMessageSize = 1024 * 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 异步传输数据的接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private TraceDispatcher traceDispatcher = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量消息的开关标志实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean autoBatch = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量处理消息的实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private ProduceAccumulator &lt;b&gt;produceAccumulator&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 指示当异步发送流量过大时是否阻塞消息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean enableBackpressureForAsyncMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大数量。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 10000。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendNum = 10000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大消息大小。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 100M。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendSize = 100 * 1024 * 1024;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-560" y="840" width="520" height="680" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--17" target="jejXhYi2k6KOZK20mIr--21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--17" value="defaultMQProducerImpl = new &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;(this, null);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--19" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY = &quot;com.rocketmq.sendMessageWithVIPChannel&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SOCKS_PROXY_CONFIG = &quot;com.rocketmq.socks.proxy.config&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_READ_BODY = &quot;com.rocketmq.read.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_DECOMPRESS_BODY = &quot;com.rocketmq.decompress.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_LATENCY_ENABLE = &quot;com.rocketmq.sendLatencyEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String START_DETECTOR_ENABLE = &quot;com.rocketmq.startDetectorEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HEART_BEAT_V2 = &quot;com.rocketmq.heartbeat.v2&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接的NameServer地址（IP+端口）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//生产者的客户端IP&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String clientIP = NetworkUtil.getLocalAddress();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端实例名，默认“DEFAULT”，“DEFAULT”&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面在启动时会被替换为 PID#当前纳秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;instanceName&lt;/b&gt; = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Deprecated&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespace;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean namespaceInitialized = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespaceV2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AccessChannel accessChannel = AccessChannel.LOCAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从命名服务拉取主题（topic）信息的间隔，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int pollNameServerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//与Broker的长连接的心跳周期，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int heartbeatBrokerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Offset persistent interval for consumer&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int persistConsumerOffsetInterval = 1000 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String unitName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeReadBody = Boolean.parseBoolean(System.getProperty(DECODE_READ_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeDecompressBody = Boolean.parseBoolean(System.getProperty(DECODE_DECOMPRESS_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean vipChannelEnabled = Boolean.parseBoolean(System.getProperty(SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useHeartbeatV2 = Boolean.parseBoolean(System.getProperty(HEART_BEAT_V2, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useTLS = TlsSystemConfig.tlsEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String socksProxyConfig = System.getProperty(SOCKS_PROXY_CONFIG, &quot;{}&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int mqClientApiTimeout = 3 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectTimeout = 200;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectInterval = 2 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LanguageCode language = LanguageCode.JAVA;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable stream request type will inject a RPCHook to add corresponding request type to remoting layer.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * And it will also generate a different client id to prevent unexpected reuses of MQClientInstance.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean enableStreamRequestType = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable the fault tolerance mechanism of the client sending process.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * DO NOT OPEN when ORDER messages are required.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Turning on will interfere with the queue selection functionality,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * possibly conflicting with the order message.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean sendLatencyEnable = Boolean.parseBoolean(System.getProperty(SEND_LATENCY_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean startDetectorEnable = Boolean.parseBoolean(System.getProperty(START_DETECTOR_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean enableHeartbeatChannelEventListener = true;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="40" width="520" height="760" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQProducer （I）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start() throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;List&amp;lt;MessageQueue&amp;gt; &lt;b&gt;fetchPublishMessageQueues&lt;/b&gt;(final String topic) throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//同步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;SendResult &lt;b&gt;send&lt;/b&gt;(...) throws MQClientException, RemotingException, MQBrokerException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;send&lt;/b&gt;(..., final SendCallback sendCallback) throws MQClientException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingException, InterruptedException, MQBrokerException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单向发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;sendOneway&lt;/b&gt;(final Message msg) throws MQClientException, RemotingException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务控制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TransactionSendResult &lt;b&gt;sendMessageInTransaction&lt;/b&gt;(final Message msg,&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Object arg) throws MQClientException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-560" y="40" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--21" value="produceAccumulator = &lt;b&gt;MQClientManager&lt;/b&gt;.getInstance()&lt;br&gt;.getOrCreateProduceAccumulator(this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--24" target="jejXhYi2k6KOZK20mIr--85">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--24" target="jejXhYi2k6KOZK20mIr--65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;核心类，DefaultMQProducerImpl 实现的是一个MQ客户端（MQClientInstance）上的某一分组的消息生产者&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 DefaultMQProducer 实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* topic */, TopicPublishInfo&amp;gt; topicPublishInfoTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;EndTransactionHook&amp;gt; endTransactionHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; asyncSenderThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService defaultAsyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected BlockingQueue&amp;lt;Runnable&amp;gt; checkRequestQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ExecutorService checkExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个实例是通过 MQClientManager 工厂创建的，同时也是当前DefautlMQProducerImpl 的容器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前 DefautlMQProducerImpl 只不过是 MQClientInstance 中的一个消息生产者（MQProducerInner&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;MQClientInstance&lt;/b&gt; &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ArrayList&amp;lt;CheckForbiddenHook&amp;gt; checkForbiddenHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQFaultStrategy mqFaultStrategy;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService asyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// compression related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int compressLevel = Integer.parseInt(System.getProperty(MixAll.MESSAGE_COMPRESS_LEVEL, &quot;5&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompressionType compressType = CompressionType.of(System.getProperty(MixAll.MESSAGE_COMPRESS_TYPE, &quot;ZLIB&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Compressor compressor = CompressorFactory.getCompressor(compressType);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// backpressure related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendNum;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendSize;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="1120" width="520" height="440" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--27" target="jejXhYi2k6KOZK20mIr--30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--27" target="jejXhYi2k6KOZK20mIr--33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--27" value="producer.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--30" target="jejXhYi2k6KOZK20mIr--31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--30" target="jejXhYi2k6KOZK20mIr--67">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--30" value="Message msg = new Message(TOPIC, TAG, bytes);&lt;br&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;SendResult &lt;b&gt;sendResult&lt;/b&gt; = producer.&lt;b&gt;send&lt;/b&gt;(msg, 20 * 1000);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;同步发送消息&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--31" value="producer.shutdown();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--33" target="jejXhYi2k6KOZK20mIr--36">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--33" value="this.setProducerGroup(&lt;br&gt;withNamespace(this.producerGroup));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在生产者分组上添加&lt;b&gt;命名空间&lt;/b&gt;信息，不指定命名空间默认为null,即不附加命名空间&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--36" target="jejXhYi2k6KOZK20mIr--38">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--36" target="jejXhYi2k6KOZK20mIr--41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--36" value="this.&lt;b&gt;defaultMQProducerImpl&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;创建内部组件并启动&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--38" target="jejXhYi2k6KOZK20mIr--141">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--38" value="this.&lt;b&gt;produceAccumulator&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于支持&lt;b&gt;批量发送消息&lt;/b&gt;，accumulator: 蓄能器，比喻很贴切&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--41" target="jejXhYi2k6KOZK20mIr--44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--41" target="jejXhYi2k6KOZK20mIr--136">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--41" value="检查 this.serviceState 状态（即生产者客户端启动状态），有 CREATE_JUST、RUNNING、SHUTDOWN_ALREADY、START_FAILED 4种状态，仅仅&lt;b&gt;CREATE_JUST&lt;/b&gt; 会执行客户端启动流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--42" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="785" y="370" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--44" target="jejXhYi2k6KOZK20mIr--47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--44" value="修改启动状态 START_FAILED&lt;br&gt;检查生产者分组命名规范、修改客户端实例名（instanceName）" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--47" target="jejXhYi2k6KOZK20mIr--49">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--47" target="jejXhYi2k6KOZK20mIr--61">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--47" value="this.&lt;b&gt;mQClientFactory&lt;/b&gt; = MQClientManager.getInstance().&lt;br&gt;&lt;b&gt;getOrCreateMQClientInstance&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer, rpcHook);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建MQ客户端实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--49" target="jejXhYi2k6KOZK20mIr--52">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--49" value="boolean registerOK = mQClientFactory.&lt;b&gt;registerProducer&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer.getProducerGroup(), this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance 同时是 MQProduceInner 的容器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="720" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--52" target="jejXhYi2k6KOZK20mIr--55">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--52" target="jejXhYi2k6KOZK20mIr--69">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--52" value="&lt;b&gt;if (startFactory)&lt;/b&gt;&lt;br&gt;&lt;b&gt;mQClientFactory&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;mQClientFactory 即上面的 MQClientInstance 实例，将启动其内部的各个组件&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--55" target="jejXhYi2k6KOZK20mIr--57">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--55" target="jejXhYi2k6KOZK20mIr--70">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--55" value="this.initTopicRoute();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--57" target="jejXhYi2k6KOZK20mIr--134">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--57" value="this.mqFaultStrategy.startDetector();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--63">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--86">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1720" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--89">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="510" />
              <mxPoint x="1460" y="590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--61" value="从 MQClientManager &lt;b&gt;factoryTable&lt;/b&gt; 中获取 &lt;b&gt;MQClientInstance&lt;/b&gt;, 不存在则创建&lt;br&gt;&lt;div&gt;instance = new &lt;b&gt;MQClientInstance&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;clientConfig.cloneClientConfig(),&lt;/div&gt;&lt;div&gt;this.factoryIndexGenerator.getAndIncrement(), &lt;b&gt;clientId&lt;/b&gt;, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1230" y="470" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--62" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;就是MQ客户端（MQClientInstance）&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;和 ProduceAccumulator 的容器, 同时也是它们的工厂&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger &lt;b&gt;factoryIndexGenerator&lt;/b&gt; = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;MQClientInstance&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;ProduceAccumulator&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public MQClientInstance getOrCreateMQClientInstance(...)&amp;nbsp;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public ProduceAccumulator getOrCreateProduceAccumulator(final ClientConfig clientConfig)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-560" y="1840" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--63" value="MQClientInstance prev = this.factoryTable&lt;br&gt;.&lt;b&gt;putIfAbsent&lt;/b&gt;(clientId,instance);&lt;br&gt;if (prev != null)&amp;nbsp;instance = prev;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;前面还在迷惑为何没有加锁，原来是这里借助 putIfAbsent 原子操作实现的并发同步&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1240" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--64" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;尽管这步之前可能同时有多个线程创建客户端实例&lt;br style=&quot;font-size: 10px;&quot;&gt;但是因为 putIfAbsent 是原子操作（见源码注释）&lt;br style=&quot;font-size: 10px;&quot;&gt;如果clientId键的值已经存在，会改回之前的值，&lt;br style=&quot;font-size: 10px;&quot;&gt;最终instance一定是最先创建的那个实例&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1450" y="640" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--65" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;保存一个客户端实例上所有分组的消息生产者、消费者、MQAdminExtInner, 同时提供与NameServer Broker 通信、处理消息的能力（也即一个客户端实例上的生产者、消费者使用的是同一个客户端连接）&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientConfig clientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String clientId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long bootTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// &lt;b&gt;groupName&lt;/b&gt; -&amp;gt; &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, &lt;b&gt;MQProducerInner&lt;/b&gt;&amp;gt; &lt;b&gt;producerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQConsumerInner&amp;gt; &lt;b&gt;consumerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQAdminExtInner&amp;gt; &lt;b&gt;adminExtTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MQClientAPIImpl&lt;/b&gt; &lt;b&gt;mQClientAPIImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MQAdminImpl&lt;/b&gt; &lt;b&gt;mQAdminImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Topic -&amp;gt; TopicRouteData&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, TopicRouteData&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, ConcurrentMap&amp;lt;MessageQueue, String&amp;gt;&amp;gt; &lt;b&gt;topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockNamesrv = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockHeartbeat = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; brokerAddrTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Broker name -&amp;gt; ( address -&amp;gt; version )&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;String, Integer&amp;gt;&amp;gt; brokerVersionTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Broker address&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String&amp;gt; brokerSupportV2HeartbeatSet = new HashSet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Integer&amp;gt; brokerAddrHeartbeatFingerprintTable = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(r -&amp;gt; new Thread(r, &quot;MQClientFactoryScheduledThread&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService fetchRemoteConfigExecutorService = Executors.newSingleThreadScheduledExecutor(...);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullMessageService &lt;b&gt;pullMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceService &lt;b&gt;rebalanceService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConsumerStatsManager &lt;b&gt;consumerStatsManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="1840" width="520" height="520" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--67" target="jejXhYi2k6KOZK20mIr--148">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--67" value="msg.setTopic(&lt;br&gt;withNamespace(msg.getTopic()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--68" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--69" target="jejXhYi2k6KOZK20mIr--73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--69" value="this.mQClientAPIImpl&lt;br&gt;.fetchNameServerAddr();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--70" value="List&amp;lt;String&amp;gt; topics = this.defaultMQProducer.getTopics();&lt;br&gt;topics.forEach(topic -&amp;gt; {&lt;br&gt;TopicPublishInfo topicPublishInfo = &lt;b&gt;tryToFindTopicPublishInfo&lt;/b&gt;(newTopic);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1870" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--71" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--73" target="jejXhYi2k6KOZK20mIr--76">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--73" target="jejXhYi2k6KOZK20mIr--91">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--73" value="this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--76" target="jejXhYi2k6KOZK20mIr--79">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--76" target="jejXhYi2k6KOZK20mIr--120">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--76" value="this.&lt;b&gt;startScheduledTask&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一些定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--79" target="jejXhYi2k6KOZK20mIr--82">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--79" target="jejXhYi2k6KOZK20mIr--128">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--79" value="this.&lt;b&gt;pullMessageService&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一个守护线程&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--82" target="jejXhYi2k6KOZK20mIr--84">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--82" target="jejXhYi2k6KOZK20mIr--131">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--82" value="this.&lt;b&gt;rebalanceService&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--84" target="jejXhYi2k6KOZK20mIr--41">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="1810" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1460" y="1810" />
              <mxPoint x="1460" y="1850" />
              <mxPoint x="740" y="1850" />
              <mxPoint x="740" y="445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--84" value="this.defaultMQProducer&lt;br&gt;.&lt;b&gt;getDefaultMQProducerImpl&lt;/b&gt;().start(false);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&amp;nbsp;DefaultMQProducerImpl，即一个消息分组对应的消息生产者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--85" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQProducerInner&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;（I）&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="1000" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--86" value="&lt;b&gt;clientId 生成规则&lt;/b&gt;： ClientIP@instanceName&lt;br&gt;@unitName@StreamRequestType&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;后面两部分可能没有，比如192.168.1.5@74854#15296806586016&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--87" value="&lt;b style=&quot;&quot;&gt;instanceName 命名规则&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;： 如果前面没有指定实例名（默认是DEFAULT）&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里会更改为 &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;PID#System.nanoTime()&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1210" y="410" width="350" height="40" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--88" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientAPIImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static boolean sendSmartMsg =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Boolean.parseBoolean(System.getProperty(&quot;org.apache.rocketmq.client.sendSmartMsg&quot;, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;RemotingClient&lt;/b&gt; &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final TopAddressing topAddressing;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientRemotingProcessor clientRemotingProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String nameSrvAddr = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ClientConfig &lt;b&gt;clientConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; getNameServerAddressList()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public RemotingClient getRemotingClient()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String fetchNameServerAddr()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String onNameServerAddressChange(String namesrvAddress)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void start()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void shutdown()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createSubscriptionGroup(final String addr, final SubscriptionGroupConfig config,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis) throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;createTopic&lt;/b&gt;(final String addr, final String defaultTopic, final TopicConfig topicConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createPlainAccessConfig(final String addr, final PlainAccessConfig plainAccessConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void deleteAccessConfig(final String addr, final String accessKey, final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void updateGlobalWhiteAddrsConfig(final String addr, final String globalWhiteAddrs, String aclFileFullPath,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SendResult &lt;b&gt;sendMessage&lt;/b&gt;(...)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1680" y="1840" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--89" value="实例化 MQClientInstance 内部组件，包括&lt;br&gt;&lt;b&gt;MQClientAPIImpl、mQAdminImpl、pullMessageService、rebalanceService、defaultMQProducer、consumerStatsManager&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--90" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--91" target="jejXhYi2k6KOZK20mIr--94">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--91" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--92" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--94" target="jejXhYi2k6KOZK20mIr--97">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--94" target="jejXhYi2k6KOZK20mIr--100">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--94" value="Netty客户端Bootstrap初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里只关注后面pipeline中最后两个Handler&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#ea6b66&quot;&gt;奇怪暂时没有找到哪里启动连接，todo: 可能在其他类中获取Bootstrap并启动的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--96" target="jejXhYi2k6KOZK20mIr--106">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--96" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends NettyRemotingAbstract implements &lt;b&gt;RemotingClient&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;Bootstrap&lt;/b&gt; &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup &lt;b&gt;eventLoopGroupWorker&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; &lt;b&gt;bootstrapMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; channelTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定时任务执行器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HashedWheelTimer&lt;/b&gt; &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; namesrvAddrList = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// RocketMQ 自定义事件的监听器，todo 这些事件的作用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener &lt;b&gt;channelEventListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="1840" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--97" value="&lt;div&gt;ch.pipeline().addLast(&lt;/div&gt;&lt;div&gt;nettyClientConfig.isDisableNettyWorkerGroup() ? null : defaultEventExecutorGroup,&lt;/div&gt;&lt;div&gt;new NettyEncoder(), new NettyDecoder(),&lt;/div&gt;&lt;div&gt;new IdleStateHandler(0, 0, nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),&lt;/div&gt;&lt;div&gt;new &lt;b&gt;NettyConnectManageHandler&lt;/b&gt;(), new &lt;b&gt;NettyClientHandler&lt;/b&gt;());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1960" y="900" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--100" target="jejXhYi2k6KOZK20mIr--103">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--100" target="jejXhYi2k6KOZK20mIr--108">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--100" value="&lt;b&gt;nettyEventExecutor&lt;/b&gt;.start();&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&lt;b&gt;一个守护线程&lt;/b&gt;，线程阻塞读取自身eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;即生产者消费者模式，执行事件监听回调&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--101" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--103" target="jejXhYi2k6KOZK20mIr--105">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--102" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--103" target="jejXhYi2k6KOZK20mIr--111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--103" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;timer也是启动了一个线程，处理定义任务，这里提交了个TimerTask任务 3秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--104" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--105" target="jejXhYi2k6KOZK20mIr--112">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--105" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里提交了个TimerTask任务 0秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--106" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreOneway;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreAsync;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; responseTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;&amp;gt; processorTable =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new HashMap&amp;lt;&amp;gt;(64);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于启动一个守护线程，线程阻塞读取eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; rpcHooks = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="1560" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--108" target="jejXhYi2k6KOZK20mIr--109">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--108" value="&lt;b&gt;NettyEventExecutor#run()&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事件监听回调，事件包括：IDLE、CLOSE、CONNET、EXCEPTION、ACTIVIE&lt;br&gt;这些事件是 RocketMQ中定义的&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--109" value="ChannelEventListener#onChannelXxx()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2200" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--110" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;疑问：&lt;br&gt;1 为何实现HashedWheelTimer处理定时任务，不用JDK中现成的类？&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="720" y="10" width="640" height="100" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--111" value="NettyRemotingClient.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this, 1000, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期调用scanResponseTable()扫描已弃用的请求并使其过期&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="1050" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--112" value="NettyRemotingClient&lt;br&gt;.this.&lt;b&gt;scanAvailableNameSrv&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this,connectTimeoutMillis, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--113" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;即每秒处理一下 responseTable 中的超时请求&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2170" y="1075" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--114" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;即定期更新一下可用NameServer地址&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2170" y="1155" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--122">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--116" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--123">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--117" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--124">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--118" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--125">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--119" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--126">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--120" value="通过 this.scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleAtFixedRate&lt;/b&gt;() 一共提交了4个定时任务" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--121" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1280" y="790" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--122" value="MQClientInstance.this.mQClientAPIImpl&lt;br&gt;.&lt;b&gt;fetchNameServerAddr&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--123" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--124" value="MQClientInstance.this.&lt;b&gt;cleanOfflineBroker&lt;/b&gt;();&lt;br&gt;MQClientInstance.this&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--125" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;persistAllConsumerOffset&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--126" value="MQClientInstance.this.&lt;b&gt;adjustThreadPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--127" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--128" target="jejXhYi2k6KOZK20mIr--129">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--128" value="PullMessageService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--129" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;while:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageRequest messageRequest = this.&lt;b style=&quot;font-size: 9px;&quot;&gt;messageRequestQueue&lt;/b&gt;.take();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageRequest.&lt;b style=&quot;font-size: 9px;&quot;&gt;getMessageRequestMode&lt;/b&gt;() == MessageRequestMode.POP) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.popMessage((PopRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.pullMessage((PullRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1610" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--131" target="jejXhYi2k6KOZK20mIr--132">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--131" value="RebalanceService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--132" value="todo" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--133" value="&lt;font color=&quot;#007fff&quot;&gt;这里 defaultMQProducer 是内部Producer, 分组为 CLIENT_INNER_PRODUCER&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1795" width="450" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--134" value="this.serviceState = ServiceState.RUNNING;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--135" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--136" target="jejXhYi2k6KOZK20mIr--137">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--136" value="this.mQClientFactory&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--137" value="RequestFutureHolder.getInstance()&lt;br&gt;.&lt;b&gt;startScheduledTask&lt;/b&gt;(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动定时任务，用于每秒扫描一下过期请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--138" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RequestFutureHolder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final RequestFutureHolder INSTANCE = new RequestFutureHolder();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentHashMap&amp;lt;String, RequestResponseFuture&amp;gt; &lt;b&gt;requestFutureTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;DefaultMQProducerImpl&amp;gt; &lt;b&gt;producerSet&lt;/b&gt; = new HashSet&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1560" y="1120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--141" target="jejXhYi2k6KOZK20mIr--143">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--141" target="jejXhYi2k6KOZK20mIr--144">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--141" value="guardThreadForSyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行同步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--142" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--143" target="jejXhYi2k6KOZK20mIr--145">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--143" value="guardThreadForAsyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行异步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--144" value="GuardForSyncSendService#run();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--145" value="GuardForAsyncSendService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--146" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Message&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;b&gt;topic&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;flag&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//一些约定好的属性KEY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// KEYS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// TAGS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;DELAY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;WAIT&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;INSTANCE_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// BUYER_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_SEC&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELIVER_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; &lt;b&gt;properties&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息体&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] &lt;b&gt;body&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;transactionId&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-560" y="2400" width="520" height="280" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--147" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="jejXhYi2k6KOZK20mIr--148" target="jejXhYi2k6KOZK20mIr--149">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--148" value="return this.defaultMQProducerImpl.&lt;b&gt;send&lt;/b&gt;(msg, timeout);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--149" value="" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="3BUzB-CuzncaUeyYl-aW" name="NameServer">
    <mxGraphModel dx="3847" dy="837" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="uRtEAP2a5k4lkSkrBafr-164" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2100" y="2150" width="240" height="420" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-163" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2100" y="1390" width="240" height="740" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AJX_MhfLM1ez97IJH3E7-1" target="uRtEAP2a5k4lkSkrBafr-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AJX_MhfLM1ez97IJH3E7-1" value="命名服务启动&lt;br&gt;&lt;b&gt;NamesrvStartup&lt;/b&gt;#main()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-1" value="&lt;b&gt;parseCommandlineAndConfigFile&lt;/b&gt;(args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;解析命令行参数和配置文件内容然后赋值到NamesrvStartup 各个配置（xxxConfig）对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-3" value="NamesrvController controller = &lt;b&gt;createAndStartNamesrvController&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-5" target="uRtEAP2a5k4lkSkrBafr-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-5" value="controllerManagerMain();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动管理后台，不是必须的先略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-7" target="uRtEAP2a5k4lkSkrBafr-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-7" value="CommandLine commandLine = ServerUtil.&lt;b&gt;parseCmdLine&lt;/b&gt;(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options), new DefaultParser());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;使用&lt;b&gt;Commons-cli&lt;/b&gt;工具解析命令行参数&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-9" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;将命令行参数 &lt;b style=&quot;font-size: 9px;&quot;&gt;-c&amp;nbsp; 指定的文件中的属性以及 -p 直接设置的属性&lt;/b&gt;&amp;nbsp;加载到 NameServerStartup&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;namesrvConfig&lt;/b&gt;、&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyServerConfig&lt;/b&gt;、&amp;nbsp;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyClientConfig、controllerConfig&amp;nbsp;&lt;/b&gt;等字段&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;NamesrvStartup&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;NameServer 启动类，用于启动 RocketMQ NameServer （NamesrvController） 和 管理后台（ControllerManager）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static Properties &lt;b&gt;properties&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RokcetMQ NameSever 相关配置，下面三个配置用于启动 NamesrvController&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NameServer Netty服务端配置，使用Netty与其他组件通信&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NameServer 也需要主动发起与其他组件通信&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RocketMQ Web管理后台配置，这个配置用于启动 ControllerManager&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static ControllerConfig &lt;b&gt;controllerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-560" y="80" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-12" value="NamesrvController controller = &lt;b&gt;createNamesrvController&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-14" target="uRtEAP2a5k4lkSkrBafr-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-14" value="start(controller);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动命名服务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="uRtEAP2a5k4lkSkrBafr-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="qkaxiBqNsh2hagOEbENo-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="qkaxiBqNsh2hagOEbENo-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-16" value="final NamesrvController controller = new &lt;b&gt;NamesrvController&lt;/b&gt;(namesrvConfig, nettyServerConfig, nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-18" value="controller.getConfiguration()&lt;br&gt;.registerConfig(properties);&lt;br&gt;return controller;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.564;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-20" target="uRtEAP2a5k4lkSkrBafr-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.91;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-20" target="uRtEAP2a5k4lkSkrBafr-28">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-590" y="666" />
              <mxPoint x="-590" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NamesrvController&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;RocketMQ 命名服务的核心实现类&lt;/font&gt;&lt;/b&gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// NamesrvStartup 中三个配置类实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scanExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScanScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//配置属性的容器，里面是一个名为 configTable 的嵌套的HashMap，存储&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp;Namespace -&amp;gt; （Key -&amp;gt; Value）&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final KVConfigManager &lt;b&gt;kvConfigManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路由信息的一组 ConcurrentHashMap&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RouteInfoManager &lt;b&gt;routeInfoManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingClient &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty服务端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingServer &lt;b&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//实现ChannelEventListener，默认会回调 routeInfoManager 的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BrokerHousekeepingService &lt;b&gt;brokerHousekeepingService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService defaultExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService clientRequestExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; defaultThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; clientRequestThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Configuration &lt;b&gt;configuration&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private FileWatchService fileWatchService;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-560" y="320" width="520" height="380" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RouteInfoManager&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long DEFAULT_BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ReadWriteLock lock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String, QueueData&amp;gt;&amp;gt; &lt;b&gt;topicQueueTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* brokerName */, BrokerData&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* clusterName */, Set&amp;lt;String/* brokerName */&amp;gt;&amp;gt; &lt;b&gt;clusterAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, BrokerLiveInfo&amp;gt; &lt;b&gt;brokerLiveTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt;&amp;gt; &lt;b&gt;topicQueueMappingInfoTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BatchUnregistrationService &lt;b&gt;unRegisterService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvController &lt;b&gt;namesrvController&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="80" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-28" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Configuration&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;Object&amp;gt; &lt;b&gt;configObjectList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;(4);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String storePath;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean storePathFromConfig = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Object storePathObject;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Field storePathField;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DataVersion dataVersion = new DataVersion();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ReadWriteLock readWriteLock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Properties &lt;b&gt;allConfigs&lt;/b&gt; = new Properties();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="360" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-29" value="boolean initResult = controller.initialize();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;进一步初始化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-31" target="uRtEAP2a5k4lkSkrBafr-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-31" value="Runtime.getRuntime()&lt;br&gt;.addShutdownHook(...);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;优雅关机&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-33" target="uRtEAP2a5k4lkSkrBafr-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-33" value="controller.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-35" value="loadConfig();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从&amp;nbsp;&lt;b&gt;kvConfig.json&amp;nbsp;&lt;/b&gt;加载属性配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-37" value="initiateNetworkComponents();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个Netty客户端和一个Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-59" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240" y="1180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-39" value="initiateThreadExecutors();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建两个线程池，用于执行 NettyRequestProcessor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1210" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-41" value="registerProcessor();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;向Netty服务端processorTable注册请求的处理器(NettyRequestProcessor)，以及设置处理线程池（就是上面创建的线程池）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-43" value="startScheduleService();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动3个定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-45" value="initiateSslContext();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置SSL, 启动一个线程监听证书和密钥文件的变化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-47" target="uRtEAP2a5k4lkSkrBafr-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-47" value="initiateRpcHooks();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注册RPCHook, 用于拓展请求前和响应后的处理逻辑&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-49" value="this.kvConfigManager.load();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="qkaxiBqNsh2hagOEbENo-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-94">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-51" value="this.&lt;b&gt;remotingServer&lt;/b&gt; = new &lt;b&gt;NettyRemotingServer&lt;/b&gt;(&lt;br&gt;this.nettyServerConfig, this.brokerHousekeepingService);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-53" target="uRtEAP2a5k4lkSkrBafr-107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-53" value="this.&lt;b&gt;remotingClient&lt;/b&gt; = new &lt;b&gt;NettyRemotingClient&lt;/b&gt;(this.nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-91" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-55" target="uRtEAP2a5k4lkSkrBafr-92" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1420" y="400" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingServer &lt;/b&gt;extends NettyRemotingAbstract implements RemotingServer&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServerBootstrap &lt;b&gt;serverBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupSelector;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupBoss;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;publicExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; r -&amp;gt; new Thread(r, &quot;ServerHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DefaultEventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NettyRemotingServer可能包含多个SubRemotingServer&lt;br&gt;//监听端口 -&amp;gt; NettyRemotingAbstract&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer/*Port*/, NettyRemotingAbstract&amp;gt; &lt;b&gt;remotingServerTable&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HANDSHAKE_HANDLER_NAME = &quot;handshakeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_DECODER = &quot;HAProxyDecoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_HANDLER = &quot;HAProxyHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_MODE_HANDLER = &quot;TlsModeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_HANDLER_NAME = &quot;sslHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String FILE_REGION_ENCODER_NAME = &quot;fileRegionEncoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TlsModeHandler tlsModeHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyEncoder encoder;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyConnectManageHandler connectionManageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyServerHandler &lt;b&gt;serverHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingCodeDistributionHandler distributionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="440" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="i3243ysWS5UdkbpY5Jqh-1" target="uRtEAP2a5k4lkSkrBafr-92" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1980" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-59" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;this.defaultThreadPoolQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; (this.namesrvConfig.getDefaultThreadPoolQueueCapacity());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.defaultExecutor =&amp;nbsp; &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ThreadUtils.&lt;b style=&quot;font-size: 9px;&quot;&gt;newThreadPoolExecutor&lt;/b&gt;(this.namesrvConfig.getDefaultThreadPoolNums(), this.namesrvConfig.getDefaultThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.defaultThreadPoolQueue, new ThreadFactoryImpl(&quot;&lt;b style=&quot;font-size: 9px;&quot;&gt;RemotingExecutorThread_&lt;/b&gt;&quot;));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.clientRequestThreadPoolQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;(this.namesrvConfig.getClientRequestThreadPoolQueueCapacity());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.clientRequestExecutor = ThreadUtils.&lt;b style=&quot;font-size: 9px;&quot;&gt;newThreadPoolExecutor&lt;/b&gt;(this.namesrvConfig.getClientRequestThreadPoolNums(), this.namesrvConfig.getClientRequestThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.clientRequestThreadPoolQueue, new ThreadFactoryImpl(&quot;&lt;b style=&quot;font-size: 9px;&quot;&gt;ClientRequestExecutorThread_&lt;/b&gt;&quot;));&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;arcSize=4;align=left;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-63" value="&lt;div&gt;ClientRequestProcessor clientRequestProcessor = new &lt;b&gt;ClientRequestProcessor&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.remotingServer.&lt;b&gt;registerProcessor&lt;/b&gt;(RequestCode.&lt;b&gt;GET_ROUTEINFO_BY_TOPIC&lt;/b&gt;, clientRequestProcessor, this.clientRequestExecutor);&lt;/div&gt;&lt;div&gt;this.remotingServer.&lt;b&gt;registerDefaultProcessor&lt;/b&gt;(new DefaultRequestProcessor(this), this.defaultExecutor);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1340" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-68" value="&lt;div&gt;this.&lt;b&gt;scanExecutorService&lt;/b&gt;.scheduleAtFixedRate(&lt;br&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.routeInfoManager::&lt;b&gt;scanNotActiveBroker&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 5, this.namesrvConfig.getScanNotActiveBrokerInterval(), TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt;.scheduleAtFixedRate(&lt;br&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.kvConfigManager::&lt;b&gt;printAllPeriodically&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 1, 10, TimeUnit.MINUTES);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt;.scheduleAtFixedRate(() -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.&lt;b&gt;printWaterMark&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}, 10, 1, TimeUnit.SECONDS);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="1420" width="440.5" height="140" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-76" value="fileWatchService = new FileWatchService(watchFiles, listener);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-78" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.&lt;b&gt;registerRPCHook&lt;/b&gt;(&lt;br&gt;new ZoneRouteRPCHook());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="1reMIaGBY-K2Yn5TWBya-1" target="uRtEAP2a5k4lkSkrBafr-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="uRtEAP2a5k4lkSkrBafr-113" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-80" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-85" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-82" target="uRtEAP2a5k4lkSkrBafr-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-82" target="1reMIaGBY-K2Yn5TWBya-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240.5" y="2630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-82" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000.5" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-84" target="1reMIaGBY-K2Yn5TWBya-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-84" value="this.&lt;b&gt;routeInfoManager&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-86" value="createAndStartControllerManager();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="510" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-92" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的单向请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore &lt;b&gt;semaphoreOneway&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的异步请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore &lt;b&gt;semaphoreAsync&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此映射缓存所有正在进行的请求。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; &lt;b&gt;responseTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此容器保存每个请求代码的所有处理器，即对于每个传入的请求，我们可以在此映射中查找响应的处理器来处理请求。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;&lt;b&gt;NettyRequestProcessor&lt;/b&gt;, ExecutorService&amp;gt;&amp;gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;processorTable&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 实际是一个守护者线程，用于将 netty 事件传递给用户定义的 {@link ChannelEventListener} 的执行器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在没有在 {@link #processorTable} 中找到精确匹配的情况下使用的默认请求处理器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于创建 {@link SslHandler} 的 SSL 上下文。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自定义 RPC 钩子，todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; &lt;b&gt;rpcHooks&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="80" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-94" target="qkaxiBqNsh2hagOEbENo-17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-19" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="qkaxiBqNsh2hagOEbENo-18">
          <mxGeometry x="0.6696" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-94" target="qkaxiBqNsh2hagOEbENo-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-22" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="qkaxiBqNsh2hagOEbENo-21">
          <mxGeometry x="0.6224" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-94" value="&lt;div&gt;super(nettyServerConfig.getServerOnewaySemaphoreValue(),&amp;nbsp;&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;nettyServerConfig.getServerAsyncSemaphoreValue());&lt;/div&gt;&lt;div&gt;this.serverBootstrap = new &lt;b&gt;ServerBootstrap&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.nettyServerConfig = nettyServerConfig;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//RocketMQ自定义的Netty事件监听器，NettyEventExecutor这个任务分发事件&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.channelEventListener = channelEventListener;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;publicExecutor&lt;/b&gt; = &lt;b&gt;buildPublicExecutor&lt;/b&gt;(nettyServerConfig);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt; = &lt;b&gt;buildScheduleExecutor&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.eventLoopGroupBoss = &lt;b&gt;buildBossEventLoopGroup&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.eventLoopGroupSelector = &lt;b&gt;buildEventLoopGroupSelector&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;loadSslContext();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="640" width="439.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-102" value="RocketMQ自行实现了一个简单的命名服务，记录各模块实例信息&lt;br&gt;注意下面代码流程中省略了一些细节" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-107" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;super(nettyClientConfig.getClientOnewaySemaphoreValue(), &lt;br&gt;&amp;nbsp; &amp;nbsp; nettyClientConfig.getClientAsyncSemaphoreValue());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.nettyClientConfig = nettyClientConfig;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.channelEventListener = channelEventListener;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.loadSocksProxyJson();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;int publicThreadNums = nettyClientConfig.getClientCallbackExecutorThreads();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (publicThreadNums &amp;lt;= 0) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; publicThreadNums = 4;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;publicExecutor&lt;/b&gt; = Executors.newFixedThreadPool(publicThreadNums, new ThreadFactoryImpl(&quot;&lt;b&gt;NettyClientPublicExecutor_&lt;/b&gt;&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;scanExecutor&lt;/b&gt; = ThreadUtils.newThreadPoolExecutor(4, 10, 60, TimeUnit.SECONDS,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ArrayBlockingQueue&amp;lt;&amp;gt;(32), new ThreadFactoryImpl(&quot;&lt;b&gt;NettyClientScan_thread_&lt;/b&gt;&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (eventLoopGroup != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.eventLoopGroupWorker = eventLoopGroup;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;eventLoopGroupWorker&lt;/b&gt; = new &lt;b&gt;NioEventLoopGroup&lt;/b&gt;(1, new ThreadFactoryImpl(&quot;NettyClientSelector_&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.defaultEventExecutorGroup = eventExecutorGroup;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (nettyClientConfig.isUseTLS()) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="820" width="439.5" height="300" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-113" target="uRtEAP2a5k4lkSkrBafr-115" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-113" target="uRtEAP2a5k4lkSkrBafr-123">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-113" value="&lt;div&gt;this.&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt; = &lt;br&gt;new DefaultEventExecutorGroup(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建用于处理Netty请求的线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-119" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-115" value="prepareSharableHandlers();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;有5个ChannelHandler是共享的&lt;br&gt;即所有pipeline中使用同一实例，都需要注释&lt;br&gt;&amp;nbsp;@ChannelHandler.Sharable&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1840" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-117" value="tlsModeHandler = new&amp;nbsp; &lt;br&gt;&amp;nbsp; TlsModeHandler(TlsSystemConfig.tlsMode);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;encoder&lt;/b&gt; = new NettyEncoder();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;connectionManageHandler&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; NettyConnectManageHandler();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;serverHandler&lt;/b&gt; = new NettyServerHandler();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;distributionHandler&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; RemotingCodeDistributionHandler();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;arcSize=8;align=left;" parent="1" vertex="1">
          <mxGeometry x="1479" y="1820" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-122" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-126" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-125" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-119" value="serverBootstrap.group(...)&lt;br&gt;.channel(...).option(...).childOption(...)&lt;br&gt;.localAddress()...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;ServerBootstrap 初始化配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1940" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-124" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-121" target="uRtEAP2a5k4lkSkrBafr-123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-121" value=".childHandler((ChannelInitializer)ch -&amp;gt; {&lt;br&gt;&lt;b&gt;configChannel&lt;/b&gt;(ch);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="1940" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-173" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.508;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;dashed=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-123" target="uRtEAP2a5k4lkSkrBafr-145" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2070" y="1970" />
              <mxPoint x="2070" y="1360" />
              <mxPoint x="2222" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-1" value="请求处理" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="uRtEAP2a5k4lkSkrBafr-173" vertex="1" connectable="0">
          <mxGeometry x="0.6736" y="3" relative="1" as="geometry">
            <mxPoint x="39" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-123" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;return ch.pipeline()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;, HANDSHAKE_HANDLER_NAME, new &lt;b&gt;HandshakeHandler&lt;/b&gt;())&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;encoder&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyDecoder&lt;/b&gt;(),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;distributionHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;connectionManageHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;serverHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; );&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1890" width="319.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-128" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-125" target="uRtEAP2a5k4lkSkrBafr-127" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-125" value="addCustomConfig(serverBootstrap);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;为 serverBootstrap 设置额外的&amp;nbsp;childOption&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-127" target="uRtEAP2a5k4lkSkrBafr-129" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-127" value="ChannelFuture sync = serverBootstrap.bind().sync();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="2100" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-129" target="uRtEAP2a5k4lkSkrBafr-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-129" value="this.&lt;b&gt;remotingServerTable&lt;/b&gt;.put(&lt;br&gt;this.nettyServerConfig.getListenPort(), this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2180" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-131" target="uRtEAP2a5k4lkSkrBafr-133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-131" value="&lt;div&gt;if (this.channelEventListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.nettyEventExecutor.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动监听Netty请求事件并分发给ChannelEventListener的线程&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2260" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-135" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-139" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-133" value="this.timer.newTimeout(&lt;br&gt;&lt;b&gt;timerScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2340" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-135" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期扫描并处理过期的请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2340" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-139" target="uRtEAP2a5k4lkSkrBafr-141" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-139" value="scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleWithFixedDelay&lt;/b&gt;(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2420" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-141" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;printRemotingCodeDistribution&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2420" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="uRtEAP2a5k4lkSkrBafr-161" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2360" y="1440" />
              <mxPoint x="2360" y="1200" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-178" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-4" target="uRtEAP2a5k4lkSkrBafr-148" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-145" value="HandshakeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;握手处理，借助&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;检测是否是Proxy Protocol 类型, 这个主要是为了支持&lt;b&gt;HAProxy&lt;/b&gt;代理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1410" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-179" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-148" target="uRtEAP2a5k4lkSkrBafr-150" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-148" value="NettyDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是RocketMQ自定义的解码器，继承&lt;br&gt;&lt;b&gt;LengthFieldBasedFrameDecoder&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120" y="1730" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-180" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-150" target="uRtEAP2a5k4lkSkrBafr-151" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-150" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120" y="1810" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-181" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-151" target="uRtEAP2a5k4lkSkrBafr-154" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-151" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1890" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-182" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-154" target="uRtEAP2a5k4lkSkrBafr-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-154" value="NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1970" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-183" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-155" target="uRtEAP2a5k4lkSkrBafr-171" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-155" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2120" y="2050" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-161" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ProtocolDetectionResult&amp;lt;HAProxyProtocolVersion&amp;gt; detectionResult = HAProxyMessageDecoder.detectProtocol(byteBuf);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if (detectionResult.state() == ProtocolDetectionState.NEEDS_MORE_DATA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//其实是半包处理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;if (detectionResult.state() == ProtocolDetectionState.DETECTED) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), HA_PROXY_DECODER, new &lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_DECODER, HA_PROXY_HANDLER, new &lt;b&gt;HAProxyMessageHandler&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_HANDLER, TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ctx.pipeline().remove(this);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;即检测到使用了Proxy Protocol 就添加先在 HandshakeHandler 后添加&amp;nbsp;HAProxyMessageDecoder、HAProxyMessageHandler、&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;TlsModeHandler，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;然后再删除当前的 HandshakeHandler；&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1110" width="600" height="180" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-166" value="NettyEncoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2490" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-187" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-169" target="uRtEAP2a5k4lkSkrBafr-177" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-169" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2330" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-185" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-170" target="uRtEAP2a5k4lkSkrBafr-169" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-170" value="NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2119.5" y="2250" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-184" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-171" target="uRtEAP2a5k4lkSkrBafr-170" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-171" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2119.5" y="2170" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-175" value="InBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2110.5" y="1370" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-176" value="OutBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2110.5" y="2130" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-188" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-177" target="uRtEAP2a5k4lkSkrBafr-166" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-177" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2410" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-6" target="Lc81XJVoeO8ClW7Fo5lE-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1510" as="sourcePoint" />
            <mxPoint x="2220" y="1730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-2" target="x9bTwj67HdBwY7-d5Wo_-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-2" value="HAProxyMessageHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要就是将连接信息存储起来，这里将信息存储到了channel的属性表&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1570" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-2" target="Lc81XJVoeO8ClW7Fo5lE-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1590" as="sourcePoint" />
            <mxPoint x="2220" y="1730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-4" target="x9bTwj67HdBwY7-d5Wo_-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-4" value="TlsModeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;提供 TLS 支持处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1650" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="Lc81XJVoeO8ClW7Fo5lE-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1510" as="sourcePoint" />
            <mxPoint x="2220" y="1570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-6" target="x9bTwj67HdBwY7-d5Wo_-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2380" y="1520" />
              <mxPoint x="2380" y="1340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-6" value="HAProxyMessageDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Proxy协议仅仅就是最开始多传递了个代理协议头部信息，通过这个解码器解析协议版本，协议&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1490" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&lt;/b&gt; extends NettyRemotingAbstract implements RemotingClient&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Bootstrap &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupWorker;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; bootstrapMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; channelTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer timer = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; &lt;b&gt;namesrvAddrList&lt;/b&gt; = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="440" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-2" value="&lt;b&gt;NettyRemotingServer&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1266" y="1730" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-3" value="&lt;b&gt;NettyRemotingClient&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1268" y="2570" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-8" value="&lt;font color=&quot;#007fff&quot;&gt;关于连接接入，传输层的处理参考 netty.drawio&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2100" y="1310" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-11" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;ByteToMessageDecoder&lt;/b&gt;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;extends&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ChannelInboundHandlerAdapter&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;基础的解码器，很多消息解码器继承这个解码器，像数据包半包、粘包等情况的处理就是在编解码器中处理的&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过使用内存副本将 ByteBufs 合并为一个 ByteBuf 来累积 ByteBuf&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;public static final Cumulator &lt;b&gt;MERGE_CUMULATOR&lt;/b&gt; = (alloc, cumulation, in) -&amp;gt; {...};&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过将 ByteBufs 添加到 CompositeByteBuf 来累积 ByteBuf而尽可能不使用内存复制。请注意，CompositeByteBuf 使用更复杂的索引实现，根据您的用例和解码器实现这可能相比仅使用MERGE_CUMULATOR会更慢&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;public static final Cumulator &lt;b&gt;COMPOSITE_CUMULATOR&lt;/b&gt;&amp;nbsp;= (alloc, cumulation, in) -&amp;gt; {...};&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//位掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_INIT = 0;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_CALLING_CHILD_DECODE = 1;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_HANDLER_REMOVED_PENDING = 2;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于存储累积数据的ByteBuf，就像是一个&lt;b&gt;数据池&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;ByteBuf &lt;b&gt;cumulation&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认使用&amp;nbsp;MERGE_CUMULATOR 累积数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Cumulator &lt;b&gt;cumulator&lt;/b&gt; = MERGE_CUMULATOR;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否在每次&amp;nbsp;channelRead(ChannelHandlerContext, Object) 调用中仅解码一个消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;singleDecode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;first&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//此标志决定我们是否需要调用 {@link ChannelHandlerContext#read()} 来消费更多的数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;firedChannelRead&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//STATE_INIT 的位掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private byte &lt;b&gt;decodeState&lt;/b&gt; = STATE_INIT;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//设置调用 ByteBuf.discardSomeReadBytes() 的读取次数，从而释放内存。默认值为 16。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;discardAfterReads&lt;/b&gt; = 16;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//累积读取次数（channelRead()次数），msg 没有更多数据或者超过 discardAfterReads 后清0&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//何时会累加？比如每次 channelRead 都传了很多条消息（比如操作系统底层机制中粘包发送），但是我配置了singleDecode = true, 在 callDecode 中每次只处理一个消息，这样就会导致 cumulator 中数据积累的越来越多。一旦超过 discardAfterReads 就会&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;numReads&lt;/b&gt;;&lt;/p&gt;&lt;br&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//返回此解码器的内部累积缓冲区。通常不需要直接访问内部缓冲区来编写解码器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ByteBuf internalBuffer()&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="1520" width="520" height="520" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-1" target="i3243ysWS5UdkbpY5Jqh-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ByteToMessageDecoder&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServerBootstrap &lt;b&gt;serverBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupSelector;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupBoss;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;publicExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; r -&amp;gt; new Thread(r, &quot;ServerHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DefaultEventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NettyRemotingServer可能包含多个SubRemotingServer&lt;br&gt;//监听端口 -&amp;gt; NettyRemotingAbstract&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer/*Port*/, NettyRemotingAbstract&amp;gt; &lt;b&gt;remotingServerTable&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HANDSHAKE_HANDLER_NAME = &quot;handshakeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_DECODER = &quot;HAProxyDecoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_HANDLER = &quot;HAProxyHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_MODE_HANDLER = &quot;TlsModeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_HANDLER_NAME = &quot;sslHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String FILE_REGION_ENCODER_NAME = &quot;fileRegionEncoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TlsModeHandler tlsModeHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyEncoder encoder;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyConnectManageHandler connectionManageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyServerHandler &lt;b&gt;serverHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingCodeDistributionHandler distributionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="2080" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-3" target="x9bTwj67HdBwY7-d5Wo_-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-3" value="channelRead(ChannelHandlerContext ctx, Object msg)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1310" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-5" target="x9bTwj67HdBwY7-d5Wo_-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-5" value="&lt;b style=&quot;background-color: initial;&quot;&gt;cumulation&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = cumulator.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;cumulate&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(&lt;br&gt;ctx.alloc(),&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;first ?Unpooled.EMPTY_BUFFER : cumulation, (ByteBuf) msg);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将msg通过内存复制的方式累积到cumulation&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1310" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-7" target="x9bTwj67HdBwY7-d5Wo_-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-7" target="x9bTwj67HdBwY7-d5Wo_-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-7" value="&lt;div&gt;CodecOutputList out = CodecOutputList.newInstance();&lt;/div&gt;&lt;b&gt;callDecode&lt;/b&gt;(ctx, cumulation, out);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;调用解码逻辑将累积的ByteBuf内容输出到 CodecOutputList实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-9" target="x9bTwj67HdBwY7-d5Wo_-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-9" value="&lt;div&gt;循环通过&amp;nbsp;decodeRemovalReentryProtection(ctx, in, out); 读取 ByteBuf 内容到 out&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-11" target="x9bTwj67HdBwY7-d5Wo_-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-11" value="&lt;div&gt;&lt;b&gt;decode&lt;/b&gt;(ctx, in, out);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;先从ByteBuf in 中读取&lt;b&gt;协议规范版本&lt;/b&gt;，&lt;br&gt;然后使用对应版本的&lt;b&gt;StructHeaderExtractor提取头部信息&lt;/b&gt;，然后解码头部数据到&lt;b&gt;out，&lt;/b&gt;是&lt;b&gt;HAProxyMessage类型&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3120" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-13" value="&lt;div&gt;finally:&lt;/div&gt;&lt;div&gt;如果没有更多内容可读就释放 cumulation, 如果cumulation一直未读取完毕且读取次数超过discardAfterReads限制，则丢弃后面数据&lt;/div&gt;&lt;div&gt;firedChannelRead |= out.insertSinceRecycled();&lt;/div&gt;&lt;div&gt;&lt;b&gt;fireChannelRead&lt;/b&gt;(ctx, out, size);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1470" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-15" value="&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;从Netty源码知，&lt;br&gt;每个连接有一套独立的pipeline,&lt;br&gt;而里面的ChannelHandler 可能是共享的，&lt;br&gt;也可能是独立的，看 configChannel时是&lt;br&gt;新建（new）还是直接传参已有的实例&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1840" y="1365" width="230" height="90" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-16" value="&lt;div&gt;&lt;div&gt;out.add(HAProxyMessage&lt;/div&gt;&lt;div&gt;.&lt;b&gt;decodeHeader&lt;/b&gt;(decoded));&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;将数据转成 HAProxyMessage对象存入 out&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3360" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-18" target="x9bTwj67HdBwY7-d5Wo_-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-18" value="仅仅是提供对 HAProxyMessage 的进一步处理，HAProxyMessageDecoder 解析出的 HAProxyMessage 需要存储起来" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1570" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-20" target="x9bTwj67HdBwY7-d5Wo_-22" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2860" y="1670" />
              <mxPoint x="2860" y="1670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-20" value="channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_ADDR).set(msg.sourceAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_PORT).set(String.valueOf(msg.sourcePort()));&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_ADDR).set(msg.destinationAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_PORT)&lt;br&gt;.set(String.valueOf(msg.destinationPort()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2640.5" y="1570" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-22" value="&lt;div&gt;msg.tlvs().forEach(tlv -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; handleHAProxyTLV(tlv, channel);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;todo, 和 SSL等处理有关&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="2760.25" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-24" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;检测传入数据的开头是否为 TLS 握手的魔术码。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;根据配置的 TLS 模式，对客户端的连接请求做出相应的响应。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;如果启用了 SSL 连接，则在 ChannelPipeline 中添加相应的 SSL 处理器。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;移除自身这个 Handler。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;将处理后的消息传递给 ChannelPipeline 中的下一个 Handler。&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="2358.75" y="1640" width="281.25" height="80" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="qkaxiBqNsh2hagOEbENo-1" target="qkaxiBqNsh2hagOEbENo-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-1" value="创建两个ScheduledExecutorService" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-4" value="&lt;div&gt;this.namesrvConfig = namesrvConfig;&lt;/div&gt;&lt;div&gt;this.nettyServerConfig = nettyServerConfig;&lt;/div&gt;&lt;div&gt;this.nettyClientConfig = nettyClientConfig;&lt;/div&gt;&lt;div&gt;this.kvConfigManager = new &lt;b&gt;KVConfigManager&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.brokerHousekeepingService = new &lt;b&gt;BrokerHousekeepingService&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.routeInfoManager = new &lt;b&gt;RouteInfoManager&lt;/b&gt;(namesrvConfig, this);&lt;/div&gt;&lt;div&gt;this.configuration = new &lt;b&gt;Configuration&lt;/b&gt;(LOGGER, this.namesrvConfig, this.nettyServerConfig);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.configuration.setStorePathFromConfig(this.namesrvConfig, &quot;configStorePath&quot;);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="1001" y="400" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="qkaxiBqNsh2hagOEbENo-7" target="qkaxiBqNsh2hagOEbENo-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-7" value="&lt;div&gt;scheduledExecutorService = ThreadUtils.newScheduledThreadPool(1,&lt;/div&gt;&lt;div&gt;new BasicThreadFactory.Builder().namingPattern(&quot;&lt;b&gt;NSScheduledThread&lt;/b&gt;&quot;).daemon(true).build());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="1241" y="240" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-9" value="&lt;div&gt;scanExecutorService = ThreadUtils.newScheduledThreadPool(1,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new BasicThreadFactory.Builder().namingPattern(&quot;&lt;b&gt;NSScanScheduledThread&lt;/b&gt;&quot;).daemon(true).build());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="1240" y="320" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-12" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;主要逻辑：&lt;br&gt;&lt;/b&gt;&lt;/font&gt;1）&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="280" y="300" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-14" value="&lt;font color=&quot;#007fff&quot;&gt;创建一个守护者线程，用于监听队列中Netty事件（NettyEvent）并发给 ChannelEventListener&lt;br&gt;&lt;/font&gt;protected final NettyEventExecutor nettyEventExecutor = new &lt;b&gt;NettyEventExecutor&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;br&gt;private final HashedWheelTimer timer = new &lt;b&gt;HashedWheelTimer&lt;/b&gt;(r -&amp;gt; new Thread(r,&amp;nbsp; &lt;br&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&quot;ServerHouseKeepingService&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="1480.5" y="560" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-17" value="return Executors.&lt;b&gt;newFixedThreadPool&lt;/b&gt;(publicThreadNums, new &lt;br&gt;&amp;nbsp; &amp;nbsp; ThreadFactoryImpl(&quot;NettyServerPublicExecutor_&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;" vertex="1" parent="1">
          <mxGeometry x="1960" y="640" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-20" value="&lt;div&gt;return ThreadUtils.&lt;b&gt;newScheduledThreadPool&lt;/b&gt;(1,&lt;/div&gt;&lt;div&gt;new ThreadFactoryImpl(&quot;NettyServerScheduler_&quot;, true),&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;new ThreadPoolExecutor.DiscardOldestPolicy());&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;" vertex="1" parent="1">
          <mxGeometry x="1960" y="720" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="1reMIaGBY-K2Yn5TWBya-1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1100" y="1820" as="sourcePoint" />
            <mxPoint x="1098" y="2620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-1" value="this.remotingClient&lt;br&gt;.updateNameServerAddressList(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="1reMIaGBY-K2Yn5TWBya-3" target="1reMIaGBY-K2Yn5TWBya-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-3" value="&lt;div&gt;this.&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt; = &lt;br&gt;new DefaultEventExecutorGroup(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建用于处理Netty响应的线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="1reMIaGBY-K2Yn5TWBya-4" target="1reMIaGBY-K2Yn5TWBya-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-4" value="this.bootstrap.group(...)&lt;br&gt;.channel(...).option(...).childOption(...)&lt;br&gt;.localAddress()...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Bootstrap 初始化配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-6" value="&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyEventExecutor&lt;/b&gt;.start();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;this.timer.newTimeout(&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;this.timer.newTimeout(&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=7;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2760" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-8" value="this.unRegisterService.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Broker注销服务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2860" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="XyQ5pNo4CcYP3uo7oZJW" name="Broker">
    <mxGraphModel dx="2022" dy="733" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-2" target="EGYwnP1GJaqrjVY5u9EW-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-2" value="命名服务启动&lt;br&gt;&lt;b&gt;NamesrvStartup&lt;/b&gt;#main()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-4" target="EGYwnP1GJaqrjVY5u9EW-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-4" target="EGYwnP1GJaqrjVY5u9EW-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-4" value="&lt;b&gt;createBrokerController&lt;/b&gt;(args)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-5" target="EGYwnP1GJaqrjVY5u9EW-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-5" target="UH9uaCllqP1BWi3zPepl-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-5" value="BrokerController controller = &lt;b&gt;buildBrokerController&lt;/b&gt;(args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;解析命令行参数、配置文件，将配置信息写入&amp;nbsp;brokerConfig、nettyServerConfig、nettyClientConfig、&lt;b&gt;messageStoreConfig&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-6" value="RocketMQ Broker，代码流程和 Namesrv 类似&lt;br&gt;注意下面代码流程中省略了一些细节" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="20" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-7" value="controller.&lt;b&gt;start&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="EGYwnP1GJaqrjVY5u9EW-9" target="EGYwnP1GJaqrjVY5u9EW-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-9" value="boolean initResult = controller.initialize();&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-11" value="Runtime.getRuntime().addShutdownHook(|&lt;br&gt;new Thread(&lt;br&gt;buildShutdownHook(controller)));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="UH9uaCllqP1BWi3zPepl-1" target="UH9uaCllqP1BWi3zPepl-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-1" value="&lt;div&gt;final BrokerController controller = new &lt;b&gt;BrokerController&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;brokerConfig, nettyServerConfig, nettyClientConfig, messageStoreConfig);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-3" value="controller.getConfiguration()&lt;br&gt;.registerConfig(properties);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rIVS-tahEMKac8YR9IbI-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BrokerController&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final int HA_ADDRESS_MIN_LENGTH = 6;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BrokerConfig brokerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final MessageStoreConfig messageStoreConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerOffsetManager consumerOffsetManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BroadcastOffsetManager broadcastOffsetManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerManager consumerManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerFilterManager consumerFilterManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerOrderInfoManager consumerOrderInfoManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PopInflightMessageCounter popInflightMessageCounter;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ProducerManager producerManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ScheduleMessageService scheduleMessageService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ClientHousekeepingService clientHousekeepingService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PullMessageProcessor pullMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PeekMessageProcessor peekMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PopMessageProcessor popMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final AckMessageProcessor ackMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ChangeInvisibleTimeProcessor changeInvisibleTimeProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final NotificationProcessor notificationProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PollingInfoProcessor pollingInfoProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final QueryAssignmentProcessor queryAssignmentProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ClientManageProcessor clientManageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final SendMessageProcessor sendMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ReplyMessageProcessor replyMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PullRequestHoldService pullRequestHoldService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final MessageArrivingListener messageArrivingListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final Broker2Client broker2Client;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerIdsChangeListener consumerIdsChangeListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final EndTransactionProcessor endTransactionProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final RebalanceLockManager rebalanceLockManager = new RebalanceLockManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final TopicRouteInfoManager topicRouteInfoManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected BrokerOuterAPI brokerOuterAPI;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService scheduledExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService syncBrokerMemberGroupExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService brokerHeartbeatExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final SlaveSynchronize slaveSynchronize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; sendThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; putThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; ackThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; pullThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; litePullThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; replyThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; queryThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; clientManagerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; heartbeatThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; consumerManagerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; endTransactionThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; adminBrokerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; loadBalanceThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BrokerStatsManager brokerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;ConsumeMessageHook&amp;gt; consumeMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected MessageStore messageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected RemotingServer remotingServer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected CountDownLatch remotingServerStartLatch;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected RemotingServer fastRemotingServer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TopicConfigManager topicConfigManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected SubscriptionGroupManager subscriptionGroupManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TopicQueueMappingManager topicQueueMappingManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService sendMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService pullMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService litePullMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService putMessageFutureExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService ackMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService replyMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService queryMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService adminBrokerExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService clientManageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService heartbeatExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService consumerManageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService loadBalanceExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService endTransactionExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected boolean updateMasterHAServerAddrPeriodically = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerStats brokerStats;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private InetSocketAddress storeHost;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TimerMessageStore timerMessageStore;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TimerCheckpoint timerCheckpoint;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected BrokerFastFailure brokerFastFailure;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private Configuration configuration;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TopicQueueMappingCleanService topicQueueMappingCleanService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected FileWatchService fileWatchService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TransactionalMessageCheckService transactionalMessageCheckService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TransactionalMessageService transactionalMessageService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected AbstractTransactionalMessageCheckListener transactionalMessageCheckListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected Map&amp;lt;Class, AccessValidator&amp;gt; accessValidatorMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile boolean shutdown = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ShutdownHook shutdownHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private volatile boolean isScheduleServiceStart = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private volatile boolean isTransactionCheckServiceStart = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile BrokerMemberGroup brokerMemberGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected EscapeBridge escapeBridge;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected List&amp;lt;BrokerAttachedPlugin&amp;gt; brokerAttachedPlugins = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile long shouldStartTime;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerPreOnlineService brokerPreOnlineService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile boolean isIsolated = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile long minBrokerIdInGroup = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile String minBrokerAddrInGroup = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final Lock lock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;ScheduledFuture&amp;lt;?&amp;gt;&amp;gt; scheduledFutures = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ReplicasManager replicasManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long lastSyncTimeMs = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerMetricsManager brokerMetricsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ColdDataPullRequestHoldService coldDataPullRequestHoldService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ColdDataCgCtrService coldDataCgCtrService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TransactionMetricsFlushService transactionMetricsFlushService;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-520" y="80" width="480" height="1480" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="Te4TJPjSaJWwIWo_xXHI" name="Consumer">
    <mxGraphModel dx="3728" dy="764" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="249QSjNWqVOZ7age5LvH-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="249QSjNWqVOZ7age5LvH-2" target="249QSjNWqVOZ7age5LvH-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" edge="1" parent="1" source="249QSjNWqVOZ7age5LvH-2" target="4NOqHYvpeDZbVOTjX4TA-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-2" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;消费者消费消息&lt;br&gt;启动阶段&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="249QSjNWqVOZ7age5LvH-3" target="0WAluWUy1CVLOlXYkIWE-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="249QSjNWqVOZ7age5LvH-3" target="daRG9VKHfTEQrqkJZzFC-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-3" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;DefaultMQPushConsumer consumer = new &lt;b style=&quot;font-size: 11px;&quot;&gt;DefaultMQPushConsumer&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;CONSUMER_GROUP);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-4" value="RocketMQ Consumer&lt;br&gt;注意下面代码流程中省略了一些细节" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="20" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="0WAluWUy1CVLOlXYkIWE-1" target="0WAluWUy1CVLOlXYkIWE-5">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="380" y="260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="0WAluWUy1CVLOlXYkIWE-1" target="daRG9VKHfTEQrqkJZzFC-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-1" value="consumer.&lt;b&gt;setConsumeFromWhere&lt;/b&gt;(&lt;br style=&quot;font-size: 11px;&quot;&gt;ConsumeFromWhere.&lt;br style=&quot;font-size: 11px;&quot;&gt;CONSUME_FROM_FIRST_OFFSET);&lt;br&gt;consumer.&lt;b&gt;subscribe&lt;/b&gt;(TOPIC, &quot;*&quot;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="0WAluWUy1CVLOlXYkIWE-5" target="0WAluWUy1CVLOlXYkIWE-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-5" value="consumer.registerMessageListener(&lt;br style=&quot;font-size: 11px;&quot;&gt;(MessageListenerConcurrently) (msg, context) -&amp;gt; {...}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注册消息监听器（回调）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="0WAluWUy1CVLOlXYkIWE-7" target="daRG9VKHfTEQrqkJZzFC-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-7" value="consumer.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQConsumer&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends MQAdmin&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者消费失败会将消息返回给Broker，然后延迟一段时间后重试发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;sendMessageBack&lt;/b&gt;(final MessageExt msg, final int delayLevel, final String brokerName)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;throws RemotingException, MQBrokerException, InterruptedException, MQClientException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从与给定主题相关的消费者缓存中获取消息队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Set&amp;lt;MessageQueue&amp;gt; &lt;b&gt;fetchSubscribeMessageQueues&lt;/b&gt;(final String topic) throws MQClientException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="80" width="520" height="100" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="PXJ_5VzEAiNYV3dDm0dE-2" target="PXJ_5VzEAiNYV3dDm0dE-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-2" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQPushConsumer (I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;推送模式消费者接口定义，推送指Broker推送Consumer，还有一种Consumer拉取模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start() throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void registerMessageListener(MessageListener messageListener);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void registerMessageListener(final MessageListenerConcurrently messageListener);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void registerMessageListener(final MessageListenerOrderly messageListener);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void subscribe(final String topic, final String subExpression) throws MQClientException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void subscribe(final String topic, final MessageSelector selector) throws MQClientException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void unsubscribe(final String topic);&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void suspend();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void resume();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-560" y="200" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="PXJ_5VzEAiNYV3dDm0dE-2">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-300" y="800" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="I-aYgXq6NnChD4CNcDCU-1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-300" y="800" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="I-aYgXq6NnChD4CNcDCU-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//连接的NameServer地址（IP+端口）&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者的客户端IP&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String clientIP = NetworkUtil.getLocalAddress();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端实例名，默认“DEFAULT”，“DEFAULT”&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面在启动时会被替换为 PID#当前纳秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;instanceName&lt;/b&gt; = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Deprecated&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespace;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean namespaceInitialized = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespaceV2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AccessChannel accessChannel = AccessChannel.LOCAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从命名服务拉取主题（topic）信息的间隔，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int pollNameServerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//与Broker的长连接的心跳周期，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int heartbeatBrokerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Offset persistent interval for consumer&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int persistConsumerOffsetInterval = 1000 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String unitName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeReadBody = Boolean.parseBoolean(System.getProperty(DECODE_READ_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeDecompressBody = Boolean.parseBoolean(System.getProperty(DECODE_DECOMPRESS_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean vipChannelEnabled = Boolean.parseBoolean(System.getProperty(SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useHeartbeatV2 = Boolean.parseBoolean(System.getProperty(HEART_BEAT_V2, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useTLS = TlsSystemConfig.tlsEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String socksProxyConfig = System.getProperty(SOCKS_PROXY_CONFIG, &quot;{}&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int mqClientApiTimeout = 3 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectTimeout = 200;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectInterval = 2 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LanguageCode language = LanguageCode.JAVA;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable stream request type will inject a RPCHook to add corresponding request type to remoting layer.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * And it will also generate a different client id to prevent unexpected reuses of MQClientInstance.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean enableStreamRequestType = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable the fault tolerance mechanism of the client sending process.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * DO NOT OPEN when ORDER messages are required.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Turning on will interfere with the queue selection functionality,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * possibly conflicting with the order message.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean sendLatencyEnable = Boolean.parseBoolean(System.getProperty(SEND_LATENCY_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean startDetectorEnable = Boolean.parseBoolean(System.getProperty(START_DETECTOR_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean enableHeartbeatChannelEventListener = true;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="80" width="520" height="680" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.038;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="daRG9VKHfTEQrqkJZzFC-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;DefaultMQPushConsumer&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这里的大多数功能都委托给了它。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;protected final transient DefaultMQPushConsumerImpl &lt;b&gt;defaultMQPushConsumerImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 相同角色的消费者必须具有完全相同的订阅和消费组才能正确实现负载均衡。这是必需的，并且需要全局唯一。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;consumerGroup&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消息模型定义了消息传递到每个消费者客户端的方式。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// RocketMQ 支持两种消息模型：集群和广播。如果设置为集群，具有相同 {@link #consumerGroup} 的消费者客户端&lt;b&gt;只会消费订阅消息的部分&lt;/b&gt;，这实现了负载均衡；相反，如果设置为广播，每个消费者客户端将分别消费所有订阅的消息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此字段默认为集群。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageModel &lt;b&gt;messageModel&lt;/b&gt; = MessageModel.CLUSTERING;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消费者启动时的消费点。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 有三种消费点：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_LAST_OFFSET：消费者客户端从上次停止的地方继续。如果这是一个新启动的消费者客户端，根据消费组的老化情况，有两种情况：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; 如果消费组创建得如此之近，以至于最早订阅的消息尚未过期，这意味着消费组代表最近启动的业务，消费将从头开始；&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; 如果最早订阅的消息已过期，消费将从最新消息开始，这意味着在启动时间戳之前生成的消息将被忽略。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_FIRST_OFFSET：消费者客户端将从最早的可用消息开始。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_TIMESTAMP：消费者客户端将从指定的时间戳开始，这意味着在 {@link #consumeTimestamp} 之前生成的消息将被忽略。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private ConsumeFromWhere &lt;b&gt;consumeFromWhere&lt;/b&gt; = ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 精确到秒的回溯消费时间。时间格式为 20131223171201&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 意味着2013年12月23日17点12分01秒&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 默认回溯消费时间为半小时前。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String consumeTimestamp = UtilAll.timeMillisToHumanString3(System.currentTimeMillis() - (1000 * 60 * 30));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 指定消息队列如何分配给每个消费者客户端的队列分配算法。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private AllocateMessageQueueStrategy &lt;b&gt;allocateMessageQueueStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 订阅关系。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private Map&amp;lt;String /* topic */, String /* sub expression */&amp;gt; &lt;b&gt;subscription&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消息监听器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageListener &lt;b&gt;messageListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 如果消息队列分配更改，则调用的侦听器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageQueueListener &lt;b&gt;messageQueueListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 偏移量存储。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private OffsetStore &lt;b&gt;offsetStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 最小消费者线程数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeThreadMin&lt;/b&gt; = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 最大消费者线程数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeThreadMax&lt;/b&gt; = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 动态调整线程池数量的阈值。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long &lt;b&gt;adjustThreadPoolNumsThreshold&lt;/b&gt; = 100000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 同时最大跨度偏移量。它对顺序消费没有影响。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeConcurrentlyMaxSpan&lt;/b&gt; = 2000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 队列级别流量控制阈值，默认情况下，每个消息队列最多缓存1000条消息，考虑 {@code pullBatchSize}，瞬时值可能超过限制。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdForQueue&lt;/b&gt; = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 队列级别流量控制阈值，意味着等待确认确认的最大消息数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 与拉取阈值相反，一旦消息被弹出，它就被视为消费的开始。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;popThresholdForQueue&lt;/b&gt; = 96;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 限制队列级别上缓存的消息大小，默认情况下，每个消息队列最多缓存100 MiB消息，考虑 {@code pullBatchSize}，瞬时值可能超过限制。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdSizeForQueue&lt;/b&gt; = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主题级别流量控制阈值，默认值为-1（无限制）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// {@code pullThresholdForQueue} 的值将被重写，并基于 {@code pullThresholdForTopic} 计算，如果它不是无限的。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 例如，如果 pullThresholdForTopic 的值为1000，并且有10个消息队列分配给此消费者，则 pullThresholdForQueue 将设置为100。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;private int &lt;b&gt;pullThresholdForTopic&lt;/b&gt; = -1;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主题级别限制缓存的消息大小，默认值为-1 MiB（无限制）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// {@code pullThresholdSizeForQueue} 的值将被重写，并基于 {@code pullThresholdSizeForTopic} 计算，如果它不是无限的。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 例如，如果 pullThresholdSizeForTopic 的值为1000 MiB，并且有10个消息队列分配给此消费者，则 pullThresholdSizeForQueue 将设置为100 MiB。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdSizeForTopic&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息拉取间隔。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long pullInterval = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量消费大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int consumeMessageBatchMaxSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量拉取大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int pullBatchSize = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量拉取字节大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int pullBatchSizeInBytes = 256 * 1024;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 是否在每次拉取时更新订阅关系。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean postSubscriptionWhenPull = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 是否是订阅组的单位。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 最大重新消费次数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 在并发模式下，-1表示16；&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 在有序模式下，-1表示Integer.MAX_VALUE。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 如果消息在成功之前重新消费超过 {@link #maxReconsumeTimes} 次。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int maxReconsumeTimes = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 需要慢拉取的情况（如流量控制场景）的暂停拉取时间。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long suspendCurrentQueueTimeMillis = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息阻塞消费线程的最大时间（分钟）。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long consumeTimeout = 15;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息的最大不可见时间（毫秒），范围是 [5000, 300000]。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long popInvisibleTime = 60000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量弹出大小，范围是 [1, 32]。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int popBatchNums = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 关闭消费者时等待消息消费的最大时间，0表示不等待。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long awaitTerminationMillisWhenShutdown = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 异步传输数据的接口。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private TraceDispatcher traceDispatcher = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 强制使用客户端负载均衡。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean clientRebalance = true;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="800" width="520" height="1200" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-1" target="daRG9VKHfTEQrqkJZzFC-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-1" value="&lt;div style=&quot;&quot;&gt;this(consumerGroup, null, new &lt;b&gt;AllocateMessageQueueAveragely&lt;/b&gt;());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;消息队列分配算法，todo&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-3" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;this.&lt;b&gt;consumerGroup&lt;/b&gt; = consumerGroup;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;allocateMessageQueueStrategy&lt;/b&gt; = allocateMessageQueueStrategy;&lt;/div&gt;&lt;div&gt;defaultMQPushConsumerImpl = new &lt;b&gt;DefaultMQPushConsumerImpl&lt;/b&gt;(this, rpcHook);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;DefaultMQPushConsumerImpl才是实际的消费者实例&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="80" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.428;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="daRG9VKHfTEQrqkJZzFC-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.56;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="daRG9VKHfTEQrqkJZzFC-33">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1690" y="1158" />
              <mxPoint x="-1690" y="1020" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQPushConsumerImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Flow control interval when message cache is full&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_CACHE_FLOW_CONTROL = 50;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//Flow control interval when broker return flow control&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_BROKER_FLOW_CONTROL = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//Delay some time when suspend pull service&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_SUSPEND = 1000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long BROKER_SUSPEND_MAX_TIME_MILLIS = 1000 * 15;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//所属&amp;nbsp;DefaultMQPushConsumer&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumer &lt;b&gt;defaultMQPushConsumer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceImpl &lt;b&gt;rebalanceImpl&lt;/b&gt; = new RebalancePushImpl(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;FilterMessageHook&amp;gt; filterMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long consumerStartTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;ConsumeMessageHook&amp;gt; consumeMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile ServiceState &lt;b&gt;serviceState&lt;/b&gt; = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//MQ客户端实例（Netty客户端），消费者实例 DefaultMQPushConsumerImpl&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp;和 MQClientInstance 一对一&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQClientInstance &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private PullAPIWrapper pullAPIWrapper;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean pause = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean consumeOrderly = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即用户定义的消息监听器，和 DefaultMQPushConsumer 的 messageListener 是同一个对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MessageListener &lt;b&gt;messageListenerInner&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费偏移量记录&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private OffsetStore &lt;b&gt;offsetStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsumeMessageService consumeMessageService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsumeMessageService consumeMessagePopService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long queueFlowControlTimes = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long queueMaxSpanFlowControlTimes = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int[] popDelayLevel = new int[] {10, 30, 60, 120, 180, 240, 300, 360, 420, 480, 540, 600, 1200, 1800, 3600, 7200};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MAX_POP_INVISIBLE_TIME = 300000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MIN_POP_INVISIBLE_TIME = 5000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int ASYNC_TIMEOUT = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// only for test purpose, will be modified by reflection in unit test.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@SuppressWarnings(&quot;FieldMayBeFinal&quot;)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static boolean doNotUpdateTopicSubscribeInfoWhenSubscriptionChanged = false;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1680" y="800" width="520" height="640" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-6" value="&lt;div&gt;SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(topic, subExpression);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录对主题订阅的详细信息（匹配表达式和表达式类型）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;rebalanceImpl&lt;/b&gt;.&lt;b&gt;getSubscriptionInner&lt;/b&gt;().put(topic, subscriptionData);&lt;/div&gt;&lt;div&gt;if (this.mQClientFactory != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-8" target="daRG9VKHfTEQrqkJZzFC-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RebalancePushImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="800" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RebalanceImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;MessageQueue, ProcessQueue&amp;gt; processQueueTable = new ConcurrentHashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;MessageQueue, PopProcessQueue&amp;gt; popProcessQueueTable = new ConcurrentHashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;String/* topic */, Set&amp;lt;MessageQueue&amp;gt;&amp;gt; topicSubscribeInfoTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录某个消费者订阅主题的详细信息（比如匹配表达式及表达式类型（TAG、SQL92）等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;String /* topic */, SubscriptionData&amp;gt; &lt;b&gt;subscriptionInner&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String consumerGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MessageModel messageModel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AllocateMessageQueueStrategy allocateMessageQueueStrategy;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MQClientInstance mQClientFactory;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int TIMEOUT_CHECK_TIMES = 3;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int QUERY_ASSIGNMENT_TIMEOUT = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; topicBrokerRebalance = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; topicClientRebalance = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="480" width="520" height="280" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-11" target="daRG9VKHfTEQrqkJZzFC-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-11" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;setConsumerGroup&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;NamespaceUtil.wrapNamespace(&lt;br style=&quot;font-size: 10px;&quot;&gt;this.getNamespace(),&lt;br style=&quot;font-size: 10px;&quot;&gt;this.consumerGroup));&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;设置消费者组，加上命名空间如果有的话&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-13" target="daRG9VKHfTEQrqkJZzFC-17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-13" value="this.&lt;b&gt;defaultMQPushConsumerImpl&lt;/b&gt;&lt;br&gt;.&lt;b&gt;start&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="550" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="daRG9VKHfTEQrqkJZzFC-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-28" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" vertex="1" connectable="0" parent="daRG9VKHfTEQrqkJZzFC-27">
          <mxGeometry x="0.0058" y="-3" relative="1" as="geometry">
            <mxPoint x="5" y="-208" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="4NOqHYvpeDZbVOTjX4TA-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-10" value="5" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="4NOqHYvpeDZbVOTjX4TA-9">
          <mxGeometry x="0.9362" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-15" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.serviceState = ServiceState.START_FAILED;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//检查一堆配置参数是否设置有误&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.checkConfig();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;//从 DefaultMQPushConsumer 拷贝订阅数据到 DefaultMQPushConsumerImpl 实例&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.copySubscription();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //重新命名当前消费者实例名称， DEFAULT -&amp;gt; PID#System.nanoTime(), 比如&quot;155762#69266371992577&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.changeInstanceNameToPID();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 从 MQClientManager.factoryTable 获取或者创建 MQClientInstance，&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//&amp;nbsp; &amp;nbsp;这里只是创建像内部的Netty客户端还没有启动&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;mQClientFactory&lt;/b&gt; = MQClientManager.getInstance().&lt;b&gt;getOrCreateMQClientInstance&lt;/b&gt;(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer, this.rpcHook);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//继续从 DefaultMQPushConsumer 拷贝一些数据到 DefaultMQPushConsumerImpl.rebalanceImpl&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setAllocateMessageQueueStrategy(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.pullAPIWrapper == null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.pullAPIWrapper = new PullAPIWrapper(&lt;span style=&quot;background-color: initial;&quot;&gt;mQClientFactory,&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//2 消费偏移量记录，广播模式和集群模式使用不同的记录方式&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.defaultMQPushConsumer.getOffsetStore() != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; switch (this.defaultMQPushConsumer.getMessageModel()) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case BROADCASTING:&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.offsetStore = new &lt;b&gt;LocalFileOffsetStore&lt;/b&gt;(this.mQClientFactory, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case CLUSTERING:&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.offsetStore = new &lt;b&gt;RemoteBrokerOffsetStore&lt;/b&gt;(this.mQClientFactory, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.offsetStore.&lt;b&gt;load&lt;/b&gt;(); &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//RemoteBrokerOffsetStore此方法为空&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//这个内部消息监听器就是用自定义的消息消费监听器&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.&lt;b&gt;getMessageListenerInner&lt;/b&gt;() instanceof &lt;b&gt;MessageListenerOrderly&lt;/b&gt;) { &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//顺序消费&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; ... //暂时没用到这个类型，暂略&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else if (this.getMessageListenerInner() instanceof &lt;b&gt;MessageListenerConcurrently&lt;/b&gt;) { &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//异步消费&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeOrderly = false;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeMessageService =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ConsumeMessageConcurrentlyService&lt;/b&gt;(this,&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;(MessageListenerConcurrently) this.getMessageListenerInner());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeMessagePopService =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ConsumeMessagePopConcurrentlyService&lt;/b&gt;(this,&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;(MessageListenerConcurrently) this.getMessageListenerInner());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 启动消息消费相关服务&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.consumeMessageService.start();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.consumeMessagePopService.start();&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 向MQ客户端实例中注册消费者&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;boolean registerOK = mQClientFactory.&lt;b&gt;registerConsumer&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup(), this);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (!registerOK) {&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //注册失败&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.CREATE_JUST;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeMessageService.shutdown(defaultMQPushConsumer&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getAwaitTerminationMillisWhenShutdown());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; throw new MQClientException(...);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//5 启动MQ客户端实例（主要就是启动内部的Netty客户端、定时任务、消息推送服务、负载均衡服务）&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;mQClientFactory.&lt;b&gt;start&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.serviceState = ServiceState.&lt;b&gt;RUNNING&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//%RETRY%xxx主题的作用 todo&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.getSubscriptionInner().put(retryTopic, subscriptionData);&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1000" y="160" width="440" height="840" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-17" target="daRG9VKHfTEQrqkJZzFC-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-20" value="CREATE_JUST" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="daRG9VKHfTEQrqkJZzFC-19">
          <mxGeometry x="-0.1" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-17" target="daRG9VKHfTEQrqkJZzFC-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-17" value="serviceState" style="rhombus;whiteSpace=wrap;html=1;fontSize=11;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="760" y="550" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-21" target="BSc7MQy5KmO-H20q9Lak-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="BSc7MQy5KmO-H20q9Lak-2">
          <mxGeometry x="0.6711" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-21" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 执行一次主题订阅信息更新：遍历当前消费者实例所以订阅关系中所有主题Topic，从Namesrv更新主题的路由信息&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.updateTopicSubscribeInfoWhenSubscriptionChanged();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.mQClientFactory.checkClientInBroker();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 发送心跳成功就立即执行一次再均衡&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.mQClientFactory.&lt;b&gt;rebalanceImmediately&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="680" y="1020" width="280" height="120" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-23" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientManager&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance ProduceAccumulator 的容器，单例模式&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger factoryIndexGenerator = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端容器的Map clientId （节点IP@进程ID#客户端创建nanoTime）-&amp;gt; MQClientInstance&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;一个业务服务实例可能有多个客户端实例&lt;/b&gt;(clientId只是创建时间不同）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-1680" y="1480" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQ客户端实例，这个实例既可能是生产者也可能是消费者还可能都是&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 锁定超时时间，毫秒为单位。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 日志记录器。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static Logger log = LoggerFactory.getLogger(MQClientInstance.class);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 客户端配置。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientConfig clientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 客户端ID（格式：&lt;b&gt;当前节点IP@实例名instanceName&lt;/b&gt;）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;clientId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 启动时间戳。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long bootTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前客户端的生产者容器，键是生产者组的名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQProducerInner&amp;gt; &lt;b&gt;producerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前客户端的消费者容器，键是消费者组的名称，值实际是 DefaultMQPushConsumerImpl&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQConsumerInner&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;consumerTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 当前客户端的adminExt容器，键是adminExt组的名称。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQAdminExtInner&amp;gt; adminExtTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// Netty客户端配置。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// MQ客户端API实现，本质是Netty客户端，每个客户端实例一个Netty客户端实例名&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQClientAPIImpl &lt;b&gt;mQClientAPIImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// MQ管理器实现。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQAdminImpl &lt;b&gt;mQAdminImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 主题路由数据表。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, TopicRouteData&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 主题终端点表。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, ConcurrentMap&amp;lt;MessageQueue, String /*brokerName*/&amp;gt;&amp;gt; &lt;b&gt;topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 名称服务锁。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockNamesrv = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 心跳锁。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockHeartbeat = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 存储代理集群信息的容器。映射的键是代理集群名称。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 值是属于代理集群的代理实例列表。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 对于子映射，键是单个代理实例的ID，值是地址。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 代理版本表。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Broker Name */, HashMap&amp;lt;String /* address */, Integer&amp;gt;&amp;gt; brokerVersionTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 支持v2心跳的代理集合。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String /* Broker address */&amp;gt; brokerSupportV2HeartbeatSet = new HashSet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 代理地址心跳指纹表。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Integer&amp;gt; brokerAddrHeartbeatFingerprintTable = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 定时任务线程池，启动时向这个线程池提交了5个定时任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = Executors.newSingleThreadScheduledExecutor(r -&amp;gt; new Thread(r, &quot;MQClientFactoryScheduledThread&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 拉取远程配置执行服务。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService fetchRemoteConfigExecutorService = Executors.newSingleThreadScheduledExecutor(new ThreadFactory() {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; @Override&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; public Thread newThread(Runnable r) {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new Thread(r, &quot;MQClientFactoryFetchRemoteConfigScheduledThread&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;});&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 拉消息服务。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullMessageService pullMessageService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 重新平衡服务。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceService rebalanceService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 默认的消息生产者。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer defaultMQProducer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 消费者统计管理器。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConsumerStatsManager consumerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 发送心跳总次数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 服务状态。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 随机数生成器。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="1480" width="520" height="960" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-25" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProduceAccumulator&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance ProduceAccumulator 的容器，单例模式&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger factoryIndexGenerator = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="2480" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-26" target="daRG9VKHfTEQrqkJZzFC-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-26" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;instance = new &lt;b style=&quot;font-size: 10px;&quot;&gt;MQClientInstance&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;clientConfig.cloneClientConfig(),&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;this&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;.factoryIndexGenerator.getAndIncrement(),&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;clientId, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" vertex="1" parent="1">
          <mxGeometry x="1480" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" edge="1" parent="1" source="daRG9VKHfTEQrqkJZzFC-29" target="daRG9VKHfTEQrqkJZzFC-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-29" value="ClientRemotingProcessor clientRemotingProcessor = new&amp;nbsp;ClientRemotingProcessor(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//监听 Netty onChannelActive 用于发送心跳给Broker， todo&lt;/font&gt;&lt;br&gt;channelEventListener = new ChannelEventListener() {...}&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 封装的Netty客户端（NettyRemotingClient）&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt; = new &lt;b&gt;MQClientAPIImpl&lt;/b&gt;(this.nettyClientConfig,&amp;nbsp; &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; clientRemotingProcessor, rpcHook, clientConfig, channelEventListener);&lt;br&gt;this.mQClientAPIImpl.updateNameServerAddressList(this.clientConfig.getNamesrvAddr());&lt;br&gt;&lt;div&gt;this.clientId = clientId;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 MQ管理接口，也是借助Netty客户端实现，与Broker Namesrv通信&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mQAdminImpl&lt;/b&gt; = new MQAdminImpl(this);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//主动拉取消息的服务&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;pullMessageService&lt;/b&gt; = new PullMessageService(this);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//负载均衡服务&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;rebalanceService&lt;/b&gt; = new RebalanceService(this);&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//测试服务只是消费消息&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;为何默认创建一个生产者？todo 这个生产者什么用？重试？&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;this.&lt;b&gt;defaultMQProducer&lt;/b&gt; = new &lt;b&gt;DefaultMQProducer&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; MixAll.CLIENT_INNER_PRODUCER_GROUP);&lt;/div&gt;&lt;div&gt;this.defaultMQProducer.resetClientConfig(clientConfig);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;consumerStatsManager&lt;/b&gt; = new ConsumerStatsManager(this.scheduledExecutorService);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1720" y="160" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-31" value="this.remotingClient = new &lt;b style=&quot;font-size: 10px;&quot;&gt;NettyRemotingClient&lt;/b&gt;(nettyClientConfig, &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; channelEventListener);&lt;br&gt;this.clientRemotingProcessor = clientRemotingProcessor;&lt;br&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;this.remotingClient.registerRPCHook(new NamespaceRpcHook(clientConfig));&lt;br&gt;this.remotingClient.registerRPCHook(rpcHook);&lt;br&gt;&lt;div&gt;this.remotingClient.registerRPCHook(new DynamicalExtFieldRPCHook());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//其实就是注册一组 Netty ChannelHandler，todo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.CHECK_TRANSACTION_STATE, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.NOTIFY_CONSUMER_IDS_CHANGED, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.RESET_CONSUMER_CLIENT_OFFSET, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_STATUS_FROM_CLIENT, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_RUNNING_INFO, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.CONSUME_MESSAGE_DIRECTLY, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT, this.clientRemotingProcessor, null);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2200" y="160" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-33" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RemoteBrokerOffsetStore&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;集群消息模式使用的消费偏移量记录，集群模式是所有匹配的消费者分摊消息进行消费&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属MQClientInstance&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQClientInstance &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;groupName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;MessageQueue, ControllableOffset&amp;gt; offsetTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="920" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-2" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;DefaultMQPushConsumer 和&amp;nbsp;DefaultMQPushConsumerImpl &lt;br&gt;之间有很多冗余的字段（相同的字段及值）&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-290" y="740" width="290" height="40" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4NOqHYvpeDZbVOTjX4TA-3" target="4NOqHYvpeDZbVOTjX4TA-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-3" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;消费者消费消息&lt;br&gt;消费阶段&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-5" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-7" value="&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;由启动流程分析，消费阶段&lt;br&gt;消息一定是通过Netty客户端推送过来&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="40" y="1140" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="4NOqHYvpeDZbVOTjX4TA-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-13" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="4NOqHYvpeDZbVOTjX4TA-12">
          <mxGeometry x="0.8454" y="-1" relative="1" as="geometry">
            <mxPoint y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="4NOqHYvpeDZbVOTjX4TA-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-16" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="4NOqHYvpeDZbVOTjX4TA-15">
          <mxGeometry x="0.8776" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="4NOqHYvpeDZbVOTjX4TA-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-25" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="4NOqHYvpeDZbVOTjX4TA-24">
          <mxGeometry x="0.9269" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-8" value="&lt;div&gt;synchronized (this) { &lt;font color=&quot;#007fff&quot;&gt;//防止重复启动&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; switch (this.serviceState) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case CREATE_JUST:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.&lt;b&gt;START_FAILED&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == this.clientConfig.getNamesrvAddr()) {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.mQClientAPIImpl.fetchNameServerAddr();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //1 启动NettyRemotingClient客户端&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //2 启动计划任务（5个）&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;startScheduledTask&lt;/b&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //3 启动消息拉取服务（主动拉模式），这是一个线程&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;pullMessageService&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //4 启动负载均衡服务，这是一个线程&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;rebalanceService&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//5 启动前面创建的生产者, 流程参考生产者流程图&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQProducer.&lt;b&gt;getDefaultMQProducerImpl&lt;/b&gt;().&lt;b&gt;start&lt;/b&gt;(false);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.&lt;b&gt;RUNNING&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case START_FAILED:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new MQClientException(...));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="1480" y="680" width="360" height="320" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-11" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;向MQClientInstance.scheduledExecutorService提交了5个任务：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;更新命名服务的地址信息&lt;/b&gt;，每2分钟执行一次&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.mQClientAPIImpl.&lt;b&gt;fetchNameServerAddr&lt;/b&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;从命名服务更新主题路由信息&lt;/b&gt;，每 ClientConfig.&lt;span style=&quot;background-color: initial;&quot;&gt;pollNameServerInterval ms执行一次&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;();&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;清理掉线的Broker已经向所有Broker发送心跳&lt;/b&gt;，每 ClientConfig.heartbeatBrokerInterval ms执行一次&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;cleanOfflineBroker&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;持久化所有消费者消费偏移量&lt;/b&gt;，每 ClientConfig.persistConsumerOffsetInterval ms执行一次&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;persistAllConsumerOffset&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;/&lt;b&gt;/调整线程池？&lt;/b&gt;每分钟执行一次&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;MQClientInstance.this.&lt;b&gt;adjustThreadPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;verticalAlign=top;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1880" y="680" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4NOqHYvpeDZbVOTjX4TA-14">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2320" y="970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-14" value="&lt;div&gt;while (!this.isStopped()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageRequest messageRequest = this.&lt;b&gt;messageRequestQueue&lt;/b&gt;.&lt;b&gt;take&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (messageRequest.getMessageRequestMode() == MessageRequestMode.&lt;b&gt;POP&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;popMessage&lt;/b&gt;((PopRequest) messageRequest);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;pullMessage&lt;/b&gt;((PullRequest) messageRequest);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (InterruptedException ignored) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (Exception e) {&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;即此线程不断轮询，以阻塞方式从 messageRequestQueue 读取消息请求，然后根据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;请求模式选择调用 DefaultMQPushConsumerImpl 的 pullMessage() 还是 popMessage()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;todo&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1880" y="880" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-21" value="PullMessageService.&lt;br&gt;&lt;b&gt;messageRequestQueue&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="2320" y="940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-22" value="&lt;div&gt;while (!this.isStopped()) {&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;this.waitForRunning(realWaitInterval);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; boolean balanced = this.mqClientFactory.&lt;b&gt;doRebalance&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;即此线程不断轮询, 每隔一段时间重新调用一下 MQClientInstance#doRebalance()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;todo 做了什么？为何不直接提交到 ScheduledExecutorService 而是用AQS实现CountDownLatch2？&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1880" y="1080" width="400" height="140" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-23" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1605" y="650" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="BSc7MQy5KmO-H20q9Lak-1" target="BSc7MQy5KmO-H20q9Lak-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;this.mQClientFactory&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;topic);&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=12;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1020" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-5" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过 NettyRemotingClient 向 Namesrv 发送 GET_ROUTEINFO_BY_TOPIC 请求&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;topicRouteData = this.mQClientAPIImpl.&lt;b&gt;getTopicRouteInfoFromNameServer&lt;/b&gt;(topic, &lt;br&gt;&amp;nbsp; &amp;nbsp; clientConfig.getMqClientApiTimeout());&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1020" width="439" height="50" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
