<mxfile host="Electron" modified="2024-12-24T06:40:10.878Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="yooGT5wyrkYGPna-P4Ev" version="21.6.5" type="device" pages="4">
  <diagram name="Producer" id="6497DEjvEHfmiQGX_mvA">
    <mxGraphModel dx="5569" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="UuV1s5uOwehbHIiCa4GY-88" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontColor=#007FFF;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="UuV1s5uOwehbHIiCa4GY-61" target="UuV1s5uOwehbHIiCa4GY-73" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2620" y="1070" as="targetPoint" />
            <Array as="points">
              <mxPoint x="3490" y="1640" />
              <mxPoint x="3490" y="1070" />
              <mxPoint x="2660" y="1070" />
              <mxPoint x="2660" y="1040" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;RocketMQ工作原理（5.2.0）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;测试代码：官方源码 example 模块，源码启动 NameServer、Broker参考MD文档；&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;这里流程图包含四部分：Producer、NameServer、Broker、Consumer；&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;RocketMQ代码量很大（30W），这里会忽略一些细节，推荐结合《RocketMQ技术内幕》看源码，因为内部组件实在是太多了（尤其是Broker），需要清楚哪些是核心功能，忽略掉不重要的内容，不然很难有耐心看下去。&lt;br&gt;这页展示&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;生产者(Producer)&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;发送消息的逻辑（包括同步监听确认消息）；其他部分在其他页面中展示；&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;Producer 包括多种消息发送方式。&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="660" height="130" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="jejXhYi2k6KOZK20mIr--3" target="jejXhYi2k6KOZK20mIr--12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--3" value="生产者发送消息&lt;br style=&quot;font-size: 12px;&quot;&gt;启动阶段" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--4" target="jejXhYi2k6KOZK20mIr--30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--4" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;同步发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--5" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;批量发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;定时发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--7" target="LpHP1XivYoPNuTlPqCnb-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--7" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;顺序发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--8" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送单向消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--9" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送广播消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="3020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--12" target="jejXhYi2k6KOZK20mIr--17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--12" target="jejXhYi2k6KOZK20mIr--27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--12" value="DefaultMQProducer producer = new &lt;b&gt;DefaultMQProducer&lt;/b&gt;(&lt;font style=&quot;font-size: 9px;&quot;&gt;PRODUCER_GROUP&lt;/font&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.064;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="c61HgKpTzqy5PhA1b_MH-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--15" target="jejXhYi2k6KOZK20mIr--20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducer&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;就是封装了一些额外配置信息的 DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个才是消息生产者的核心&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;protected final transient DefaultMQProducerImpl &lt;b&gt;defaultMQProducerImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private final Set&amp;lt;Integer&amp;gt; retryResponseCodes = new CopyOnWriteArraySet&amp;lt;&amp;gt;(Arrays.asList(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.TOPIC_NOT_EXIST,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SERVICE_NOT_AVAILABLE,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SYSTEM_ERROR,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_PERMISSION,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_BUYER_ID,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NOT_IN_CURRENT_UNIT&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 生产者组概念上聚合了完全相同角色的所有生产者实例，特别是在涉及事务消息时尤为重要。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 对于非事务性消息，只要每个进程是唯一的就可以。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 有关更多讨论，请参见 https://rocketmq.apache.org/docs/introduction/02concepts。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b&gt;producerGroup&lt;/b&gt;; // 生产者组&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 需要为事务生产者初始化的主题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private List&amp;lt;String&amp;gt; &lt;b&gt;topics&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 仅用于测试或演示程序&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认主题创建的队列数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private volatile int defaultTopicQueueNums = 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 发送消息的超时时间。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int sendMsgTimeout = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 压缩消息体阈值，即，默认情况下，大于4k的消息体将被压缩。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int compressMsgBodyOverHowmuch = 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在同步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendAsyncFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在发送失败时内部是否重试另一个代理。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean retryAnotherBrokerWhenNotStoreOK = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 允许的最大消息体大小（以字节为单位）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int maxMessageSize = 1024 * 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 异步传输数据的接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private TraceDispatcher traceDispatcher = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量消息的开关标志实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean autoBatch = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量处理消息的实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private ProduceAccumulator &lt;b&gt;produceAccumulator&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 指示当异步发送流量过大时是否阻塞消息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean enableBackpressureForAsyncMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大数量。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 10000。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendNum = 10000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大消息大小。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 100M。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendSize = 100 * 1024 * 1024;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-560" y="840" width="520" height="680" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--17" target="jejXhYi2k6KOZK20mIr--21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--17" value="defaultMQProducerImpl = new &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;(this, null);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--19" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY = &quot;com.rocketmq.sendMessageWithVIPChannel&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SOCKS_PROXY_CONFIG = &quot;com.rocketmq.socks.proxy.config&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_READ_BODY = &quot;com.rocketmq.read.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_DECOMPRESS_BODY = &quot;com.rocketmq.decompress.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_LATENCY_ENABLE = &quot;com.rocketmq.sendLatencyEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String START_DETECTOR_ENABLE = &quot;com.rocketmq.startDetectorEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HEART_BEAT_V2 = &quot;com.rocketmq.heartbeat.v2&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接的NameServer地址（IP+端口）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//生产者的客户端IP&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String clientIP = NetworkUtil.getLocalAddress();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端实例名，默认“DEFAULT”，“DEFAULT”&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面在启动时会被替换为 PID#当前纳秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;instanceName&lt;/b&gt; = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Deprecated&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespace;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean namespaceInitialized = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespaceV2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AccessChannel accessChannel = AccessChannel.LOCAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从命名服务拉取主题（topic）信息的间隔，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int pollNameServerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//与Broker的长连接的心跳周期，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int heartbeatBrokerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int persistConsumerOffsetInterval = 1000 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String unitName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeReadBody = Boolean.parseBoolean(System.getProperty(DECODE_READ_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeDecompressBody = Boolean.parseBoolean(System.getProperty(DECODE_DECOMPRESS_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo，默认false&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;vipChannelEnabled&lt;/b&gt; = Boolean.parseBoolean(&lt;br&gt;&amp;nbsp; &amp;nbsp; System.getProperty(SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useHeartbeatV2 = Boolean.parseBoolean(System.getProperty(HEART_BEAT_V2, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useTLS = TlsSystemConfig.tlsEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String socksProxyConfig = System.getProperty(SOCKS_PROXY_CONFIG, &quot;{}&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int mqClientApiTimeout = 3 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectTimeout = 200;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectInterval = 2 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LanguageCode language = LanguageCode.JAVA;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable stream request type will inject a RPCHook to add corresponding request type to remoting layer.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * And it will also generate a different client id to prevent unexpected reuses of MQClientInstance.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean enableStreamRequestType = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable the fault tolerance mechanism of the client sending process.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * DO NOT OPEN when ORDER messages are required.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Turning on will interfere with the queue selection functionality,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * possibly conflicting with the order message.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean sendLatencyEnable = Boolean.parseBoolean(System.getProperty(SEND_LATENCY_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean startDetectorEnable = Boolean.parseBoolean(System.getProperty(START_DETECTOR_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean enableHeartbeatChannelEventListener = true;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="40" width="520" height="760" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQProducer （I）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start() throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;List&amp;lt;MessageQueue&amp;gt; &lt;b&gt;fetchPublishMessageQueues&lt;/b&gt;(final String topic) throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//同步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;SendResult &lt;b&gt;send&lt;/b&gt;(...) throws MQClientException, RemotingException, MQBrokerException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;send&lt;/b&gt;(..., final SendCallback sendCallback) throws MQClientException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingException, InterruptedException, MQBrokerException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单向发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;sendOneway&lt;/b&gt;(final Message msg) throws MQClientException, RemotingException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务控制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TransactionSendResult &lt;b&gt;sendMessageInTransaction&lt;/b&gt;(final Message msg,&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Object arg) throws MQClientException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-560" y="40" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--21" value="produceAccumulator = &lt;b&gt;MQClientManager&lt;/b&gt;.getInstance()&lt;br&gt;.getOrCreateProduceAccumulator(this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--24" target="jejXhYi2k6KOZK20mIr--85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitX=0;exitY=0.595;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="jejXhYi2k6KOZK20mIr--24" target="wqeYftxfj8nTHo_Km6VP-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1130" y="1200" as="sourcePoint" />
            <mxPoint x="-1160" y="1540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.268;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="jejXhYi2k6KOZK20mIr--24" target="cpLEBUsnRFU8It5sHO4U-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1130" y="1238" />
              <mxPoint x="-1130" y="2160" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;核心类，DefaultMQProducerImpl 实现的是一个MQ客户端（MQClientInstance）上的某一分组的消息生产者&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random &lt;b&gt;random&lt;/b&gt; = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 DefaultMQProducer 实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//主题消息发布信息表，即某个主题的消息应该发给哪些Broker节点&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//每个主题对应一个TopicPublishInfo&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* topic */, &lt;b&gt;TopicPublishInfo&lt;/b&gt;&amp;gt; &lt;b&gt;topicPublishInfoTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;EndTransactionHook&amp;gt; endTransactionHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; asyncSenderThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService defaultAsyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected BlockingQueue&amp;lt;Runnable&amp;gt; checkRequestQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ExecutorService checkExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 这个实例是通过 MQClientManager 工厂创建的，同时也是当前DefautlMQProducerImpl 的容器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前 DefautlMQProducerImpl 只不过是 MQClientInstance 中的一个消息生产者（MQProducerInner&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;MQClientInstance&lt;/b&gt; &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ArrayList&amp;lt;CheckForbiddenHook&amp;gt; checkForbiddenHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQFaultStrategy &lt;b&gt;mqFaultStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService asyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// compression related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int compressLevel = Integer.parseInt(System.getProperty(MixAll.MESSAGE_COMPRESS_LEVEL, &quot;5&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompressionType compressType = CompressionType.of(System.getProperty(MixAll.MESSAGE_COMPRESS_TYPE, &quot;ZLIB&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Compressor compressor = CompressorFactory.getCompressor(compressType);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// backpressure related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendNum;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendSize;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1120" width="520" height="440" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--27" target="jejXhYi2k6KOZK20mIr--33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--27" value="producer.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--30" target="jejXhYi2k6KOZK20mIr--31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--30" value="Message msg = new Message(&lt;br&gt;&amp;nbsp; &amp;nbsp; TOPIC, TAG, bytes);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="280" y="2300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--31" target="RnVRpb9ZFMmRX4XW8d6o-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--31" target="jejXhYi2k6KOZK20mIr--148" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--31" value="&lt;div&gt;SendResult sendResult =&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; producer.send(msg, 20 * 1000);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;同步发送消息，发送超时时间20s&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--33" target="jejXhYi2k6KOZK20mIr--36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--33" value="this.setProducerGroup(&lt;br&gt;withNamespace(this.producerGroup));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在生产者分组上添加&lt;b&gt;命名空间&lt;/b&gt;信息，不指定命名空间默认为null,即不附加命名空间&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--36" target="jejXhYi2k6KOZK20mIr--38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--36" target="jejXhYi2k6KOZK20mIr--41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--36" value="this.&lt;b&gt;defaultMQProducerImpl&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;创建内部组件并启动&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--38" target="jejXhYi2k6KOZK20mIr--141" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--38" value="this.&lt;b&gt;produceAccumulator&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于支持&lt;b&gt;批量发送消息&lt;/b&gt;，accumulator: 蓄能器，比喻很贴切&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--41" target="jejXhYi2k6KOZK20mIr--44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--41" target="jejXhYi2k6KOZK20mIr--136" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--41" value="检查 this.serviceState 状态（即生产者客户端启动状态），有 CREATE_JUST、RUNNING、SHUTDOWN_ALREADY、START_FAILED 4种状态，仅仅&lt;b&gt;CREATE_JUST&lt;/b&gt; 会执行客户端启动流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--42" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="785" y="370" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--44" target="jejXhYi2k6KOZK20mIr--47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--44" value="修改启动状态 START_FAILED&lt;br&gt;检查生产者分组命名规范、修改客户端实例名（instanceName）" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--47" target="jejXhYi2k6KOZK20mIr--49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--47" target="jejXhYi2k6KOZK20mIr--61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--47" value="this.&lt;b&gt;mQClientFactory&lt;/b&gt; = MQClientManager.getInstance().&lt;br&gt;&lt;b&gt;getOrCreateMQClientInstance&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer, rpcHook);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建MQ客户端实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--49" target="jejXhYi2k6KOZK20mIr--52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--49" value="boolean registerOK = mQClientFactory.&lt;b&gt;registerProducer&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer.getProducerGroup(), this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance 同时是 MQProduceInner 的容器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="720" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--52" target="jejXhYi2k6KOZK20mIr--55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--52" target="jejXhYi2k6KOZK20mIr--69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--52" value="&lt;b&gt;if (startFactory)&lt;/b&gt;&lt;br&gt;&lt;b&gt;mQClientFactory&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;mQClientFactory 即上面的 MQClientInstance 实例，将启动其内部的各个组件&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--55" target="jejXhYi2k6KOZK20mIr--57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--55" target="jejXhYi2k6KOZK20mIr--70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--55" value="this.initTopicRoute();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--57" target="jejXhYi2k6KOZK20mIr--134" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--57" value="this.mqFaultStrategy.startDetector();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--86" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1720" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--61" target="jejXhYi2k6KOZK20mIr--89" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="510" />
              <mxPoint x="1460" y="590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--61" value="从 MQClientManager &lt;b&gt;factoryTable&lt;/b&gt; 中获取 &lt;b&gt;MQClientInstance&lt;/b&gt;, 不存在则创建&lt;br&gt;&lt;div&gt;instance = new &lt;b&gt;MQClientInstance&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;clientConfig.cloneClientConfig(),&lt;/div&gt;&lt;div&gt;this.factoryIndexGenerator.getAndIncrement(), &lt;b&gt;clientId&lt;/b&gt;, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1230" y="470" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="jejXhYi2k6KOZK20mIr--62" target="wqeYftxfj8nTHo_Km6VP-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--62" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;就是MQ客户端（MQClientInstance）&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;和 ProduceAccumulator 的容器, 同时也是它们的工厂&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger &lt;b&gt;factoryIndexGenerator&lt;/b&gt; = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;MQClientInstance&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;ProduceAccumulator&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public MQClientInstance getOrCreateMQClientInstance(...)&amp;nbsp;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public ProduceAccumulator getOrCreateProduceAccumulator(final ClientConfig clientConfig)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1600" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--63" value="MQClientInstance prev = this.factoryTable&lt;br&gt;.&lt;b&gt;putIfAbsent&lt;/b&gt;(clientId,instance);&lt;br&gt;if (prev != null)&amp;nbsp;instance = prev;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;前面还在迷惑为何没有加锁，原来是这里借助 putIfAbsent 原子操作实现的并发同步&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="1240" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--64" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;尽管这步之前可能同时有多个线程创建客户端实例&lt;br style=&quot;font-size: 10px;&quot;&gt;但是因为 putIfAbsent 是原子操作（见源码注释）&lt;br style=&quot;font-size: 10px;&quot;&gt;如果clientId键的值已经存在，会改回之前的值，&lt;br style=&quot;font-size: 10px;&quot;&gt;最终instance一定是最先创建的那个实例&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1450" y="640" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--68" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--69" target="jejXhYi2k6KOZK20mIr--73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--69" value="this.mQClientAPIImpl&lt;br&gt;.fetchNameServerAddr();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--70" value="List&amp;lt;String&amp;gt; topics = this.defaultMQProducer.getTopics();&lt;br&gt;topics.forEach(topic -&amp;gt; {&lt;br&gt;TopicPublishInfo topicPublishInfo = &lt;b&gt;tryToFindTopicPublishInfo&lt;/b&gt;(newTopic);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1870" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--71" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--73" target="jejXhYi2k6KOZK20mIr--76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--73" target="jejXhYi2k6KOZK20mIr--91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--73" value="this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--76" target="jejXhYi2k6KOZK20mIr--79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--76" target="jejXhYi2k6KOZK20mIr--120" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--76" value="this.&lt;b&gt;startScheduledTask&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一些定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--79" target="jejXhYi2k6KOZK20mIr--82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--79" target="jejXhYi2k6KOZK20mIr--128" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--79" value="this.&lt;b&gt;pullMessageService&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一个守护线程&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--82" target="jejXhYi2k6KOZK20mIr--84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--82" target="jejXhYi2k6KOZK20mIr--131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--82" value="this.&lt;b&gt;rebalanceService&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--84" target="jejXhYi2k6KOZK20mIr--41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="1810" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1460" y="1810" />
              <mxPoint x="1460" y="1850" />
              <mxPoint x="740" y="1850" />
              <mxPoint x="740" y="445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--84" value="this.defaultMQProducer&lt;br&gt;.&lt;b&gt;getDefaultMQProducerImpl&lt;/b&gt;().start(false);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&amp;nbsp;DefaultMQProducerImpl，即一个消息分组对应的消息生产者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--85" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQProducerInner&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;（I）&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1000" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--86" value="&lt;b&gt;clientId 生成规则&lt;/b&gt;： ClientIP@instanceName&lt;br&gt;@unitName@StreamRequestType&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;后面两部分可能没有，比如192.168.1.5@74854#15296806586016&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--87" value="&lt;b style=&quot;&quot;&gt;instanceName 命名规则&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;： 如果前面没有指定实例名（默认是DEFAULT）&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里会更改为 &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;PID#System.nanoTime()&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1210" y="410" width="350" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="jejXhYi2k6KOZK20mIr--88" target="jejXhYi2k6KOZK20mIr--96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--88" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientAPIImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认为true&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static boolean &lt;b&gt;sendSmartMsg&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;Boolean.parseBoolean(System.getProperty(&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;org.apache.rocketmq.client.sendSmartMsg&quot;, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;RemotingClient&lt;/b&gt; &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final TopAddressing topAddressing;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientRemotingProcessor clientRemotingProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String nameSrvAddr = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ClientConfig &lt;b&gt;clientConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; getNameServerAddressList()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public RemotingClient getRemotingClient()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String fetchNameServerAddr()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String onNameServerAddressChange(String namesrvAddress)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void start()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void shutdown()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createSubscriptionGroup(final String addr, final SubscriptionGroupConfig config,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis) throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;createTopic&lt;/b&gt;(final String addr, final String defaultTopic, final TopicConfig topicConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createPlainAccessConfig(final String addr, final PlainAccessConfig plainAccessConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void deleteAccessConfig(final String addr, final String accessKey, final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void updateGlobalWhiteAddrsConfig(final String addr, final String globalWhiteAddrs, String aclFileFullPath,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SendResult &lt;b&gt;sendMessage&lt;/b&gt;(...)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1280" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--89" value="实例化 MQClientInstance 内部组件，包括&lt;br&gt;&lt;b&gt;MQClientAPIImpl、mQAdminImpl、pullMessageService、rebalanceService、defaultMQProducer、consumerStatsManager&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--90" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--91" target="jejXhYi2k6KOZK20mIr--94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--91" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--92" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--94" target="jejXhYi2k6KOZK20mIr--97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--94" target="jejXhYi2k6KOZK20mIr--100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--94" value="Netty客户端Bootstrap初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里只关注后面pipeline中最后两个Handler&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#ea6b66&quot;&gt;奇怪暂时没有找到哪里启动连接，todo: 可能在其他类中获取Bootstrap并启动的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="jejXhYi2k6KOZK20mIr--96" target="jejXhYi2k6KOZK20mIr--106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-87" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="jejXhYi2k6KOZK20mIr--96" target="UuV1s5uOwehbHIiCa4GY-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--96" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends NettyRemotingAbstract implements &lt;b&gt;RemotingClient&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端，还保存了&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;Bootstrap&lt;/b&gt; &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup &lt;b&gt;eventLoopGroupWorker&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//每个MQ客户端中可能创建多个Bootstrp， cidr -&amp;gt; Bootstrap, 因为需要连接 NameServer 和 Broker&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; &lt;b&gt;bootstrapMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//当前服务节点与NameServer Broker 建立的Netty连接通道，addr(IP:port) -&amp;gt; ChannelWrapper&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; &lt;b&gt;channelTables&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定时任务执行器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HashedWheelTimer&lt;/b&gt; &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; &lt;b&gt;namesrvAddrList&lt;/b&gt; = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// RocketMQ 自定义事件的监听器，本质上是对ChannelHandler的补充，不过是异步执行的&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener &lt;b&gt;channelEventListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2800" y="1280" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-41" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;shape=flexArrow;endWidth=8.571428571428571;endSize=6.552380952380952;" parent="1" source="jejXhYi2k6KOZK20mIr--97" target="6dGxRPPGjoEmWPCBBTeT-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2450" y="930" />
              <mxPoint x="2450" y="930" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-70" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Netty ChannelPipeline&lt;/b&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="6dGxRPPGjoEmWPCBBTeT-41" vertex="1" connectable="0">
          <mxGeometry x="-0.0327" y="1" relative="1" as="geometry">
            <mxPoint x="7" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--97" value="&lt;div&gt;ch.pipeline().addLast(&lt;/div&gt;&lt;div&gt;nettyClientConfig.isDisableNettyWorkerGroup() ? null : defaultEventExecutorGroup,&lt;/div&gt;&lt;div&gt;new &lt;b&gt;NettyEncoder&lt;/b&gt;(), new &lt;b&gt;NettyDecoder&lt;/b&gt;(),&lt;/div&gt;&lt;div&gt;new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0, nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),&lt;/div&gt;&lt;div&gt;new &lt;b&gt;NettyConnectManageHandler&lt;/b&gt;(), new &lt;b&gt;NettyClientHandler&lt;/b&gt;());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="900" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--100" target="jejXhYi2k6KOZK20mIr--103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--100" target="jejXhYi2k6KOZK20mIr--108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--100" value="&lt;b&gt;nettyEventExecutor&lt;/b&gt;.start();&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&lt;b&gt;一个守护线程&lt;/b&gt;，线程阻塞读取自身eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;即生产者消费者模式，执行事件监听回调&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--101" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="jejXhYi2k6KOZK20mIr--103" target="jejXhYi2k6KOZK20mIr--105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--102" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--103" target="jejXhYi2k6KOZK20mIr--111" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--103" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;timer也是启动了一个线程，处理定义任务，这里提交了个TimerTask任务 3秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--104" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--105" target="jejXhYi2k6KOZK20mIr--112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--105" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里提交了个TimerTask任务 0秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--106" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreOneway;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreAsync;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; responseTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;&amp;gt; processorTable =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new HashMap&amp;lt;&amp;gt;(64);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于启动一个守护线程，线程阻塞读取eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; rpcHooks = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2800" y="1000" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--108" target="jejXhYi2k6KOZK20mIr--109" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--108" value="&lt;b&gt;NettyEventExecutor#run()&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事件监听回调，事件包括：IDLE、CLOSE、CONNET、EXCEPTION、ACTIVIE&lt;br&gt;这些事件是 RocketMQ中定义的&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--109" target="UuV1s5uOwehbHIiCa4GY-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--109" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;&quot;&gt;ChannelEventListener&lt;/b&gt; listener = NettyRemotingAbstract.this.getChannelEventListener();&lt;br style=&quot;&quot;&gt;while(!this.isStopped()) {&lt;br style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; NettyEvent event = this.&lt;b style=&quot;&quot;&gt;eventQueue&lt;/b&gt;.poll(&lt;br style=&quot;&quot;&gt;3000, TimeUnit.MILLISECONDS);&lt;br style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; //根据事件类型，做对应处理&lt;br style=&quot;&quot;&gt;&lt;/font&gt;&amp;nbsp; &amp;nbsp; ...&lt;br style=&quot;&quot;&gt;}&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=8;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2190" y="970" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--110" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;疑问：&lt;br&gt;1 为何实现HashedWheelTimer处理定时任务，不用JDK中现成的类？&lt;br&gt;2&amp;nbsp;DefaultEventExecutorGroup 线程池原理？&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1520" y="10" width="640" height="100" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--111" value="NettyRemotingClient.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this, 1000, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期调用scanResponseTable()扫描已弃用的请求并使其过期&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1050" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--112" value="NettyRemotingClient&lt;br&gt;.this.&lt;b&gt;scanAvailableNameSrv&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this,connectTimeoutMillis, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--113" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;即每秒处理一下 responseTable 中的超时请求&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2170" y="1075" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--114" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;即定期更新一下可用NameServer地址&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2170" y="1155" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--116" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--117" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--118" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--125" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--119" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--120" target="jejXhYi2k6KOZK20mIr--126" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--120" value="通过 this.scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleAtFixedRate&lt;/b&gt;() 一共提交了4个定时任务" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--121" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1280" y="790" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--122" value="MQClientInstance.this.mQClientAPIImpl&lt;br&gt;.&lt;b&gt;fetchNameServerAddr&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--123" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--124" value="MQClientInstance.this.&lt;b&gt;cleanOfflineBroker&lt;/b&gt;();&lt;br&gt;MQClientInstance.this&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--125" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;persistAllConsumerOffset&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--126" value="MQClientInstance.this.&lt;b&gt;adjustThreadPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--127" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--128" target="jejXhYi2k6KOZK20mIr--129" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--128" value="PullMessageService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--129" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;while:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageRequest messageRequest = this.&lt;b style=&quot;font-size: 9px;&quot;&gt;messageRequestQueue&lt;/b&gt;.take();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageRequest.&lt;b style=&quot;font-size: 9px;&quot;&gt;getMessageRequestMode&lt;/b&gt;() == MessageRequestMode.POP) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.popMessage((PopRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.pullMessage((PullRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1610" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--131" target="jejXhYi2k6KOZK20mIr--132" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--131" value="RebalanceService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--132" value="todo" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--133" value="&lt;font color=&quot;#007fff&quot;&gt;这里 defaultMQProducer 是内部Producer, 分组为 CLIENT_INNER_PRODUCER&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1795" width="450" height="30" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--134" value="this.serviceState = ServiceState.RUNNING;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--135" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--136" target="jejXhYi2k6KOZK20mIr--137" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--136" value="this.mQClientFactory&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--137" value="RequestFutureHolder.getInstance()&lt;br&gt;.&lt;b&gt;startScheduledTask&lt;/b&gt;(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动定时任务，用于每秒扫描一下过期请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--138" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RequestFutureHolder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final RequestFutureHolder INSTANCE = new RequestFutureHolder();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentHashMap&amp;lt;String, RequestResponseFuture&amp;gt; &lt;b&gt;requestFutureTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;DefaultMQProducerImpl&amp;gt; &lt;b&gt;producerSet&lt;/b&gt; = new HashSet&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--141" target="jejXhYi2k6KOZK20mIr--143" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--141" target="jejXhYi2k6KOZK20mIr--144" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--141" value="guardThreadForSyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行同步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--142" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jejXhYi2k6KOZK20mIr--143" target="jejXhYi2k6KOZK20mIr--145" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--143" value="guardThreadForAsyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行异步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--144" value="GuardForSyncSendService#run();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--145" value="GuardForAsyncSendService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--146" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Message&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;b&gt;topic&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;flag&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//一些约定好的属性KEY，更多参考 &lt;b&gt;MessageConst&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// KEYS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// TAGS， 即TAG表达式也是存储到 properties&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;DELAY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;WAIT&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;INSTANCE_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// BUYER_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_SEC&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELIVER_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; &lt;b&gt;properties&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息内容&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] &lt;b&gt;body&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务ID，用于事务消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;transactionId&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-560" y="2300" width="520" height="280" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--147" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--148" target="jejXhYi2k6KOZK20mIr--149" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--148" value="msg.setTopic(withNamespace(&lt;br&gt;&amp;nbsp; &amp;nbsp; msg.getTopic()));&lt;br&gt;return this.defaultMQProducerImpl.&lt;b&gt;send&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; msg, timeout);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//先在主题上加上命名空间再发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wqeYftxfj8nTHo_Km6VP-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jejXhYi2k6KOZK20mIr--149" target="wqeYftxfj8nTHo_Km6VP-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jejXhYi2k6KOZK20mIr--149" value="return this.&lt;b&gt;sendDefaultImpl&lt;/b&gt;(msg, CommunicationMode.&lt;b&gt;SYNC&lt;/b&gt;, null, timeout);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;异步发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-4" value="producer.shutdown();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="2460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-7" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;比如&lt;/b&gt;：&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;topic = &quot;TopicTest&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;flag = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;properties = {HashMap@2202}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;WAIT&quot; -&amp;gt; &quot;true&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//表示是否等待消息存储完毕&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;TAGS&quot; -&amp;gt; &quot;TagA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;body = {byte[16]@2193} [72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48]&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;transactionId = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-560" y="2580" width="440" height="110" as="geometry" />
        </mxCell>
        <mxCell id="RnVRpb9ZFMmRX4XW8d6o-8" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="785" y="2350" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="wqeYftxfj8nTHo_Km6VP-1" target="jejXhYi2k6KOZK20mIr--88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wqeYftxfj8nTHo_Km6VP-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQ客户端实例，这个实例既可能是生产者也可能是消费者还可能都是&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final static long LOCK_TIMEOUT_MILLIS = 3000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;// 客户端配置&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientConfig clientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 客户端ID（格式：&lt;b&gt;当前节点IP@实例名instanceName&lt;/b&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;clientId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 启动时间戳&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long bootTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 当前客户端的生产者容器，键是生产者组的名称，值实际是 DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQProducerInner&amp;gt; &lt;b&gt;producerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 当前客户端的消费者容器，键是消费者组的名称，值实际是 DefaultMQPushConsumerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQConsumerInner&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;consumerTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前客户端的adminExt容器，键是adminExt组的名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQAdminExtInner&amp;gt; adminExtTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// MQ客户端API实现，本质是Netty客户端，每个客户端实例一个Netty客户端实例名&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQClientAPIImpl &lt;b&gt;mQClientAPIImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// MQ管理器实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQAdminImpl &lt;b&gt;mQAdminImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 主题路由数据表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, TopicRouteData&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 主题 -&amp;gt; MessageQueue -&amp;gt; BrokerName，&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, ConcurrentMap&amp;lt;MessageQueue, String /*brokerName*/&amp;gt;&amp;gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//防止并发重复执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final Lock lockNamesrv = new ReentrantLock();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockHeartbeat = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//brokerName -&amp;gt; brokerId -&amp;gt; brokerAddr&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//brokerId: 0 主节点ID 1 第一个从节点ID， TODO 什么时候注册的？&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;brokerAddrTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Broker Name */, HashMap&amp;lt;String /* address */, Integer&amp;gt;&amp;gt; brokerVersionTable &lt;br&gt;&amp;nbsp; &amp;nbsp; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 支持v2心跳的代理集合。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String /* Broker address */&amp;gt; brokerSupportV2HeartbeatSet = new HashSet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 代理地址心跳指纹表。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Integer&amp;gt; brokerAddrHeartbeatFingerprintTable = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 定时任务线程池，启动时向这个线程池提交了5个定时任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = Executors.newSingleThreadScheduledExecutor(r -&amp;gt; new Thread(r, &quot;MQClientFactoryScheduledThread&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 拉取远程配置执行服务。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService fetchRemoteConfigExecutorService = &lt;br&gt;&amp;nbsp; &amp;nbsp; Executors.newSingleThreadScheduledExecutor(new ThreadFactory() {...&lt;span style=&quot;background-color: initial;&quot;&gt;});&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 拉消息服务。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullMessageService &lt;b&gt;pullMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 再平衡服务。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceService &lt;b&gt;rebalanceService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认的消息生产者。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消费者统计管理器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConsumerStatsManager consumerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 发送心跳总次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 客户端服务状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 随机数生成器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random &lt;b&gt;random&lt;/b&gt; = new Random();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="1280" width="520" height="760" as="geometry" />
        </mxCell>
        <mxCell id="2jk0mwYxtk7_m_7qFBZn-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.054;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="wqeYftxfj8nTHo_Km6VP-2" target="2jk0mwYxtk7_m_7qFBZn-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-4" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="2jk0mwYxtk7_m_7qFBZn-2" vertex="1" connectable="0">
          <mxGeometry x="0.9235" y="-1" relative="1" as="geometry">
            <mxPoint x="-8" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;" parent="1" source="wqeYftxfj8nTHo_Km6VP-2" target="cpLEBUsnRFU8It5sHO4U-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-14" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="cpLEBUsnRFU8It5sHO4U-13" vertex="1" connectable="0">
          <mxGeometry x="0.9225" y="-4" relative="1" as="geometry">
            <mxPoint x="4" y="18" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.164;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="wqeYftxfj8nTHo_Km6VP-2" target="LpHP1XivYoPNuTlPqCnb-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-3" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="LpHP1XivYoPNuTlPqCnb-2" vertex="1" connectable="0">
          <mxGeometry x="0.7031" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wqeYftxfj8nTHo_Km6VP-2" value="&lt;font color=&quot;#007fff&quot;&gt;//先执行一些检查操作，包括客户端状态检查、消息检查（是否缺失重要字段、长度是否超出最大值）&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.makeSureStateOK();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;Validators.checkMessage(msg, this.defaultMQProducer);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;final long &lt;b&gt;invokeID&lt;/b&gt; = random.nextLong();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 获取主题对应的发布目的地信息，如果没有则会调用 MQClientInstance 从 NameServer 更新&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//发送消息前并没有设置过哪个Topic的消息应该发给哪个Broker，首次调用此方法时 会使用 TBW102 这个主题的路由信息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;TopicPublishInfo topicPublishInfo = this.&lt;b&gt;tryToFindTopicPublishInfo&lt;/b&gt;(msg.getTopic());&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (topicPublishInfo != null &amp;amp;&amp;amp; topicPublishInfo.ok()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //发送失败的可重试次数，仅仅用于同步发送&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; int &lt;b&gt;timesTotal&lt;/b&gt; = communicationMode == CommunicationMode.SYNC ? 1 + &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; int times = 0; &lt;font color=&quot;#007fff&quot;&gt;//重试计数&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String[] brokersSent = new String[timesTotal];&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean resetIndex = false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (; times &amp;lt; &lt;b&gt;timesTotal&lt;/b&gt;; times++) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String lastBrokerName = null == mq ? null : mq.getBrokerName();&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//只有重试发送 lastBrokerName 才不为 null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (times &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; resetIndex = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //2 从&amp;nbsp;TopicPublishInfo 中选择一个 MessageQueue 实例存储当前消息（经过MQFaultStrategy过滤&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;）&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;//BrokerFilter 的作用是如果lastBrokerName不为null将一个主题的消息优先发送到不同的Broker节点, 也即重试发送时将消息尝试发送到其他Broker节点，只有重试发送时 BrokerFilter 才有效&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageQueue &lt;b&gt;mqSelected&lt;/b&gt; = this.&lt;b&gt;selectOneMessageQueue&lt;/b&gt;(topicPublishInfo, lastBrokerName, resetIndex);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (mqSelected != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mq = mqSelected;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokersSent[times] = mq.getBrokerName(); &lt;font color=&quot;#007fff&quot;&gt;//brokersSent 记录每次重试发送目标Broker的名字&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimestampPrev = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (times &amp;gt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //Reset topic with namespace during resend.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setTopic(this.defaultMQProducer.withNamespace(msg.getTopic()));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//发送之前先检查一下是否超时，如果发送准备阶段就超时了就没必要再发了，会跳出for循环并抛出超时异常&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 内部通过 MQClientInstance (Netty客户端) 发送消息（如果主题之前不存在就这这次请求过程中创建）&lt;/b&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sendResult = this.&lt;b&gt;sendKernelImpl&lt;/b&gt;(msg, mq, communicationMode, sendCallback, topicPublishInfo,&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; timeout - costTime);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; endTimestamp = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch (communicationMode) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case ASYNC:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case ONEWAY:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case SYNC:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sendResult.getSendStatus() != SendStatus.SEND_OK) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return sendResult;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (MQClientException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; endTimestamp = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq, e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(msg.toString());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exception = e;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (RemotingException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; endTimestamp = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.mqFaultStrategy.isStartDetectorEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Set this broker unreachable when detecting schedule task is running for RemotingException.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Otherwise, isolate this broker.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true, true);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq, e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (log.isDebugEnabled()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.debug(msg.toString());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exception = e;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (MQBrokerException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; endTimestamp = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq, e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (log.isDebugEnabled()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.debug(msg.toString());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exception = e;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.defaultMQProducer.getRetryResponseCodes().contains(e.getResponseCode())) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sendResult != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return sendResult;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; endTimestamp = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq, e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (log.isDebugEnabled()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.debug(msg.toString());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (sendResult != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return sendResult;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String info = String.format(&quot;Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; times,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; System.currentTimeMillis() - beginTimestampFirst,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.getTopic(),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Arrays.toString(brokersSent));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; info += FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; MQClientException mqClientException = new MQClientException(info, exception);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (callTimeout) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RemotingTooMuchRequestException(&quot;sendDefaultImpl call timeout&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (exception instanceof MQBrokerException) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (exception instanceof RemotingConnectException) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (exception instanceof RemotingTimeoutException) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (exception instanceof MQClientException) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; throw mqClientException;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;validateNameServerSetting();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;throw new MQClientException(&quot;No route info of this topic: &quot; + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; null).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2380" width="560" height="1780" as="geometry" />
        </mxCell>
        <mxCell id="2jk0mwYxtk7_m_7qFBZn-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2jk0mwYxtk7_m_7qFBZn-1" target="cpLEBUsnRFU8It5sHO4U-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2040" y="2410" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2jk0mwYxtk7_m_7qFBZn-1" value="this.mQClientFactory.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;(topic);&lt;br&gt;this.mQClientFactory.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;(topic, true, this.defaultMQProducer);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注意首次这里会执行两次Netty请求（getTopicRouteInfoFromNameServer），第一次带着topic信息，但是会返回不存在此topic路由信息，然后会再试一次不带topic信息（&lt;b&gt;实际是会查 TBW102 主题的路由信息&lt;/b&gt;）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1600" y="2410" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="2jk0mwYxtk7_m_7qFBZn-5" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2180" y="2340" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-46" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="pibygQn-8nMuZYlYI_m3-1" target="6dGxRPPGjoEmWPCBBTeT-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-1" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//通过 NettyRemotingClient 向 Namesrv 发送 GET_ROUTEINFO_BY_TOPIC 请求&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//如果这是向此Namesrv的首次请求会先创建连接通道&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;topicRouteData&lt;/b&gt; = this.mQClientAPIImpl.&lt;b&gt;getTopicRouteInfoFromNameServer&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; clientConfig.getMqClientApiTimeout()); &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//实际会使用&amp;nbsp;&lt;b&gt;TBW102&lt;/b&gt; 作为 topic 参数&lt;/font&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;//String AUTO_CREATE_TOPIC_KEY_TOPIC = &quot;TBW102&quot;;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//即 TBW102 就是作为用于新建TOPIC&lt;/font&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//和旧值进行比较，看是否有变化，有则更新&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;brokerAddrTable&lt;/b&gt;.put(bd.getBrokerName(), bd.getBrokerAddrs());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;topicEndPointsTable&lt;/b&gt;.put(topic, mqEndPoints);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;impl&lt;/b&gt;.&lt;b&gt;updateTopicPublishInfo&lt;/b&gt;(topic, publishInfo);&lt;font color=&quot;#007fff&quot;&gt; //impl是producerTable中的MQProducerInner实例&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;impl&lt;/b&gt;.&lt;b&gt;updateTopicSubscribeInfo&lt;/b&gt;(topic, subscribeInfo); &lt;font color=&quot;#007fff&quot;&gt;//impl是consumerTable中的MQConsumerInner实例&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;topicRouteTable&lt;/b&gt;.put(topic, cloneTopicRouteData);&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2040" y="2370" width="439" height="160" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;topicRouteData&lt;/b&gt; = {TopicRouteData@2750}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;orderTopicConf = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;queueDatas&lt;/b&gt; = {ArrayList@2816}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = {QueueData@2820}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;brokerName = &quot;broker-a&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;readQueueNums = 4&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;writeQueueNums = 4&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;perm = 6&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;topicSysFlag = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;brokerDatas&lt;/b&gt; = {ArrayList@2817}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = {BrokerData@2824}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;cluster = &quot;DefaultCluster&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;brokerName = &quot;broker-a&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;brokerAddrs = {HashMap@2828}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; {Long@2833} 0 -&amp;gt; &quot;192.168.124.3:10911&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;zoneName = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;random = {Random@2829}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;enableActingMaster = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;filterServerTable&lt;/b&gt; = {HashMap@2818}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;topicQueueMappingByBroker&lt;/b&gt; = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2040" y="2100" width="240" height="250" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-7" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicPublishInfo&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;某主题消息发布信息表，即主题的消息应该发给哪些Broker节点&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;orderTopic&lt;/b&gt; = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;haveTopicRouterInfo&lt;/b&gt; = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个只是Broker消息队列信息列表，并不存储数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;&lt;b&gt;MessageQueue&lt;/b&gt;&amp;gt; &lt;b&gt;messageQueueList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile ThreadLocalIndex &lt;b&gt;sendWhichQueue&lt;/b&gt; = new ThreadLocalIndex();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个是从NameServer读取的主题消息发送目标Broker路由信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TopicRouteData &lt;b&gt;topicRouteData&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="2080" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-10" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Broker某消息队列的信息，并不存储数据&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属主题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String topic;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对接的Broker节点名&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String brokerName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TopicPublishInfo.messageQueueList&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;消息队列索引&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private int queueId;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="2080" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="cpLEBUsnRFU8It5sHO4U-11" target="cpLEBUsnRFU8It5sHO4U-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-17" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="cpLEBUsnRFU8It5sHO4U-16" vertex="1" connectable="0">
          <mxGeometry x="0.9702" y="-3" relative="1" as="geometry">
            <mxPoint y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-11" value="&lt;div&gt;long beginStartTime = System.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//从MQClientInstance 中获取目标Broker的缓存信息，如果没有则&amp;nbsp;&lt;b&gt;tryToFindTopicPublishInfo&lt;/b&gt;(mq.getTopic()) 即从NameServer读取，前面已经执行过此方法了，按说不会再发送请求获取了&lt;/font&gt;&lt;/div&gt;&lt;div&gt;String &lt;b&gt;brokerName&lt;/b&gt; = this.mQClientFactory.getBrokerNameFromMessageQueue(mq);&lt;/div&gt;&lt;div&gt;String &lt;b&gt;brokerAddr&lt;/b&gt; = this.mQClientFactory.findBrokerAddressInPublish(brokerName);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;SendMessageContext context = null;&lt;/div&gt;&lt;div&gt;if (brokerAddr != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; brokerAddr = MixAll.brokerVIPChannel(this.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr); &lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;todo&lt;/b&gt; 什么是VIP Channel&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; byte[] &lt;b&gt;prevBody&lt;/b&gt; = msg.getBody();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//非批量消息处理，给消息增加一个UNIQ_KEY的属性， 值是一个String类型的唯一ID&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;/span&gt;//比如：UNIQ_KEY -&amp;gt; ACBE00014F2D18B4AAC29465DBFF0000&lt;/font&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!(msg instanceof MessageBatch)) {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageClientIDSetter.&lt;b&gt;setUniqID&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean topicWithNamespace = false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null != this.mQClientFactory.getClientConfig().getNamespace()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //添加 INSTANCE_ID 属性&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setInstanceId(this.mQClientFactory.getClientConfig().getNamespace());&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; topicWithNamespace = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;//如果消息内容长度超过压缩阈值（默认4K）就进行压缩&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int sysFlag = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean msgBodyCompressed = false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.&lt;b&gt;tryToCompressMessage&lt;/b&gt;(msg)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sysFlag |= MessageSysFlag.COMPRESSED_FLAG;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sysFlag |= compressType.getCompressionFlag();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgBodyCompressed = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//用于事务消息&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (Boolean.parseBoolean(tranMsg)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//暂略&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (hasCheckForbiddenHook()) {&lt;/div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executeCheckForbiddenHook(checkForbiddenContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//暂略&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.hasSendMessageHook()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executeSendMessageHookBefore(context);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 请求头&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SendMessageRequestHeader &lt;b&gt;requestHeader&lt;/b&gt; = new SendMessageRequestHeader();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setTopic(msg.getTopic()); &lt;font color=&quot;#007fff&quot;&gt;//实际主题，默认主题TBW102用于创建这个新主题&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey()); &lt;font color=&quot;#007fff&quot;&gt;//默认主题，TBW102&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 主题消息队列个数&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setQueueId(mq.getQueueId()); &lt;font color=&quot;#007fff&quot;&gt;//消息存储目标消息队列ID&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setSysFlag(sysFlag);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setBornTimestamp(System.currentTimeMillis());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setFlag(msg.getFlag());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setReconsumeTimes(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setUnitMode(this.isUnitMode());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setBatch(msg instanceof MessageBatch);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setBrokerName(brokerName);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;//如果是重试消息，即 %RETRY% 开头&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (reconsumeTimes != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (maxReconsumeTimes != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageAccessor.clearProperty(msg,MessageConst.PROPERTY_MAX_RECONSUME_TIMES);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SendResult sendResult = null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch (&lt;b&gt;communicationMode&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;ASYNC&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//异步发送&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Message tmpMessage = msg;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean messageCloned = false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (&lt;b&gt;msgBodyCompressed&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;tmpMessage = MessageAccessor.cloneMessage(msg);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageCloned = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setBody(prevBody);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (&lt;b&gt;topicWithNamespace&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!messageCloned) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; tmpMessage = MessageAccessor.cloneMessage(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageCloned = true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;this.defaultMQProducer.getNamespace()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;        &lt;/span&gt;&lt;/span&gt;//发送前先判断下是否已经超时&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long costTimeAsync = System.currentTimeMillis() - beginStartTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (timeout &amp;lt; costTimeAsync) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RemotingTooMuchRequestException(&quot;sendKernelImpl call timeout&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;        &lt;/span&gt;&lt;/span&gt;//1 执行异步发送操作&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sendResult = this.&lt;b&gt;mQClientFactory&lt;/b&gt;.getMQClientAPIImpl().&lt;b&gt;sendMessage&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerAddr,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerName,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;tmpMessage&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; timeout - costTimeAsync,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; communicationMode,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;sendCallback&lt;/b&gt;,&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//异步回调&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; topicPublishInfo,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.mQClientFactory,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;ONEWAY&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//单向消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;SYNC&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//同步发送&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//发送前先判断下是否已经超时&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long costTimeSync = System.currentTimeMillis() - beginStartTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (timeout &amp;lt; costTimeSync) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RemotingTooMuchRequestException(&quot;sendKernelImpl call timeout&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//1 执行同步发送操作&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sendResult = this.&lt;b&gt;mQClientFactory&lt;/b&gt;.getMQClientAPIImpl().&lt;b&gt;sendMessage&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerAddr,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerName,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;msg&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; timeout - costTimeSync,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; communicationMode,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;default&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; assert false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.hasSendMessageHook()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context.setSendResult(sendResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executeSendMessageHookAfter(context);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return sendResult;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (RemotingException | InterruptedException | MQBrokerException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (this.hasSendMessageHook()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context.setException(e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executeSendMessageHookAfter(context);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setBody(prevBody);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; this.defaultMQProducer.getNamespace()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;throw new MQClientException(&quot;The broker[&quot; + brokerName + &quot;] not exist&quot;, null);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="1600" y="2920" width="480" height="1860" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-12" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1765" y="2890" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="cpLEBUsnRFU8It5sHO4U-15" target="cpLEBUsnRFU8It5sHO4U-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-3" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="cpLEBUsnRFU8It5sHO4U-20" vertex="1" connectable="0">
          <mxGeometry x="0.0176" y="-1" relative="1" as="geometry">
            <mxPoint x="10" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-15" value="&lt;div&gt;long beginStartTime = System.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&lt;b&gt;RemotingCommand&lt;/b&gt; &lt;b&gt;request&lt;/b&gt; = null;&lt;/div&gt;&lt;div&gt;String msgType = msg.getProperty(MessageConst.&lt;b&gt;PROPERTY_MESSAGE_TYPE&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;boolean isReply = msgType != null &amp;amp;&amp;amp; msgType.equals(MixAll.&lt;b&gt;REPLY_MESSAGE_FLAG&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;if (&lt;b&gt;isReply&lt;/b&gt;) { &lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (sendSmartMsg) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2&lt;br&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; .createSendMessageRequestHeaderV2(requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; RequestCode.&lt;b&gt;SEND_REPLY_MESSAGE_V2&lt;/b&gt;, requestHeaderV2);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(RequestCode.&lt;b&gt;SEND_REPLY_MESSAGE&lt;/b&gt;, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (&lt;b&gt;sendSmartMsg&lt;/b&gt; || msg instanceof MessageBatch) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; .createSendMessageRequestHeaderV2(requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(msg instanceof MessageBatch ? &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;RequestCode.&lt;b&gt;SEND_BATCH_MESSAGE&lt;/b&gt; :&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;RequestCode.&lt;b&gt;SEND_MESSAGE_V2&lt;/b&gt;, requestHeaderV2); &lt;font color=&quot;#007fff&quot;&gt;//非批量消息同步发送默认用这个请求码&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(RequestCode.&lt;b&gt;SEND_MESSAGE&lt;/b&gt;, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;request.setBody(msg.getBody());&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;switch (communicationMode) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;ONEWAY&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.remotingClient.invokeOneway(addr, request, timeoutMillis);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;ASYNC&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final AtomicInteger times = new AtomicInteger();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long costTimeAsync = System.currentTimeMillis() - beginStartTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (timeoutMillis &amp;lt; costTimeAsync) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.sendMessageAsync(addr, brokerName, msg, timeoutMillis - costTimeAsync, request, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; sendCallback, topicPublishInfo, instance,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; retryTimesWhenSendFailed, times, context, producer);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;SYNC&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long costTimeSync = System.currentTimeMillis() - beginStartTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (timeoutMillis &amp;lt; costTimeSync) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//3 向Broker同步发送消息&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;sendMessageSync&lt;/b&gt;(addr, brokerName, msg, timeoutMillis - costTimeSync, request);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; assert false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return null;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=3;align=left;" parent="1" vertex="1">
          <mxGeometry x="2120" y="2920" width="480" height="680" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-18" value="MQClientAPIImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2300" y="2890" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-37" value="" style="edgeStyle=orthogonalEdgeStyle;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;rounded=1;" parent="1" source="cpLEBUsnRFU8It5sHO4U-19" target="6dGxRPPGjoEmWPCBBTeT-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3080" y="2900" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-19" value="RemotingCommand &lt;b&gt;response&lt;/b&gt; = this.&lt;b&gt;remotingClient&lt;/b&gt;.&lt;b&gt;invokeSync&lt;/b&gt;(addr, request, &lt;br&gt;&amp;nbsp; &amp;nbsp; timeoutMillis);&lt;br&gt;&lt;div&gt;assert response != null;&lt;/div&gt;&lt;div&gt;return this.&lt;b&gt;processSendResponse&lt;/b&gt;(brokerName, msg, response, addr);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2640" y="3150" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-21" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;关于RocketMQ对Netty的封装后面专门分析，这里不深入了&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2605" y="2920" width="290" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cpLEBUsnRFU8It5sHO4U-22" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;addr&lt;/b&gt; = &quot;192.168.124.3:10911&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;request&lt;/b&gt; = {RemotingCommand@3029}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;code&lt;/b&gt; = &lt;b&gt;310&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;font-weight: bold; white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//RequestCode.SEND_MESSAGE_V2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;language = {LanguageCode@3075} &quot;JAVA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;version = 453&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;opaque = 3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;flag = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;remark = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;extFields = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;customHeader&lt;/b&gt; = {SendMessageRequestHeaderV2@3026}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; a = &quot;please_rename_unique_group_name&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; b = &quot;TopicTest&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; c = &quot;TBW102&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; d = {Integer@3082} 4&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; e = {Integer@3083} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; f = {Integer@3083} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; g = {Long@3084} 1716984238478&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; h = {Integer@3083} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; i = &quot;UNIQ_KEYACBE00019C7418B4AAC29480558C0000WAITtrueTAGSTagA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; j = {Integer@3083} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; k = {Boolean@3086} false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; l = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; m = {Boolean@3086} false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; n = &quot;broker-a&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; lo = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; ns = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; nsd = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; bname = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; oway = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;cachedHeader = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;serializeTypeCurrentRPC = {SerializeType@3076} &quot;JSON&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;body&lt;/b&gt; = {byte[16]@2971} [72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48]&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;suspended = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;processTimer = null&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2640" y="3220" width="450" height="420" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-1" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3000" y="880" width="240" height="420" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-2" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3000" y="1340" width="240" height="500" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-6" target="6dGxRPPGjoEmWPCBBTeT-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-6" value="NettyDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是RocketMQ自定义的解码器，继承&lt;br&gt;&lt;b&gt;LengthFieldBasedFrameDecoder&lt;br&gt;根据消息中长度字段提取消息主体&lt;br&gt;&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1440" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-8" target="6dGxRPPGjoEmWPCBBTeT-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-8" value="IdleStateHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于自动关闭空闲的连接通道&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-10" target="6dGxRPPGjoEmWPCBBTeT-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-10" value="&lt;div&gt;NettyRemotingClient$&lt;/div&gt;&lt;div&gt;NettyConnectManageHandler&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1600" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-36" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-12" target="UuV1s5uOwehbHIiCa4GY-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-12" value="&lt;div&gt;NettyRemotingClient$&lt;/div&gt;&lt;div&gt;NettyClientHandler&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1680" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-33" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-33" target="6dGxRPPGjoEmWPCBBTeT-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-15" target="UuV1s5uOwehbHIiCa4GY-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-15" value="NettyEncoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1140" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-22" target="6dGxRPPGjoEmWPCBBTeT-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-17" value="DefaultChannelPipeline$TailContext" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="900" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-22" value="OutBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3010.5" y="860" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-24" target="6dGxRPPGjoEmWPCBBTeT-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-24" value="IdleStateHandler&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;Netty提供的一个ChannelHandler&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;当Channel一段时间没有读写，触发&lt;b&gt;IdleStateEvent（3种子事件），用于自动关闭空闲的连接通道&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1060" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-34" value="InBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3015.5" y="1315" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-39" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="pibygQn-8nMuZYlYI_m3-7" target="UuV1s5uOwehbHIiCa4GY-94" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2601" y="900" as="targetPoint" />
            <Array as="points">
              <mxPoint x="4060" y="2560" />
              <mxPoint x="4060" y="2320" />
              <mxPoint x="3740" y="2320" />
              <mxPoint x="3740" y="820" />
              <mxPoint x="3860" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-43" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;生产者关键流程&lt;/b&gt;：&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;1 生产者启动阶段，创建了一堆线程或线程池，启动了一堆任务，都是做什么的？&lt;/span&gt;&lt;br&gt;&lt;ul style=&quot;&quot;&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;AsyncAppender-Worker-RocketmqToolsAppender&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;Client_192.168.124.3@DEFAULT_GuardForAsyncSend&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ClientHouseKeepingService&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;LatencyFaultToleranceScheduledThread&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;MQClientFactoryScheduledThread&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;NettyClientPublicExecutor_x (1..4)&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;NettyClientScan_thread_1&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;NettyClientSelector_1&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//NioEventLoop线程，监听Channel事件&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;NettyClientWorkerThread_x&lt;/b&gt; (1..4)&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; //ChannelHandler事件处理线程&lt;/span&gt;&lt;/span&gt;&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;NettyEventExecutor&lt;/b&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//这个线程其实是ChannelHandler的拓展处理，ChannelPipeline 中会向此线程 &lt;b&gt;eventQueue&lt;/b&gt; 中加入NettyEvent事件&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//此线程轮询 eventQueue 异步执行进一步的处理&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;PullMessageService&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;RebalanceService&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;RequestHouseKeepingService1&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;2 生产者什么时候建立与Broker的连接通道的？&lt;/span&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;搜索源码找Bootstrap connect()方法调用，找到一个NettyRemotingClient#createChannel() 方法, IDEA查看其调用路径发现是发送消息前会先判断连接通道是否存在，不存在则先创建连接通道，再发送消息。&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; 生产者与 NameServer 建立连接通道也是在首次请求NameServer时创建的。&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;3 生产者向Broker发送消息并处理响应的流程？&lt;br&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;4 生产者发送一个主题消息，如果有多个Broker节点，Broker对每个主题又有多个队列，是怎么分配到底存储在那个节点那个队列中的？&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="760" y="10" width="750" height="350" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-49" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-45" target="6dGxRPPGjoEmWPCBBTeT-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-45" target="pibygQn-8nMuZYlYI_m3-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3540" y="2450" />
              <mxPoint x="3540" y="2560" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-45" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;...&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 与Namesrv或Broker的连接是否存在，存在直接从 channelTables 取，不存在则创建连接通道&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;b&gt;final Channel channel = this.getAndCreateChannel(addr);&lt;br&gt;&lt;/b&gt;...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 发送请求，内部是通过Netty异步通信的&lt;/b&gt;&lt;/font&gt;&lt;br&gt;RemotingCommand response = this.&lt;b&gt;invokeSyncImpl&lt;/b&gt;(channel, request, left);&lt;br&gt;...&lt;br&gt;return response;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3080" y="2395" width="439" height="110" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-47" target="6dGxRPPGjoEmWPCBBTeT-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-47" value="NettyRemotingClient#&lt;b&gt;createChannel&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建连接管道，本质是执行connnect() 方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3560" y="2420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-50" target="UuV1s5uOwehbHIiCa4GY-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2601" y="900" as="targetPoint" />
            <Array as="points">
              <mxPoint x="4020" y="2450" />
              <mxPoint x="4020" y="2340" />
              <mxPoint x="3260" y="2340" />
              <mxPoint x="3260" y="820" />
              <mxPoint x="3380" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-2" value="&lt;font color=&quot;#007fff&quot;&gt;从ChannelPipeline tail ChannelHandler开始&lt;br&gt;依次调用各个ChannelHandler的 connect()&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];" parent="UuV1s5uOwehbHIiCa4GY-1" vertex="1" connectable="0">
          <mxGeometry x="-0.9655" y="-1" relative="1" as="geometry">
            <mxPoint x="-11" y="9" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-50" value="&lt;div&gt;ChannelFuture channelFuture = fetchBootstrap(addr)&lt;span style=&quot;background-color: initial;&quot;&gt;.&lt;b&gt;connect&lt;/b&gt;(hostAndPort[0], Integer.parseInt(hostAndPort[1]));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部先创建连接Channel，再调Channel的connect方法连接服务端&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;align=center;" parent="1" vertex="1">
          <mxGeometry x="3800" y="2420" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6dGxRPPGjoEmWPCBBTeT-52" value="NettyRemotingClient" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3840" y="2390" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-3" value="&lt;font color=&quot;#007fff&quot;&gt;从ChannelPipeline tail ChannelHandler开始&lt;br&gt;依次调用各个ChannelHandler的 writeAndFlush()&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];" parent="1" vertex="1" connectable="0">
          <mxGeometry x="4010" y="2560" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-4" value="&lt;font color=&quot;#007fff&quot;&gt;注意Netty客户端到每个Netty服务端的每个连接Channel 都有自己的ChannelPipeline实例，&lt;br&gt;但是这里为了方便不区分了&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3002" y="1840" width="500" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-42" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-12" target="UuV1s5uOwehbHIiCa4GY-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-12" value="连接操作&lt;br style=&quot;font-size: 10px;&quot;&gt;connect(...)" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3350.5" y="840" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-48" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-5" target="UuV1s5uOwehbHIiCa4GY-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-5" value="&lt;font color=&quot;#007fff&quot;&gt;只是在连接之后发一个连接事件&lt;/font&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;NettyRemotingClient&lt;/b&gt;.this.&lt;b style=&quot;&quot;&gt;putNettyEvent&lt;/b&gt;(&lt;br&gt;new NettyEvent(NettyEventType.&lt;b style=&quot;&quot;&gt;CONNECT&lt;/b&gt;&lt;br&gt;, remote, ctx.channel()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3281" y="980" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-15" target="UuV1s5uOwehbHIiCa4GY-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-49" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-15" target="UuV1s5uOwehbHIiCa4GY-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-15" value="&lt;font color=&quot;#007fff&quot;&gt;没有做任何事&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1060" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-17" value="DefaultChannelPipeline$HeadContext" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="6dGxRPPGjoEmWPCBBTeT-17" target="UuV1s5uOwehbHIiCa4GY-22" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3122" y="960" as="sourcePoint" />
            <mxPoint x="3122" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-22" value="NettyRemotingClient$&lt;br&gt;NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="980" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-32" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-29" target="UuV1s5uOwehbHIiCa4GY-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-39" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-29" target="UuV1s5uOwehbHIiCa4GY-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-29" value="&lt;font color=&quot;#007fff&quot;&gt;没有做任何事&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1140" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-38" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-30" target="UuV1s5uOwehbHIiCa4GY-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-46" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-30" target="UuV1s5uOwehbHIiCa4GY-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-47" value="连接成功&lt;br&gt;channelActive()" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#007FFF;" parent="UuV1s5uOwehbHIiCa4GY-46" vertex="1" connectable="0">
          <mxGeometry x="-0.0348" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-30" value="unsafe.connect(remoteAddress, localAddress, promise);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;最终是调用connect本地方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-17" target="UuV1s5uOwehbHIiCa4GY-33" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3122" y="1280" as="sourcePoint" />
            <mxPoint x="3122" y="1460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-44" value="&lt;font color=&quot;#007fff&quot;&gt;Netty服务器响应&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="UuV1s5uOwehbHIiCa4GY-34" vertex="1" connectable="0">
          <mxGeometry x="-0.0348" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-33" value="DefaultChannelPipeline$HeadContext" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1360" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-35" value="DefaultChannelPipeline$TailContext" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3022.5" y="1760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-37" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;其实Netty ChannelHandler的责任链是类似&lt;b&gt;装饰器&lt;/b&gt;的封装模式(类似洋葱模型)，&lt;br&gt;即下面这种链表的展示方式不太准确，但是比较清晰&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3000" y="800" width="370" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-51" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-45" target="UuV1s5uOwehbHIiCa4GY-57" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3380.521739130436" y="1440" as="targetPoint" />
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-45" target="UuV1s5uOwehbHIiCa4GY-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-60" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;自动读&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="UuV1s5uOwehbHIiCa4GY-56" vertex="1" connectable="0">
          <mxGeometry x="-0.7739" y="1" relative="1" as="geometry">
            <mxPoint x="4" y="40" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-45" value="ctx.fireChannelActive();&lt;br&gt;readIfIsAutoRead();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如果配置了自动读，则触发 pipeline.read()&lt;br&gt;从后面逻辑可知即&lt;b&gt;注册监听读事件&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1360" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-90" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-52" target="UuV1s5uOwehbHIiCa4GY-89" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-52" value="&lt;font color=&quot;#007fff&quot;&gt;没有做任何事&lt;br&gt;后面流程不再展示这种空白方法&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="3520" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-54" target="UuV1s5uOwehbHIiCa4GY-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-54" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;注册监听读事件&lt;br&gt;&lt;/font&gt;read(...)" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3580" y="840" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-59" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-57" target="UuV1s5uOwehbHIiCa4GY-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-82" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-57" target="UuV1s5uOwehbHIiCa4GY-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-57" value="&lt;font color=&quot;#007fff&quot;&gt;没有做任何事&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1440" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-69" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-58" target="UuV1s5uOwehbHIiCa4GY-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-81" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-58" target="UuV1s5uOwehbHIiCa4GY-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-58" value="&lt;div&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;initialize&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//继续传递&lt;/font&gt;&lt;/div&gt;&lt;div&gt;super.channelActive(ctx);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-68" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-61" target="UuV1s5uOwehbHIiCa4GY-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-80" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-61" target="UuV1s5uOwehbHIiCa4GY-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-61" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final String remoteAddress = RemotingHelper&lt;br&gt;.parseChannelRemoteAddr(ctx.channel());&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;super.channelActive(ctx);&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt; &lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//继续传递&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//发布ACTIVE事件&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;NettyRemotingClient&lt;/b&gt;.this.&lt;b&gt;putNettyEvent&lt;/b&gt;(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;new NettyEvent(NettyEventType.&lt;b&gt;ACTIVE&lt;/b&gt;,&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;remoteAddress, ctx.channel()));&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1600" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-67" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-63" target="UuV1s5uOwehbHIiCa4GY-66" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-79" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-63" target="UuV1s5uOwehbHIiCa4GY-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-63" value="&lt;font color=&quot;#007fff&quot;&gt;没有做任何事&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1700" width="199" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-78" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-66" target="UuV1s5uOwehbHIiCa4GY-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-66" value="onUnhandledInboundChannelActive();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;默认是空方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="3281" y="1760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-74" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-71" target="UuV1s5uOwehbHIiCa4GY-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-75" value="IDLE&lt;br style=&quot;font-size: 10px;&quot;&gt;CLOSE&lt;br style=&quot;font-size: 10px;&quot;&gt;CONNECT&lt;br style=&quot;font-size: 10px;&quot;&gt;EXCEPTION&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;ACTIVE&lt;/b&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="UuV1s5uOwehbHIiCa4GY-74" vertex="1" connectable="0">
          <mxGeometry x="-0.0142" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-71" value="event&lt;br&gt;.getType()" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;align=center;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2440" y="970" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-73" value="生产者 ChannelEventListener 实现是 &lt;b&gt;MQClientInstance$2&lt;/b&gt;, 只实现了ACTIVE事件处理，用于判断激活连接的目标Broker地址是否已经存在于MQClientInstance.&lt;b&gt;brokerAddrTable&lt;/b&gt;, 是则发送心跳，发送成功就立即执行一次再平衡" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2680" y="980" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-77" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;NettyEventExecutor&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2725" y="950" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-83" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ChannelEventListener (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Netty Channel 事件监听器，作为 ChannelHandler 的补充&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void onChannelConnect(final String remoteAddr, final Channel channel);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void onChannelClose(final String remoteAddr, final Channel channel);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void onChannelException(final String remoteAddr, final Channel channel);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void onChannelIdle(final String remoteAddr, final Channel channel);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void onChannelActive(final String remoteAddr, final Channel channel);&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-3360" y="1100" width="520" height="140" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-85" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=block;endFill=1;dashed=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-86" target="UuV1s5uOwehbHIiCa4GY-83" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-3100" y="1280" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-86" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance$2&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;MQClientInstance 初始化时创建的匿名内部类&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; brokerAddrTable = MQClientInstance.this.brokerAddrTable;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//只实现了这个方法，判断激活连接的目标Broker地址是否已经存在于MQClientInstance.brokerAddrTable, 是则发送心跳，发送成功就立即执行一次再平衡&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;public void &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;onChannelActive&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(String remoteAddr, Channel channel)&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-3360" y="1280" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-89" value="unsafe.beginRead();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;内部其实是往Channel selectionKey 中注册&lt;br&gt;read 事件，表示后面需要监听读事件&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3520" y="1220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-93" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-91" target="UuV1s5uOwehbHIiCa4GY-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-91" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;有数据可读&lt;br&gt;channelRead(...)&lt;/font&gt;" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3579.5" y="1300" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-98" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-92" target="UuV1s5uOwehbHIiCa4GY-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-92" value="入口是继承的&lt;br&gt;ByteToMessageDecoder#channelRead()，&lt;br&gt;内部会调用到 NettyDecoder#decode()&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3520" y="1440" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-103" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-94" target="UuV1s5uOwehbHIiCa4GY-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-94" value="写操作&lt;br style=&quot;font-size: 10px;&quot;&gt;writeAndFlush(...)&lt;br&gt;write()" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3800" y="840" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-106" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-107" target="UuV1s5uOwehbHIiCa4GY-105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-95" value="额外在ChannelPromise中注册一个监听器" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3760" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-96" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;关于怎么执行到这里的&lt;br&gt;参考netty.drawio&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3662" y="1295" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-100" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-97" target="UuV1s5uOwehbHIiCa4GY-99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-97" value="&lt;font color=&quot;#007fff&quot;&gt;更新了些字段，后面再研究&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3520" y="1520" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-102" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-99" target="UuV1s5uOwehbHIiCa4GY-101" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="et-XjreOMqEX0LqqpJ0o-2" value="..." style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-99" target="et-XjreOMqEX0LqqpJ0o-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-99" value="入口是继承的&lt;br&gt;SimpleChannelInboundHandler&lt;br&gt;#channelRead(), 内部会调用 NettyClientHandler#channelRead0()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3520" y="1680" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-101" value="ReferenceCountUtil.release(msg);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;最终会调用这个方法释放msg对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3520" y="1760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-105" value="unsafe.write(msg, promise);&lt;br&gt;unsafe.flush();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;先加入缓冲，再调用flush(), 最终会调用到write本地方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3760" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-108" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UuV1s5uOwehbHIiCa4GY-95" target="UuV1s5uOwehbHIiCa4GY-107" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3860" y="1120" as="sourcePoint" />
            <mxPoint x="3860" y="1220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-107" target="UuV1s5uOwehbHIiCa4GY-111" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-107" value="&lt;div&gt;入口是继承的&lt;/div&gt;&lt;div&gt;MessageToByteEncoder#write()，&lt;/div&gt;&lt;div&gt;内部会调用到 NettyEncoder#encode()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3760" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UuV1s5uOwehbHIiCa4GY-111" target="UuV1s5uOwehbHIiCa4GY-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-111" value="&lt;div&gt;I cast = (I) msg;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//分配ByteBuf对象，默认是用 PooledByteBufAllocator 分配&lt;/font&gt;&lt;/div&gt;&lt;div&gt;buf = &lt;b&gt;allocateBuffer&lt;/b&gt;(ctx, cast, preferDirect);&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //执行RocketMQ中编码逻辑&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;encode&lt;/b&gt;(ctx, cast, buf);&amp;nbsp;&lt;/div&gt;&lt;div&gt;} finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ReferenceCountUtil.release(cast);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (buf.isReadable()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; //其实是继续传递给下一个ChannelHandler&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.write(buf, promise);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; buf.release();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.write(Unpooled.EMPTY_BUFFER, promise);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;buf = null;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="4000" y="1060" width="240" height="220" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-114" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//先写命令对象的头信息到ByteBuf对象&lt;/font&gt;&lt;/div&gt;&lt;div&gt;remotingCommand.&lt;b&gt;fastEncodeHeader&lt;/b&gt;(out);&lt;/div&gt;&lt;div&gt;byte[] body = remotingCommand.getBody();&lt;/div&gt;&lt;div&gt;if (body != null) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //再写消息体到ByteBuf对象&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; out.&lt;b&gt;writeBytes&lt;/b&gt;(body);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="4280" y="1120" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-116" value="MessageToByteEncoder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4045" y="1030" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-117" value="NettyEncoder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4330" y="1100" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-118" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;报文&lt;br&gt;长度&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4280" y="1260" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UuV1s5uOwehbHIiCa4GY-119" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;头部&lt;br&gt;长度&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4360" y="1260" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="72Ht_2b3qwp2gp2Md_9H-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;RocketMQ命令JSON格式序列化编码后：&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4280" y="1230" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="72Ht_2b3qwp2gp2Md_9H-3" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;协议&lt;br&gt;类型&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4320" y="1260" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="72Ht_2b3qwp2gp2Md_9H-4" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;报文长度（4bytes）：4 + headerSize + bodySize （没有算报文长度字段的4字节长度）&lt;br&gt;协议类型（1bytes）：JSON（0）、ROCKETMQ（1）&lt;br&gt;头部长度（3bytes）&lt;br&gt;头部内容：&lt;b&gt;注意看源码实际是将整个RemotingCommand对象序列化后写到了头部内容区域&lt;/b&gt;&lt;br&gt;JSON序列化是使用的FastJson工具。&lt;br&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4280" y="1300" width="430" height="100" as="geometry" />
        </mxCell>
        <mxCell id="72Ht_2b3qwp2gp2Md_9H-5" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;头部&lt;br&gt;内容&lt;br&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4400" y="1260" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="72Ht_2b3qwp2gp2Md_9H-6" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;消息体&lt;br&gt;内容&lt;br&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4480" y="1260" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="RffD4n2BkVokqasOKvOE-1" value="&lt;font color=&quot;#007fff&quot;&gt;Netty LengthFieldBasedFrameDecoder 注释中列举了7种示例，&lt;br&gt;但是从代码实现上看和任何一种格式都不符合：初始化时设置的长度字段偏移：0，长度字段长度：4，lengthAdjustment: 0, initialBytesToStrip:4 （这个字段应该是报文长度字段的字节数）&amp;nbsp;&lt;br&gt;解码规则其实是按 NettyEncoder 的编码方式进行解码，&lt;br&gt;解码时先读取前4bytes获取报文长度（其实是协议类型、头部长度、头部内容、消息体内容总长）&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3750" y="1440" width="850" height="60" as="geometry" />
        </mxCell>
        <mxCell id="et-XjreOMqEX0LqqpJ0o-1" value="processResponseCommand(ctx, msg);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Producer客户端处理的是&amp;nbsp;RESPONSE_COMMAND&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3761" y="1680" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="et-XjreOMqEX0LqqpJ0o-4" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;就是从 responseTable 通过 opaque 获取对应的&amp;nbsp; ResponseFuture，&lt;br style=&quot;font-size: 10px;&quot;&gt;写响应结果或者执行回调&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3960" y="1690" width="320" height="40" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="cpLEBUsnRFU8It5sHO4U-1" target="pibygQn-8nMuZYlYI_m3-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2479" y="2450" as="sourcePoint" />
            <mxPoint x="3080" y="2450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-1" value="&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;...&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//向 NameServer 发送 GET_ROUTEINFO_BY_TOPIC 请求&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;RemotingCommand request = RemotingCommand.createRequestCommand(&lt;br&gt;RequestCode.&lt;b&gt;GET_ROUTEINFO_BY_TOPIC&lt;/b&gt;, requestHeader);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;RemotingCommand response = this.&lt;b&gt;remotingClient&lt;/b&gt;.&lt;b&gt;invokeSync&lt;/b&gt;(null, request, timeoutMillis);&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2520" y="2400" width="439" height="100" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="pibygQn-8nMuZYlYI_m3-4" target="pibygQn-8nMuZYlYI_m3-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-4" value="return &lt;b style=&quot;font-size: 9px;&quot;&gt;invokeImpl&lt;/b&gt;(channel, request, timeoutMillis)&lt;br style=&quot;font-size: 9px;&quot;&gt;.thenApply(ResponseFuture::getResponseCommand)&lt;br style=&quot;font-size: 9px;&quot;&gt;.get(timeoutMillis, TimeUnit.MILLISECONDS);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;前面是同步调用，后面是异步调用，这里get() 异步转同步&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="3550" y="2520" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-6" value="NettyRemotingAbstract" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3590" y="2490" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-7" value="channel.writeAndFlush(response)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;内部调用 pipeline.writeAndFlush()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3800" y="2530" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-9" value="NettyRemotingClient" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3234.5" y="2365" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pibygQn-8nMuZYlYI_m3-10" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;request = {RemotingCommand@2413}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;code&lt;/b&gt; = 105&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;language = {LanguageCode@2564} &quot;JAVA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;version = 453&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;opaque = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;flag = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;remark = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;extFields = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;customHeader&lt;/b&gt; = {GetRouteInfoRequestHeader@2405}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; topic = &quot;TopicTest&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; acceptStandardJsonOnly = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; lo = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; ns = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; nsd = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; bname = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; oway = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;cachedHeader = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;serializeTypeCurrentRPC = {SerializeType@2565} &quot;JSON&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;body = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;suspended = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;processTimer = null&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2520" y="2130" width="290" height="270" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="LpHP1XivYoPNuTlPqCnb-1" target="LpHP1XivYoPNuTlPqCnb-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-1" value="return this.&lt;b&gt;mqFaultStrategy&lt;/b&gt;.&lt;b&gt;selectOneMessageQueue&lt;/b&gt;(tpInfo, lastBrokerName, resetIndex);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里可以看到默认是借助 MQFaultStrategy 实现 MessageQueue实例选择的，&lt;/font&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQFaultStrategy 内部带了一组QueueFilter过滤器，用于过滤 MessageQueue&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1600" y="2700" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="LpHP1XivYoPNuTlPqCnb-4" target="LpHP1XivYoPNuTlPqCnb-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-4" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 每个线程中都会创建一个 BrokerFilter&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;BrokerFilter brokerFilter = &lt;b style=&quot;font-size: 9px;&quot;&gt;threadBrokerFilter&lt;/b&gt;.get();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;brokerFilter.setLastBrokerName(lastBrokerName);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (this.&lt;b style=&quot;font-size: 9px;&quot;&gt;sendLatencyFaultEnable&lt;/b&gt;) {&lt;b&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//如果开启延时容错&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (resetIndex) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; tpInfo.resetIndex();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// availableFilter 优先级高于 reachableFilter&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; MessageQueue mq = tpInfo.&lt;b&gt;selectOneMessageQueue&lt;/b&gt;(&lt;b&gt;availableFilter&lt;/b&gt;, &lt;b&gt;brokerFilter&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (mq != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return mq;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; mq = tpInfo.&lt;b&gt;selectOneMessageQueue&lt;/b&gt;(&lt;b&gt;reachableFilter&lt;/b&gt;, &lt;b&gt;brokerFilter&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (mq != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return mq;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 兜底，不使用过滤器过滤&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return tpInfo.&lt;b style=&quot;font-size: 9px;&quot;&gt;selectOneMessageQueue&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;// 如果没有开启延迟容错&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageQueue mq = tpInfo.&lt;b style=&quot;font-size: 9px;&quot;&gt;selectOneMessageQueue&lt;/b&gt;(&lt;b&gt;brokerFilter&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (mq != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return mq;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 兜底，不使用过滤器过滤&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return tpInfo.&lt;b style=&quot;font-size: 9px;&quot;&gt;selectOneMessageQueue&lt;/b&gt;();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2040" y="2580" width="440" height="300" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQFaultStrategy&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;意为MQ错误策略，&lt;/b&gt;从其源码逻辑看应该是&lt;b&gt;发送容错策略，注意到它在消息发送时选择存储的消息队列实例时有起到关键作用，至于其他功能，后面再看&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//延迟容错？&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LatencyFaultTolerance&amp;lt;String&amp;gt; &lt;b&gt;latencyFaultTolerance&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean sendLatencyFaultEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean startDetectorEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long[] latencyMax = {50L, 100L, 550L, 1800L, 3000L, 5000L, 15000L};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long[] notAvailableDuration = {0L, 0L, 2000L, 5000L, 6000L, 10000L, 30000L};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;BrokerFilter 的作用是如果lastBrokerName不为null将一个主题的消息优先发送到不同的Broker节点, 也即重试发送时将消息尝试发送到其他Broker节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ThreadLocal&amp;lt;BrokerFilter&amp;gt; &lt;b&gt;threadBrokerFilter&lt;/b&gt; = new ThreadLocal&amp;lt;BrokerFilter&amp;gt;() {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override protected BrokerFilter initialValue() {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new &lt;b&gt;BrokerFilter&lt;/b&gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; };&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// availableFilter 优先级高于 reachableFilter, 它们两个都是通过 LatencyFaultTolerance 实现的&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private QueueFilter reachableFilter = new QueueFilter() {...};&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private QueueFilter availableFilter = new QueueFilter() {...};&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于从TopicPublishInfo提供的消息队列列表中选择一个消息队列存储当前消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public MessageQueue &lt;b&gt;selectOneMessageQueue&lt;/b&gt;(final TopicPublishInfo tpInfo, final String lastBrokerName, final boolean resetIndex)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 还有一些其他方法，todo&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="2300" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-7" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个方法展示了 MessageQueue 实例选择规则：轮询+过滤器过滤&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private MessageQueue &lt;b&gt;selectOneMessageQueue&lt;/b&gt;(List&amp;lt;MessageQueue&amp;gt; messageQueueList, ThreadLocalIndex sendQueue, QueueFilter ...&lt;b&gt;filter&lt;/b&gt;) {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (filter != null &amp;amp;&amp;amp; filter.length != 0) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i = 0; i &amp;lt; &lt;b&gt;messageQueueList&lt;/b&gt;.size(); i++) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 队列ID递增轮询，为了每次都选择不一样的消息队列，这样可以实现消息发送负载均衡&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int index = Math.abs(sendQueue.&lt;b&gt;incrementAndGet&lt;/b&gt;() % messageQueueList.size());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageQueue mq = messageQueueList.get(index);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean filterResult = true;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 过滤器过滤&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;for&lt;/b&gt; (QueueFilter f: filter) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Preconditions.checkNotNull(f);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; filterResult &amp;amp;= f.&lt;b&gt;filter&lt;/b&gt;(mq);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (filterResult) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return mq;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//上面选择为空，就直接选择下一个MessageQueue&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; int index = Math.abs(sendQueue.incrementAndGet() % messageQueueList.size());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return messageQueueList.get(index);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2520" y="2580" width="440" height="300" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-9" value="TopicPublishInfo" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2685" y="2550" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-10" value="MQFaultStrategy" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2204.5" y="2550" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="LpHP1XivYoPNuTlPqCnb-11" target="LpHP1XivYoPNuTlPqCnb-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-11" value="SendResult sendResult = producer.send(msg, new &lt;b&gt;MessageQueueSelector&lt;/b&gt;() {...}, orderId);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是借助 MessageQueueSelector选择&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="2820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0.001;entryY=0.169;entryDx=0;entryDy=0;entryPerimeter=0;dashed=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="LpHP1XivYoPNuTlPqCnb-13" target="wqeYftxfj8nTHo_Km6VP-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="2820" />
              <mxPoint x="970" y="2681" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-16" value="&lt;font color=&quot;#007fff&quot;&gt;对比&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="LpHP1XivYoPNuTlPqCnb-15" vertex="1" connectable="0">
          <mxGeometry x="-0.2928" y="2" relative="1" as="geometry">
            <mxPoint x="-8" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="LpHP1XivYoPNuTlPqCnb-13" value="&lt;font color=&quot;#007fff&quot;&gt;// 就是先选择消息队列&lt;br&gt;&lt;/font&gt;MessageQueue mq = this.&lt;b&gt;defaultMQProducerImpl&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.&lt;b&gt;invokeMessageQueueSelector&lt;/b&gt;(msg, selector, arg, this.getSendMsgTimeout());&lt;br&gt;mq = queueWithNamespace(mq);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;// 然后将消息直接发送到这个消息队列&lt;br&gt;&lt;/font&gt;&lt;div&gt;if (this.getAutoBatch() &amp;amp;&amp;amp; !(msg instanceof MessageBatch)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return sendByAccumulator(msg, mq, null);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;sendDirect&lt;/b&gt;(msg, mq, null);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="520" y="2790" width="440" height="120" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="3BUzB-CuzncaUeyYl-aW" name="NameServer">
    <mxGraphModel dx="3915" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="uRtEAP2a5k4lkSkrBafr-164" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2100" y="2150" width="240" height="420" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-163" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2100" y="1390" width="240" height="740" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AJX_MhfLM1ez97IJH3E7-1" target="uRtEAP2a5k4lkSkrBafr-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AJX_MhfLM1ez97IJH3E7-1" value="命名服务启动&lt;br&gt;&lt;b&gt;NamesrvStartup&lt;/b&gt;#main()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-1" value="&lt;b&gt;parseCommandlineAndConfigFile&lt;/b&gt;(args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;解析命令行参数和配置文件内容然后赋值到NamesrvStartup 各个配置（xxxConfig）对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-3" value="NamesrvController controller = &lt;b&gt;createAndStartNamesrvController&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-5" target="uRtEAP2a5k4lkSkrBafr-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-5" value="controllerManagerMain();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动管理后台，不是必须的先略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-7" target="uRtEAP2a5k4lkSkrBafr-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-7" value="CommandLine commandLine = ServerUtil.&lt;b&gt;parseCmdLine&lt;/b&gt;(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options), new DefaultParser());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;使用&lt;b&gt;Commons-cli&lt;/b&gt;工具解析命令行参数&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-9" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;将命令行参数 &lt;b style=&quot;font-size: 9px;&quot;&gt;-c&amp;nbsp; 指定的文件中的属性以及 -p 直接设置的属性&lt;/b&gt;&amp;nbsp;加载到 NameServerStartup&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;namesrvConfig&lt;/b&gt;、&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyServerConfig&lt;/b&gt;、&amp;nbsp;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyClientConfig、controllerConfig&amp;nbsp;&lt;/b&gt;等字段&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;NamesrvStartup&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;NameServer 启动类，用于启动 RocketMQ NameServer （NamesrvController） 和 管理后台（ControllerManager）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static Properties &lt;b&gt;properties&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RokcetMQ NameSever 相关配置，下面三个配置用于启动 NamesrvController&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NameServer Netty服务端配置，使用Netty与其他组件通信&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NameServer 也需要主动发起与其他组件通信&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RocketMQ Web管理后台配置，这个配置用于启动 ControllerManager&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static ControllerConfig &lt;b&gt;controllerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-560" y="80" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-12" value="NamesrvController controller = &lt;b&gt;createNamesrvController&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-14" target="uRtEAP2a5k4lkSkrBafr-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-14" value="start(controller);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动命名服务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="uRtEAP2a5k4lkSkrBafr-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="qkaxiBqNsh2hagOEbENo-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="qkaxiBqNsh2hagOEbENo-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-16" value="final NamesrvController controller = new &lt;b&gt;NamesrvController&lt;/b&gt;(namesrvConfig, nettyServerConfig, nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-18" value="controller.getConfiguration()&lt;br&gt;.registerConfig(properties);&lt;br&gt;return controller;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.564;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-20" target="uRtEAP2a5k4lkSkrBafr-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.921;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-20" target="uRtEAP2a5k4lkSkrBafr-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NamesrvController&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;RocketMQ 命名服务的核心实现类&lt;/font&gt;&lt;/b&gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// NamesrvStartup 中三个配置类实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scanExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScanScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//配置属性的容器，里面是一个名为 configTable 的嵌套的HashMap，存储&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp;Namespace -&amp;gt; （Key -&amp;gt; Value）&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final KVConfigManager &lt;b&gt;kvConfigManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//存储路由信息的一组 ConcurrentHashMap&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RouteInfoManager &lt;b&gt;routeInfoManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingClient &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty服务端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingServer &lt;b&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//实现ChannelEventListener，默认会回调 routeInfoManager 的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BrokerHousekeepingService &lt;b&gt;brokerHousekeepingService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService defaultExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService clientRequestExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; defaultThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; clientRequestThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Configuration &lt;b&gt;configuration&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private FileWatchService fileWatchService;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-560" y="320" width="520" height="380" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RouteInfoManager&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;Broker路由信息管理器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long DEFAULT_BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ReadWriteLock lock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Topic -&amp;gt; brokerName -&amp;gt;&amp;nbsp; Broker中消息队列信息（所属Broker节点名、读/写队列数量、权限等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String, QueueData&amp;gt;&amp;gt; &lt;b&gt;topicQueueTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//brokerName -&amp;gt; Broker信息（集群、节点名、主从节点地址列表）&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* brokerName */, BrokerData&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//集群名 -&amp;gt; brokerName集合&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* clusterName */, Set&amp;lt;String/* brokerName */&amp;gt;&amp;gt; &lt;b&gt;clusterAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, BrokerLiveInfo&amp;gt; &lt;b&gt;brokerLiveTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;topicQueueMappingInfoTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BatchUnregistrationService &lt;b&gt;unRegisterService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvController &lt;b&gt;namesrvController&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="80" width="520" height="280" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-28" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Configuration&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;Object&amp;gt; &lt;b&gt;configObjectList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;(4);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String storePath;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean storePathFromConfig = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Object storePathObject;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Field storePathField;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DataVersion dataVersion = new DataVersion();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ReadWriteLock readWriteLock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Properties &lt;b&gt;allConfigs&lt;/b&gt; = new Properties();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="620" width="520" height="140" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-29" value="boolean initResult = controller.initialize();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;进一步初始化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-31" target="uRtEAP2a5k4lkSkrBafr-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-31" value="Runtime.getRuntime()&lt;br&gt;.addShutdownHook(...);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;优雅关机&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-33" target="uRtEAP2a5k4lkSkrBafr-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-33" value="controller.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-35" value="loadConfig();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从&amp;nbsp;&lt;b&gt;kvConfig.json&amp;nbsp;&lt;/b&gt;加载属性配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-37" value="initiateNetworkComponents();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个Netty客户端和一个Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-59" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240" y="1180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-39" value="initiateThreadExecutors();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建两个线程池，用于执行 NettyRequestProcessor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1210" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-41" value="registerProcessor();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;向Netty服务端processorTable注册请求的处理器(NettyRequestProcessor)，以及设置处理线程池（就是上面创建的线程池）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-43" value="startScheduleService();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动3个定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-45" value="initiateSslContext();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置SSL, 启动一个线程监听证书和密钥文件的变化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-47" target="uRtEAP2a5k4lkSkrBafr-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-47" value="initiateRpcHooks();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注册RPCHook, 用于拓展请求前和响应后的处理逻辑&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-49" value="this.kvConfigManager.load();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="qkaxiBqNsh2hagOEbENo-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-51" value="this.&lt;b&gt;remotingServer&lt;/b&gt; = new &lt;b&gt;NettyRemotingServer&lt;/b&gt;(&lt;br&gt;this.nettyServerConfig, this.&lt;b&gt;brokerHousekeepingService&lt;/b&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-53" target="uRtEAP2a5k4lkSkrBafr-107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-53" value="this.&lt;b&gt;remotingClient&lt;/b&gt; = new &lt;b&gt;NettyRemotingClient&lt;/b&gt;(this.nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-91" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-55" target="uRtEAP2a5k4lkSkrBafr-92" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1420" y="400" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingServer &lt;/b&gt;extends NettyRemotingAbstract implements RemotingServer&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServerBootstrap &lt;b&gt;serverBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupSelector;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupBoss;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;publicExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; r -&amp;gt; new Thread(r, &quot;ServerHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DefaultEventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NettyRemotingServer可能包含多个RemotingServer，默认只有一个&lt;br&gt;//监听端口（默认9876） -&amp;gt; NettyRemotingAbstract&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer/*Port*/, NettyRemotingAbstract&amp;gt; &lt;b&gt;remotingServerTable&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HANDSHAKE_HANDLER_NAME = &quot;handshakeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_DECODER = &quot;HAProxyDecoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_HANDLER = &quot;HAProxyHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_MODE_HANDLER = &quot;TlsModeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_HANDLER_NAME = &quot;sslHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String FILE_REGION_ENCODER_NAME = &quot;fileRegionEncoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TlsModeHandler tlsModeHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyEncoder encoder;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyConnectManageHandler connectionManageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyServerHandler &lt;b&gt;serverHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingCodeDistributionHandler distributionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="440" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="i3243ysWS5UdkbpY5Jqh-1" target="uRtEAP2a5k4lkSkrBafr-92" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1980" y="440" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-59" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;this.defaultThreadPoolQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; (this.namesrvConfig.getDefaultThreadPoolQueueCapacity());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.defaultExecutor =&amp;nbsp; &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ThreadUtils.&lt;b style=&quot;font-size: 9px;&quot;&gt;newThreadPoolExecutor&lt;/b&gt;(this.namesrvConfig.getDefaultThreadPoolNums(), this.namesrvConfig.getDefaultThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.defaultThreadPoolQueue, new ThreadFactoryImpl(&quot;&lt;b style=&quot;font-size: 9px;&quot;&gt;RemotingExecutorThread_&lt;/b&gt;&quot;));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.clientRequestThreadPoolQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;(this.namesrvConfig.getClientRequestThreadPoolQueueCapacity());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.clientRequestExecutor = ThreadUtils.&lt;b style=&quot;font-size: 9px;&quot;&gt;newThreadPoolExecutor&lt;/b&gt;(this.namesrvConfig.getClientRequestThreadPoolNums(), this.namesrvConfig.getClientRequestThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.clientRequestThreadPoolQueue, new ThreadFactoryImpl(&quot;&lt;b style=&quot;font-size: 9px;&quot;&gt;ClientRequestExecutorThread_&lt;/b&gt;&quot;));&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;arcSize=4;align=left;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1160" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-63" target="MQfhwkLH8ELev91oxun4-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="1370" />
              <mxPoint x="1700" y="2940" />
              <mxPoint x="140" y="2940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-63" value="&lt;div&gt;ClientRequestProcessor clientRequestProcessor = new &lt;b&gt;ClientRequestProcessor&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.remotingServer.&lt;b&gt;registerProcessor&lt;/b&gt;(RequestCode.&lt;b&gt;GET_ROUTEINFO_BY_TOPIC&lt;/b&gt;, &lt;b&gt;clientRequestProcessor&lt;/b&gt;, this.clientRequestExecutor); &lt;font color=&quot;#007fff&quot;&gt;//专门获取路由信息的请求处理器&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.remotingServer.&lt;b&gt;registerDefaultProcessor&lt;/b&gt;(new DefaultRequestProcessor(this), this.defaultExecutor);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1340" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-68" value="&lt;div&gt;this.&lt;b&gt;scanExecutorService&lt;/b&gt;.scheduleAtFixedRate(&lt;br&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.routeInfoManager::&lt;b&gt;scanNotActiveBroker&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 5, this.namesrvConfig.getScanNotActiveBrokerInterval(), TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt;.scheduleAtFixedRate(&lt;br&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.kvConfigManager::&lt;b&gt;printAllPeriodically&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 1, 10, TimeUnit.MINUTES);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt;.scheduleAtFixedRate(() -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; NamesrvController.this.&lt;b&gt;printWaterMark&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}, 10, 1, TimeUnit.SECONDS);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="1420" width="440.5" height="140" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-76" value="fileWatchService = new FileWatchService(watchFiles, listener);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-78" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.&lt;b&gt;registerRPCHook&lt;/b&gt;(&lt;br&gt;new ZoneRouteRPCHook());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="1reMIaGBY-K2Yn5TWBya-1" target="uRtEAP2a5k4lkSkrBafr-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="uRtEAP2a5k4lkSkrBafr-113" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-80" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-85" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-82" target="uRtEAP2a5k4lkSkrBafr-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-82" target="1reMIaGBY-K2Yn5TWBya-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240.5" y="2630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-82" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000.5" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-84" target="1reMIaGBY-K2Yn5TWBya-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-84" value="this.&lt;b&gt;routeInfoManager&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-86" value="createAndStartControllerManager();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="510" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-92" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的单向请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore &lt;b&gt;semaphoreOneway&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的异步请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore &lt;b&gt;semaphoreAsync&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此映射缓存所有正在进行的请求。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; &lt;b&gt;responseTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// &lt;b&gt;此容器保存每个请求代码的所有处理器，即对于每个传入的请求，我们可以在此映射中查找响应的处理器来处理请求。&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;&lt;b&gt;NettyRequestProcessor&lt;/b&gt;, ExecutorService&amp;gt;&amp;gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;processorTable&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 实际是一个守护者线程，用于将 netty 事件传递给用户定义的 {@link ChannelEventListener} 的执行器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在没有在 {@link #processorTable} 中找到精确匹配的情况下使用的默认请求处理器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于创建 {@link SslHandler} 的 SSL 上下文。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自定义 RPC 钩子，todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; &lt;b&gt;rpcHooks&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="80" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-94" target="qkaxiBqNsh2hagOEbENo-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-19" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="qkaxiBqNsh2hagOEbENo-18" vertex="1" connectable="0">
          <mxGeometry x="0.6696" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-94" target="qkaxiBqNsh2hagOEbENo-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-22" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="qkaxiBqNsh2hagOEbENo-21" vertex="1" connectable="0">
          <mxGeometry x="0.6224" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-94" value="&lt;div&gt;super(nettyServerConfig.getServerOnewaySemaphoreValue(),&amp;nbsp;&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;nettyServerConfig.getServerAsyncSemaphoreValue());&lt;/div&gt;&lt;div&gt;this.serverBootstrap = new &lt;b&gt;ServerBootstrap&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.nettyServerConfig = nettyServerConfig;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//RocketMQ自定义的Netty事件监听器，NettyEventExecutor这个任务分发事件&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.channelEventListener = channelEventListener;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;publicExecutor&lt;/b&gt; = &lt;b&gt;buildPublicExecutor&lt;/b&gt;(nettyServerConfig);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;scheduledExecutorService&lt;/b&gt; = &lt;b&gt;buildScheduleExecutor&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.eventLoopGroupBoss = &lt;b&gt;buildBossEventLoopGroup&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.eventLoopGroupSelector = &lt;b&gt;buildEventLoopGroupSelector&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;loadSslContext();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="640" width="439.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-102" value="&lt;b&gt;RocketMQ NameServer&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;RocketMQ自行实现了一个简单的命名服务，记录各模块实例信息&lt;br&gt;注意下面代码流程中省略了一些细节&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-107" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;super(nettyClientConfig.getClientOnewaySemaphoreValue(), &lt;br&gt;&amp;nbsp; &amp;nbsp; nettyClientConfig.getClientAsyncSemaphoreValue());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.nettyClientConfig = nettyClientConfig;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.channelEventListener = channelEventListener;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.loadSocksProxyJson();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;int publicThreadNums = nettyClientConfig.getClientCallbackExecutorThreads();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (publicThreadNums &amp;lt;= 0) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; publicThreadNums = 4;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;publicExecutor&lt;/b&gt; = Executors.newFixedThreadPool(publicThreadNums, new ThreadFactoryImpl(&quot;&lt;b&gt;NettyClientPublicExecutor_&lt;/b&gt;&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;scanExecutor&lt;/b&gt; = ThreadUtils.newThreadPoolExecutor(4, 10, 60, TimeUnit.SECONDS,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ArrayBlockingQueue&amp;lt;&amp;gt;(32), new ThreadFactoryImpl(&quot;&lt;b&gt;NettyClientScan_thread_&lt;/b&gt;&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (eventLoopGroup != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.eventLoopGroupWorker = eventLoopGroup;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;eventLoopGroupWorker&lt;/b&gt; = new &lt;b&gt;NioEventLoopGroup&lt;/b&gt;(1, new ThreadFactoryImpl(&quot;NettyClientSelector_&quot;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.defaultEventExecutorGroup = eventExecutorGroup;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (nettyClientConfig.isUseTLS()) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="820" width="439.5" height="300" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-113" target="uRtEAP2a5k4lkSkrBafr-115" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-113" target="uRtEAP2a5k4lkSkrBafr-123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-113" value="&lt;div&gt;this.&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt; = &lt;br&gt;new DefaultEventExecutorGroup(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建用于处理Netty请求的线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1760" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-119" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-115" value="prepareSharableHandlers();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;有5个ChannelHandler是共享的&lt;br&gt;即所有pipeline中使用同一实例，都需要注释&lt;br&gt;&amp;nbsp;@ChannelHandler.Sharable&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1840" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-117" value="tlsModeHandler = new&amp;nbsp; &lt;br&gt;&amp;nbsp; TlsModeHandler(TlsSystemConfig.tlsMode);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;encoder&lt;/b&gt; = new NettyEncoder();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;connectionManageHandler&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; NettyConnectManageHandler();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;serverHandler&lt;/b&gt; = new NettyServerHandler();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;distributionHandler&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; RemotingCodeDistributionHandler();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;arcSize=8;align=left;" parent="1" vertex="1">
          <mxGeometry x="1479" y="1820" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-122" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-126" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-125" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-119" value="serverBootstrap.group(...)&lt;br&gt;.channel(...).option(...).childOption(...)&lt;br&gt;.localAddress()...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;ServerBootstrap 初始化配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1940" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-124" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-121" target="uRtEAP2a5k4lkSkrBafr-123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-121" value=".childHandler((ChannelInitializer)ch -&amp;gt; {&lt;br&gt;&lt;b&gt;configChannel&lt;/b&gt;(ch);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="1940" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-173" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.508;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;dashed=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-123" target="uRtEAP2a5k4lkSkrBafr-145" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2070" y="1970" />
              <mxPoint x="2070" y="1360" />
              <mxPoint x="2222" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-1" value="请求处理" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="uRtEAP2a5k4lkSkrBafr-173" vertex="1" connectable="0">
          <mxGeometry x="0.6736" y="3" relative="1" as="geometry">
            <mxPoint x="39" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-123" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;return ch.pipeline()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;, HANDSHAKE_HANDLER_NAME, new &lt;b&gt;HandshakeHandler&lt;/b&gt;())&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;encoder&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyDecoder&lt;/b&gt;(),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;distributionHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;connectionManageHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;serverHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; );&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1890" width="319.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-128" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-125" target="uRtEAP2a5k4lkSkrBafr-127" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-125" value="addCustomConfig(serverBootstrap);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;为 serverBootstrap 设置额外的&amp;nbsp;childOption&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-127" target="uRtEAP2a5k4lkSkrBafr-129" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-127" value="ChannelFuture sync = serverBootstrap.bind().sync();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="2100" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-129" target="uRtEAP2a5k4lkSkrBafr-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-129" value="this.&lt;b&gt;remotingServerTable&lt;/b&gt;.put(&lt;br&gt;this.nettyServerConfig.getListenPort(), this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2180" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-131" target="uRtEAP2a5k4lkSkrBafr-133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-131" value="&lt;div&gt;if (this.channelEventListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.nettyEventExecutor.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动监听Netty请求事件并分发给ChannelEventListener的线程&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2260" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-135" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-139" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-133" value="this.timer.newTimeout(&lt;br&gt;&lt;b&gt;timerScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2340" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-135" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期扫描并处理过期的请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2340" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-139" target="uRtEAP2a5k4lkSkrBafr-141" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-139" value="scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleWithFixedDelay&lt;/b&gt;(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1239.5" y="2420" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-141" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;printRemotingCodeDistribution&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2420" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="uRtEAP2a5k4lkSkrBafr-161" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2360" y="1440" />
              <mxPoint x="2360" y="1200" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-178" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-4" target="uRtEAP2a5k4lkSkrBafr-148" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-145" value="HandshakeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;握手处理，借助&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;检测是否是Proxy Protocol 类型, 这个主要是为了支持&lt;b&gt;HAProxy&lt;/b&gt;代理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1410" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-179" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-148" target="uRtEAP2a5k4lkSkrBafr-150" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-148" value="NettyDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是RocketMQ自定义的解码器，继承&lt;br&gt;&lt;b&gt;LengthFieldBasedFrameDecoder&lt;/b&gt;&lt;br&gt;按照右方的格式进行解码&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120" y="1730" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-180" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-150" target="uRtEAP2a5k4lkSkrBafr-151" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-150" value="RemotingCodeDistributionHandler&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;Netty各请求码的请求进入与发出的计数器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2120" y="1810" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-181" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-151" target="uRtEAP2a5k4lkSkrBafr-154" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-151" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1890" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-182" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-154" target="uRtEAP2a5k4lkSkrBafr-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-154" value="&lt;div&gt;NettyRemotingServer$&lt;/div&gt;&lt;div&gt;NettyConnectManageHandler&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;处理与Broker节点的Netty通道连接、关闭、以及空闲事件，发布对应的事件交给NettyEventExecutor 线程处理&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1970" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-183" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-155" target="uRtEAP2a5k4lkSkrBafr-171" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-155" target="MQfhwkLH8ELev91oxun4-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-155" value="NettyServerHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;相当于是 NettyRequestProcessor 的代理&lt;br&gt;共享的处理器&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2120" y="2050" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-161" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ProtocolDetectionResult&amp;lt;HAProxyProtocolVersion&amp;gt; detectionResult = HAProxyMessageDecoder.detectProtocol(byteBuf);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if (detectionResult.state() == ProtocolDetectionState.NEEDS_MORE_DATA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//其实是半包处理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;if (detectionResult.state() == ProtocolDetectionState.DETECTED) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), HA_PROXY_DECODER, new &lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_DECODER, HA_PROXY_HANDLER, new &lt;b&gt;HAProxyMessageHandler&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_HANDLER, TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ctx.pipeline().remove(this);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;即检测到使用了Proxy Protocol 就添加先在 HandshakeHandler 后添加&amp;nbsp;HAProxyMessageDecoder、HAProxyMessageHandler、&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;TlsModeHandler，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;然后再删除当前的 HandshakeHandler；&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1110" width="600" height="180" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-166" value="NettyEncoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2490" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-187" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-169" target="uRtEAP2a5k4lkSkrBafr-177" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-169" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2330" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-185" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-170" target="uRtEAP2a5k4lkSkrBafr-169" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-170" value="NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2119.5" y="2250" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-184" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-171" target="uRtEAP2a5k4lkSkrBafr-170" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-171" target="MQfhwkLH8ELev91oxun4-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-171" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2119.5" y="2170" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-175" value="InBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2110.5" y="1370" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-176" value="OutBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2110.5" y="2130" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-188" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-177" target="uRtEAP2a5k4lkSkrBafr-166" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-177" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2119" y="2410" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-6" target="Lc81XJVoeO8ClW7Fo5lE-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1510" as="sourcePoint" />
            <mxPoint x="2220" y="1730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-2" target="x9bTwj67HdBwY7-d5Wo_-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-2" value="HAProxyMessageHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要就是将连接信息存储起来，这里将信息存储到了channel的属性表&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1570" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-2" target="Lc81XJVoeO8ClW7Fo5lE-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1590" as="sourcePoint" />
            <mxPoint x="2220" y="1730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-4" target="x9bTwj67HdBwY7-d5Wo_-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-4" value="TlsModeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;提供 TLS 支持处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1650" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="Lc81XJVoeO8ClW7Fo5lE-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2220" y="1510" as="sourcePoint" />
            <mxPoint x="2220" y="1570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Lc81XJVoeO8ClW7Fo5lE-6" target="x9bTwj67HdBwY7-d5Wo_-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2380" y="1520" />
              <mxPoint x="2380" y="1340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Lc81XJVoeO8ClW7Fo5lE-6" value="HAProxyMessageDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Proxy协议仅仅就是最开始多传递了个代理协议头部信息，通过这个解码器解析协议版本，协议&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2120.5" y="1490" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&lt;/b&gt; extends NettyRemotingAbstract implements RemotingClient&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Bootstrap &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupWorker;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; bootstrapMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; channelTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer timer = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; &lt;b&gt;namesrvAddrList&lt;/b&gt; = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="440" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-2" value="&lt;b&gt;NettyRemotingServer&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1266" y="1730" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-3" value="&lt;b&gt;NettyRemotingClient&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1268" y="2570" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-8" value="&lt;font color=&quot;#007fff&quot;&gt;关于连接接入，传输层的处理参考 netty.drawio&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2100" y="1310" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i3243ysWS5UdkbpY5Jqh-11" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;ByteToMessageDecoder&lt;/b&gt;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;extends&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ChannelInboundHandlerAdapter&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Netty基础的解码器，很多消息解码器继承这个解码器，像数据包半包、粘包等情况的处理就是在编解码器中处理的&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过使用内存副本将 ByteBufs 合并为一个 ByteBuf 来累积 ByteBuf&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;public static final Cumulator &lt;b&gt;MERGE_CUMULATOR&lt;/b&gt; = (alloc, cumulation, in) -&amp;gt; {...};&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过将 ByteBufs 添加到 CompositeByteBuf 来累积 ByteBuf而尽可能不使用内存复制。请注意，CompositeByteBuf 使用更复杂的索引实现，根据您的用例和解码器实现这可能相比仅使用MERGE_CUMULATOR会更慢&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;public static final Cumulator &lt;b&gt;COMPOSITE_CUMULATOR&lt;/b&gt;&amp;nbsp;= (alloc, cumulation, in) -&amp;gt; {...};&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//位掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_INIT = 0;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_CALLING_CHILD_DECODE = 1;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final byte STATE_HANDLER_REMOVED_PENDING = 2;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于存储累积数据的ByteBuf，就像是一个&lt;b&gt;数据池&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;ByteBuf &lt;b&gt;cumulation&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认使用&amp;nbsp;MERGE_CUMULATOR 累积数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Cumulator &lt;b&gt;cumulator&lt;/b&gt; = MERGE_CUMULATOR;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否在每次&amp;nbsp;channelRead(ChannelHandlerContext, Object) 调用中仅解码一个消息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;singleDecode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;first&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//此标志决定我们是否需要调用 {@link ChannelHandlerContext#read()} 来消费更多的数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;firedChannelRead&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//STATE_INIT 的位掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private byte &lt;b&gt;decodeState&lt;/b&gt; = STATE_INIT;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//设置调用 ByteBuf.discardSomeReadBytes() 的读取次数，从而释放内存。默认值为 16。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;discardAfterReads&lt;/b&gt; = 16;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//累积读取次数（channelRead()次数），msg 没有更多数据或者超过 discardAfterReads 后清0&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//何时会累加？比如每次 channelRead 都传了很多条消息（比如操作系统底层机制中粘包发送），但是我配置了singleDecode = true, 在 callDecode 中每次只处理一个消息，这样就会导致 cumulator 中数据积累的越来越多。一旦超过 discardAfterReads 就会&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;numReads&lt;/b&gt;;&lt;/p&gt;&lt;br&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//返回此解码器的内部累积缓冲区。通常不需要直接访问内部缓冲区来编写解码器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ByteBuf internalBuffer()&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="880" width="520" height="480" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-1" target="i3243ysWS5UdkbpY5Jqh-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ByteToMessageDecoder&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServerBootstrap &lt;b&gt;serverBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupSelector;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupBoss;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;publicExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; r -&amp;gt; new Thread(r, &quot;ServerHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DefaultEventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NettyRemotingServer可能包含多个SubRemotingServer&lt;br&gt;//监听端口 -&amp;gt; NettyRemotingAbstract&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer/*Port*/, NettyRemotingAbstract&amp;gt; &lt;b&gt;remotingServerTable&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HANDSHAKE_HANDLER_NAME = &quot;handshakeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_DECODER = &quot;HAProxyDecoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_HANDLER = &quot;HAProxyHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_MODE_HANDLER = &quot;TlsModeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_HANDLER_NAME = &quot;sslHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String FILE_REGION_ENCODER_NAME = &quot;fileRegionEncoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TlsModeHandler tlsModeHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyEncoder encoder;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyConnectManageHandler connectionManageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyServerHandler &lt;b&gt;serverHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingCodeDistributionHandler distributionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="1400" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-3" target="x9bTwj67HdBwY7-d5Wo_-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-3" value="channelRead(ChannelHandlerContext ctx, Object msg)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1310" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-5" target="x9bTwj67HdBwY7-d5Wo_-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-5" value="&lt;b style=&quot;background-color: initial;&quot;&gt;cumulation&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = cumulator.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;cumulate&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(&lt;br&gt;ctx.alloc(),&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;first ?Unpooled.EMPTY_BUFFER : cumulation, (ByteBuf) msg);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将msg通过内存复制的方式累积到cumulation&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1310" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-7" target="x9bTwj67HdBwY7-d5Wo_-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-7" target="x9bTwj67HdBwY7-d5Wo_-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-7" value="&lt;div&gt;CodecOutputList out = CodecOutputList.newInstance();&lt;/div&gt;&lt;b&gt;callDecode&lt;/b&gt;(ctx, cumulation, out);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;调用解码逻辑将累积的ByteBuf内容输出到 CodecOutputList实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-9" target="x9bTwj67HdBwY7-d5Wo_-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-9" value="&lt;div&gt;循环通过&amp;nbsp;&lt;/div&gt;&lt;div&gt;decodeRemovalReentryProtection(ctx, in, out); 读取 ByteBuf 内容到 out&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-11" target="x9bTwj67HdBwY7-d5Wo_-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-11" value="&lt;div&gt;&lt;b&gt;decode&lt;/b&gt;(ctx, in, out);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;先从ByteBuf in 中读取&lt;b&gt;协议规范版本&lt;/b&gt;，&lt;br&gt;然后使用对应版本的&lt;b&gt;StructHeaderExtractor提取头部信息&lt;/b&gt;，然后解码头部数据到&lt;b&gt;out，&lt;/b&gt;是&lt;b&gt;HAProxyMessage类型&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3120" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-13" value="&lt;div&gt;finally:&lt;/div&gt;&lt;div&gt;如果没有更多内容可读就释放 cumulation, 如果cumulation一直未读取完毕且读取次数超过discardAfterReads限制，则丢弃后面数据&lt;/div&gt;&lt;div&gt;firedChannelRead |= out.insertSinceRecycled();&lt;/div&gt;&lt;div&gt;&lt;b&gt;fireChannelRead&lt;/b&gt;(ctx, out, size);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2640" y="1470" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-15" value="&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;从Netty源码知，&lt;br&gt;每个连接有一套独立的pipeline,&lt;br&gt;而里面的ChannelHandler 可能是共享的，&lt;br&gt;也可能是独立的，看 configChannel时是&lt;br&gt;新建（new）还是直接传参已有的实例&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1840" y="1365" width="230" height="90" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-16" value="&lt;div&gt;&lt;div&gt;out.add(HAProxyMessage&lt;/div&gt;&lt;div&gt;.&lt;b&gt;decodeHeader&lt;/b&gt;(decoded));&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;将数据转成 HAProxyMessage对象存入 out&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3360" y="1390" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-18" target="x9bTwj67HdBwY7-d5Wo_-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-18" value="仅仅是提供对 HAProxyMessage 的进一步处理，HAProxyMessageDecoder 解析出的 HAProxyMessage 需要存储起来" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1570" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="x9bTwj67HdBwY7-d5Wo_-20" target="x9bTwj67HdBwY7-d5Wo_-22" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2860" y="1670" />
              <mxPoint x="2860" y="1670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-20" value="channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_ADDR).set(msg.sourceAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_PORT).set(String.valueOf(msg.sourcePort()));&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_ADDR).set(msg.destinationAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_PORT)&lt;br&gt;.set(String.valueOf(msg.destinationPort()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2640.5" y="1570" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-22" value="&lt;div&gt;msg.tlvs().forEach(tlv -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; handleHAProxyTLV(tlv, channel);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;todo, 和 SSL等处理有关&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="2760.25" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="x9bTwj67HdBwY7-d5Wo_-24" value="&lt;div&gt;检测传入数据的开头是否为 TLS 握手的魔术码。&lt;/div&gt;&lt;div&gt;根据配置的 TLS 模式，对客户端的连接请求做出相应的响应。&lt;/div&gt;&lt;div&gt;如果启用了 SSL 连接，则在 ChannelPipeline 中添加相应的 SSL 处理器。&lt;/div&gt;&lt;div&gt;移除自身这个 Handler。&lt;/div&gt;&lt;div&gt;将处理后的消息传递给 ChannelPipeline 中的下一个 Handler。&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1640" width="281.25" height="80" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="qkaxiBqNsh2hagOEbENo-1" target="qkaxiBqNsh2hagOEbENo-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-1" value="创建两个ScheduledExecutorService" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-4" value="&lt;div&gt;this.namesrvConfig = namesrvConfig;&lt;/div&gt;&lt;div&gt;this.nettyServerConfig = nettyServerConfig;&lt;/div&gt;&lt;div&gt;this.nettyClientConfig = nettyClientConfig;&lt;/div&gt;&lt;div&gt;this.kvConfigManager = new &lt;b&gt;KVConfigManager&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.brokerHousekeepingService = new &lt;b&gt;BrokerHousekeepingService&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;this.routeInfoManager = new &lt;b&gt;RouteInfoManager&lt;/b&gt;(namesrvConfig, this);&lt;/div&gt;&lt;div&gt;this.configuration = new &lt;b&gt;Configuration&lt;/b&gt;(LOGGER, this.namesrvConfig, this.nettyServerConfig);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.configuration.setStorePathFromConfig(this.namesrvConfig, &quot;configStorePath&quot;);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1001" y="400" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="qkaxiBqNsh2hagOEbENo-7" target="qkaxiBqNsh2hagOEbENo-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-7" value="&lt;div&gt;scheduledExecutorService = ThreadUtils.newScheduledThreadPool(1,&lt;/div&gt;&lt;div&gt;new BasicThreadFactory.Builder().namingPattern(&quot;&lt;b&gt;NSScheduledThread&lt;/b&gt;&quot;).daemon(true).build());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="1241" y="240" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-9" value="&lt;div&gt;scanExecutorService = ThreadUtils.newScheduledThreadPool(1,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new BasicThreadFactory.Builder().namingPattern(&quot;&lt;b&gt;NSScanScheduledThread&lt;/b&gt;&quot;).daemon(true).build());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="1240" y="320" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-12" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;主要逻辑：&lt;br&gt;&lt;/b&gt;&lt;/font&gt;1）创建两个计划任务线程池&lt;br&gt;2）初始化 NamesrvController 内部组件&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="280" y="300" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y9gi6OcHUz6zn1ZT-3La-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="qkaxiBqNsh2hagOEbENo-14" target="y9gi6OcHUz6zn1ZT-3La-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-14" value="&lt;font color=&quot;#007fff&quot;&gt;创建一个守护者线程，用于监听队列中Netty事件（NettyEvent）并发给 ChannelEventListener&lt;br&gt;这里的 &lt;b&gt;ChannelEventListener&lt;/b&gt; 实例是 namesrv 模块中的&amp;nbsp;&lt;b&gt;BrokerHousekeepingService&lt;/b&gt;&lt;br&gt;&lt;/font&gt;protected final NettyEventExecutor nettyEventExecutor = new &lt;b&gt;NettyEventExecutor&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;br&gt;private final HashedWheelTimer timer = new &lt;b&gt;HashedWheelTimer&lt;/b&gt;(r -&amp;gt; new Thread(r,&amp;nbsp; &lt;br&gt;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&quot;ServerHouseKeepingService&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="540" width="439.5" height="80" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-17" value="return Executors.&lt;b&gt;newFixedThreadPool&lt;/b&gt;(publicThreadNums, new &lt;br&gt;&amp;nbsp; &amp;nbsp; ThreadFactoryImpl(&quot;NettyServerPublicExecutor_&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;" parent="1" vertex="1">
          <mxGeometry x="1960" y="640" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qkaxiBqNsh2hagOEbENo-20" value="&lt;div&gt;return ThreadUtils.&lt;b&gt;newScheduledThreadPool&lt;/b&gt;(1,&lt;/div&gt;&lt;div&gt;new ThreadFactoryImpl(&quot;NettyServerScheduler_&quot;, true),&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;new ThreadPoolExecutor.DiscardOldestPolicy());&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;" parent="1" vertex="1">
          <mxGeometry x="1960" y="720" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="1reMIaGBY-K2Yn5TWBya-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1100" y="1820" as="sourcePoint" />
            <mxPoint x="1098" y="2620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-1" value="this.remotingClient&lt;br&gt;.updateNameServerAddressList(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="1reMIaGBY-K2Yn5TWBya-3" target="1reMIaGBY-K2Yn5TWBya-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-3" value="&lt;div&gt;this.&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt; = &lt;br&gt;new DefaultEventExecutorGroup(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建用于处理Netty响应的线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="1reMIaGBY-K2Yn5TWBya-4" target="1reMIaGBY-K2Yn5TWBya-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-4" value="this.bootstrap.group(...)&lt;br&gt;.channel(...).option(...).childOption(...)&lt;br&gt;.localAddress()...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Bootstrap 初始化配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-6" value="&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;nettyEventExecutor&lt;/b&gt;.start();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;this.timer.newTimeout(&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left; font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;this.timer.newTimeout(&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2760" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1reMIaGBY-K2Yn5TWBya-8" value="this.unRegisterService.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Broker注销服务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="2860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-1" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;报文&lt;br&gt;长度&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1760" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-2" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;头部&lt;br&gt;长度&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2479.5" y="1760" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-3" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;RocketMQ命令JSON格式序列化编码后：&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1730" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-4" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;协议&lt;br&gt;类型&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2439.5" y="1760" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-5" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;报文长度（4bytes）：4 + headerSize + bodySize （没有算报文长度字段的4字节长度）&lt;br&gt;协议类型（1bytes）：JSON（0）、ROCKETMQ（1）&lt;br&gt;头部长度（3bytes）&lt;br&gt;头部内容：&lt;b&gt;注意看源码实际是将整个RemotingCommand对象序列化后写到了头部内容区域&lt;/b&gt;&lt;br&gt;JSON序列化是使用的FastJson工具。&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2680.75" y="1730" width="430" height="90" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-6" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;头部&lt;br&gt;内容&lt;br&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2519.5" y="1760" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="7X-lJwlq-AZff7wvAJcF-7" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;消息体&lt;br&gt;内容&lt;br&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2599.5" y="1760" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="J-j0uoPCWoi-A7m3jXjP-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;有数据可读时，解析请求码，并在 inboundDistribution 中为对应的 LongAddr 计数+1&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2399.5" y="1825" width="400" height="30" as="geometry" />
        </mxCell>
        <mxCell id="J-j0uoPCWoi-A7m3jXjP-3" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;RemotingCodeDistributionHandler&lt;/b&gt; extends ChannelDuplexHandler&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Netty各请求码的请求进入与发出的计数器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录各个请求码的请求的Inbound次数，请求码 -&amp;gt; LongAddr计数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer, LongAdder&amp;gt; inboundDistribution;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录各个请求码的请求的outbound次数，请求码 -&amp;gt; LongAddr计数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer, LongAdder&amp;gt; outboundDistribution;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="880" width="520" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Wfp0nVyENlQ4jSQKXHcK-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;内部将事件交给 BrokerHousekeepingService 处理&lt;br&gt;只是在与Broker的连接Channel关闭、异常、因空闲超时关闭时销毁在 RouteInfoManager 中的路由信息&lt;br&gt;只作用于 Broker 和 NameServer 的Netty连接&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2400" y="1975" width="480" height="60" as="geometry" />
        </mxCell>
        <mxCell id="y9gi6OcHUz6zn1ZT-3La-1" value="&lt;b&gt;BrokerHousekeepingService&lt;/b&gt;#&lt;br&gt;&lt;b&gt;onChannelXxx&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是在Broker连接关闭、异常时清理下Broker路由信息&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=12;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1960.5" y="550" width="199.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;通过Channel绑定的端口选择RemotingServer，再通过请求码（RequestCode）或响应码从NettyRemotingServer &lt;b style=&quot;&quot;&gt;processorTable&lt;/b&gt;&lt;br&gt;或 &lt;b&gt;responseTable&lt;/b&gt; 中选择对应的 NettyRequestProcessor ResponseFuture处理&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2400" y="2120" width="600" height="40" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="MQfhwkLH8ELev91oxun4-2" target="MQfhwkLH8ELev91oxun4-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-2" value="processRequestCommand(ctx, msg);&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;找到匹配的处理器和上下文等信息封装成RequestTask 提交到处理器制定的线程池中异步执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2399" y="2050" width="201" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-5" value="processResponseCommand(ctx, msg);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2398.5" y="2170" width="201.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-7" value="final Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; matched = this.processorTable.get(cmd.getCode());&lt;br&gt;final int opaque = cmd.getOpaque();&lt;br&gt;&lt;div style=&quot;&quot;&gt;Runnable run = &lt;b&gt;buildProcessRequestHandler&lt;/b&gt;(ctx, cmd, pair, opaque);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final RequestTask requestTask = new &lt;b&gt;RequestTask&lt;/b&gt;(run, ctx.channel(), cmd);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;pair.getObject2().&lt;b&gt;submit&lt;/b&gt;(requestTask);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="2640" y="2040" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="MQfhwkLH8ELev91oxun4-9" target="MQfhwkLH8ELev91oxun4-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="MQfhwkLH8ELev91oxun4-9" target="-xlFMzJ-DY4f2ZiYv_yZ-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-9" value="请求处理器&lt;br&gt;NettyRequestProcessor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里只展示注册的两个请求处理器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="MQfhwkLH8ELev91oxun4-10" target="MQfhwkLH8ELev91oxun4-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-10" value="DefaultRequestProcessor&amp;nbsp;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="GldkGT82WNLh4XqGUqAd-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="MQfhwkLH8ELev91oxun4-12" target="GldkGT82WNLh4XqGUqAd-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="940" y="3110" />
              <mxPoint x="940" y="2990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="GldkGT82WNLh4XqGUqAd-3" value="103" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="GldkGT82WNLh4XqGUqAd-2" vertex="1" connectable="0">
          <mxGeometry x="0.6899" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yGQmKQBC3qj4uak957hq-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="MQfhwkLH8ELev91oxun4-12" target="yGQmKQBC3qj4uak957hq-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="940" y="3110" />
              <mxPoint x="940" y="3070" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="yGQmKQBC3qj4uak957hq-3" value="217" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="yGQmKQBC3qj4uak957hq-2" vertex="1" connectable="0">
          <mxGeometry x="0.4972" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="MQfhwkLH8ELev91oxun4-12" value="&lt;div&gt;RequestCode.PUT_KV_CONFIG&lt;/div&gt;&lt;div&gt;RequestCode.GET_KV_CONFIG&lt;/div&gt;&lt;div&gt;RequestCode.DELETE_KV_CONFIG&lt;/div&gt;&lt;div&gt;RequestCode.QUERY_DATA_VERSION&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//103, 注册Broker节点，每个Broker节点每几秒都会向NameServer注册一下自己&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;RequestCode.&lt;b&gt;REGISTER_BROKER &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;RequestCode.&lt;b&gt;UNREGISTER_BROKER&lt;/b&gt;&lt;/div&gt;&lt;div&gt;RequestCode.&lt;b&gt;BROKER_HEARTBEAT&lt;/b&gt;&lt;/div&gt;&lt;div&gt;RequestCode.GET_BROKER_MEMBER_GROUP&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//106, 获取Broker集群信息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;RequestCode.&lt;b&gt;GET_BROKER_CLUSTER_INFO&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;RequestCode.WIPE_WRITE_PERM_OF_BROKER&lt;/div&gt;&lt;div&gt;RequestCode.ADD_WRITE_PERM_OF_BROKER&lt;/div&gt;&lt;div&gt;RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER&lt;/div&gt;&lt;div&gt;RequestCode.DELETE_TOPIC_IN_NAMESRV&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//217，注册Topic到NameServer, 只是用于重启时将之前已经创建的Topic重新注册到NameServer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;RequestCode.&lt;b&gt;REGISTER_TOPIC_IN_NAMESRV&lt;/b&gt;&lt;/div&gt;&lt;div&gt;RequestCode.GET_KVLIST_BY_NAMESPACE&lt;/div&gt;&lt;div&gt;RequestCode.GET_TOPICS_BY_CLUSTER&lt;/div&gt;&lt;div&gt;RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS&lt;/div&gt;&lt;div&gt;RequestCode.GET_UNIT_TOPIC_LIST&lt;/div&gt;&lt;div&gt;RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST&lt;/div&gt;&lt;div&gt;RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST&lt;/div&gt;&lt;div&gt;RequestCode.UPDATE_NAMESRV_CONFIG&lt;/div&gt;&lt;div&gt;RequestCode.GET_NAMESRV_CONFIG&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="520" y="2960" width="400" height="300" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="-xlFMzJ-DY4f2ZiYv_yZ-1" target="-xlFMzJ-DY4f2ZiYv_yZ-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-1" value="ClientRequestProcessor&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;只处理RequestCode.&lt;b&gt;GET_ROUTEINFO_BY_TOPIC&lt;/b&gt;&lt;br&gt;每个客户端每隔几秒就会请求刷新一下本地路由信息&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="3290" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="-xlFMzJ-DY4f2ZiYv_yZ-4" target="-xlFMzJ-DY4f2ZiYv_yZ-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-4" value="ClientRequestProcessor#&lt;br&gt;&lt;b&gt;getRouteInfoByTopic&lt;/b&gt;(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="3290" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-6" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这个方法解释了某个Topic的消息发送以及消费应该请求哪个Broker节点地址的问题，&lt;br&gt;结合Producer源码知新建的主题默认会使用 &lt;b&gt;TBW102&lt;/b&gt; 的Broker节点路由信息，而这个 &lt;b&gt;TBW102 的路由信息是在注册Broker时注册的&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&quot;TBW102&quot; -&amp;gt; {HashMap@18352}&amp;nbsp; size = 1&lt;/div&gt;&lt;div&gt;&amp;nbsp; key = &quot;TBW102&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; value = {HashMap@18352}&amp;nbsp; size = 1&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &quot;broker-a&quot; -&amp;gt; {QueueData@18360} &quot;QueueData [brokerName=broker-a, readQueueNums=8, writeQueueNums=8, perm=7, topicSysFlag=0]&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; key = &quot;broker-a&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; value = {QueueData@18360} &quot;QueueData [brokerName=broker-a, readQueueNums=8, writeQueueNums=8, perm=7, topicSysFlag=0]&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerName = &quot;broker-a&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; readQueueNums = 8&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; writeQueueNums = 8&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; perm = 7&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; topicSysFlag = 0&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="520" y="3360" width="660" height="170" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-7" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;先抛出几个重要问题（然后看下RocketMQ怎么实现的）：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;ul style=&quot;font-size: 10px;&quot;&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;生产某主题消息的时候并没有设置(也没法设置)消息应该存储在哪个Broker节点，NameServer到底是怎么选择以及记录Topic -&amp;gt; Broker节点的路由的？&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;答案在 ClientRequestProcessor#getRouteInfoByTopic() 方法中，生产者的源码可以看到是使用的 TBW102 这个主题的路由信息&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;配置、消息等数据的持久化机制。&lt;/li&gt;&lt;/ul&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="10" width="640" height="150" as="geometry" />
        </mxCell>
        <mxCell id="-xlFMzJ-DY4f2ZiYv_yZ-9" value="...&lt;br&gt;TopicRouteData topicRouteData = this.namesrvController.getRouteInfoManager()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;pickupTopicRouteData&lt;/b&gt;(requestHeader.getTopic());&lt;br&gt;...&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;这里面会查询Topic的Broker路由信息并选择一个返回，如果没有的话会直接返回null，即并不会为不存在的主题自动选择路由&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="3280" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="63h_fX4H9zoi2UHSpp6--1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="S6vRM9OLHSeni7QlyEma-1" target="7GYCDW63MonnmuBh_o8K-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S6vRM9OLHSeni7QlyEma-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicRouteData&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;主题路由信息&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String orderTopicConf;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即主题消息存储的消息队列信息（位于的Broker名、读写索引[readQueueNums、writeQueueNums]、perm等&lt;span style=&quot;background-color: initial;&quot;&gt;）&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;QueueData&amp;gt; &lt;b&gt;queueDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即queueDatas中Broker的信息（所属集群名、Broker名、broker实例地址[这里看到可能有多个]等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;BrokerData&amp;gt; &lt;b&gt;brokerDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HashMap&amp;lt;String/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可能为空，todo&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt; topicQueueMappingByBroker;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="880" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="GldkGT82WNLh4XqGUqAd-1" target="E4m4unHSNSP0zs8HY3to-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="GldkGT82WNLh4XqGUqAd-1" value="&lt;b&gt;registerBroker&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是更新RouteInfoManager Broker路由信息，包括下面的 TBW102 主题路由信息，用户创建的主题在首次发送消息时会由Broker创建并通过此处理器注册到NameServer&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1001" y="2960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="yGQmKQBC3qj4uak957hq-1" value="&lt;b&gt;registerTopicToNamesrv&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="3040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7GYCDW63MonnmuBh_o8K-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BrokerData&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;主题路由信息&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//集群名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;cluster&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Broker节点名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;brokerName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Broker节点地址列表，brokerId（0是Master，&amp;gt;=1 是 Slave） -&amp;gt; Broker节点地址&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HashMap&amp;lt;Long, String&amp;gt; &lt;b&gt;brokerAddrs&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;zoneName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从节点是否允许升级为主节点，用于旧版本的HA适配&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;enableActingMaster&lt;/b&gt; = false;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="880" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="HkKYDQLv04MGSXf4qCC--1" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;这块代码解释了请求是怎么从&amp;nbsp;NettyServerHandler 转交给 Processor 进行处理的&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1480.5" y="510" width="460" height="30" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="E4m4unHSNSP0zs8HY3to-1" target="E4m4unHSNSP0zs8HY3to-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-1" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;RegisterBrokerResult result = this.namesrvController.&lt;b&gt;getRouteInfoManager&lt;/b&gt;().&lt;b&gt;registerBroker&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getClusterName(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getBrokerAddr(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getBrokerName(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getBrokerId(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getHaServerAddr(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; request.getExtFields().get(MixAll.ZONE_NAME),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getHeartbeatTimeoutMillis(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; requestHeader.getEnableActingMaster(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; topicConfigWrapper,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; filterServerList,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.channel()&lt;/div&gt;&lt;div&gt;);&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1241" y="2960" width="439" height="180" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-3" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;BrokerData brokerData = this.brokerAddrTable.get(brokerName);&lt;/div&gt;&lt;div&gt;brokerData.setEnableActingMaster(!isOldVersionBroker &amp;amp;&amp;amp; enableActingMaster);&lt;br&gt;&lt;/div&gt;&lt;div&gt;brokerData.setZoneName(zoneName);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;for (Map.Entry&amp;lt;String, TopicConfig&amp;gt; entry : tcTable.entrySet()) {&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 每注册一个Broker节点都会为每个默认的主题添加一条Broker路由信息以及队列配置信息&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 这里解释了 TBW102 等默认主题的Broker路由信息怎么来的&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;this.&lt;b&gt;createAndUpdateQueueData&lt;/b&gt;(brokerName, topicConfig);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1721" y="2960" width="439" height="180" as="geometry" />
        </mxCell>
        <mxCell id="E4m4unHSNSP0zs8HY3to-6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;默认创建的主题&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;topicQueueTable = {ConcurrentHashMap@3272}&amp;nbsp; size = 12&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;SCHEDULE_TOPIC_XXXX&quot; -&amp;gt; {HashMap@3863}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;SELF_TEST_TOPIC&quot; -&amp;gt; {HashMap@3865}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;DefaultCluster&quot; -&amp;gt; {HashMap@3867}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;DefaultCluster_REPLY_TOPIC&quot; -&amp;gt; {HashMap@3869}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;rmq_sys_REVIVE_LOG_DefaultCluster&quot; -&amp;gt; {HashMap@3871}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;RMQ_SYS_TRANS_HALF_TOPIC&quot; -&amp;gt; {HashMap@3873}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;rmq_sys_SYNC_BROKER_MEMBER_broker-a&quot; -&amp;gt; {HashMap@3875}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;&lt;b&gt;broker-a&lt;/b&gt;&quot; -&amp;gt; {HashMap@3877}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;RMQ_SYS_TRANS_OP_HALF_TOPIC&quot; -&amp;gt; {HashMap@3879}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;&lt;b&gt;TBW102&lt;/b&gt;&quot; -&amp;gt; {HashMap@3881}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;BenchmarkTest&quot; -&amp;gt; {HashMap@3883}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&quot;OFFSET_MOVED_EVENT&quot; -&amp;gt; {HashMap@3885}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="365" width="380" height="180" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="XyQ5pNo4CcYP3uo7oZJW" name="Broker">
    <mxGraphModel dx="3915" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="_vTxldMSkyuMYbInRsxu-1" target="io5fEsn8NokLgAYsNQZp-36" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2300" y="4100" />
              <mxPoint x="2300" y="1180" />
              <mxPoint x="1460" y="1180" />
              <mxPoint x="1460" y="845" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-2" target="EGYwnP1GJaqrjVY5u9EW-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-2" target="iXBdxiTUZG9k7DSO9CjL-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-2" value="Broker代理服务启动&lt;br&gt;&lt;b&gt;BrokerStartup&lt;/b&gt;#main()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-4" target="EGYwnP1GJaqrjVY5u9EW-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-4" target="EGYwnP1GJaqrjVY5u9EW-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-4" value="&lt;b&gt;createBrokerController&lt;/b&gt;(args)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-5" target="EGYwnP1GJaqrjVY5u9EW-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-5" target="UH9uaCllqP1BWi3zPepl-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-5" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;BrokerController controller = &lt;b style=&quot;&quot;&gt;buildBrokerController&lt;/b&gt;(args);&lt;br&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;先解析命令行参数、配置文件，将配置信息写入&amp;nbsp;brokerConfig、nettyServerConfig、nettyClientConfig、&lt;b style=&quot;&quot;&gt;messageStoreConfig，&lt;/b&gt;&lt;br&gt;然后实例化 BrokerController 创建一堆管理器、服务实例、Netty请求处理器、监听器、队列&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="520" y="145" width="200" height="90" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-6" value="&lt;b&gt;RocketMQ Broker（代理服务器）&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;组件实在是太多了，很挑战耐心，推荐先结合《&lt;b&gt;RocketMQ技术内幕&lt;/b&gt;》区分重点组件，先梳理重要组件的逻辑；&lt;br&gt;注意下面代码流程中省略了很多细节&lt;br&gt;读消息存储服务的源码前先浏览下《RocketMQ技术内幕》C4 可以帮助理解源码，这部分很值得仔细研究下，可以帮助理解分布式数据存储服务（比如数据库）的设计&lt;br&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="800" height="120" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-7" target="pBlFwodvM3tueQb4qPJ1-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-7" value="controller.&lt;b&gt;start&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1489.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-9" target="EGYwnP1GJaqrjVY5u9EW-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="EGYwnP1GJaqrjVY5u9EW-9" target="io5fEsn8NokLgAYsNQZp-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-9" value="boolean initResult = controller.initialize();&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="EGYwnP1GJaqrjVY5u9EW-11" value="Runtime.getRuntime().addShutdownHook(|&lt;br&gt;new Thread(&lt;br&gt;buildShutdownHook(controller)));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UH9uaCllqP1BWi3zPepl-1" target="UH9uaCllqP1BWi3zPepl-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UH9uaCllqP1BWi3zPepl-1" target="io5fEsn8NokLgAYsNQZp-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-1" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final BrokerController controller = new &lt;b style=&quot;&quot;&gt;BrokerController&lt;/b&gt;(&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;brokerConfig, nettyServerConfig, nettyClientConfig, messageStoreConfig);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;创建一堆管理器、服务实例、Netty请求处理器、监听器、队列&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="150" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UH9uaCllqP1BWi3zPepl-3" value="controller.getConfiguration()&lt;br&gt;.registerConfig(properties);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;系统属性合并到configuration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9ZpLQJjH8hzzHKrBqNTH-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="rIVS-tahEMKac8YR9IbI-1" target="9ZpLQJjH8hzzHKrBqNTH-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="rIVS-tahEMKac8YR9IbI-1" target="A6NGypoCB3MqtpjTJkto-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="rIVS-tahEMKac8YR9IbI-1" target="iXBdxiTUZG9k7DSO9CjL-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rIVS-tahEMKac8YR9IbI-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BrokerController&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final int HA_ADDRESS_MIN_LENGTH = 6;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BrokerConfig &lt;b&gt;brokerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息存储配置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final MessageStoreConfig &lt;b&gt;messageStoreConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerOffsetManager &lt;b&gt;consumerOffsetManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BroadcastOffsetManager &lt;b&gt;broadcastOffsetManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final &lt;b&gt;ConsumerManager&lt;/b&gt; &lt;b&gt;consumerManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerFilterManager consumerFilterManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerOrderInfoManager consumerOrderInfoManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PopInflightMessageCounter popInflightMessageCounter;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//生产者管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final &lt;b&gt;ProducerManager&lt;/b&gt; &lt;b&gt;producerManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ScheduleMessageService &lt;b&gt;scheduleMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final &lt;b&gt;ClientHousekeepingService&lt;/b&gt; &lt;b&gt;clientHousekeepingService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PullMessageProcessor pullMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PeekMessageProcessor peekMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PopMessageProcessor popMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final AckMessageProcessor ackMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ChangeInvisibleTimeProcessor changeInvisibleTimeProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final NotificationProcessor notificationProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PollingInfoProcessor pollingInfoProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final QueryAssignmentProcessor queryAssignmentProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ClientManageProcessor clientManageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final SendMessageProcessor sendMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ReplyMessageProcessor replyMessageProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final PullRequestHoldService pullRequestHoldService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final MessageArrivingListener messageArrivingListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final Broker2Client broker2Client;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final ConsumerIdsChangeListener consumerIdsChangeListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final EndTransactionProcessor endTransactionProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final RebalanceLockManager rebalanceLockManager = new RebalanceLockManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b&gt;TopicRouteInfoManager&lt;/b&gt; &lt;b&gt;topicRouteInfoManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;BrokerOuterAPI&lt;/b&gt; &lt;b&gt;brokerOuterAPI&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService scheduledExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService syncBrokerMemberGroupExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ScheduledExecutorService brokerHeartbeatExecutorService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final SlaveSynchronize slaveSynchronize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; sendThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; putThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; ackThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; pullThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; litePullThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; replyThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; queryThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; clientManagerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; heartbeatThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; consumerManagerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; endTransactionThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; adminBrokerThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final BlockingQueue&amp;lt;Runnable&amp;gt; loadBalanceThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final &lt;b&gt;BrokerStatsManager&lt;/b&gt; &lt;b&gt;brokerStatsManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;ConsumeMessageHook&amp;gt; consumeMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//非延迟消息的存储服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;MessageStore&lt;/b&gt; &lt;b&gt;messageStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;RemotingServer&lt;/b&gt; &lt;b&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected CountDownLatch remotingServerStartLatch;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;RemotingServer&lt;/b&gt; &lt;b&gt;fastRemotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;TopicConfigManager&lt;/b&gt; &lt;b&gt;topicConfigManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;SubscriptionGroupManager&lt;/b&gt; &lt;b&gt;subscriptionGroupManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;TopicQueueMappingManager&lt;/b&gt; &lt;b&gt;topicQueueMappingManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService sendMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService pullMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService litePullMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService putMessageFutureExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService ackMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService replyMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService queryMessageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService adminBrokerExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService clientManageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService heartbeatExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService consumerManageExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService loadBalanceExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ExecutorService endTransactionExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected boolean updateMasterHAServerAddrPeriodically = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerStats brokerStats;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private InetSocketAddress storeHost;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//延迟消息的存储服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private &lt;b&gt;TimerMessageStore&lt;/b&gt; &lt;b&gt;timerMessageStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TimerCheckpoint timerCheckpoint;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected BrokerFastFailure brokerFastFailure;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private Configuration &lt;b&gt;configuration&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected TopicQueueMappingCleanService topicQueueMappingCleanService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected FileWatchService fileWatchService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;TransactionalMessageCheckService&lt;/b&gt; &lt;b&gt;transactionalMessageCheckService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;TransactionalMessageService&lt;/b&gt; &lt;b&gt;transactionalMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected &lt;b&gt;AbstractTransactionalMessageCheckListener&lt;/b&gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; transactionalMessageCheckListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected Map&amp;lt;Class, AccessValidator&amp;gt; accessValidatorMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile boolean shutdown = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ShutdownHook shutdownHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private volatile boolean isScheduleServiceStart = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private volatile boolean isTransactionCheckServiceStart = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile BrokerMemberGroup brokerMemberGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected EscapeBridge escapeBridge;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected List&amp;lt;BrokerAttachedPlugin&amp;gt; brokerAttachedPlugins = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile long shouldStartTime;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerPreOnlineService brokerPreOnlineService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile boolean isIsolated = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile long minBrokerIdInGroup = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected volatile String minBrokerAddrInGroup = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final Lock lock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final List&amp;lt;ScheduledFuture&amp;lt;?&amp;gt;&amp;gt; scheduledFutures = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected ReplicasManager replicasManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long lastSyncTimeMs = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private BrokerMetricsManager brokerMetricsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ColdDataPullRequestHoldService coldDataPullRequestHoldService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ColdDataCgCtrService coldDataCgCtrService;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TransactionMetricsFlushService transactionMetricsFlushService;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-520" y="160" width="480" height="1640" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-1" target="io5fEsn8NokLgAYsNQZp-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="980" y="810" />
              <mxPoint x="980" y="620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-33" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="io5fEsn8NokLgAYsNQZp-32" vertex="1" connectable="0">
          <mxGeometry x="0.4533" y="2" relative="1" as="geometry">
            <mxPoint x="12" y="-43" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-35" value="2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-1" target="io5fEsn8NokLgAYsNQZp-34" edge="1">
          <mxGeometry x="0.5" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-1" target="sXESOgIZEqy42PXHShon-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-4" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="sXESOgIZEqy42PXHShon-3" vertex="1" connectable="0">
          <mxGeometry x="0.8857" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-1" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 MQ一些元数据初始化&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;boolean result = this.initializeMetadata();&lt;/div&gt;&lt;div&gt;... &lt;font color=&quot;#007fff&quot;&gt;//返回false直接退出&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 消息存储初始化&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;result = this.initializeMessageStore();&lt;/div&gt;&lt;div&gt;... &lt;font color=&quot;#007fff&quot;&gt;//返回false直接退出&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return this.recoverAndInitService();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="760" y="760" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-7" target="io5fEsn8NokLgAYsNQZp-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-7" target="io5fEsn8NokLgAYsNQZp-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-7" target="io5fEsn8NokLgAYsNQZp-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-7" target="io5fEsn8NokLgAYsNQZp-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-7" target="io5fEsn8NokLgAYsNQZp-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-7" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;这里主要关注一些线程和线程池任务&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-9" target="io5fEsn8NokLgAYsNQZp-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-9" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ScheduleMessageService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建包含1个核心线程的计划任务线程池，线程名前缀 &lt;b&gt;ScheduleMessageServicePersistThread&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-11" value="&lt;div style=&quot;&quot;&gt;ScheduleMessageService.this.persist();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-13" target="io5fEsn8NokLgAYsNQZp-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-13" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ClientHousekeepingService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;创建包含1个核心线程的计划任务线程池，线程名前缀&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;ClientHousekeepingScheduledThread&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-14" value="&lt;div style=&quot;&quot;&gt;ClientHousekeepingService.this&lt;br&gt;.scanExceptionChannel();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-18" target="io5fEsn8NokLgAYsNQZp-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-18" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;PullRequestHoldService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;br&gt;&lt;b&gt;PullRequestHoldService&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-19" value="PullRequestHoldService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-21" target="io5fEsn8NokLgAYsNQZp-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="430" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-21" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ColdDataPullRequestHoldService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;br&gt;&lt;b&gt;ColdDataPullRequestHoldService&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-26" value="ColdDataPullRequestHoldService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-28" target="io5fEsn8NokLgAYsNQZp-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-28" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ColdDataCgCtrService&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;创建一个非守护线程，线程名&lt;br&gt;&lt;b&gt;ColdDataCgCtrService&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-29" value="ColdDataCgCtrService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-31" value="&lt;div&gt;boolean result = this.&lt;b&gt;topicConfigManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;result = result &amp;amp;&amp;amp; this.&lt;b&gt;topicQueueMappingManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;result = result &amp;amp;&amp;amp; this.&lt;b&gt;consumerOffsetManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;result = result &amp;amp;&amp;amp; this.&lt;b&gt;subscriptionGroupManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;result = result &amp;amp;&amp;amp; this.&lt;b&gt;consumerFilterManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;result = result &amp;amp;&amp;amp; this.&lt;b&gt;consumerOrderInfoManager&lt;/b&gt;.load();&lt;/div&gt;&lt;div&gt;return result;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;从对应json配置文件加载配置，文件不存在就从.bak文件加载，还没有就用默认的，运行时还会持久化到配置文件，应该是某个定时任务完成的，todo&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="1000" y="560" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="io5fEsn8NokLgAYsNQZp-34" target="io5fEsn8NokLgAYsNQZp-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-34" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;defaultMessageStore = new &lt;b style=&quot;font-size: 9px;&quot;&gt;DefaultMessageStore&lt;/b&gt;(this.messageStoreConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.brokerStatsManager, this.messageArrivingListener, this.brokerConfig, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; topicConfigManager.getTopicConfigTable());&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.brokerStats = new BrokerStats(defaultMessageStore);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageStorePluginContext context = new MessageStorePluginContext(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig, configuration);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果有插件就使用装饰器模式封装 &lt;b&gt;defaultMessageStore&lt;/b&gt;，没有插件就直接返回 defaultMessageStore&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;messageStore&lt;/b&gt; = MessageStoreFactory.&lt;b&gt;build&lt;/b&gt;(context, &lt;b&gt;defaultMessageStore&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.messageStore.getDispatcherList().addFirst(new CommitLogDispatcherCalcBitMap(this.brokerConfig, &lt;br&gt;&amp;nbsp; &amp;nbsp; this.consumerFilterManager));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageStoreConfig.isTimerWheelEnable()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerCheckpoint = new TimerCheckpoint(BrokerPathConfigHelper.getTimerCheckPath(&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; TimerMetrics timerMetrics = new TimerMetrics(BrokerPathConfigHelper.getTimerMetricsPath(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;messageStoreConfig.getStorePathRootDir()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore = new TimerMessageStore(messageStore, messageStoreConfig, timerCheckpoint, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;timerMetrics, brokerStatsManager);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.timerMessageStore.registerEscapeBridgeHook(msg -&amp;gt; escapeBridge.putMessage(msg));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.messageStore.setTimerMessageStore(this.timerMessageStore);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="700" width="440" height="260" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="io5fEsn8NokLgAYsNQZp-36" target="6p4HSz2lRJ6rl-BUe08P-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="io5fEsn8NokLgAYsNQZp-36" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMessageStore&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;详情参考 rocketmq-messagestore.drawio&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1480" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="RNo32aOgol8WFuH39X7G-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.645;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="9ZpLQJjH8hzzHKrBqNTH-1" target="9ZpLQJjH8hzzHKrBqNTH-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1041" y="341" />
              <mxPoint x="-1060" y="340" />
              <mxPoint x="-1060" y="1000" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="9ZpLQJjH8hzzHKrBqNTH-1" target="ZVkVS-yd981mC1FR8FSe-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1070" y="230" />
              <mxPoint x="-1070" y="640" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="9ZpLQJjH8hzzHKrBqNTH-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BrokerOuterAPI&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;就是带有各个Broker节点信息的Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端，即NettyRemotingClient&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RemotingClient &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final TopAddressing &lt;b&gt;topAddressing&lt;/b&gt; = new DefaultTopAddressing(MixAll.getWSAddr());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;brokerOuterExecutor&lt;/b&gt; = ThreadUtils.newThreadPoolExecutor(4, &lt;br&gt;&amp;nbsp; &amp;nbsp; 10, 1, TimeUnit.MINUTES,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ArrayBlockingQueue&amp;lt;&amp;gt;(32), &lt;br&gt;&amp;nbsp; &amp;nbsp; new&amp;nbsp;ThreadFactoryImpl(&quot;brokerOutApi_thread_&quot;, true));&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主要是主题Broker路由信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientMetadata &lt;b&gt;clientMetadata&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//借助NettyRemotingClient 封装的RPC客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RpcClient &lt;b&gt;rpcClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//命名服务地址&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;nameSrvAddr&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = null;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="160" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="RNo32aOgol8WFuH39X7G-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="9ZpLQJjH8hzzHKrBqNTH-3" target="RNo32aOgol8WFuH39X7G-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9ZpLQJjH8hzzHKrBqNTH-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientMetadata&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Topic -&amp;gt; TopicRouteData&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* Topic */, TopicRouteData&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Topic -&amp;gt; MessageQueue -&amp;gt; brokerName&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* Topic */, ConcurrentMap&amp;lt;MessageQueue, &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;String/*brokerName*/&amp;gt;&amp;gt; &lt;b&gt;topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//brokerName -&amp;gt; brokerId -&amp;gt; brokerAddr&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* Broker Name */, HashMap&amp;lt;Long/* brokerId */, String/* &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;address */&amp;gt;&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//brokerName -&amp;gt; brokerAddr -&amp;gt; brokerVersion&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* Broker Name */, HashMap&amp;lt;String/* address */, Integer&amp;gt;&amp;gt; &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;b&gt;brokerVersionTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="880" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="RNo32aOgol8WFuH39X7G-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicRouteData&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;主题路由信息&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String orderTopicConf;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即主题消息存储的消息队列信息（位于的Broker名、读写索引[readQueueNums、writeQueueNums]、perm等&lt;span style=&quot;background-color: initial;&quot;&gt;）&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;QueueData&amp;gt; &lt;b&gt;queueDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即queueDatas中Broker的信息（所属集群名、Broker名、broker实例地址[这里看到可能有多个]等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;BrokerData&amp;gt; &lt;b&gt;brokerDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HashMap&amp;lt;String/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可能为空，todo&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt; topicQueueMappingByBroker;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2120" y="880" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.137;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-1" target="pBlFwodvM3tueQb4qPJ1-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-5" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="pBlFwodvM3tueQb4qPJ1-4" vertex="1" connectable="0">
          <mxGeometry x="0.8695" y="-1" relative="1" as="geometry">
            <mxPoint x="-15" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.195;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-1" target="ZVkVS-yd981mC1FR8FSe-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-8" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZVkVS-yd981mC1FR8FSe-7" vertex="1" connectable="0">
          <mxGeometry x="0.8822" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="32" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.3;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-1" target="iXBdxiTUZG9k7DSO9CjL-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="1391" />
              <mxPoint x="970" y="2890" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-10" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iXBdxiTUZG9k7DSO9CjL-4" vertex="1" connectable="0">
          <mxGeometry x="0.979" y="-3" relative="1" as="geometry">
            <mxPoint x="4" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-1" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;this.shouldStartTime = System.currentTimeMillis() + messageStoreConfig.getDisappearTimeAfterStart();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (messageStoreConfig.getTotalReplicas() &amp;gt; 1 &amp;amp;&amp;amp; this.brokerConfig.isEnableSlaveActingMaster()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; isIsolated = true;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 启动Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (this.brokerOuterAPI != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;brokerOuterAPI&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 启动基础服务（包括消息存储、Netty服务端等等）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;startBasicService&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (!isIsolated &amp;amp;&amp;amp; !this.messageStoreConfig.isEnableDLegerCommitLog() &amp;amp;&amp;amp; !this.messageStoreConfig.isDuplicationEnable()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; changeSpecialServiceStatus(this.brokerConfig.getBrokerId() == MixAll.MASTER_ID);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 将当前Broker信息注册到所有NameServer&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;registerBrokerAll&lt;/b&gt;(true, false, true);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//注册定时任务隔一段时间重新将当前Broker注册到所有NameServer&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;scheduledFutures.add(this.&lt;b&gt;scheduledExecutorService&lt;/b&gt;.scheduleAtFixedRate(new AbstractBrokerRunnable(this.getBrokerIdentity()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; public void run0() {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BrokerController.this.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;registerBrokerAll&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(true, false, brokerConfig.isForceRegister());&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;...&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}, 1000 * 10, Math.max(10000, Math.min(brokerConfig.&lt;b&gt;getRegisterNameServerPeriod&lt;/b&gt;(), 60000)), TimeUnit.MILLISECONDS));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//enableSlaveActingMaster为true，则副本组在无master状态下，brokerId==1的slave将在TopicRoute中被替换成master（即brokerId=0），并以只读模式对客户端提供服务，默认为false&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (this.brokerConfig.isEnableSlaveActingMaster()) {&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; scheduleSendHeartbeat();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; scheduledFutures.add(this.syncBrokerMemberGroupExecutorService.scheduleAtFixedRate(new AbstractBrokerRunnable(this.getBrokerIdentity()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void run0() {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; BrokerController.this.&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;syncBrokerMemberGroup&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }, 1000, this.brokerConfig.getSyncBrokerMemberGroupPeriod(), TimeUnit.MILLISECONDS));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (this.brokerConfig.isEnableControllerMode()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; scheduleSendHeartbeat();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (brokerConfig.isSkipPreOnline()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; startServiceWithoutCondition();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//4 每5秒请求一下NameServer更新一下Broker集群信息，请求码：&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;GET_BROKER_CLUSTER_INFO&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; public void run() {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BrokerController.this.brokerOuterAPI.&lt;b&gt;refreshMetadata&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}, 10, 5, TimeUnit.SECONDS);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="1199" width="440" height="641" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-3" target="pBlFwodvM3tueQb4qPJ1-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-3" target="pBlFwodvM3tueQb4qPJ1-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-3" value="this.remotingClient.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;后端单独将RocketMQ Netty服务端和客户端封装提出来分析，这里只关注pipeline中的ChannelHandler，以及一些线程或线程池任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-5" value="BrokerOuterAPI" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1055" y="1190" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="pBlFwodvM3tueQb4qPJ1-10" target="pBlFwodvM3tueQb4qPJ1-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-10" value="ChannelPipeline" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="1240" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-12" value="&lt;div&gt;ch.pipeline().addLast(&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //执行ChannelHandler的线程池&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; nettyClientConfig.isDisableNettyWorkerGroup() ? null : defaultEventExecutorGroup,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyEncoder&lt;/b&gt;(),&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;NettyDecoder&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0, nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyConnectManageHandler&lt;/b&gt;(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyClientHandler&lt;/b&gt;());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1200" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="pBlFwodvM3tueQb4qPJ1-14" target="pBlFwodvM3tueQb4qPJ1-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-14" target="pBlFwodvM3tueQb4qPJ1-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="pBlFwodvM3tueQb4qPJ1-14" target="pBlFwodvM3tueQb4qPJ1-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-14" value="线程或线程池任务" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-17" value="NettyEventExecutor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一个非阻塞线程用于分发eventQueue中的Netty事件给对应监听器，线程名 NettyEventExecutor， 不属于核心逻辑可暂略&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1481" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="pBlFwodvM3tueQb4qPJ1-20" target="pBlFwodvM3tueQb4qPJ1-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-20" value="this.timer.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1481" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="pBlFwodvM3tueQb4qPJ1-23" target="pBlFwodvM3tueQb4qPJ1-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-23" value="this.timer.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1481" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-26" value="NettyRemotingClient.this&lt;br&gt;.&lt;b&gt;scanAvailableNameSrv&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBlFwodvM3tueQb4qPJ1-28" value="NettyRemotingClient.this.&lt;br&gt;&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期扫描和过期已废弃的请求，即扫描&lt;br&gt;responseTable中的元素，清除过期的请求并回调过期的ResponseFuture&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="ZVkVS-yd981mC1FR8FSe-2" target="ZVkVS-yd981mC1FR8FSe-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends NettyRemotingAbstract implements &lt;b&gt;RemotingClient&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;Bootstrap&lt;/b&gt; &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup &lt;b&gt;eventLoopGroupWorker&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; &lt;b&gt;bootstrapMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; channelTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定时任务执行器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HashedWheelTimer&lt;/b&gt; &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; namesrvAddrList = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// RocketMQ 自定义事件的监听器，todo 这些事件的作用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener &lt;b&gt;channelEventListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1600" y="440" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreOneway;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreAsync;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; &lt;b&gt;responseTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;processorTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new HashMap&amp;lt;&amp;gt;(64);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于启动一个守护线程，线程阻塞读取eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; rpcHooks = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1600" y="160" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;" parent="1" source="ZVkVS-yd981mC1FR8FSe-6" target="iXBdxiTUZG9k7DSO9CjL-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-13" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iXBdxiTUZG9k7DSO9CjL-12" vertex="1" connectable="0">
          <mxGeometry x="0.909" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;" parent="1" source="ZVkVS-yd981mC1FR8FSe-6" target="iXBdxiTUZG9k7DSO9CjL-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-16" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="iXBdxiTUZG9k7DSO9CjL-15" vertex="1" connectable="0">
          <mxGeometry x="0.8837" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZVkVS-yd981mC1FR8FSe-6" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 非定时消息存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (this.messageStore != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;messageStore&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 定时消息存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (this.timerMessageStore != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;timerMessageStore&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.replicasManager != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.replicasManager.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (remotingServerStartLatch != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; remotingServerStartLatch.await();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 Netty服务端启动&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (this.remotingServer != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;remotingServer&lt;/b&gt;.start();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null != nettyServerConfig &amp;amp;&amp;amp; 0 == nettyServerConfig.getListenPort()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nettyServerConfig.setListenPort(remotingServer.localListenPort());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//4&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (this.fastRemotingServer != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;fastRemotingServer&lt;/b&gt;.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;this.storeHost = new InetSocketAddress(this.getBrokerConfig().getBrokerIP1(), this.getNettyServerConfig().getListenPort());&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;for (BrokerAttachedPlugin brokerAttachedPlugin : brokerAttachedPlugins) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (brokerAttachedPlugin != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerAttachedPlugin.start();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.popMessageProcessor != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.popMessageProcessor.getPopLongPollingService().start();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.popMessageProcessor.getPopBufferMergeService().start();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.popMessageProcessor.getQueueLockManager().start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.ackMessageProcessor != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.ackMessageProcessor.startPopReviveService();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.notificationProcessor != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.notificationProcessor.getPopLongPollingService().start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.topicQueueMappingCleanService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.topicQueueMappingCleanService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.fileWatchService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.fileWatchService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.pullRequestHoldService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.pullRequestHoldService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.clientHousekeepingService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.clientHousekeepingService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.brokerStatsManager != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerStatsManager.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.brokerFastFailure != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerFastFailure.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.broadcastOffsetManager != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.broadcastOffsetManager.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.escapeBridge != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.escapeBridge.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.topicRouteInfoManager != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.topicRouteInfoManager.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.brokerPreOnlineService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerPreOnlineService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.coldDataPullRequestHoldService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.coldDataPullRequestHoldService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (this.coldDataCgCtrService != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.coldDataCgCtrService.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1580" width="440" height="1180" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-1" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;Broker核心组件与功能&lt;/b&gt;：&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;1）BrokerOuterAPI，Netty客户端，实现对外请求&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;2）MessageStore， 实现消息存储&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;3）RemotingServer，Netty服务端实现接受外部请求&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;4）&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="235" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicConfigManager&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储各主题的主题配置（包括主题名、读/写队列个数、权限等等），包括一些内部主题的配置&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int SCHEDULE_TOPIC_QUEUE_NUM = 18;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private transient final Lock topicConfigTableLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//Topic -&amp;gt; TopicConfig&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ConcurrentMap&amp;lt;String, TopicConfig&amp;gt; &lt;b&gt;topicConfigTable&lt;/b&gt; = &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;new ConcurrentHashMap&amp;lt;&amp;gt;(1024);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DataVersion dataVersion = new DataVersion();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属BrokerController&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected transient BrokerController &lt;b&gt;brokerController&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="480" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iXBdxiTUZG9k7DSO9CjL-3" target="iXBdxiTUZG9k7DSO9CjL-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-3" value="&lt;div&gt;List&amp;lt;RegisterBrokerResult&amp;gt; registerBrokerResultList = this.brokerOuterAPI.&lt;b&gt;registerBrokerAll&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.getBrokerClusterName(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.getBrokerAddr(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.getBrokerName(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.getBrokerId(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.getHAServerAddr(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; topicConfigWrapper,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Lists.newArrayList(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; oneway,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.getRegisterBrokerTimeoutMills(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.isEnableSlaveActingMaster(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.isCompressedRegister(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerConfig.isEnableSlaveActingMaster() ? &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.brokerConfig.getBrokerNotActiveTimeoutMillis() : null,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;this.getBrokerIdentity());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;handleRegisterBrokerResult&lt;/b&gt;(registerBrokerResultList, checkOrderConfig);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2780" width="440" height="220" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iXBdxiTUZG9k7DSO9CjL-5" target="iXBdxiTUZG9k7DSO9CjL-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-5" value="&lt;div&gt;List&amp;lt;String&amp;gt; nameServerAddressList = this.remotingClient.getAvailableNameSrvList();&lt;/div&gt;&lt;div&gt;for (final String namesrvAddr : nameServerAddressList) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;brokerOuterExecutor&lt;/b&gt;.execute(new AbstractBrokerRunnable(brokerIdentity) {&lt;font color=&quot;#007fff&quot;&gt; //异步执行注册&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void run0() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RegisterBrokerResult result = &lt;b&gt;registerBroker&lt;/b&gt;(namesrvAddr, oneway, timeoutMills, requestHeader, body);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (result != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; registerBrokerResultList.add(result);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2800" width="440" height="180" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-7" value="BrokerOuterAPI" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1655" y="2770" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-8" value="RemotingCommand request = RemotingCommand.createRequestCommand(&lt;br&gt;&amp;nbsp; &amp;nbsp; RequestCode.&lt;b&gt;REGISTER_BROKER&lt;/b&gt;, requestHeader);&lt;br&gt;request.setBody(body);&lt;br&gt;RemotingCommand response = this.&lt;b&gt;remotingClient&lt;/b&gt;.invokeSync(&lt;b&gt;namesrvAddr&lt;/b&gt;, request, &lt;br&gt;&amp;nbsp; &amp;nbsp; timeoutMills);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1960" y="2850" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-11" value="todo" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="iXBdxiTUZG9k7DSO9CjL-14" target="iXBdxiTUZG9k7DSO9CjL-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-14" value="只关注ChannelPipeline的初始化" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1690" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-17" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;BrokerController&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="690" y="1169" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.004;entryY=0.108;entryDx=0;entryDy=0;entryPerimeter=0;shape=flexArrow;" parent="1" source="iXBdxiTUZG9k7DSO9CjL-18" target="UOgHbx062x8avttLDLgC-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-18" value="&lt;div&gt;return ch.pipeline()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(defaultEventExecutorGroup, HANDSHAKE_HANDLER_NAME, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;new &lt;b&gt;HandshakeHandler&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .addLast(defaultEventExecutorGroup,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;encoder&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyDecoder&lt;/b&gt;(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;distributionHandler&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;connectionManageHandler&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;serverHandler&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; );&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;这里可以看到ChannelHandler的处理都在单独的线程池中执行&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1640" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="iXBdxiTUZG9k7DSO9CjL-20" target="88cYBq0NHoLnCytSyxW7-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iXBdxiTUZG9k7DSO9CjL-20" value="Broker代理服务&lt;br&gt;接收请求" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-1" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2240.8499999999995" y="2400" width="240" height="420" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-2" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2240" y="1640" width="240" height="740" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-6" target="UOgHbx062x8avttLDLgC-17" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2500.8499999999995" y="1690" />
              <mxPoint x="2500.8499999999995" y="1450" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-34" target="UOgHbx062x8avttLDLgC-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-6" value="HandshakeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;握手处理，借助&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;检测是否是Proxy Protocol 类型, 这个主要是为了支持&lt;b&gt;HAProxy&lt;/b&gt;代理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="1660" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-8" target="UOgHbx062x8avttLDLgC-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-8" target="IlE1B2CKHWzOFgL5Q3cu-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-8" value="NettyDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是RocketMQ自定义的解码器，继承&lt;br&gt;&lt;b&gt;LengthFieldBasedFrameDecoder&lt;br&gt;根据消息中长度字段提取消息主体&lt;br&gt;&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2260.8499999999995" y="1980" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-10" target="UOgHbx062x8avttLDLgC-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-10" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2260.8499999999995" y="2060" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-12" target="UOgHbx062x8avttLDLgC-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-12" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="2140" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-14" target="UOgHbx062x8avttLDLgC-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-14" value="&lt;div&gt;NettyRemotingServer$&lt;/div&gt;&lt;div&gt;NettyConnectManageHandler&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="2220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-16" target="UOgHbx062x8avttLDLgC-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="wrxCO2yFKbasApRgCUrf-6" target="88cYBq0NHoLnCytSyxW7-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3160" y="2330" />
              <mxPoint x="3160" y="3020" />
              <mxPoint x="380" y="3020" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-16" target="wrxCO2yFKbasApRgCUrf-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-16" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2260.8499999999995" y="2300" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-17" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;protected void decode(ChannelHandlerContext ctx, ByteBuf byteBuf, List&amp;lt;Object&amp;gt; out) throws Exception {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ProtocolDetectionResult&amp;lt;HAProxyProtocolVersion&amp;gt; detectionResult = HAProxyMessageDecoder.detectProtocol(byteBuf);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (detectionResult.state() == ProtocolDetectionState.NEEDS_MORE_DATA) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&amp;nbsp; &amp;nbsp; //其实是半包处理&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (detectionResult.state() == ProtocolDetectionState.DETECTED) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), HA_PROXY_DECODER, new HAProxyMessageDecoder())&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_DECODER, HA_PROXY_HANDLER, new HAProxyMessageHandler())&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_HANDLER, TLS_MODE_HANDLER, tlsModeHandler);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else { &lt;font color=&quot;#007fff&quot;&gt;//如果没有使用HAProxy代理，会将 HandshakeHandler 替换为 TlsModelHandler&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), TLS_MODE_HANDLER, tlsModeHandler);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ctx.pipeline().remove(this);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;即检测到使用了Proxy Protocol 就添加先在 HandshakeHandler 后添加&amp;nbsp;HAProxyMessageDecoder、HAProxyMessageHandler、&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;TlsModeHandler，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial; font-size: 9px;&quot;&gt;然后再删除当前的 HandshakeHandler；&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;如果没有使用HAProxy代理，会将 HandshakeHandler 替换为 TlsModelHandler&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2540.3499999999995" y="1360" width="600" height="200" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-18" value="NettyEncoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2259.8499999999995" y="2740" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-20" target="UOgHbx062x8avttLDLgC-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-20" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2259.8499999999995" y="2580" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-22" target="UOgHbx062x8avttLDLgC-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-22" value="&lt;div&gt;NettyRemotingServer$&lt;/div&gt;&lt;div&gt;NettyConnectManageHandler&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2260.3499999999995" y="2500" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-24" target="UOgHbx062x8avttLDLgC-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-24" target="wrxCO2yFKbasApRgCUrf-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-24" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2260.3499999999995" y="2420" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-25" value="InBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2251.3499999999995" y="1620" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-26" value="OutBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2251.3499999999995" y="2380" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-28" target="UOgHbx062x8avttLDLgC-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-28" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2259.8499999999995" y="2660" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-37" target="UOgHbx062x8avttLDLgC-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2360.8499999999995" y="1760" as="sourcePoint" />
            <mxPoint x="2360.8499999999995" y="1980" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-31" target="UOgHbx062x8avttLDLgC-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-31" value="HAProxyMessageHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要就是将连接信息存储起来，这里将信息存储到了channel的属性表&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="1820" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-31" target="UOgHbx062x8avttLDLgC-34" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2360.8499999999995" y="1840" as="sourcePoint" />
            <mxPoint x="2360.8499999999995" y="1980" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-34" target="UOgHbx062x8avttLDLgC-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-34" value="TlsModeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;提供 TLS 支持处理，测试中并没有开启TLS&lt;br&gt;这个处理器最终会被删除掉&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="1900" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-6" target="UOgHbx062x8avttLDLgC-37" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2360.8499999999995" y="1760" as="sourcePoint" />
            <mxPoint x="2360.8499999999995" y="1820" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="UOgHbx062x8avttLDLgC-37" target="UOgHbx062x8avttLDLgC-40" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2520.8499999999995" y="1770" />
              <mxPoint x="2520.8499999999995" y="1610" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-37" value="HAProxyMessageDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Proxy协议仅仅就是最开始多传递了个代理协议头部信息，通过这个解码器解析协议版本，协议&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2261.3499999999995" y="1740" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-38" value="&lt;font color=&quot;#007fff&quot;&gt;关于连接接入，传输层的处理参考 netty.drawio&lt;br&gt;这里前面4个InBound ChannelHandler 测试中并没有用到&lt;br&gt;可以暂时忽略&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2240.8499999999995" y="1560" width="320" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-40" target="UOgHbx062x8avttLDLgC-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-40" value="channelRead(ChannelHandlerContext ctx, Object msg)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2540.3499999999995" y="1580" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-42" target="UOgHbx062x8avttLDLgC-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-42" value="&lt;b style=&quot;background-color: initial;&quot;&gt;cumulation&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = cumulator.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;cumulate&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(&lt;br&gt;ctx.alloc(),&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;first ?Unpooled.EMPTY_BUFFER : cumulation, (ByteBuf) msg);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将msg通过内存复制的方式累积到cumulation&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2780.8499999999995" y="1580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-45" target="UOgHbx062x8avttLDLgC-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-45" target="UOgHbx062x8avttLDLgC-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-45" value="&lt;div&gt;CodecOutputList out = CodecOutputList.newInstance();&lt;/div&gt;&lt;b&gt;callDecode&lt;/b&gt;(ctx, cumulation, out);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;调用解码逻辑将累积的ByteBuf内容输出到 CodecOutputList实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2780.8499999999995" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-47" target="UOgHbx062x8avttLDLgC-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-47" value="&lt;div&gt;循环通过&amp;nbsp;decodeRemovalReentryProtection(ctx, in, out); 读取 ByteBuf 内容到 out&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="3020.8499999999995" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-49" target="UOgHbx062x8avttLDLgC-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-49" value="&lt;div&gt;&lt;b&gt;decode&lt;/b&gt;(ctx, in, out);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;先从ByteBuf in 中读取&lt;b&gt;协议规范版本&lt;/b&gt;，&lt;br&gt;然后使用对应版本的&lt;b&gt;StructHeaderExtractor提取头部信息&lt;/b&gt;，然后解码头部数据到&lt;b&gt;out，&lt;/b&gt;是&lt;b&gt;HAProxyMessage类型&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3260.8499999999995" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-50" value="&lt;div&gt;finally:&lt;/div&gt;&lt;div&gt;如果没有更多内容可读就释放 cumulation, 如果cumulation一直未读取完毕且读取次数超过discardAfterReads限制，则丢弃后面数据&lt;/div&gt;&lt;div&gt;firedChannelRead |= out.insertSinceRecycled();&lt;/div&gt;&lt;div&gt;&lt;b&gt;fireChannelRead&lt;/b&gt;(ctx, out, size);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2780.8499999999995" y="1740" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-51" value="&lt;div&gt;&lt;div&gt;out.add(HAProxyMessage&lt;/div&gt;&lt;div&gt;.&lt;b&gt;decodeHeader&lt;/b&gt;(decoded));&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;将数据转成 HAProxyMessage对象存入 out&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3500.8499999999995" y="1660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-53" target="UOgHbx062x8avttLDLgC-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-53" value="仅仅是提供对 HAProxyMessage 的进一步处理，HAProxyMessageDecoder 解析出的 HAProxyMessage 需要存储起来" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2540.3499999999995" y="1840" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="UOgHbx062x8avttLDLgC-55" target="UOgHbx062x8avttLDLgC-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3000.8499999999995" y="1940" />
              <mxPoint x="3000.8499999999995" y="1940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-55" value="channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_ADDR).set(msg.sourceAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_PORT).set(String.valueOf(msg.sourcePort()));&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_ADDR).set(msg.destinationAddress());&lt;br&gt;channel.&lt;b&gt;attr&lt;/b&gt;(AttributeKeys.PROXY_PROTOCOL_SERVER_PORT)&lt;br&gt;.set(String.valueOf(msg.destinationPort()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2781.3499999999995" y="1840" width="439.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-56" value="&lt;div&gt;msg.tlvs().forEach(tlv -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; handleHAProxyTLV(tlv, channel);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;todo, 和 SSL等处理有关&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="2901.0999999999995" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UOgHbx062x8avttLDLgC-57" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;检测传入数据的开头是否为 TLS 握手的魔术码；&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;根据配置的 TLS 模式，对客户端的连接请求做出相应的响应。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;如果启用了 SSL 连接，则在 ChannelPipeline 中添加相应的 SSL 处理器。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;移除自身这个 Handler。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;将处理后的消息传递给 ChannelPipeline 中的下一个 Handler。&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2540.3499999999995" y="1918" width="281.25" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-1" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;比如生产者发送消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;request = {RemotingCommand@4026}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;code = 310&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;language = {LanguageCode@4839} &quot;JAVA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;version = 453&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;opaque = 4&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;flag = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;remark = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b&gt;extFields&lt;/b&gt; = {HashMap@4840}&amp;nbsp; size = 13&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//请求头字段&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;a&quot; -&amp;gt; &quot;please_rename_unique_group_name&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//producerGroup&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;b&quot; -&amp;gt; &quot;TopicTest-10&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//topic&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;c&quot; -&amp;gt; &quot;TBW102&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//defaultTopic&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;d&quot; -&amp;gt; &quot;4&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//defaultTopicQueueNums&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;e&quot; -&amp;gt; &quot;0&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//queueId&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;f&quot; -&amp;gt; &quot;0&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//sysFlag&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;g&quot; -&amp;gt; &quot;1717603824996&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//bornTimestamp&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;h&quot; -&amp;gt; &quot;0&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//flag&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;i&quot; -&amp;gt; &quot;UNIQ_KEYACB400014B3918B4AAC219C9555B0000WAITtrueTAGSTagA&quot; //properties&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;j&quot; -&amp;gt; &quot;0&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//reconsumeTimes&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;k&quot; -&amp;gt; &quot;false&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//unitMode&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;m&quot; -&amp;gt; &quot;false&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//batch&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &quot;n&quot; -&amp;gt; &quot;broker-a&quot;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//maxReconsumeTimes&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b&gt;customHeader&lt;/b&gt; = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b&gt;cachedHeader&lt;/b&gt; = {SendMessageRequestHeaderV2@4841}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; a = &quot;please_rename_unique_group_name&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; b = &quot;TopicTest-10&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; c = &quot;TBW102&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; d = {Integer@4690} 4&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; e = {Integer@4691} 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; f = {Integer@4691} 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; g = {Long@4692} 1717603824996&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; h = {Integer@4691} 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; i = &quot;UNIQ_KEYACB400014B3918B4AAC219C9555B0000WAITtrueTAGSTagA&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; j = {Integer@4691} 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; k = {Boolean@4884} false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; l = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; m = {Boolean@4884} false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; n = &quot;broker-a&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; lo = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; ns = null&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;/&lt;/span&gt;/namespace name&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; nsd = null&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//是否被命名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; bname = null&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//broker name&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; oway = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;serializeTypeCurrentRPC = {SerializeType@4842} &quot;JSON&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;body = {byte[16]@4843} [72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48]&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;suspended = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;processTimer = {Stopwatch@4844} &quot;43.41 min&quot;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="40" y="3140" width="400" height="520" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-3" value="&lt;font color=&quot;#007fff&quot;&gt;Netty LengthFieldBasedFrameDecoder 注释中列举了7种示例，&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;但是从代码实现上看和任何一种格式都不符合：初始化时设置的长度字段偏移：0，长度字段长度：4，lengthAdjustment: 0, initialBytesToStrip:4 （这个字段应该是报文长度字段的字节数）&amp;nbsp;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;解码规则其实是按 NettyEncoder 的编码方式进行解码，&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;解码时先读取前4bytes获取报文长度（其实是协议类型、头部长度、头部内容、消息体内容总长）&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3150.8499999999995" y="2025" width="850" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="IlE1B2CKHWzOFgL5Q3cu-5" target="IlE1B2CKHWzOFgL5Q3cu-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-5" value="&lt;font color=&quot;#007fff&quot;&gt;//调用LengthFieldBasedFrameDecoder解码逻辑提取消息主体&lt;/font&gt;&lt;br&gt;frame = (ByteBuf) super.&lt;b&gt;decode&lt;/b&gt;(ctx, in);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//这一步主要是反序列化&lt;/font&gt;&lt;br&gt;RemotingCommand cmd = RemotingCommand&lt;br&gt;&amp;nbsp; &amp;nbsp;.&lt;b&gt;decode&lt;/b&gt;(frame);&lt;br&gt;cmd.setProcessTimer(timer);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2540.3499999999995" y="2020" width="281.25" height="70" as="geometry" />
        </mxCell>
        <mxCell id="IlE1B2CKHWzOFgL5Q3cu-7" value="&lt;div&gt;int readerIndex = in.readerIndex();&lt;/div&gt;&lt;div&gt;int actualFrameLength = frameLengthInt - initialBytesToStrip;&lt;/div&gt;&lt;div&gt;ByteBuf frame = &lt;b&gt;extractFrame&lt;/b&gt;(ctx, in, readerIndex, actualFrameLength);&lt;/div&gt;&lt;div&gt;in.readerIndex(readerIndex + actualFrameLength);&lt;/div&gt;&lt;div&gt;return frame;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="2859.0999999999995" y="2020" width="281.25" height="70" as="geometry" />
        </mxCell>
        <mxCell id="LlSruaPnQRZVj0I_e1dB-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="LlSruaPnQRZVj0I_e1dB-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="sXESOgIZEqy42PXHShon-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="NkqDwNfi0PbD3_duYgaC-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="eq0b_6B1wbCSJMy3NEEP-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="88cYBq0NHoLnCytSyxW7-1" target="h7HRPMHvCTYBDUlLkEB4-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="88cYBq0NHoLnCytSyxW7-1" value="请求处理器" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="tDYusJ2PWB5UsnWIg58C-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="LlSruaPnQRZVj0I_e1dB-1" target="tDYusJ2PWB5UsnWIg58C-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LlSruaPnQRZVj0I_e1dB-1" value="&lt;b&gt;SendMessageProcessor&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;处理&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;RequestCode.SEND_MESSAGE&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;RequestCode.&lt;b&gt;SEND_MESSAGE_V2&amp;nbsp;&lt;/b&gt;(310)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;RequestCode.SEND_BATCH_MESSAGE&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;RequestCode.&lt;b&gt;CONSUMER_SEND_MSG_BACK &lt;/b&gt;(36)&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="3080" width="199" height="100" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.995;exitY=0.776;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="sXESOgIZEqy42PXHShon-2" target="h7HRPMHvCTYBDUlLkEB4-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-7" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="h7HRPMHvCTYBDUlLkEB4-6" vertex="1" connectable="0">
          <mxGeometry x="0.451" y="-2" relative="1" as="geometry">
            <mxPoint x="-1" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-2" value="&lt;div style=&quot;&quot;&gt;result = this.messageStore.load();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;result = result &amp;amp;&amp;amp; this.timerMessageStore.load();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;result = result &amp;amp;&amp;amp; this.scheduleMessageService.load();&lt;br&gt;this.brokerMetricsManager = new BrokerMetricsManager(this);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;initializeRemotingServer();&lt;/div&gt;&lt;div&gt;initializeResources();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 注册请求处理器&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;registerProcessor&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;initializeScheduledTasks();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 初始化事务消息处理服务&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;initialTransaction&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;initialAcl();&lt;/div&gt;&lt;div&gt;initialRpcHooks();&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="980" width="440" height="180" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="sXESOgIZEqy42PXHShon-6" target="07X-HWd1W3Q1zzt6SAMq-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-6" value="&lt;b&gt;PullMessageProcessor&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;消费者拉取消息请求处理器&lt;br&gt;处理 RequestCode.&lt;b&gt;PULL_MESSAGE&lt;/b&gt; (11)&lt;br&gt;RequestCode.LITE_PULL_MESSAGE (361)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="4720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-9" value="PeekMessageProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="4800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-10" value="PopMessageProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="4880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-11" value="AckMessageProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="4960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-12" value="ChangeInvisibleTimeProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="5040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sXESOgIZEqy42PXHShon-13" value="..." style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="5600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;内部将事件交给 BrokerHousekeepingService 处理&lt;br&gt;只是在与Broker的连接Channel关闭、异常、因空闲超时关闭时销毁在 RouteInfoManager 中的路由信息&lt;br&gt;只作用于 Broker 和 NameServer 的Netty连接&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2540.85" y="2225" width="480" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-2" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;通过Channel绑定的端口选择RemotingServer，再通过请求码（RequestCode）或响应码从NettyRemotingServer &lt;b style=&quot;&quot;&gt;processorTable&lt;/b&gt;&lt;br&gt;或 &lt;b&gt;responseTable&lt;/b&gt; 中选择对应的 NettyRequestProcessor ResponseFuture处理&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2540.85" y="2370" width="600" height="40" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="wrxCO2yFKbasApRgCUrf-4" target="wrxCO2yFKbasApRgCUrf-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-4" value="processRequestCommand(ctx, msg);&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;找到匹配的处理器和上下文等信息封装成RequestTask 提交到处理器制定的线程池中异步执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2539.85" y="2300" width="201" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-5" value="processResponseCommand(ctx, msg);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2539.35" y="2420" width="201.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wrxCO2yFKbasApRgCUrf-6" value="final Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; matched = this.&lt;b&gt;processorTable&lt;/b&gt;.get(cmd.getCode());&lt;br&gt;final int opaque = cmd.getOpaque();&lt;br&gt;&lt;div style=&quot;&quot;&gt;Runnable run = &lt;b&gt;buildProcessRequestHandler&lt;/b&gt;(ctx, cmd, pair, opaque);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final RequestTask requestTask = new &lt;b&gt;RequestTask&lt;/b&gt;(run, ctx.channel(), cmd);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;pair.getObject2().&lt;b&gt;submit&lt;/b&gt;(requestTask);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="2780.85" y="2290" width="359.15" height="80" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;endArrow=open;endFill=0;" parent="1" source="A6NGypoCB3MqtpjTJkto-8" target="A6NGypoCB3MqtpjTJkto-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicQueueMappingManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储主题到Broker队列的映射信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private transient final Lock lock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DataVersion dataVersion = new DataVersion();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属的BrokerController&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private transient BrokerController &lt;b&gt;brokerController&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//Topic -&amp;gt; TopicQueueMappingDetail&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, TopicQueueMappingDetail&amp;gt; &lt;b&gt;topicQueueMappingTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;span style=&quot;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1400" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicQueueMappingInfo&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储主题到Broker队列的映射信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;String &lt;b&gt;topic&lt;/b&gt;;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String scope = MixAll.METADATA_SCOPE_GLOBAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int &lt;b&gt;totalQueues&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//identify the hosted broker name&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String &lt;b&gt;bname&lt;/b&gt;;&amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//important to fence the old dirty data&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long epoch;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是脏数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean dirty; //indicate if the data is dirty&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ConcurrentMap&amp;lt;Integer/*logicId*/, Integer/*physicalId*/&amp;gt; &lt;b&gt;currIdMap&lt;/b&gt; = new &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1160" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="A6NGypoCB3MqtpjTJkto-13" target="A6NGypoCB3MqtpjTJkto-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="A6NGypoCB3MqtpjTJkto-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicQueueMappingDetail&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;存储主题到Broker队列的映射信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// globalId (其实是queueId) -&amp;gt;&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;Integer/*global id*/, List&amp;lt;LogicQueueMappingItem&amp;gt;&amp;gt; &lt;b&gt;hostedQueues&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1440" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="tDYusJ2PWB5UsnWIg58C-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="tDYusJ2PWB5UsnWIg58C-1" target="tDYusJ2PWB5UsnWIg58C-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="tDYusJ2PWB5UsnWIg58C-5" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="tDYusJ2PWB5UsnWIg58C-4" vertex="1" connectable="0">
          <mxGeometry x="0.2114" y="-2" relative="1" as="geometry">
            <mxPoint x="1" y="242" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DUlj2uKyITs8i-9-p9XH-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.996;exitY=0.09;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="tDYusJ2PWB5UsnWIg58C-1" target="DUlj2uKyITs8i-9-p9XH-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DUlj2uKyITs8i-9-p9XH-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="DUlj2uKyITs8i-9-p9XH-2" vertex="1" connectable="0">
          <mxGeometry x="0.0489" y="2" relative="1" as="geometry">
            <mxPoint x="-2" y="68" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tDYusJ2PWB5UsnWIg58C-1" value="&lt;div&gt;SendMessageContext sendMessageContext;&lt;/div&gt;&lt;div&gt;switch (request.getCode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;case&lt;/b&gt; RequestCode.&lt;b&gt;CONSUMER_SEND_MSG_BACK&lt;/b&gt;:&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 1 消息消费失败发回处理，后面可以看到是以延迟消息的形式发送到了重试主题中，&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 并没有发到原主题&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;consumerSendMsgBack&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;default&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//主要就是解析RemotingCommand中的&lt;b&gt;extFilelds&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SendMessageRequestHeader requestHeader = parseRequestHeader(request);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (requestHeader == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//首次处理这个Topic消息，会返回一个空的TopicQueueMappingContext&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; TopicQueueMappingContext mappingContext = this.brokerController&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.getTopicQueueMappingManager()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.buildTopicQueueMappingContext(requestHeader, true);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand rewriteResult = this.brokerController.getTopicQueueMappingManager()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.rewriteRequestForStaticTopic(requestHeader, mappingContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (rewriteResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return rewriteResult;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//消息上下文信息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sendMessageContext = &lt;b&gt;buildMsgContext&lt;/b&gt;(ctx, requestHeader, request);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executeSendMessageHookBefore(sendMessageContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (AbortProcessException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final RemotingCommand errorResponse = RemotingCommand&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.createResponseCommand(e.getResponseCode(), e.getErrorMessage());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; errorResponse.setOpaque(request.getOpaque());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return errorResponse;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand response;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; clearReservedProperties(requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (requestHeader.isBatch()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response = this.&lt;b&gt;sendBatchMessage&lt;/b&gt;(ctx, request, sendMessageContext, requestHeader, mappingContext,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (ctx1, response1) -&amp;gt; executeSendMessageHookAfter(response1, ctx1));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response = this.&lt;b&gt;sendMessage&lt;/b&gt;(ctx, request, sendMessageContext, requestHeader, mappingContext,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (ctx12, response12) -&amp;gt; executeSendMessageHookAfter(response12, ctx12));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="760" y="3080" width="440" height="560" as="geometry" />
        </mxCell>
        <mxCell id="_vTxldMSkyuMYbInRsxu-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.637;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="tDYusJ2PWB5UsnWIg58C-3" target="_vTxldMSkyuMYbInRsxu-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_vTxldMSkyuMYbInRsxu-3" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_vTxldMSkyuMYbInRsxu-2" vertex="1" connectable="0">
          <mxGeometry x="0.9524" relative="1" as="geometry">
            <mxPoint x="-17" y="460" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WS2-srf6M03RlDYXjZrx-1" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_vTxldMSkyuMYbInRsxu-2" vertex="1" connectable="0">
          <mxGeometry x="-0.0118" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-3" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_vTxldMSkyuMYbInRsxu-2" vertex="1" connectable="0">
          <mxGeometry x="0.8635" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="p-c8a4QaCHUM1Zi8Nfrx-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.018;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="tDYusJ2PWB5UsnWIg58C-3" target="p-c8a4QaCHUM1Zi8Nfrx-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="34dl4HjKRIYGEBBzzcXS-1" value="0" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="p-c8a4QaCHUM1Zi8Nfrx-2" vertex="1" connectable="0">
          <mxGeometry x="-0.7443" relative="1" as="geometry">
            <mxPoint x="19" y="38" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.62;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="tDYusJ2PWB5UsnWIg58C-3" target="h7HRPMHvCTYBDUlLkEB4-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1810" y="4224" />
              <mxPoint x="1810" y="3670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-4" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="h7HRPMHvCTYBDUlLkEB4-2" vertex="1" connectable="0">
          <mxGeometry x="0.9304" relative="1" as="geometry">
            <mxPoint x="11" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tDYusJ2PWB5UsnWIg58C-3" value="&lt;b&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//0 主要是创建返回值对象，并做些检查, 当发现topic不存在时会创建topic&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/b&gt;final RemotingCommand response = &lt;b&gt;preSend&lt;/b&gt;(ctx, request, requestHeader);&lt;br style=&quot;font-size: 9px;&quot;&gt;...&lt;br style=&quot;font-size: 9px;&quot;&gt;final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader)&amp;nbsp;response.readCustomHeader();&lt;br style=&quot;font-size: 9px;&quot;&gt;final byte[] body = request.&lt;b style=&quot;font-size: 9px;&quot;&gt;getBody&lt;/b&gt;();&lt;br style=&quot;font-size: 9px;&quot;&gt;int queueIdInt = requestHeader.getQueueId();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;// 这里用到的主题配置就是在第一次创建主题时创建的&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (queueIdInt &amp;lt; 0) {&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;//如果队列ID小于0,则随机选择一个队列存储消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; queueIdInt = randomQueueId(topicConfig.getWriteQueueNums());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;//这个消息类型是存储到消息队列中的消息实例的类型&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;MessageExtBrokerInner&lt;/b&gt; &lt;b&gt;msgInner&lt;/b&gt; = new MessageExtBrokerInner();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setTopic(requestHeader.getTopic()); &lt;font color=&quot;#007fff&quot;&gt;//消息主题&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setQueueId(queueIdInt); &lt;font color=&quot;#007fff&quot;&gt;//消息存储到的队列的索引&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;Map&amp;lt;String, String&amp;gt; oriProps = MessageDecoder.string2messageProperties(requestHeader.getProperties());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果是重试或重试超过最大重试次数的处理，todo 后面再看&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (!&lt;b&gt;handleRetryAndDLQ&lt;/b&gt;(requestHeader, response, request, msgInner, topicConfig, oriProps)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setBody(body);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setFlag(requestHeader.getFlag());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String uniqKey = oriProps.get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (uniqKey == null || uniqKey.length() &amp;lt;= 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; uniqKey = MessageClientIDSetter.createUniqID();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; oriProps.put(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX, uniqKey);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageAccessor.setProperties(msgInner, oriProps);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//清理策略，COMPACTION 策略需要 KEYS 属性，这里其实是检查，todo&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;CleanupPolicy cleanupPolicy = CleanupPolicyUtils.getDeletePolicy(Optional.of(topicConfig));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (Objects.equals(cleanupPolicy, CleanupPolicy.COMPACTION)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (StringUtils.isBlank(msgInner.getKeys())) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setCode(ResponseCode.MESSAGE_ILLEGAL);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setRemark(&quot;Required message key is missing&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setBornTimestamp(requestHeader.getBornTimestamp());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setBornHost(ctx.channel().remoteAddress());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setStoreHost(this.getStoreHost());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String clusterName = this.brokerController.getBrokerConfig().getBrokerClusterName();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_CLUSTER, clusterName);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String traFlag = oriProps.get(MessageConst.PROPERTY_TRANSACTION_PREPARED);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务消息的处理，todo&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;boolean sendTransactionPrepareMessage;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (Boolean.parseBoolean(traFlag)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; !(msgInner.getReconsumeTimes() &amp;gt; 0 &amp;amp;&amp;amp; msgInner.getDelayTimeLevel() &amp;gt; 0)) { //For client under version 4.6.1&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (this.brokerController.getBrokerConfig().isRejectTransactionMessage()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setCode(ResponseCode.NO_PERMISSION);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setRemark(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;the broker[&quot; + this.brokerController.getBrokerConfig().getBrokerIP1()&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + &quot;] sending transaction message is forbidden&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; sendTransactionPrepareMessage = true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; sendTransactionPrepareMessage = false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//后面是将消息存储到消息队列的操作&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long beginTimeMillis = this.brokerController.getMessageStore().now();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (brokerController.getBrokerConfig().isAsyncSendEnable()) {&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//异步存储（默认）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;PutMessageResult&amp;gt; asyncPutMessageFuture;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (sendTransactionPrepareMessage) { &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 事务消息异步存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; asyncPutMessageFuture = this.brokerController.&lt;b&gt;getTransactionalMessageService&lt;/b&gt;().&lt;b&gt;asyncPrepareMessage&lt;/b&gt;(msgInner);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else { &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 非事务消息异步存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; asyncPutMessageFuture = this.brokerController.getMessageStore().&lt;b&gt;asyncPutMessage&lt;/b&gt;(msgInner);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; final int finalQueueIdInt = queueIdInt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; final MessageExtBrokerInner finalMsgInner = msgInner;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; asyncPutMessageFuture.thenAcceptAsync(putMessageResult -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand responseFuture =&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handlePutMessageResult(putMessageResult, response, request, finalMsgInner, responseHeader, sendMessageContext,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ctx, finalQueueIdInt, beginTimeMillis, mappingContext, BrokerMetricsManager.getMessageType(requestHeader));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (responseFuture != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; doResponse(ctx, request, responseFuture);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // record the transaction metrics, responseFuture == null means put successfully&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sendTransactionPrepareMessage &amp;amp;&amp;amp; (responseFuture == null || responseFuture.getCode() == ResponseCode.SUCCESS)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.getTransactionalMessageService().getTransactionMetrics()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.addAndGet(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC), 1);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sendMessageCallback.onComplete(sendMessageContext, response);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }, this.brokerController.getPutMessageFutureExecutor());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // Returns null to release the send message thread&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;//同步存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; PutMessageResult putMessageResult = null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (sendTransactionPrepareMessage) { &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//3 事务消息同步存储&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult = this.brokerController.getTransactionalMessageService().&lt;b&gt;prepareMessage&lt;/b&gt;(msgInner);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//4 非事务消息同步存储&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; putMessageResult = this.brokerController.getMessageStore().&lt;b&gt;putMessage&lt;/b&gt;(msgInner);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;handlePutMessageResult&lt;/b&gt;(putMessageResult, response, request, msgInner, responseHeader, sendMessageContext, ctx, queueIdInt, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;beginTimeMillis, mappingContext, BrokerMetricsManager.getMessageType(requestHeader));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // record the transaction metrics&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;amp;&amp;amp; putMessageResult.getAppendMessageResult().isOk()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.getTransactionalMessageService().getTransactionMetrics()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; .addAndGet(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC), 1);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; sendMessageCallback.onComplete(sendMessageContext, response);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="3480" width="559" height="1200" as="geometry" />
        </mxCell>
        <mxCell id="_vTxldMSkyuMYbInRsxu-1" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//做一些检查、对批量、延迟消息做特殊处理，todo后面再看&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (PutMessageHook putMessageHook : putMessageHookList) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PutMessageResult handleResult = putMessageHook.&lt;b&gt;executeBeforePutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (handleResult != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(handleResult);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;long beginTime = this.getSystemClock().now();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//将消息异步写入 CommitLog 文件，本质是写入了文件缓冲中，数据刷盘到文件则是通过线程异步完成的，这部分详细参考 rokcetmq-messagestore.drawio&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;PutMessageResult&amp;gt; putResultFuture = this.&lt;b&gt;commitLog&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;asyncPutMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div&gt;putResultFuture.thenAccept(result -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long elapsedTime = this.getSystemClock().now() - beginTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.storeStatsService.&lt;b&gt;setPutMessageEntireTimeMax&lt;/b&gt;(elapsedTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (null == result || !result.isOk()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.storeStatsService.getPutMessageFailedTimes().&lt;b&gt;add&lt;/b&gt;(1);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;return putResultFuture;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1840" y="3960" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="_vTxldMSkyuMYbInRsxu-4" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Message&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String topic;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int flag;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; properties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] body;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String transactionId;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1640" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="oexqA_hjLOkNcrBCT8dM-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="oexqA_hjLOkNcrBCT8dM-1" target="_vTxldMSkyuMYbInRsxu-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="oexqA_hjLOkNcrBCT8dM-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageExt&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String brokerName;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int queueId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int storeSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息索引信息在ConsumeQueue MappedFile 中的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;queueOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//详细参考 MessageSysFlag 注释&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;sysFlag&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long bornTimestamp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private SocketAddress bornHost;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long storeTimestamp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private SocketAddress storeHost;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String msgId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long commitLogOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int bodyCRC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int reconsumeTimes;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long preparedTransactionOffset;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1800" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="oexqA_hjLOkNcrBCT8dM-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="oexqA_hjLOkNcrBCT8dM-3" target="oexqA_hjLOkNcrBCT8dM-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="oexqA_hjLOkNcrBCT8dM-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageExtBrokerInner&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String propertiesString;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long tagsCode;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ByteBuffer encodedBuff;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean encodeCompleted;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MessageVersion version = MessageVersion.MESSAGE_VERSION_V1;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2120" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-1" target="6p4HSz2lRJ6rl-BUe08P-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-1" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;在新消息写入CommitLog、并被&lt;b&gt;ReputMessageService&lt;/b&gt; 异步写入 ConsumeQueue、IndexFile 之后，&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;还通过&amp;nbsp;notifyMessageArrivceIfNecessary() 通知消费者消费&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1720" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-6" target="6p4HSz2lRJ6rl-BUe08P-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-6" value="&lt;div style=&quot;&quot;&gt;DefaultMessageStore#&lt;br&gt;&lt;b&gt;notifyMessageArrivceIfNecessary&lt;/b&gt;()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1960" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-8" target="6p4HSz2lRJ6rl-BUe08P-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-8" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;if (DefaultMessageStore.this.brokerConfig.isLongPollingEnable()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;amp;&amp;amp; DefaultMessageStore.this.messageArrivingListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;messageArrivingListener&lt;/b&gt;.&lt;b&gt;arriving&lt;/b&gt;(dispatchRequest.getTopic(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getQueueId(), dispatchRequest.&lt;b&gt;getConsumeQueueOffset&lt;/b&gt;() + 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getTagsCode(), dispatchRequest.getStoreTimestamp(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dispatchRequest.getBitMap(), dispatchRequest.getPropertiesMap());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; DefaultMessageStore.this.&lt;b&gt;reputMessageService&lt;/b&gt;&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;notifyMessageArrive4MultiQueue&lt;/b&gt;(dispatchRequest);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2200" y="760" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-9" target="07X-HWd1W3Q1zzt6SAMq-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="07X-HWd1W3Q1zzt6SAMq-2" vertex="1" connectable="0">
          <mxGeometry x="0.4249" y="3" relative="1" as="geometry">
            <mxPoint x="3" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-9" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;pullRequestHoldService&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;notifyMessageArriving&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(topic, queueId, logicOffset, tagsCode,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;msgStoreTime, filterBitMap, properties);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.popMessageProcessor.&lt;b&gt;notifyMessageArriving&lt;/b&gt;(topic, queueId);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.notificationProcessor.&lt;b&gt;notifyMessageArriving&lt;/b&gt;(topic, queueId);&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2680" y="760" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-10" value="DefaultMessageStore" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2828" y="730" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-12" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MessageArrivingListener (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;arriving&lt;/b&gt;(String topic, int queueId, long logicOffset, long tagsCode,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;long msgStoreTime, &lt;br&gt;&amp;nbsp; &amp;nbsp; byte[] filterBitMap, Map&amp;lt;String, String&amp;gt; properties);&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2280" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-14" target="6p4HSz2lRJ6rl-BUe08P-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="6p4HSz2lRJ6rl-BUe08P-14" target="6p4HSz2lRJ6rl-BUe08P-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NotifyMessageArrivingListener&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullRequestHoldService &lt;b&gt;pullRequestHoldService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PopMessageProcessor &lt;b&gt;popMessageProcessor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NotificationProcessor &lt;b&gt;notificationProcessor&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2400" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="6p4HSz2lRJ6rl-BUe08P-15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PullRequestHoldService&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;extends ServiceThread&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;是一个非守护线程，内部维持了各个主题队列的 PullRequest列表，线程启动后会轮询 pullRequestTable将新消息位置属性等信息&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final String TOPIC_QUEUEID_SEPARATOR = &quot;@&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final BrokerController &lt;b&gt;brokerController&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final SystemClock systemClock = new SystemClock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;lt;topicName&amp;gt;@&amp;lt;queueId&amp;gt; -&amp;gt; ManyPullRequest&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ConcurrentMap&amp;lt;String/* topic@queueId */, ManyPullRequest&amp;gt; &lt;b&gt;pullRequestTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(1024);&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="2400" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-1" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//主题队列的key（格式：&amp;lt;topic&amp;gt;@&amp;lt;queueId&amp;gt;），比如“TopicTest-10@2”&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String key = this.buildKey(topic, queueId);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//获取这个主题队列上的PullRequest集合，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;ManyPullRequest mpr = this.&lt;b style=&quot;font-size: 9px;&quot;&gt;pullRequestTable&lt;/b&gt;.get(key);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (mpr != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;PullRequest&amp;gt; requestList = mpr.cloneListAndClear(); &lt;font color=&quot;#007fff&quot;&gt;//克隆并清空，后面mpr就是空的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (requestList != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;PullRequest&amp;gt; replayList = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (PullRequest request : &lt;b&gt;requestList&lt;/b&gt;) {&amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long newestOffset = maxOffset; &lt;font color=&quot;#007fff&quot;&gt;//即前面传参的logicOffset，是消息在ConsumeQueue中存储的相对偏移（第几个消息）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (newestOffset &amp;lt;= request.getPullFromThisOffset()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; newestOffset = this.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (newestOffset &amp;gt; request.getPullFromThisOffset()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean match = request.&lt;b&gt;getMessageFilter&lt;/b&gt;().&lt;b&gt;isMatchedByConsumeQueue&lt;/b&gt;(tagsCode,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new ConsumeQueueExt.CqExtUnit(tagsCode, msgStoreTime, filterBitMap));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // match by bit map, need eval again when properties is not null.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (match &amp;amp;&amp;amp; properties != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; match = request.getMessageFilter().isMatchedByCommitLog(null, properties);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (match) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//异步调用PullMessageProcessor.this.processRequest(...),&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;即重放Consumer拉消息请求处理方法&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.&lt;b&gt;getPullMessageProcessor&lt;/b&gt;().&lt;b&gt;executeRequestWhenWakeup&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; request.getClientChannel(),&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;request.getRequestCommand());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;PullRequestHoldService#notifyMessageArriving: failed to execute request when &quot;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + &quot;message matched, topic={}, queueId={}&quot;, topic, queueId, e);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (System.currentTimeMillis() &amp;gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //挂起超时且前面不匹配的请求也执行&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.&lt;b&gt;getPullMessageProcessor&lt;/b&gt;().&lt;b&gt;executeRequestWhenWakeup&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;request.getClientChannel(),&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;request.getRequestCommand());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;replayList&lt;/b&gt;.add(request); &lt;font color=&quot;#007fff&quot;&gt;//已经matched的请求不会再加回mpr&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!replayList.isEmpty()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mpr.&lt;b&gt;addPullRequest&lt;/b&gt;(replayList);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="3160" y="480" width="440" height="620" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-4" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DispatcherRequest&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于消息消费的消息队列实现，并不存储消息本身，而是存储消息在CommitLog中的位置&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;topic&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;queueId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CommitLog中最新提交的消息在MappedFile中的偏移量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;commitLogOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//正在被分发的消息的长度&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;msgSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TAGS属性的hashcode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;tagsCode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long storeTimestamp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息在当前队列的偏移，即相对于当前消费队列第一个消息的偏移&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;consumeQueueOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String keys;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean success;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String uniqKey;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int sysFlag;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long preparedTransactionOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String, String&amp;gt; propertiesMap;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] &lt;b&gt;bitMap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int bufferSize = -1;//the buffer size maybe larger than the msg size if the message is wrapped by something&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// for batch consume queue&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long&amp;nbsp; msgBaseOffset = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private short batchSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long nextReputFromOffset = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String offsetId;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="2560" width="480" height="440" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.388;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="07X-HWd1W3Q1zzt6SAMq-5" target="07X-HWd1W3Q1zzt6SAMq-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-9" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="07X-HWd1W3Q1zzt6SAMq-8" vertex="1" connectable="0">
          <mxGeometry x="0.922" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.524;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="07X-HWd1W3Q1zzt6SAMq-5" target="sQ_lBTr8jpGpnW1OxW_L-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1239.65" y="5139" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="NIsg8XFVn3GaT6LxfTtD-1" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="sQ_lBTr8jpGpnW1OxW_L-2" vertex="1" connectable="0">
          <mxGeometry x="0.3627" y="-4" relative="1" as="geometry">
            <mxPoint y="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-5" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 先是执行一堆检查：broker是否可读、Consumer分组配置是否存在、配置中是否可消费、topic配置中权限是否可读等等&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;...&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;final boolean useResetOffsetFeature = brokerController.getBrokerConfig().isUseServerSideResetOffset();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String topic = requestHeader.getTopic();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;String group = requestHeader.getConsumerGroup();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int queueId = requestHeader.getQueueId();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;Long resetOffset = brokerController.getConsumerOffsetManager().queryThenEraseResetOffset(topic, group, queueId);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个方法近300行，但是核心的逻辑是这里&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;GetMessageResult&lt;/b&gt; &lt;b&gt;getMessageResult&lt;/b&gt; = null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (useResetOffsetFeature &amp;amp;&amp;amp; null != resetOffset) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult = new GetMessageResult();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult.setStatus(GetMessageStatus.OFFSET_RESET);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult.setNextBeginOffset(resetOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult.setMinOffset(messageStore.getMinOffsetInQueue(topic, queueId));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult.setMaxOffset(messageStore.getMaxOffsetInQueue(topic, queueId));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; getMessageResult.setSuggestPullingFromSlave(false);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; long broadcastInitOffset = queryBroadcastPullInitOffset(topic, group, queueId, requestHeader, channel);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (broadcastInitOffset &amp;gt;= 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult = new GetMessageResult();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult.setStatus(GetMessageStatus.OFFSET_RESET);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult.setNextBeginOffset(broadcastInitOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SubscriptionData finalSubscriptionData = subscriptionData;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand finalResponse = response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//1 从 DefaultMessageStore 异步获取&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageStore.&lt;b&gt;getMessageAsync&lt;/b&gt;(group, topic, queueId, requestHeader.getQueueOffset(),&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.getMaxMsgNums(), messageFilter)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;thenApply&lt;/b&gt;(&lt;b&gt;result&lt;/b&gt; -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == result) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; finalResponse.setCode(ResponseCode.SYSTEM_ERROR);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; finalResponse.setRemark(&quot;store getMessage return null&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return finalResponse;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerController.getColdDataCgCtrService().coldAcc(requestHeader.getConsumerGroup(), result.getColdDataSum());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 根据获取消息结果处理&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return &lt;b&gt;pullMessageResultHandler&lt;/b&gt;.&lt;b&gt;handle&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;result&lt;/b&gt;,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; channel,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; finalSubscriptionData,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscriptionGroupConfig,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerAllowSuspend,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageFilter,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; finalResponse,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappingContext,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeMills&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; );&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; })&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //响应请求&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;thenAccept&lt;/b&gt;(result -&amp;gt; NettyRemotingAbstract.&lt;b&gt;writeResponse&lt;/b&gt;(channel, request, result));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (getMessageResult != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b&gt;pullMessageResultHandler&lt;/b&gt;.&lt;b&gt;handle&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; channel,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscriptionData,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscriptionGroupConfig,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; brokerAllowSuspend,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageFilter,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mappingContext,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beginTimeMills&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; );&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return null;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="758.65" y="4720" width="440" height="800" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="07X-HWd1W3Q1zzt6SAMq-7" target="07X-HWd1W3Q1zzt6SAMq-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-7" value="return CompletableFuture.completedFuture(&lt;br&gt;&lt;b&gt;getMessage&lt;/b&gt;(group, topic, queueId, offset, maxMsgNums, messageFilter));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;参考 MessageStore 流程图&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1238.65" y="4750" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-10" value="DefaultMessageStore" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1278.65" y="4720" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="07X-HWd1W3Q1zzt6SAMq-11" value="获取消息结果的几种可能状态：&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.NO_MESSAGE_IN_QUEUE&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.OFFSET_TOO_SMALL&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.OFFSET_OVERFLOW_ONE&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.OFFSET_OVERFLOW_BADLY&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.NO_MATCHED_MESSAGE&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.OFFSET_FOUND_NULL&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.MESSAGE_WAS_REMOVING&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.&lt;b&gt;FOUND&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;GetMessageStatus.NO_MATCHED_LOGIC_QUEUE" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1478.65" y="4720" width="240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="sQ_lBTr8jpGpnW1OxW_L-1" target="sQ_lBTr8jpGpnW1OxW_L-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1458.65" y="5140" />
              <mxPoint x="1458.65" y="5450" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="sQ_lBTr8jpGpnW1OxW_L-1" target="sQ_lBTr8jpGpnW1OxW_L-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-1" value="&lt;b&gt;DefaultPullMessageResultHandler&lt;/b&gt;#&lt;br&gt;handle()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;根据 RemotingCommand code 分别处理，部分其实相当于根据获取消息结果进行处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.15" y="5109" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="sQ_lBTr8jpGpnW1OxW_L-3" target="sQ_lBTr8jpGpnW1OxW_L-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-3" value="&lt;b&gt;ResponseCode.PULL_NOT_FOUND&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;拉取失败就添加对有消息到达的监听&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1479.65" y="5420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="sQ_lBTr8jpGpnW1OxW_L-5" target="sQ_lBTr8jpGpnW1OxW_L-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-5" value="&lt;b&gt;ResponseCode.SUCCESS&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;对应&lt;/font&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;GetMessageStatus.FOUND，直接读取消息返回给消费者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1479.65" y="5100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-7" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这里先只关注两种状态的处理&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1263.65" y="5169" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-8" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;if (this.brokerController.getBrokerConfig().isTransferMsgByHeap()) { &lt;font color=&quot;#007fff&quot;&gt;//默认&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//合并 GetMessageResult messageBufferList，然后通过 array 方法读取内容的字节数组，&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; 测试中为何会读取到两个ByteBuffer？因为距离上次消费此主题到现在中间插入了两条消息，消息读取是批量读取的&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; final byte[] r = this.&lt;b&gt;readGetMessageResult&lt;/b&gt;(getMessageResult, requestHeader.getConsumerGroup(), &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;requestHeader.getTopic(), requestHeader.getQueueId());&amp;nbsp;&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.getTopic(), requestHeader.getQueueId(),&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (int) (this.brokerController.getMessageStore().now() - beginTimeMills));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; response.&lt;b&gt;setBody&lt;/b&gt;(r);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; FileRegion fileRegion = new ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()),&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; getMessageResult);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand finalResponse = response;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; channel.&lt;b&gt;writeAndFlush&lt;/b&gt;(fileRegion)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addListener((ChannelFutureListener) future -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult.release();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Attributes attributes = RemotingMetricsManager.newAttributesBuilder()&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .put(LABEL_REQUEST_CODE, RemotingHelper.getRequestCodeDesc(request.getCode()))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .put(LABEL_RESPONSE_CODE, RemotingHelper.getResponseCodeDesc(finalResponse.getCode()))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .put(LABEL_RESULT, RemotingMetricsManager.getWriteAndFlushResult(future))&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .build();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingMetricsManager.rpcLatency.record(request.getProcessTimer().elapsed(TimeUnit.MILLISECONDS), attributes);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!future.isSuccess()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;Fail to transfer messages from page cache to {}&quot;, channel.remoteAddress(), future.cause());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;Error occurred when transferring messages from page cache&quot;, e);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getMessageResult.release();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1718.65" y="4940" width="520" height="380" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1.002;entryY=0.081;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="sQ_lBTr8jpGpnW1OxW_L-11" target="07X-HWd1W3Q1zzt6SAMq-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sQ_lBTr8jpGpnW1OxW_L-11" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;final boolean hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag());&lt;/div&gt;&lt;div&gt;final long suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : 0;&lt;/div&gt;&lt;div&gt;if (brokerAllowSuspend &amp;amp;&amp;amp; hasSuspendFlag) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long pollingTimeMills = suspendTimeoutMillisLong;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String topic = requestHeader.getTopic();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long offset = requestHeader.getQueueOffset();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int queueId = requestHeader.getQueueId();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PullRequest &lt;b&gt;pullRequest&lt;/b&gt; = new &lt;b&gt;PullRequest&lt;/b&gt;(request, channel, pollingTimeMills,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.getMessageStore().now(), offset, subscriptionData, messageFilter);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //即拉取消息失败，就将拉取请求添加到 PullRequestHoldService pullRequestTable，后面由 ReputMesageService 在有消息可消费时通知（&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;notifyMessageArrivceIfNecessary()&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;）&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.brokerController.&lt;b&gt;getPullRequestHoldService&lt;/b&gt;().&lt;b&gt;suspendPullRequest&lt;/b&gt;(topic, queueId, pullRequest);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //向消费者返回null&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=2;align=left;" parent="1" vertex="1">
          <mxGeometry x="1718.65" y="5340" width="520" height="220" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="NkqDwNfi0PbD3_duYgaC-1" target="NkqDwNfi0PbD3_duYgaC-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-1" value="&lt;b&gt;ClientManageProcessor&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;处理 RequestCode.HEART_BEAT (34)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;RequestCode.UNREGISTER_CLIENT (35)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;RequestCode.CHECK_CLIENT_CONFIG（46）&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="519.15" y="5730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="NkqDwNfi0PbD3_duYgaC-3" target="NkqDwNfi0PbD3_duYgaC-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-7" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="NkqDwNfi0PbD3_duYgaC-6" vertex="1" connectable="0">
          <mxGeometry x="0.3833" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-3" value="&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;switch (request.getCode()) {&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.HEART_BEAT:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;heartBeat&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.UNREGISTER_CLIENT:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;unregisterClient&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.CHECK_CLIENT_CONFIG:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;checkClientConfig&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;return null;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="758.65" y="5680" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-5" value="&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;for (ConsumerData consumerData : heartbeatData.getConsumerDataSet()) {&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; boolean changed = this.brokerController.&lt;b&gt;getConsumerManager&lt;/b&gt;().&lt;b&gt;registerConsumer&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getGroupName(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; clientChannelInfo,&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getConsumeType(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getMessageModel(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getConsumeFromWhere(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getSubscriptionDataSet(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; isNotifyConsumerIdsChangedEnable&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; );&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;for (ProducerData data : heartbeatData.getProducerDataSet()) {&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; this.brokerController.&lt;b&gt;getProducerManager&lt;/b&gt;().&lt;b&gt;registerProducer&lt;/b&gt;(data.getGroupName(),&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; clientChannelInfo);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1238.65" y="5660" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumerManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消费者管理器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者分组 -&amp;gt; ConsumerGroupInfo (groupName、topic -&amp;gt; SubscriptionData、channelInfoTable、消费类型、消息模式、消费起始偏移等)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, ConsumerGroupInfo&amp;gt; &lt;b&gt;consumerTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(1024);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, ConsumerGroupInfo&amp;gt; &lt;b&gt;consumerCompensationTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(1024);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;ConsumerIdsChangeListener&amp;gt; consumerIdsChangeListenerList = new CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final BrokerStatsManager brokerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long channelExpiredTimeout;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long subscriptionExpiredTimeout;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="720" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProducerManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;生产者管理器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long CHANNEL_EXPIRED_TIMEOUT = 1000 * 120;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int GET_AVAILABLE_CHANNEL_RETRY_COUNT = 3;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* group name */, ConcurrentHashMap&amp;lt;Channel, ClientChannelInfo&amp;gt;&amp;gt; &lt;b&gt;groupChannelTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String, Channel&amp;gt; &lt;b&gt;clientChannelTable&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final BrokerStatsManager brokerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private PositiveAtomicCounter positiveAtomicCounter = new PositiveAtomicCounter();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;ProducerChangeListener&amp;gt; producerChangeListenerList = new &lt;br&gt;&amp;nbsp; &amp;nbsp; CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1000" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="NkqDwNfi0PbD3_duYgaC-10" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;注册到 ConsumerManager consumerTable 的消费者信息：&lt;/b&gt;&lt;br&gt;key: please_rename_unique_group_name_4&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;value： {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;allChannel&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;allClientId&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;channelInfoTable&quot;: {},&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;consumeFromWhere&quot;: &quot;CONSUME_FROM_FIRST_OFFSET&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;consumeType&quot;: &quot;CONSUME_PASSIVELY&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;groupName&quot;: &quot;please_rename_unique_group_name_4&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;lastUpdateTimestamp&quot;: 1718198678359,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;messageModel&quot;: &quot;CLUSTERING&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;subscribeTopics&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;subscriptionTable&quot;: {}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1696.65" y="5665" width="310" height="190" as="geometry" />
        </mxCell>
        <mxCell id="mEOQWECAQyR5dx2vd3Kd-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;GetMessageResult&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;从MessageStore查询的消息数据&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;SelectMappedBufferResult&amp;gt; messageMapedList;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;ByteBuffer&amp;gt; messageBufferList;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;Long&amp;gt; messageQueueOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private GetMessageStatus status;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long nextBeginOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long minOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long maxOffset;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int bufferTotalSize = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int messageCount = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean suggestPullingFromSlave = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int msgCount4Commercial = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int commercialSizePerMsg = 4 * 1024;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long coldDataSum = 0L;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="3040" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="mEOQWECAQyR5dx2vd3Kd-2" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;getMessageResult = {GetMessageResult@4130}&lt;/div&gt;&lt;div&gt;&amp;nbsp;messageMapedList = {ArrayList@4887}&amp;nbsp; size = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp; 0 = {SelectMappedBufferResult@4893}&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; 1 = {SelectMappedBufferResult@4894}&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&lt;b&gt;messageBufferList&lt;/b&gt; = {ArrayList@4888}&amp;nbsp; size = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp; 0 = {DirectByteBuffer@4895} &quot;java.nio.DirectByteBuffer[pos=0 lim=242 cap=1073656395]&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp; 1 = {DirectByteBuffer@4901} &quot;java.nio.DirectByteBuffer[pos=0 lim=242 cap=1073656153]&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;messageQueueOffset = {ArrayList@4889}&amp;nbsp; size = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp; 0 = {Long@4908} 0&lt;/div&gt;&lt;div&gt;&amp;nbsp; 1 = {Long@4909} 1&lt;/div&gt;&lt;div&gt;&amp;nbsp;status = {GetMessageStatus@4890} &quot;FOUND&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;nextBeginOffset = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp;minOffset = 0&lt;/div&gt;&lt;div&gt;&amp;nbsp;maxOffset = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp;bufferTotalSize = 484&lt;/div&gt;&lt;div&gt;&amp;nbsp;messageCount = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp;suggestPullingFromSlave = false&lt;/div&gt;&lt;div&gt;&amp;nbsp;msgCount4Commercial = 2&lt;/div&gt;&lt;div&gt;&amp;nbsp;commercialSizePerMsg = 4096&lt;/div&gt;&lt;div&gt;&amp;nbsp;coldDataSum = 0&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2250" y="4940" width="430" height="250" as="geometry" />
        </mxCell>
        <mxCell id="_NSqbVcSP8NbKmjyiwZC-1" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;PullRequestHoldService&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3315" y="450" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Ur48CQh2tFv5cfVYlTKV-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="p-c8a4QaCHUM1Zi8Nfrx-1" target="Ur48CQh2tFv5cfVYlTKV-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="p-c8a4QaCHUM1Zi8Nfrx-1" value="&lt;div&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot;&gt;//&amp;nbsp;&lt;/font&gt;msgCheck()&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;topic 不存在则创建&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;topicConfig = this.brokerController.getTopicConfigManager()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;.&lt;b&gt;createTopicInSendMessageMethod&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.getTopic(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.getDefaultTopic(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingHelper.parseChannelRemoteAddr(ctx.channel()),&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;/&lt;/span&gt;/ 读写队列个数&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.&lt;b&gt;getDefaultTopicQueueNums&lt;/b&gt;(), topicSysFlag);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1840" y="3480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Ur48CQh2tFv5cfVYlTKV-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Ur48CQh2tFv5cfVYlTKV-1" target="Ur48CQh2tFv5cfVYlTKV-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qJy9MSSes6QPAAs6ClO5-1" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Ur48CQh2tFv5cfVYlTKV-4" vertex="1" connectable="0">
          <mxGeometry x="-0.0698" y="-2" relative="1" as="geometry">
            <mxPoint x="1" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Ur48CQh2tFv5cfVYlTKV-1" value="&lt;div&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//将为主题创建的配置注册到本地 TopicConfigManager&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;putTopicConfig&lt;/b&gt;(topicConfig);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 会向所有NameServer报备（注册）&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;registerBrokerData&lt;/b&gt;(topicConfig);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2321.35" y="3480" width="198.65" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Ur48CQh2tFv5cfVYlTKV-3" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;默认向所有NameServer发送&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;RequestCode.&lt;b&gt;REGISTER_BROKER &lt;/b&gt;请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=14;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2560.85" y="3510" width="198.65" height="60" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="eq0b_6B1wbCSJMy3NEEP-1" target="eq0b_6B1wbCSJMy3NEEP-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-1" value="&lt;b&gt;ConsumerManageProcessor&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;处理 RequestCode.GET_CONSUMER_LIST_BY_GROUP&amp;nbsp;(38)&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;RequestCode.&lt;b&gt;UPDATE_CONSUMER_OFFSET&lt;/b&gt;&amp;nbsp;(15)&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;RequestCode.QUERY_CONSUMER_OFFSET（14）&lt;/font&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="519.15" y="5930" width="240.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="eq0b_6B1wbCSJMy3NEEP-3" target="eq0b_6B1wbCSJMy3NEEP-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-7" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="eq0b_6B1wbCSJMy3NEEP-6" vertex="1" connectable="0">
          <mxGeometry x="0.5" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-3" value="&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;switch (request.getCode()) {&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.GET_CONSUMER_LIST_BY_GROUP:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.getConsumerListByGroup(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.UPDATE_CONSUMER_OFFSET:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 2 更新消息队列的消费位点&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;updateConsumerOffset&lt;/b&gt;(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; case RequestCode.QUERY_CONSUMER_OFFSET:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.queryConsumerOffset(ctx, request);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="798.65" y="5880" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="eq0b_6B1wbCSJMy3NEEP-5" value="&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 存储在OffsetManager&amp;nbsp;offsetTable，消费位点也会持久化到磁盘（TODO）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;this.brokerController.&lt;b&gt;getConsumerOffsetManager&lt;/b&gt;().&lt;b&gt;commitOffset&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; RemotingHelper.parseChannelRemoteAddr(ctx.channel()), group, topic, queueId, &lt;br&gt;&amp;nbsp; &amp;nbsp; offset);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1238.65" y="5920" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="JrXRcp5HBTDRNXJl_5MU-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="DUlj2uKyITs8i-9-p9XH-1" target="JrXRcp5HBTDRNXJl_5MU-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1840" y="3275" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DUlj2uKyITs8i-9-p9XH-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 方法两百多行，这里只展示重要逻辑&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); font-size: 9px;&quot;&gt;...&lt;br style=&quot;font-size: 9px;&quot;&gt;// 消息重试会保存到 %RETRY%consumerGroup 主题中，前提是没有超过最大重试次数&lt;/b&gt;&lt;span style=&quot;color: rgb(0, 127, 255); font-size: 9px;&quot;&gt;（当前版本默认3次，3.4.9之前是16次）&lt;/span&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/font&gt;String &lt;b style=&quot;font-size: 9px;&quot;&gt;newTopic&lt;/b&gt; = MixAll.getRetryTopic(requestHeader.getGroup());&lt;br style=&quot;font-size: 9px;&quot;&gt;int &lt;b style=&quot;font-size: 9px;&quot;&gt;queueIdInt&lt;/b&gt; = this.random.nextInt(subscriptionGroupConfig.getRetryQueueNums());&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//随机选择一个消息队列&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;...&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;TopicConfig topicConfig = masterBroker.getTopicConfigManager().&lt;b style=&quot;font-size: 9px;&quot;&gt;createTopicInSendMessageBackMethod&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; newTopic,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscriptionGroupConfig.getRetryQueueNums(),&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;// 重试消息会延迟投递，&lt;/b&gt;后面会 msgExt.setDelayTimeLevel(delayLevel);&lt;br&gt;// RocketMQ 应该&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/font&gt;int delayLevel = requestHeader.getDelayLevel();&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255); font-size: 9px;&quot;&gt;// 重试次数检查，达到重试最大次数，保存到死信队列&lt;/b&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (request.getVersion() &amp;gt;= MQVersion.Version.V3_4_9.ordinal()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; Integer times = requestHeader.getMaxReconsumeTimes();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (times != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; maxReconsumeTimes = times;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (msgExt.getReconsumeTimes() &amp;gt;= maxReconsumeTimes&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; || delayLevel &amp;lt; 0) {&lt;/div&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 9px;&quot;&gt;newTopic&lt;/b&gt; = MixAll.getDLQTopic(requestHeader.getGroup());&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//&amp;nbsp;%DLQ%consumerGroup&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 9px;&quot;&gt;queueIdInt&lt;/b&gt; = randomQueueId(DLQ_NUMS_PER_GROUP);&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageExtBrokerInner msgInner = new MessageExtBrokerInner();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setTopic(newTopic);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;msgInner.setQueueId(queueIdInt);&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 保存到 CommitLog， 后面会通过ReputMessageService 线程任务将消息索引放到 MessageQueue&amp;nbsp;&lt;/font&gt;&lt;/div&gt;PutMessageResult putMessageResult = masterBroker.&lt;b style=&quot;font-size: 9px;&quot;&gt;getMessageStore&lt;/b&gt;().&lt;b style=&quot;font-size: 9px;&quot;&gt;putMessage&lt;/b&gt;(msgInner);" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;align=left;arcSize=2;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="1241" y="3080" width="559" height="380" as="geometry" />
        </mxCell>
        <mxCell id="JrXRcp5HBTDRNXJl_5MU-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JrXRcp5HBTDRNXJl_5MU-3" target="JrXRcp5HBTDRNXJl_5MU-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JrXRcp5HBTDRNXJl_5MU-3" value="引出一个问题：&lt;br&gt;&lt;b&gt;%RETRY% 主题是怎么被消费的？&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;消费者启动时会额外订阅 &lt;b&gt;%RETRY%&lt;br&gt;+ 当前消费者分组&lt;/b&gt;的主题&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1840" y="3240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JrXRcp5HBTDRNXJl_5MU-4" value="跳转到 Consumer 流程图查看" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2080" y="3240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-1" target="h7HRPMHvCTYBDUlLkEB4-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-1" value="return &lt;b&gt;transactionalMessageBridge&lt;/b&gt;.&lt;b&gt;asyncPutHalfMessage&lt;/b&gt;(messageInner);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="1840" y="3640" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-5" target="h7HRPMHvCTYBDUlLkEB4-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-5" target="h7HRPMHvCTYBDUlLkEB4-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1700" y="1040" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-5" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;优先使用 &lt;b style=&quot;font-size: 9px;&quot;&gt;SPI&lt;/b&gt; 加载用户定义的事务相关服务，没有就初始化默认的，这里主要关注&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;TransactionalMessageServiceImpl&lt;/b&gt;&lt;/span&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;DefaultTransactionalMessageCheckListener&lt;/b&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;TransactionalMessageCheckService&lt;/b&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-8" value="BrokerController" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="805.0000000000001" y="730" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-9" target="h7HRPMHvCTYBDUlLkEB4-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-9" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;TransactionalMessageCheckService&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;是一个非守护线程，BrokerController#start() 中启动&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-11" target="h7HRPMHvCTYBDUlLkEB4-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-11" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;TransactionalMessageCheckService#run()&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-30" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-13" target="h7HRPMHvCTYBDUlLkEB4-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2420" y="1120" />
              <mxPoint x="2420" y="1080" />
              <mxPoint x="1940" y="1080" />
              <mxPoint x="1940" y="1055" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-13" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;onWaitEnd()&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;不断间隔轮询调用 TransactionalMessageService 的 &lt;b&gt;check()&lt;/b&gt; 方法&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-16" target="h7HRPMHvCTYBDUlLkEB4-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-16" value="&lt;div style=&quot;&quot;&gt;&lt;b&gt;TransactionalMessageServiceImpl&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;事务消息实现的核心类&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1010" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-17" target="h7HRPMHvCTYBDUlLkEB4-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-17" value="&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;MessageStore 和普通消息用的同一个消息存储服务&lt;br&gt;&lt;b&gt;//&amp;nbsp;parseHalfMessageInner 中将消息的topic修改为了半消息主题&lt;br&gt;&lt;/b&gt;&lt;/font&gt;return &lt;b&gt;store&lt;/b&gt;.&lt;b&gt;asyncPutMessage&lt;/b&gt;(&lt;b&gt;parseHalfMessageInner&lt;/b&gt;(messageInner));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2319.5" y="3640" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-19" value="&lt;div&gt;String uniqId = msgInner.getUserProperty(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);&lt;/div&gt;&lt;div&gt;if (uniqId != null &amp;amp;&amp;amp; !uniqId.isEmpty()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MessageAccessor.putProperty(msgInner, TransactionalMessageUtil.TRANSACTION_ID, uniqId);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 使用这两个属性保存原始主题和队列&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MessageAccessor.putProperty(msgInner, MessageConst.&lt;b&gt;PROPERTY_REAL_TOPIC&lt;/b&gt;, msgInner.getTopic());&lt;/div&gt;&lt;div&gt;MessageAccessor.putProperty(msgInner, MessageConst.&lt;b&gt;PROPERTY_REAL_QUEUE_ID&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String.valueOf(msgInner.getQueueId()));&lt;/div&gt;&lt;div&gt;msgInner.setSysFlag(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MessageSysFlag.&lt;b&gt;resetTransactionValue&lt;/b&gt;(msgInner.getSysFlag(),&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; MessageSysFlag.TRANSACTION_NOT_TYPE));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 提交到半消息主题，“RMQ_SYS_TRANS_HALF_TOPIC”，队列ID 0&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;msgInner.&lt;b&gt;setTopic&lt;/b&gt;(TransactionalMessageUtil.buildHalfTopic());&lt;/div&gt;&lt;div&gt;msgInner.&lt;b&gt;setQueueId&lt;/b&gt;(0);&lt;/div&gt;&lt;div&gt;msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));&lt;/div&gt;&lt;div&gt;return msgInner;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=3;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2800" y="3640" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-21" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;&quot;&gt;事务半消息经过确认本地事务执行成功后才能真正提交，那么半消息就需要临时保存到其他地方，&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;这里的处理方法是创建一个半消息主题（RMQ_SYS_TRANS_HALF_TOPIC&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;），将事务半消息提交到半消息主题；&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;然后客户端主动 COMMIT 或 Rollback 时，读取半消息，然后再发给原始主体并删除或直接删除；&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;另外Broker启动阶段还启动了 TransactionalMessageCheckService 这个非守护线程，间隔轮询调用&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;TransactionalMessageService#check() 方法，check 方法中会不断轮询半消息主题的消息队列回调&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;半消息生产者&amp;nbsp;TransactionListener#checkLocalTransaction(MessageExt msg) 方法，然后生产者&lt;br&gt;会再此通过 END_TRANSACTION 请求上报本地事务状态，Broker再根据结果，&lt;/b&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;读取半消息，然后再发给原始主体并删除或直接删除；&lt;/b&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;作为防止客户端&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;主动&lt;br&gt;COMMIT 或 Rollback 通信失败的&lt;/span&gt;&lt;b&gt;兜底&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2319.5" y="3705" width="470" height="170" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-22" target="h7HRPMHvCTYBDUlLkEB4-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-22" value="&lt;b&gt;EndTransactionProcessor&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;font size=&quot;1&quot;&gt;处理 RequestCode.END_TRANSACTION&amp;nbsp;(37)&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520.5" y="6080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-24" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 本地事务执行成功或失败，提交半消息到原始的主题 或 回滚半事务消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (MessageSysFlag.&lt;b&gt;TRANSACTION_COMMIT_TYPE&lt;/b&gt; == requestHeader.getCommitOrRollback()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; result = this.brokerController.getTransactionalMessageService()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;commitMessage&lt;/b&gt;(requestHeader); &lt;font color=&quot;#007fff&quot;&gt;//只是通过偏移量查询半事务消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (result.getResponseCode() == ResponseCode.SUCCESS) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (rejectCommitOrRollback(requestHeader, result.getPrepareMessage())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setCode(ResponseCode.ILLEGAL_OPERATION);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.warn(...);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand res = checkPrepareMessage(result.getPrepareMessage(), requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (res.getCode() == ResponseCode.SUCCESS) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 消息修改，比如将主体和消息队列ID改回原始主题和队列ID&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageExtBrokerInner msgInner = &lt;b&gt;endMessageTransaction&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp;result.getPrepareMessage());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requestHeader.getCommitOrRollback()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgInner.setStoreTimestamp(result.getPrepareMessage().getStoreTimestamp());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageAccessor.clearProperty(msgInner, &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageConst.PROPERTY_TRANSACTION_PREPARED);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 将消息发送到原主题&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand sendResult = &lt;b&gt;sendFinalMessage&lt;/b&gt;(msgInner);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sendResult.getCode() == ResponseCode.SUCCESS) {&lt;/div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.brokerController.getTransactionalMessageService()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;deletePrepareMessage&lt;/b&gt;(result.getPrepareMessage());&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 更新 BrokerMetricsManager 监控数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return sendResult;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return res;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 本地事务执行失败，回滚半事务消息（其实是删除）&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;else if (MessageSysFlag.&lt;b&gt;TRANSACTION_ROLLBACK_TYPE&lt;/b&gt; == requestHeader.getCommitOrRollback()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; result = this.brokerController.getTransactionalMessageService()&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;.&lt;b&gt;rollbackMessage&lt;/b&gt;(requestHeader);&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//只是通过偏移量查询半事务消息&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (result.getResponseCode() == ResponseCode.SUCCESS) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (rejectCommitOrRollback(requestHeader, result.getPrepareMessage())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setCode(ResponseCode.ILLEGAL_OPERATION);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.warn(...);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingCommand res = checkPrepareMessage(result.getPrepareMessage(), requestHeader);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (res.getCode() == ResponseCode.SUCCESS) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 删除半事务消息&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.brokerController.getTransactionalMessageService()&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;deletePrepareMessage&lt;/b&gt;(result.getPrepareMessage());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 更新 BrokerMetricsManager 监控数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return res;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="760" y="6080" width="440" height="720" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-26" target="h7HRPMHvCTYBDUlLkEB4-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-26" value="&lt;div style=&quot;&quot;&gt;TransactionalMessageServiceImpl#&lt;b&gt;check()&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;作为生产者主动 COMMIT 或 Rollback 请求的兜底操作，防止因网络原因 Broker 未收到请求&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1010" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-28" target="h7HRPMHvCTYBDUlLkEB4-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-28" value="&lt;div style=&quot;&quot;&gt;主要就是两层循环，遍历半消息主题所有消息队列中所有半消息，一一执行半消息本地事务执行状态&lt;/div&gt;&lt;div style=&quot;&quot;&gt;for (MessageQueue messageQueue : msgQueues) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; while (true) {&lt;/div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;boolean &lt;b&gt;isNeedCheck&lt;/b&gt; = opMsg == null &amp;amp;&amp;amp; valueOfCurrentMinusBorn &amp;gt; checkImmunityTime&lt;br&gt;    || opMsg != null &amp;amp;&amp;amp; opMsg.get(opMsg.size() - 1).getBornTimestamp() - startTime &amp;gt; transactionTimeout&lt;br&gt;    || valueOfCurrentMinusBorn &amp;lt;= -1;&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;if (&lt;b&gt;isNeedCheck&lt;/b&gt;) {&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; listener.&lt;b&gt;resolveHalfMsg&lt;/b&gt;(msgExt);&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;br&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="2200" y="920" width="440" height="150" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-31" target="h7HRPMHvCTYBDUlLkEB4-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-31" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;b&gt;executorService&lt;/b&gt;.execute(new Runnable() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; public void run() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;sendCheckMessage&lt;/b&gt;(msgExt);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="2680" y="935" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="h7HRPMHvCTYBDUlLkEB4-33" target="h7HRPMHvCTYBDUlLkEB4-35" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3140" y="995" />
              <mxPoint x="3140" y="1070" />
              <mxPoint x="2660" y="1070" />
              <mxPoint x="2660" y="1110" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-33" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Broker ProducerManager 中保存着与客户端的连接通道&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;Channel channel = brokerController&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;getProducerManager&lt;/b&gt;()&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;getAvailableChannel&lt;/b&gt;(groupId);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;brokerController.getBroker2Client()&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;checkProducerTransactionState&lt;/b&gt;(groupId, channel, checkTransactionStateRequestHeader, msgExt);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="2920" y="935" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="h7HRPMHvCTYBDUlLkEB4-35" value="&lt;div style=&quot;&quot;&gt;向生产者（客户端）发送请求，请求码&lt;/div&gt;&lt;div style=&quot;&quot;&gt;RequestCode.&lt;b&gt;CHECK_TRANSACTION_STATE&lt;/b&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=16;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1080" width="210" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="Te4TJPjSaJWwIWo_xXHI" name="Consumer">
    <mxGraphModel dx="4742" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="1sCiEnjxGI17WgVkHkzz-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.001;entryY=0.194;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryPerimeter=0;" parent="1" source="1sCiEnjxGI17WgVkHkzz-6" target="bPtuGuzI8SsVk5XaO2P4-11" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5780" y="1400" />
              <mxPoint x="5780" y="800" />
              <mxPoint x="2420" y="800" />
              <mxPoint x="2420" y="652" />
              <mxPoint x="2440" y="652" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="G8nSWGWCtPQHXwYgGT0W-2" value="&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;MessageRequest 来源&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1sCiEnjxGI17WgVkHkzz-8" vertex="1" connectable="0">
          <mxGeometry x="0.9662" y="-1" relative="1" as="geometry">
            <mxPoint x="49" y="99" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-43" target="bPtuGuzI8SsVk5XaO2P4-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2190" y="2120" />
              <mxPoint x="2190" y="1025" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-42" target="bPtuGuzI8SsVk5XaO2P4-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2170" y="2040" />
              <mxPoint x="2170" y="715" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="1" source="249QSjNWqVOZ7age5LvH-2" target="249QSjNWqVOZ7age5LvH-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="249QSjNWqVOZ7age5LvH-2" target="4NOqHYvpeDZbVOTjX4TA-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-2" value="&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;消费者消费消息&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;启动阶段&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;有3种消费者类型，这里分析最常用的DefaultMQPushConsumer&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="1" source="249QSjNWqVOZ7age5LvH-3" target="0WAluWUy1CVLOlXYkIWE-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="249QSjNWqVOZ7age5LvH-3" target="daRG9VKHfTEQrqkJZzFC-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-3" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;DefaultMQPushConsumer consumer = new &lt;b style=&quot;font-size: 11px;&quot;&gt;DefaultMQPushConsumer&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;CONSUMER_GROUP);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="249QSjNWqVOZ7age5LvH-4" value="&lt;b&gt;RocketMQ Consumer&lt;/b&gt;&lt;br&gt;消费者通过NameServer发现Broker节点信息&lt;br&gt;注意下面代码流程中省略了一些细节" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="0WAluWUy1CVLOlXYkIWE-1" target="0WAluWUy1CVLOlXYkIWE-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="380" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="0WAluWUy1CVLOlXYkIWE-1" target="daRG9VKHfTEQrqkJZzFC-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-1" value="consumer.&lt;b&gt;setConsumeFromWhere&lt;/b&gt;(&lt;br style=&quot;font-size: 11px;&quot;&gt;ConsumeFromWhere.&lt;br style=&quot;font-size: 11px;&quot;&gt;CONSUME_FROM_FIRST_OFFSET);&lt;br&gt;consumer.&lt;b&gt;subscribe&lt;/b&gt;(TOPIC, &quot;*&quot;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="1" source="0WAluWUy1CVLOlXYkIWE-5" target="0WAluWUy1CVLOlXYkIWE-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-5" value="consumer.registerMessageListener(&lt;br style=&quot;font-size: 11px;&quot;&gt;(MessageListenerConcurrently) (msg, context) -&amp;gt; {...}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注册消息监听器（回调）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="0WAluWUy1CVLOlXYkIWE-7" target="daRG9VKHfTEQrqkJZzFC-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0WAluWUy1CVLOlXYkIWE-7" value="consumer.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQConsumer&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends MQAdmin&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者消费失败会将消息返回给Broker，然后延迟一段时间后重试发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;sendMessageBack&lt;/b&gt;(final MessageExt msg, final int delayLevel, final String brokerName)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;throws RemotingException, MQBrokerException, InterruptedException, MQClientException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从与给定主题相关的消费者缓存中获取消息队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Set&amp;lt;MessageQueue&amp;gt; &lt;b&gt;fetchSubscribeMessageQueues&lt;/b&gt;(final String topic) throws MQClientException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="160" width="520" height="100" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="PXJ_5VzEAiNYV3dDm0dE-2" target="PXJ_5VzEAiNYV3dDm0dE-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="PXJ_5VzEAiNYV3dDm0dE-2" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQPushConsumer (I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;推送模式消费者接口定义，推送指Broker推送Consumer，还有一种Consumer拉取模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start() throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void registerMessageListener(MessageListener messageListener);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void registerMessageListener(final MessageListenerConcurrently messageListener);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void registerMessageListener(final MessageListenerOrderly messageListener);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void subscribe(final String topic, final String subExpression) throws MQClientException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void subscribe(final String topic, final MessageSelector selector) throws MQClientException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void unsubscribe(final String topic);&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void suspend();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void resume();&lt;br&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-560" y="280" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="PXJ_5VzEAiNYV3dDm0dE-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-300" y="880" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="I-aYgXq6NnChD4CNcDCU-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-300" y="880" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="I-aYgXq6NnChD4CNcDCU-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//连接的NameServer地址（IP+端口）&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者的客户端IP&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String clientIP = NetworkUtil.getLocalAddress();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端实例名，默认“DEFAULT”，“DEFAULT”&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面在启动时会被替换为 PID#当前纳秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;instanceName&lt;/b&gt; = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Deprecated&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespace;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean namespaceInitialized = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespaceV2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AccessChannel accessChannel = AccessChannel.LOCAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从命名服务拉取主题（topic）信息的间隔，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int pollNameServerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//与Broker的长连接的心跳周期，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int heartbeatBrokerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Offset persistent interval for consumer&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int persistConsumerOffsetInterval = 1000 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String unitName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeReadBody = Boolean.parseBoolean(System.getProperty(DECODE_READ_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeDecompressBody = Boolean.parseBoolean(System.getProperty(DECODE_DECOMPRESS_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean vipChannelEnabled = Boolean.parseBoolean(System.getProperty(SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useHeartbeatV2 = Boolean.parseBoolean(System.getProperty(HEART_BEAT_V2, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useTLS = TlsSystemConfig.tlsEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String socksProxyConfig = System.getProperty(SOCKS_PROXY_CONFIG, &quot;{}&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int mqClientApiTimeout = 3 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectTimeout = 200;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectInterval = 2 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LanguageCode language = LanguageCode.JAVA;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable stream request type will inject a RPCHook to add corresponding request type to remoting layer.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * And it will also generate a different client id to prevent unexpected reuses of MQClientInstance.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean enableStreamRequestType = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable the fault tolerance mechanism of the client sending process.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * DO NOT OPEN when ORDER messages are required.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Turning on will interfere with the queue selection functionality,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * possibly conflicting with the order message.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean sendLatencyEnable = Boolean.parseBoolean(System.getProperty(SEND_LATENCY_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean startDetectorEnable = Boolean.parseBoolean(System.getProperty(START_DETECTOR_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean enableHeartbeatChannelEventListener = true;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="160" width="520" height="680" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.038;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="FLcnCGNqTxovisvCWYwo-3" target="daRG9VKHfTEQrqkJZzFC-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="FLcnCGNqTxovisvCWYwo-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;DefaultMQPushConsumer&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这里的大多数功能都委托给了它。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;protected final transient DefaultMQPushConsumerImpl &lt;b&gt;defaultMQPushConsumerImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 相同角色的消费者必须具有完全相同的订阅和消费组才能正确实现负载均衡。这是必需的，并且需要全局唯一。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;consumerGroup&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消息模型定义了消息传递到每个消费者客户端的方式。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// RocketMQ 支持两种消息模型：&lt;b&gt;集群&lt;/b&gt;和&lt;b&gt;广播&lt;/b&gt;。如果设置为集群，具有相同 {@link #consumerGroup} 的消费者客户端&lt;b&gt;只会消费订阅消息的部分（即一个消息不会被）&lt;/b&gt;，这实现了负载均衡；相反，如果设置为广播，每个消费者客户端将分别消费所有订阅的消息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此字段默认为集群。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageModel &lt;b&gt;messageModel&lt;/b&gt; = MessageModel.CLUSTERING;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消费者启动时的消费点。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 有三种消费点：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_LAST_OFFSET：消费者客户端从上次停止的地方继续。如果这是一个新启动的消费者客户端，根据消费组的老化情况，有两种情况：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; 如果消费组创建得如此之近，以至于最早订阅的消息尚未过期，这意味着消费组代表最近启动的业务，消费将从头开始；&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; 如果最早订阅的消息已过期，消费将从最新消息开始，这意味着在启动时间戳之前生成的消息将被忽略。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_FIRST_OFFSET：消费者客户端将从最早的可用消息开始。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// CONSUME_FROM_TIMESTAMP：消费者客户端将从指定的时间戳开始，这意味着在 {@link #consumeTimestamp} 之前生成的消息将被忽略。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private ConsumeFromWhere &lt;b&gt;consumeFromWhere&lt;/b&gt; = ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 精确到秒的回溯消费时间。时间格式为 20131223171201&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 意味着2013年12月23日17点12分01秒&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认回溯消费时间为半小时前&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b&gt;consumeTimestamp&lt;/b&gt; = UtilAll.timeMillisToHumanString3(System.currentTimeMillis() - (1000 * 60 * 30));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 指定消息队列如何分配给每个消费者客户端的队列分配算法。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private AllocateMessageQueueStrategy &lt;b&gt;allocateMessageQueueStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 订阅关系。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private Map&amp;lt;String /* topic */, String /* sub expression */&amp;gt; &lt;b&gt;subscription&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 消息监听器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageListener &lt;b&gt;messageListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 如果消息队列分配更改，则调用的侦听器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private MessageQueueListener &lt;b&gt;messageQueueListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 消费偏移量（消费位点）存储&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private OffsetStore &lt;b&gt;offsetStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 最小消费者线程数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeThreadMin&lt;/b&gt; = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 最大消费者线程数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeThreadMax&lt;/b&gt; = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 动态调整线程池数量的阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long &lt;b&gt;adjustThreadPoolNumsThreshold&lt;/b&gt; = 100000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 同时最大跨度偏移量。它对顺序消费没有影响&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;consumeConcurrentlyMaxSpan&lt;/b&gt; = 2000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 队列级别流量控制阈值，默认情况下，每个消息队列最多缓存1000条消息，考虑 {@code pullBatchSize}，瞬时值可能超过限制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdForQueue&lt;/b&gt; = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 队列级别流量控制阈值，意味着等待确认确认的最大消息数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 与拉取阈值相反，一旦消息被弹出，它就被视为消费的开始。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;popThresholdForQueue&lt;/b&gt; = 96;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制队列级别上缓存的消息大小，默认情况下，每个消息队列最多缓存100 MiB消息，考虑 {@code pullBatchSize}，瞬时值可能超过限制。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdSizeForQueue&lt;/b&gt; = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主题级别流量控制阈值，默认值为-1（无限制）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// {@code pullThresholdForQueue} 的值将被重写，并基于 {@code pullThresholdForTopic} 计算，如果它不是无限的。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 例如，如果 pullThresholdForTopic 的值为1000，并且有10个消息队列分配给此消费者，则 pullThresholdForQueue 将设置为100。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;private int &lt;b&gt;pullThresholdForTopic&lt;/b&gt; = -1;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主题级别限制缓存的消息大小，默认值为-1 MiB（无限制）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// {@code pullThresholdSizeForQueue} 的值将被重写，并基于 {@code pullThresholdSizeForTopic} 计算，如果它不是无限的。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 例如，如果 pullThresholdSizeForTopic 的值为1000 MiB，并且有10个消息队列分配给此消费者，则 pullThresholdSizeForQueue 将设置为100 MiB。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b&gt;pullThresholdSizeForTopic&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息拉取间隔。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long pullInterval = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量消费大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int consumeMessageBatchMaxSize = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量拉取大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int pullBatchSize = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量拉取字节大小。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int pullBatchSizeInBytes = 256 * 1024;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 是否在每次拉取时更新订阅关系。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean postSubscriptionWhenPull = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 是否是订阅组的单位。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 最大重新消费次数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 在并发模式下，-1表示16；&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 在有序模式下，-1表示Integer.MAX_VALUE。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 如果消息在成功之前重新消费超过 {@link #maxReconsumeTimes} 次。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int maxReconsumeTimes = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 需要慢拉取的情况（如流量控制场景）的暂停拉取时间。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long suspendCurrentQueueTimeMillis = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息阻塞消费线程的最大时间（分钟）。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long consumeTimeout = 15;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 消息的最大不可见时间（毫秒），范围是 [5000, 300000]。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long popInvisibleTime = 60000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 批量弹出大小，范围是 [1, 32]。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int popBatchNums = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 关闭消费者时等待消息消费的最大时间，0表示不等待。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long awaitTerminationMillisWhenShutdown = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 异步传输数据的接口。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private TraceDispatcher traceDispatcher = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;// 强制使用客户端负载均衡。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean clientRebalance = true;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="880" width="520" height="1200" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-1" target="daRG9VKHfTEQrqkJZzFC-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-1" value="&lt;div style=&quot;&quot;&gt;this(consumerGroup, null, new &lt;b&gt;AllocateMessageQueueAveragely&lt;/b&gt;());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;消息队列分配算法，todo&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-3" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;this.&lt;b&gt;consumerGroup&lt;/b&gt; = consumerGroup;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;allocateMessageQueueStrategy&lt;/b&gt; = allocateMessageQueueStrategy;&lt;/div&gt;&lt;div&gt;defaultMQPushConsumerImpl = new &lt;b&gt;DefaultMQPushConsumerImpl&lt;/b&gt;(this, rpcHook);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;DefaultMQPushConsumerImpl才是实际的消费者实例&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="240" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.56;exitDx=0;exitDy=0;exitPerimeter=0;endArrow=open;endFill=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="daRG9VKHfTEQrqkJZzFC-33" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1690" y="1238" />
              <mxPoint x="-1690" y="1100" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.281;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="daRG9VKHfTEQrqkJZzFC-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1700" y="1060" />
              <mxPoint x="-1700" y="920" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.58;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="i4JN70CcAHU7UOiHbAm4-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1710" y="1251" />
              <mxPoint x="-1710" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.601;exitDx=0;exitDy=0;exitPerimeter=0;endArrow=open;endFill=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-5" target="i4JN70CcAHU7UOiHbAm4-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1690" y="1265" />
              <mxPoint x="-1690" y="1620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQPushConsumerImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Flow control interval when message cache is full&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_CACHE_FLOW_CONTROL = 50;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//Flow control interval when broker return flow control&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_BROKER_FLOW_CONTROL = 20;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//Delay some time when suspend pull service&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final long PULL_TIME_DELAY_MILLS_WHEN_SUSPEND = 1000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long BROKER_SUSPEND_MAX_TIME_MILLIS = 1000 * 15;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//所属&amp;nbsp;DefaultMQPushConsumer&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumer &lt;b&gt;defaultMQPushConsumer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceImpl &lt;b&gt;rebalanceImpl&lt;/b&gt; = new RebalancePushImpl(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;FilterMessageHook&amp;gt; filterMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long consumerStartTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;ConsumeMessageHook&amp;gt; consumeMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile ServiceState &lt;b&gt;serviceState&lt;/b&gt; = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//MQ客户端实例（Netty客户端），消费者实例 DefaultMQPushConsumerImpl&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp;和 MQClientInstance 多对一&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQClientInstance &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private PullAPIWrapper pullAPIWrapper;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean pause = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean consumeOrderly = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;用户定义的消息监听器（实现消费逻辑）&lt;/b&gt;，和 DefaultMQPushConsumer 的 messageListener 是同一个对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MessageListener &lt;b&gt;messageListenerInner&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//消费偏移量记录&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private OffsetStore &lt;b&gt;offsetStore&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsumeMessageService &lt;b&gt;consumeMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsumeMessageService &lt;b&gt;consumeMessagePopService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long queueFlowControlTimes = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long queueMaxSpanFlowControlTimes = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int[] popDelayLevel = new int[] {10, 30, 60, 120, 180, 240, 300, 360, 420, 480, 540, 600, 1200, 1800, 3600, 7200};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MAX_POP_INVISIBLE_TIME = 300000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MIN_POP_INVISIBLE_TIME = 5000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int ASYNC_TIMEOUT = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// only for test purpose, will be modified by reflection in unit test.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@SuppressWarnings(&quot;FieldMayBeFinal&quot;)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static boolean doNotUpdateTopicSubscribeInfoWhenSubscriptionChanged = false;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="880" width="520" height="640" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-6" value="&lt;div&gt;SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(topic, subExpression);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//记录对主题订阅的详细信息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;（比如主题名、匹配方式[TAG | SQL92]、匹配字段集合）&lt;/font&gt;&lt;div&gt;this.&lt;b&gt;rebalanceImpl&lt;/b&gt;.&lt;b&gt;getSubscriptionInner&lt;/b&gt;().put(topic, subscriptionData);&lt;/div&gt;&lt;div&gt;if (this.mQClientFactory != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.mQClientFactory.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=7;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="320" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-8" target="daRG9VKHfTEQrqkJZzFC-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RebalancePushImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="880" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RebalanceImpl&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;每个消费者都有一个重新负载实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MessageQueue 用于存储从 Broker 读取的消息，消息处理器前会放到与其对应的 ProcessQueue，由消息消费者线程从 ProcessQueue 中取出消息进行处理&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;MessageQueue, ProcessQueue&amp;gt; &lt;b&gt;processQueueTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;MessageQueue, PopProcessQueue&amp;gt; &lt;b&gt;popProcessQueueTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//topic -&amp;gt; Set&amp;lt;MessageQueue&amp;gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;String/* topic */, Set&amp;lt;&lt;b&gt;MessageQueue&lt;/b&gt;&amp;gt;&amp;gt; &lt;b&gt;topicSubscribeInfoTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录某个消费者订阅主题的详细信息（比如匹配表达式及表达式类型（TAG、SQL92）等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;String /* topic */, &lt;b&gt;SubscriptionData&lt;/b&gt;&amp;gt; &lt;b&gt;subscriptionInner&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String consumerGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//两种模式：集群和广播&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MessageModel messageModel;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AllocateMessageQueueStrategy &lt;b&gt;allocateMessageQueueStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected MQClientInstance &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int TIMEOUT_CHECK_TIMES = 3;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int QUERY_ASSIGNMENT_TIMEOUT = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; topicBrokerRebalance = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; topicClientRebalance = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="480" width="520" height="360" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-11" target="daRG9VKHfTEQrqkJZzFC-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-11" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;setConsumerGroup&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;NamespaceUtil.wrapNamespace(&lt;br style=&quot;font-size: 10px;&quot;&gt;this.getNamespace(),&lt;br style=&quot;font-size: 10px;&quot;&gt;this.consumerGroup));&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;设置消费者组，加上命名空间如果有的话&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-13" target="daRG9VKHfTEQrqkJZzFC-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-13" value="this.&lt;b&gt;defaultMQPushConsumerImpl&lt;/b&gt;&lt;br&gt;.&lt;b&gt;start&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="710" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="daRG9VKHfTEQrqkJZzFC-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-28" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="daRG9VKHfTEQrqkJZzFC-27" vertex="1" connectable="0">
          <mxGeometry x="0.0058" y="-3" relative="1" as="geometry">
            <mxPoint x="5" y="-95" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="4NOqHYvpeDZbVOTjX4TA-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="740" />
              <mxPoint x="1460" y="1959" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-10" value="5" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4NOqHYvpeDZbVOTjX4TA-9" vertex="1" connectable="0">
          <mxGeometry x="0.9362" y="-3" relative="1" as="geometry">
            <mxPoint x="13" y="21" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="i4JN70CcAHU7UOiHbAm4-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-3" value="0" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="i4JN70CcAHU7UOiHbAm4-2" vertex="1" connectable="0">
          <mxGeometry x="0.9198" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="i4JN70CcAHU7UOiHbAm4-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-8" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="i4JN70CcAHU7UOiHbAm4-7" vertex="1" connectable="0">
          <mxGeometry x="0.7478" y="-3" relative="1" as="geometry">
            <mxPoint x="13" y="32" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ink1OJaSQJaR3CQkYgyS-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-15" target="ink1OJaSQJaR3CQkYgyS-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-15" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.serviceState = ServiceState.START_FAILED;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//检查一堆配置参数是否设置有误&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.checkConfig();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;//0 从 DefaultMQPushConsumer 拷贝主题订阅信息到 DefaultMQPushConsumerImpl 实例&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;以及注册一个重试主题到 DefaultMQPushConsumerImpl 实例&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;copySubscription&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //重新命名当前消费者实例名称， DEFAULT -&amp;gt; PID#System.nanoTime(), 比如&quot;155762#69266371992577&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.changeInstanceNameToPID();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 从 MQClientManager.factoryTable 获取或者创建 MQClientInstance，&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//&amp;nbsp; &amp;nbsp;这里只是创建像内部的Netty客户端还没有启动&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;mQClientFactory&lt;/b&gt; = MQClientManager.getInstance().&lt;b&gt;getOrCreateMQClientInstance&lt;/b&gt;(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer, this.rpcHook);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//继续从 DefaultMQPushConsumer 拷贝一些数据到 DefaultMQPushConsumerImpl.rebalanceImpl&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setAllocateMessageQueueStrategy(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.pullAPIWrapper == null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.pullAPIWrapper = new PullAPIWrapper(&lt;span style=&quot;background-color: initial;&quot;&gt;mQClientFactory,&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;//2 创建消费偏移量记录实例，广播模式和集群模式使用不同的记录方式&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;集群模式消费进度存储在Broker、广播模式存储进度存储在消费者端&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.defaultMQPushConsumer.getOffsetStore() != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; switch (this.defaultMQPushConsumer.getMessageModel()) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case BROADCASTING: &lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;本地存储进度&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.offsetStore = new &lt;b&gt;LocalFileOffsetStore&lt;/b&gt;(this.mQClientFactory, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b&gt;CLUSTERING&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;远程存储进度(先保存在本地 offsetTable, 然后定期持久化到Broker&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;)&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.offsetStore = new &lt;b&gt;RemoteBrokerOffsetStore&lt;/b&gt;(this.mQClientFactory, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.offsetStore.&lt;b&gt;load&lt;/b&gt;(); &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//RemoteBrokerOffsetStore此方法为空&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//这个内部消息监听器就是用自定义的消息消费监听器&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (this.&lt;b&gt;getMessageListenerInner&lt;/b&gt;() instanceof &lt;b&gt;MessageListenerOrderly&lt;/b&gt;) { &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//&lt;b&gt;顺序消费&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //会创建顺序消费线程 &lt;b&gt;ConsumeMessageOrderlyService&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; ... //暂时没用到这个类型，暂略&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} else if (this.getMessageListenerInner() instanceof &lt;b&gt;MessageListenerConcurrently&lt;/b&gt;) { &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//&lt;b&gt;异步消费&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeOrderly = false;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;consumeMessageService&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ConsumeMessageConcurrentlyService&lt;/b&gt;(this,&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;(MessageListenerConcurrently) this.getMessageListenerInner());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeMessagePopService =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ConsumeMessagePopConcurrentlyService&lt;/b&gt;(this,&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;(MessageListenerConcurrently) this.getMessageListenerInner());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 启动消息消费相关服务，即上面的 ConsumeMessageConcurrentlyService ConsumeMessagePopConcurrentlyService&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;consumeMessageService&lt;/b&gt;.start();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.&lt;b&gt;consumeMessagePopService&lt;/b&gt;.start();&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 向MQ客户端实例中注册当前消费者，一个业务服务可能有多个客户端实例，一个客户端实例（MQClientInstance）中可能注册多个消费者（consumerTable）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;boolean registerOK = mQClientFactory.&lt;b&gt;registerConsumer&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;this.defaultMQPushConsumer.getConsumerGroup(), this);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;if (!registerOK) {&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //注册失败&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.CREATE_JUST;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.consumeMessageService.shutdown(defaultMQPushConsumer&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getAwaitTerminationMillisWhenShutdown());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; throw new MQClientException(...);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//5 启动MQ客户端实例（主要就是启动内部的Netty客户端、定时任务、消息推送服务、负载均衡服务）&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;mQClientFactory.&lt;b&gt;start&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.serviceState = ServiceState.&lt;b&gt;RUNNING&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;break;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="320" width="440" height="840" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-17" target="daRG9VKHfTEQrqkJZzFC-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-20" value="CREATE_JUST" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="daRG9VKHfTEQrqkJZzFC-19" vertex="1" connectable="0">
          <mxGeometry x="-0.1" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-17" target="daRG9VKHfTEQrqkJZzFC-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-17" value="serviceState" style="rhombus;whiteSpace=wrap;html=1;fontSize=11;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="760" y="710" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="daRG9VKHfTEQrqkJZzFC-21" target="BSc7MQy5KmO-H20q9Lak-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="BSc7MQy5KmO-H20q9Lak-2" vertex="1" connectable="0">
          <mxGeometry x="0.6711" y="2" relative="1" as="geometry">
            <mxPoint x="-3" y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XxbNxbS5GUrKA4K-fgnr-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-21" target="XxbNxbS5GUrKA4K-fgnr-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="980" y="2269" />
              <mxPoint x="980" y="2460" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="XxbNxbS5GUrKA4K-fgnr-8" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="XxbNxbS5GUrKA4K-fgnr-3" vertex="1" connectable="0">
          <mxGeometry x="0.8288" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-21" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 执行一次主题订阅信息更新&lt;/b&gt;：遍历当前消费者实例所有订阅关系中所有主题Topic，从Namesrv更新主题的路由信息&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.updateTopicSubscribeInfoWhenSubscriptionChanged();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 检查Broker中的客户端，从源码实现看就是找到包含此客户端实例所有消费者订阅主题消息的Broker地址（确保存在）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.mQClientFactory.checkClientInBroker();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 发送心跳成功就立即执行一次再均衡&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //立即唤醒 RebalanceService&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.mQClientFactory.&lt;b&gt;rebalanceImmediately&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}}&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="680" y="2190" width="280" height="160" as="geometry" />
        </mxCell>
        <mxCell id="BEhAUxJ9NpTtALDGA_Yr-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-23" target="daRG9VKHfTEQrqkJZzFC-24" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1130" y="1860" />
              <mxPoint x="-1130" y="2240" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-23" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientManager&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance ProduceAccumulator 的容器，单例模式&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger factoryIndexGenerator = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端容器的Map clientId （节点IP@进程ID#客户端创建nanoTime）-&amp;gt; MQClientInstance&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;一个业务服务实例可能有多个客户端实例&lt;/b&gt;(clientId只是创建时间不同）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1760" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="XxbNxbS5GUrKA4K-fgnr-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;endArrow=open;endFill=0;exitX=-0.003;exitY=0.361;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-24" target="XxbNxbS5GUrKA4K-fgnr-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1680" y="2080" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="-1710" y="2092" />
              <mxPoint x="-1710" y="1860" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="OHT3zQG8ArBcro6t0c-W-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.002;exitY=0.208;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-24" target="daRG9VKHfTEQrqkJZzFC-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1690" y="1951" />
              <mxPoint x="-1690" y="1640" />
              <mxPoint x="-1420" y="1640" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;最核心的类&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQ客户端实例，这个实例既可能作为生产者也可能作为消费者还可能都是&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final static long LOCK_TIMEOUT_MILLIS = 3000;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;// 客户端配置&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientConfig clientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 客户端ID（格式：&lt;b&gt;当前节点IP@实例名instanceName&lt;/b&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;clientId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 启动时间戳&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long bootTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 当前客户端的生产者容器，consumeGroup -&amp;gt; MQProducerInner&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQProducerInner&amp;gt; &lt;b&gt;producerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 当前客户端的消费者容器，consumeGroup -&amp;gt; DefaultMQPushConsumerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQConsumerInner&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;consumerTable&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前客户端的adminExt容器，键是adminExt组的名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQAdminExtInner&amp;gt; adminExtTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Netty客户端配置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// MQ客户端API实现，本质是Netty客户端，每个客户端实例一个Netty客户端实例名&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQClientAPIImpl &lt;b&gt;mQClientAPIImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// MQ管理器实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQAdminImpl &lt;b&gt;mQAdminImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 主题路由数据表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, &lt;b&gt;TopicRouteData&lt;/b&gt;&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主题终端点表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Topic */, ConcurrentMap&amp;lt;MessageQueue, String /*brokerName*/&amp;gt;&amp;gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//防止并发同时执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final Lock lockNamesrv = new ReentrantLock();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockHeartbeat = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 存储代理集群信息的容器。映射的键是代理集群名称。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 值是属于代理集群的代理实例列表。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 对于子映射，键是单个代理实例的ID，值是地址。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 代理版本表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* Broker Name */, HashMap&amp;lt;String /* address */, Integer&amp;gt;&amp;gt; brokerVersionTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 支持v2心跳的代理集合&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String /* Broker address */&amp;gt; brokerSupportV2HeartbeatSet = new HashSet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 代理地址心跳指纹表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Integer&amp;gt; brokerAddrHeartbeatFingerprintTable = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 定时任务线程池，启动时向这个线程池提交了5个定时任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = Executors.newSingleThreadScheduledExecutor(r -&amp;gt; new Thread(r, &quot;MQClientFactoryScheduledThread&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 拉取远程配置执行服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService fetchRemoteConfigExecutorService = Executors.newSingleThreadScheduledExecutor(new ThreadFactory() {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; @Override&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; public Thread newThread(Runnable r) {&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new Thread(r, &quot;MQClientFactoryFetchRemoteConfigScheduledThread&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;});&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 拉消息服务&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;PullMessageService&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;pullMessageService&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 重新平衡服务&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceService &lt;b&gt;rebalanceService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 默认的消息生产者。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer defaultMQProducer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 消费者统计管理器。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConsumerStatsManager consumerStatsManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 发送心跳总次数。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 服务状态。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// 随机数生成器。&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="-1680" y="1760" width="520" height="920" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-25" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProduceAccumulator&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance ProduceAccumulator 的容器，单例模式&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger factoryIndexGenerator = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String/* clientId */, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="3040" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="daRG9VKHfTEQrqkJZzFC-26" target="daRG9VKHfTEQrqkJZzFC-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-26" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;instance = new &lt;b style=&quot;font-size: 10px;&quot;&gt;MQClientInstance&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;clientConfig.cloneClientConfig(),&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;this&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;.factoryIndexGenerator.getAndIncrement(),&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;clientId, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="daRG9VKHfTEQrqkJZzFC-29" target="daRG9VKHfTEQrqkJZzFC-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XdBi3h5rr53AErXNQe9W-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="daRG9VKHfTEQrqkJZzFC-32" vertex="1" connectable="0">
          <mxGeometry x="0.8364" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-29" target="bPtuGuzI8SsVk5XaO2P4-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="daRG9VKHfTEQrqkJZzFC-29" target="bPtuGuzI8SsVk5XaO2P4-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-29" value="ClientRemotingProcessor clientRemotingProcessor = new&amp;nbsp;ClientRemotingProcessor(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//监听 Netty onChannelActive 用于发送心跳给Broker， todo&lt;/font&gt;&lt;br&gt;channelEventListener = new ChannelEventListener() {...}&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 封装的Netty客户端（NettyRemotingClient）&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt; = new &lt;b&gt;MQClientAPIImpl&lt;/b&gt;(this.nettyClientConfig,&amp;nbsp; &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; clientRemotingProcessor, rpcHook, clientConfig, channelEventListener);&lt;br&gt;this.mQClientAPIImpl.updateNameServerAddressList(this.clientConfig.getNamesrvAddr());&lt;br&gt;&lt;div&gt;this.clientId = clientId;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 MQ管理接口，也是借助Netty客户端实现，与Broker Namesrv通信&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;mQAdminImpl&lt;/b&gt; = new MQAdminImpl(this);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 主动拉取消息的服务&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;pullMessageService&lt;/b&gt; = new PullMessageService(this);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 负载均衡服务&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;rebalanceService&lt;/b&gt; = new RebalanceService(this);&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//测试服务只是消费消息&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;为何默认创建一个生产者？为了消费失败后重新发回Broker之后重试消费&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;this.&lt;b&gt;defaultMQProducer&lt;/b&gt; = new &lt;b&gt;DefaultMQProducer&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; MixAll.CLIENT_INNER_PRODUCER_GROUP);&lt;/div&gt;&lt;div&gt;this.defaultMQProducer.resetClientConfig(clientConfig);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;consumerStatsManager&lt;/b&gt; = new ConsumerStatsManager(this.scheduledExecutorService);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1720" y="520" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-31" value="this.remotingClient = new &lt;b style=&quot;font-size: 10px;&quot;&gt;NettyRemotingClient&lt;/b&gt;(nettyClientConfig, &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; channelEventListener);&lt;br&gt;this.clientRemotingProcessor = clientRemotingProcessor;&lt;br&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;this.remotingClient.registerRPCHook(new NamespaceRpcHook(clientConfig));&lt;br&gt;this.remotingClient.registerRPCHook(rpcHook);&lt;br&gt;&lt;div&gt;this.remotingClient.registerRPCHook(new DynamicalExtFieldRPCHook());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//其实就是注册一组请求码的 Netty ChannelHandler，这里都是 &lt;b&gt;ClientRemotingProcessor&lt;/b&gt; 处理的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.CHECK_TRANSACTION_STATE, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.NOTIFY_CONSUMER_IDS_CHANGED, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.RESET_CONSUMER_CLIENT_OFFSET, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_STATUS_FROM_CLIENT, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_RUNNING_INFO, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.&lt;b&gt;CONSUME_MESSAGE_DIRECTLY&lt;/b&gt;, this.clientRemotingProcessor, null);&lt;/div&gt;&lt;div&gt;this.remotingClient.registerProcessor(RequestCode.&lt;b&gt;PUSH_REPLY_MESSAGE_TO_CLIENT&lt;/b&gt;, this.clientRemotingProcessor, null);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2200" y="320" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="daRG9VKHfTEQrqkJZzFC-33" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RemoteBrokerOffsetStore&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;集群消息模式使用的消费偏移量记录，集群模式是所有匹配的消费者分摊消息进行消费&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属MQClientInstance&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MQClientInstance &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;groupName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;MessageQueue, ControllableOffset&amp;gt; offsetTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1000" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-2" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;DefaultMQPushConsumer 和&amp;nbsp;DefaultMQPushConsumerImpl &lt;br&gt;之间有很多冗余的字段（相同的字段及值）&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-290" y="820" width="290" height="40" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-3" target="4NOqHYvpeDZbVOTjX4TA-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-3" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;消费者Netty处理器&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-5" value="&lt;font style=&quot;&quot;&gt;ClientRemotingProcessor&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="4NOqHYvpeDZbVOTjX4TA-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-13" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4NOqHYvpeDZbVOTjX4TA-12" vertex="1" connectable="0">
          <mxGeometry x="0.8454" y="-1" relative="1" as="geometry">
            <mxPoint y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="bPtuGuzI8SsVk5XaO2P4-42" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1880" y="2089.04347826087" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-16" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4NOqHYvpeDZbVOTjX4TA-15" vertex="1" connectable="0">
          <mxGeometry x="0.8776" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-8" target="bPtuGuzI8SsVk5XaO2P4-43" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1880" y="2269" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-25" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4NOqHYvpeDZbVOTjX4TA-24" vertex="1" connectable="0">
          <mxGeometry x="0.9269" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-8" value="&lt;div&gt;synchronized (this) { &lt;font color=&quot;#007fff&quot;&gt;//防止重复启动&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; switch (this.serviceState) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case CREATE_JUST:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.&lt;b&gt;START_FAILED&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == this.clientConfig.getNamesrvAddr()) {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.mQClientAPIImpl.fetchNameServerAddr();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //1 启动NettyRemotingClient客户端&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //2 启动计划任务（5个）&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;startScheduledTask&lt;/b&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //3 启动消息拉取服务（主动拉模式），这是一个线程&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;pullMessageService&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //4 启动负载均衡服务，这是一个线程&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;rebalanceService&lt;/b&gt;.&lt;b&gt;start&lt;/b&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//5 启动前面创建的重试生产者, 流程参考生产者流程图&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQProducer.&lt;b&gt;getDefaultMQProducerImpl&lt;/b&gt;().&lt;b&gt;start&lt;/b&gt;(false);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.serviceState = ServiceState.&lt;b&gt;RUNNING&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case START_FAILED:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new MQClientException(...));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1799" width="360" height="320" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-11" target="bPtuGuzI8SsVk5XaO2P4-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-55" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="bPtuGuzI8SsVk5XaO2P4-54" vertex="1" connectable="0">
          <mxGeometry x="0.732" y="-1" relative="1" as="geometry">
            <mxPoint x="-5" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KbjGYLnwEtNko80yWfFh-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" parent="1" source="4NOqHYvpeDZbVOTjX4TA-11" target="BSc7MQy5KmO-H20q9Lak-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2320" y="1824.521739130435" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2300" y="1847" />
              <mxPoint x="2300" y="2160" />
              <mxPoint x="1220" y="2160" />
              <mxPoint x="1220" y="2220" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KbjGYLnwEtNko80yWfFh-3" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="KbjGYLnwEtNko80yWfFh-2" vertex="1" connectable="0">
          <mxGeometry x="0.5545" y="-1" relative="1" as="geometry">
            <mxPoint x="828" y="-309" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-11" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;向MQClientInstance.&lt;b&gt;scheduledExecutorService&lt;/b&gt;提交了5个定时任务：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&amp;nbsp;&lt;b&gt;更新命名服务的地址信息&lt;/b&gt;，每2分钟执行一次&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.mQClientAPIImpl.&lt;b&gt;fetchNameServerAddr&lt;/b&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&amp;nbsp;&lt;b&gt;从命名服务更新主题路由信息&lt;/b&gt;，每 ClientConfig.&lt;span style=&quot;background-color: initial;&quot;&gt;pollNameServerInterval ms执行一次&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;();&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//3&amp;nbsp;&lt;b&gt;清理掉线的Broker已经向所有Broker发送心跳&lt;/b&gt;，每 ClientConfig.heartbeatBrokerInterval ms执行一次&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;cleanOfflineBroker&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//4 这里会向所有包含当前消费者主题的Broker中注册当前客户端消费者和生产者信息&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;5&amp;nbsp;持久化所有消费者消费偏移量&lt;/b&gt;，每 ClientConfig.persistConsumerOffsetInterval ms执行一次&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;MQClientInstance.this.&lt;b&gt;persistAllConsumerOffset&lt;/b&gt;();&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;/&lt;b&gt;/调整线程池？&lt;/b&gt;每分钟执行一次&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;MQClientInstance.this.&lt;b&gt;adjustThreadPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1880" y="1799" width="400" height="191" as="geometry" />
        </mxCell>
        <mxCell id="4NOqHYvpeDZbVOTjX4TA-23" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1605" y="1769" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="BSc7MQy5KmO-H20q9Lak-1" target="BSc7MQy5KmO-H20q9Lak-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;this.mQClientFactory&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;topic);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;获取当前客户端所有消费者和生产者的主题，然后向NameServer 发送请求，获取这些主题的 TopicRouteData 信息（brokerName -&amp;gt; [topic、totalQueues等]）&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=12;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2220" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="BSc7MQy5KmO-H20q9Lak-5" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通过 NettyRemotingClient 向 Namesrv 发送 &lt;b&gt;GET_ROUTEINFO_BY_TOPIC&lt;/b&gt; 请求&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;topicRouteData&lt;/b&gt; = this.mQClientAPIImpl.&lt;b&gt;getTopicRouteInfoFromNameServer&lt;/b&gt;(topic, &lt;br&gt;&amp;nbsp; &amp;nbsp; clientConfig.getMqClientApiTimeout());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//和旧值进行比较，看是否有变化，有则更新&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;brokerAddrTable&lt;/b&gt;.put(bd.getBrokerName(), bd.getBrokerAddrs());&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;topicEndPointsTable&lt;/b&gt;.put(topic, mqEndPoints);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//impl是producerTable中的MQProducerInner实例，&lt;b&gt;更新主题对应的 TopicPublishInfo&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;impl&lt;/b&gt;.&lt;b&gt;updateTopicPublishInfo&lt;/b&gt;(topic, publishInfo);&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//impl是consumerTable中的MQConsumerInner实例，更新内部 rebalanceImpl.&lt;b&gt;topicSubscribeInfoTable, &lt;/b&gt;即&lt;b&gt;更新主题对应的 MessageQueue 集合&lt;br&gt;根据 TopicRouteData 中 queueDatas 创建 readQueueNums 个 MessageQueue&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;impl&lt;/b&gt;.&lt;b&gt;updateTopicSubscribeInfo&lt;/b&gt;(topic, subscribeInfo);&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//更新主题对应的 TopicRouteData 信息&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.&lt;b&gt;topicRouteTable&lt;/b&gt;.put(topic, cloneTopicRouteData);&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=6;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="2170" width="439" height="200" as="geometry" />
        </mxCell>
        <mxCell id="XxbNxbS5GUrKA4K-fgnr-1" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;for (SubscriptionData subscriptionData : subscriptionInner) {&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;if (ExpressionType.&lt;b&gt;isTagType&lt;/b&gt;(subscriptionData.getExpressionType())) &lt;font color=&quot;#007fff&quot;&gt;//只是针对非 TAG 表达式&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;continue;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //检查客户端实例 &lt;b&gt;topicRouteTable&lt;/b&gt; 字段（CHM），查看主题对应的BrokerData信息&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //BrokerData信息不为空就随机获取一个BrokerData的地址信息&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; String addr = &lt;b&gt;findBrokerAddrByTopic&lt;/b&gt;(subscriptionData.getTopic());&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; //通过NettyRemotingClient 向 &lt;b&gt;Broker&lt;/b&gt; 发送&amp;nbsp;&lt;/span&gt;&lt;b&gt;CHECK_CLIENT_CONFIG&lt;/b&gt; 同步请求并检查响应码&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.getMQClientAPIImpl().&lt;b&gt;checkClientInBroker&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;addr, entry.getKey(), this.clientId,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscriptionData, clientConfig.getMqClientApiTimeout()&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2390" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="XxbNxbS5GUrKA4K-fgnr-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TopicRouteData&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;主题路由信息&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String orderTopicConf;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即主题消息存储的消息队列信息（位于的Broker名、读写索引[readQueueNums、writeQueueNums]、perm等&lt;span style=&quot;background-color: initial;&quot;&gt;）&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;QueueData&amp;gt; &lt;b&gt;queueDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//即queueDatas中Broker的信息（所属集群名、Broker名、broker实例地址[这里看到可能有多个]等）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;BrokerData&amp;gt; &lt;b&gt;brokerDatas&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HashMap&amp;lt;String/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可能为空，todo&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt; topicQueueMappingByBroker;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1760" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="X9grzAPewyNBlL88Efqx-1" value="&lt;font style=&quot;&quot;&gt;这里需要弄明白的几个问题：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;ul style=&quot;&quot;&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;消费者和Broker之间是怎么发现彼此的？&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;消费者是通过NameServer查询到消费者消费主题相关的Broker路由信息的，之后消费者会向这些Broker发送心跳，Broker会记录这些消费者信息。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;为何说推模式是通过拉模式实现的？拉模式和推模式具体是怎么实现的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从消费者启动流程可知会启动PullMessageService这个线程，这个线程会一直轮询阻塞从&lt;/font&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;messageRequestQueue中读取 MessageRequest 命令再向 Broker 发送PULL_MESSAGE等请求拉取消息，如果有消息可以拉取成功并直接返回，这就实现了拉模式；&lt;br&gt;但是可能发请求时并没有可以消费的消息，这时Broker会将PullRequest（即消费者中的MessageRequest）存储到 PullRequestHoldService &lt;b&gt;pullRequestTable&lt;/b&gt;，待有新消息到来会重放pullRequestTable 中对应的 PullRequest 请求再次读取消息并通过netty长连接通道推送，这就实现了推模式。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;font style=&quot;&quot;&gt;消费者、Broker消息队列的消费关系是哪里维持的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;消费者消费消息是结合上次消费的逻辑偏移去ConsumeQueue批量查的，每个主题每个队列都有一个ConsumeQueue（两层ConcurrentHashMap），消费者创建时只是指定了消费的主题，&lt;b&gt;消费的目标队列ID则是在RebalanceService中动态分配的&lt;/b&gt;（还支持再均衡），经过 doRebalace() 之后就可以通过主题和消费队列ID去 Broker ConsumeQueueStore 中查找目标消费队列了&lt;br&gt;&lt;/font&gt;&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;消费者分组信息是怎么影响消费关系的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;是通过影响RebalanceService动态分配消费队列实现的，从 RebalanceService#doRebalanceByTopic()中可以看到再均衡前会拉取所有同一消费者分组的消费者集合，然后将消费主题下所有消费队列按分配策略分配给这些消费者，比如&amp;nbsp;&lt;/font&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;AllocateMessageQueueAveragely 就是将主题的所有消费队列平均分配给同组下所有消费者消费。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;消费进度怎么记录以及管理的？&lt;br&gt;&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="10" width="1340" height="190" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-1" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//刚开始启动时 DefaultMQPushConsumer 主题订阅信息还是空的，所以其实并没有拷贝&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;switch (this.defaultMQPushConsumer.getMessageModel()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case BROADCASTING:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case CLUSTERING:&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&lt;b&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;//获取此消费者分组对应的重试主题&lt;/b&gt;&lt;/font&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;名&lt;/font&gt;&lt;span style=&quot;font-size: 10px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp;&quot;%RETRY%&amp;lt;consumerGroup&amp;gt;&quot;，&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;&lt;span style=&quot;font-size: 10px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; //因为重试消息是被发到重试主题&lt;/span&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;而不是原主题中，所以需要额外订阅重试主体&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final String &lt;b&gt;retryTopic&lt;/b&gt; = MixAll.getRetryTopic(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getConsumerGroup());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SubscriptionData &lt;b&gt;subscriptionData&lt;/b&gt; = FilterAPI.buildSubscriptionData(retryTopic, &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; SubscriptionData.SUB_ALL);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//注册重试主题的订阅信息（比如主题名、匹配方式[TAG | SQL92]、匹配字段集合）&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.rebalanceImpl.&lt;b&gt;getSubscriptionInner&lt;/b&gt;().&lt;b&gt;put&lt;/b&gt;(retryTopic, subscriptionData);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="280" width="440" height="220" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-6" target="i4JN70CcAHU7UOiHbAm4-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="i4JN70CcAHU7UOiHbAm4-6" target="i4JN70CcAHU7UOiHbAm4-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-6" target="bPtuGuzI8SsVk5XaO2P4-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-6" target="bPtuGuzI8SsVk5XaO2P4-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;ConsumeMessageConcurrentlyService&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部创建了3个线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-9" target="bPtuGuzI8SsVk5XaO2P4-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeMessageConcurrentlyService&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;集群消息模式使用的消费偏移量记录，集群模式是所有匹配的消费者分摊消息进行消费&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 DefaultMQPushConsumerImpl&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumer defaultMQPushConsumer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用户定义的消息监听器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageListenerConcurrently &lt;b&gt;messageListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//后面消费线程池的任务队列（ConsumeRequest）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; &lt;b&gt;consumeRequestQueue&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//执行消息消费任务的线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ThreadPoolExecutor &lt;b&gt;consumeExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者分组&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;consumerGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;cleanExpireMsgExecutors&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1240" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-10" target="bPtuGuzI8SsVk5XaO2P4-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-10" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeMessagePopConcurrentlyService&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;集群消息模式使用的消费偏移量记录，集群模式是所有匹配的消费者分摊消息进行消费&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQPushConsumer defaultMQPushConsumer;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageListenerConcurrently &lt;b&gt;messageListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//后面消费线程池的任务队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; &lt;b&gt;consumeRequestQueue&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//执行消息消费任务的线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ThreadPoolExecutor &lt;b&gt;consumeExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;consumerGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1520" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-13" target="bPtuGuzI8SsVk5XaO2P4-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="i4JN70CcAHU7UOiHbAm4-13" target="bPtuGuzI8SsVk5XaO2P4-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-13" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;ConsumeMessagePopConcurrentlyService&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部创建了2个线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="i4JN70CcAHU7UOiHbAm4-15" target="bPtuGuzI8SsVk5XaO2P4-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i4JN70CcAHU7UOiHbAm4-15" value="&lt;div style=&quot;&quot;&gt;consumeExecutor&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名前缀：ConsumeMessageThread_&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-1" target="bPtuGuzI8SsVk5XaO2P4-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-1" value="&lt;div style=&quot;&quot;&gt;scheduledExecutorService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名前缀：&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;ConsumeMessageScheduledThread_&lt;br&gt;&lt;b&gt;用于异步提交ConsumeRequest 到 consumeExecutor&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-2" target="bPtuGuzI8SsVk5XaO2P4-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-2" value="&lt;div style=&quot;&quot;&gt;cleanExpireMsgExecutors&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名前缀：&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;CleanExpireMsgScheduledThread_&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-5" value="&lt;div style=&quot;&quot;&gt;consumeExecutor&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名前缀：&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;ConsumeMessageThread_&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-7" value="&lt;div style=&quot;&quot;&gt;scheduledExecutorService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;线程名前缀：&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;ConsumeMessageScheduledThread_&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-9" target="bPtuGuzI8SsVk5XaO2P4-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-9" value="&lt;div style=&quot;&quot;&gt;PullMessageService&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;是一个非守护线程，轮询从 messageRequestQueue 中阻塞获取消息请求实例，同时还提供单线程的计划任务线程池用于异步提交MessageRequest或任务&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="2200" y="670" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-11" target="bPtuGuzI8SsVk5XaO2P4-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-11" target="bPtuGuzI8SsVk5XaO2P4-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="k4oS1oCZOwMWvCcxRnyl-4" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="bPtuGuzI8SsVk5XaO2P4-20" vertex="1" connectable="0">
          <mxGeometry x="-0.0144" y="2" relative="1" as="geometry">
            <mxPoint y="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-11" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;while (!this.isStopped()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MessageRequest messageRequest = this.&lt;b&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;messageRequestQueue&lt;/font&gt;&lt;/b&gt;.&lt;b&gt;take&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (messageRequest.getMessageRequestMode() == MessageRequestMode.POP) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 通过PullRequest中的消费者分组从客户端消费者表consumerTable中选择一个消费者&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//执行消费者（是 DefaultMQPushConsumerImpl 实例）的 popMessage() 方法&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;popMessage&lt;/b&gt;((PopRequest) messageRequest);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//2 一样先选择一个消费者，然后执行 pullMessage() 方法&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;pullMessage&lt;/b&gt;((PullRequest) messageRequest);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2440" y="620" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-13" target="bPtuGuzI8SsVk5XaO2P4-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-13" value="&lt;div style=&quot;&quot;&gt;RebalanceService&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;根据当前节点当前主题的消息队列数量和消费者数量，进行负载均衡重新分配&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="2200" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-15" target="bPtuGuzI8SsVk5XaO2P4-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-15" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;this.&lt;b&gt;pullAPIWrapper&lt;/b&gt;.&lt;b&gt;popAsync&lt;/b&gt;(popRequest.getMessageQueue(), invisibleTime, this.defaultMQPushConsumer.getPopBatchNums(),&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;popRequest.getConsumerGroup(), BROKER_SUSPEND_MAX_TIME_MILLIS, popCallback, true, popRequest.getInitMode(),&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;false, subscriptionData.getExpressionType(), subscriptionData.getSubString());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;会先检查消费者状态，如果&lt;b&gt;不满足执行条件会调用&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;executePopPullRequestLater()将MessageRequest加回 messageRequestQueue&lt;/b&gt;, 满足执行条件会执行&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;这行代码即&lt;b&gt;发送 POP_MESSAGE 请求&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2920" y="620" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-17" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;FindBrokerResult findBrokerResult = this.mQClientFactory.findBrokerAddressInSubscribe(&lt;br&gt;&amp;nbsp; &amp;nbsp; mq.getBrokerName(), MixAll.MASTER_ID, true);&lt;br&gt;&lt;/div&gt;&lt;div&gt;String brokerAddr = findBrokerResult.getBrokerAddr();&lt;br&gt;&lt;/div&gt;&lt;div&gt;this.mQClientFactory.getMQClientAPIImpl().&lt;b&gt;popMessageAsync&lt;/b&gt;(mq.getBrokerName(), brokerAddr, requestHeader, timeout, popCallback);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;即通过Netty客户端向Broker发送&amp;nbsp;RequestCode.POP_MESSAGE （&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;200050&lt;b style=&quot;background-color: initial;&quot;&gt;）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3400" y="620" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-19" target="bPtuGuzI8SsVk5XaO2P4-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-23" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="bPtuGuzI8SsVk5XaO2P4-22" vertex="1" connectable="0">
          <mxGeometry x="-0.14" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-19" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;this.pullAPIWrapper.&lt;b&gt;pullKernelImpl&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pullRequest.getMessageQueue(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; subExpression,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; subscriptionData.getExpressionType(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; subscriptionData.getSubVersion(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pullRequest.&lt;b&gt;getNextOffset&lt;/b&gt;(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getPullBatchSize(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getPullBatchSizeInBytes(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; sysFlag,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; commitOffsetValue,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; BROKER_SUSPEND_MAX_TIME_MILLIS,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CommunicationMode.ASYNC,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;pullCallback&lt;/b&gt;&lt;/div&gt;&lt;div&gt;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;会先检查消费者状态，如果不满足执行条件会调用&lt;b&gt;executePullRequestLater&lt;/b&gt;()将MessageRequest加回 messageRequestQueue, 满足执行条件会执行这行代码即发送 &lt;b&gt;PULL_MESSAGE 或&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;LITE_PULL_MESSAGE&lt;/b&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp;请求&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2920" y="720" width="440" height="220" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-21" target="l0-h6NWxp7fgGbFjqFid-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-21" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (PullSysFlag.hasLitePullFlag(requestHeader.getSysFlag())) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(RequestCode.&lt;b&gt;LITE_PULL_MESSAGE&lt;/b&gt;, requestHeader);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; request = RemotingCommand.createRequestCommand(RequestCode.&lt;b&gt;PULL_MESSAGE&lt;/b&gt;, requestHeader);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;switch (communicationMode) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case ONEWAY:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; assert false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case ASYNC:&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 拉取消息成功就直接回调处理方法&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;pullMessageAsync&lt;/b&gt;(addr, request, timeoutMillis, &lt;b&gt;pullCallback&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case SYNC:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return this.&lt;b&gt;pullMessageSync&lt;/b&gt;(addr, request, timeoutMillis);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; assert false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;即通过Netty客户端向Broker发送 RequestCode.PULL_MESSAGE （11）或&amp;nbsp;RequestCode.LITE_PULL_MESSAGE（361）&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3400" y="710" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-25" target="bPtuGuzI8SsVk5XaO2P4-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-25" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;while (!this.isStopped()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;this.waitForRunning(realWaitInterval);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;boolean balanced = this.mqClientFactory.&lt;b&gt;doRebalance&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2440" y="970" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-27" target="bPtuGuzI8SsVk5XaO2P4-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-27" value="&lt;div style=&quot;&quot;&gt;for (Map.Entry&amp;lt;String, MQConsumerInner&amp;gt; entry : this.consumerTable.entrySet()) {&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;MQConsumerInner impl = entry.getValue();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;impl.&lt;b&gt;tryRebalance&lt;/b&gt;()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;遍历 MQClientInstance consumerTable 所有消费者执行各个消费者 RebalanceImpl#doRebalance()&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2920" y="960" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-29" target="bPtuGuzI8SsVk5XaO2P4-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-29" value="&lt;div style=&quot;&quot;&gt;ConsumeMessageConcurrentlyService$&lt;br&gt;ConsumeRequest#run()&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;消息消费任务，主要就是回调用户定义的消费方法 MessageListenerConcurrently&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-31" target="jlYKEgkvsbYtYgwFCarP-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-9" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="jlYKEgkvsbYtYgwFCarP-8" vertex="1" connectable="0">
          <mxGeometry x="0.3148" y="-2" relative="1" as="geometry">
            <mxPoint x="4" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-31" value="&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; .executeHookBefore(consumeMessageContext);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; //1 回调用户消息消费方法，注意 msgs 是 List&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp;status = listener.&lt;b&gt;consumeMessage&lt;/b&gt;(Collections.unmodifiableList(&lt;b&gt;msgs&lt;/b&gt;), context);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; .executeHookAfter(consumeMessageContext);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()&lt;span style=&quot;background-color: initial;&quot;&gt;.incConsumeRT(&lt;br&gt;&amp;nbsp; &amp;nbsp; ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(),&amp;nbsp; &amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; consumeRT);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 消费结果处理，做一些统计、消费失败处理、更新消费进度&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ConsumeMessageConcurrentlyService.this.&lt;b&gt;processConsumeResult&lt;/b&gt;(status, context, this);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1080" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-33" value="&lt;div style=&quot;&quot;&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;如果通过 &lt;b&gt;submitConsumeRequestLater()&lt;/b&gt; 提交的消息数量大于配置中 consumeMessageBatchMaxSize，会将消息分成多批提交到 consumeExecutor&amp;nbsp;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-35" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;定期清理&amp;nbsp;RebalanceImpl processQueueTable 所有 ProcessQueue中过期的消息（即消费超时的消息），todo&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-37" value="&lt;div style=&quot;text-align: center;&quot;&gt;ConsumeMessageConcurrentlyService$&lt;b style=&quot;background-color: initial;&quot;&gt;ConsumeRequest&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消息消费请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final List&amp;lt;MessageExt&amp;gt; msgs;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ProcessQueue processQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageQueue messageQueue;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2800" y="1240" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-38" value="&lt;div style=&quot;text-align: center;&quot;&gt;ConsumeMessagePopConcurrentlyService$&lt;b style=&quot;background-color: initial;&quot;&gt;ConsumeRequest&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消息消费请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;MessageExt&amp;gt; msgs;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PopProcessQueue processQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MessageQueue messageQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long popTime = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long invisibleTime = 0;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2800" y="1520" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-42" value="&lt;div style=&quot;&quot;&gt;this.pullMessageService.start();&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1880" y="2010" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-43" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;this.rebalanceService.start();&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1880" y="2090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-46" target="bPtuGuzI8SsVk5XaO2P4-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-46" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;return this.&lt;b&gt;rebalanceImpl&lt;/b&gt;.doRebalance(&lt;br&gt;this.isConsumeOrderly());&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;RebalanceImpl 实现有3种，注意这里只分析&lt;b&gt;RebalancePushImpl&lt;/b&gt;的实现&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=6;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3400" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-48" target="bPtuGuzI8SsVk5XaO2P4-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-48" value="&lt;div style=&quot;&quot;&gt;for (final Map.Entry&amp;lt;String, SubscriptionData&amp;gt; entry : subTable.entrySet()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;boolean result = this.&lt;b&gt;rebalanceByTopic&lt;/b&gt;(topic, isOrder);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;this.truncateMessageQueueNotMyTopic();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;其实是为所有主题重新分配&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="3640" y="980" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-50" target="1sCiEnjxGI17WgVkHkzz-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1sCiEnjxGI17WgVkHkzz-2" vertex="1" connectable="0">
          <mxGeometry x="0.25" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="21" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-50" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;switch (messageModel) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;BROADCASTING&lt;/b&gt;: {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... //暂略&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;CLUSTERING&lt;/b&gt;: {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //之前 主题 -&amp;gt; 消息队列集合&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Set&amp;lt;MessageQueue&amp;gt; &lt;b&gt;mqSet&lt;/b&gt; = this.topicSubscribeInfoTable.get(topic);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; //查找存储此topic消息的Broker主节点地址，如果有多个Broker主节点存储此topic消息就随机返回一个Broker地址&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //然后向此Broker地址发送 RequestCode.GET_CONSUMER_LIST_BY_GROUP 异步请求，获取此topic consumerGroup分组的消费者ID列表&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;String&amp;gt; &lt;b&gt;cidAll&lt;/b&gt; = this.mQClientFactory.findConsumerIdList(topic, &lt;b&gt;consumerGroup&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == mqSet) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.messageQueueChanged(topic, Collections.&amp;lt;MessageQueue&amp;gt;emptySet(), &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; Collections.&amp;lt;MessageQueue&amp;gt;emptySet());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == cidAll) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;doRebalance, {} {}, get consumer id list failed&quot;, consumerGroup, topic);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //&lt;b&gt;此主题的 Producer 已启动且发布消息，且执行 updateTopicRouteInfoFromNameServer() 以及 sendHeartbeatToAllBroker() 成功之后，mqSet cidAll 都不会为null&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //注意如果 Producer 没有启动或者 Producer 消息消费完毕， 这里 mqSet cidAll 可能为空（就不会执行重新负载），具体原因参考 NameServer 主题路由注册注销机制源码&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (mqSet != null &amp;amp;&amp;amp; cidAll != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;MessageQueue&amp;gt; mqAll = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqAll.addAll(mqSet);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Collections.sort(mqAll);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Collections.sort(cidAll);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //默认是策略是 AllocateMessageQueueAveragely&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;MessageQueue&amp;gt; allocateResult = null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt; // AllocateMessageQueueAveragely 会平均分配&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 假设有6个MessageQueue（Q0 Q1 Q2 Q3 Q4 Q5），4个消费者(C0 C1 C2 C3)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 按此策略各消费者会分得 C0(Q0 Q1) C1(Q2 Q3) C2(Q4) C3(Q5)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; allocateResult = strategy.allocate(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.consumerGroup,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.mQClientFactory.getClientId(),&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mqAll,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cidAll);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;allocate message queue exception. strategy name: {}, ex: {}&quot;, strategy.getName(), e);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Set&amp;lt;MessageQueue&amp;gt; allocateResultSet = new HashSet&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (allocateResult != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; allocateResultSet.addAll(allocateResult);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //1 更新&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;processQueueTable 中&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp;MessageQueue 对应的 ProcessQueue&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp;重新负载后当前消费者负责消费的队列可能有新增&lt;/b&gt;&lt;span style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;（比如主题消息队列数量不变但是有消费者服务实例宕机，其他消费者实例就需要多承担消费任务）&lt;/span&gt;&lt;b style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;或消减，对应地也需要添加或删除 ProcessQueue&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean changed = this.&lt;b&gt;updateProcessQueueTableInRebalance&lt;/b&gt;(topic, allocateResultSet, isOrder);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (changed) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.messageQueueChanged(topic, mqSet, allocateResultSet);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; balanced = allocateResultSet.equals(getWorkingMessageQueue(topic));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4120" y="980" width="440" height="720" as="geometry" />
        </mxCell>
        <mxCell id="KbjGYLnwEtNko80yWfFh-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="bPtuGuzI8SsVk5XaO2P4-53" target="KbjGYLnwEtNko80yWfFh-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bPtuGuzI8SsVk5XaO2P4-53" value="&lt;div&gt;&lt;font style=&quot;background-color: initial;&quot;&gt;return this.sendHeartbeatToAllBroker();&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;向所有包含此客户端主题（所有消费者和生产者主题）&lt;/font&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;消息的Broker发送心跳信息（并不是向所有Broker），因为更新 brokerAddrTable 都是通过topic指定更新的，所以客户端保存的Broker信息肯定是和客户端主题相关的Broker&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=15;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="2320" y="1864.5" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="-bXenXZ_OrZkZ0YaOcYN-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="KbjGYLnwEtNko80yWfFh-4" target="-bXenXZ_OrZkZ0YaOcYN-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="-bXenXZ_OrZkZ0YaOcYN-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;dashed=1;" parent="1" source="KbjGYLnwEtNko80yWfFh-4" target="bPtuGuzI8SsVk5XaO2P4-50" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3180" y="1863" />
              <mxPoint x="3180" y="1710" />
              <mxPoint x="4100" y="1710" />
              <mxPoint x="4100" y="1340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="-bXenXZ_OrZkZ0YaOcYN-5" value="&lt;font color=&quot;#007fff&quot;&gt;消费者信息&lt;br&gt;注册到相关Broker后&lt;br&gt;下次重新分配负载&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="-bXenXZ_OrZkZ0YaOcYN-4" vertex="1" connectable="0">
          <mxGeometry x="0.9045" y="-2" relative="1" as="geometry">
            <mxPoint x="-42" y="48" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KbjGYLnwEtNko80yWfFh-4" value="&lt;font color=&quot;#007fff&quot;&gt;//1 这里可以看到向Broker注册消费者和生产者信息时都注册了什么信息&lt;/font&gt;&lt;br&gt;final HeartbeatData heartbeatData = this.&lt;b&gt;prepareHeartbeatData&lt;/b&gt;(false);&lt;br&gt;for (Entry&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; brokerClusterInfo : this.brokerAddrTable.entrySet()) {&lt;br&gt;&amp;nbsp; &amp;nbsp; ...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //内部向Broker异步发送&amp;nbsp;RequestCode.&lt;b&gt;HEART_BEAT&lt;/b&gt; 请求&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;sendHeartbeatToBroker&lt;/b&gt;(id, brokerName, addr, heartbeatData);&lt;br&gt;&amp;nbsp; &amp;nbsp; ...&lt;br&gt;}&lt;br&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;verticalAlign=middle;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1830" width="400" height="130" as="geometry" />
        </mxCell>
        <mxCell id="-bXenXZ_OrZkZ0YaOcYN-1" value="&lt;div&gt;HeartbeatData &lt;b&gt;heartbeatData&lt;/b&gt; = new &lt;b&gt;HeartbeatData&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// clientID （客户端IP@instanceName@...）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;heartbeatData.&lt;b&gt;setClientID&lt;/b&gt;(this.clientId);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// Consumer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (Map.Entry&amp;lt;String, MQConsumerInner&amp;gt; entry : this.consumerTable.entrySet()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MQConsumerInner impl = entry.getValue();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (impl != null) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//注册的消费者信息：分组、消费类型(推、拉、POP)、消息模式(集群、广播)、消费起始偏移（实际不一定使用这个偏移）、订阅信息&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConsumerData &lt;b&gt;consumerData&lt;/b&gt; = new &lt;b&gt;ConsumerData&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.setGroupName(impl.groupName());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.setConsumeType(impl.consumeType());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.setMessageModel(impl.messageModel());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.setConsumeFromWhere(impl.consumeFromWhere());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getSubscriptionDataSet().addAll(impl.subscriptions());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.setUnitMode(impl.isUnitMode());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!isWithoutSub) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumerData.getSubscriptionDataSet().addAll(impl.subscriptions());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; heartbeatData.getConsumerDataSet().add(consumerData);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// Producer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (Map.Entry&amp;lt;String/* group */, MQProducerInner&amp;gt; entry : this.producerTable.entrySet()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MQProducerInner impl = entry.getValue();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (impl != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ProducerData &lt;b&gt;producerData&lt;/b&gt; = new &lt;b&gt;ProducerData&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; producerData.setGroupName(entry.getKey());&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; heartbeatData.getProducerDataSet().add(producerData);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;heartbeatData.setWithoutSub(isWithoutSub);&lt;/div&gt;&lt;div&gt;return heartbeatData;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;verticalAlign=middle;strokeColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="3200" y="1720" width="400" height="430" as="geometry" />
        </mxCell>
        <mxCell id="-bXenXZ_OrZkZ0YaOcYN-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;向所有相关Broker注册的信息：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;{&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;clientID&lt;/b&gt;&quot;: &quot;192.168.124.3@902399#94940991006009&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;consumerDataSet&lt;/b&gt;&quot;: [&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;consumeFromWhere&quot;: &quot;CONSUME_FROM_FIRST_OFFSET&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;consumeType&quot;: &quot;CONSUME_PASSIVELY&quot;, //即PUSH&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;groupName&quot;: &quot;please_rename_unique_group_name_4&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;messageModel&quot;: &quot;CLUSTERING&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;subscriptionDataSet&lt;/b&gt;&quot;: [&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;classFilterMode&quot;: false,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;codeSet&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;expressionType&quot;: &quot;TAG&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;subString&quot;: &quot;*&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;subVersion&quot;: 1718194550146,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;tagsSet&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;topic&quot;: &quot;%RETRY%please_rename_unique_group_name_4&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; },&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;classFilterMode&quot;: false,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;codeSet&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;expressionType&quot;: &quot;TAG&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;subString&quot;: &quot;*&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;subVersion&quot;: 1718194550110,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;tagsSet&quot;: [],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;topic&quot;: &quot;TopicTest-2&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;unitMode&quot;: false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;heartbeatFingerprint&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;producerDataSet&lt;/b&gt;&quot;: [&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;groupName&quot;: &quot;CLIENT_INNER_PRODUCER&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ],&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;withoutSub&quot;: false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1970" width="350" height="490" as="geometry" />
        </mxCell>
        <mxCell id="F6hBptz6ar2b9dJgxTKF-1" value="更新主题（）对应的 TopicRouteData 信息：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;{&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;brokerDatas&quot;: [&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;brokerAddrs&quot;: { &quot;0&quot;: &quot;192.168.124.3:10911&quot; },&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;brokerName&quot;: &quot;broker-a&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;cluster&quot;: &quot;DefaultCluster&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;enableActingMaster&quot;: false&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; ],&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;filterServerTable&quot;: {},&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;queueDatas&quot;: [&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;brokerName&quot;: &quot;broker-a&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;perm&quot;: 6,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;readQueueNums&quot;: 1,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;topicSysFlag&quot;: 0,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;writeQueueNums&quot;: 1&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; ]&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1720" y="2170" width="240" height="280" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="1sCiEnjxGI17WgVkHkzz-1" target="1sCiEnjxGI17WgVkHkzz-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="k4oS1oCZOwMWvCcxRnyl-2" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1sCiEnjxGI17WgVkHkzz-5" vertex="1" connectable="0">
          <mxGeometry x="-0.1296" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-1" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;boolean changed = false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 删除当前消费者不再需要负责消费的 MessageQueue 和 对应的 ProcessQueue&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// removeQueueMap 只是因为在迭代器中不能执行删除会抛异常，才用其作为临时缓存&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;HashMap&amp;lt;MessageQueue, ProcessQueue&amp;gt; removeQueueMap = new HashMap&amp;lt;&amp;gt;(this.processQueueTable.size());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;Iterator&amp;lt;Entry&amp;lt;MessageQueue, ProcessQueue&amp;gt;&amp;gt; it = this.processQueueTable.entrySet().iterator();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;while (it.hasNext()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; Entry&amp;lt;MessageQueue, ProcessQueue&amp;gt; next = it.next();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; MessageQueue mq = next.getKey();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ProcessQueue pq = next.getValue();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (mq.getTopic().equals(topic)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!mqSet.contains(mq)) { &lt;font color=&quot;#007fff&quot;&gt;//即mq不再需要当前消费者负责消费&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pq.&lt;b&gt;setDropped&lt;/b&gt;(true);&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//设置ProcessQueue为废弃状态&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; removeQueueMap.put(mq, pq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //push消费模式且从ProcessQueue拉取超时，应该是消费者消费能力不足？todo：何时pq会拉取超时？&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; else if (pq.isPullExpired() &amp;amp;&amp;amp; this.consumeType() == ConsumeType.CONSUME_PASSIVELY) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pq.&lt;b&gt;setDropped&lt;/b&gt;(true);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; removeQueueMap.put(mq, pq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;[BUG]doRebalance, {}, try remove unnecessary mq, {}, because pull is pause, so try to fixed it&quot;,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;consumerGroup, mq);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;for (Entry&amp;lt;MessageQueue, ProcessQueue&amp;gt; entry : removeQueueMap.entrySet()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; MessageQueue mq = entry.getKey();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ProcessQueue pq = entry.getValue();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //MessageQueue并不是直接删除就行了，还需要提前&lt;b&gt;先提交下消费偏移位置&lt;/b&gt;等，todo&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (this.&lt;b&gt;removeUnnecessaryMessageQueue&lt;/b&gt;(mq, pq)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;processQueueTable&lt;/b&gt;.remove(mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; changed = true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(&quot;doRebalance, {}, remove unnecessary mq, {}&quot;, consumerGroup, mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 添加当前消费者负责消费的新 MessageQueue 和对应的 ProcessQueue&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;boolean allMQLocked = true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;List&amp;lt;PullRequest&amp;gt; &lt;b&gt;pullRequestList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;for (MessageQueue mq : mqSet) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!this.processQueueTable.containsKey(mq)) { &lt;font color=&quot;#007fff&quot;&gt;//即mq是新增的需要当前消费者负责消费的MessageQueue&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isOrder &amp;amp;&amp;amp; !this.lock(mq)) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//为何加锁？RebalanceService中各个消费者再平衡是在同一个非守护线程中顺序执行的，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;不过也可能其他线程哪里可能会修改下面临界数据暂时没看到&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;doRebalance, {}, add a new mq failed, {}, because lock failed&quot;, consumerGroup, mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; allMQLocked = false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //删除OffsetStore中此mq的消费进度&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;removeDirtyOffset&lt;/b&gt;(mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ProcessQueue pq = &lt;b&gt;createProcessQueue&lt;/b&gt;(topic);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pq.setLocked(true);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //重新读取消费进度&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long nextOffset = this.&lt;b&gt;computePullFromWhere&lt;/b&gt;(mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (nextOffset &amp;gt;= 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (pre != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(&quot;doRebalance, {}, mq already exists, {}&quot;, consumerGroup, mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(&quot;doRebalance, {}, add a new mq, {}&quot;, consumerGroup, mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; PullRequest pullRequest = new PullRequest();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pullRequest.setConsumerGroup(consumerGroup);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pullRequest.setNextOffset(nextOffset);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pullRequest.setMessageQueue(mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pullRequest.setProcessQueue(pq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pullRequestList.add(pullRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; changed = true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;doRebalance, {}, add new mq failed, {}&quot;, consumerGroup, mq);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (!allMQLocked) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; mQClientFactory.rebalanceLater(500);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 每添加一个新的MessageQueue，需要提交一个PullRequest，启动对这个消息队列的消费流程&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b&gt;dispatchPullRequest&lt;/b&gt;(pullRequestList, 500);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return changed;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4600" y="980" width="440" height="840" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="1sCiEnjxGI17WgVkHkzz-4" target="1sCiEnjxGI17WgVkHkzz-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-4" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;for (PullRequest pullRequest : pullRequestList) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (delay &amp;lt;= 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;// 这个方法延迟 delay ms 后执行一次&amp;nbsp;executePullRequestImmediately()&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQPushConsumerImpl.&lt;b&gt;executePullRequestLater&lt;/b&gt;(pullRequest, delay);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="5080" y="1350" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="1sCiEnjxGI17WgVkHkzz-6" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp;this.&lt;b&gt;messageRequestQueue&lt;/b&gt;.put(pullRequest);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=15;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="5560" y="1370" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="l0-h6NWxp7fgGbFjqFid-1" target="l0-h6NWxp7fgGbFjqFid-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4100" y="830" />
              <mxPoint x="4100" y="740" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="l0-h6NWxp7fgGbFjqFid-1" target="l0-h6NWxp7fgGbFjqFid-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4100" y="830" />
              <mxPoint x="4100" y="920" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-1" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;请求响应后回调 DefaultMQPushConsumerImpl$&lt;br&gt;pullMessage()中定义的实现PullCallback的匿名内部类&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=22;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3880" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="l0-h6NWxp7fgGbFjqFid-3" target="l0-h6NWxp7fgGbFjqFid-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;onSuccess()&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=22;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4120" y="710" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-5" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;onException(Throwable e)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;异常处理比较简单，借助 executePullRequestLater() 方法延迟一段时间后重新提交&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=22;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4120" y="890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="l0-h6NWxp7fgGbFjqFid-9" target="l0-h6NWxp7fgGbFjqFid-11" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4500" y="740" />
              <mxPoint x="4500" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-13" value="FOUND&lt;br&gt;成功拉取" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="l0-h6NWxp7fgGbFjqFid-12" vertex="1" connectable="0">
          <mxGeometry x="-0.1333" y="-1" relative="1" as="geometry">
            <mxPoint x="26" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="l0-h6NWxp7fgGbFjqFid-9" target="l0-h6NWxp7fgGbFjqFid-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4500" y="740" />
              <mxPoint x="4500" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-18" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;NO_NEW_MSG/&lt;br style=&quot;font-size: 10px;&quot;&gt;NO_MATCHED_MSG&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="l0-h6NWxp7fgGbFjqFid-15" vertex="1" connectable="0">
          <mxGeometry x="0.44" y="2" relative="1" as="geometry">
            <mxPoint x="-4" y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="l0-h6NWxp7fgGbFjqFid-9" target="l0-h6NWxp7fgGbFjqFid-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4500" y="740" />
              <mxPoint x="4500" y="900" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-19" value="OFFSET_ILLEGAL" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="l0-h6NWxp7fgGbFjqFid-17" vertex="1" connectable="0">
          <mxGeometry x="0.5857" y="-1" relative="1" as="geometry">
            <mxPoint y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-9" value="消息拉取状态" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=22;" parent="1" vertex="1">
          <mxGeometry x="4360" y="700" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="l0-h6NWxp7fgGbFjqFid-11" target="jlYKEgkvsbYtYgwFCarP-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-3" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="jlYKEgkvsbYtYgwFCarP-2" vertex="1" connectable="0">
          <mxGeometry x="0.5124" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-11" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 将拉取的消息列表提交给&amp;nbsp;consumeMessageService 处理，即这里并不是消息消费的位置&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;boolean dispatchToConsume = processQueue.putMessage(pullResult.getMsgFoundList());&lt;/div&gt;&lt;div&gt;DefaultMQPushConsumerImpl.this.&lt;b&gt;consumeMessageService&lt;/b&gt;.&lt;b&gt;submitConsumeRequest&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pullResult.getMsgFoundList(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; processQueue,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pullRequest.getMessageQueue(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dispatchToConsume);&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;// 执行这块代码为了触发下一次拉取消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() &amp;gt; 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; DefaultMQPushConsumerImpl.this.&lt;b&gt;executePullRequestLater&lt;/b&gt;(pullRequest,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; DefaultMQPushConsumerImpl.this.&lt;b&gt;executePullRequestImmediately&lt;/b&gt;(pullRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=5;align=left;" parent="1" vertex="1">
          <mxGeometry x="4600" y="590" width="440" height="180" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-14" value="&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 执行这一行为了触发下一次拉取消息&lt;/font&gt;&lt;/div&gt;DefaultMQPushConsumerImpl.this&lt;br style=&quot;font-size: 9px;&quot;&gt;.executePullRequestImmediately(pullRequest);&lt;br&gt;..." style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=22;align=left;" parent="1" vertex="1">
          <mxGeometry x="4600" y="790" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l0-h6NWxp7fgGbFjqFid-16" value="" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=22;" parent="1" vertex="1">
          <mxGeometry x="4600" y="870" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="k4oS1oCZOwMWvCcxRnyl-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;比如当前消费者实例负责 TopicTest-1 这个主题的中 4 个队列的消费，会向 messageRequestQueue 中 put 4 个 PullRequest 请求来启动对这4个队列的消费&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;0 = {PullRequest@2716} &quot;PullRequest [consumerGroup=please_rename_unique_group_name_4, messageQueue=MessageQueue [topic=TopicTest-1, brokerName=broker-a, queueId=3], nextOffset=0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;1 = {PullRequest@2739} &quot;PullRequest [consumerGroup=please_rename_unique_group_name_4, messageQueue=MessageQueue [topic=TopicTest-1, brokerName=broker-a, queueId=2], nextOffset=0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;2 = {PullRequest@2740} &quot;PullRequest [consumerGroup=please_rename_unique_group_name_4, messageQueue=MessageQueue [topic=TopicTest-1, brokerName=broker-a, queueId=1], nextOffset=0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;3 = {PullRequest@2741} &quot;PullRequest [consumerGroup=please_rename_unique_group_name_4, messageQueue=MessageQueue [topic=TopicTest-1, brokerName=broker-a, queueId=0], nextOffset=0]&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="5050" y="1755" width="920" height="70" as="geometry" />
        </mxCell>
        <mxCell id="k4oS1oCZOwMWvCcxRnyl-5" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;注意一个服务实例中可能注册有多个消费者&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2670" y="590" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="k4oS1oCZOwMWvCcxRnyl-6" value="&lt;b&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这里可以最终看到拉取消息是一批批地拉取，上一批处理完再拉取下一批&lt;/font&gt;&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4600" y="560" width="340" height="30" as="geometry" />
        </mxCell>
        <mxCell id="lVE0Ub6YxTm5ZSgNUZbr-1" value="&lt;b&gt;以默认的负载均衡策略来看，集群中同一个分组的所有消费者会平均分担一个主题下所有的消息队列，&lt;br&gt;一个消息队列最多由一个消费者进行消费，不会出现多线程并发消费同一个消息队列的情况。&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="4120" y="1710" width="470" height="40" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="jlYKEgkvsbYtYgwFCarP-1" target="i4JN70CcAHU7UOiHbAm4-15" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5300" y="620" />
              <mxPoint x="5300" y="950" />
              <mxPoint x="1820" y="950" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-6" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;从Broker拉取消息&lt;br style=&quot;font-size: 10px;&quot;&gt;装配成消费任务 ConsumeRequest&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="jlYKEgkvsbYtYgwFCarP-4" vertex="1" connectable="0">
          <mxGeometry x="0.9855" y="-1" relative="1" as="geometry">
            <mxPoint x="1" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-1" value="&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 执行这一行为了触发下一次拉取消息&lt;/font&gt;&lt;/div&gt;this.&lt;b&gt;consumeExecutor&lt;br&gt;&lt;/b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;submit&lt;/b&gt;(consumeRequest);&lt;br&gt;..." style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=22;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="5080" y="590" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jlYKEgkvsbYtYgwFCarP-7" target="jlYKEgkvsbYtYgwFCarP-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-7" value="&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; .executeHookBefore(consumeMessageContext);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; //1 回调用户消息消费方法，注意 msgs 是 List&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp;status = listener.&lt;b&gt;consumeMessage&lt;/b&gt;(Collections.unmodifiableList(&lt;b&gt;msgs&lt;/b&gt;), context);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; .executeHookAfter(consumeMessageContext);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()&lt;span style=&quot;background-color: initial;&quot;&gt;.incConsumeRT(&lt;br&gt;&amp;nbsp; &amp;nbsp; ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(),&amp;nbsp; &amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; consumeRT);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2 消费结果处理，做一些消费TPS统计、消费失败处理、更新消费进度&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ConsumeMessageConcurrentlyService.this.&lt;b&gt;processConsumeResult&lt;/b&gt;(status, context, this);&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1080" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.995;exitY=0.592;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="jlYKEgkvsbYtYgwFCarP-10" target="1rxinjsTnm6Vs97CKNB9-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-3" value="&lt;font color=&quot;#007fff&quot;&gt;消息消费失败重新发回给Broker&lt;br&gt;后续流程&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1rxinjsTnm6Vs97CKNB9-2" vertex="1" connectable="0">
          <mxGeometry x="-0.8309" relative="1" as="geometry">
            <mxPoint x="304" y="613" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-4" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1rxinjsTnm6Vs97CKNB9-2" vertex="1" connectable="0">
          <mxGeometry x="0.5432" y="1" relative="1" as="geometry">
            <mxPoint x="29" y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-10" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int ackIndex = context.getAckIndex();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (consumeRequest.getMsgs().isEmpty())&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;switch (status) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;CONSUME_SUCCESS&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 做一些消费 TPS 统计...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;RECONSUME_LATER&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 会导致后面 for 循环将所有消息重新发回到Broker&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ackIndex = -1;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;... 消费失败 TPS 统计..&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;switch (this.defaultMQPushConsumer.getMessageModel()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;BROADCASTING&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i = ackIndex + 1; i &amp;lt; consumeRequest.getMsgs().size(); i++) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageExt msg = consumeRequest.getMsgs().get(i);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;BROADCASTING, the message consume failed, drop it, {}&quot;, msg.toString());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;CLUSTERING&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;MessageExt&amp;gt; msgBackFailed = new ArrayList&amp;lt;&amp;gt;(consumeRequest.getMsgs().size());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 消费失败（RECONSUME_LATER）才会执行这个for循环&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i = ackIndex + 1; i &amp;lt; consumeRequest.getMsgs().size(); i++) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageExt msg = consumeRequest.getMsgs().get(i);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Maybe message is expired and cleaned, just ignore it.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!consumeRequest.getProcessQueue().containsMessage(msg)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.info(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 1 将消费失败的消息重新发送回Broker, 借助 MQClientInstance 中创建的 DefaultMQProducer&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 这里解释了消费者中为何要创建生产者实例的原因&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean result = this.&lt;b&gt;sendMessageBack&lt;/b&gt;(msg, context);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!result) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msgBackFailed.add(msg);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!msgBackFailed.isEmpty()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; consumeRequest.getMsgs().removeAll(msgBackFailed);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 返回消息列表中消息的最大偏移，消息消费失败也会更新消费位点，因为重试其实是发了一个新消息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;long offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (offset &amp;gt;= 0 &amp;amp;&amp;amp; !consumeRequest.getProcessQueue().isDropped()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;b&gt; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; // 2 更新 OffsetStore 实例消费位点（offsetTable）, 比如 CLUSTERING 中是 RemoteBrokerOffsetStore&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 消费偏移通过对应的线程池任务定期同步到 Broker（可通过 OffsetStore persistXxx方法反向查调用链&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;找到任务）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.defaultMQPushConsumerImpl.&lt;b&gt;getOffsetStore&lt;/b&gt;().&lt;b&gt;updateOffset&lt;/b&gt;(consumeRequest.getMessageQueue(), offset, true);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3160" y="1080" width="440" height="620" as="geometry" />
        </mxCell>
        <mxCell id="jlYKEgkvsbYtYgwFCarP-16" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;消费进度更新后由线程池任务定期向Broker持久化（persistXxx方法），&lt;br&gt;通过发送&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;RequestCode.&lt;b&gt;UPDATE_CONSUMER_OFFSET &lt;/b&gt;实现，&lt;/font&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;与其说是持久化不如说是同步，看此命令码的处理方法可以看到只是更新 Broker OffsetManager &lt;br&gt;offsetTable, 并没有立即刷到磁盘，持久化到磁盘也是通过专门的线程任务实现的&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1290" width="440" height="70" as="geometry" />
        </mxCell>
        <mxCell id="G8nSWGWCtPQHXwYgGT0W-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;三种消费者类型对比与使用场景：&lt;br&gt;https://rocketmq.apache.org/zh/docs/featureBehavior/06consumertype/&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="300" width="340" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rpe9jBAspnPgU4ctBdTs-2" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;消费者负载均衡分配策略原理参考 Markdown 文档：&lt;br&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;AllocateMessageQueueAveragely&lt;/b&gt;&lt;br&gt;AllocateMessageQueueAveragelyByCircle&lt;br&gt;AllocateMessageQueueByConfig&lt;br&gt;AllocateMessageQueueByMachineRoom&lt;br&gt;&lt;b&gt;AllocateMessageQueueConsistentHash&lt;/b&gt;&lt;br&gt;AllocateMachineRoomNearby&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3840" y="1280" width="260" height="110" as="geometry" />
        </mxCell>
        <mxCell id="ink1OJaSQJaR3CQkYgyS-1" value="&lt;div style=&quot;&quot;&gt;&lt;b&gt;ConsumeMessageOrderlyService&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;内部处理流程同样是用了线程池，但是和&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;ConsumeMessageConcurrentlyService 不同的是加了&lt;b&gt;消息队列同步锁&lt;/b&gt;，通过锁实现了这个队列消息的顺序消费&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="1rxinjsTnm6Vs97CKNB9-1" target="1rxinjsTnm6Vs97CKNB9-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4600" y="2080" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-1" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 最终是执行这个方法&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;p&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;rivate void &lt;b style=&quot;font-size: 9px;&quot;&gt;sendMessageBack&lt;/b&gt;(MessageExt msg, int delayLevel, final String brokerName,&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 9px;&quot;&gt;&#x9;&lt;/span&gt;final MessageQueue mq)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; throws RemotingException, MQBrokerException, InterruptedException, MQClientException {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean needRetry = true;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 看上去是模拟测试用的，实际不会走这里，先忽略&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (brokerName != null &amp;amp;&amp;amp; brokerName.startsWith(MixAll.LOGICAL_QUEUE_MOCK_BROKER_PREFIX)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; || mq != null &amp;amp;&amp;amp; mq.getBrokerName().startsWith(MixAll.LOGICAL_QUEUE_MOCK_BROKER_PREFIX)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; needRetry = false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;sendMessageBackAsNormalMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 实际走这个条件&lt;/font&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String brokerAddr = (null != brokerName) ? &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.mQClientFactory.&lt;b&gt;findBrokerAddressInPublish&lt;/b&gt;(brokerName)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 即通过Netty客户端将消息发回给Broker&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.mQClientFactory.getMQClientAPIImpl().&lt;b&gt;consumerSendMessageBack&lt;/b&gt;(brokerAddr, brokerName, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;msg,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;this.defaultMQPushConsumer.getConsumerGroup(), delayLevel, 5000, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;getMaxReconsumeTimes());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable t) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;Failed to send message back, consumerGroup={}, brokerName={}, mq={}, message={}&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.defaultMQPushConsumer.getConsumerGroup(), brokerName, mq, msg, t);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (needRetry) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;sendMessageBackAsNormalMessage&lt;/b&gt;(msg);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.defaultMQPushConsumer.getNamespace()));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="4120" y="1880" width="440" height="400" as="geometry" />
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-5" value="DefaultMPPushConsumerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4250" y="1850" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="1rxinjsTnm6Vs97CKNB9-8" value="向 Broker 发送&amp;nbsp;&lt;b&gt;RequestCode&lt;br&gt;.CONSUMER_SEND_MSG_BACK&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="4600" y="2050" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
