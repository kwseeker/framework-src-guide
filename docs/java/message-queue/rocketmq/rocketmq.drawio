<mxfile host="Electron" modified="2024-03-06T14:54:15.599Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="WI5g8vyrzL_fJJ-XiSAL" version="21.6.5" type="device" pages="4">
  <diagram name="Producer" id="6497DEjvEHfmiQGX_mvA">
    <mxGraphModel dx="3478" dy="657" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="vPcbMLoeAANIdaAQQIEJ-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;RocketMQ工作原理（5.2.0）&lt;/font&gt;&lt;/h1&gt;&lt;p&gt;这页展示&lt;b&gt;生产者&lt;/b&gt;发送消息的逻辑（包括同步监听确认消息）；其他各部分在其他页面中展示;&amp;nbsp;&lt;br&gt;Producer 包括多种消息发送方式。&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;RocketMQ代码量太大了，这里会忽略一些细节。&lt;/span&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="640" height="100" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="vPcbMLoeAANIdaAQQIEJ-2" target="4EuGsi6HqrbHvLX2JFA4-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="vPcbMLoeAANIdaAQQIEJ-2" value="生产者发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="vPcbMLoeAANIdaAQQIEJ-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;异步发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-2" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;批量发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;定时发送消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-4" value="DefaultMQProducer &lt;br style=&quot;font-size: 10px;&quot;&gt;顺序发送消息" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-5" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送单向消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;DefaultMQProducer&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;发送广播消息&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-7" target="4EuGsi6HqrbHvLX2JFA4-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-7" target="4EuGsi6HqrbHvLX2JFA4-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-7" value="DefaultMQProducer producer = new &lt;b&gt;DefaultMQProducer&lt;/b&gt;(&lt;font style=&quot;font-size: 9px;&quot;&gt;PRODUCER_GROUP&lt;/font&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-9" target="4EuGsi6HqrbHvLX2JFA4-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.004;exitY=0.067;exitDx=0;exitDy=0;endArrow=diamondThin;endFill=1;exitPerimeter=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-9" target="4EuGsi6HqrbHvLX2JFA4-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducer&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;就死封装了一些额外配置信息的 DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这个才是消息生产者的核心&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;protected final transient DefaultMQProducerImpl &lt;b&gt;defaultMQProducerImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private final Set&amp;lt;Integer&amp;gt; retryResponseCodes = new CopyOnWriteArraySet&amp;lt;&amp;gt;(Arrays.asList(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.TOPIC_NOT_EXIST,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SERVICE_NOT_AVAILABLE,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.SYSTEM_ERROR,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_PERMISSION,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NO_BUYER_ID,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; ResponseCode.NOT_IN_CURRENT_UNIT&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 生产者组概念上聚合了完全相同角色的所有生产者实例，特别是在涉及事务消息时尤为重要。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 对于非事务性消息，只要每个进程是唯一的就可以。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 有关更多讨论，请参见 https://rocketmq.apache.org/docs/introduction/02concepts。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b&gt;producerGroup&lt;/b&gt;; // 生产者组&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 需要为事务生产者初始化的主题&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private List&amp;lt;String&amp;gt; &lt;b&gt;topics&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 仅用于测试或演示程序&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认主题创建的队列数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private volatile int defaultTopicQueueNums = 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 发送消息的超时时间。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int sendMsgTimeout = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 压缩消息体阈值，即，默认情况下，大于4k的消息体将被压缩。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int compressMsgBodyOverHowmuch = 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在同步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，在声称发送失败之前，内部执行的最大重试次数。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这可能会导致消息重复，需要应用程序开发人员解决。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int retryTimesWhenSendAsyncFailed = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在发送失败时内部是否重试另一个代理。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean retryAnotherBrokerWhenNotStoreOK = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 允许的最大消息体大小（以字节为单位）。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int maxMessageSize = 1024 * 1024 * 4;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 异步传输数据的接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private TraceDispatcher traceDispatcher = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量消息的开关标志实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean autoBatch = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自动批量处理消息的实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private ProduceAccumulator &lt;b&gt;produceAccumulator&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 指示当异步发送流量过大时是否阻塞消息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private boolean enableBackpressureForAsyncMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大数量。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 10000。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendNum = 10000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在异步模式下，限制正在进行的发送异步消息的最大消息大小。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认值为 100M。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int backPressureForAsyncSendSize = 100 * 1024 * 1024;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-560" y="1120" width="520" height="680" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-10" target="4EuGsi6HqrbHvLX2JFA4-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-10" value="defaultMQProducerImpl = new &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;(this, null);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-12" target="4EuGsi6HqrbHvLX2JFA4-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-12" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY = &quot;com.rocketmq.sendMessageWithVIPChannel&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SOCKS_PROXY_CONFIG = &quot;com.rocketmq.socks.proxy.config&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_READ_BODY = &quot;com.rocketmq.read.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String DECODE_DECOMPRESS_BODY = &quot;com.rocketmq.decompress.body&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String SEND_LATENCY_ENABLE = &quot;com.rocketmq.sendLatencyEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String START_DETECTOR_ENABLE = &quot;com.rocketmq.startDetectorEnable&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HEART_BEAT_V2 = &quot;com.rocketmq.heartbeat.v2&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接的NameServer地址（IP+端口）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//生产者的客户端IP&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String clientIP = NetworkUtil.getLocalAddress();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//客户端实例名，默认“DEFAULT”，“DEFAULT”&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;后面在启动时会被替换为 PID#当前纳秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;instanceName&lt;/b&gt; = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Deprecated&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespace;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean namespaceInitialized = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String namespaceV2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AccessChannel accessChannel = AccessChannel.LOCAL;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从命名服务拉取主题（topic）信息的间隔，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int pollNameServerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//与Broker的长连接的心跳周期，默认30s&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int heartbeatBrokerInterval = 1000 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Offset persistent interval for consumer&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int persistConsumerOffsetInterval = 1000 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long pullTimeDelayMillsWhenException = 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean unitMode = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String unitName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeReadBody = Boolean.parseBoolean(System.getProperty(DECODE_READ_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean decodeDecompressBody = Boolean.parseBoolean(System.getProperty(DECODE_DECOMPRESS_BODY, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean vipChannelEnabled = Boolean.parseBoolean(System.getProperty(SEND_MESSAGE_WITH_VIP_CHANNEL_PROPERTY, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useHeartbeatV2 = Boolean.parseBoolean(System.getProperty(HEART_BEAT_V2, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useTLS = TlsSystemConfig.tlsEnable;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String socksProxyConfig = System.getProperty(SOCKS_PROXY_CONFIG, &quot;{}&quot;);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int mqClientApiTimeout = 3 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectTimeout = 200;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int detectInterval = 2 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private LanguageCode language = LanguageCode.JAVA;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable stream request type will inject a RPCHook to add corresponding request type to remoting layer.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * And it will also generate a different client id to prevent unexpected reuses of MQClientInstance.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected boolean enableStreamRequestType = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;/**&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Enable the fault tolerance mechanism of the client sending process.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * DO NOT OPEN when ORDER messages are required.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * Turning on will interfere with the queue selection functionality,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; * possibly conflicting with the order message.&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; */&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean sendLatencyEnable = Boolean.parseBoolean(System.getProperty(SEND_LATENCY_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean startDetectorEnable = Boolean.parseBoolean(System.getProperty(START_DETECTOR_ENABLE, &quot;false&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean enableHeartbeatChannelEventListener = true;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="320" width="520" height="760" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQProducer （I）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start() throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;List&amp;lt;MessageQueue&amp;gt; &lt;b&gt;fetchPublishMessageQueues&lt;/b&gt;(final String topic) throws MQClientException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//同步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;SendResult &lt;b&gt;send&lt;/b&gt;(...) throws MQClientException, RemotingException, MQBrokerException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;send&lt;/b&gt;(..., final SendCallback sendCallback) throws MQClientException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemotingException, InterruptedException, MQBrokerException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单向发送&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;sendOneway&lt;/b&gt;(final Message msg) throws MQClientException, RemotingException,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; InterruptedException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务控制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TransactionSendResult &lt;b&gt;sendMessageInTransaction&lt;/b&gt;(final Message msg,&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Object arg) throws MQClientException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-560" y="40" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-16" value="produceAccumulator = &lt;b&gt;MQClientManager&lt;/b&gt;.getInstance()&lt;br&gt;.getOrCreateProduceAccumulator(this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-18" target="XCCizzzmYaNoT9W5dNt4-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-18" target="4EuGsi6HqrbHvLX2JFA4-55">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-18" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;核心类，DefaultMQProducerImpl 实现的是一个MQ客户端（MQClientInstance）上的某一分组的消息生产者&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 DefaultMQProducer 实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String/* topic */, TopicPublishInfo&amp;gt; topicPublishInfoTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;SendMessageHook&amp;gt; sendMessageHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ArrayList&amp;lt;EndTransactionHook&amp;gt; endTransactionHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RPCHook rpcHook;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BlockingQueue&amp;lt;Runnable&amp;gt; asyncSenderThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService defaultAsyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected BlockingQueue&amp;lt;Runnable&amp;gt; checkRequestQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected ExecutorService checkExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个实例是通过 MQClientManager 工厂创建的，同时也是当前DefautlMQProducerImpl 的容器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 当前 DefautlMQProducerImpl 只不过是 MQClientInstance 中的一个消息生产者（MQProducerInner&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;MQClientInstance&lt;/b&gt; &lt;b&gt;mQClientFactory&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ArrayList&amp;lt;CheckForbiddenHook&amp;gt; checkForbiddenHookList = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MQFaultStrategy mqFaultStrategy;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService asyncSenderExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// compression related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int compressLevel = Integer.parseInt(System.getProperty(MixAll.MESSAGE_COMPRESS_LEVEL, &quot;5&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private CompressionType compressType = CompressionType.of(System.getProperty(MixAll.MESSAGE_COMPRESS_TYPE, &quot;ZLIB&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Compressor compressor = CompressorFactory.getCompressor(compressType);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;// backpressure related&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendNum;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Semaphore semaphoreAsyncSendSize;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1120" width="520" height="440" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-20" target="4EuGsi6HqrbHvLX2JFA4-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-20" target="4EuGsi6HqrbHvLX2JFA4-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-20" value="producer.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-22" target="4EuGsi6HqrbHvLX2JFA4-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-22" target="4EuGsi6HqrbHvLX2JFA4-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-22" value="Message msg = new Message(TOPIC, TAG, bytes);&lt;br&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;SendResult &lt;b&gt;sendResult&lt;/b&gt; = producer.&lt;b&gt;send&lt;/b&gt;(msg, 20 * 1000);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;同步发送消息&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-24" value="producer.shutdown();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-26" target="4EuGsi6HqrbHvLX2JFA4-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-26" value="this.setProducerGroup(&lt;br&gt;withNamespace(this.producerGroup));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在生产者分组上添加&lt;b&gt;命名空间&lt;/b&gt;信息，不指定命名空间默认为null,即不附加命名空间&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-28" target="4EuGsi6HqrbHvLX2JFA4-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-28" target="4EuGsi6HqrbHvLX2JFA4-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-28" value="this.&lt;b&gt;defaultMQProducerImpl&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;创建内部组件并启动&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-30" target="XCCizzzmYaNoT9W5dNt4-81">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-30" value="this.&lt;b&gt;produceAccumulator&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于支持&lt;b&gt;批量发送消息&lt;/b&gt;，accumulator: 蓄能器，比喻很贴切&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-32" target="4EuGsi6HqrbHvLX2JFA4-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-76" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-32" target="XCCizzzmYaNoT9W5dNt4-75">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-32" value="检查 this.serviceState 状态（即生产者客户端启动状态），有 CREATE_JUST、RUNNING、SHUTDOWN_ALREADY、START_FAILED 4种状态，仅仅&lt;b&gt;CREATE_JUST&lt;/b&gt; 会执行客户端启动流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-34" value="DefaultMQProducerImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="785" y="370" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-35" target="4EuGsi6HqrbHvLX2JFA4-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-35" value="修改启动状态 START_FAILED&lt;br&gt;检查生产者分组命名规范、修改客户端实例名（instanceName）" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-37" target="4EuGsi6HqrbHvLX2JFA4-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-37" target="4EuGsi6HqrbHvLX2JFA4-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-37" value="this.&lt;b&gt;mQClientFactory&lt;/b&gt; = MQClientManager.getInstance().&lt;br&gt;&lt;b&gt;getOrCreateMQClientInstance&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer, rpcHook);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建MQ客户端实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-39" target="4EuGsi6HqrbHvLX2JFA4-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-39" value="boolean registerOK = mQClientFactory.&lt;b&gt;registerProducer&lt;/b&gt;(&lt;br&gt;this.defaultMQProducer.getProducerGroup(), this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;MQClientInstance 同时是 MQProduceInner 的容器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="720" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-41" target="4EuGsi6HqrbHvLX2JFA4-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-41" target="4EuGsi6HqrbHvLX2JFA4-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-41" value="&lt;b&gt;if (startFactory)&lt;/b&gt;&lt;br&gt;&lt;b&gt;mQClientFactory&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;mQClientFactory 即上面的 MQClientInstance 实例，将启动其内部的各个组件&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-45" target="4EuGsi6HqrbHvLX2JFA4-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-45" target="4EuGsi6HqrbHvLX2JFA4-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-45" value="this.initTopicRoute();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-47" target="XCCizzzmYaNoT9W5dNt4-73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-47" value="this.mqFaultStrategy.startDetector();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-49" target="4EuGsi6HqrbHvLX2JFA4-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-57" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-49" target="XCCizzzmYaNoT9W5dNt4-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1720" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-49" target="XCCizzzmYaNoT9W5dNt4-10">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="510" />
              <mxPoint x="1460" y="590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-49" value="从 MQClientManager &lt;b&gt;factoryTable&lt;/b&gt; 中获取 &lt;b&gt;MQClientInstance&lt;/b&gt;, 不存在则创建&lt;br&gt;&lt;div&gt;instance = new &lt;b&gt;MQClientInstance&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;clientConfig.cloneClientConfig(),&lt;/div&gt;&lt;div&gt;this.factoryIndexGenerator.getAndIncrement(), &lt;b&gt;clientId&lt;/b&gt;, rpcHook);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1230" y="470" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-51" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;就是MQ客户端（MQClientInstance）&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;和 ProduceAccumulator 的容器, 同时也是它们的工厂&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static MQClientManager &lt;b&gt;instance&lt;/b&gt; = new MQClientManager();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AtomicInteger &lt;b&gt;factoryIndexGenerator&lt;/b&gt; = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;MQClientInstance&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, MQClientInstance&amp;gt; &lt;b&gt;factoryTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ClientId -&amp;gt;&amp;nbsp;ProduceAccumulator&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentMap&amp;lt;String, ProduceAccumulator&amp;gt; &lt;b&gt;accumulatorTable&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ConcurrentHashMap&amp;lt;String, ProduceAccumulator&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public MQClientInstance getOrCreateMQClientInstance(...)&amp;nbsp;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public ProduceAccumulator getOrCreateProduceAccumulator(final ClientConfig clientConfig)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-560" y="1840" width="520" height="200" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-52" value="MQClientInstance prev = this.factoryTable&lt;br&gt;.&lt;b&gt;putIfAbsent&lt;/b&gt;(clientId,instance);&lt;br&gt;if (prev != null)&amp;nbsp;instance = prev;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;前面还在迷惑为何没有加锁，原来是这里借助 putIfAbsent 原子操作实现的并发同步&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="1240" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-54" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;尽管这步之前可能同时有多个线程创建客户端实例&lt;br style=&quot;font-size: 10px;&quot;&gt;但是因为 putIfAbsent 是原子操作（见源码注释）&lt;br style=&quot;font-size: 10px;&quot;&gt;如果clientId键的值已经存在，会改回之前的值，&lt;br style=&quot;font-size: 10px;&quot;&gt;最终instance一定是最先创建的那个实例&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1450" y="640" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientInstance&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;保存一个客户端实例上所有分组的消息生产者、消费者、MQAdminExtInner, 同时提供与NameServer Broker 通信、处理消息的能力（也即一个客户端实例上的生产者、消费者使用的是同一个客户端连接）&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientConfig clientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String clientId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long bootTimestamp = System.currentTimeMillis();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// &lt;b&gt;groupName&lt;/b&gt; -&amp;gt; &lt;b&gt;DefaultMQProducerImpl&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, &lt;b&gt;MQProducerInner&lt;/b&gt;&amp;gt; &lt;b&gt;producerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQConsumerInner&amp;gt; &lt;b&gt;consumerTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MQAdminExtInner&amp;gt; &lt;b&gt;adminExtTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig nettyClientConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MQClientAPIImpl&lt;/b&gt; &lt;b&gt;mQClientAPIImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MQAdminImpl&lt;/b&gt; &lt;b&gt;mQAdminImpl&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Topic -&amp;gt; TopicRouteData&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, TopicRouteData&amp;gt; &lt;b&gt;topicRouteTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, ConcurrentMap&amp;lt;MessageQueue, String&amp;gt;&amp;gt; &lt;b&gt;topicEndPointsTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockNamesrv = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockHeartbeat = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;Long, String&amp;gt;&amp;gt; brokerAddrTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Broker name -&amp;gt; ( address -&amp;gt; version )&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, HashMap&amp;lt;String, Integer&amp;gt;&amp;gt; brokerVersionTable = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//Broker address&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String&amp;gt; brokerSupportV2HeartbeatSet = new HashSet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Integer&amp;gt; brokerAddrHeartbeatFingerprintTable = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(r -&amp;gt; new Thread(r, &quot;MQClientFactoryScheduledThread&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService fetchRemoteConfigExecutorService = Executors.newSingleThreadScheduledExecutor(...);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PullMessageService &lt;b&gt;pullMessageService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RebalanceService &lt;b&gt;rebalanceService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DefaultMQProducer &lt;b&gt;defaultMQProducer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConsumerStatsManager &lt;b&gt;consumerStatsManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ServiceState serviceState = ServiceState.CREATE_JUST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Random random = new Random();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="1840" width="520" height="520" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-69" target="XCCizzzmYaNoT9W5dNt4-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-69" value="msg.setTopic(&lt;br&gt;withNamespace(msg.getTopic()));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-71" target="4EuGsi6HqrbHvLX2JFA4-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-71" value="this.mQClientAPIImpl&lt;br&gt;.fetchNameServerAddr();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-73" value="List&amp;lt;String&amp;gt; topics = this.defaultMQProducer.getTopics();&lt;br&gt;topics.forEach(topic -&amp;gt; {&lt;br&gt;TopicPublishInfo topicPublishInfo = &lt;b&gt;tryToFindTopicPublishInfo&lt;/b&gt;(newTopic);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1870" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-78" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-75" target="4EuGsi6HqrbHvLX2JFA4-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-75" target="XCCizzzmYaNoT9W5dNt4-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-75" value="this.&lt;b&gt;mQClientAPIImpl&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-80" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-77" target="4EuGsi6HqrbHvLX2JFA4-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-77" target="XCCizzzmYaNoT9W5dNt4-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-77" value="this.&lt;b&gt;startScheduledTask&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一些定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-79" target="4EuGsi6HqrbHvLX2JFA4-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-63" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-79" target="XCCizzzmYaNoT9W5dNt4-62">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-79" value="this.&lt;b&gt;pullMessageService&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动一个守护线程&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="4EuGsi6HqrbHvLX2JFA4-82" target="4EuGsi6HqrbHvLX2JFA4-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-67" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-82" target="XCCizzzmYaNoT9W5dNt4-66">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-82" value="this.&lt;b&gt;rebalanceService&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" edge="1" parent="1" source="4EuGsi6HqrbHvLX2JFA4-84" target="4EuGsi6HqrbHvLX2JFA4-32">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="1810" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1460" y="1810" />
              <mxPoint x="1460" y="1850" />
              <mxPoint x="740" y="1850" />
              <mxPoint x="740" y="445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="4EuGsi6HqrbHvLX2JFA4-84" value="this.defaultMQProducer&lt;br&gt;.&lt;b&gt;getDefaultMQProducerImpl&lt;/b&gt;().start(false);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&amp;nbsp;DefaultMQProducerImpl，即一个消息分组对应的消息生产者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MQProducerInner&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;（I）&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="1000" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-3" value="&lt;b&gt;clientId 生成规则&lt;/b&gt;： ClientIP@instanceName&lt;br&gt;@unitName@StreamRequestType&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;后面两部分可能没有，比如192.168.1.5@74854#15296806586016&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-4" value="&lt;b style=&quot;&quot;&gt;instanceName 命名规则&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;： 如果前面没有指定实例名（默认是DEFAULT）&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里会更改为 &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;PID#System.nanoTime()&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1210" y="410" width="350" height="40" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MQClientAPIImpl&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static boolean sendSmartMsg =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Boolean.parseBoolean(System.getProperty(&quot;org.apache.rocketmq.client.sendSmartMsg&quot;, &quot;true&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;RemotingClient&lt;/b&gt; &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final TopAddressing topAddressing;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ClientRemotingProcessor clientRemotingProcessor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String nameSrvAddr = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ClientConfig &lt;b&gt;clientConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; getNameServerAddressList()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public RemotingClient getRemotingClient()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String fetchNameServerAddr()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String onNameServerAddressChange(String namesrvAddress)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void start()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void shutdown()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createSubscriptionGroup(final String addr, final SubscriptionGroupConfig config,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis) throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;createTopic&lt;/b&gt;(final String addr, final String defaultTopic, final TopicConfig topicConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void createPlainAccessConfig(final String addr, final PlainAccessConfig plainAccessConfig,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void deleteAccessConfig(final String addr, final String accessKey, final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throws RemotingException, InterruptedException, MQClientException&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void updateGlobalWhiteAddrsConfig(final String addr, final String globalWhiteAddrs, String aclFileFullPath,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long timeoutMillis)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SendResult &lt;b&gt;sendMessage&lt;/b&gt;(...)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1680" y="1840" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-10" value="实例化 MQClientInstance 内部组件，包括&lt;br&gt;&lt;b&gt;MQClientAPIImpl、mQAdminImpl、pullMessageService、rebalanceService、defaultMQProducer、consumerStatsManager&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-12" target="XCCizzzmYaNoT9W5dNt4-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-12" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-14" target="XCCizzzmYaNoT9W5dNt4-17">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-14" target="XCCizzzmYaNoT9W5dNt4-19">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-14" value="Netty客户端Bootstrap初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里只关注后面pipeline中最后两个Handler&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#ea6b66&quot;&gt;奇怪暂时没有找到哪里启动连接，todo: 可能在其他类中获取Bootstrap并启动的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-16" target="XCCizzzmYaNoT9W5dNt4-25">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-16" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends NettyRemotingAbstract implements &lt;b&gt;RemotingClient&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long LOCK_TIMEOUT_MILLIS = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long MIN_CLOSE_TIMEOUT_MILLIS = 100;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;Bootstrap&lt;/b&gt; &lt;b&gt;bootstrap&lt;/b&gt; = new Bootstrap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup &lt;b&gt;eventLoopGroupWorker&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock lockChannelTables = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String /* cidr */, SocksProxyConfig /* proxy */&amp;gt; proxyMap = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;String /* cidr */, Bootstrap&amp;gt; &lt;b&gt;bootstrapMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String /* addr */, ChannelWrapper&amp;gt; channelTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, ChannelWrapper&amp;gt; channelWrapperTables = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定时任务执行器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HashedWheelTimer&lt;/b&gt; &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(r -&amp;gt; new Thread(r, &quot;ClientHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;List&amp;lt;String&amp;gt;&amp;gt; namesrvAddrList = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, Boolean&amp;gt; availableNamesrvAddrMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;String&amp;gt; namesrvAddrChoosed = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger namesrvIndex = new AtomicInteger(initValueIndex());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Lock namesrvChannelLock = new ReentrantLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService publicExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService scanExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService callbackExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// RocketMQ 自定义事件的监听器，todo 这些事件的作用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener &lt;b&gt;channelEventListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="1840" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-17" value="&lt;div&gt;ch.pipeline().addLast(&lt;/div&gt;&lt;div&gt;nettyClientConfig.isDisableNettyWorkerGroup() ? null : defaultEventExecutorGroup,&lt;/div&gt;&lt;div&gt;new NettyEncoder(), new NettyDecoder(),&lt;/div&gt;&lt;div&gt;new IdleStateHandler(0, 0, nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),&lt;/div&gt;&lt;div&gt;new &lt;b&gt;NettyConnectManageHandler&lt;/b&gt;(), new &lt;b&gt;NettyClientHandler&lt;/b&gt;());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1960" y="900" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-19" target="XCCizzzmYaNoT9W5dNt4-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-19" target="XCCizzzmYaNoT9W5dNt4-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-19" value="&lt;b&gt;nettyEventExecutor&lt;/b&gt;.start();&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动&lt;b&gt;一个守护线程&lt;/b&gt;，线程阻塞读取自身eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;即生产者消费者模式，执行事件监听回调&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-21" target="XCCizzzmYaNoT9W5dNt4-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-21" target="XCCizzzmYaNoT9W5dNt4-34">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-21" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;timer也是启动了一个线程，处理定义任务，这里提交了个TimerTask任务 3秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-23" target="XCCizzzmYaNoT9W5dNt4-36">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-23" value="this.&lt;b&gt;timer&lt;/b&gt;.newTimeout(&lt;br&gt;&lt;b&gt;timerTaskScanAvailableNameSrv&lt;/b&gt;, 0, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里提交了个TimerTask任务 0秒后执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-25" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;核心是Netty客户端&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreOneway;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreAsync;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; responseTable =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;&amp;gt; processorTable =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new HashMap&amp;lt;&amp;gt;(64);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于启动一个守护线程，线程阻塞读取eventQueue中的事件，然后根据事件类型分发给监听器的对应的处理器方法&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor &lt;b&gt;nettyEventExecutor&lt;/b&gt; = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; rpcHooks = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-2240" y="1560" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-27" target="XCCizzzmYaNoT9W5dNt4-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-27" value="&lt;b&gt;NettyEventExecutor#run()&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事件监听回调，事件包括：IDLE、CLOSE、CONNET、EXCEPTION、ACTIVIE&lt;br&gt;这些事件是 RocketMQ中定义的&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-31" value="ChannelEventListener#onChannelXxx()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2200" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-33" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;疑问：&lt;br&gt;1 为何实现HashedWheelTimer处理定时任务，不用JDK中现成的类？&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="600" y="20" width="640" height="100" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-34" value="NettyRemotingClient.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this, 1000, TimeUnit.MILLISECONDS);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期调用scanResponseTable()扫描已弃用的请求并使其过期&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="1050" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-36" value="NettyRemotingClient&lt;br&gt;.this.&lt;b&gt;scanAvailableNameSrv&lt;/b&gt;();&lt;br&gt;timer.&lt;b&gt;newTimeout&lt;/b&gt;(this,connectTimeoutMillis, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-41" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;即每秒处理一下 responseTable 中的超时请求&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2170" y="1075" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-42" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;即定期更新一下可用NameServer地址&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2170" y="1155" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-43" target="XCCizzzmYaNoT9W5dNt4-46">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-43" target="XCCizzzmYaNoT9W5dNt4-48">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-55" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-43" target="XCCizzzmYaNoT9W5dNt4-50">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-43" target="XCCizzzmYaNoT9W5dNt4-52">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-61" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-43" target="XCCizzzmYaNoT9W5dNt4-59">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-43" value="通过 this.scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleAtFixedRate&lt;/b&gt;() 一共提交了4个定时任务" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-45" value="MQClientInstance" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1280" y="790" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-46" value="MQClientInstance.this.mQClientAPIImpl&lt;br&gt;.&lt;b&gt;fetchNameServerAddr&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-48" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;updateTopicRouteInfoFromNameServer&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-50" value="MQClientInstance.this.&lt;b&gt;cleanOfflineBroker&lt;/b&gt;();&lt;br&gt;MQClientInstance.this&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-52" target="XCCizzzmYaNoT9W5dNt4-59">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-52" value="MQClientInstance.this&lt;br&gt;.&lt;b&gt;persistAllConsumerOffset&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-59" value="MQClientInstance.this.&lt;b&gt;adjustThreadPool&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-65" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-62" target="XCCizzzmYaNoT9W5dNt4-64">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-62" value="PullMessageService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-64" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;while:&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MessageRequest messageRequest = this.&lt;b style=&quot;font-size: 9px;&quot;&gt;messageRequestQueue&lt;/b&gt;.take();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (messageRequest.&lt;b style=&quot;font-size: 9px;&quot;&gt;getMessageRequestMode&lt;/b&gt;() == MessageRequestMode.POP) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.popMessage((PopRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; this.pullMessage((PullRequest) messageRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=6;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1610" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-66" target="XCCizzzmYaNoT9W5dNt4-68">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-66" value="RebalanceService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-68" value="todo" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-72" value="&lt;font color=&quot;#007fff&quot;&gt;这里 defaultMQProducer 是内部Producer, 分组为 CLIENT_INNER_PRODUCER&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1480" y="1795" width="450" height="30" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-73" value="this.serviceState = ServiceState.RUNNING;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-75" target="XCCizzzmYaNoT9W5dNt4-77">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-75" value="this.mQClientFactory&lt;br&gt;.&lt;b&gt;sendHeartbeatToAllBrokerWithLock&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-77" value="RequestFutureHolder.getInstance()&lt;br&gt;.&lt;b&gt;startScheduledTask&lt;/b&gt;(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动定时任务，用于每秒扫描一下过期请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-79" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RequestFutureHolder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final RequestFutureHolder INSTANCE = new RequestFutureHolder();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConcurrentHashMap&amp;lt;String, RequestResponseFuture&amp;gt; &lt;b&gt;requestFutureTable&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;DefaultMQProducerImpl&amp;gt; &lt;b&gt;producerSet&lt;/b&gt; = new HashSet&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1560" y="1120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-81" target="XCCizzzmYaNoT9W5dNt4-85">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-88" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-81" target="XCCizzzmYaNoT9W5dNt4-87">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-81" value="guardThreadForSyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行同步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-90" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-85" target="XCCizzzmYaNoT9W5dNt4-89">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-85" value="guardThreadForAsyncSend.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动线程执行异步批量发送&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-87" value="GuardForSyncSendService#run();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-89" value="GuardForAsyncSendService#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-91" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Message&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private String &lt;b&gt;topic&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;flag&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//一些约定好的属性KEY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// KEYS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// TAGS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;DELAY&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;WAIT&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;INSTANCE_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// BUYER_ID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_SEC&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELAY_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;TIMER_DELIVER_MS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, String&amp;gt; &lt;b&gt;properties&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息体&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private byte[] &lt;b&gt;body&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;transactionId&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-560" y="2400" width="520" height="280" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="XCCizzzmYaNoT9W5dNt4-92" target="XCCizzzmYaNoT9W5dNt4-94">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-92" value="return this.defaultMQProducerImpl.&lt;b&gt;send&lt;/b&gt;(msg, timeout);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XCCizzzmYaNoT9W5dNt4-94" value="" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="2360" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="3BUzB-CuzncaUeyYl-aW" name="NameServer">
    <mxGraphModel dx="2609" dy="630" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="uRtEAP2a5k4lkSkrBafr-164" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="2100" y="1720" width="240" height="420" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-163" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="2100" y="1200" width="240" height="500" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="AJX_MhfLM1ez97IJH3E7-1" target="uRtEAP2a5k4lkSkrBafr-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AJX_MhfLM1ez97IJH3E7-1" value="命名服务启动&lt;br&gt;NamesrvStartup#main()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-1" target="uRtEAP2a5k4lkSkrBafr-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-1" value="parseCommandlineAndConfigFile(args);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-3" target="uRtEAP2a5k4lkSkrBafr-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-3" value="NamesrvController controller = createAndStartNamesrvController();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-5" target="uRtEAP2a5k4lkSkrBafr-86">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-5" value="controllerManagerMain();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;不是必须的先略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-7" target="uRtEAP2a5k4lkSkrBafr-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-7" value="CommandLine commandLine = ServerUtil.&lt;b&gt;parseCmdLine&lt;/b&gt;(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options), new DefaultParser());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;使用Commons-cli工具解析命令行参数&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-9" value="将命令行参数 -c&amp;nbsp; 指定的文件中的属性加载到&amp;nbsp;&lt;b&gt;namesrvConfig&lt;/b&gt;、&lt;b&gt;nettyServerConfig&lt;/b&gt;、&amp;nbsp;&lt;b&gt;nettyClientConfig、controllerConfig&lt;/b&gt;&lt;br&gt;&amp;nbsp;等字段" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;NamesrvStartup&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static Properties &lt;b&gt;properties&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static ControllerConfig &lt;b&gt;controllerConfig&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="80" width="520" height="120" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-12" target="uRtEAP2a5k4lkSkrBafr-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-12" value="NamesrvController controller = &lt;b&gt;createNamesrvController&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-14" target="uRtEAP2a5k4lkSkrBafr-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-14" value="start(controller);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="uRtEAP2a5k4lkSkrBafr-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-16" target="uRtEAP2a5k4lkSkrBafr-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-16" value="final NamesrvController controller = new NamesrvController(namesrvConfig, nettyServerConfig, nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-18" value="controller.getConfiguration()&lt;br&gt;.registerConfig(properties);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NamesrvController&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig &lt;b&gt;nettyServerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyClientConfig &lt;b&gt;nettyClientConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scanExecutorService&lt;/b&gt; = ThreadUtils.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BasicThreadFactory.Builder().namingPattern(&quot;NSScanScheduledThread&quot;).daemon(true).build());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//配置属性的容器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Namespace -&amp;gt; （Key -&amp;gt; Value）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final KVConfigManager &lt;b&gt;kvConfigManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RouteInfoManager &lt;b&gt;routeInfoManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingClient &lt;b&gt;remotingClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingServer &lt;b&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//实现ChannelEventListener，默认会回调 routeInfoManager 的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BrokerHousekeepingService &lt;b&gt;brokerHousekeepingService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService defaultExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService clientRequestExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; defaultThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private BlockingQueue&amp;lt;Runnable&amp;gt; clientRequestThreadPoolQueue;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Configuration &lt;b&gt;configuration&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private FileWatchService fileWatchService;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="240" width="520" height="360" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-21" target="uRtEAP2a5k4lkSkrBafr-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-21" value="this.brokerHousekeepingService = new &lt;b&gt;BrokerHousekeepingService&lt;/b&gt;(this);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个实例其实是ChannelEventListener&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-23" target="uRtEAP2a5k4lkSkrBafr-25">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-23" value="this.&lt;b&gt;routeInfoManager&lt;/b&gt; = new RouteInfoManager(namesrvConfig, this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-25" value="&amp;nbsp;this.configuration = new &lt;b&gt;Configuration&lt;/b&gt;(LOGGER, this.namesrvConfig, this.nettyServerConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RouteInfoManager&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final static long DEFAULT_BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ReadWriteLock lock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String, QueueData&amp;gt;&amp;gt; &lt;b&gt;topicQueueTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* brokerName */, BrokerData&amp;gt; &lt;b&gt;brokerAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* clusterName */, Set&amp;lt;String/* brokerName */&amp;gt;&amp;gt; &lt;b&gt;clusterAddrTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, BrokerLiveInfo&amp;gt; &lt;b&gt;brokerLiveTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;BrokerAddrInfo/* brokerAddr */, List&amp;lt;String&amp;gt;/* Filter Server */&amp;gt; &lt;b&gt;filterServerTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String/* topic */, Map&amp;lt;String/*brokerName*/, TopicQueueMappingInfo&amp;gt;&amp;gt; &lt;b&gt;topicQueueMappingInfoTable&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final BatchUnregistrationService &lt;b&gt;unRegisterService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvController &lt;b&gt;namesrvController&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NamesrvConfig &lt;b&gt;namesrvConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="240" width="520" height="240" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-28" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Configuration&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;Object&amp;gt; &lt;b&gt;configObjectList&lt;/b&gt; = new ArrayList&amp;lt;&amp;gt;(4);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String storePath;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean storePathFromConfig = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Object storePathObject;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Field storePathField;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DataVersion dataVersion = new DataVersion();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ReadWriteLock readWriteLock = new ReentrantReadWriteLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Properties &lt;b&gt;allConfigs&lt;/b&gt; = new Properties();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="520" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-29" target="uRtEAP2a5k4lkSkrBafr-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-29" value="boolean initResult = controller.initialize();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-31" target="uRtEAP2a5k4lkSkrBafr-33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-31" value="Runtime.getRuntime().addShutdownHook(...);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-33" target="uRtEAP2a5k4lkSkrBafr-80">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-33" value="controller.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-35" target="uRtEAP2a5k4lkSkrBafr-49">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-35" value="loadConfig();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-39">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-37" target="uRtEAP2a5k4lkSkrBafr-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-37" value="initiateNetworkComponents();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个Netty客户端和一个服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-39" target="uRtEAP2a5k4lkSkrBafr-59">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-39" value="initiateThreadExecutors();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建两个线程池&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-41" target="uRtEAP2a5k4lkSkrBafr-63">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-41" value="registerProcessor();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;向Netty服务端中注册请求的处理器，以及线程池（就是上面创建的线程池）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-45">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-68">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-70">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-43" target="uRtEAP2a5k4lkSkrBafr-72">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-43" value="startScheduleService();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动3个定时任务&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-45" target="uRtEAP2a5k4lkSkrBafr-76">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-45" value="initiateSslContext();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置SSL, 启动一个线程监听证书和密钥文件的变化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-47" target="uRtEAP2a5k4lkSkrBafr-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-47" value="initiateRpcHooks();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注册RPCHook, 用于拓展请求前和响应后的处理逻辑&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-49" value="this.kvConfigManager.load();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1241" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-51" target="uRtEAP2a5k4lkSkrBafr-94">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1480" y="590" />
              <mxPoint x="1480" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-51" value="this.&lt;b&gt;remotingServer&lt;/b&gt; = new &lt;b&gt;NettyRemotingServer&lt;/b&gt;(&lt;br&gt;this.nettyServerConfig, this.brokerHousekeepingService);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1240.5" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-53" target="uRtEAP2a5k4lkSkrBafr-107">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-53" value="this.&lt;b&gt;remotingClient&lt;/b&gt; = new &lt;b&gt;NettyRemotingClient&lt;/b&gt;(this.nettyClientConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1240" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-91" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-55" target="uRtEAP2a5k4lkSkrBafr-92">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-300" y="1040" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingServer &lt;/b&gt;extends NettyRemotingAbstract implements RemotingServer&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServerBootstrap &lt;b&gt;serverBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupSelector;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup eventLoopGroupBoss;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final NettyServerConfig nettyServerConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;publicExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ScheduledExecutorService &lt;b&gt;scheduledExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelEventListener channelEventListener;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HashedWheelTimer &lt;b&gt;timer&lt;/b&gt; = new HashedWheelTimer(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; r -&amp;gt; new Thread(r, &quot;ServerHouseKeepingService&quot;));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DefaultEventExecutorGroup defaultEventExecutorGroup;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//NettyRemotingServer可能包含多个SubRemotingServer&lt;br&gt;//监听端口 -&amp;gt; NettyRemotingAbstract&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Integer/*Port*/, NettyRemotingAbstract&amp;gt; &lt;b&gt;remotingServerTable&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HANDSHAKE_HANDLER_NAME = &quot;handshakeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_DECODER = &quot;HAProxyDecoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String HA_PROXY_HANDLER = &quot;HAProxyHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_MODE_HANDLER = &quot;TlsModeHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String TLS_HANDLER_NAME = &quot;sslHandler&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String FILE_REGION_ENCODER_NAME = &quot;fileRegionEncoder&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TlsModeHandler tlsModeHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyEncoder encoder;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyConnectManageHandler connectionManageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyServerHandler &lt;b&gt;serverHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private RemotingCodeDistributionHandler distributionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="1080" width="520" height="400" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-56" target="uRtEAP2a5k4lkSkrBafr-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-56" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingClient&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends NettyRemotingAbstract implements RemotingClient&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1120" y="1080" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-59" target="uRtEAP2a5k4lkSkrBafr-61">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-59" value="this.&lt;b&gt;defaultExecutor&lt;/b&gt; = ThreadUtils.&lt;b style=&quot;font-size: 10px;&quot;&gt;newThreadPoolExecutor&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;this.namesrvConfig.getDefaultThreadPoolNums(), this.namesrvConfig.getDefaultThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.&lt;b style=&quot;font-size: 10px;&quot;&gt;defaultThreadPoolQueue&lt;/b&gt;, new ThreadFactoryImpl(&quot;&lt;b&gt;RemotingExecutorThread_&lt;/b&gt;&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1220" y="720" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-61" value="this.&lt;b&gt;clientRequestExecutor&lt;/b&gt; = ThreadUtils.&lt;b&gt;newThreadPoolExecutor&lt;/b&gt;(&lt;br&gt;this.namesrvConfig.getClientRequestThreadPoolNums(), this.namesrvConfig.getClientRequestThreadPoolNums(), 1000 * 60, TimeUnit.MILLISECONDS, this.clientRequestThreadPoolQueue, new ThreadFactoryImpl(&quot;&lt;b&gt;ClientRequestExecutorThread_&lt;/b&gt;&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1210" y="820" width="260" height="90" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-63" target="uRtEAP2a5k4lkSkrBafr-65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-63" value="Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; pair = new Pair&amp;lt;&amp;gt;(processor, &lt;b&gt;executorThis&lt;/b&gt;);&lt;br&gt;this.&lt;b&gt;processorTable&lt;/b&gt;.put(requestCode, pair);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;processor 是&amp;nbsp;&lt;b&gt;ClientRequestProcessor&lt;/b&gt; 实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1230" y="940" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-65" value="this.&lt;b&gt;defaultRequestProcessorPair&lt;/b&gt; = new Pair&amp;lt;&amp;gt;(processor, &lt;b&gt;executor&lt;/b&gt;);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;processor 是&amp;nbsp;&lt;b&gt;DefaultRequestProcessor&lt;/b&gt; 实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1020" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-67" value="&lt;b&gt;NettyRemotingServer&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1265" y="910" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-68" value="NamesrvController.this.routeInfoManager&lt;br&gt;::&lt;b&gt;scanNotActiveBroker&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-70" value="NamesrvController.this.kvConfigManager&lt;br&gt;::&lt;b&gt;printAllPeriodically&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-72" value="NamesrvController.this.&lt;b&gt;printWaterMark&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-76" value="fileWatchService = new FileWatchService(watchFiles, listener);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-78" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.&lt;b&gt;registerRPCHook&lt;/b&gt;(&lt;br&gt;new ZoneRouteRPCHook());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="uRtEAP2a5k4lkSkrBafr-82">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-80" target="uRtEAP2a5k4lkSkrBafr-113">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-80" value="this.&lt;b&gt;remotingServer&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-85" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-82" target="uRtEAP2a5k4lkSkrBafr-84">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-82" value="this.&lt;b&gt;remotingClient&lt;/b&gt;.start();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动Netty客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-84" value="this.&lt;b&gt;routeInfoManager&lt;/b&gt;.start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="2420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-86" value="createAndStartControllerManager();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-92" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NettyRemotingAbstract&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的单向请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreOneway;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 限制正在进行的异步请求的最大数量的信号量，以保护系统的内存占用。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Semaphore semaphoreAsync;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此映射缓存所有正在进行的请求。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentMap&amp;lt;Integer /* opaque */, ResponseFuture&amp;gt; responseTable = new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此容器保存每个请求代码的所有处理器，即对于每个传入的请求，我们可以在此映射中查找响应的处理器来处理请求。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/* request code */, Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;&amp;gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp;processorTable = new HashMap&amp;lt;&amp;gt;(64);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 将 netty 事件传递给用户定义的 {@link ChannelEventListener} 的执行器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final NettyEventExecutor nettyEventExecutor = new NettyEventExecutor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 在没有在 {@link #processorTable} 中找到精确匹配的情况下使用的默认请求处理器。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; defaultRequestProcessorPair;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于创建 {@link SslHandler} 的 SSL 上下文。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile SslContext sslContext;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自定义 RPC 钩子。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected List&amp;lt;RPCHook&amp;gt; rpcHooks = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-560" y="720" width="520" height="320" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-97" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-94" target="uRtEAP2a5k4lkSkrBafr-96">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-94" value="&lt;div&gt;this.semaphoreOneway = new Semaphore(permitsOneway, true);&lt;/div&gt;&lt;div&gt;this.semaphoreAsync = new Semaphore(permitsAsync, true);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1520.5" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-96" target="uRtEAP2a5k4lkSkrBafr-98">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-96" value="this.serverBootstrap = new ServerBootstrap();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1520.5" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-98" target="uRtEAP2a5k4lkSkrBafr-100">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-104" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-98" target="uRtEAP2a5k4lkSkrBafr-103">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-98" value="this.&lt;b&gt;publicExecutor&lt;/b&gt; = buildPublicExecutor(nettyServerConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1520" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-106" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-100" target="uRtEAP2a5k4lkSkrBafr-105">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-100" value="this.&lt;b&gt;scheduledExecutorService&lt;/b&gt; = buildScheduleExecutor();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="1520" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-102" value="注意下面代码流程中省略了一些细节" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="20" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-103" value="return Executors.&lt;b&gt;newFixedThreadPool&lt;/b&gt;(&lt;br&gt;publicThreadNums, new ThreadFactoryImpl(&lt;br&gt;&quot;&lt;b&gt;NettyServerPublicExecutor_&lt;/b&gt;&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-105" value="&lt;div&gt;return ThreadUtils.&lt;b&gt;newScheduledThreadPool&lt;/b&gt;(1,&lt;/div&gt;&lt;div&gt;new ThreadFactoryImpl(&lt;/div&gt;&lt;div&gt;&quot;&lt;b&gt;NettyServerScheduler_&lt;/b&gt;&quot;, true),&lt;/div&gt;&lt;div&gt;new ThreadPoolExecutor.DiscardOldestPolicy());&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1750" y="560" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-110" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-107" target="uRtEAP2a5k4lkSkrBafr-109">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-107" value="&lt;div&gt;this.semaphoreOneway = new Semaphore(permitsOneway, true);&lt;/div&gt;&lt;div&gt;this.semaphoreAsync = new Semaphore(permitsAsync, true);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1520" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-109" target="uRtEAP2a5k4lkSkrBafr-111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-109" value="this.&lt;b&gt;publicExecutor&lt;/b&gt; = Executors.&lt;b&gt;newFixedThreadPool&lt;/b&gt;(&lt;br&gt;publicThreadNums, new ThreadFactoryImpl(&lt;br&gt;&quot;&lt;b&gt;NettyClientPublicExecutor_&lt;/b&gt;&quot;));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1520" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-111" value="&lt;div&gt;this.&lt;b&gt;scanExecutor&lt;/b&gt; = ThreadUtils.&lt;b&gt;newThreadPoolExecutor&lt;/b&gt;(4, 10, 60, TimeUnit.SECONDS,&lt;/div&gt;&lt;div&gt;new ArrayBlockingQueue&amp;lt;&amp;gt;(32), &lt;br&gt;new ThreadFactoryImpl(&lt;/div&gt;&lt;div&gt;&quot;NettyClientScan_thread_&quot;));&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1520" y="800" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-113" target="uRtEAP2a5k4lkSkrBafr-115">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-113" value="&lt;div&gt;this.&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt; = &lt;br&gt;new DefaultEventExecutorGroup(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建用于处理Netty事件的线程池&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1500" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-117">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-115" target="uRtEAP2a5k4lkSkrBafr-119">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-115" value="prepareSharableHandlers();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1580" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-117" value="tlsModeHandler = new TlsModeHandler(TlsSystemConfig.tlsMode);&lt;br&gt;&lt;b&gt;encoder&lt;/b&gt; = new NettyEncoder();&lt;br&gt;&lt;b&gt;connectionManageHandler&lt;/b&gt; = new NettyConnectManageHandler();&lt;br&gt;&lt;b&gt;serverHandler&lt;/b&gt; = new NettyServerHandler();&lt;br&gt;&lt;b&gt;distributionHandler&lt;/b&gt; = new RemotingCodeDistributionHandler();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1470" y="1560" width="220" height="100" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-122" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-126" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-119" target="uRtEAP2a5k4lkSkrBafr-125">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-119" value="serverBootstrap 初始化配置" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1680" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-124" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-121" target="uRtEAP2a5k4lkSkrBafr-123">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-121" value=".childHandler((ChannelInitializer)ch -&amp;gt; {&lt;br&gt;&lt;b&gt;configChannel&lt;/b&gt;(ch);&lt;br&gt;});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480.5" y="1680" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-173" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.508;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;dashed=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-123" target="uRtEAP2a5k4lkSkrBafr-145">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2070" y="1710" />
              <mxPoint x="2070" y="1170" />
              <mxPoint x="2221" y="1170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-123" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;return ch.pipeline()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;, HANDSHAKE_HANDLER_NAME, new &lt;b&gt;HandshakeHandler&lt;/b&gt;())&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .addLast(&lt;b&gt;defaultEventExecutorGroup&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;encoder&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;NettyDecoder&lt;/b&gt;(),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;distributionHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;IdleStateHandler&lt;/b&gt;(0, 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;connectionManageHandler&lt;/b&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;serverHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; );&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=4;" vertex="1" parent="1">
          <mxGeometry x="1720" y="1630" width="319.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-128" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-125" target="uRtEAP2a5k4lkSkrBafr-127">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-125" value="addCustomConfig(serverBootstrap);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;为 serverBootstrap 设置额外的&amp;nbsp;childOption&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1820" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-127" target="uRtEAP2a5k4lkSkrBafr-129">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-127" value="ChannelFuture sync = serverBootstrap.bind().sync();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1900" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-129" target="uRtEAP2a5k4lkSkrBafr-131">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-129" value="this.&lt;b&gt;remotingServerTable&lt;/b&gt;.put(&lt;br&gt;this.nettyServerConfig.getListenPort(), this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="1980" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-131" target="uRtEAP2a5k4lkSkrBafr-133">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-131" value="&lt;div&gt;if (this.channelEventListener != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.nettyEventExecutor.start();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;启动监听Netty事件的线程&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2060" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-135">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-133" target="uRtEAP2a5k4lkSkrBafr-139">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-133" value="this.timer.newTimeout(&lt;br&gt;&lt;b&gt;timerScanResponseTable&lt;/b&gt;, 1000 * 3, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2140" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-135" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;scanResponseTable&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定期扫描并处理过期的请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1480.5" y="2140" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-139" target="uRtEAP2a5k4lkSkrBafr-141">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-139" value="scheduledExecutorService&lt;br&gt;.&lt;b&gt;scheduleWithFixedDelay&lt;/b&gt;(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-141" value="NettyRemotingServer.this&lt;br&gt;.&lt;b&gt;printRemotingCodeDistribution&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1480.5" y="2220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="uRtEAP2a5k4lkSkrBafr-161">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-178" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-145" target="uRtEAP2a5k4lkSkrBafr-148">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-145" value="HandshakeHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;握手处理，借助&lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;检测通信协议类型, 这个主要是为了支持&lt;b&gt;HAProxy&lt;/b&gt;代理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120" y="1220" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-179" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-148" target="uRtEAP2a5k4lkSkrBafr-150">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-148" value="NettyDecoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120" y="1300" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-180" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-150" target="uRtEAP2a5k4lkSkrBafr-151">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-150" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120" y="1380" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-181" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-151" target="uRtEAP2a5k4lkSkrBafr-154">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-151" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120.5" y="1460" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-182" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-154" target="uRtEAP2a5k4lkSkrBafr-155">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-154" value="NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120.5" y="1540" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-183" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-155" target="uRtEAP2a5k4lkSkrBafr-171">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-155" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2120" y="1620" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-161" value="&lt;div&gt;if (detectionResult.state() == ProtocolDetectionState.DETECTED) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), HA_PROXY_DECODER, new &lt;b&gt;HAProxyMessageDecoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_DECODER, HA_PROXY_HANDLER, new &lt;b&gt;HAProxyMessageHandler&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addAfter(defaultEventExecutorGroup, HA_PROXY_HANDLER, TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ctx.pipeline().addAfter(defaultEventExecutorGroup, ctx.name(), TLS_MODE_HANDLER, &lt;b&gt;tlsModeHandler&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ctx.pipeline().remove(this);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="2359" y="1190" width="601" height="120" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-166" value="NettyEncoder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2119" y="2060" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-187" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-169" target="uRtEAP2a5k4lkSkrBafr-177">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-169" value="IdleStateHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2119" y="1900" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-185" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-170" target="uRtEAP2a5k4lkSkrBafr-169">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-170" value="NettyConnectManageHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2119.5" y="1820" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-184" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-171" target="uRtEAP2a5k4lkSkrBafr-170">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-171" value="NettyServerHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2119.5" y="1740" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-175" value="InBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2109.5" y="1180" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-176" value="OutBound" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2115" y="1700" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-188" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="uRtEAP2a5k4lkSkrBafr-177" target="uRtEAP2a5k4lkSkrBafr-166">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uRtEAP2a5k4lkSkrBafr-177" value="RemotingCodeDistributionHandler" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2119" y="1980" width="199" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="XyQ5pNo4CcYP3uo7oZJW" name="Broker">
    <mxGraphModel dx="1114" dy="756" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="Te4TJPjSaJWwIWo_xXHI" name="Consumer">
    <mxGraphModel dx="1114" dy="756" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
