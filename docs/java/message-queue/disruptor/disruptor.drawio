<mxfile host="Electron" modified="2024-10-25T12:03:58.338Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="Xh4VJ-PwnVhyIxseXYU8" version="21.6.5" type="device">
  <diagram name="第 1 页" id="EZIj7stLJ7IglIkDNbZx">
    <mxGraphModel dx="3676" dy="733" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Disruptor (4.0.0)&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;&quot;&gt;LMAX Disruptor 的定位是 线程间高性能的消息库。&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;核心源码 7K 行（70个源码文件），另外配了大量的测试代码（2W行）。&lt;/div&gt;&lt;div style=&quot;&quot;&gt;这里结合官方的几个Demo过一下源码流程。&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="440" height="90" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-2" target="fhfUE1HdMHP-IcORmnVZ-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-2" value="&lt;b&gt;LongEventMain&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;官方提供的第一个例子&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="40" y="230" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.45;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-3" target="fhfUE1HdMHP-IcORmnVZ-8">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="740" y="246" />
              <mxPoint x="740" y="770" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-10" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-9">
          <mxGeometry x="0.4417" y="-3" relative="1" as="geometry">
            <mxPoint x="3" y="137" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-3" target="fhfUE1HdMHP-IcORmnVZ-32">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="750" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-63" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-31">
          <mxGeometry x="0.555" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.376;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-3" target="fhfUE1HdMHP-IcORmnVZ-59">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="750" y="225" />
              <mxPoint x="750" y="330" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-64" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-60">
          <mxGeometry x="0.8247" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-67" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.998;exitY=0.888;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-3" target="fhfUE1HdMHP-IcORmnVZ-66">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="730" y="369" />
              <mxPoint x="730" y="1030" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-70" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-67">
          <mxGeometry x="0.9327" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-3" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事件工厂，生产事件&lt;/font&gt;&lt;/div&gt;&lt;div&gt;LongEventFactory factory = new LongEventFactory();&lt;/div&gt;&lt;div&gt;int bufferSize = 1024;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 1&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Disruptor&amp;lt;LongEvent&amp;gt; disruptor =&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new &lt;b&gt;Disruptor&lt;/b&gt;&amp;lt;&amp;gt;(factory, bufferSize, DaemonThreadFactory.INSTANCE);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 2 绑定事件消费者 （这里实际是创建了两组消费者，第一组包含两个消费者）但从后面处理模式看这种实现只是&lt;b&gt;广播&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;disruptor.&lt;b&gt;handleEventsWith&lt;/b&gt;(new LongEventHandler(1), new LongEventHandler(2));&lt;/div&gt;&lt;div&gt;disruptor.&lt;b&gt;handleEventsWith&lt;/b&gt;(new LongEventHandler(3));&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;// 3 启动 Disruptor，为每个消费者创建线程并启动&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;disruptor.&lt;b&gt;start&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;RingBuffer&amp;lt;LongEvent&amp;gt; ringBuffer = disruptor.&lt;b&gt;getRingBuffer&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;LongEventProducer producer = new &lt;b&gt;LongEventProducer&lt;/b&gt;(ringBuffer);&lt;/div&gt;&lt;div&gt;ByteBuffer bb = ByteBuffer.allocate(8);&lt;/div&gt;&lt;div&gt;for (long l = 0; true; l++)&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 每隔1s发布一次 LongEvent&lt;/font&gt;&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bb.putLong(0, l);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 4 发布 LongEvent&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; producer.&lt;b&gt;onData&lt;/b&gt;(bb);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Thread.sleep(1000);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="280" y="120" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-7" target="fhfUE1HdMHP-IcORmnVZ-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-39" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-7" target="fhfUE1HdMHP-IcORmnVZ-38">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-7" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;Disruptor&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消息发布的环形缓冲&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b&gt;RingBuffer&lt;/b&gt;&amp;lt;T&amp;gt; &lt;b&gt;ringBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 自定义线程工厂&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ThreadFactory threadFactory;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 里面主要是消费者集合&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b&gt;ConsumerRepository&lt;/b&gt; &lt;b&gt;consumerRepository&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final AtomicBoolean started;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ExceptionHandler&amp;lt;? super T&amp;gt; exceptionHandler;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// 注册Event消费者组&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final EventHandlerGroup&amp;lt;T&amp;gt; &lt;b&gt;handleEventsWith&lt;/b&gt;(EventHandler&amp;lt;? super T&amp;gt;... handlers)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-440" y="520" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-8" target="fhfUE1HdMHP-IcORmnVZ-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-8" value="&lt;div&gt;public RingBuffer&amp;lt;T&amp;gt; start() {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // CAS + AtomicBoolean&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;状态字段防止重复启动&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.checkOnlyStartedOnce();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 即遍历消费者集合为每个消费者通过&amp;nbsp; threadFactory 创建线程并启动&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;consumerRepository&lt;/b&gt;.&lt;b&gt;startAll&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;this.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;threadFactory&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return this.ringBuffer;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="760" y="720" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-11" target="fhfUE1HdMHP-IcORmnVZ-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-11" value="&lt;div&gt;this.&lt;b&gt;consumerInfos&lt;/b&gt;.forEach((c) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; c.&lt;b&gt;start&lt;/b&gt;(threadFactory);&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1240" y="740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-13" target="fhfUE1HdMHP-IcORmnVZ-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumerRepository&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;消费者仓库&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这两个Map分别用于从 EventHandlerIndentity、Sequence 查找对应的EventProcessor&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;EventHandlerIdentity, EventProcessorInfo&amp;gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; eventProcessorInfoByEventHandler&lt;/b&gt; = new IdentityHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Sequence, ConsumerInfo&amp;gt; &lt;b&gt;eventProcessorInfoBySequence&lt;/b&gt;&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; = new IdentityHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 消费者集合&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Collection&amp;lt;ConsumerInfo&amp;gt; &lt;b&gt;consumerInfos&lt;/b&gt; = new ArrayList();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fad7ac;strokeColor=#b46504;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1000" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-15" value="ConsumerRepository" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1270" y="710" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-16" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumerInfo (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;消费者接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Sequence[] getSequences();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;SequenceBarrier getBarrier();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isEndOfChain();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void start(ThreadFactory var1);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void halt();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void markAsUsedInBarrier();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isRunning();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1000" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-18" target="fhfUE1HdMHP-IcORmnVZ-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-18" target="fhfUE1HdMHP-IcORmnVZ-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-18" target="fhfUE1HdMHP-IcORmnVZ-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-18" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;EventProcessorInfo&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;ConsumerInfo 唯一的实现类，定义消费者实现，包括事件处理器和序列屏障&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;事件处理器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;EventProcessor&lt;/b&gt; &lt;b&gt;eventprocessor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;序列屏障&lt;/b&gt;，保存消费者消费记录信息&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//每组消费者（EventHandlerGroup）的 SequcenBarrier 实例相同&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;SequenceBarrier&lt;/b&gt; &lt;b&gt;barrier&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean endOfChain = true;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1300" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;EventProcessor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;b&gt;事件处理器，真正处理事件的处理器&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;重要方法：&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Sequence getSequence();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void halt();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isRunning();&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="1320" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-22" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SequenceBarrier (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;序列屏障，&lt;/b&gt;不太明白为何叫这个名字，看内部逻辑是用于&lt;b&gt;借助 WaitStrategy 实现消费者线程对事件的等待与唤醒&lt;/b&gt;，以及&lt;b&gt;记录与消费者绑定的 RingBuffer 的 cursor 指针当被唤醒后提取可消费的消息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 内部调用 WaitStrategy 等待方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long waitFor(long var1) throws AlertException, InterruptedException, TimeoutException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getCursor();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isAlerted();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void alert();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void clearAlert();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void checkAlert() throws AlertException;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1280" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-23" target="fhfUE1HdMHP-IcORmnVZ-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-23" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BatchEventProcessor&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;事件批处理器，消费线程被唤醒后会取所有可用的事件进行遍历处理&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 处理器状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int IDLE = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int HALTED = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int RUNNING = 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger running = new AtomicInteger(0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 处理除了超时、告警外的异常&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExceptionHandler&amp;lt;? super T&amp;gt; &lt;b&gt;exceptionHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 事件数据提供者，即绑定的 RingBuffer 实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final DataProvider&amp;lt;T&amp;gt; &lt;b&gt;dataProvider&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final SequenceBarrier &lt;b&gt;sequenceBarrier&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventHandlerBase&amp;lt;? super T&amp;gt; &lt;b&gt;eventHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 批处理事件数量上限，默认 Integer.MAX_VALUE&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;batchLimitOffset&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 每个事件处理器自己的消费指针&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 13px;&quot;&gt;&lt;font style=&quot;font-size: 13px;&quot;&gt;private final Sequence &lt;b style=&quot;&quot;&gt;sequence&lt;/b&gt; = new Sequence(-1L);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;private final RewindHandler &lt;b style=&quot;&quot;&gt;rewindHandler&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int retriesAttempted = 0;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="1520" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-84" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-27" target="fhfUE1HdMHP-IcORmnVZ-83">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-27" value="Thread thread = threadFactory&lt;br&gt;.&lt;b&gt;newThread&lt;/b&gt;(this.eventprocessor);&lt;br&gt;...&lt;br&gt;thread.&lt;b&gt;start&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1480" y="740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-29" value="EventProcessorInfo" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1515" y="710" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-30" target="fhfUE1HdMHP-IcORmnVZ-94">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-30" value="MultiProducerSequencer sequencer = new &lt;b&gt;MultiProducerSequencer&lt;/b&gt;(bufferSize, waitStrategy);&lt;br&gt;return new &lt;b&gt;RingBuffer&lt;/b&gt;(factory, sequencer);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="120" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-80" target="fhfUE1HdMHP-IcORmnVZ-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-32" target="fhfUE1HdMHP-IcORmnVZ-34">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-32" value="this(RingBuffer.&lt;b&gt;createMultiProducer&lt;/b&gt;(eventFactory, ringBufferSize), threadFactory);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="760" y="120" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-34" value="&lt;div&gt;this.consumerRepository = new &lt;b&gt;ConsumerRepository&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;this.started = new AtomicBoolean(false);&lt;/div&gt;&lt;div&gt;this.exceptionHandler = new ExceptionHandlerWrapper();&lt;/div&gt;&lt;div&gt;this.ringBuffer = &lt;b&gt;ringBuffer&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;this.threadFactory = threadFactory;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1241" y="200" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-42" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-36" target="fhfUE1HdMHP-IcORmnVZ-41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-36" target="fhfUE1HdMHP-IcORmnVZ-45">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-36" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RingBufferFields&amp;lt;E&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int BUFFER_PAD = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 索引掩码&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long indexMask;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 环形缓冲元素节点容器，E是存储的元素的数据类型, 发布的事件对象是先放到这里，这个数组的大小是 bufferSize + 2 * BUFFER_PAD, 因为要在前后都加上32字节的PAD留白&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final E[] &lt;b&gt;entries&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//缓存的容量，必须是2的幂指数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final int &lt;b&gt;bufferSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 意译为序列化器，用于标记缓冲当前&lt;b&gt;写指针、&lt;/b&gt;各个消费者的&lt;b&gt;消费指针&lt;/b&gt;、可用元素节点等信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final &lt;b&gt;Sequencer&lt;/b&gt; &lt;b&gt;sequencer&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="240" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-38" target="fhfUE1HdMHP-IcORmnVZ-36">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-38" target="fhfUE1HdMHP-IcORmnVZ-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-38" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RingBuffer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;环形缓冲&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; 8 * 7 个字段（一共56个字节），TODO&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected byte&amp;nbsp;p10, ..., p17, p20, ..., p77;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fad7ac;strokeColor=#b46504;" vertex="1" parent="1">
          <mxGeometry x="-880" y="520" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-41" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RingBufferPad&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//&amp;nbsp; 8 * 7 个字段（一共56个字节），TODO&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected byte p10, ..., p17, p20, ..., p77;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="120" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-43" target="fhfUE1HdMHP-IcORmnVZ-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-43" target="fhfUE1HdMHP-IcORmnVZ-74">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-43" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProcessingSequenceBarrier&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 等待策略，默认 BlockingWaitStrategy&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final WaitStrategy &lt;b&gt;waitStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 依赖的缓冲序列索引，默认和&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;cursorSequence 一致&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 13px;&quot;&gt;&lt;font style=&quot;font-size: 13px;&quot;&gt;private final Sequence &lt;b style=&quot;&quot;&gt;dependentSequence&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;// 是否有告警，反向搜索代码发现处理器抛异常会告警，Disruptor关闭时会告警&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean &lt;b&gt;alerted&lt;/b&gt; = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 即与当前消费者绑定的 RingBuffer 的 sequencer.cursor&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Sequence &lt;b&gt;cursorSequence&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Sequencer sequencer;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1560" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-45" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Sequencer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void claim(long sequence);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isAvailable(long sequence);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void addGatingSequences(Sequence... gatingSequences);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;SequenceBarrier&lt;/b&gt; &lt;b&gt;newBarrier&lt;/b&gt;(Sequence... sequencesToTrack);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getMinimumSequence();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getHighestPublishedSequence(long nextSequence, long availableSequence);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;lt;T&amp;gt; EventPoller&amp;lt;T&amp;gt; newPoller(DataProvider&amp;lt;T&amp;gt; provider, Sequence... gatingSequences);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="280" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;dashed=1;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-47" target="fhfUE1HdMHP-IcORmnVZ-45">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;endArrow=open;endFill=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-47" target="fhfUE1HdMHP-IcORmnVZ-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-103" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.002;entryY=0.206;entryDx=0;entryDy=0;entryPerimeter=0;shape=link;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-47" target="fhfUE1HdMHP-IcORmnVZ-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-106" value="&lt;font color=&quot;#007fff&quot;&gt;等待唤醒通道&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-103">
          <mxGeometry x="-0.6853" y="4" relative="1" as="geometry">
            <mxPoint x="16" y="-13" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-47" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractSequencer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final AtomicReferenceFieldUpdater&amp;lt;AbstractSequencer, Sequence[]&amp;gt; SEQUENCE_UPDATER = ...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final int bufferSize;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个添加这个字段是为了在RingBuffer中有数据可消费时可以及时通知与RingBuffer绑定的所有消费者组进行消费&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final WaitStrategy &lt;b&gt;waitStrategy&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// &lt;b&gt;当前缓冲写指针&lt;/b&gt;，初始为-1是因为获取RingBuffer下一个元素指针能是通过next()获取的，&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;next() 中通过 VarHandle 并发安全的执行 CAS getAndAdd(this, 1) 方法后再加1&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 13px;&quot;&gt;&lt;font style=&quot;font-size: 13px;&quot;&gt;protected final &lt;b style=&quot;&quot;&gt;Sequence cursor&lt;/b&gt; = new Sequence(-1L);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;// 存储消费者的&lt;b style=&quot;&quot;&gt;消费指针&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 12px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;protected volatile &lt;b style=&quot;&quot;&gt;Sequence[] gatingSequences&lt;/b&gt; = new Sequence[0];&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 12px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="500" width="400" height="220" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-50" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-49" target="fhfUE1HdMHP-IcORmnVZ-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-49" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MultiProducerSequencer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final VarHandle &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;AVAILABLE_ARRAY&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; =&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; MethodHandles.arrayElementVarHandle(int[].class);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//存储所有消费者中消费最慢的消费者的消费值指针&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Sequence &lt;b&gt;gatingSequenceCache&lt;/b&gt; = new Sequence(-1L);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于标记环形缓冲中哪些位置的元素是可用的，每往RingBuffer中添加一个值都要标记一下&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;// cursor 在生产者抢占位置成功后就移动了，但是发布数据可能失败，所以还需要这个标记下是否发布成功&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int[] &lt;b&gt;availableBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int indexMask;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int indexShift;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="760" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-51" target="fhfUE1HdMHP-IcORmnVZ-53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-51" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Sequence &lt;font color=&quot;#007fff&quot;&gt;用作索引(指针)&lt;/font&gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;官方说使用Sequence作为一种手段来&lt;b&gt;识别特定组件的位置&lt;/b&gt;。每个消费者（事件处理器）都像Disruptor本身一样维护一个Sequence。大多数并发代码依赖于这些Sequence值的移动，因此Sequence支持AtomicLong的许多当前特性。事实上，两者之间&lt;b&gt;唯一的真实的区别是Sequence包含了额外的功能来防止Sequence和其他值之间的错误共享&lt;/b&gt;。&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static final long INITIAL_VALUE = -1L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;VarHandle 提供了一种类型安全的方式来访问和修改内存中的变量，避免了 Unsafe 类中的一些不安全操作&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final &lt;b&gt;VarHandle&lt;/b&gt; VALUE_FIELD;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="500" width="400" height="220" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-57" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-53" target="fhfUE1HdMHP-IcORmnVZ-55">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-53" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RhsPadding&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;RhsPadding 中也是56个字节字段， p90-p157，用于防止内存伪共享&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="380" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-54" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;LhsPadding&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;LhsPadding&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;中也是56个字节字段， p10-p77，用于防止内存伪共享&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="140" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-55" target="fhfUE1HdMHP-IcORmnVZ-54">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Value&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;&quot;&gt;protected long value;&lt;/b&gt;&lt;br&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1760" y="260" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-59" target="fhfUE1HdMHP-IcORmnVZ-61">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-59" value="&lt;font color=&quot;#007fff&quot;&gt;// 这里传空 Sequence 数组，后面创建 SequenceBarrier 实例的时候就是使用RingBuffer sequencer&lt;br&gt;实例的 cursor 作为 dependentSequence&lt;/font&gt;&lt;br&gt;return createEventProcessors(&lt;b&gt;new Sequence[0]&lt;/b&gt;, handlers);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="761" y="300" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-82" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.999;exitY=0.721;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;exitPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-61" target="fhfUE1HdMHP-IcORmnVZ-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-97" value="&lt;font color=&quot;#007fff&quot;&gt;这里多个事件处理器&lt;br&gt;用同一个 SequenceBarrier&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-82">
          <mxGeometry x="-0.8473" y="2" relative="1" as="geometry">
            <mxPoint x="47" y="-17" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-98" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.999;exitY=0.848;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-61" target="fhfUE1HdMHP-IcORmnVZ-96">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1690" y="605" />
              <mxPoint x="1690" y="630" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-61" value="&lt;div&gt;EventHandlerGroup&amp;lt;T&amp;gt; createEventProcessors(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Sequence[] &lt;b&gt;barrierSequences&lt;/b&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final EventHandler&amp;lt;? super T&amp;gt;[] eventHandlers)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 每个EventHandler 对应一个Sequence, 即&lt;b&gt;每个 EventHandler 都有自己的消费指针&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &lt;/b&gt;// 也就是说每个 EventHandler 对事件的消费互不影响，这种消费方式就是&lt;b&gt;广播&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final Sequence[] processorSequences = new Sequence[eventHandlers.length];&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 使用 barrierSequences&amp;nbsp;创建序列屏障，如果为空数组就用RingBuffer的 cursor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 这里可以看到还是有实现&lt;b&gt;组内消费者分摊消费的潜力&lt;/b&gt;的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final SequenceBarrier &lt;b&gt;barrier&lt;/b&gt; = ringBuffer.&lt;b&gt;newBarrier&lt;/b&gt;(barrierSequences);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 遍历将每个 EventHandler 封装成 BatchEventProcessor 注册到 ConsumerRepository&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 同时绑定的多个消费者中的 SequenceBarrier 实例相同（即监听同一个 mutex）&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (int i = 0, eventHandlersLength = eventHandlers.length; i &amp;lt; eventHandlersLength; i++)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final EventHandler&amp;lt;? super T&amp;gt; eventHandler = eventHandlers[i];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final BatchEventProcessor&amp;lt;T&amp;gt; &lt;b&gt;batchEventProcessor&lt;/b&gt; =&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new BatchEventProcessorBuilder().build(ringBuffer, &lt;b&gt;barrier&lt;/b&gt;, eventHandler);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (exceptionHandler != null)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; batchEventProcessor.setExceptionHandler(exceptionHandler);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//注册到消费者集合&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;consumerRepository&lt;/b&gt;.&lt;b&gt;add&lt;/b&gt;(batchEventProcessor, eventHandler, &lt;b&gt;barrier&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;processorSequences&lt;/b&gt;[i] = batchEventProcessor.getSequence();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 将&amp;nbsp;processorSequences 加入到 RingBuffer 内部 Sequencer 的&amp;nbsp;gatingSequences&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;updateGatingSequencesForNextInChain&lt;/b&gt;(barrierSequences, processorSequences);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return new &lt;b&gt;EventHandlerGroup&lt;/b&gt;&amp;lt;&amp;gt;(this, consumerRepository, processorSequences);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1241" y="300" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-65" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;disruptor = {Disruptor@860}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;ringBuffer&lt;/b&gt; = {RingBuffer@863}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; p10 = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; p77 = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; indexMask = 1023&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;entries&lt;/b&gt; = {Object[1088]@1038}&amp;nbsp; &amp;nbsp;&lt;b&gt;1088 = bufferSize + 2*BUFFER_PAD&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; bufferSize = 1024&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;sequencer&lt;/b&gt; = {MultiProducerSequencer@1039}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;gatingSequenceCache = {Sequence@1041} &quot;-1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;availableBuffer&lt;/b&gt; = {int[1024]@1042} [-1, ...]&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;indexMask = 1023&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;indexShift = 10&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;bufferSize = 1024&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;waitStrategy = {BlockingWaitStrategy@1043}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;cursor = {Sequence@1044} &quot;-1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;gatingSequences&lt;/b&gt; = {Sequence[1]@1045}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; 0 = {Sequence@1009} &quot;-1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; RingBufferPad.p10 = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; RingBufferPad.p77 = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;threadFactory = {DaemonThreadFactory@871} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;consumerRepository&lt;/b&gt; = {ConsumerRepository@865}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; eventProcessorInfoByEventHandler = {IdentityHashMap@1016}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;{LongEventHandler@980}&amp;nbsp; -&amp;gt; {EventProcessorInfo@1054}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; eventProcessorInfoBySequence = {IdentityHashMap@1017}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;{Sequence@1009} &quot;-1&quot; -&amp;gt; {EventProcessorInfo@1054}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;consumerInfos&lt;/b&gt; = {ArrayList@1018}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;0 = {EventProcessorInfo@1054}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; eventprocessor = {BatchEventProcessor@991}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;barrier&lt;/b&gt; = {ProcessingSequenceBarrier@977}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; endOfChain = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;started = {AtomicBoolean@872} &quot;false&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;exceptionHandler = {ExceptionHandlerWrapper@864}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2200" y="280" width="350" height="420" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-66" target="fhfUE1HdMHP-IcORmnVZ-68">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="1030" />
              <mxPoint x="1220" y="1150" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-100" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.003;exitY=0.112;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-66" target="fhfUE1HdMHP-IcORmnVZ-99">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-101" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-100">
          <mxGeometry x="0.0445" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-66" value="&lt;div&gt;long sequence = ringBuffer.&lt;b&gt;next&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;//获取 cursor 指针的下一可写索引，本质是CAS getAndAdd(1)&lt;/font&gt;&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //获取 sequence 指针指向的元素节点&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; LongEvent event = ringBuffer.&lt;b&gt;get&lt;/b&gt;(sequence);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; event.&lt;b&gt;set&lt;/b&gt;(bb.getLong(0));&lt;/div&gt;&lt;div&gt;} finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ringBuffer.&lt;b&gt;publish&lt;/b&gt;(sequence);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" vertex="1" parent="1">
          <mxGeometry x="761" y="980" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-73" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-68" target="fhfUE1HdMHP-IcORmnVZ-72">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-68" value="sequencer.publish(sequence);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=7;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1120" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-71" value="看源码过程中的疑问：&lt;br&gt;&lt;ul&gt;&lt;li&gt;Disruptor 生产消费逻辑&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;整体和其他地方见到的环形缓冲、滑动窗口操作类似，通过“双”指针读写。&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事件生产：&lt;br&gt;生产者首先向 RingBuffer 中申请占位，多个生产者都通过 RingBuffer next() 占位，内部通过 CAS 抢占位置，如果缓冲写满就根据选择的等待策略处理；&lt;br&gt;生产者占位成功后，RingBuffer cursor 指针+1, 生产者向对应位置写数据成功后在&amp;nbsp;availableBuffer 标记此位置数据可用；然后通过 Sequencer 中的 waitStrategy 唤醒对应的消费者组进行消费&lt;br&gt;事件消费：&lt;br&gt;消费者线程被唤醒后，结合 RingBuffer 当前可读位置和自己的消费进度，读取所有可以被消费的事件，遍历事件进行消费，消费完成后更新自己的消费进度。&lt;/font&gt;&lt;/li&gt;&lt;li&gt;RingBuffer 存满后怎么处理的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;修改测试将bufferSize设置为4, 消费者线程全部通过断点阻塞，然后生产者不断往RingBuffer 发布数据，当写指针比消费指针快一轮之后会根据阻塞策略选择不同方式处理，比如默认的BlockingWaitStrategy会&lt;b&gt;自旋等待&lt;/b&gt;，直到有空位可写。&lt;br&gt;实际使用时需要根据业务量调整缓冲大小，尽量不要让缓冲占尽，否则后面写入会被阻塞。&lt;/font&gt;&lt;/li&gt;&lt;li&gt;为何要每个消费者都创建一个线程？不会造成线程数量太多么？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;感觉是受等待策略的限制导致的，比如使用 BlockingWaitStrategy，使用的 Java 等待唤醒机制，就没法再使用线程池了。&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font color=&quot;#007fff&quot;&gt;不过这个问题确实存在。不知能否使用 JDK21的虚线程优化，TODO。&lt;/font&gt;&lt;/li&gt;&lt;li&gt;为何 Sequence value 前后要填充 56 字节?&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;填充字节是为了解决伪共享内存问题，但是为何要前后分别填充 56 字节？因为 value 本身是long类型占8个字节，缓冲行的长度是64字节，所以前后分别填充56字节可以与其他数据拉开足够的距离避免出现伪共享。&lt;br&gt;RingBuffer 中的填充方式呢？&lt;/font&gt;&lt;/li&gt;&lt;li&gt;多生产者与多消费者怎么保持 Sequence 指针线程安全的？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;多个生产者发布数据到同一个 RingBuffer&amp;nbsp; 实例前，需要先通过 RingBuffer next() 方法占位，这个方法内部基于CAS是线程安全的；成功占位后再在 RingBuffer 相应的位置写数据；&lt;br&gt;对于多消费者由于当前测试每个消费者维护自己的消费进度（即&lt;b&gt;广播&lt;/b&gt;模式，官方称&lt;b&gt;组播&lt;/b&gt;），根本不存在并发问题；&lt;br&gt;那么Disruptor支持分摊消费的模式么？&lt;br&gt;从当前版本事件处理器唯一的实现类&amp;nbsp;BatchEventProcessor 看暂时不支持分摊消费，因为&lt;br&gt;其记录消费进度是靠私有成员变量 sequence，而这个值不会被外部修改，只有消费者本身消费事件后会更新，要实现分摊消费，这些消费者需要共享一个消费进度。&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="400" width="600" height="520" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-72" target="fhfUE1HdMHP-IcORmnVZ-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-72" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//在 Sequencer &lt;b&gt;availableBuffer&lt;/b&gt; 中标记此位置的元素可用&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;setAvailable&lt;/b&gt;(sequence);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//唤醒所有等待此 mutex 的线程&lt;/font&gt;&lt;/div&gt;&lt;div&gt;waitStrategy.&lt;b&gt;signalAllWhenBlocking&lt;/b&gt;();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" vertex="1" parent="1">
          <mxGeometry x="1482" y="1120" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-74" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;WaitStrategy (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;定义线程没有事件消费时的等待策略，有8种实现&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1560" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-76" target="fhfUE1HdMHP-IcORmnVZ-74">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-76" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;BlockingWaitStrategy&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;阻塞等待策略，借助 Java 对象的等待唤醒机制&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 借助对象的 wait() notifyXxx() 实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Object &lt;b&gt;mutex&lt;/b&gt; = new Object();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="1880" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-89" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=-0.002;entryY=0.28;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryPerimeter=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-78" target="fhfUE1HdMHP-IcORmnVZ-87">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2140" y="1070" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2410" y="1150" />
              <mxPoint x="2410" y="869" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-90" value="&lt;font color=&quot;#007fff&quot;&gt;唤醒 （BlockingWaitStrategy）&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="fhfUE1HdMHP-IcORmnVZ-89">
          <mxGeometry x="-0.9342" y="-1" relative="1" as="geometry">
            <mxPoint x="67" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-78" value="&lt;div&gt;synchronized (mutex){&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; mutex.&lt;b&gt;notifyAll&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;从前面可以看到事件消费者绑定逻辑里面，&lt;b&gt;一起绑定的多个消费者监听同一个 mutext&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1721" y="1120" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-32" target="fhfUE1HdMHP-IcORmnVZ-80">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1200" y="150" as="sourcePoint" />
            <mxPoint x="1720" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-80" value="return createMultiProducer(factory, bufferSize, new &lt;b&gt;BlockingWaitStrategy&lt;/b&gt;());&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;默认使用&amp;nbsp; BlockingWaitStrategy 策略，即Java对象的 wait notify 机制&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="1241" y="120" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-83" target="fhfUE1HdMHP-IcORmnVZ-85">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-83" value="BatchEventProcessor#run()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=9;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1720" y="740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-88" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-85" target="fhfUE1HdMHP-IcORmnVZ-87">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-85" value="&lt;div&gt;int witnessValue = running.compareAndExchange(IDLE, RUNNING);&lt;/div&gt;&lt;div&gt;if (witnessValue == IDLE) { // Successful CAS&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; sequenceBarrier.&lt;b&gt;clearAlert&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;// 将 BatchEventProcess alerted 设置为 false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;notifyStart&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;//回调事件处理器启动钩子，做些处理器初始化&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (running.get() == RUNNING)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 内部死循环，等待下个索引的事件可用，有事件会被唤醒&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;processEvents&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;notifyShutdown&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;// 回调关闭钩子，后事处理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; running.set(IDLE);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (witnessValue == RUNNING) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new IllegalStateException(&quot;Thread is already running&quot;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; earlyExit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1960" y="740" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-87" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;private void &lt;b&gt;processEvents&lt;/b&gt;() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; T event = null;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; long nextSequence = sequence.get() + 1L;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;while&lt;/b&gt; (true) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long startOfBatchSequence = nextSequence;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;// 等待被唤醒，被&lt;b style=&quot;font-size: 9px;&quot;&gt;唤醒后可能缓冲中已经填充了多个事件（比如被事件1唤醒但是读&lt;/b&gt;&lt;b&gt;dependentSequence前又有事件2、事件3插入了环形缓冲&lt;/b&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;），返回当前可用的最大的 Sequence 的索引值&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long availableSequence = sequenceBarrier.&lt;b&gt;waitFor&lt;/b&gt;(nextSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // batchLimitOffset 默认是 Integer.MAX_VALUE&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final long endOfBatchSequence = min(nextSequence + batchLimitOffset, availableSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (nextSequence &amp;lt;= endOfBatchSequence) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //调用自定义 EventHandler 的批处理前置处理&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; eventHandler.&lt;b&gt;onBatchStart&lt;/b&gt;(endOfBatchSequence - nextSequence + 1, availableSequence - nextSequence + 1);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 轮询取这些事件的事件对象，回调自定义 EventHandler onEvent 事件处理器方法&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; while (nextSequence &amp;lt;= endOfBatchSequence) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; event = &lt;b&gt;dataProvider&lt;/b&gt;.get(nextSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; eventHandler.&lt;b&gt;onEvent&lt;/b&gt;(event, nextSequence, nextSequence == endOfBatchSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextSequence++;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; retriesAttempted = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //消费者更新自己的消费进度&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sequence.set(endOfBatchSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;catch (final &lt;b&gt;RewindableException&lt;/b&gt; e) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextSequence = rewindHandler.attemptRewindGetNextSequence(e, startOfBatchSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;catch (final &lt;b&gt;TimeoutException&lt;/b&gt; e) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;notifyTimeout&lt;/b&gt;(sequence.get());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;catch (final &lt;b&gt;AlertException&lt;/b&gt; ex) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (running.get() != RUNNING) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;catch (final Throwable ex) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handleEventException(ex, nextSequence, event);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sequence.set(nextSequence);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nextSequence++;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;font color=&quot;#007fff&quot;&gt; //while end&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2440" y="740" width="520" height="460" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-92" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Cursored, EventSequencer&amp;lt;E&amp;gt;, EventSink&amp;lt;E&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Cursored 接口：&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getCursor();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;EventSequencer&amp;lt;E&amp;gt; 接口继承&amp;nbsp;DataProvider&amp;lt;T&amp;gt;, Sequenced&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;T get(long sequence);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long next();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void publish(long sequence);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;EventSink&amp;lt;E&amp;gt; 接口：&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;定义了一批事件发布方法&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-440" y="280" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-94" value="&lt;div&gt;super(bufferSize, waitStrategy);&lt;/div&gt;&lt;div&gt;availableBuffer = new int[bufferSize];&lt;/div&gt;&lt;div&gt;Arrays.fill(availableBuffer, -1);&lt;/div&gt;&lt;div&gt;indexMask = bufferSize - 1;&lt;/div&gt;&lt;div&gt;indexShift = Util.log2(bufferSize);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="2200" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-96" value="&lt;div&gt;ringBuffer.&lt;b&gt;addGatingSequences&lt;/b&gt;(processorSequences);&lt;/div&gt;&lt;div&gt;for (final Sequence barrierSequence : barrierSequences) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ringBuffer.&lt;b&gt;removeGatingSequence&lt;/b&gt;(barrierSequence);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;consumerRepository.unMarkEventProcessorsAsEndOfChain(barrierSequences);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1720" y="600" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-99" value="&lt;div&gt;long current = cursor.getAndAdd(n);&lt;/div&gt;&lt;div&gt;long &lt;b&gt;nextSequence&lt;/b&gt; = current + n;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//下一个写指针&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long wrapPoint = nextSequence - bufferSize;&lt;/div&gt;&lt;div&gt;long cachedGatingSequence = gatingSequenceCache.get();&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;写指针比最慢的消费者消费指针快了一轮 || 消费指针比当前已写指针还大？什么时候会出现这种情况？&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;if (&lt;b&gt;wrapPoint &amp;gt; cachedGatingSequence || cachedGatingSequence &amp;gt; current&lt;/b&gt;)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long gatingSequence;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp; &lt;b&gt;自旋等待&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; while (wrapPoint &amp;gt; (gatingSequence = Util.getMinimumSequence(gatingSequences, current)))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LockSupport.&lt;b&gt;parkNanos&lt;/b&gt;(1L); // TODO, should we spin based on the wait strategy?&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gatingSequenceCache.&lt;b&gt;set&lt;/b&gt;(gatingSequence);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return nextSequence;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="1240" y="840" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-102" value="MultiProducerSequencer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1380" y="810" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="fhfUE1HdMHP-IcORmnVZ-104" target="fhfUE1HdMHP-IcORmnVZ-74">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fhfUE1HdMHP-IcORmnVZ-104" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;LiteTimeoutBlockingWaitStrategy&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp;基于CAS + 带超时的等待唤醒机制&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final Object mutex = new Object();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean signalNeeded = new AtomicBoolean(false);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long timeoutInNanos;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="1880" width="400" height="120" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
