<mxfile host="Electron" modified="2025-03-01T09:59:56.278Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="cban5Bw72xWXnkG0WFaV" version="21.6.5" type="device" pages="2">
  <diagram name="工作主流程" id="GKn8MqRBRS7uCVeujyc3">
    <mxGraphModel dx="5124" dy="606" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="S1kR7U3J-qD7APwjgyKx-1" value="&lt;h1 style=&quot;font-size: 18px;&quot;&gt;&lt;font style=&quot;font-size: 18px;&quot;&gt;Sentinel 工作原理流程&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;源码版本：spring-cloud-starter-alibaba-sentinel:2021.0.5.0, 使用Nacos 作为规则数据源。&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;大部分代码都很容易理解，主要是用于系统保护、流控规则校验的相关的数据的统计部分有点难以理解（比如Node树）。&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;测试DEMO: SpringBoot-Labs/sentinel&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=16;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="520" height="100" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-2" target="S1kR7U3J-qD7APwjgyKx-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-2" target="S1kR7U3J-qD7APwjgyKx-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-2" target="S1kR7U3J-qD7APwjgyKx-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-2" value="配置加载" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="120" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-4" target="S1kR7U3J-qD7APwjgyKx-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-4" target="S1kR7U3J-qD7APwjgyKx-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-4" target="S1kR7U3J-qD7APwjgyKx-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-4" target="S1kR7U3J-qD7APwjgyKx-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-4" value="组件初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要关注3个自动配置类&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="540" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-6" target="S1kR7U3J-qD7APwjgyKx-141" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-6" target="JXVrsIax2Fh7985Lvlhv-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-6" value="请求流量统计、规则检查、规则检查异常处理" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="1480" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-10" value="系统属性配置 &lt;br&gt;SentinelProperties" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-12" target="S1kR7U3J-qD7APwjgyKx-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-12" target="S1kR7U3J-qD7APwjgyKx-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-12" target="S1kR7U3J-qD7APwjgyKx-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-12" target="S1kR7U3J-qD7APwjgyKx-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-12" value="规则动态配置&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;调用&lt;b&gt;控制台&lt;/b&gt;的接口&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-16" target="S1kR7U3J-qD7APwjgyKx-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-16" value="流控规则动态配置&lt;br&gt;POST /v1/flow/rule" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-18" value="熔断规则动态配置&lt;br&gt;POST /degrade/rule" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-20" value="热点规则动态配置&lt;br&gt;POST /paramFlow/rule&amp;nbsp;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-22" value="授权规则动态配置&lt;br&gt;POST /authority/rule" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-26" target="S1kR7U3J-qD7APwjgyKx-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-26" value="SentinelAutoConfiguration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-28" target="S1kR7U3J-qD7APwjgyKx-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-28" value="SentinelWebAutoConfiguration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-29" target="S1kR7U3J-qD7APwjgyKx-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-29" value="SentinelFeignAutoConfiguration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-32" target="S1kR7U3J-qD7APwjgyKx-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-32" value="设置一批系统属性" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-34" target="S1kR7U3J-qD7APwjgyKx-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-34" value="配置类&amp;amp;Bean" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-133" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-36" target="S1kR7U3J-qD7APwjgyKx-132" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-36" value="&lt;b&gt;SentinelResourceAspect&lt;/b&gt;&lt;br&gt;SentinelBeanPostProcessor&lt;br&gt;&lt;b&gt;SentinelDataSourceHandler&lt;/b&gt;&lt;br&gt;SentinelConverterConfiguration&lt;br&gt;SentinelJsonConfiguration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="720" y="610" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-39" target="S1kR7U3J-qD7APwjgyKx-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-39" value="配置类&amp;amp;Bean" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-40" value="&lt;b&gt;SentinelWebInterceptor&lt;/b&gt;&lt;br&gt;&lt;b&gt;SentinelWebMvcConfig&lt;/b&gt;&lt;br&gt;SentinelWebMvcConfigurer" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="720" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-42" target="S1kR7U3J-qD7APwjgyKx-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-42" value="SentinelFeignAutoConfiguration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="480" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-44" value="SentinelFeign.Builder" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="720" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-46" target="S1kR7U3J-qD7APwjgyKx-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-46" value="FlowControllerV1#apiAddFlowRule()&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="720" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-48" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;FlowRuleEntity&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;流控规则实体定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Long id;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private String app;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private String ip;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer port;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//被限制的应用，即规则只对这些应用生效，默认default&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private String &lt;b&gt;limitApp&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//流控目标资源。是&quot;路由&quot; 或 &quot;请求方法:路由&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private String &lt;b&gt;resource&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//流控类型：0:线程数、1:QPS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer &lt;b&gt;grade&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//流控阈值，比如：最多count个线程、最大count QPS&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Double &lt;b&gt;count&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//流控模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//STRATEGY_DIRECT 根据调用方限流，需结合 limitApp 使用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//STRATEGY_RELATE 根据关联流量限流，比如写操作频繁时对读进行限流&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//STRATEGY_CHAIN 根据调用链路入口限流&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer &lt;b&gt;strategy&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private String refResource;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//控制行为&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//CONTROL_BEHAVIOR_DEFAULT直接拒绝（快速失败）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//CONTROL_BEHAVIOR_WARM_UP 冷启动（让流量缓慢增加）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;CONTROL_BEHAVIOR_RATE_LIMITER 排队等待，匀速器模式，处理间隔性突发流量让请求可以在接下来的空闲期间逐渐处理，比如处理MQ请求&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer &lt;b&gt;controlBehavior&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer warmUpPeriodSec;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Integer maxQueueingTimeMs;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private boolean clusterMode;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private ClusterFlowConfig clusterConfig;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Date gmtCreate;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private Date gmtModified;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-400" y="120" width="360" height="480" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-49" target="S1kR7U3J-qD7APwjgyKx-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-49" value="各字段校验" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="960" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-51" target="S1kR7U3J-qD7APwjgyKx-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-51" value="entity = repository.&lt;b&gt;save&lt;/b&gt;(entity);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;先保存到内存&lt;/b&gt;，repository是InMemoryRuleRepositoryAdapter类型，是内存存储服务的适配器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="960" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-53" target="S1kR7U3J-qD7APwjgyKx-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-53" value="&lt;b&gt;publishRules&lt;/b&gt;(entity.getApp(), entity.getIp(), entity.getPort()).get(5000, TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="960" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;strokeColor=#000000;" parent="1" source="S1kR7U3J-qD7APwjgyKx-55" target="S1kR7U3J-qD7APwjgyKx-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-75" value="&lt;font color=&quot;#007fff&quot;&gt;从控制台请求到&lt;br&gt;Sentinel客户端，&lt;br&gt;即业务服务&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="S1kR7U3J-qD7APwjgyKx-59" vertex="1" connectable="0">
          <mxGeometry x="-0.0167" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-55" value="先查找指定Sentinel客户端机器上所有流控规则，然后通过 sentinelApiClient&lt;br&gt;.setFlowRuleOfMachineAsync(...) 异步请求 http://ip:port(8719)/&lt;b&gt;setRules&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1200" y="350" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-57" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;id = {Long@9265} 4&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;app = &quot;demo-provider&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;ip = &quot;192.168.124.8&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;port = {Integer@9268} &lt;b&gt;8719&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;limitApp = &quot;default&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;resource = &quot;sentinel_default_context&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;grade = {Integer@9271} 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;count = {Double@9272} 1.0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;strategy = {Integer@9273} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;refResource = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;controlBehavior = {Integer@9273} 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;warmUpPeriodSec = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;maxQueueingTimeMs = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;clusterMode = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;clusterConfig = {ClusterFlowConfig@9274}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;gmtCreate = {Date@9256} &quot;Mon Apr 01 18:37:04 CST 2024&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;gmtModified = {Date@9256} &quot;Mon Apr 01 18:37:04 CST 2024&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-760" y="120" width="360" height="260" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-61" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-58" target="S1kR7U3J-qD7APwjgyKx-60" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1740" y="390" />
              <mxPoint x="1740" y="230" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-86" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-58" target="S1kR7U3J-qD7APwjgyKx-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-58" value="&lt;b&gt;ModifyRulesCommandHandler&lt;/b&gt;#&lt;br&gt;handle(CommandRequest request)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1520" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-60" target="S1kR7U3J-qD7APwjgyKx-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-60" value="FLOW_RULE_TYPE &lt;br&gt;（flow）&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;流控规则&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1760" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-63" target="S1kR7U3J-qD7APwjgyKx-65" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-63" value="List&amp;lt;FlowRule&amp;gt; flowRules = JSONArray.parseArray(data, FlowRule.class);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2000" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-65" target="S1kR7U3J-qD7APwjgyKx-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-65" target="S1kR7U3J-qD7APwjgyKx-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-65" value="&lt;b&gt;FlowRuleManager&lt;/b&gt;.&lt;b&gt;loadRules&lt;/b&gt;(&lt;br&gt;flowRules);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2000" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-67" target="S1kR7U3J-qD7APwjgyKx-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-67" value="writeToDataSource(&lt;br&gt;getFlowDataSource(), flowRules)" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2000" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-69" target="S1kR7U3J-qD7APwjgyKx-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-69" value="&lt;b&gt;currentProperty&lt;/b&gt;.updateValue(rules);&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2240" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-71" value="dataSource.write(value);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;可写的数据源只有FileWritableDataSource,只有配置使用文件作为数据源才会执行这个方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2240" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-73" value="&lt;font color=&quot;#007fff&quot;&gt;这里操作的是流控规则，&lt;br&gt;repository实际是&amp;nbsp;&lt;b&gt;InMemFlowRuleStore&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1170" y="290" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-74" value="&lt;b&gt;sentinel-transport-common&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1530" y="320" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-76" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;请求参数包括两部分：&lt;br style=&quot;font-size: 10px;&quot;&gt;&quot;&lt;b&gt;type&lt;/b&gt;&quot;: &quot;flow&quot;&lt;br style=&quot;font-size: 10px;&quot;&gt;&quot;&lt;b&gt;data&lt;/b&gt;&quot;:&amp;nbsp;[&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;clusterConfig&quot;: {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;acquireRefuseStrategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;clientOfflineTime&quot;: 2000,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;fallbackToLocalWhenFail&quot;: true,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;resourceTimeout&quot;: 2000,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;resourceTimeoutStrategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;sampleCount&quot;: 10,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;strategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;thresholdType&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;windowIntervalMs&quot;: 1000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; },&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;clusterMode&quot;: false,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;controlBehavior&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;count&quot;: 1.0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;grade&quot;: 1,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;limitApp&quot;: &quot;default&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;maxQueueingTimeMs&quot;: 500,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;resource&quot;: &quot;/demo/echo&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;strategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;warmUpPeriodSec&quot;: 10&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;]&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1410" y="20" width="180" height="330" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-77" target="S1kR7U3J-qD7APwjgyKx-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-77" value="&lt;b&gt;value = newValue;&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;更新内存中的规则&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2481" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-80" target="S1kR7U3J-qD7APwjgyKx-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-80" value="&lt;div&gt;for (PropertyListener&amp;lt;T&amp;gt; listener : listeners) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; listener.&lt;b&gt;configUpdate&lt;/b&gt;(newValue);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;遍历所有FlowPropertyListener，回调更新规&lt;/font&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;则 比如Rules&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="2481" y="360" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-82" value="&lt;div&gt;更新 &lt;b&gt;FlowRuleManager&lt;/b&gt; &lt;b&gt;flowRules&lt;/b&gt;;&amp;nbsp;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=15;" parent="1" vertex="1">
          <mxGeometry x="2720" y="370" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-84" value="&lt;font color=&quot;#cc0000&quot;&gt;！！！从后面的流程可以看到 Sentinel 控制台默认并不支持将规则写入配置中心，&lt;br&gt;所以测试时可以发现控制台配置好规则后，去配置中心根本看不到配置的规则&lt;br&gt;如果想要支持，可以去修改控制台源码&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1760" y="140" width="460" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-151" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-85" target="S1kR7U3J-qD7APwjgyKx-150" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-85" value="DEGRADE_RULE_TYPE （degrade&lt;span style=&quot;background-color: initial;&quot;&gt;）&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;熔断规则&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1760" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-87" value="主要研究：&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;ol style=&quot;font-size: 11px;&quot;&gt;&lt;li style=&quot;font-size: 11px;&quot;&gt;基于配置中心的规则的管理：持久化，推送、拉取规则到各规则管理器的原理；&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;都是基于配置中心本身的能力，Sentinel客户端启动时会主动拉取一次规则配置、同时注册规则配置监听器；&lt;br style=&quot;font-size: 11px;&quot;&gt;配置中心有修改规则配置会回调监听器，最终配置会更新到各个客户端本地各种规则管理器。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 11px;&quot;&gt;规则校验是怎么嵌入到请求处理流程中的；&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;两种方式&lt;br style=&quot;font-size: 11px;&quot;&gt;1）通过定义一个拦截器实现（实现HandlerInterceptor接口），规则校验逻辑全部在 &lt;br style=&quot;font-size: 11px;&quot;&gt;SentinelWebInterceptor、SentinelWebTotalInterceptor 中执行；&lt;br style=&quot;font-size: 11px;&quot;&gt;2）通过Spring AOP 切面实现。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 11px;&quot;&gt;流控、限流、黑白名单、热点数据等规则的校验流程实现原理。&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;通过一组ProcessorSlot实现。&lt;/font&gt;&lt;/li&gt;&lt;/ol&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="560" y="5" width="590" height="180" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-97" target="S1kR7U3J-qD7APwjgyKx-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-97" value="ExecutorService pool = new ThreadPoolExecutor(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;创建线程池 sentinel-nacos-ds-update&lt;br&gt;用于执行监听器回调&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-100" target="S1kR7U3J-qD7APwjgyKx-102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-105" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-100" target="S1kR7U3J-qD7APwjgyKx-104" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-100" value="this.configListener = new Listener() {...}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-113" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-102" target="S1kR7U3J-qD7APwjgyKx-112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-102" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;b style=&quot;&quot;&gt;receiveConfigInfo&lt;/b&gt;(&lt;br style=&quot;&quot;&gt;final String configInfo)&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;&quot;&gt;配置变更NacosServer会回调此方法&lt;br style=&quot;&quot;&gt;更新 DynamicSentinelProperty value值&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1920" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-104" target="S1kR7U3J-qD7APwjgyKx-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-104" target="S1kR7U3J-qD7APwjgyKx-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-104" value="initNacosListener();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;初始化Nacos配置监听器&lt;br&gt;Push模式实现&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-106" target="S1kR7U3J-qD7APwjgyKx-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-106" value="loadInitialConfig();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;数据源启动时主动拉取一次规则配置&lt;br&gt;pull模式实现&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-111" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-108" target="S1kR7U3J-qD7APwjgyKx-110" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-108" value="this.configService = NacosFactory.createConfigService(&lt;br&gt;this.properties);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;本质是创建了NacosClient 客户端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1920" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-110" value="configService.&lt;b&gt;addListener&lt;/b&gt;(dataId, groupId, configListener);&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;通过 NacosClient 向配置中心注册配置监听器，监听groupId分组、dataId配置集&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1920" y="860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-112" target="S1kR7U3J-qD7APwjgyKx-115" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-112" value="T newValue = NacosDataSource.this&lt;br&gt;.&lt;b&gt;parser&lt;/b&gt;.convert(configInfo);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;转成 ArrayList&amp;lt;FlowRule&amp;gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2160" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-115" target="S1kR7U3J-qD7APwjgyKx-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-115" value="&lt;b&gt;getProperty&lt;/b&gt;().updateValue(&lt;br&gt;newValue);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2160" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-128" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-117" target="S1kR7U3J-qD7APwjgyKx-123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-117" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractDataSource&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;protected final Converter&amp;lt;S, T&amp;gt; parser;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected final SentinelProperty&amp;lt;T&amp;gt; &lt;b&gt;property&lt;/b&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-400" y="640" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-125" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-118" target="S1kR7U3J-qD7APwjgyKx-124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-131" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-118" target="S1kR7U3J-qD7APwjgyKx-130" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2610" y="810" />
              <mxPoint x="2610" y="900" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-118" value="&lt;div&gt;for (PropertyListener&amp;lt;T&amp;gt; listener : listeners) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; listener.&lt;b&gt;configUpdate&lt;/b&gt;(newValue);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这里的PropertyListener是各个规则管理器内部定义的属性监听器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=12;" parent="1" vertex="1">
          <mxGeometry x="2400" y="765" width="200" height="90" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-121" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-120" target="S1kR7U3J-qD7APwjgyKx-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-120" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;NacosDataSource&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;规则的Nacos数据源&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final int DEFAULT_TIMEOUT = 3000;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final ExecutorService &lt;b&gt;pool&lt;/b&gt; = new ThreadPoolExecutor(...);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final Listener &lt;b&gt;configListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final String &lt;b&gt;groupId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final String &lt;b&gt;dataId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final Properties &lt;b&gt;properties&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private ConfigService &lt;b&gt;configService&lt;/b&gt; = null;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-400" y="760" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-122" value="DynamicSentinelProperty" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2420" y="740" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-123" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DynamicSentinelProperty&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//属性监听器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected Set&amp;lt;PropertyListener&amp;lt;T&amp;gt;&amp;gt; &lt;b&gt;listeners&lt;/b&gt; = Collections.synchronizedSet(&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;new HashSet&amp;lt;PropertyListener&amp;lt;T&amp;gt;&amp;gt;());&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//规则列表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private T &lt;b&gt;value&lt;/b&gt; = null;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="640" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-124" value="Map&amp;lt;String, List&amp;lt;FlowRule&amp;gt;&amp;gt; rules = FlowRuleUtil.buildFlowRuleMap(value);&lt;br&gt;flowRules.clear();&lt;br&gt;&lt;b&gt;flowRules&lt;/b&gt;.putAll(rules);" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=12;fillColor=#ffcc99;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="2630" y="780" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-126" value="&lt;b&gt;FlowRuleManager&lt;/b&gt;$FlowPropertyListener" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2615" y="750" width="250" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-127" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;FlowRuleManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;流控规则管理器&lt;/b&gt;，流控规则的本地容器，配置中心更新流控规则配置后会通过监听器回调更新到这个实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//流控规则&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final Map&amp;lt;String, List&amp;lt;FlowRule&amp;gt;&amp;gt; &lt;b&gt;flowRules&lt;/b&gt; = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConcurrentHashMap&amp;lt;String, List&amp;lt;FlowRule&amp;gt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Push模式，监听回调&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final FlowPropertyListener &lt;b&gt;LISTENER&lt;/b&gt; = new FlowPropertyListener();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static SentinelProperty&amp;lt;List&amp;lt;FlowRule&amp;gt;&amp;gt; &lt;b&gt;currentProperty&lt;/b&gt; = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DynamicSentinelProperty&amp;lt;List&amp;lt;FlowRule&amp;gt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定时任务线程池，处理 MetricTimerListener&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final ScheduledExecutorService &lt;b&gt;SCHEDULER&lt;/b&gt; = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;Executors.newScheduledThreadPool(&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;1,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new NamedThreadFactory(&quot;sentinel-metrics-record-task&quot;, true));&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1400" y="640" width="480" height="260" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="S1kR7U3J-qD7APwjgyKx-130" target="3PC2WQgvGjgkUnSvGf-g-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3700" y="900" />
              <mxPoint x="3700" y="2840" />
            </Array>
            <mxPoint x="2610.000000000002" y="1230.0000000000005" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-130" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;其他 RuleManager PropertyListener&lt;br&gt;更新规则列表，如&amp;nbsp;&lt;b&gt;DegradeRuleManager&lt;/b&gt;、&lt;b&gt;AuthorityRuleManager&lt;/b&gt;，和 FlowRuleManager 处理基本相同&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=12;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2630" y="860" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-132" target="upGvQ8i2CHYi3lYlOZoj-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-132" target="upGvQ8i2CHYi3lYlOZoj-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-132" value="&lt;span style=&quot;border-color: var(--border-color); font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;SentinelDataSourceHandler&lt;/b&gt; 实现 SmartInitializingSingleton接口在&lt;b&gt;afterSingletonsInstantiated&lt;/b&gt;() 方法中又通过DefaultListableBeanFactory的方法根据数据源定义属性注册了Sentinel数据源Bean&lt;/font&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="960" y="610" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-137" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-134" target="S1kR7U3J-qD7APwjgyKx-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-140" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-138" target="S1kR7U3J-qD7APwjgyKx-118" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2380" y="970" />
              <mxPoint x="2380" y="810" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-138" value="T newValue = loadConfig();&lt;br style=&quot;font-size: 11px;&quot;&gt;getProperty().updateValue(newValue);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;先从NacosDataSource.configSevice主动拉取规则配置，然后通过parser转成规则对象列表&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1920" y="940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-148" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-141" target="S1kR7U3J-qD7APwjgyKx-147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-141" value="依旧是先经过 Tomcat 的一系列组件（最后是ApplictionFilterChain）、然后经过ApplictionFilterChain中SpringMVC的一些过滤器，再是HttpServlet -&amp;gt; DispatcherServlet -&amp;gt; 然后是走到&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;SentinelWebInterceptor&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=10;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="240" y="1470" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-155" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-147" target="S1kR7U3J-qD7APwjgyKx-154" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-41" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-147" target="JXVrsIax2Fh7985Lvlhv-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-147" value="&lt;b&gt;SentinelWebInterceptor&lt;br&gt;#preHandle(...)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;由DispatcherServlet$&lt;b&gt;applyPreHandle&lt;/b&gt;()&lt;br&gt;方法发起调用&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="480" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-150" value="&lt;font color=&quot;#007fff&quot;&gt;后续处理和流控规则基本相同&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2000" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-153" value="&lt;font color=&quot;#007fff&quot;&gt;这部分详细参考 SpringMVC&lt;br&gt;源码工作流程图&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="255" y="1550" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-159" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-154" target="S1kR7U3J-qD7APwjgyKx-158" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-160" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="S1kR7U3J-qD7APwjgyKx-159" vertex="1" connectable="0">
          <mxGeometry x="0.0702" y="3" relative="1" as="geometry">
            <mxPoint x="13" y="-50" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-162" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-154" target="S1kR7U3J-qD7APwjgyKx-161" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-163" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="S1kR7U3J-qD7APwjgyKx-162" vertex="1" connectable="0">
          <mxGeometry x="0.4289" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-165" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-154" target="S1kR7U3J-qD7APwjgyKx-164" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-166" value="6" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="S1kR7U3J-qD7APwjgyKx-165" vertex="1" connectable="0">
          <mxGeometry x="0.8056" y="-3" relative="1" as="geometry">
            <mxPoint x="3" y="39" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-154" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //1 先获取请求路由作为流控等目标资源，比如 /demo/echo、GET:/demo/echo&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; String resourceName = this.&lt;b style=&quot;font-size: 11px;&quot;&gt;getResourceName&lt;/b&gt;(request);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //2 为空不校验规则&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; if (StringUtil.isEmpty(resourceName)) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //3 非空先在&lt;b style=&quot;font-size: 11px;&quot;&gt;请求属性&lt;/b&gt;中记录调用次数（+1）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp; 首次统计也不需要校验规则&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; } else if (this.&lt;b style=&quot;font-size: 11px;&quot;&gt;increaseReferece&lt;/b&gt;(request, this.baseWebMvcConfig.getRequestRefName(), 1) != 1) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //4 非首次统计需要校验规则&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String origin = this.parseOrigin(request);&amp;nbsp;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//解析来源应用，默认为&quot;&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//如果SentinelWebMvcConfig.webContextUnify==true（默认为true）, 使用&amp;nbsp;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; //“sentinel_spring_web_context&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;” 作为统一的上下文名称，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //否则使用资源名称作为上下文名称（这种情况需要小心上下文数量超出阈值）&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String contextName = this.&lt;b&gt;getContextName&lt;/b&gt;(request);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ContextUtil.&lt;b style=&quot;font-size: 11px;&quot;&gt;enter&lt;/b&gt;(contextName, origin); &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//使用ThreadLocal存储&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Entry entry = SphU.&lt;span style=&quot;font-size: 11px;&quot;&gt;entry&lt;/span&gt;(resourceName, 1, EntryType.IN);&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request.&lt;b style=&quot;font-size: 11px;&quot;&gt;setAttribute&lt;/b&gt;(this.baseWebMvcConfig.getRequestAttributeName(), entry);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; //5 规则校验失败会抛出BlockException&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; } catch (BlockException var12) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; BlockException e = var12;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //6 处理规则检查异常&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b style=&quot;font-size: 11px;&quot;&gt;handleBlockException&lt;/b&gt;(request, response, e);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ContextUtil.exit();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=3;align=left;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="720" y="1250" width="440" height="520" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-156" value="&lt;b&gt;SentinelWebTotalInterceptor&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;Sentinel源码中还定义了这个拦截器，不过starter中默认并没有注入，先略&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="480" y="1890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-84" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-157" target="R8YPJ6jMD8Vm_6NY_bdp-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-157" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;FlowRule&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;流控规则实体定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//流控类型：0:线程数、1:QPS&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private int &lt;b&gt;grade&lt;/b&gt; = 1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//流控阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private double &lt;b&gt;count&lt;/b&gt;;、&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//流控模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private int &lt;b&gt;strategy&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String &lt;b&gt;refResource&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private int &lt;b&gt;controlBehavior&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private int &lt;b&gt;warmUpPeriodSec&lt;/b&gt; = 10;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private int &lt;b&gt;maxQueueingTimeMs&lt;/b&gt; = 500;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是集群模式，集群模式和本地模式流控校验方式不同&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private boolean &lt;b&gt;clusterMode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private ClusterFlowConfig clusterConfig;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private TrafficShapingController controller;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1280" y="320" width="360" height="280" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-168" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-158" target="S1kR7U3J-qD7APwjgyKx-167" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-158" value="&lt;b&gt;increaseReferece&lt;/b&gt;(request, this.baseWebMvcConfig&lt;br&gt;.getRequestRefName(), 1)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="1370" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-171" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-161" target="S1kR7U3J-qD7APwjgyKx-170" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-161" value="SphU.&lt;b&gt;entry&lt;/b&gt;(resourceName, 1, EntryType.IN);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;记录统计并执行规则校验&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-164" target="JXVrsIax2Fh7985Lvlhv-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-164" value="&lt;b&gt;handleBlockException&lt;/b&gt;(&lt;br&gt;request, response, e);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;规则校验失败会抛出 BlockException&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="2050" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-167" value="通过请求属性&lt;b&gt;$$sentinel_spring_web_entry_attr-rc&lt;/b&gt;记录调用次数&lt;br&gt;request.&lt;b&gt;setAttribute&lt;/b&gt;(rcKey, newRc);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1440" y="1370" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-169" value="&lt;font color=&quot;#007fff&quot;&gt;这里并不是最终统计接口调用次数的地方&lt;br&gt;后面应该还有地方取 $$sentinel_spring_web_entry_attr-rc&lt;br&gt;&amp;nbsp;这个属性值做汇总&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1650" y="1370" width="330" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-179" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-170" target="S1kR7U3J-qD7APwjgyKx-178" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-170" value="Env.&lt;b&gt;sph&lt;/b&gt;.entryWithType(name, resourceType, trafficType, 1, OBJECTS0);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1440" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-172" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;SphU&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final Object[] OBJECTS0 = new Object[0];&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-400" y="1720" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-173" target="S1kR7U3J-qD7APwjgyKx-174" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-173" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Env&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;public static final &lt;b&gt;Sph&lt;/b&gt; &lt;b&gt;sph&lt;/b&gt; = new CtSph();&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-800" y="1720" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-174" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Sph &lt;/b&gt;extends&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;SphResourceTypeSupport (I)&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于记录统计信息和执行资源规则检查的基本接口。&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1200" y="1720" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-176" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;dashed=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-177" target="S1kR7U3J-qD7APwjgyKx-174" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1020" y="1880" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-35" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=classic;endFill=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-177" target="7B76-LEGkQ0qvEv1oR-M-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-177" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;CtSph&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final Object[] &lt;b style=&quot;font-size: 11px;&quot;&gt;OBJECTS0&lt;/b&gt; = new Object[0];&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//资源 -&amp;gt; Processor&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;SlotChain&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static volatile Map&amp;lt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ResourceWrapper&lt;/b&gt;, &lt;b style=&quot;font-size: 11px;&quot;&gt;ProcessorSlotChain&lt;/b&gt;&amp;gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;chainMap&lt;/b&gt; = &lt;span style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;new HashMap&amp;lt;ResourceWrapper, ProcessorSlotChain&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1240" y="1880" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-181" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-178" target="S1kR7U3J-qD7APwjgyKx-180" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-178" value="StringResourceWrapper resource = new StringResourceWrapper(name, entryType, resourceType);" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1680" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-183" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S1kR7U3J-qD7APwjgyKx-180" target="S1kR7U3J-qD7APwjgyKx-182" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-180" value="return &lt;b&gt;entryWithPriority&lt;/b&gt;(resource, count, prioritized, args);" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="1560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-182" target="7B76-LEGkQ0qvEv1oR-M-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-22" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="7B76-LEGkQ0qvEv1oR-M-21" vertex="1" connectable="0">
          <mxGeometry x="0.7931" y="-3" relative="1" as="geometry">
            <mxPoint x="5" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-182" target="7B76-LEGkQ0qvEv1oR-M-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-76" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="7B76-LEGkQ0qvEv1oR-M-75" vertex="1" connectable="0">
          <mxGeometry x="0.9254" y="3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-182" value="&lt;div&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//获取前面ContextUtil.enter(contextName, origin)保存的上下文&lt;/b&gt;&lt;/font&gt;&lt;div&gt;Context &lt;b&gt;context&lt;/b&gt; = ContextUtil.getContext();&lt;/div&gt;&lt;div&gt;if (context instanceof NullContext) {&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// 表明上下文数量超过了阈值（默认2000）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; //所以只会初始化Entry, 不会校验规则&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return new CtEntry(resourceWrapper, null, context);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (context == null) {&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认情况下不可能为null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//Sentinel全局开关关闭，不需要校验规则&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (!Constants.ON) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return new CtEntry(resourceWrapper, null, context);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 查找资源对应的ProcessorSlotChain, 不存在则创建 chain = SlotChainProvider.newSlotChain();&lt;br&gt;//&amp;nbsp; &amp;nbsp;ProcessorSlotChain 内部是链表（责任链模式）&lt;br&gt;&lt;/font&gt;&lt;div&gt;ProcessorSlot&amp;lt;Object&amp;gt; chain = &lt;b&gt;lookProcessChain&lt;/b&gt;(resourceWrapper);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;if (chain == null) {&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;//表明资源数量（对应 slot chain size）超出&amp;nbsp;Constants.MAX_SLOT_CHAIN_SIZE&lt;/font&gt;&lt;/div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//所以只会初始化Entry, 不会校验规则&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return new CtEntry(resourceWrapper, null, context);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&amp;nbsp;&lt;/div&gt;&lt;div&gt;Entry e = new &lt;b&gt;CtEntry&lt;/b&gt;(resourceWrapper, chain, context);&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; chain.&lt;b&gt;entry&lt;/b&gt;(context, resourceWrapper, null, count, prioritized, args);&lt;/div&gt;&lt;div&gt;} catch (BlockException e1) {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //4&amp;nbsp;这里是规则校验失败后退出，校验成功的话是在&amp;nbsp;&lt;span style=&quot;text-align: center; background-color: initial; border-color: var(--border-color);&quot;&gt;SentinelWebInterceptor&lt;/span&gt;&lt;span style=&quot;text-align: center; background-color: initial; border-color: var(--border-color);&quot;&gt;#afterCompletion() 中调用 exit() 的&lt;/span&gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; e.&lt;b&gt;exit&lt;/b&gt;(count, args);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; throw e1;&lt;/div&gt;&lt;div&gt;} catch (Throwable e1) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; // This should not happen, unless there are errors existing in Sentinel internal.&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RecordLog.info(&quot;Sentinel unexpected exception&quot;, e1);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return e;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1920" y="1480" width="560" height="530" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-184" value="&lt;b&gt;CtSph&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1750" y="1450" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-185" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;当前测试设置的流控规则( QPS、根据调用方限流、直接失败)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;[&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;resource&quot;: &quot;/demo/echo&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;limitApp&quot;: &quot;default&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;grade&quot;: 1,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;count&quot;: 5,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;strategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;controlBehavior&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;clusterMode&quot;: false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;]&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="240" y="1290" width="290" height="160" as="geometry" />
        </mxCell>
        <mxCell id="gmwCS7IYYuH75fHtpYmN-1" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-186" target="S1kR7U3J-qD7APwjgyKx-187" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-186" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ContextUtil&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;查看各个上下文、上下文中各个资源&lt;b&gt;统计节点&lt;/b&gt;的入口类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//保存请求调用上下文（该上下文标记为调用链的入口&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static ThreadLocal&amp;lt;Context&amp;gt; &lt;b&gt;contextHolder&lt;/b&gt; = new ThreadLocal&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//保存所有上下文入口节点，contextName -&amp;gt; EntranceNode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile Map&amp;lt;String, DefaultNode&amp;gt; &lt;b&gt;contextNameNodeMap&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认创建名为 sentinel_default_context 的上下文&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static void initDefaultContext()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-480" y="1120" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="gmwCS7IYYuH75fHtpYmN-3" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-187" target="gmwCS7IYYuH75fHtpYmN-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-90" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.893;entryDx=0;entryDy=0;entryPerimeter=0;endArrow=open;endFill=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-187" target="7B76-LEGkQ0qvEv1oR-M-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-187" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;b style=&quot;&quot;&gt;Context&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;请求调用上下文（该上下文标记为调用链的入口&lt;/font&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//上下文名称, 比如 sentinel_spring_web_context (SpringWeb默认使用这个上下文名称)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;private final String &lt;b&gt;name&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;//当前调用树的 EntranceNode, 相当于调用上下文统计节点的&lt;b&gt;根节点&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;private DefaultNode &lt;b&gt;entranceNode&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//当前正在执行的Entry，Entry 通过parent child 实现&lt;b&gt;双向链表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;private Entry &lt;b&gt;curEntry&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot; color=&quot;#007fff&quot;&gt;//当前调用上下文来源&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;private String origin = &quot;&quot;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;private final boolean async;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="1120" width="360" height="220" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;endArrow=block;endFill=0;" parent="1" source="gmwCS7IYYuH75fHtpYmN-2" target="7B76-LEGkQ0qvEv1oR-M-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="gmwCS7IYYuH75fHtpYmN-2" target="R8YPJ6jMD8Vm_6NY_bdp-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1420" y="1230" />
              <mxPoint x="-1420" y="1100" />
              <mxPoint x="-1840" y="1100" />
              <mxPoint x="-1840" y="1260" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="gmwCS7IYYuH75fHtpYmN-2" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;StatisticNode&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;调用树的统计节点，很重要的类，全靠它统计数据，这里&lt;b&gt;创建了2个滑动窗口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//此滑动窗口存储&lt;b&gt;最近 INTERVAL 毫秒的统计数据&lt;/b&gt;。默认窗口时间跨度1s分成两个桶&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private transient volatile Metric &lt;b&gt;rollingCounterInSecond&lt;/b&gt; = new &lt;b&gt;ArrayMetric&lt;/b&gt;(SampleCountProperty.SAMPLE_COUNT, IntervalProperty.INTERVAL);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//此滑动窗口存储&lt;b&gt;最近 60 秒的统计数据&lt;/b&gt;。&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;默认窗口时间跨度60s分成60个桶&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private transient Metric &lt;b&gt;rollingCounterInMinute&lt;/b&gt; = new ArrayMetric(60, 60 * 1000, false);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;线程计数器（即正在处理的资源线程数），&lt;/b&gt;进入统计时+1,退出时-1，也即正在处理资源请求数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private LongAdder &lt;b&gt;curThreadNum&lt;/b&gt; = new LongAdder();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//上次获取统计数据的时间戳&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private long &lt;b&gt;lastFetchTime&lt;/b&gt; = -1;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1400" y="1120" width="480" height="220" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-1" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Constants.ROOT&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;全局的根统计节点，是EntranceNode类型&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;br&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//默认创建名为 sentinel_default_context 的上下文&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static void initDefaultContext()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="1360" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-2" target="gmwCS7IYYuH75fHtpYmN-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-56" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-2" target="7B76-LEGkQ0qvEv1oR-M-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-2" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DefaultNode&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//节点统计的资源目标（SpringWeb就是对应的Web路由）&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private ResourceWrapper &lt;b&gt;id&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所有子节点的列表，子节点是当前上下文下所有资源的统计节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private volatile Set&amp;lt;Node&amp;gt; &lt;b&gt;childList&lt;/b&gt; = new HashSet&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//相关的集群访问统计节点，每个DefaultNode都有一个对应的ClusterNode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private ClusterNode &lt;b&gt;clusterNode&lt;/b&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1340" y="1380" width="360" height="180" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-4" target="7B76-LEGkQ0qvEv1oR-M-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-4" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;EntranceNode&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;代表调用树的入口节点&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1340" y="1600" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-6" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Node(I)&amp;nbsp;&lt;/b&gt;extends OccupySupport, DebugSupport&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;保存资源的实时统计信息&lt;/font&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1340" y="1000" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-9" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Entry&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;保存当前调用的信息。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final Object[] OBJECTS0 = new Object[0];&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//此条目的创建时间，用于 rt 统计。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final long createTimestamp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private long completeTimestamp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//当前上下文中资源的统计信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Node &lt;b&gt;curNode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//来源app的统计信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Node &lt;b&gt;originNode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Throwable error;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private BlockException blockError;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//资源信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected final ResourceWrapper &lt;b&gt;resourceWrapper&lt;/b&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1800" y="1120" width="360" height="280" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-10" target="7B76-LEGkQ0qvEv1oR-M-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-10" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;先从chainMap查找ProcessorSlotChain, 没有就在双重检查锁、CopyOnWrite保护下创建 chain = SlotChainProvider.&lt;b&gt;newSlotChain&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-13" target="7B76-LEGkQ0qvEv1oR-M-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-13" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;先SPI加载SlotChainBuilder，没有的话使用默认的&amp;nbsp;&lt;b&gt;DefaultSlotChainBuilder&lt;/b&gt; 创建 ProcessorSlotChain&lt;br&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;return &lt;b&gt;slotChainBuilder&lt;/b&gt;.&lt;b&gt;build&lt;/b&gt;();&lt;/span&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3000" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-15" value="&lt;b&gt;SlotChainProvider&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3035" y="1450" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-16" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public ProcessorSlotChain build() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; ProcessorSlotChain chain = new &lt;b style=&quot;font-size: 10px;&quot;&gt;DefaultProcessorSlotChain&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; List&amp;lt;ProcessorSlot&amp;gt; sortedSlotList = SpiLoader.of(&lt;b&gt;ProcessorSlot&lt;/b&gt;.class).loadInstanceListSorted();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; for (ProcessorSlot slot : sortedSlotList) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; if (!(slot instanceof AbstractLinkedProcessorSlot)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RecordLog.warn(...);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; chain.&lt;b&gt;addLast&lt;/b&gt;((AbstractLinkedProcessorSlot&amp;lt;?&amp;gt;) slot);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; return chain;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3240" y="1425" width="320" height="170" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-18" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;ProcessorSlot SPI 文件中定义的 ProcessorSlot:&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.nodeselector.NodeSelectorSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.clusterbuilder.ClusterBuilderSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.logger.LogSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.statistic.StatisticSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.block.authority.AuthoritySlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.system.SystemSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.block.flow.FlowSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;com.alibaba.csp.sentinel.slots.block.degrade.DegradeSlot&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3240" y="1300" width="300" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-19" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;最终创建的 SlotChain:&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;chain = {&lt;b&gt;DefaultProcessorSlotChain&lt;/b&gt;@12252}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;first = {DefaultProcessorSlotChain$1@12251}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; this$0 = {DefaultProcessorSlotChain@12252}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; next = {&lt;b&gt;NodeSelectorSlot&lt;/b&gt;@12250}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;map = {HashMap@12432}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;next = {&lt;b&gt;ClusterBuilderSlot&lt;/b&gt;@12249}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; clusterNode = {ClusterNode@12551}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; next = {&lt;b&gt;LogSlot&lt;/b&gt;@12248}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;next = {&lt;b&gt;StatisticSlot&lt;/b&gt;@12247}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; next = {&lt;b&gt;AuthoritySlot&lt;/b&gt;@12246}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;next = {&lt;b&gt;SystemSlot&lt;/b&gt;@12242}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; next = {&lt;b&gt;ParamFlowSlot&lt;/b&gt;@12241}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;next = {&lt;b&gt;FlowSlot&lt;/b&gt;@12237}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checker = {FlowRuleChecker@12243}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ruleProvider = {FlowSlot$1@12244}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; next = {&lt;b&gt;DegradeSlot&lt;/b&gt;@12245}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;next = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;end = {&lt;b&gt;DegradeSlot&lt;/b&gt;@12245}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;next = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3570" y="1345" width="240" height="250" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-20" target="7B76-LEGkQ0qvEv1oR-M-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-20" value="&lt;font style=&quot;&quot;&gt;chain.entry(context, resourceWrapper, null, count, prioritized, args);&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="S1kR7U3J-qD7APwjgyKx-182" target="7B76-LEGkQ0qvEv1oR-M-23" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2480" y="1745" as="sourcePoint" />
            <mxPoint x="2760" y="1510" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2500" y="1745" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-27" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="7B76-LEGkQ0qvEv1oR-M-24" vertex="1" connectable="0">
          <mxGeometry x="0.8854" y="-2" relative="1" as="geometry">
            <mxPoint x="6" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-23" target="7B76-LEGkQ0qvEv1oR-M-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-23" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;ProcessorSlot&amp;lt;Object&amp;gt; chain = lookProcessChain(resourceWrapper);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-28" target="7B76-LEGkQ0qvEv1oR-M-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-43" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="7B76-LEGkQ0qvEv1oR-M-41" vertex="1" connectable="0">
          <mxGeometry x="-0.1" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-28" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;first.transformEntry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;组成一条责任链&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-30" target="7B76-LEGkQ0qvEv1oR-M-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-30" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DefaultProcessorSlotChain&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ProcessorSlot 头节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AbstractLinkedProcessorSlot&amp;lt;?&amp;gt; &lt;b&gt;first&lt;/b&gt; = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;AbstractLinkedProcessorSlot&amp;lt;Object&amp;gt;() {...}&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ProcessorSlot 尾节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AbstractLinkedProcessorSlot&amp;lt;?&amp;gt; &lt;b&gt;end&lt;/b&gt; = first;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-400" y="2360" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-38" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;dashed=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-31" target="7B76-LEGkQ0qvEv1oR-M-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-31" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractLinkedProcessorSlot&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//ProcessorSlot 组成单向链表, 构成责任链&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private AbstractLinkedProcessorSlot&amp;lt;?&amp;gt; &lt;b&gt;next&lt;/b&gt; = null;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Object o 参数类型转换，然后调用节点业务方法（entry()）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;transformEntry&lt;/b&gt;(Context context, ResourceWrapper resourceWrapper, Object o, int count, boolean prioritized, Object... args)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//调用下一个节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;fireEntry&lt;/b&gt;(Context context, ResourceWrapper resourceWrapper, Object obj, int count, boolean prioritized, Object... args)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-400" y="2000" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-32" target="7B76-LEGkQ0qvEv1oR-M-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-32" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProcessorSlotChain&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public abstract void addFirst(AbstractLinkedProcessorSlot&amp;lt;?&amp;gt; protocolProcessor);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public abstract void addLast(AbstractLinkedProcessorSlot&amp;lt;?&amp;gt; protocolProcessor);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-400" y="2200" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-37" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ProcessorSlot&amp;lt;T&amp;gt; (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;规则的校验是通过一串 ProcessorSlot 实现的。&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-400" y="1880" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-39" value="DefaultProcessorSlotChain" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2775" y="1620" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-40" target="7B76-LEGkQ0qvEv1oR-M-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-47" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="7B76-LEGkQ0qvEv1oR-M-45" vertex="1" connectable="0">
          <mxGeometry x="-0.05" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-40" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;super.fireEntry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;first 是头节点，里面并没有业务逻辑&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3000" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-42" value="DefaultProcessorSlotChain$&lt;br&gt;AbstractLinkedProcessorSlot" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3010" y="1610" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-44" target="7B76-LEGkQ0qvEv1oR-M-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-3" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-2" vertex="1" connectable="0">
          <mxGeometry x="-0.0395" y="-2" relative="1" as="geometry">
            <mxPoint x="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-44" target="3PC2WQgvGjgkUnSvGf-g-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-44" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;不存在就创建当前资源的的统计节点&lt;br&gt;并加入调用上下文的EntranceNode childList&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3000" y="1750" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-46" value="&lt;b&gt;NodeSelectorSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1765" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-48" target="7B76-LEGkQ0qvEv1oR-M-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-6" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-4" vertex="1" connectable="0">
          <mxGeometry x="0.1711" y="-1" relative="1" as="geometry">
            <mxPoint x="-1" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-48" target="3PC2WQgvGjgkUnSvGf-g-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-48" value="&lt;font style=&quot;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;存储资源的统计信息以及调用者信息&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3000" y="1989.92" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-50" value="&lt;b&gt;ClusterBuilderSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2875" y="2004.92" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-51" target="7B76-LEGkQ0qvEv1oR-M-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-7" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-5" vertex="1" connectable="0">
          <mxGeometry x="0.1711" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-51" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于异常发生时记录日志&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3000" y="2089.92" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-52" value="LogSlot" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2910" y="2104.92" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-54" target="7B76-LEGkQ0qvEv1oR-M-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-10" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-8" vertex="1" connectable="0">
          <mxGeometry x="-0.0921" y="3" relative="1" as="geometry">
            <mxPoint x="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-54" target="3PC2WQgvGjgkUnSvGf-g-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-26" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;返回时&lt;br&gt;执行统计&lt;/b&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-25" vertex="1" connectable="0">
          <mxGeometry x="-0.2382" y="-5" relative="1" as="geometry">
            <mxPoint x="9" y="-5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-54" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从源码可以看到是在责任链返回时执行统计，即&lt;b&gt;本轮统计不参与本轮的校验&lt;/b&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3000" y="2450" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-55" value="&lt;b&gt;StatisticSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2895" y="2465" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-56" target="7B76-LEGkQ0qvEv1oR-M-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-11" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-9" vertex="1" connectable="0">
          <mxGeometry x="-0.0921" y="-1" relative="1" as="geometry">
            <mxPoint x="1" y="442" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-56" target="3PC2WQgvGjgkUnSvGf-g-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-56" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;黑白名单控制&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3000" y="2830" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-57" value="&lt;b&gt;AuthoritySlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2890" y="2845" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-58" target="7B76-LEGkQ0qvEv1oR-M-60" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-17" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-16" vertex="1" connectable="0">
          <mxGeometry x="-0.0395" y="3" relative="1" as="geometry">
            <mxPoint x="-3" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-58" target="3PC2WQgvGjgkUnSvGf-g-34" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3200" y="3160" />
              <mxPoint x="3200" y="3160" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-58" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;系统保护&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3000" y="3140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-59" value="&lt;b&gt;SystemSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2895" y="3140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-60" target="7B76-LEGkQ0qvEv1oR-M-62" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-18" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-13" vertex="1" connectable="0">
          <mxGeometry x="-0.0921" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-43" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-60" target="3PC2WQgvGjgkUnSvGf-g-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-60" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;热点参数限流&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3000" y="3450.0000000000005" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-61" value="&lt;b&gt;ParamFlowSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2890" y="3465.0000000000005" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-14" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-62" target="7B76-LEGkQ0qvEv1oR-M-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-19" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-14" vertex="1" connectable="0">
          <mxGeometry x="-0.0395" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-62" target="3PC2WQgvGjgkUnSvGf-g-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-62" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;流量控制&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="3000" y="3650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-63" value="&lt;b&gt;FlowSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2905" y="3665" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-64" target="3PC2WQgvGjgkUnSvGf-g-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-64" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;entry(context, resourceWrapper, t, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;熔断降级，主要是断路器的状态切换&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="3000" y="4450" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-65" value="&lt;b&gt;DegradeSlot&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2895" y="4465" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-74" value="&lt;font style=&quot;&quot;&gt;e.exit(count, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;依次触发调用各个ProcessorSlot&amp;nbsp;&lt;br&gt;exit() 方法&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1970" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-78" target="7B76-LEGkQ0qvEv1oR-M-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-78" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;CtEntry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//上次调用的统计节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected Entry &lt;b&gt;parent&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//下次调用的统计节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected Entry &lt;b&gt;child&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected ProcessorSlot&amp;lt;Object&amp;gt; &lt;b&gt;chain&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected Context context;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected LinkedList&amp;lt;BiConsumer&amp;lt;Context, Entry&amp;gt;&amp;gt; exitHandlers;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1800" y="1440" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-81" value="这块主要用于保存调用上下文的统计信息&lt;br&gt;有几个概念需要梳理清楚：&lt;br&gt;&lt;b&gt;上下文&lt;/b&gt;&lt;br&gt;&lt;b&gt;资源（被保护的对象，比如请求的web路由）&lt;/b&gt;&lt;br&gt;&lt;b&gt;Node（资源的实时统计数据，组成树）&lt;/b&gt;&lt;br&gt;&lt;b&gt;Entry（当前调用的信息，组成双向链表）&lt;/b&gt;&lt;br&gt;这部分代码的数据结构不是很容易理解为何这么做，建议先看校验代码逻辑怎么使用这些数据的再反推为何这么实现" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-480" y="1000" width="640" height="110" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-82" target="7B76-LEGkQ0qvEv1oR-M-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-680" y="2180" />
              <mxPoint x="-310" y="2180" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-82" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;NodeSelectorSlot&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//调用上下文名 -&amp;gt; DefaultNode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile Map&amp;lt;String, DefaultNode&amp;gt; &lt;b&gt;map&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;new HashMap&amp;lt;String, DefaultNode&amp;gt;(10);&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-840" y="2360" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-84" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-83" target="gmwCS7IYYuH75fHtpYmN-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-83" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ClusterNode&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;维护资源运行统计信息（响应时间、qps、线程计数、异常）以及调用方列表&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final String &lt;b&gt;name&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final int &lt;b&gt;resourceType&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Map&amp;lt;String, StatisticNode&amp;gt; &lt;b&gt;originCountMap&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final ReentrantLock lock = new ReentrantLock();&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-940" y="1380" width="360" height="180" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-87" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="7B76-LEGkQ0qvEv1oR-M-86" target="7B76-LEGkQ0qvEv1oR-M-31" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1040" y="2180" />
              <mxPoint x="-310" y="2180" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-86" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClusterBuilderSlot&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//请求资源 -&amp;gt; ClusterNode&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile Map&amp;lt;ResourceWrapper, ClusterNode&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;clusterNodeMap&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Object lock = new Object();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile ClusterNode &lt;b&gt;clusterNode&lt;/b&gt; = null;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1200" y="2360" width="320" height="160" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-88" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;this = {&lt;b&gt;NodeSelectorSlot&lt;/b&gt;@12250}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;map&lt;/b&gt; = {HashMap@12432}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &quot;&lt;b&gt;sentinel_spring_web_context&lt;/b&gt;&quot; -&amp;gt; {&lt;b&gt;DefaultNode&lt;/b&gt;@12263}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;key = &quot;sentinel_spring_web_context&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;value = {DefaultNode@12263}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;id&lt;/b&gt; = {StringResourceWrapper@12601} &quot;StringResourceWrapper{name=&#39;/demo/echo&#39;, entryType=IN, resourceType=1}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;childList&lt;/b&gt; = {HashSet@12488}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;clusterNode&lt;/b&gt; = {ClusterNode@12551}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;rollingCounterInSecond&lt;/b&gt; = {ArrayMetric@12602}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;rollingCounterInMinute&lt;/b&gt; = {ArrayMetric@12603}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;curThreadNum&lt;/b&gt; = {LongAdder@12604} &quot;0&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;lastFetchTime&lt;/b&gt; = -1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;next&lt;/b&gt; = {ClusterBuilderSlot@12249}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-840" y="2480" width="670" height="200" as="geometry" />
        </mxCell>
        <mxCell id="7B76-LEGkQ0qvEv1oR-M-89" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;context&lt;/b&gt; = {Context@12304} &quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;name&lt;/b&gt; = &quot;sentinel_spring_web_context&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;entranceNode&lt;/b&gt; = {EntranceNode@12468}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;id&lt;/b&gt; = {StringResourceWrapper@12626} &quot;StringResourceWrapper{name=&#39;sentinel_spring_web_context&#39;, entryType=IN, resourceType=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;childList&lt;/b&gt; = {HashSet@12480}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;0 = {&lt;b&gt;DefaultNode&lt;/b&gt;@12263}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; clusterNode = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; rollingCounterInSecond = {ArrayMetric@12627}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; rollingCounterInMinute = {ArrayMetric@12628}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; curThreadNum = {LongAdder@12629} &quot;0&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; lastFetchTime = -1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;curEntry&lt;/b&gt; = {CtEntry@12427}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; parent = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; child = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; chain = {DefaultProcessorSlotChain@12252}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; context = {Context@12304}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; exitHandlers = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; createTimestamp = 1712047852437&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; completeTimestamp = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; curNode = {DefaultNode@12263}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; originNode = {StatisticNode@12623}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; error = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; blockError = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; resourceWrapper = {StringResourceWrapper@12305} &quot;StringResourceWrapper{name=&#39;/demo/echo&#39;, entryType=IN, resourceType=1}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;origin = &quot;default&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;async = false&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-840" y="2700" width="750" height="390" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-1" value="&lt;font color=&quot;#007fff&quot;&gt;这里的责任链是通过&lt;b&gt;单向链表&lt;/b&gt;实现的，&lt;br&gt;每个节点都会实现AbstractLinkedProcessorSlot &lt;br&gt;这个抽象类用于实现链表节点的依次调用&lt;br&gt;fireEntry() 触发调用下一个ProcessorSlot节点&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2520" y="1720" width="270" height="70" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-20" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;DefaultNode node = map.get(context.getName());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (node == null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; synchronized (this) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; node = map.get(context.getName());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (node == null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //当前请求资源的统计数据节点&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; node = new &lt;b&gt;DefaultNode&lt;/b&gt;(resourceWrapper, null);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HashMap&amp;lt;String, DefaultNode&amp;gt; cacheMap = new HashMap&amp;lt;String, DefaultNode&amp;gt;(map.size());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cacheMap.putAll(map);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cacheMap.put(context.getName(), node);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; map = cacheMap;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 构建&lt;b&gt;调用树&lt;/b&gt;，Context.entranceNode.childList&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ((DefaultNode) context.getLastNode()).&lt;b&gt;addChild&lt;/b&gt;(node);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;context.&lt;b&gt;setCurNode&lt;/b&gt;(node);&lt;/div&gt;&lt;div&gt;&lt;b&gt;fireEntry&lt;/b&gt;(context, resourceWrapper, node, count, prioritized, args);&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3280" y="1650" width="400" height="260" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-22" value="&lt;font style=&quot;&quot;&gt;DCL控制下往 ClusterBuilerSlot&amp;nbsp;Map&amp;lt;ResourceWrapper, ClusterNode&amp;gt; &lt;b&gt;clusterNodeMap&lt;/b&gt; 中添加 &lt;b&gt;ClusterNode&lt;br&gt;&lt;/b&gt;clusterNode = new &lt;b&gt;ClusterNode&lt;/b&gt;(resourceWrapper.getName(), resourceWrapper.getResourceType());&lt;br&gt;newMap.put(node.getId(), clusterNode);&lt;br&gt;node.setClusterNode(clusterNode);&lt;br&gt;&lt;div&gt;if (!&quot;&quot;.equals(context.getOrigin())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; Node originNode = node.getClusterNode().getOrCreateOriginNode(context.getOrigin());&lt;/div&gt;&lt;div&gt;&amp;nbsp; context.getCurEntry().setOriginNode(originNode);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3280" y="1930" width="400" height="180" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-24" target="R8YPJ6jMD8Vm_6NY_bdp-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-61" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-24" target="R8YPJ6jMD8Vm_6NY_bdp-60" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-24" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //先触发执行后面的ProcessorSlot&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; //&lt;b&gt;没有异常&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //1 请求通过, 添加线程计数和通过请求计数&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; node.&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//对&lt;b&gt;当前Node节点&lt;/b&gt;和&lt;b&gt;clusterNode&lt;/b&gt; curThreadNum+1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; node.&lt;b style=&quot;font-size: 9px;&quot;&gt;addPassRequest&lt;/b&gt;(count);&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//对&lt;b&gt;当前Node节点&lt;/b&gt;和&lt;b&gt;clusterNode&lt;/b&gt; rollingCounterInSecond + count&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;//&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;rollingCounterInMinute + count&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (context.getCurEntry().getOriginNode() != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; context.&lt;b&gt;getCurEntry&lt;/b&gt;().getOriginNode().&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; context.&lt;b&gt;getCurEntry&lt;/b&gt;().getOriginNode().&lt;b&gt;addPassRequest&lt;/b&gt;(count);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //2 全局的统计&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (resourceWrapper.getEntryType() == EntryType.IN) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; // Add count for global inbound entry node for global statistics.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;addPassRequest&lt;/b&gt;(count);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //3 请求通过回调，通过监听器（钩子）拓展其他统计&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; for (ProcessorSlotEntryCallback&amp;lt;DefaultNode&amp;gt; handler : StatisticSlotCallbackRegistry.getEntryCallbacks()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; handler.&lt;b&gt;onPass&lt;/b&gt;(context, resourceWrapper, node, count, args);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} catch (&lt;b&gt;PriorityWaitException&lt;/b&gt; ex) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; node.&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (context.getCurEntry().getOriginNode() != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; // Add count for origin node.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; context.&lt;b&gt;getCurEntry&lt;/b&gt;().getOriginNode().&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (resourceWrapper.getEntryType() == EntryType.IN) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; // Add count for global inbound entry node for global statistics.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;increaseThreadNum&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; // Handle pass event with registered entry callback handlers.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; for (ProcessorSlotEntryCallback&amp;lt;DefaultNode&amp;gt; handler : StatisticSlotCallbackRegistry.getEntryCallbacks()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; handler.&lt;b&gt;onPass&lt;/b&gt;(context, resourceWrapper, node, count, args);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} catch (&lt;b&gt;BlockException&lt;/b&gt; e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; // Blocked, set block exception to current entry.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; context.getCurEntry().setBlockError(e);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; // Add block count.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; node.&lt;b&gt;increaseBlockQps&lt;/b&gt;(count);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (context.getCurEntry().getOriginNode() != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; context.getCurEntry().getOriginNode().&lt;b&gt;increaseBlockQps&lt;/b&gt;(count);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; if (resourceWrapper.getEntryType() == EntryType.IN) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; // Add count for global inbound entry node for global statistics.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Constants.ENTRY_NODE.&lt;b&gt;increaseBlockQps&lt;/b&gt;(count);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; // Handle block event with registered entry callback handlers.&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; for (ProcessorSlotEntryCallback&amp;lt;DefaultNode&amp;gt; handler : StatisticSlotCallbackRegistry.getEntryCallbacks()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; handler.&lt;b&gt;onBlocked&lt;/b&gt;(e, context, resourceWrapper, node, count, args);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;} catch (&lt;b&gt;Throwable&lt;/b&gt; e) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; context.getCurEntry().setError(e);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="3280" y="2150" width="400" height="660" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-27" target="3PC2WQgvGjgkUnSvGf-g-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-27" value="&lt;font style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验访问应用黑白名单&lt;/font&gt;&lt;br&gt;&lt;b&gt;checkBlackWhiteAuthority&lt;/b&gt;(resourceWrapper, context);&lt;br&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="3280" y="2830" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-29" value="从&amp;nbsp;&lt;b&gt;AuthorityRuleManager&amp;nbsp;&lt;/b&gt;通过资源名读取&lt;b style=&quot;font-size: 10px;&quot;&gt;黑白名单的规则集合，&lt;/b&gt;然后依次校验各个规则&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;AuthorityRuleChecker&lt;/b&gt;.&lt;b&gt;passCheck&lt;/b&gt;(rule, context)， 就是字符串比较，校验不通过则&lt;br&gt;throw new &lt;b&gt;AuthorityException&lt;/b&gt;(context.getOrigin(), rule);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="3720" y="2820" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-32" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AuthorityRuleManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;黑白名单规则管理器&lt;/b&gt;，黑白名单规则的本地容器，配置中心更新黑白名单规则配置后会通过监听器回调更新到这个实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//黑白名单规则，&lt;b&gt;资源名称 -&amp;gt; AuthorityRule集合&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile Map&amp;lt;String, Set&amp;lt;AuthorityRule&amp;gt;&amp;gt; &lt;b&gt;authorityRules&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Push模式，监听回调&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final RulePropertyListener &lt;b&gt;LISTENER&lt;/b&gt; = new RulePropertyListener();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static SentinelProperty&amp;lt;List&amp;lt;AuthorityRule&amp;gt;&amp;gt; currentProperty = new DynamicSentinelProperty&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1920" y="640" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-33" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AuthorityRule&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends AbstractRule&amp;nbsp;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;应用访问的黑白名单规则定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;//规则策略，默认是白名单&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private int &lt;b&gt;strategy&lt;/b&gt; = RuleConstant.AUTHORITY_WHITE;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1800" y="320" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-34" target="3PC2WQgvGjgkUnSvGf-g-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-34" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验系统保护规则，只会校验 inbound (EntryType.IN&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;b&gt;SystemRuleManager&lt;/b&gt;.&lt;b&gt;checkSystem&lt;/b&gt;(resourceWrapper, &lt;b&gt;count&lt;/b&gt;);&lt;br&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;校验失败抛出&amp;nbsp;SystemBlockException&lt;br&gt;&lt;/font&gt;基本都是基于全局的统计节点&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3280" y="3130" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-70" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.001;exitY=0.345;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-36" target="R8YPJ6jMD8Vm_6NY_bdp-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-73" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.598;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-36" target="R8YPJ6jMD8Vm_6NY_bdp-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.003;exitY=0.801;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-36" target="R8YPJ6jMD8Vm_6NY_bdp-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-36" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;if (resourceWrapper == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//系统开关打开才会执行 SystemRule 校验&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;if (!checkSystemStatus.get()) {&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//只校验EntryType.IN类型资源&lt;/span&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;if (resourceWrapper.getEntryType() != EntryType.IN) {&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// qps 检查 （统计数据来源于 StatisticSlot&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;double currentQps = Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;passQps&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (currentQps + count &amp;gt; qps) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; throw new &lt;b style=&quot;font-size: 10px;&quot;&gt;SystemBlockException&lt;/b&gt;(resourceWrapper.getName(), &quot;qps&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;//总线程数检查&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;int currentThread = Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;curThreadNum&lt;/b&gt;();&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (currentThread &amp;gt; maxThread) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; throw new SystemBlockException(resourceWrapper.getName(), &quot;thread&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;//平均响应时长检查，RT: ResponseTime&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;double rt = Constants.&lt;b&gt;ENTRY_NODE&lt;/b&gt;.&lt;b&gt;avgRt&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (rt &amp;gt; maxRt) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; throw new SystemBlockException(resourceWrapper.getName(), &quot;rt&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// Google BBR 算法检查，需要打开开关才会执行&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;（数据源于 SystemStatusListener、StatisticSlot）&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (highestSystemLoadIsSet &amp;amp;&amp;amp; &lt;b&gt;getCurrentSystemAvgLoad&lt;/b&gt;() &amp;gt; highestSystemLoad) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; if (!&lt;b&gt;checkBbr&lt;/b&gt;(currentThread)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SystemBlockException(resourceWrapper.getName(), &quot;load&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// cpu占用检查 （数据源于 SystemStatusListener）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (highestCpuUsageIsSet &amp;amp;&amp;amp; getCurrentCpuUsage() &amp;gt; highestCpuUsage) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; throw new SystemBlockException(resourceWrapper.getName(), &quot;cpu&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3720" y="2940" width="360" height="460" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-38" value="资源与规则：https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html#/" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-480" y="80" width="440" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-39" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;SystemRuleManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;系统规则管理器&lt;/b&gt;，&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;结合应用的 Load、总体平均 RT、入口 QPS 和线程数等几个维度的监控指标，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。&lt;br&gt;&lt;/font&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//黑白名单规则，&lt;b&gt;资源名称 -&amp;gt; AuthorityRule集合&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile double highestSystemLoad = Double.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CPU占用，[0, 1]&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile double &lt;b&gt;highestCpuUsage&lt;/b&gt; = Double.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile double &lt;b&gt;qps&lt;/b&gt; = Double.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile long &lt;b&gt;maxRt&lt;/b&gt; = Long.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile long &lt;b&gt;maxThread&lt;/b&gt; = Long.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录下面各阈值是否被用户设置，设置了才有效&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile boolean highestSystemLoadIsSet = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile boolean highestCpuUsageIsSet = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile boolean qpsIsSet = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile boolean maxRtIsSet = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static volatile boolean maxThreadIsSet = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否执行系统状态检查的开关，默认关闭&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static AtomicBoolean &lt;b&gt;checkSystemStatus&lt;/b&gt; = new AtomicBoolean(false);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//系统状态监听任务，后面的scheduler中每秒会执行一次这个任务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static &lt;b&gt;SystemStatusListener&lt;/b&gt; &lt;b&gt;statusListener&lt;/b&gt; = null;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Push模式，规则配置监听回调&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final static SystemPropertyListener &lt;b&gt;listener&lt;/b&gt; = new SystemPropertyListener();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static SentinelProperty&amp;lt;List&amp;lt;SystemRule&amp;gt;&amp;gt; currentProperty = new DynamicSentinelProperty&amp;lt;List&amp;lt;SystemRule&amp;gt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//系统状态监听任务的计划任务线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final static ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1,&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;new NamedThreadFactory(&quot;sentinel-system-status-record-task&quot;, true));&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2440" y="640" width="480" height="520" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-41" target="3PC2WQgvGjgkUnSvGf-g-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-41" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;/div&gt;&lt;b&gt;SystemStatusListener&lt;/b&gt;#&lt;b&gt;run&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SystemRuleManager.scheduler 每秒执行一次统计任务，统计&lt;b&gt;系统最近一分钟的平均负载&lt;/b&gt;、&lt;b&gt;当前CPU负载&lt;/b&gt;(取系统统计的CPU负载和计算出来的进程的CPU负载的较大值)；&lt;br&gt;这个任务统计的信息仅仅用于SystemSlot的 &lt;b&gt;CPU占用检查&lt;/b&gt;&lt;br&gt;通过JMX（OperatingSystemMXBean、RuntimeMXBean）统计&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3280" y="2993.33" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-87" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-42" target="R8YPJ6jMD8Vm_6NY_bdp-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-42" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验热点参数规则&lt;/font&gt;&lt;/div&gt;&lt;b&gt;checkFlow&lt;/b&gt;(resourceWrapper, count, args);&lt;br&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3280" y="3450.0000000000005" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" target="3PC2WQgvGjgkUnSvGf-g-48" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3680" y="3680" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-44" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验流控规则&lt;/font&gt;&lt;/div&gt;&lt;b&gt;checkFlow(resourceWrapper, context, node, count, prioritized);&lt;br&gt;&lt;/b&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3280" y="3650.02" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-46" target="JXVrsIax2Fh7985Lvlhv-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-46" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验熔断规则&lt;/font&gt;&lt;/div&gt;&lt;b&gt;performChecking(context, resourceWrapper);&lt;br&gt;&lt;/b&gt;fireEntry(context, resourceWrapper, node, count, prioritized, args);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3280" y="4450" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-48" target="3PC2WQgvGjgkUnSvGf-g-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-48" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//依次校验流控规则&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// ruleProvider 是 Function 函数对象，通过资源名获取对应的 FlowRule集合&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;Collection&amp;lt;&lt;b style=&quot;font-size: 10px;&quot;&gt;FlowRule&lt;/b&gt;&amp;gt; rules = ruleProvider.apply(resource.getName());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (rules != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; for (&lt;b&gt;FlowRule&lt;/b&gt; rule : rules) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; if (!&lt;b style=&quot;font-size: 10px;&quot;&gt;canPassCheck&lt;/b&gt;(rule, context, node, count, prioritized)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new &lt;b&gt;FlowException&lt;/b&gt;(rule.getLimitApp(), rule);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="3720" y="3620.05" width="360" height="119.95" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-50" value="FlowRuleChecker" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3840" y="3590.05" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-51" target="3PC2WQgvGjgkUnSvGf-g-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-51" target="3PC2WQgvGjgkUnSvGf-g-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-51" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;String limitApp = rule.getLimitApp();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (limitApp == null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (rule.&lt;b&gt;isClusterMode&lt;/b&gt;()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;passClusterCheck&lt;/b&gt;(rule, context, node, acquireCount, prioritized);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;passLocalCheck&lt;/b&gt;(rule, context, node, acquireCount, prioritized);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3620.05" width="360" height="119.95" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-57" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;/div&gt;TODO&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4520" y="3600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-59" target="3PC2WQgvGjgkUnSvGf-g-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-59" target="3PC2WQgvGjgkUnSvGf-g-65" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4760" y="3730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-59" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;Node selectedNode = &lt;b&gt;selectNodeByRequesterAndStrategy&lt;/b&gt;(&lt;br&gt;rule, context, node);&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;通过limitApp origin 流控策略选择合适的统计节点（即&lt;b&gt;不同的流控策略使用不同的统计节点&lt;/b&gt;）&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4520" y="3700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-61" target="3PC2WQgvGjgkUnSvGf-g-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-109" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-61" target="3PC2WQgvGjgkUnSvGf-g-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-111" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-61" target="3PC2WQgvGjgkUnSvGf-g-110" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-113" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-61" target="3PC2WQgvGjgkUnSvGf-g-112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-61" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;return rule.&lt;b&gt;getRater&lt;/b&gt;().&lt;b&gt;canPass&lt;/b&gt;(&lt;br&gt;&lt;b&gt;selectedNode&lt;/b&gt;, acquireCount, prioritized);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;DefaultController: 立即拒绝&lt;br&gt;RateLimiterController&lt;br&gt;WarmUpController&lt;br&gt;WarmUpRateLimiterController&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4520" y="4290" width="200" height="79.95" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-67" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-65" target="3PC2WQgvGjgkUnSvGf-g-66" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5020" y="3780" />
              <mxPoint x="4900" y="3780" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-68" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-67" vertex="1" connectable="0">
          <mxGeometry x="0.0045" relative="1" as="geometry">
            <mxPoint x="62" y="-91" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-104" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-67" vertex="1" connectable="0">
          <mxGeometry x="-0.5525" y="3" relative="1" as="geometry">
            <mxPoint x="3" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-65" target="3PC2WQgvGjgkUnSvGf-g-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-77" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-76" vertex="1" connectable="0">
          <mxGeometry x="-0.0864" y="4" relative="1" as="geometry">
            <mxPoint x="-83" y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-65" value="请求来源app(origin)是限制的limitApp&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;amp;&amp;amp; 来源app非default、other" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4920" y="3700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-66" target="3PC2WQgvGjgkUnSvGf-g-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-73" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-70" vertex="1" connectable="0">
          <mxGeometry x="-0.0515" y="-3" relative="1" as="geometry">
            <mxPoint x="-3" y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-72" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-66" target="3PC2WQgvGjgkUnSvGf-g-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-74" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-72" vertex="1" connectable="0">
          <mxGeometry x="-0.0394" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-66" value="流控策略 DIRECT ?" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4800" y="4000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-69" value="return context.getOriginNode();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即 &lt;b&gt;Context.curEntry&lt;br&gt;.originNode&lt;/b&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4760" y="4100" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-71" value="return selectReferenceNode(&lt;br&gt;rule, context, node);" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="4920" y="4100" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-75" target="3PC2WQgvGjgkUnSvGf-g-78" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5380" y="3880" />
              <mxPoint x="5220" y="3880" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-88" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-80" vertex="1" connectable="0">
          <mxGeometry x="-0.0273" relative="1" as="geometry">
            <mxPoint x="86" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-87" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-75" target="3PC2WQgvGjgkUnSvGf-g-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-89" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-87" vertex="1" connectable="0">
          <mxGeometry x="-0.0182" y="3" relative="1" as="geometry">
            <mxPoint x="-38" y="6" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-75" value="limitApp 是 default" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="5280" y="3800.05" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-84" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-78" target="3PC2WQgvGjgkUnSvGf-g-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-78" target="3PC2WQgvGjgkUnSvGf-g-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-94" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-85" vertex="1" connectable="0">
          <mxGeometry x="0.0756" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-78" value="流控策略 DIRECT ?" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="5120" y="4000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-81" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1" vertex="1" connectable="0">
          <mxGeometry x="5179.727272727274" y="4079.9999999999995" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-82" value="return node.getClusterNode();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即 &lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;Context.entranceNode.&lt;br&gt;childList[].clusterNode&lt;br&gt;&lt;/b&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="5080" y="4099" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-83" value="return selectReferenceNode(&lt;br&gt;rule, context, node);" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="5240" y="4099" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-86" target="3PC2WQgvGjgkUnSvGf-g-66" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="5460" y="3999.05" as="targetPoint" />
            <Array as="points">
              <mxPoint x="5540" y="3980" />
              <mxPoint x="4900" y="3980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-86" target="3PC2WQgvGjgkUnSvGf-g-92" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5540" y="3980" />
              <mxPoint x="5620" y="3980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-96" value="N" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="3PC2WQgvGjgkUnSvGf-g-95" vertex="1" connectable="0">
          <mxGeometry x="-0.016" y="1" relative="1" as="geometry">
            <mxPoint x="1" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-86" value="limitApp 是 other&lt;br&gt;&amp;amp;&amp;amp; FlowRuleManager.isOtherOrigin(origin, rule.getResource()" style="rhombus;whiteSpace=wrap;html=1;rounded=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="5440" y="3900.05" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-90" value="Y" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="1" vertex="1" connectable="0">
          <mxGeometry x="5509.997272727274" y="3979.9999999999995" as="geometry">
            <mxPoint x="-12" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-92" value="return null;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="5560" y="4000" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-105" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;每个规则实例对应一个TrafficShapingController实例&lt;br&gt;分别对应&amp;nbsp;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;CONTROL_BEHAVIOR_DEFAULT&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;CONTROL_BEHAVIOR_RATE_LIMITER&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;CONTROL_BEHAVIOR_WARM_UP&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4290" y="4294.99" width="250" height="70" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-106" target="efD_JUAdZYZt2iUUUV3x-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-106" value="DefaultController#&lt;b&gt;canPass&lt;/b&gt;(Node node, int acquireCount, boolean prioritized)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;直接拒绝模式&lt;/b&gt;，这里的node是用的 Context.entranceNode.childList[].clusterNode&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4760" y="4299.98" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="3PC2WQgvGjgkUnSvGf-g-108" target="JXVrsIax2Fh7985Lvlhv-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-108" value="RateLimiterController#&lt;b&gt;canPass&lt;/b&gt;(Node node, int acquireCount, boolean prioritized)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;匀速器模式，漏桶算法实现，&lt;/b&gt;和前面热点参数流空&amp;nbsp;passThrottleLocalCheck() 逻辑差不多&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4760" y="4670" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-110" value="WarmUpController#&lt;b&gt;canPass&lt;/b&gt;(Node node, int acquireCount, boolean prioritized)&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;冷启动模式，令牌桶算法&lt;/b&gt;（TODO&amp;nbsp; 确认）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4760" y="4950" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3PC2WQgvGjgkUnSvGf-g-112" value="WarmUpRateLimiterController#&lt;b&gt;canPass&lt;/b&gt;(&lt;br&gt;Node node, int acquireCount, boolean prioritized)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;漏桶算法实现，&lt;/b&gt;官方文档并没有介绍这种模式&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4760" y="5030" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-1" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;测试DEMO中设置的流控规则( QPS、根据调用方限流、直接失败)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;[&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;resource&quot;: &quot;/demo/echo&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;limitApp&quot;: &quot;default&quot;,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;grade&quot;: 1,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;count&quot;: 5,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;strategy&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;controlBehavior&quot;: 0,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;clusterMode&quot;: false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;]&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3750.05" width="310" height="160" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-4" value="&lt;font color=&quot;#007fff&quot;&gt;详细解析参考测试DEMO JMXTest.java&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3365" y="3073.33" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-51" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-12" target="R8YPJ6jMD8Vm_6NY_bdp-69" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3740" y="2420" />
              <mxPoint x="3740" y="2750" />
              <mxPoint x="4220" y="2750" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-52" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-12" target="R8YPJ6jMD8Vm_6NY_bdp-72" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3740" y="2420" />
              <mxPoint x="3740" y="2750" />
              <mxPoint x="4100" y="2750" />
              <mxPoint x="4100" y="3200" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-12" value="ArrayMetric &lt;b style=&quot;font-size: 11px;&quot;&gt;rollingCounterInSecond&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;这个窗口默认是1s分两个桶&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2400" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-13" value="ArrayMetric &lt;b style=&quot;font-size: 11px;&quot;&gt;rollingCounterInMinute&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;这个窗口默认是60s分60个桶&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2440" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-14" value="LongAdder &lt;b style=&quot;font-size: 11px;&quot;&gt;curThreadNum&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;线程统计计数，请求进入时+1, 退出时-1&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2480" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-15" value="long &lt;b style=&quot;font-size: 11px;&quot;&gt;lastFetchTime&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2520" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-16" value="&lt;b&gt;StatisticNode&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3815" y="2370" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-17" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;每次执行StatisticSlot.entry都会+1, &lt;br&gt;所以这里并不是当前执行的线程数量&lt;br&gt;而是统计处理的任务线程数量&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3965" y="2470" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-24" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-18" target="R8YPJ6jMD8Vm_6NY_bdp-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-18" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ArrayMetric&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;implements Metric&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;基于 LeapArray滑动窗口的统计对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final LeapArray&amp;lt;MetricBucket&amp;gt; &lt;b&gt;data&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2240" y="1200" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-23" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-19" target="R8YPJ6jMD8Vm_6NY_bdp-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-19" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;LeapArray&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;统计指标的基本数据结构，使用滑动窗口算法计算数据。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//每个桶的时间跨度（单位ms）比如rollingCounterInSecond默认是1s分两个桶，每个桶的时间跨度就是500ms&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected int &lt;b&gt;windowLengthInMs&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//分的样本数量(桶的数量),&amp;nbsp;比如rollingCounterInSecond默认是1s分两个桶&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected int &lt;b&gt;sampleCount&lt;/b&gt;;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//时间跨度（单位ms），比如rollingCounterInSecond默认跨度是1s&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected int &lt;b&gt;intervalInMs&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private double &lt;b&gt;intervalInSecond&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;滑动窗口的实现（一组桶）&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected final AtomicReferenceArray&amp;lt;WindowWrap&amp;lt;T&amp;gt;&amp;gt; &lt;b&gt;array&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final ReentrantLock updateLock = new ReentrantLock();&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2640" y="1200" width="360" height="280" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-20" target="R8YPJ6jMD8Vm_6NY_bdp-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-20" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BucketLeapArray&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends LeapArray&amp;lt;MetricBucket&amp;gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;只是定义了窗口中统计数据的泛型类型 &lt;b&gt;MetricBucket&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2640" y="1520" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-22" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;WindowWrap&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;滑动窗口是一组桶，这个类描述的是单个桶&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单个窗口存储桶的时间跨度（ms）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final long windowLengthInMs;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//窗口开始的时间戳&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private long windowStart;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//统计数据&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private T value;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-3040" y="1200" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-26" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;MetricBucket&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;窗口中桶的统计数据类型&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//多个计数器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对不同的统计事件使用不同的索引位置的LongAddr计数器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MetricEvent.PASS.ordinal() -&amp;gt; 0&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MetricEvent.BLOCK.ordinal() -&amp;gt; 1&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//...&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private final LongAdder[] &lt;b&gt;counters&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最小的 Response Time&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private volatile long &lt;b&gt;minRt&lt;/b&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-3040" y="1440" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-27" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4000" y="2405" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-28" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4030" y="2405" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-29" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4000" y="2445" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-30" value="..." style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4030" y="2445" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-31" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4060" y="2445" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-32" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;一共60个桶&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4085" y="2445" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-33" value="窗口滑动方式：按&lt;b&gt;当前时间戳&amp;nbsp;&lt;/b&gt;/ &lt;b&gt;窗口每个桶的时间跨度 %&amp;nbsp;窗口的桶数&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2568" width="390" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-34" value="LongAdder[] &lt;b&gt;counters&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;一共6种MetricEvent事件，每种事件有一个计数器&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="4160" y="2400" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-35" value="long &lt;b&gt;minRt&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="4160" y="2440" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-38" value="MetricBucket&amp;nbsp;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="4215" y="2370" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-39" value="滑动窗口是MetricBucket&amp;nbsp;数组" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3980" y="2370" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-40" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;一共2个桶&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4085" y="2405" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-41" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4400" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-42" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4420" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-43" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4440" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-44" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4460" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-46" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4480" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-47" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4500" y="2405" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-49" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;endWidth=10;endSize=3.67;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="4370" y="2419.5" as="sourcePoint" />
            <mxPoint x="4390" y="2420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-51" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;endWidth=10;endSize=3.67;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3970" y="2419.58" as="sourcePoint" />
            <mxPoint x="3990" y="2420.08" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-52" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;endWidth=10;endSize=3.67;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3970" y="2459.58" as="sourcePoint" />
            <mxPoint x="3990" y="2460.08" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-54" target="R8YPJ6jMD8Vm_6NY_bdp-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-59" value="MetricEvent.PASS" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="R8YPJ6jMD8Vm_6NY_bdp-56" vertex="1" connectable="0">
          <mxGeometry x="0.3963" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-54" value="addPassRequest(count)" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2290" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-58" value="&amp;nbsp; 0&amp;nbsp; &amp;nbsp; 1&amp;nbsp; &amp;nbsp; 2&amp;nbsp; &amp;nbsp; 3&amp;nbsp; &amp;nbsp; 4&amp;nbsp; &amp;nbsp; 5" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4400" y="2435" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-62" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-60" target="R8YPJ6jMD8Vm_6NY_bdp-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-63" value="MetricEvent.BLOCK" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="R8YPJ6jMD8Vm_6NY_bdp-62" vertex="1" connectable="0">
          <mxGeometry x="0.0377" y="1" relative="1" as="geometry">
            <mxPoint x="28" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-60" value="increaseBlockQps(count)" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3760" y="2620" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-69" value="return &lt;b&gt;rollingCounterInSecond&lt;/b&gt;.&lt;b&gt;pass&lt;/b&gt;() / rollingCounterInSecond&lt;br&gt;.getWindowIntervalInSec();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前窗口时间段内（默认1s）所有通过的请求数量 / 窗口时间跨度（默认1s）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3063.33" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-72" value="long successCount = &lt;b&gt;rollingCounterInSecond&lt;/b&gt;.&lt;b&gt;success&lt;/b&gt;();&lt;br&gt;return rollingCounterInSecond.&lt;b&gt;rt&lt;/b&gt;() * 1.0 / successCount;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前窗口时间段内 所有成功请求的响应时间之和 / 成功的请求数量&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3180" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-75" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;public enum MetricEvent {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; PASS,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; BLOCK,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; EXCEPTION,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; SUCCESS,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; RT,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; OCCUPIED_PASS&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4160" y="2480" width="140" height="110" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-76" value="代码实现上统计最大QPS * 最小响应时间，估算出一个最大的吞吐量，如果当前负载数量超过这个估计的最大吞吐量就限制请求" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3279" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-78" value="SystemRuleManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3830" y="2910" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-79" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;看BBR算法论文好像还略复杂但是这里的实现很简单&lt;br&gt;TODO 深入研究下BRR算法&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4325" y="3289" width="250" height="40" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-81" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ParamFlowRuleManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;热点参数规则管理器&lt;/b&gt;，热点参数规则的本地容器，配置中心更新热点参数规则配置后会通过监听器回调更新到这个实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//黑白名单规则，&lt;b&gt;资源名称 -&amp;gt; ParamFlowRule集合&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final Map&amp;lt;String, List&amp;lt;ParamFlowRule&amp;gt;&amp;gt; PARAM_FLOW_RULES = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final static RulePropertyListener PROPERTY_LISTENER = new RulePropertyListener();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static SentinelProperty&amp;lt;List&amp;lt;ParamFlowRule&amp;gt;&amp;gt; currentProperty = new DynamicSentinelProperty&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2961" y="640" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-82" value="&lt;div style=&quot;text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ParamFlowRule&lt;/b&gt; extends AbstractRule&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;热点参数规则定义。令牌桶算法进行校验，令牌桶是每段时间放出一批令牌。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255); font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255); font-size: 11px;&quot;&gt;//规则策略，0线程 1QPS，默认是QPS&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;grade&lt;/b&gt; = RuleConstant.FLOW_GRADE_QPS;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//参数索引, 此规则是针对第几个参数，支持负数，表示倒数第几个参数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private Integer &lt;b style=&quot;font-size: 11px;&quot;&gt;paramIdx&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//参数默认的阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private double &lt;b style=&quot;font-size: 11px;&quot;&gt;count&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//控制行为，默认直接拒绝&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;controlBehavior&lt;/b&gt; = RuleConstant.CONTROL_BEHAVIOR_DEFAULT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最大排队等待令牌时间，即当前即使没有令牌也不一定被拒绝请求，当前距离下一个令牌放出时间小于&amp;nbsp;maxQueueingTimeMs 就等待一会儿再尝试获取令牌&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;maxQueueingTimeMs&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private int &lt;b style=&quot;font-size: 11px;&quot;&gt;burstCount&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// durationInSec 时间内放出 count（可能被hotItems value覆盖&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;）个令牌&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// 代码中是每隔 durationInSec * 1000.0 / count ms 放出一个令牌&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long &lt;b style=&quot;font-size: 11px;&quot;&gt;durationInSec&lt;/b&gt; = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private List&amp;lt;ParamFlowItem&amp;gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;paramFlowItemList&lt;/b&gt; = new ArrayList&amp;lt;ParamFlowItem&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//热点参数配置：参数值 -&amp;gt; 参数阈值（会覆盖默认阈值）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private Map&amp;lt;Object, Integer&amp;gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;hotItems&lt;/b&gt; = new HashMap&amp;lt;Object, Integer&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//是否是集群模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean &lt;b style=&quot;font-size: 11px;&quot;&gt;clusterMode&lt;/b&gt; = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private ParamFlowClusterConfig &lt;b style=&quot;font-size: 11px;&quot;&gt;clusterConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2961" y="240" width="480" height="360" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-83" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractRule&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;流控规则实体定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//规则ID&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Long id;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//作用于的资源名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String resource;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对于不同的规则这个字段含义可能不同，比如&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;对于AuthorityRule 这个字段就是应用的黑白名单&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String limitApp;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1280" y="80" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-85" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SystemRule&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends AbstractRule&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;系统保护规则定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//系统负载阈值&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private double &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;highestSystemLoad&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = -1;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//CPU占用阈值&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private double &lt;b&gt;highestCpuUsage&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//入口QPS阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private double &lt;b&gt;qps&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//平均响应时间阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private long &lt;b&gt;avgRt&lt;/b&gt; = -1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最大并发线程数阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private long &lt;b&gt;maxThread&lt;/b&gt; = -1;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2320" y="320" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="R8YPJ6jMD8Vm_6NY_bdp-86" target="efD_JUAdZYZt2iUUUV3x-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="R8YPJ6jMD8Vm_6NY_bdp-86" value="从&amp;nbsp;&lt;b&gt;ParamFlowRuleManager&amp;nbsp;&lt;/b&gt;通过资源名读取&lt;b&gt;热点参数&lt;/b&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;规则集合，&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;如果参数资源的统计对象不存在会执行初始化，&lt;/span&gt;然后依次校验各个规则 &lt;b&gt;ParamFlowChecker.passCheck(&lt;/b&gt;resourceWrapper, rule, count, args)，校验不通过则&lt;br&gt;throw new &lt;b&gt;ParamFlowException&lt;/b&gt;(resourceWrapper.getName(), triggeredParam, rule);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="3720" y="3440" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-18" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-1" target="efD_JUAdZYZt2iUUUV3x-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-1" target="efD_JUAdZYZt2iUUUV3x-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-1" value="&lt;div&gt;...&lt;/div&gt;&lt;div&gt;if (rule.&lt;b&gt;isClusterMode&lt;/b&gt;() &amp;amp;&amp;amp; rule.getGrade() == RuleConstant.FLOW_GRADE_QPS) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;passClusterCheck&lt;/b&gt;(resourceWrapper, rule, count, value);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return &lt;b&gt;passLocalCheck&lt;/b&gt;(resourceWrapper, rule, count, value);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;value 是 ParamFlowRule 待校验的参数值&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="4120" y="3440" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-5" value="&lt;font color=&quot;#007fff&quot;&gt;有些规则（FlowRule、ParamFlowRule）包含&lt;b&gt;集群模式&lt;/b&gt;，关于集群模式参考：&lt;br&gt;https://sentinelguard.io/zh-cn/docs/cluster-flow-control.html&lt;br&gt;集群模式将所有节点看作一个整体进行管控，比如&lt;br&gt;给某个用户限制调用某个 API 的总 QPS 为 50，这个API在两个节点上部署，&lt;br&gt;如果此用户对其中一个节点此API访问的QPS已达到30,对另一个节点的此API访问的QPS&lt;br&gt;就不能超过20；&lt;br&gt;与集群模式相对立的是&lt;b&gt;本地模式&lt;/b&gt;，对各个节点的管控是独立的。&lt;br&gt;集群模式的实现比本地模式更加复杂，因为需要整合每个节点的统计数据，然后判断&lt;br&gt;是否对请求放行&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-1770" y="140" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-6" value="本地模式校验" style="text;html=1;align=center;verticalAlign=bottom;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4580" y="3670" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-7" value="集群模式校验" style="text;html=1;align=center;verticalAlign=bottom;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4580" y="3570" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-14" value="TODO" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4520" y="3400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-15" target="efD_JUAdZYZt2iUUUV3x-30" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4760" y="3527.67" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-15" value="参数可能是集合、数组类型，那么就遍历内部元素一一校验，&amp;nbsp;&lt;b&gt;passSingleValueCheck&lt;/b&gt;(&lt;br&gt;resourceWrapper, rule, count, value);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4520" y="3500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-16" value="本地模式校验" style="text;html=1;align=center;verticalAlign=bottom;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4580" y="3466.67" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-17" value="集群模式校验" style="text;html=1;align=center;verticalAlign=bottom;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4580" y="3370" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="efD_JUAdZYZt2iUUUV3x-24" target="efD_JUAdZYZt2iUUUV3x-38" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5230" y="3450" />
              <mxPoint x="5230" y="3450" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-24" value="&lt;b&gt;FLOW_GRADE_QPS&lt;/b&gt;&lt;br&gt;&lt;b&gt;CONTROL_BEHAVIOR_RATE_LIMITER&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="5000" y="3420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="efD_JUAdZYZt2iUUUV3x-27" target="efD_JUAdZYZt2iUUUV3x-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-27" value="&lt;b&gt;FLOW_GRADE_THREAD&lt;/b&gt;&lt;br&gt;&lt;b&gt;任意控制行为&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="5000" y="3580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-30" target="efD_JUAdZYZt2iUUUV3x-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-30" target="efD_JUAdZYZt2iUUUV3x-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-30" target="efD_JUAdZYZt2iUUUV3x-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-30" value="根据规则类型、控制行为&lt;br&gt;选择使用的校验方式" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="4760" y="3500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="efD_JUAdZYZt2iUUUV3x-31" target="efD_JUAdZYZt2iUUUV3x-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-31" value="&lt;b&gt;FLOW_GRADE_QPS&lt;/b&gt;&lt;br&gt;&lt;b&gt;RATE_LIMITER外其他控制行为&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;比如默认的CONTROL_BEHAVIOR_DEFAULT&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="5000" y="3500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-35" value="&lt;font color=&quot;#007fff&quot;&gt;热点参数的统计数据（&lt;b&gt;ParameterMetric &lt;/b&gt;和 Metric接口没关系）由&amp;nbsp;&lt;b&gt;ParameterMetricStorage&lt;/b&gt; 保存&lt;br&gt;&lt;b&gt;ParameterMetricStorage&lt;/b&gt;: &lt;br&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;metricsMap：&lt;/span&gt;资源名 -&amp;gt; ParameterMetric&amp;nbsp;&lt;br&gt;&lt;b&gt;ParameterMetric&lt;/b&gt;:&amp;nbsp;&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ruleTimeCounters：&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ParamFlowRule(规则) -&amp;gt; Object(参数) -&amp;gt; AtomicLong(上次获取到令牌的时间戳ms)&lt;br&gt;&amp;nbsp; &amp;nbsp; ruleTokenCounter： ParamFlowRule(规则) -&amp;gt; Object(参数) -&amp;gt; AtomicLong(其实就是令牌桶，记录桶中令牌数量)&lt;br&gt;&amp;nbsp; &amp;nbsp; threadCountMap：&lt;br&gt;统计时使用 &lt;b&gt;LRU 策略&lt;/b&gt;统计最近最常访问的热点参数（当前版本并没有看到那里有统计热点参数，可能是新版本功能）；&lt;br&gt;校验时使用&lt;b&gt;令牌桶算法&lt;/b&gt;进行流控。&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3280" y="3510" width="550" height="120" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-37" value="ParamFlowChecker" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4235" y="3410" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="efD_JUAdZYZt2iUUUV3x-38" target="efD_JUAdZYZt2iUUUV3x-40" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5450" y="3450" />
              <mxPoint x="5450" y="2660" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-38" value="return &lt;b&gt;passThrottleLocalCheck&lt;/b&gt;(resourceWrapper, rule, acquireCount, value);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;内部使用&lt;b&gt;漏桶算法&lt;/b&gt;实现&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="5240" y="3420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-40" value="&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//估算获取 acquireCount 个令牌，需要的时间&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//这里可以看到这里的漏桶算法是相当于&lt;b&gt;每隔 durationInSec * 1000.0 / tokenCount ms放出一个令牌&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long costTime = Math.round(1.0 * 1000 * acquireCount * rule.getDurationInSec() / tokenCount);&lt;/div&gt;&lt;div&gt;while (true) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long currentTime = TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这个是从 ParameterMetric ruleTimeCounters 中读取的 CacheMap&amp;lt;Object, AtomicLong&amp;gt; 对象&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //用于记录上次成功获取此参数令牌的时间戳&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AtomicLong timeRecorder = timeRecorderMap.putIfAbsent(value, new AtomicLong(currentTime));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (timeRecorder == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//首次对热点参数进行校验，直接放行，也即默认开始就有一个令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long lastPassTime = timeRecorder.get(); &lt;font color=&quot;#007fff&quot;&gt;//上次成功获取令牌的时间戳&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long expectedTime = lastPassTime + costTime;&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//预计下次放出令牌的时间戳&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//第一个条件成立说明已经有一个令牌放出&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //第二个条件成立说明还没有令牌放出，但是在 maxQueueingTimeMs 可等待时间范围内，会自旋等待一段时间重试&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (expectedTime &amp;lt;= currentTime || expectedTime - currentTime &amp;lt; rule.getMaxQueueingTimeMs()) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //这两行为了处理并发抢占令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AtomicLong lastPastTimeRef = timeRecorderMap.get(value);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (lastPastTimeRef.compareAndSet(lastPassTime, currentTime)) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; //CAS成功说明期间没有其他线程抢占令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //走到这里可能已经发放了新令牌也可能没有发放令牌，需要根据时间判断下&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long waitTime = expectedTime - currentTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (waitTime &amp;gt; 0) { &lt;font color=&quot;#007fff&quot;&gt;//还没发放令牌，就睡眠等待一会，这里看到 maxQueueingTimeMs 不宜设置太大&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //否则可能导致请求线程积压、接口超时&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lastPastTimeRef.set(expectedTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; TimeUnit.MILLISECONDS.sleep(waitTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RecordLog.warn(&quot;passThrottleLocalCheck: wait interrupted&quot;, e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //已经发放令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //CAS失败说明期间有其他线程抢占了令牌，自旋重试&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.yield();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="5480" y="2450" width="540" height="520" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="efD_JUAdZYZt2iUUUV3x-42" target="efD_JUAdZYZt2iUUUV3x-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-42" value="return &lt;b&gt;passDefaultLocalCheck&lt;/b&gt;(resourceWrapper, rule, acquireCount, value);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;内部也是使用&lt;b&gt;漏桶算法&lt;/b&gt;实现，不过和上面的略有不同&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="5240" y="3500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-44" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;ParameterMetric metric = getParameterMetric(resourceWrapper);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录 热点参数 -&amp;gt; 桶中令牌数量（漏桶）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;CacheMap&amp;lt;Object, AtomicLong&amp;gt; tokenCounters = metric == null ? null : metric.getRuleTokenCounter(rule);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//记录 热点参数 -&amp;gt; 上次获取令牌的时间戳&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;CacheMap&amp;lt;Object, AtomicLong&amp;gt; timeCounters = metric == null ? null : metric.getRuleTimeCounter(rule);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;if (tokenCounters == null || timeCounters == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;br style=&quot;font-size: 8px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 计算令牌限流的阈值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;Set&amp;lt;Object&amp;gt; exclusionItems = rule.getParsedHotItems().keySet();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;long tokenCount = (long)rule.getCount();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;if (exclusionItems.contains(value)) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; tokenCount = rule.getParsedHotItems().get(value);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;if (tokenCount == 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 最终实际的阈值（作为令牌桶内令牌数量的初始值）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;long maxCount = tokenCount + rule.getBurstCount();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;if (acquireCount &amp;gt; maxCount) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;br style=&quot;font-size: 8px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//从下面代码可以看到这里的&lt;b&gt;漏桶算法&lt;/b&gt;是相当于&lt;b&gt;每隔 durationInSec 放出一批 tokenCount 令牌&lt;/b&gt;,&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//补充令牌又不能使令牌数超过maxCount&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//上面为何说“相当于”是因为&lt;b&gt;每次获取令牌时才会触发判断是否需要补充令牌&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;while (true) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; long currentTime = TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //首次获取令牌时往桶中填充令牌，记录填充令牌的时间， TODO: 校验 CacheMap 返回值是否是线程安全的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; AtomicLong lastAddTokenTime = timeCounters.putIfAbsent(value, new AtomicLong(currentTime));&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (lastAddTokenTime == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //填充桶内令牌的数量，开始往令牌桶填充满令牌（maxCount），由于此次还需要消耗 acquireCount 个令牌&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //所以最终填充 maxCount - acquireCount 个令牌&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount));&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;br style=&quot;font-size: 8px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 当前距离上次获取令牌的时间&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; long passTime = currentTime - lastAddTokenTime.get();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 超过了补充令牌的周期，需要往漏桶补充令牌&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (passTime &amp;gt; rule.getDurationInSec() * 1000) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //一般不太可能执行，除非万一执行了 clear()， oldQps 实际就是漏桶对象&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AtomicLong oldQps = tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - acquireCount));&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (oldQps == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Might not be accurate here.&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lastAddTokenTime.set(currentTime);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //用于计算应该往令牌桶补充多少个令牌&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long restQps = oldQps.get();&amp;nbsp; &amp;nbsp; //获取剩余令牌数&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //每 durationInSec 补充 tokenCount 个令牌，过去 passTime, 就乘以 passTime, 但是又不能超过 maxCount&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long toAddCount = (passTime * tokenCount) / (rule.getDurationInSec() * 1000);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long newQps = toAddCount + restQps &amp;gt; maxCount ? (maxCount - acquireCount)&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : (restQps + toAddCount - acquireCount);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (newQps &amp;lt; 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //若有其他线程竞争补充令牌，防止重复填充&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (oldQps.compareAndSet(restQps, newQps)) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lastAddTokenTime.set(currentTime);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.yield();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//不需要补充令牌&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //就判断剩下的令牌是否满足需要，并CAS更新令牌数量&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AtomicLong oldQps = tokenCounters.get(value);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (oldQps != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long oldQpsValue = oldQps.get();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (oldQpsValue - acquireCount &amp;gt;= 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (oldQps.&lt;b&gt;compareAndSet&lt;/b&gt;(oldQpsValue, oldQpsValue - acquireCount)) {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.yield();&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=8;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="5480" y="2990" width="540" height="780" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-46" value="&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;br&gt;感觉这个不是很重要，后面看&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="5240" y="3580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-58" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.997;exitY=0.125;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="efD_JUAdZYZt2iUUUV3x-49" target="efD_JUAdZYZt2iUUUV3x-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-49" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//根据流控类型选择统计ClusterNode的线程数量或者QPS统计&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int curCount = &lt;b&gt;avgUsedTokens&lt;/b&gt;(node);&lt;/div&gt;&lt;div&gt;if (curCount + acquireCount &amp;gt; count) {&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//超过阈值限流&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //prioritized 参数当前版本并没有哪个地方有传 true, 这里面的逻辑先略&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (prioritized &amp;amp;&amp;amp; grade == RuleConstant.FLOW_GRADE_QPS) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long currentTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long waitInMs;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; currentTime = TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; waitInMs = node.tryOccupyNext(currentTime, acquireCount, count);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (waitInMs &amp;lt; OccupyTimeoutProperty.getOccupyTimeout()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; node.addWaitingRequest(currentTime + waitInMs, acquireCount);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; node.addOccupiedPass(acquireCount);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sleep(waitInMs);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new PriorityWaitException(waitInMs);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//未超过阈值请求放行&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return true;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="5000" y="4209.98" width="360" height="240.02" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-53" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;flipH=1;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="4340" y="3063" width="20" height="187" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-54" value="基于滑动时间窗口的统计校验" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4350" y="3140" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-55" value="&lt;b&gt;统计节点滑动时间窗口统计实现&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3980" y="2340" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="efD_JUAdZYZt2iUUUV3x-57" value="return grade == RuleConstant.FLOW_GRADE_THREAD ? node.&lt;b&gt;curThreadNum&lt;/b&gt;() : (int)(node.&lt;b&gt;passQps&lt;/b&gt;());&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;passQps()滑动窗口算法实现，参考前面的解析&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="5400" y="4209.98" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-1" value="&lt;div&gt;... &lt;font color=&quot;#007fff&quot;&gt;（省略一些值校验）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long currentTime = TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//每放出一个令牌大概需要的时间ms，count是规则中配置的隔一段时间放出令牌的数量&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long costTime = Math.round(1.0 * (acquireCount) / count * 1000);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//从上次获取令牌之后下次放出令牌的时间&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//latestPassedTime 是 AtomicLong 类型&lt;/font&gt;&lt;/div&gt;&lt;div&gt;long expectedTime = costTime + latestPassedTime.get();&amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;if (expectedTime &amp;lt;= currentTime) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//已经有放出一个可用令牌，&lt;/font&gt;&lt;font color=&quot;#cc0000&quot;&gt;这里&lt;b&gt;没有保证线程安全，故意这么写的？并发冲突概率还是比较低的，可能人家认为没必要保证线程安全，即使多放出几个令牌对整体的流控也没多大影响&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; latestPassedTime.set(currentTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;} else {&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; //还没有发出可用令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 先判断是否在可等待时间范围内&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long waitTime = costTime + latestPassedTime.get() - TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (waitTime &amp;gt; maxQueueingTimeMs) { &lt;font color=&quot;#007fff&quot;&gt;//没有在范围内&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;//拒绝请求&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//在范围内&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//获取下个令牌发放时间&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long oldTime = latestPassedTime.addAndGet(costTime);&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; waitTime = oldTime - TimeUtil.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (waitTime &amp;gt; maxQueueingTimeMs) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; latestPassedTime.addAndGet(-costTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //睡眠等待 waitTime ms 后默认获取到新发放的令牌&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (waitTime &amp;gt; 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.sleep(waitTime);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return false;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="5000" y="4470" width="360" height="460" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-3" value="&lt;div&gt;if (baseWebMvcConfig.getBlockExceptionHandler() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;baseWebMvcConfig.getBlockExceptionHandler()&lt;/div&gt;&lt;div&gt;.handle(request, response, e);&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;即有配置 BaseWebMvcConfig.blockExceptionHandler 就使用这个处理器处理异常，没有就再抛出，使用MVC的&lt;b&gt;统一异常处理器&lt;/b&gt;处理&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1440" y="2020" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-5" target="JXVrsIax2Fh7985Lvlhv-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-5" value="@SentinelResource &lt;br&gt;自定义资源实现原理" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="2400" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-7" target="JXVrsIax2Fh7985Lvlhv-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-7" value="原理是通过SpringAOP切面（&lt;b&gt;SentinelResourceAspect&lt;/b&gt;）拦截注解的方法，自动调用Sentinel 客户端SphU API实现对资源的规则校验" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-9" target="JXVrsIax2Fh7985Lvlhv-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-9" value="&lt;b&gt;SentinelResourceAspect&lt;/b&gt;#&lt;br&gt;&lt;b&gt;invokeResourceWithSentinel&lt;/b&gt;(&lt;br&gt;ProceedingJoinPoint pjp)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="480" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.374;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-11" target="S1kR7U3J-qD7APwjgyKx-161" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1170" y="2365" />
              <mxPoint x="1170" y="1525" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-11" target="qvYtqrxYLjiLd9eBwE0J-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-11" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;public Object invokeResourceWithSentinel(ProceedingJoinPoint pjp) throws Throwable {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; Method originMethod = resolveMethod(pjp);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; SentinelResource &lt;b style=&quot;font-size: 11px;&quot;&gt;annotation&lt;/b&gt; = originMethod.getAnnotation(&lt;b style=&quot;font-size: 11px;&quot;&gt;SentinelResource&lt;/b&gt;.class);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (annotation == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Should not go through here.&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new IllegalStateException(&quot;Wrong state for SentinelResource annotation&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; String &lt;b style=&quot;font-size: 11px;&quot;&gt;resourceName&lt;/b&gt; = getResourceName(annotation.value(), originMethod);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; EntryType entryType = annotation.entryType();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; int resourceType = annotation.resourceType();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; Entry entry = null;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry = SphU.entry(resourceName, resourceType, entryType, pjp.getArgs());&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return pjp.proceed();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (BlockException ex) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return &lt;b style=&quot;font-size: 11px;&quot;&gt;handleBlockException&lt;/b&gt;(pjp, annotation, ex);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable ex) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Class&amp;lt;? extends Throwable&amp;gt;[] exceptionsToIgnore = annotation.exceptionsToIgnore();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // The ignore list will be checked first.&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (exceptionsToIgnore.length &amp;gt; 0 &amp;amp;&amp;amp; exceptionBelongsTo(ex, exceptionsToIgnore)) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw ex;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (exceptionBelongsTo(ex, annotation.exceptionsToTrace())) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; traceException(ex);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return &lt;b&gt;handleFallback&lt;/b&gt;(pjp, annotation, ex);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // No fallback function can handle the exception, so throw it out.&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw ex;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (entry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry.exit(1, pjp.getArgs());&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;和&amp;nbsp;SentinelWebInterceptor 的处理类似，异常处理有些差异&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="720" y="2170" width="440" height="520" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-14" target="JXVrsIax2Fh7985Lvlhv-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4100" y="4480" />
              <mxPoint x="4100" y="4550" />
              <mxPoint x="3260" y="4550" />
              <mxPoint x="3260" y="4630" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-14" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;从 DegradeRuleManager 通过资源名读取熔断规则集合，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;然后依次校验各个熔断规则&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;for (&lt;b&gt;CircuitBreaker&lt;/b&gt; cb : circuitBreakers) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!cb.&lt;b&gt;tryPass&lt;/b&gt;(context)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new &lt;b&gt;DegradeException&lt;/b&gt;(cb.getRule().getLimitApp(), cb.getRule());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="3720" y="4430" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#fff2cc;strokeColor=#000000;" parent="1" source="JXVrsIax2Fh7985Lvlhv-16" target="JXVrsIax2Fh7985Lvlhv-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-16" target="JXVrsIax2Fh7985Lvlhv-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-16" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;两种断路器实现&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="3280" y="4600" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-18" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;ExceptionCircuitBreaker&lt;/b&gt;#&lt;br&gt;tryPass(Context context)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;处理异常比率、异常数量两种模式的降级规则&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3480" y="4700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-22" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;DegradeRule&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;extends AbstractRule&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;熔断降级规则定义。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255); font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//断路器模式，默认类型是0按平均响应时间，另外还有：1按异常比率 2&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int grade = RuleConstant.DEGRADE_GRADE_RT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//阈值，&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RT模式下表示最大相应时间ms,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//EXCEPTION_RATIO模式下表示最大异常比率，&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//EXCEPTION_COUNT模式下表示最多的异常数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private double count;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//断路器打开后恢复时间（s），超时后，断路器将转换为半开状态以尝试接收一些请求&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int timeWindow;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//可以触发熔断的最小请求数（在活动统计时间跨度内）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int minRequestAmount = RuleConstant.DEGRADE_DEFAULT_MIN_REQUEST_AMOUNT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RT模式下慢请求率的阈值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private double slowRatioThreshold = 1.0d;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//统计间隔时间(ms)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int statIntervalMs = 1000;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-3480" y="320" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#000000;" parent="1" source="JXVrsIax2Fh7985Lvlhv-16" target="JXVrsIax2Fh7985Lvlhv-20" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="3480" y="4630" as="sourcePoint" />
            <mxPoint x="3620" y="4800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-20" target="JXVrsIax2Fh7985Lvlhv-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-20" value="&lt;font style=&quot;&quot;&gt;&lt;b&gt;ResponseTimeCircuitBreaker&lt;/b&gt;#&lt;br&gt;tryPass(Context context)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;RT模式，资源响应时间超过阈值后，所有对该资源的请求都会被拒绝&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3480" y="4600.02" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-25" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;if (currentState.get() == State.CLOSED) { &lt;font color=&quot;#007fff&quot;&gt;//断路器关闭，不熔断&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (currentState.get() == State.OPEN) { &lt;font color=&quot;#007fff&quot;&gt;//断路器开启&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //如果恢复超时，通过CAS尝试转成半开启状态，上图中的4&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;retryTimeoutArrived&lt;/b&gt;() &amp;amp;&amp;amp; &lt;b&gt;fromOpenToHalfOpen&lt;/b&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return false;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=4;align=left;" parent="1" vertex="1">
          <mxGeometry x="3720" y="4570" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractCircuitBreaker&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//降级规则&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final DegradeRule &lt;b&gt;rule&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//断路器开启后恢复时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final int &lt;b&gt;recoveryTimeoutMs&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventObserverRegistry &lt;b&gt;observerRegistry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//断路器状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final AtomicReference&amp;lt;State&amp;gt; &lt;b&gt;currentState&lt;/b&gt; = new AtomicReference&amp;lt;&amp;gt;(State.CLOSED);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long &lt;b&gt;nextRetryTimestamp&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="3120" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-29" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-28" target="JXVrsIax2Fh7985Lvlhv-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-28" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ResponseTimeCircuitBreaker&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final double SLOW_REQUEST_RATIO_MAX_VALUE = 1.0d;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//允许的最大平均响应时间&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;maxAllowedRt&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最大慢请求比率，实际的慢请求比率大于这个值，或者实际慢请求比率为1.0会开启断路器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final double &lt;b&gt;maxSlowRequestRatio&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//最小请求数量，只有请求数量达到这个值才可能开启断路器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final int &lt;b&gt;minRequestAmount&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//也是通过滑动窗口统计的，&lt;b&gt;统计数据全在这里&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final LeapArray&amp;lt;SlowRequestCounter&amp;gt; &lt;b&gt;slidingCounter&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//请求结束后更新统计数据，进而触发更新断路器状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;onRequestComplete&lt;/b&gt;(Context context)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-480" y="3360" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-30" target="JXVrsIax2Fh7985Lvlhv-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-30" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;断路器数据统计&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;注意不是在 StatisticSlot 中统计的，而是在 &lt;b&gt;DegradeSlot#exit()&lt;/b&gt; 中统计的&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3280" y="4020.02" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-34" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-31" target="JXVrsIax2Fh7985Lvlhv-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-31" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;background-color: rgb(43, 43, 43); font-size: 10px;&quot;&gt;&lt;pre style=&quot;font-size: 10px;&quot;&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;for (CircuitBreaker circuitBreaker : circuitBreakers) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;circuitBreaker.&lt;b&gt;onRequestComplete&lt;/b&gt;(context);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即遍历降级规则管理器中所有断路器执行onRequestComplete() 数据统计方法&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="3470" y="4010" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-33" target="JXVrsIax2Fh7985Lvlhv-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-33" value="&lt;font style=&quot;&quot;&gt;&lt;b&gt;ResponseTimeCircuitBreaker&lt;/b&gt;#&lt;br&gt;&lt;b&gt;onRequestComplete&lt;/b&gt;(Context context)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里只展示 RT 模式的断路器ResponseTimeCircuitBreaker&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3720" y="4020.02" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-37" value="&lt;font style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//获取当前时间对应的滑动窗口的桶（一个窗口中多个桶，桶内是一组计数器）&lt;/font&gt;&lt;br&gt;SlowRequestCounter counter = &lt;b&gt;slidingCounter&lt;/b&gt;.currentWindow().value();&lt;br&gt;Entry entry = context.getCurEntry();&lt;br&gt;...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//计算这个请求的响应时间&lt;/font&gt;&lt;br&gt;long completeTime = entry.getCompleteTimestamp();&lt;br&gt;long rt = completeTime - entry.getCreateTimestamp();&lt;br&gt;&lt;div&gt;if (rt &amp;gt; maxAllowedRt) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //慢请求，slowCount 计数器 + 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; counter.&lt;b&gt;slowCount&lt;/b&gt;.add(1);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//总的请求数量计数器 + 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;counter.&lt;b&gt;totalCount&lt;/b&gt;.add(1);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//根据统计数据更新断路器的状态，即下图 1|2|3&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;handleStateChangeWhenThresholdExceeded&lt;/b&gt;(rt);&lt;br&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="3960" y="3940.02" width="360" height="219.98" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-43" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-39" target="JXVrsIax2Fh7985Lvlhv-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-39" value="&lt;div&gt;请求处理&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="JXVrsIax2Fh7985Lvlhv-42" target="JXVrsIax2Fh7985Lvlhv-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-42" value="&lt;div&gt;&lt;b&gt;SentinelWebInterceptor&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;#afterCompletion(...)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;像一些RT数据是在这里触发统计的&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="480" y="1790" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-44" value="&lt;font color=&quot;#007fff&quot;&gt;DegradeSlot#exit()方法一方面会在&lt;b&gt;规则校验失败抛异常后调用&lt;/b&gt;；&lt;br&gt;另一方面会在&lt;b&gt;规则校验通过且处理完请求后在&amp;nbsp;SentinelWebInterceptor&lt;/b&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;#afterCompletion() 中调用&lt;/b&gt;；&lt;br&gt;这里统计降级规则数据就是在第二种情况中统计&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3280" y="4110" width="560" height="60" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="JXVrsIax2Fh7985Lvlhv-45" target="JXVrsIax2Fh7985Lvlhv-30" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1860" y="1940" />
              <mxPoint x="1860" y="4050" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-48" value="&lt;font color=&quot;#007fff&quot;&gt;这里省略了很多步骤&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="JXVrsIax2Fh7985Lvlhv-47" vertex="1" connectable="0">
          <mxGeometry x="0.9574" y="-2" relative="1" as="geometry">
            <mxPoint x="10" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-45" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;if (&lt;b&gt;increaseReferece&lt;/b&gt;(request, this.baseWebMvcConfig.getRequestRefName(), -1) != 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;Entry entry = &lt;b&gt;getEntryInRequest&lt;/b&gt;(request, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;baseWebMvcConfig.getRequestAttributeName());&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;if (entry == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; // should not happen&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; RecordLog.warn(...&lt;span style=&quot;background-color: initial;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这里有执行 entry.exit(), 会调用各个 ProcessorSlot的 exit()&lt;/font&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;traceExceptionAndExit&lt;/b&gt;(entry, ex);&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;removeEntryInRequest&lt;/b&gt;(request);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;ContextUtil.&lt;b&gt;exit&lt;/b&gt;();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=2;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="720" y="1790" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-61" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-49" target="JXVrsIax2Fh7985Lvlhv-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-62" value="&lt;font color=&quot;#007fff&quot;&gt;4&lt;br&gt;retryTimeoutArrived() &amp;amp;&amp;amp; fromOpenToHalfOpen(context)&lt;br&gt;即自从开启到现在已经 &amp;gt;= recoveryTimeoutMs，&lt;br&gt;通过CAS尝试转成半开启状态&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="JXVrsIax2Fh7985Lvlhv-61" vertex="1" connectable="0">
          <mxGeometry x="0.0082" y="2" relative="1" as="geometry">
            <mxPoint x="60" y="8" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-49" value="State.OPEN" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="3800" y="4210" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-53" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=1;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-50" target="JXVrsIax2Fh7985Lvlhv-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-54" value="2&lt;br&gt;rt &amp;lt;= maxAllowRt" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#007FFF;" parent="JXVrsIax2Fh7985Lvlhv-53" vertex="1" connectable="0">
          <mxGeometry x="-0.0316" y="-1" relative="1" as="geometry">
            <mxPoint x="17" y="-10" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-55" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-50" target="JXVrsIax2Fh7985Lvlhv-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-56" value="3&lt;br&gt;rt &amp;gt; maxAllowedRt" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#007FFF;" parent="JXVrsIax2Fh7985Lvlhv-55" vertex="1" connectable="0">
          <mxGeometry x="-0.0308" y="-1" relative="1" as="geometry">
            <mxPoint x="-8" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-50" value="State.HALF_OPEN" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="3560" y="4330" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-58" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" source="JXVrsIax2Fh7985Lvlhv-51" target="JXVrsIax2Fh7985Lvlhv-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-59" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;1&lt;br&gt;当前窗口内请求数量大于 minRequestAmount &amp;amp;&amp;amp;&lt;br&gt;（当前窗口慢请求比率 &amp;gt; maxSlowRequestRatio ||&lt;br&gt;当前窗口慢请求比率 == maxSlowRequestRatio == &lt;br&gt;SLOW_REQUEST_RATIO_MAX_VALUE)&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="JXVrsIax2Fh7985Lvlhv-58" vertex="1" connectable="0">
          <mxGeometry x="-0.0765" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="JXVrsIax2Fh7985Lvlhv-51" value="State.CLOSE" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="3320" y="4210" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="qvYtqrxYLjiLd9eBwE0J-1" target="qvYtqrxYLjiLd9eBwE0J-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-1" value="&lt;b&gt;handleBlockException&lt;/b&gt;(&lt;br&gt;request, response, e);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;规则校验失败会抛出 BlockException&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-3" value="AbstractSentinelAspectSupport" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1205" y="2370" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-4" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// blockHandler 存在就用 &lt;b&gt;blockHandler&lt;/b&gt; 处理异常，否则使用 f&lt;b&gt;allback&lt;/b&gt; 处理&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Method blockHandlerMethod = this.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;extractBlockHandlerMethod&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(pjp, annotation.blockHandler(), annotation.blockHandlerClass());&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;if (&lt;b&gt;blockHandlerMethod&lt;/b&gt; != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; Object[] originArgs = pjp.getArgs();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; Object[] args = Arrays.copyOf(originArgs, originArgs.length + 1);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; args[args.length - 1] = ex;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b&gt;invoke&lt;/b&gt;(pjp, blockHandlerMethod, args);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b&gt;handleFallback&lt;/b&gt;(pjp, annotation, ex);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1440" y="2350" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="qvYtqrxYLjiLd9eBwE0J-6" value="SentinelWebInterceptor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1225" y="2020" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="NLFEyrqeDpPYeB_EFXL_-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="NLFEyrqeDpPYeB_EFXL_-1" target="JXVrsIax2Fh7985Lvlhv-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NLFEyrqeDpPYeB_EFXL_-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="NLFEyrqeDpPYeB_EFXL_-1" target="NLFEyrqeDpPYeB_EFXL_-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="NLFEyrqeDpPYeB_EFXL_-1" value="&lt;b style=&quot;font-size: 11px;&quot;&gt;BaseWebMvcConfig Bean初始化&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;SentinelWebInterceptor 中通过构造函数注入 BaseWebMvcConfig Bean, 实现类型有两种，这里用到&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;SentinelWebMvcConfig&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1920" y="2039.96" width="200" height="80.08" as="geometry" />
        </mxCell>
        <mxCell id="NLFEyrqeDpPYeB_EFXL_-6" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 降级处理器的设置逻辑：先判断&amp;nbsp;blockExceptionHandlerOptional 即&lt;b&gt;自定义的 BlockExceptionHandler&lt;/b&gt; Bean 是否存在，存在就使用自定义的，不存在再看配置文件中有没有配置&lt;b&gt;阻塞页面&lt;/b&gt;，有的话重定向到阻塞页面，没有的话设置默认的 &lt;b&gt;DefaultBlockExceptionHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (this.blockExceptionHandlerOptional.isPresent()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.blockExceptionHandlerOptional.ifPresent(&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sentinelWebMvcConfig::setBlockExceptionHandler);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else if (StringUtils.hasText(this.properties.getBlockPage())) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; sentinelWebMvcConfig.setBlockExceptionHandler((request, response, e) -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.sendRedirect(this.properties.getBlockPage());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; sentinelWebMvcConfig.setBlockExceptionHandler(new DefaultBlockExceptionHandler());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2160" y="2040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="upGvQ8i2CHYi3lYlOZoj-1" target="upGvQ8i2CHYi3lYlOZoj-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-1" value="dataSourceProperties&lt;br&gt;.postRegister(newDataSource);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="1200" y="1150" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-3" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 这个过程可以看到每个数据源实例只能配置一种类型的规则&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;switch (this.getRuleType()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case FLOW:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; FlowRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case DEGRADE:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DegradeRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case PARAM_FLOW:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ParamFlowRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case SYSTEM:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SystemRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case AUTHORITY:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AuthorityRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case GW_FLOW:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; GatewayRuleManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; case GW_API_GROUP:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; GatewayApiDefinitionManager.register2Property(dataSource.getProperty());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="1440" y="1040" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-5" value="AbstractDataSource newDataSource = (AbstractDataSource)this.beanFactory&lt;br style=&quot;font-size: 11px;&quot;&gt;.getBean(dataSourceName);&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1200" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="upGvQ8i2CHYi3lYlOZoj-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="upGvQ8i2CHYi3lYlOZoj-5" target="S1kR7U3J-qD7APwjgyKx-134" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1400" y="650" as="sourcePoint" />
            <mxPoint x="1680" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S1kR7U3J-qD7APwjgyKx-134" value="new &lt;b&gt;NacosDataSource&lt;/b&gt;(properties, this.groupId, this.dataId, this.converter);&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;测试Demo中配置的是Nacos作为数据源&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1440" y="620" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="TN8HgY1CltahRotQwGUT" name="调用上下文">
    <mxGraphModel dx="1434" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-1" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="200" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-2" value="ContextUtil" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="105" y="50" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PiyzJssY4Ue3jckoztQY-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="rv9ZlCTTiJ06F9HG7BeC-3" target="rv9ZlCTTiJ06F9HG7BeC-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-3" value="ThreadLocal&amp;lt;Context&amp;gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;contextHolder" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="100" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-4" value="Map&amp;lt;String, DefaultNode&amp;gt; contextNameNodeMap" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="160" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-5" value="String name&lt;br&gt;private DefaultNode entranceNode;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="80" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="rv9ZlCTTiJ06F9HG7BeC-6" value="Context" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="350" y="50" width="60" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
