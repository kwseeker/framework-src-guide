<mxfile host="Electron" modified="2024-04-30T09:13:55.496Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="U_v2UW37py8wwdSt3EV8" version="21.6.5" type="device" pages="2">
  <diagram id="j0OrxLXEKiOk3vR1xS3o" name="编程式事务">
    <mxGraphModel dx="2364" dy="733" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="3k61qGwMEzmhM3xupUGX-4" value="连接来源" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;curved=1;strokeColor=#97D077;" parent="1" source="3k61qGwMEzmhM3xupUGX-2" target="t2Bh8Tgv82BLZMkkJCVr-75" edge="1">
          <mxGeometry x="-0.9806" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1320" y="1322" />
              <mxPoint x="2083" y="1322" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-25" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-9" target="t2Bh8Tgv82BLZMkkJCVr-39" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1320" y="1360" />
              <mxPoint x="1320" y="1651" />
              <mxPoint x="1130" y="1651" />
              <mxPoint x="1130" y="1931" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-47" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-42" target="3tcmVddGPVW7wgybLThJ-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-48" value="&lt;b&gt;else&lt;br&gt;即SUPPORTS/NOT_SUPPORTED/NEVER&lt;br&gt;&lt;/b&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#007FFF;" parent="3tcmVddGPVW7wgybLThJ-47" connectable="0" vertex="1">
          <mxGeometry x="-0.6824" y="-23" relative="1" as="geometry">
            <mxPoint x="13" y="23" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KUTTFBSQQBKSvKt4xpuZ-1" value="&lt;h1 style=&quot;font-size: 18px&quot;&gt;&lt;font style=&quot;font-size: 18px&quot;&gt;Spring 编程式事务 工作原理（5.0.7）&lt;/font&gt;&lt;/h1&gt;&lt;div&gt;这里讲Spring编程式事务的原理。声明式事务参考第2个Tab页(其实就是编程式事务+AOP)。&lt;/div&gt;&lt;p&gt;&lt;font style=&quot;font-size: 14px&quot;&gt;前置知识：&lt;/font&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;MySQL事务（事务是数据库提供的能力，从JDBC事务到Spring事务是对底层事务接口的层层封装）&lt;/li&gt;&lt;li&gt;Spring JDBCTemplate(JDBC事务操作、保存点)&lt;/li&gt;&lt;li&gt;Spring AOP (Spring对声明式事务的封装使用了AOP)&lt;/li&gt;&lt;li&gt;Spring组件（ReflectionUtils、...）&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="19" width="600" height="161" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;curved=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-2" target="6U_a8jkAf0Mo0z_RWQwz-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-2" value="start" style="ellipse;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="100" y="200" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;curved=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-3" target="6U_a8jkAf0Mo0z_RWQwz-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-16" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-3" target="3tcmVddGPVW7wgybLThJ-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint y="310" />
              <mxPoint y="280" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-3" value="DataSource ds = new &lt;b&gt;DriverManagerDataSource&lt;/b&gt;(&lt;br&gt;url, user, password)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建数据源&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-7" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-4" target="6U_a8jkAf0Mo0z_RWQwz-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#330000;dashed=1;curved=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-4" target="3tcmVddGPVW7wgybLThJ-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-11" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#007FFF;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-4" target="3tcmVddGPVW7wgybLThJ-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-17" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-4" target="3tcmVddGPVW7wgybLThJ-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-4" value="TransactionTemplate template = new &lt;b&gt;TransactionTemplate&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建与数据库事务连接模板&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-9" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-6" target="6U_a8jkAf0Mo0z_RWQwz-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-13" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#007FFF;dashed=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-6" target="3tcmVddGPVW7wgybLThJ-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-18" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-6" target="3tcmVddGPVW7wgybLThJ-19" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="310" y="560" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-6" value="PlatformTransactionManager txManager =&lt;br&gt;new &lt;b&gt;DataSourceTransactionManager&lt;/b&gt;(ds)&amp;nbsp;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-11" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-8" target="6U_a8jkAf0Mo0z_RWQwz-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-8" value="template.setTransactionManager(&lt;br&gt;txManager)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="640" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-13" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-10" target="6U_a8jkAf0Mo0z_RWQwz-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;curved=1;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-10" target="t2Bh8Tgv82BLZMkkJCVr-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="320" y="840" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-10" value="template.&lt;b&gt;execute&lt;/b&gt;(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="760" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-147" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="6U_a8jkAf0Mo0z_RWQwz-12" target="t2Bh8Tgv82BLZMkkJCVr-146" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="760" y="780" />
              <mxPoint x="760" y="385" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6U_a8jkAf0Mo0z_RWQwz-12" value="TransactionCallback#&lt;b&gt;doInTransaction&lt;/b&gt;(&lt;br&gt;TransactionStatus status)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="760" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-1" value="org.springframework.jdbc.datasource.DriverManagerDataSource" style="swimlane;startSize=20;" parent="1" vertex="1">
          <mxGeometry x="-520" y="280" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-2" value="&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;url&lt;/b&gt; = &quot;jdbc:mysql://localhost:3306/spring-tx?useSSL=false&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;username&lt;/b&gt; = &quot;root&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;password&lt;/b&gt; = &quot;123456&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;catalog = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;schema&lt;/b&gt; = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;connectionProperties&lt;/b&gt; = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="3tcmVddGPVW7wgybLThJ-1" vertex="1">
          <mxGeometry y="20" width="480" height="140" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#330000;curved=1;" parent="1" source="3tcmVddGPVW7wgybLThJ-3" target="3tcmVddGPVW7wgybLThJ-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-3" value="&amp;lt;cinit&amp;gt;&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="380" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-5" value="Constants constants = new Constants(&lt;b&gt;TransactionDefinition&lt;/b&gt;.class)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;读取TransactionDefinition public static final 字段存到&amp;nbsp;&lt;b&gt;fieldCache&lt;/b&gt; Map中，&lt;/font&gt;&lt;font color=&quot;#cc0066&quot;&gt;什么用？&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="375" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-7" value="org.springframework.transaction.support.TransactionTemplate" style="swimlane;startSize=20;" parent="1" vertex="1">
          <mxGeometry x="-520" y="480" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-8" value="&lt;div&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;transactionManager&lt;/b&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt; = null&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;propagationBehavior&lt;/b&gt;&lt;font color=&quot;#330000&quot;&gt; = 0&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//0是&lt;b&gt;PROPAGATION_REQUIRED&lt;/b&gt;, 即默认的事务传递策略&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;isolationLevel&lt;/b&gt;&lt;font color=&quot;#330000&quot;&gt; = -1&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;&#x9;&lt;/span&gt;&#x9;&#x9;&#x9;&lt;font color=&quot;#007fff&quot;&gt;//-1是&lt;b&gt;ISOLATION_DEFAULT&lt;/b&gt;, 即默认使用数据库默认的隔离级别&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;timeout = -1&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0) ; white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//TIMEOUT_DEFAULT&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;readOnly = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;name = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="3tcmVddGPVW7wgybLThJ-7" vertex="1">
          <mxGeometry y="20" width="480" height="140" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-9" value="&amp;lt;init&amp;gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是设置默认的事务传播策略、隔离级别等&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="440" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-15" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-12" target="3tcmVddGPVW7wgybLThJ-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-12" value="&amp;lt;cinit&amp;gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="500" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-14" value="&lt;font style=&quot;font-size: 9px&quot;&gt;Constants constants = new Constants(&lt;br&gt;&lt;b&gt;AbstractPlatformTransactionManager&lt;/b&gt;.class);&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;同上&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="500" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-25" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-19" target="3tcmVddGPVW7wgybLThJ-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-19" value="&amp;lt;init&amp;gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="560" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-23" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-20" target="3tcmVddGPVW7wgybLThJ-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-20" value="setDataSource(dataSource)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如果dataSource是代理对象，先获取原始类型对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="620" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-22" value="afterPropertiesSet()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;只是字段为空检查&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="680" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-26" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-24" target="3tcmVddGPVW7wgybLThJ-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-24" value="this()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;一些字段初始化&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="560" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-27" value="org.springframework.jdbc.datasource.DataSourceTransactionManager" style="swimlane;startSize=20;" parent="1" vertex="1">
          <mxGeometry x="-520" y="680" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-28" value="&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;dataSource&lt;/b&gt; = {DriverManagerDataSource@738}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;enforceReadOnly = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;transactionSynchronization = 0&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;defaultTimeout = -1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;nestedTransactionAllowed = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;validateExistingTransaction = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;globalRollbackOnParticipationFailure&lt;/b&gt; = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;failEarlyOnGlobalRollbackOnly = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;rollbackOnCommitFailure = false&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="3tcmVddGPVW7wgybLThJ-27" vertex="1">
          <mxGeometry y="20" width="480" height="140" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-8" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-3" target="t2Bh8Tgv82BLZMkkJCVr-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-10" value="N" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-3" target="t2Bh8Tgv82BLZMkkJCVr-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-3" value="&lt;font style=&quot;font-size: 8px&quot;&gt;this.transactionManager instanceof CallbackPreferringPlatformTransactionManager&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="340" y="840" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-7" value="&lt;font color=&quot;#007fff&quot;&gt;DEMO没走这里，TODO&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="560" y="860" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-12" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-9" target="t2Bh8Tgv82BLZMkkJCVr-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-25" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-9" target="t2Bh8Tgv82BLZMkkJCVr-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-9" value="TransactionStatus &lt;b&gt;status&lt;/b&gt; = this.transactionManager.getTransaction(this)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="310" y="960" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-14" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-11" target="t2Bh8Tgv82BLZMkkJCVr-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-19" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=1;entryDx=0;entryDy=0;fontSize=8;dashed=1;strokeColor=#00CC66;shape=link;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-11" target="6U_a8jkAf0Mo0z_RWQwz-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="540" y="3280" />
              <mxPoint x="540" y="800" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-11" value="result = action.doInTransaction(status)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在事务中执行业务操作&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="322.5" y="3260" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-16" value="Y, 异常" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-13" target="t2Bh8Tgv82BLZMkkJCVr-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-18" value="N，无异常" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-13" target="t2Bh8Tgv82BLZMkkJCVr-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-13" value="RuntimeException &lt;br&gt;| Error | Throwable ex" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="362.5" y="3360" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-23" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-15" target="t2Bh8Tgv82BLZMkkJCVr-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-158" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-15" target="t2Bh8Tgv82BLZMkkJCVr-157" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-15" value="rollbackOnException(status, ex)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="562.5" y="3380" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-21" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-17" target="t2Bh8Tgv82BLZMkkJCVr-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-113" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-17" target="xfdcjk_qxBO9EsxSu5Ji-112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-116" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-17" target="xfdcjk_qxBO9EsxSu5Ji-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-17" value="this.transactionManager.commit(status)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="322.5" y="3520.5" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-20" value="return result;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="322.5" y="3662" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-22" value="throw ex&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如果有外层事务，会被外层事务再次捕获&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="562.5" y="3440" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-27" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-24" target="t2Bh8Tgv82BLZMkkJCVr-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-39" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-24" target="3tcmVddGPVW7wgybLThJ-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-24" value="Object transaction = doGetTransaction();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从缓存获取事务对象（事务对象本质是带着事务控制参数的连接对象）&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="560" y="960" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-29" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-26" target="t2Bh8Tgv82BLZMkkJCVr-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-26" value="DataSourceTransactionObject txObject = new &lt;b&gt;DataSourceTransactionObject&lt;/b&gt;()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="960" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-31" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-28" target="t2Bh8Tgv82BLZMkkJCVr-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-28" value="txObject.setSavepointAllowed(&lt;br&gt;isNestedTransactionAllowed())&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;savepointAllowed = true;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="1020" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-33" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-30" target="t2Bh8Tgv82BLZMkkJCVr-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-30" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;div&gt;ConnectionHolder conHolder = (ConnectionHolder) &lt;b&gt;TransactionSynchronizationManager&lt;/b&gt;&lt;br&gt;.&lt;b&gt;getResource&lt;/b&gt;(obtainDataSource());&lt;/div&gt;&lt;div&gt;txObject.setConnectionHolder(conHolder, false);&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px&quot;&gt;从resources ThreadLocal中获取连接，&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px&quot;&gt;首次执行connectionHolder获取肯定为空，如果外层有事务就是返回外层事务的连接&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="785" y="1075" width="230" height="80" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-137" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;strokeColor=#97D077;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-32" target="t2Bh8Tgv82BLZMkkJCVr-69" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1380" y="1148" />
              <mxPoint x="1380" y="1970" />
              <mxPoint x="1590" y="1970" />
              <mxPoint x="1590" y="2290" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-32" value="Object value = doGetResource(actualKey)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从缓存&lt;b&gt;NamedThreadLocal&lt;/b&gt;找线程此数据源对应的连接的副本，首次获取为null,后面会创建并缓存到这个缓存空间，再内层事务再次获取就返回这个缓存的连接&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1060" y="1082.5" width="190" height="65" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-37" value="TransactionSynchronizationManager&lt;br&gt;.isSynchronizationActive()&lt;br&gt;即&amp;nbsp;synchronizations TheadLocal是否非空" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-34" target="t2Bh8Tgv82BLZMkkJCVr-36" edge="1">
          <mxGeometry x="-0.145" y="10" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1122.5" y="1920" />
              <mxPoint x="1122.5" y="1740" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-40" value="transaction != null" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-34" target="t2Bh8Tgv82BLZMkkJCVr-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-41" value="else" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-34" target="t2Bh8Tgv82BLZMkkJCVr-42" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1142.5" y="2020" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-41" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-34" target="t2Bh8Tgv82BLZMkkJCVr-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-34" value="SuspendedResourcesHolder suspendedResources = &lt;b&gt;suspend&lt;/b&gt;(null);&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;挂起事务；传递null, 就只是判断下事务同步器Set是否不为空，不为空要递归调用所有同步器的suspend方法然后将其他ThreadLocal资源重置&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="1890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-117" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=none;strokeColor=#000000;noLabel=1;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-36" target="t2Bh8Tgv82BLZMkkJCVr-116" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-119" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=none;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-36" target="t2Bh8Tgv82BLZMkkJCVr-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-36" value="suspendedSynchronizations = doSuspendSynchronization()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1162.5" y="1720" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-39" value="&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1162.5" y="1921" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-42" value="return null;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1162.5" y="2000" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-46" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-43" target="t2Bh8Tgv82BLZMkkJCVr-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-43" value="boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;true&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="2060" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-48" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-45" target="t2Bh8Tgv82BLZMkkJCVr-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-50" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-45" target="t2Bh8Tgv82BLZMkkJCVr-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-45" value="&lt;div&gt;DefaultTransactionStatus status = &lt;b&gt;newTransactionStatus&lt;/b&gt;(&lt;span&gt;definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;1 新建用于保存事务状态的对象&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="2135" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-47" value="&lt;div&gt;new &lt;b&gt;DefaultTransactionStatus&lt;/b&gt;(&lt;span&gt;transaction, newTransaction,actualNewSynchronization,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;definition.isReadOnly(), debug,suspendedResources)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2140" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-52" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-49" target="t2Bh8Tgv82BLZMkkJCVr-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-65" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-49" target="t2Bh8Tgv82BLZMkkJCVr-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-49" value="&lt;b&gt;doBegin&lt;/b&gt;(transaction, definition)&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;2 创建连接及连接初始化（是否设置只读、设置隔离级别、事务结束后是否恢复自动提交、事务超时时间等、最后绑定资源）&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="2225" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-55" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-51" target="t2Bh8Tgv82BLZMkkJCVr-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-51" value="prepareSynchronization(status, definition)&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;设置其他NamedThreadLocal的值&lt;/font&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;如：事务名称、只读标志、隔离级别、事务活跃状态&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="3060" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-57" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-54" target="t2Bh8Tgv82BLZMkkJCVr-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-54" value="return status&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;DefaultTransactionStatus类型&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="3120" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-59" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-56" target="t2Bh8Tgv82BLZMkkJCVr-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-56" value="RuntimeException &lt;br&gt;| Error ex&lt;br&gt;上面流程有异常？" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="922.5" y="3180" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-58" value="resume(null, suspendedResources)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="3200" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-70" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-62" target="t2Bh8Tgv82BLZMkkJCVr-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-72" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-62" target="t2Bh8Tgv82BLZMkkJCVr-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-62" value="Connection newCon = obtainDataSource().getConnection()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;刚启动没有建立连接，这里需要先建立连接&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="1362.5" y="2230" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-66" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-64" target="t2Bh8Tgv82BLZMkkJCVr-62" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-68" value="N" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-64" target="t2Bh8Tgv82BLZMkkJCVr-77" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1222.5" y="2294" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-64" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;!txObject.hasConnectionHolder() ||&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;&#x9;&#x9;&#x9;&#x9;&#x9;txObject.getConnectionHolder()&lt;br&gt;.isSynchronizedWithTransaction()&lt;/font&gt;&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-100" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-69" target="t2Bh8Tgv82BLZMkkJCVr-77" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1462.5" y="2340" />
              <mxPoint x="1222.5" y="2340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-69" value="txObject.setConnectionHolder(new ConnectionHolder(newCon), true)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将新建的连接缓存到connectionHolder&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1362.5" y="2290" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-74" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-71" target="t2Bh8Tgv82BLZMkkJCVr-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-71" value="getConnectionFromDriver(getUsername(), getPassword())" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1602.5" y="2230" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-76" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-73" target="t2Bh8Tgv82BLZMkkJCVr-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-73" value="getConnectionFromDriverManager(url, props)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1842.5" y="2230" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-75" value="DriverManager.getConnection(url, props);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;JDBC的接口（绿色节点）&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2082.5" y="2230" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-80" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-77" target="t2Bh8Tgv82BLZMkkJCVr-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-77" value="txObject.getConnectionHolder()&lt;br&gt;.&lt;b&gt;setSynchronizedWithTransaction&lt;/b&gt;(true)&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;只是创建个连接就算同步了？synchronizedWithTransaction字段是代表这意思吗？&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2360" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-82" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-79" target="t2Bh8Tgv82BLZMkkJCVr-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-79" value="con = txObject.getConnectionHolder()&lt;br&gt;.getConnection()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2430" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-85" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-81" target="t2Bh8Tgv82BLZMkkJCVr-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-139" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-81" target="t2Bh8Tgv82BLZMkkJCVr-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-81" value="Integer previousIsolationLevel = DataSourceUtils&lt;br&gt;.&lt;b&gt;prepareConnectionForTransaction&lt;/b&gt;(con, definition)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2490" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-87" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-84" target="t2Bh8Tgv82BLZMkkJCVr-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-84" value="txObject.setPreviousIsolationLevel(&lt;br&gt;previousIsolationLevel)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2600" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-89" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-86" target="t2Bh8Tgv82BLZMkkJCVr-88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-86" value="if (con.getAutoCommit()) :&amp;nbsp;&lt;br&gt;txObject.setMustRestoreAutoCommit(true)&lt;br&gt;con.&lt;b&gt;setAutoCommit&lt;/b&gt;(false);&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;如果当前是自动提交，记录一下事务执行完后要恢复设置为自动提交，然后关闭自动提交&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-93" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-88" target="t2Bh8Tgv82BLZMkkJCVr-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-95" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-88" target="t2Bh8Tgv82BLZMkkJCVr-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-88" value="prepareTransactionalConnection(con, definition)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2740" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-90" value="org.springframework.jdbc.datasource.DataSourceTransactionManager$DataSourceTransactionObject" style="swimlane;startSize=20;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="680" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-91" value="&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;newConnectionHolder&lt;/b&gt; = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;mustRestoreAutoCommit&lt;/b&gt; = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;connectionHolder&lt;/b&gt; = {ConnectionHolder@1479}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;previousIsolationLevel&lt;/b&gt; = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;savepointAllowed&lt;/b&gt; = true&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="t2Bh8Tgv82BLZMkkJCVr-90" vertex="1">
          <mxGeometry y="20" width="480" height="100" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-97" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-92" target="t2Bh8Tgv82BLZMkkJCVr-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-92" value="txObject.getConnectionHolder()&lt;br&gt;.setTransactionActive(true)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="2797.5" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-94" value="如果设置了事务只读&lt;br&gt;stmt.executeUpdate(&quot;SET TRANSACTION READ ONLY&quot;)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1362.5" y="2740" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-99" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-96" target="t2Bh8Tgv82BLZMkkJCVr-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-96" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;if (timeout != TransactionDefinition.TIMEOUT_DEFAULT)&amp;nbsp; :&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;txObject.getConnectionHolder()&lt;br&gt;.setTimeoutInSeconds(timeout);&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1102.5" y="2860" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-103" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-98" target="t2Bh8Tgv82BLZMkkJCVr-102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-141" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-98" target="t2Bh8Tgv82BLZMkkJCVr-140" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-98" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;div&gt;if (txObject.isNewConnectionHolder()) :&amp;nbsp;&lt;/div&gt;&lt;div&gt;TransactionSynchronizationManager.&lt;b&gt;bindResource&lt;/b&gt;(&lt;br&gt;obtainDataSource(), txObject.getConnectionHolder());&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#fad9d5;strokeColor=#ae4132;" parent="1" vertex="1">
          <mxGeometry x="1102.5" y="2920" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-102" value="出现异常的话释放连接" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1122.5" y="3020" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-30" value="NamedThreadLocal(&lt;br&gt;&quot;Transactional resources&quot;)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1250" y="1095" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-37" value="Y&lt;br&gt;&lt;font style=&quot;font-size: 7px&quot;&gt;说明存在外部事务，&lt;br&gt;使用外部事务处理&lt;br&gt;此内部事务&lt;br&gt;&lt;/font&gt;" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-31" target="3tcmVddGPVW7wgybLThJ-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-40" value="N, 当前没有连接对象，&lt;br&gt;事务对象是个空壳" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-31" target="3tcmVddGPVW7wgybLThJ-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-31" value="isExistingTransaction(&lt;br style=&quot;font-size: 9px&quot;&gt;transaction)&lt;br style=&quot;font-size: 9px&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;是否存在连接对象&lt;br&gt;且事务是活跃状态&lt;br&gt;首次走到这没有连接对象&lt;br&gt;&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="1160" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=7;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-36" target="xfdcjk_qxBO9EsxSu5Ji-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1020" y="1200" />
              <mxPoint x="1020" y="1240" />
              <mxPoint x="780" y="1240" />
              <mxPoint x="780" y="1440" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-36" value="&lt;b&gt;return&lt;/b&gt; &lt;b&gt;handleExistingTransaction&lt;/b&gt;(definition, transaction, debugEnabled)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;外部已有事务，处理内层事务都是走这里&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#f0a30a;fontColor=#000000;strokeColor=#BD7000;" parent="1" vertex="1">
          <mxGeometry x="800" y="1175" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-44" value="&lt;b&gt;PROPAGATION_MANDATORY&lt;/b&gt;" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-42" target="3tcmVddGPVW7wgybLThJ-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-45" value="&lt;b&gt;PROPAGATION_REQUIRED&lt;br&gt;||&amp;nbsp;PROPAGATION_REQUIRES_NEW&lt;br&gt;||&amp;nbsp;PROPAGATION_NESTED&lt;/b&gt;" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-42" target="t2Bh8Tgv82BLZMkkJCVr-34" edge="1">
          <mxGeometry y="40" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-42" value="definition&lt;br&gt;事务传播类型？&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;处理最外部事务走这里&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#f0a30a;fontColor=#000000;strokeColor=#BD7000;" parent="1" vertex="1">
          <mxGeometry x="602.5" y="1760" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-43" value="&lt;font style=&quot;font-size: 10px&quot;&gt;throw&amp;nbsp;&amp;nbsp;IllegalTransactionStateException&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px&quot;&gt;前面走N,当前没有没有外部事务，没法融合到外部事务，肯定是抛异常&lt;/font&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="1760" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-46" value="&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="882.5" y="3300" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-105" value="org.springframework.transaction.support.TransactionSynchronizationManager" style="swimlane;startSize=20;" parent="1" vertex="1">
          <mxGeometry x="-520" y="880" width="480" height="180" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-106" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;这个类可以当作一个工具类，内部都是static方法，包含一组NamedThreadLocal静态成员, 关于这个类的作用，可以参考附录，主要就是通过ThreadLocal为数据库连接等状态化的对象提供一种线程安全的访问方式，这样虽然Spring中Service-&amp;gt;DAO层都是单例对象，也可以在线上多线程环境下安全的访问底层有状态的资源。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;resources&lt;/b&gt;&lt;font color=&quot;#330000&quot;&gt; = {NamedThreadLocal@944} &quot;Transactional resources&quot;&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0) ; white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//Connection、Session 等资源，&lt;br&gt;数据源对象-&amp;gt;连接对象的Map&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;synchronizations&lt;/b&gt; = {NamedThreadLocal@945} &quot;Transaction synchronizations&quot; &lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务同步器Set&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;currentTransactionName&lt;/b&gt;&lt;font color=&quot;#330000&quot;&gt; = {NamedThreadLocal@946} &quot;Current transaction name&quot;&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0) ; white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务对象名称&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;currentTransactionReadOnly&lt;/b&gt; = {NamedThreadLocal@947} &quot;Current transaction read-only status&quot;　&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务只读状态&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;currentTransactionIsolationLevel&lt;/b&gt; = {NamedThreadLocal@948} &quot;Current transaction isolation level&quot; &lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务隔离级别&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;b&gt;actualTransactionActive&lt;/b&gt; = {NamedThreadLocal@949} &quot;Actual transaction active&quot; &lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务活跃状态&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="t2Bh8Tgv82BLZMkkJCVr-105" vertex="1">
          <mxGeometry y="20" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-107" value="&lt;h1 style=&quot;font-size: 18px&quot;&gt;&lt;span style=&quot;font-size: 14px ; font-weight: normal&quot;&gt;可借鉴学习：&lt;/span&gt;&lt;/h1&gt;&lt;ul&gt;&lt;li style=&quot;font-size: 11px&quot;&gt;事务同步机制[TransactionSynchronizationManager]　&lt;br&gt;本质：Spring通过ThreadLocal为状态化的对象提供一种线程安全的访问方法(使用线程私有的副本)。同时也方便工具类获取连接、注册事务同步器等操作，比如DataSourceUtils.getConnection() 、TransactionSynchronizationManager.registerSynchronization()。&lt;/li&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;参考&lt;/font&gt;&lt;span style=&quot;font-size: 11px&quot;&gt;：&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px&quot;&gt;https://www.lyytaw.com/spring/spring_tx_TransactionSynchronizationManager&lt;br&gt;https://cloud.tencent.com/developer/article/1497685&lt;/font&gt;&lt;br&gt;&lt;font style=&quot;font-size: 11px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;原理举例&lt;font color=&quot;#007fff&quot;&gt;：比如ThreadA、ThreadB连接数据库时都会维护一套自己的配置和状态（比如TransactionSynchronizationManager可以存储Connection、事务名称、只读状态、隔离级别、事务活跃状态等）存放在ThreadLocal，当某线程获取到执行权限，会加载自己的配置然后执行操作，执行完会或被抢占（比如事务被挂起）会将最新的配置和状态更新到ThreadLocal备用，然后将执行权限交给其他线程，其他线程加载自己的配置和状态，执行操作。&lt;/font&gt;&lt;font color=&quot;#cc0066&quot;&gt;看多线程下的事务代码验证一下&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;li style=&quot;font-size: 11px&quot;&gt;TransactionSynchronization 拓展点的使用&lt;br&gt;&lt;font style=&quot;font-size: 10px&quot; color=&quot;#007fff&quot;&gt;比如：&lt;br&gt;1）处理事务中异步操作的坑，参考测试Demo：&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;SpringTransactionAsyncExample&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="640" y="19" width="760" height="221" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-109" value="本测试：TransactionTemplate 包含&amp;nbsp;DataSourceTransactionManager,&amp;nbsp;&lt;br&gt;DataSourceTransactionManager包含DriverManagerDataSource ,&amp;nbsp;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="50" y="690" width="350" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-110" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.003;exitY=0.312;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;strokeColor=#00CC66;exitPerimeter=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-8" target="3tcmVddGPVW7wgybLThJ-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-540" y="544" />
              <mxPoint x="-540" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-111" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.172;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;strokeColor=#00CC66;exitPerimeter=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-28" target="3tcmVddGPVW7wgybLThJ-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-550" y="724" />
              <mxPoint x="-550" y="280" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-112" value="actualKey是前面配置的数据源" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1100" y="1060" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-113" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;事务传播类型：&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;MANDATORY&lt;/b&gt;：外部存在事务就将当前操作融合到外部事务，外部不存在事务就抛异常；&lt;/font&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;REQUIRED&lt;/b&gt;（默认）：外部存在事务就将当前操作融合到外部事务，外部不存在事务就新建事务；&lt;/font&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;REQUIRES_NEW&lt;/b&gt;：外部存在事务就将外部事务先挂起，然后创建新事务，外部不存在事务直接创建新事务；&lt;br&gt;&lt;/font&gt;&lt;b&gt;NESTED&lt;/b&gt;：外部存在事务就将当前操作融合到外部事务，SavePoint外层影响内层内层不影响外层，外部不存在事务直接创建新事务；&lt;br&gt;&lt;b&gt;SUPPORTS&lt;/b&gt;: 外部存在事务就将当前操作融合到外部事务，外部不存在事务也不创建新事务；&lt;br&gt;&lt;b&gt;NOT_SUPPORTED&lt;/b&gt;:&amp;nbsp;外部存在事务就将外部事务挂起，外部不存在事务也不创建新事务；&lt;br&gt;&lt;b&gt;NEVER&lt;/b&gt;:&amp;nbsp;外部存在事务就抛异常，外部不存在事务也不创建新事务；&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="297.5" y="1840" width="425" height="150" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-115" value="TransactionSynchronization 事务同步器接口：&lt;br&gt;参考Markdown文档" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-790" y="880" width="260" height="90" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-121" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=none;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-116" target="t2Bh8Tgv82BLZMkkJCVr-120" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-130" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-116" target="t2Bh8Tgv82BLZMkkJCVr-129" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-116" value="&lt;div&gt;if (transaction != null) {&lt;/div&gt;&lt;div&gt;suspendedResources = &lt;b&gt;doSuspend&lt;/b&gt;(transaction);&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是事务挂起操作&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1142.5" y="1780" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-118" value="1 遍历所有事务同步器执行suspend()方法" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1422.5" y="1720" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-123" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=none;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-120" target="t2Bh8Tgv82BLZMkkJCVr-122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-124" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=none;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-120" target="t2Bh8Tgv82BLZMkkJCVr-122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-120" value="txObject.setConnectionHolder(null)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;2 清除事务对象的连接对象&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1422.5" y="1785" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-126" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-122" target="t2Bh8Tgv82BLZMkkJCVr-125" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-164" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;strokeColor=#82b366;dashed=1;fillColor=#d5e8d4;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-122" target="t2Bh8Tgv82BLZMkkJCVr-98" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1662.5" y="1880" />
              <mxPoint x="1662.5" y="2920" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-122" value="TransactionSynchronizationManager&lt;br&gt;.&lt;b&gt;unbindResource&lt;/b&gt;(obtainDataSource())" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1422.5" y="1840" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-125" value="3.1 就是将resources ThreadLocal中此数据源的连接对象清除掉" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1662.5" y="1840" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-127" value="AbstractPlatformTransactionManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="892.5" y="1870" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-129" value="3.2 重置其他NamedThreadLocal的值&lt;br&gt;如：事务名称、只读标志、隔离级别、事务活跃状态&lt;font color=&quot;#007fff&quot;&gt;（设置为不活跃）&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1162.5" y="1860" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-132" value="&lt;font style=&quot;font-size: 10px&quot;&gt;即null事务挂起：&lt;br&gt;主要是释放TransactionSynchronizationManager中的NamedTheadLocal资源，即释放线程本地事务资源&lt;br&gt;另外事务同步器的suspend在事务本地资源释放前一步执行&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1652.5" y="1770" width="280" height="50" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-134" value="org.springframework.transaction.support.DefaultTransactionStatus" style="swimlane;startSize=20;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1100" width="480" height="180" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-135" value="&lt;div&gt;&lt;b&gt;transaction&lt;/b&gt; = {DataSourceTransactionManager$DataSourceTransactionObject@928}&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//事务对象，本质是连接, 要么是新建的（对最外层事务总是新建），要么是从resouces NamedThreadLocal拿的，具体看传播行为类型&lt;/font&gt;&lt;/div&gt;&lt;div&gt;newTransaction = true&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是新建的事务（连接），被融合的事务和外部事务处理的有差别使用这两个参数区分处理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;newSynchronization = true&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否要为事务新创建事务同步器的NamedThreadLocal（要求事务非活跃状态）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;readOnly = false&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否是只读事务&lt;/font&gt;&lt;/div&gt;&lt;div&gt;debug = true&lt;/div&gt;&lt;div&gt;&lt;b&gt;suspendedResources&lt;/b&gt; = null&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//被挂起的资源，即被挂起的事务（或称连接）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;rollbackOnly&lt;/b&gt; = false&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//是否需要回滚的标志&lt;/font&gt;&lt;/div&gt;&lt;div&gt;completed = false&lt;/div&gt;&lt;div&gt;&lt;b&gt;savepoint&lt;/b&gt; = null&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="t2Bh8Tgv82BLZMkkJCVr-134" vertex="1">
          <mxGeometry y="20" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-143" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-138" target="t2Bh8Tgv82BLZMkkJCVr-142" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-138" value="if (definition != null &amp;amp;&amp;amp; definition.isReadOnly()) :&amp;nbsp;&lt;br&gt;con.&lt;b&gt;setReadOnly&lt;/b&gt;(true)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1372.5" y="2495" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-145" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-140" target="t2Bh8Tgv82BLZMkkJCVr-144" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-140" value="&lt;div&gt;&lt;font size=&quot;1&quot;&gt;actualKey = TransactionSynchronizationUtils&lt;br&gt;.unwrapResourceIfNecessary(key)&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1382.5" y="2920" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-142" value="&lt;font style=&quot;font-size: 9px&quot;&gt;if (definition != null &amp;amp;&amp;amp; definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) :&amp;nbsp;&lt;br&gt;currentIsolation = con.getTransactionIsolation();&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;previousIsolationLevel = currentIsolation;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;&lt;span&gt;&#x9;&#x9;&#x9;&#x9;&lt;/span&gt;con.&lt;b&gt;setTransactionIsolation&lt;/b&gt;(definition.getIsolationLevel())&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1362.5" y="2560" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-144" value="&lt;div&gt;&lt;font size=&quot;1&quot;&gt;Map&amp;lt;Object, Object&amp;gt; map = resources.get();&lt;br&gt;&lt;/font&gt;&lt;b&gt;resources&lt;/b&gt;.set(map);&lt;br&gt;&lt;/div&gt;&lt;div&gt;map.put(actualKey, value)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即重新设置resources ThreadLocal，当前数据源到新建连接的映射&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1382.5" y="2980" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-149" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;curved=1;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-146" target="t2Bh8Tgv82BLZMkkJCVr-148" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3k61qGwMEzmhM3xupUGX-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-146" target="3k61qGwMEzmhM3xupUGX-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-146" value="Connection conn = DataSourceUtils.getConnection(ds)&lt;br&gt;&lt;font color=&quot;#cc0066&quot;&gt;获取的是同一个连接么？是；&lt;br&gt;之所以要随时注意获取的是否是同一个连接是因为事务作用域是会话（即连接），要保证事务有效必须确保是在一个连接会话中&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="350" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-152" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-148" target="t2Bh8Tgv82BLZMkkJCVr-151" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-148" value="第１个更新操作：&lt;br&gt;创建Statement并执行prepare.executeUpdate()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="440" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-154" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-151" target="t2Bh8Tgv82BLZMkkJCVr-153" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-56" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-151" target="3tcmVddGPVW7wgybLThJ-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-151" value="savePoint = status.createSavepoint();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="800" y="500" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-156" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-153" target="t2Bh8Tgv82BLZMkkJCVr-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-153" value="第２个更新操作：&lt;br&gt;创建Statement并执行prepare.executeUpdate()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="680" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-161" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-155" target="t2Bh8Tgv82BLZMkkJCVr-160" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-155" value="模拟发生运行时异常&lt;br&gt;throw new RuntimeException(&quot;test&quot;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="740" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-79" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-157" target="3tcmVddGPVW7wgybLThJ-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-157" value="this.transactionManager.rollback(status)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="762.5" y="3380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-163" value="Y&lt;br&gt;这里捕获异常&lt;br&gt;execute方法中&lt;br&gt;就不会捕获了，&lt;br&gt;除非再抛出" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-160" target="t2Bh8Tgv82BLZMkkJCVr-162" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-160" value="&lt;font style=&quot;font-size: 8px&quot;&gt;自行捕获异常？&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="800" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-51" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-162" target="3tcmVddGPVW7wgybLThJ-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-54" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="t2Bh8Tgv82BLZMkkJCVr-162" target="3tcmVddGPVW7wgybLThJ-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="t2Bh8Tgv82BLZMkkJCVr-162" value="捕获异常后可选择&lt;br&gt;处理措施" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1040" y="800" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-67" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-50" target="3tcmVddGPVW7wgybLThJ-66" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-50" value="status.rollbackToSavepoint(savePoint)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;回滚到保存点&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="760" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-77" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-52" target="3tcmVddGPVW7wgybLThJ-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-52" value="status.setRollbackOnly()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;说是手动触发回滚，只是设置了标志，&lt;/font&gt;&lt;font color=&quot;#cc0066&quot;&gt;看后面是怎么处理这个标志回滚的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1200" y="840" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-58" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-55" target="3tcmVddGPVW7wgybLThJ-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-55" value="getSavepointManager()&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;事务对象实现了SavepointManager接口，所以这里获取的就是DataSourceTransactionObject对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1040" y="500" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-60" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-57" target="3tcmVddGPVW7wgybLThJ-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-57" value="createSavepoint()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1040" y="560" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-62" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-59" target="3tcmVddGPVW7wgybLThJ-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-59" value="conHolder = getConnectionHolderForSavepoint()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1280" y="560" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-65" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-61" target="3tcmVddGPVW7wgybLThJ-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-61" value="return conHolder.createSavepoint()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1280" y="620" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-63" value="JdbcTransactionObjectSupport" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1315" y="540" width="130" height="20" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-64" value="this.savepointCounter++&lt;br&gt;return &lt;b&gt;getConnection()&lt;/b&gt;.&lt;b&gt;setSavepoint&lt;/b&gt;(&lt;br&gt;SAVEPOINT_NAME_PREFIX + this.savepointCounter)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1520" y="615" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-69" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-66" target="3tcmVddGPVW7wgybLThJ-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-66" value="getSavepointManager()&lt;br&gt;.rollbackToSavepoint(savepoint)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1420" y="760" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-71" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-68" target="3tcmVddGPVW7wgybLThJ-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-68" value="conHolder = getConnectionHolderForSavepoint()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1640" y="760" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-73" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-70" target="3tcmVddGPVW7wgybLThJ-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-70" value="conHolder.getConnection()&lt;br&gt;.rollback((Savepoint) savepoint)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1640" y="820" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-75" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-72" target="3tcmVddGPVW7wgybLThJ-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-72" value="conHolder.resetRollbackOnly()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1640" y="880" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-74" value="this.rollbackOnly = false" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1860" y="880" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-76" value="this.rollbackOnly = true;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1420" y="840" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-82" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-78" target="3tcmVddGPVW7wgybLThJ-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-78" value="processRollback(defStatus, false)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1002.5" y="3380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-80" value="AbstractPlatformTransactionManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1017.5" y="3360" width="170" height="20" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-86" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-81" target="3tcmVddGPVW7wgybLThJ-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-29" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-81" target="xfdcjk_qxBO9EsxSu5Ji-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-81" value="triggerBeforeCompletion(status)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1242.5" y="3380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-88" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-85" target="3tcmVddGPVW7wgybLThJ-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-90" value="N" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-85" target="3tcmVddGPVW7wgybLThJ-89" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-85" value="status.hasSavepoint()" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1282.5" y="3440" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-101" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-87" target="3tcmVddGPVW7wgybLThJ-97" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1522.5" y="3520" />
              <mxPoint x="1652.5" y="3520" />
              <mxPoint x="1652.5" y="3790" />
              <mxPoint x="1342.5" y="3790" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-73" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-87" target="xfdcjk_qxBO9EsxSu5Ji-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-87" value="status.rollbackToHeldSavepoint()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1442.5" y="3450" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-92" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-89" target="3tcmVddGPVW7wgybLThJ-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-107" value="N" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-89" target="3tcmVddGPVW7wgybLThJ-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-89" value="&lt;font style=&quot;font-size: 9px&quot;&gt;status.isNewTransaction()&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1282.5" y="3540" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-102" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-91" target="3tcmVddGPVW7wgybLThJ-97" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1342.5" y="3680.0000000000005" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1522.5" y="3620" />
              <mxPoint x="1632.5" y="3620" />
              <mxPoint x="1632.5" y="3790" />
              <mxPoint x="1342.5" y="3790" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-71" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-91" target="xfdcjk_qxBO9EsxSu5Ji-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-91" value="doRollback(status)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1442.5" y="3550" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-37" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-97" target="xfdcjk_qxBO9EsxSu5Ji-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-118" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="3tcmVddGPVW7wgybLThJ-97" target="xfdcjk_qxBO9EsxSu5Ji-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-97" value="triggerAfterCompletion(status, TransactionSynchronization&lt;br&gt;.&lt;font style=&quot;font-size: 8px&quot;&gt;STATUS_ROLLED_BACK&lt;/font&gt;)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1242.5" y="3840" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-42" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-98" target="xfdcjk_qxBO9EsxSu5Ji-43" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1480" y="4060" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-98" value="finally:&lt;br&gt;cleanupAfterCompletion(status)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事务资源清理&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1242.5" y="4040" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-110" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-106" target="3tcmVddGPVW7wgybLThJ-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-109" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="3tcmVddGPVW7wgybLThJ-106" target="xfdcjk_qxBO9EsxSu5Ji-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-106" value="&lt;font style=&quot;font-size: 9px&quot;&gt;status.hasTransaction()&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1282.5" y="3630" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-118" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;curved=1;" parent="1" source="3tcmVddGPVW7wgybLThJ-108" target="3tcmVddGPVW7wgybLThJ-97" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1520" y="3700" />
              <mxPoint x="1610" y="3700" />
              <mxPoint x="1610" y="3790" />
              <mxPoint x="1343" y="3790" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-120" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="3tcmVddGPVW7wgybLThJ-108" target="3tcmVddGPVW7wgybLThJ-121" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1682.5" y="3660.166666666667" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-108" value="&lt;font&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;if (status.&lt;b&gt;isLocalRollbackOnly&lt;/b&gt;() || &lt;b&gt;isGlobalRollbackOnParticipationFailure&lt;/b&gt;())&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;只是设置rollbackOnly=true,说我要回滚，实际回滚是给外部事务处理&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1440" y="3635" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-33" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="3tcmVddGPVW7wgybLThJ-121" target="xfdcjk_qxBO9EsxSu5Ji-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3tcmVddGPVW7wgybLThJ-121" value="doSetRollbackOnly(status);" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1682.5" y="3640" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-1" value="&lt;b&gt;测试Demo:&lt;br&gt;&lt;/b&gt;事件传播行为：SpringTransactionPropagationExample" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="260" y="200" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=7;fontColor=#007FFF;curved=1;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-3" target="xfdcjk_qxBO9EsxSu5Ji-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-8" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-3" target="xfdcjk_qxBO9EsxSu5Ji-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="900" y="1440" />
              <mxPoint x="900" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-16" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-3" target="xfdcjk_qxBO9EsxSu5Ji-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-17" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-3" target="xfdcjk_qxBO9EsxSu5Ji-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-18" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-3" target="xfdcjk_qxBO9EsxSu5Ji-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-3" value="事务传播类型？" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="1400" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-5" value="&lt;span style=&quot;font-size: 10px&quot;&gt;PROPAGATION_NEVER&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;外部存在事务直接抛异常&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="919.5" y="1260" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-10" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-7" target="xfdcjk_qxBO9EsxSu5Ji-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-7" value="&lt;font&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;PROPAGATION_NOT_SUPPORTED&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;外部存在事务先挂起，然后直接返回null事务的状态对象&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="919.5" y="1340" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-12" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=7;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-9" target="xfdcjk_qxBO9EsxSu5Ji-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-9" value="&lt;span style=&quot;font-size: 10px&quot;&gt;suspendedResources = &lt;b&gt;suspend&lt;/b&gt;(transaction)&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1119.5" y="1340" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-21" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-11" target="xfdcjk_qxBO9EsxSu5Ji-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-11" value="&lt;div&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;prepareTransactionStatus&lt;/b&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;definition, &lt;b&gt;null&lt;/b&gt;, false, newSynchronization, debugEnabled, suspendedResources)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1099.5" y="1400" width="210" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-13" value="&lt;font&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;PROPAGATION_REQUIRES_NEW&lt;/b&gt;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="918.5" y="1420" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-14" value="&lt;font&gt;&lt;b&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;PROPAGATION_NESTED&lt;/span&gt;&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;借助保存点实现，TODO&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="919.5" y="1500" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-27" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-15" target="xfdcjk_qxBO9EsxSu5Ji-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-15" value="&lt;span style=&quot;font-size: 10px&quot;&gt;PROPAGATION_SUPPORTS or &lt;b&gt;PROPAGATION_REQUIRED&lt;/b&gt;&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;外部存在事务直接返回对外部事务封装的新的状态对象&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="919.5" y="1580" width="170" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-19" value="&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;transactionSynchronization默认是SYNCHRONIZATION_ALWAYS&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;什么用？？？&lt;br&gt;源码注释说总是激活事务同步，即便返回的是空事务。&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=7;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1089" y="2060" width="271" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-24" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-20" target="xfdcjk_qxBO9EsxSu5Ji-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-20" value="&lt;div&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;&amp;nbsp;status = &lt;b&gt;newTransactionStatus&lt;/b&gt;(&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&#x9;&#x9;&#x9;&#x9;&lt;font style=&quot;font-size: 9px&quot;&gt;definition, transaction, newTransaction, newSynchronization, debug, suspendedResources)&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1357.5" y="1400" width="210" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-23" value="&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;prepareSynchronization&lt;/b&gt;(status, definition);&lt;br&gt;&lt;/span&gt;return status;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1357.5" y="1460" width="210" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-26" value="&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;prepareTransactionStatus&lt;/b&gt;(definition, &lt;b&gt;transaction&lt;/b&gt;, false, &lt;b&gt;newSynchronization&lt;/b&gt;, debugEnabled, null)&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=9;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1119.5" y="1585" width="200.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-69" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=8;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-28" target="xfdcjk_qxBO9EsxSu5Ji-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-28" value="if (status.isNewSynchronization())：&lt;br&gt;TransactionSynchronizationUtils.triggerBeforeCompletion()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;要求是新绑定的事务同步器才触发&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="3380" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-31" value="&lt;div style=&quot;text-align: left ; font-size: 10px&quot;&gt;&lt;span&gt;比如&lt;/span&gt;&lt;span&gt;PROPAGATION_REQUIRED，外部已有事务的情况下，对内层来说这里status（就是外部事务的status）内部不是新绑定的事务同步器，而是用的外部事务的事务同期器，内部当然不能执行，否则回到外部会再执行一次就重复了&lt;/span&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1480" y="3320" width="280" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-62" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-32" target="xfdcjk_qxBO9EsxSu5Ji-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-32" value="DataSourceTransactionObject txObject = (DataSourceTransactionObject) status.&lt;b&gt;getTransaction&lt;/b&gt;()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1880" y="3640" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-40" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-34" target="xfdcjk_qxBO9EsxSu5Ji-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-34" value="synchronizations = TransactionSynchronizationManager&lt;br&gt;.getSynchronizations()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1640" y="3840" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-38" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-36" target="xfdcjk_qxBO9EsxSu5Ji-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-36" value="&lt;font style=&quot;font-size: 9px&quot;&gt;status&lt;br&gt;.isNewSynchronization()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;同样需要判断是否是&lt;br&gt;新事务同步器&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="3830" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-106" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-39" target="xfdcjk_qxBO9EsxSu5Ji-105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-107" value="这不重复了么？上面的应该可以删掉" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#97D077;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-39" target="xfdcjk_qxBO9EsxSu5Ji-48" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1840" y="4060" />
              <mxPoint x="1900" y="4060" />
              <mxPoint x="1900" y="4180" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-39" value="TransactionSynchronizationManager&lt;br&gt;.clearSynchronization()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1640" y="3900" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-47" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-43" target="xfdcjk_qxBO9EsxSu5Ji-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-43" value="status.setCompleted()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="4040" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-51" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-46" target="xfdcjk_qxBO9EsxSu5Ji-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-84" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-46" target="xfdcjk_qxBO9EsxSu5Ji-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-46" value="status&lt;br&gt;.isNewSynchronization()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;右边是清理同步器&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1500" y="4110" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-75" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-48" target="xfdcjk_qxBO9EsxSu5Ji-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-82" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-48" target="xfdcjk_qxBO9EsxSu5Ji-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-48" value="TransactionSynchronizationManager&lt;br&gt;.clearSynchronization()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1682.5" y="4180" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-53" value="Y" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-50" target="xfdcjk_qxBO9EsxSu5Ji-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-55" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-50" target="xfdcjk_qxBO9EsxSu5Ji-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-50" value="status&lt;br&gt;.isNewTransaction()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;右边是清理除同步器外其他资源，以及恢复自动提交、释放连接&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1500" y="4370" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-95" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-52" target="xfdcjk_qxBO9EsxSu5Ji-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-52" value="doCleanupAfterCompletion(&lt;br&gt;status.getTransaction())" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1680" y="4380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-57" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-54" target="xfdcjk_qxBO9EsxSu5Ji-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-54" value="status&lt;br&gt;.getSuspendedResources() != null&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;当前事务（内层）有挂起的外部事务，比如PROPAGATION_REQUIRED&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="4625" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-59" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-56" target="xfdcjk_qxBO9EsxSu5Ji-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-56" value="Object transaction = (status.hasTransaction() ? status.getTransaction() : null)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1680" y="4645" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-58" value="&lt;b&gt;resume&lt;/b&gt;(transaction, (SuspendedResourcesHolder) status.getSuspendedResources())&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;恢复外层被挂起的事务&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1680" y="4720" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-65" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-61" target="xfdcjk_qxBO9EsxSu5Ji-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-61" value="&lt;b&gt;txObject&lt;/b&gt;.setRollbackOnly()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1880" y="3702" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-64" value="getConnectionHolder().setRollbackOnly();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注意这里是将连接的rollbackOnly标志设置为true&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2102.5" y="3702" width="197.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-68" value="遍历事务同步器执行&lt;b&gt;beforeCompletion&lt;/b&gt;()方法" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#e6d0de;gradientColor=#d5739d;strokeColor=#996185;" parent="1" vertex="1">
          <mxGeometry x="1780" y="3380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-70" value="&lt;font&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;txObject = (DataSourceTransactionObject) status.getTransaction();&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;con = txObject.getConnectionHolder().getConnection();&lt;/span&gt;&lt;br&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;con.&lt;b&gt;rollback&lt;/b&gt;()&lt;/font&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1680" y="3545" width="247.5" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-72" value="&lt;div&gt;conHolder = getConnectionHolderForSavepoint();&lt;br&gt;conHolder.getConnection().&lt;b&gt;rollback&lt;/b&gt;((Savepoint) savepoint);&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&#x9;&lt;/span&gt;conHolder.resetRollbackOnly(&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1680" y="3445" width="277.5" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-74" value="synchronizations.remove()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1942.5" y="4180" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-87" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-81" target="xfdcjk_qxBO9EsxSu5Ji-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-81" value="&lt;font style=&quot;font-size: 9px&quot;&gt;if (!status.hasTransaction() || status.isNewTransaction())：&lt;br&gt;遍历事务同步器执行&lt;/font&gt;synchronization.&lt;b&gt;afterCompletion&lt;/b&gt;(completionStatus)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#e6d0de;gradientColor=#d5739d;strokeColor=#996185;" parent="1" vertex="1">
          <mxGeometry x="1662.5" y="4240" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-85" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-83" target="xfdcjk_qxBO9EsxSu5Ji-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-83" value="synchronizations = TransactionSynchronizationManager&lt;br&gt;.getSynchronizations()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1682.5" y="4120" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-89" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-86" target="xfdcjk_qxBO9EsxSu5Ji-88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-86" value="&lt;font size=&quot;1&quot;&gt;else if (!synchronizations.isEmpty())&lt;br&gt;&lt;b&gt;registerAfterCompletionWithExistingTransaction&lt;/b&gt;(&lt;br&gt;status.getTransaction(), synchronizations);&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1662.5" y="4300" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-91" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-88" target="xfdcjk_qxBO9EsxSu5Ji-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-88" value="&lt;font size=&quot;1&quot;&gt;invokeAfterCompletion(synchronizations, &lt;b&gt;TransactionSynchronization.STATUS_UNKNOWN&lt;/b&gt;)&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1942.5" y="4300" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-90" value="遍历事务同步器执行&lt;br&gt;synchronization.&lt;b&gt;afterCompletion&lt;/b&gt;(completionStatus)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#e6d0de;gradientColor=#d5739d;strokeColor=#996185;" parent="1" vertex="1">
          <mxGeometry x="2220" y="4300" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-97" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-94" target="xfdcjk_qxBO9EsxSu5Ji-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-94" value="TransactionSynchronizationManager&lt;br&gt;.unbindResource(obtainDataSource())&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;释放同步器外其他资源&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1966.88" y="4380" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-99" value="" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-96" target="xfdcjk_qxBO9EsxSu5Ji-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-96" value="Connection con = txObject.getConnectionHolder().getConnection()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1958.13" y="4440" width="217.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-103" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-98" target="xfdcjk_qxBO9EsxSu5Ji-102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-98" value="&lt;div&gt;if (txObject.isMustRestoreAutoCommit()) {&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&#x9;&#x9;&lt;/span&gt;con.&lt;b&gt;setAutoCommit&lt;/b&gt;(true);&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&#x9;&lt;/span&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;恢复自动提交，前面开启事务时关闭了自动提交&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1958.13" y="4500" width="217.5" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-100" value="&lt;div&gt;if (txObject.isNewConnectionHolder()) {&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&#x9;&lt;/span&gt;DataSourceUtils.&lt;b&gt;releaseConnection&lt;/b&gt;(con, this.dataSource);&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&lt;/span&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如果是最外部事务就直接关闭连接，因为用不到了&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1920.94" y="4640" width="290.62" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-104" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-102" target="xfdcjk_qxBO9EsxSu5Ji-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-102" value="DataSourceUtils.resetConnectionAfterTransaction(&lt;br&gt;con, txObject.getPreviousIsolationLevel())&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;重置连接，因为内层如果新建事务，内层事务执行完也会清理资源，但是连接在外层事务还要使用&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1942.5" y="4570" width="247.5" height="50" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-105" value="synchronizations.remove()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1880" y="3900" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-110" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-108" target="3tcmVddGPVW7wgybLThJ-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-119" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#97D077;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-108" target="xfdcjk_qxBO9EsxSu5Ji-117" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="3740" />
              <mxPoint x="1220" y="3970" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-108" value="if (!isFailEarlyOnGlobalRollbackOnly())：&lt;br&gt;&lt;b&gt;unexpectedRollback&lt;/b&gt; = false;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1252.5" y="3720" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-121" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-112" target="3tcmVddGPVW7wgybLThJ-78" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="3541" />
              <mxPoint x="970" y="3400" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-112" value="if (defStatus.isLocalRollbackOnly()):&lt;br&gt;processRollback(defStatus, false)&lt;br&gt;return" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="3520.5" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-122" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-114" target="3tcmVddGPVW7wgybLThJ-78" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="3630" />
              <mxPoint x="970" y="3400" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-114" value="if (!shouldCommitOnGlobalRollbackOnly() &amp;amp;&amp;amp; defStatus.&lt;b&gt;isGlobalRollbackOnly&lt;/b&gt;()):&amp;nbsp;&lt;br&gt;&lt;div&gt;processRollback(defStatus, true);&lt;/div&gt;&lt;div&gt;&lt;span&gt;&#x9;&#x9;&#x9;&lt;/span&gt;return;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO: 这里的条件逻辑还有一点没梳理清&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="3600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-120" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;strokeColor=#000000;" parent="1" source="xfdcjk_qxBO9EsxSu5Ji-117" target="3tcmVddGPVW7wgybLThJ-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xfdcjk_qxBO9EsxSu5Ji-117" value="&lt;div&gt;if (&lt;b&gt;unexpectedRollback&lt;/b&gt;) :&amp;nbsp;&lt;/div&gt;&lt;div&gt;throw new &lt;b&gt;UnexpectedRollbackException&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1242.5" y="3940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3k61qGwMEzmhM3xupUGX-1" value="&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;这里是事务的真正开启&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot; color=&quot;#007fff&quot;&gt;对于MySQL自动提交打开的情况下：&lt;br&gt;START TRANSACTION 或 BEGIN手动开启事务，COMMIT ROLLBACK结束事务；&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot; color=&quot;#007fff&quot;&gt;不手动开启事务，每条DML都在一个事务中执行；&lt;br&gt;自动提交关闭的情况下：从关闭开始后面所有操作都处于一个事务中，直到COMMIT或ROLLBACK结束，然后会开启一个新的事务。&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="870" y="2660" width="249.5" height="70" as="geometry" />
        </mxCell>
        <mxCell id="3k61qGwMEzmhM3xupUGX-2" value="&lt;font style=&quot;font-size: 8px&quot;&gt;conHolder = (ConnectionHolder) &lt;b&gt;TransactionSynchronizationManager&lt;/b&gt;&lt;br&gt;.&lt;b&gt;getResource&lt;/b&gt;(dataSource);&lt;br&gt;return conHolder.getConnection();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;和猜想的一样是从名为resources的NamedThreadLocal中拿的，这里存的是事务开启前建的连接&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1040" y="355" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3k61qGwMEzmhM3xupUGX-5" value="&lt;b&gt;这里很重要，恢复了自动提交&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1805" y="4515" width="150" height="20" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="p5Dia_mpoU9N_-alUjp1" name="声明式事务">
    <mxGraphModel dx="1102" dy="872" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="wwtrWa-EpWfXN5D0lTTW-0" />
        <mxCell id="wwtrWa-EpWfXN5D0lTTW-1" parent="wwtrWa-EpWfXN5D0lTTW-0" />
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
