<mxfile host="Electron" modified="2025-01-07T16:49:13.346Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="tlbJu1--4azu7ervS9U-" version="21.6.5" type="device">
  <diagram name="第 1 页" id="anDfxD5Yjz07njIsCnzu">
    <mxGraphModel dx="2901" dy="764" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Seata AT GlobalLock工作原理 (v2.0.0)&lt;/font&gt;&lt;/h1&gt;&lt;div&gt;Seata 全局锁用于保证不同分布式事务的&lt;b&gt;写隔离&lt;/b&gt;和&lt;b&gt;读隔离；&lt;/b&gt;&lt;br&gt;这里只分析基于DB实现的全局锁实现原理。&lt;/div&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="620" height="70" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-2" target="IiQ-Olb6a7n2lc8_pSmE-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-6" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="IiQ-Olb6a7n2lc8_pSmE-5">
          <mxGeometry x="-0.2" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-2" value="&lt;b&gt;全局锁的获取&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;发生在TC处理分支事务注册请求处理流程中&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-3" value="&lt;b&gt;全局锁的释放&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-4" target="IiQ-Olb6a7n2lc8_pSmE-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-4" value="AbstractCore#&lt;b style=&quot;font-size: 11px;&quot;&gt;branchSessionLock&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-7" target="IiQ-Olb6a7n2lc8_pSmE-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-7" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;protected void branchSessionLock(GlobalSession globalSession, BranchSession branchSession)&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; String applicationData = branchSession.getApplicationData();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean autoCommit = true;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean skipCheckLock = false;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; ... applicationData 不为空的话，从里面读取 autoCommit skipCheckLock 的值 ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!branchSession.&lt;b style=&quot;font-size: 11px;&quot;&gt;lock&lt;/b&gt;(autoCommit, skipCheckLock)) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new BranchTransactionException(LockKeyConflict, ...&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; branchSession.getBranchId()));&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (StoreException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Throwable cause = e.getCause();&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (cause instanceof BranchTransactionException) {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new BranchTransactionException(...);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="120" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-9" value="ATCore" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="710" y="90" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-10" target="IiQ-Olb6a7n2lc8_pSmE-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-10" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;public boolean lock(boolean autoCommit, boolean skipCheckLock) throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (this.branchType.equals(BranchType.&lt;b style=&quot;font-size: 11px;&quot;&gt;AT&lt;/b&gt;)) {&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt; // 即全局锁仅用于AT模式&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return lockManager.&lt;b style=&quot;font-size: 11px;&quot;&gt;acquireLock&lt;/b&gt;(this, autoCommit, skipCheckLock);&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1000" y="200" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-12" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;BranchSession&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1170" y="170" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-13" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;LockManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean &lt;b&gt;acquireLock&lt;/b&gt;(BranchSession branchSession) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean &lt;b&gt;acquireLock&lt;/b&gt;(BranchSession branchSession, boolean autoCommit, boolean skipCheckLock) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean &lt;b&gt;releaseLock&lt;/b&gt;(BranchSession branchSession) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean releaseGlobalSessionLock(GlobalSession globalSession) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-440" y="120" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-18" target="IiQ-Olb6a7n2lc8_pSmE-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-18" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLockManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-440" y="360" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-20" target="IiQ-Olb6a7n2lc8_pSmE-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-20" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DataBaseLockManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Locker locker;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-440" y="520" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-23" target="IiQ-Olb6a7n2lc8_pSmE-32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-23" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;div&gt;public boolean acquireLock(BranchSession branchSession, boolean autoCommit, &lt;br&gt;&amp;nbsp; &amp;nbsp; boolean skipCheckLock) throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;// lockKey 由“表名:主键值”组成，主键值可能有多个使用“,”连接，还可能有多个表:主键值，使用“;”连接&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String lockKey = branchSession.&lt;b&gt;getLockKey&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 解析全部 &quot;表名:主键值“ 结合分支会话信息组成一组行锁&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;RowLock&amp;gt; locks = &lt;b&gt;collectRowLocks&lt;/b&gt;(branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (CollectionUtils.isEmpty(locks)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // DataBaseLockManager 初始化时创建了&amp;nbsp;DataBaseLocker&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;getLocker&lt;/b&gt;(branchSession).&lt;b&gt;acquireLock&lt;/b&gt;(&lt;b&gt;locks&lt;/b&gt;, autoCommit, skipCheckLock);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1480" y="160" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-25" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RowLock&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;行锁&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String xid;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Long transactionId;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private Long branchId;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String resourceId;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 表名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String tableName;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 主键值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String pk;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String &lt;b&gt;rowKey&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private String feature;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1320" y="320" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;endArrow=block;endFill=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-26" target="IiQ-Olb6a7n2lc8_pSmE-27">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-26" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLocker&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;protected static final String LOCK_SPLIT = &quot;^^^&quot;;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-880" y="320" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-27" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Locker&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean acquireLock(List&amp;lt;RowLock&amp;gt; rowLock) ;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean acquireLock(List&amp;lt;RowLock&amp;gt; rowLock, boolean autoCommit, boolean skipCheckLock);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean releaseLock(List&amp;lt;RowLock&amp;gt; rowLock);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean releaseLock(String xid, Long branchId);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean releaseLock(String xid);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-880" y="120" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-29" target="IiQ-Olb6a7n2lc8_pSmE-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-29" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DataBaseLocker&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// DAO 接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private LockStore &lt;b&gt;lockStore&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-880" y="480" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-31" value="&lt;font color=&quot;#007fff&quot;&gt;锁和锁管理器也有四种实现，这里只分析基于关系型数据库的实现&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-440" y="620" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-32" target="IiQ-Olb6a7n2lc8_pSmE-35">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2420" y="260" />
              <mxPoint x="2420" y="420" />
              <mxPoint x="260" y="420" />
              <mxPoint x="260" y="740" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-32" target="IiQ-Olb6a7n2lc8_pSmE-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-32" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//LockDO 是DB数据表中的数据对象&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return lockStore.&lt;b&gt;acquireLock&lt;/b&gt;(&lt;b&gt;convertToLockDO&lt;/b&gt;(locks), autoCommit, skipCheckLock);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=10;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1960" y="230" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-34" value="LockStoreDataBaseDAO" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2100" y="200" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IiQ-Olb6a7n2lc8_pSmE-35" target="IiQ-Olb6a7n2lc8_pSmE-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-35" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;public boolean acquireLock(List&amp;lt;LockDO&amp;gt; lockDOs, boolean autoCommit, boolean skipCheckLock) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // LockDO 去重&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (lockDOs.size() &amp;gt; 1) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lockDOs = lockDOs.stream().filter(LambdaUtils.&lt;b&gt;distinctByKey&lt;/b&gt;(LockDO::getRowKey)).collect(Collectors.toList());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn = lockStoreDataSource.getConnection();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (originalAutoCommit = conn.getAutoCommit()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn.setAutoCommit(false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;LockDO&amp;gt; unrepeatedLockDOs = lockDOs;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //获取锁前校验，需要先校验这些锁是否已经存在，有任意一个锁存在都不能获取锁&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!skipCheckLock) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean canLock = true;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 从锁的数据表中查询这些锁是否已经存在&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String checkLockSQL = LockStoreSqlFactory.getLogStoreSql(dbType).&lt;b&gt;getCheckLockableSql&lt;/b&gt;(lockTable, lockDOs.size());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // lockDOs中的锁都不存在，则获取这些锁，就是将它们插入到数据表&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (unrepeatedLockDOs.size() == 1) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 只有一个锁对象&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LockDO lockDO = unrepeatedLockDOs.get(0);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!doAcquireLock(conn, lockDO)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn.&lt;b&gt;rollback&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;// 可能插入前其他事务将锁插入了数据表，则当前事务获取锁失败，还需要当前事务将已经插入的锁回滚&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!doAcquireLocks(conn, unrepeatedLockDOs)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn.rollback();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn.commit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (SQLException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new StoreException(e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 释放连接，恢复自动提交 ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="440" width="680" height="600" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-37" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;protected boolean doAcquireLock(Connection conn, LockDO lockDO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; PreparedStatement ps = null;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String insertLockSQL = LockStoreSqlFactory.&lt;b&gt;getLogStoreSql&lt;/b&gt;(dbType)&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; .getInsertLockSQL(lockTable);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps = conn.prepareStatement(insertLockSQL);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setString(1, lockDO.getXid());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setLong(2, lockDO.getTransactionId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setLong(3, lockDO.getBranchId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setString(4, lockDO.getResourceId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setString(5, lockDO.getTableName());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setString(6, lockDO.getPk());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setString(7, lockDO.&lt;b&gt;getRowKey&lt;/b&gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ps.setInt(8, LockStatus.Locked.getCode());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return ps.executeUpdate() &amp;gt; 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } catch (SQLException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (e instanceof SQLIntegrityConstraintViolationException) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new StoreException(e);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; IOUtil.close(ps);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1000" y="580" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-39" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;insert into&amp;nbsp; #lock_table# (xid, transaction_id, branch_id, resource_id, table_name, pk, row_key, gmt_create, gmt_modified,status) &lt;/b&gt;&lt;br&gt;&lt;b&gt;values (?, ?, ?, ?, ?, ?, ?, now(), now(), ?);&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;br&gt;&lt;b&gt;获取锁原理就是基于主键唯一索引（row_key）进行插入，插入成功获取锁成功，插入失败获取锁失败，和Redis set nx 原理一样。&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1450" y="565" width="760" height="70" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-40" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;CREATE TABLE IF NOT EXISTS `&lt;b&gt;lock_table&lt;/b&gt;`&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;(&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `row_key`&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; VARCHAR(128) NOT NULL,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `xid`&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; VARCHAR(128),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `transaction_id` BIGINT,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `branch_id`&amp;nbsp; &amp;nbsp; &amp;nbsp; BIGINT&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;NOT NULL,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `resource_id`&amp;nbsp; &amp;nbsp; VARCHAR(256),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `table_name`&amp;nbsp; &amp;nbsp; &amp;nbsp;VARCHAR(32),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `pk`&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;VARCHAR(36),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `status`&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;TINYINT&amp;nbsp; &amp;nbsp; &amp;nbsp; NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;0:locked ,1:rollbacking&#39;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `gmt_create`&amp;nbsp; &amp;nbsp; &amp;nbsp;DATETIME,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; `gmt_modified`&amp;nbsp; &amp;nbsp;DATETIME,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;PRIMARY KEY&lt;/b&gt; (`&lt;b&gt;row_key&lt;/b&gt;`),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; KEY `idx_status` (`status`),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; KEY `idx_branch_id` (`branch_id`),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; KEY `idx_xid` (`xid`)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;) ENGINE = InnoDB&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; DEFAULT CHARSET = utf8mb4;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1450" y="640" width="500" height="270" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-41" value="&lt;font color=&quot;#007fff&quot;&gt;即删除锁的行记录&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="255" y="1095" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-42" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;protected LockDO convertToLockDO(RowLock rowLock) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; LockDO lockDO = new LockDO();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setBranchId(rowLock.getBranchId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setPk(rowLock.getPk());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setResourceId(rowLock.getResourceId());&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 锁记录的主键是 resourceId^^^tableName^^^pk 拼接成的，比如&amp;nbsp;&lt;/b&gt;&lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;jdbc:mysql://127.0.0.1:13306/seata_product^^^product^^^1&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.&lt;b&gt;setRowKey&lt;/b&gt;(&lt;b&gt;getRowKey&lt;/b&gt;(rowLock.getResourceId(), rowLock.getTableName(), rowLock.getPk()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setXid(rowLock.getXid());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setTransactionId(rowLock.getTransactionId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; lockDO.setTableName(rowLock.getTableName());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return lockDO;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="2440" y="160" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="IiQ-Olb6a7n2lc8_pSmE-44" value="&lt;b&gt;获取锁原理就是基于主键唯一索引（row_key）进行插入，&lt;br&gt;插入成功获取锁成功，插入失败获取锁失败，和Redis set nx 原理一样。&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="40" y="200" width="410" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
