<mxfile host="Electron" modified="2025-01-05T09:19:01.286Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="9m4Kc09ScU4s_A0ArjA1" version="21.6.5" type="device">
  <diagram name="第 1 页" id="3aabxiXxBKXcbQL7kUOO">
    <mxGraphModel dx="3915" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Seata Server (TC) 工作原理 (v2.0.0)&lt;/font&gt;&lt;/h1&gt;&lt;div&gt;seata-server 模块是一个SpringBoot Web应用, 主要依赖&amp;nbsp;seata-spring-autoconfigure-server、seata-core、seata-config-all、seata-discovery-all、数据库连接池及接口 模块，另外还依赖序列化、压缩、监控模块。&lt;/div&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="620" height="70" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-14" target="4g4Tmo7ESNFW7hSOMNtd-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="500" y="150" />
              <mxPoint x="500" y="230" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-2" target="4g4Tmo7ESNFW7hSOMNtd-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-2" value="Server端自动配置" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;ConfigProperties&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;配置中心的配置属性，seata.config&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String type = &quot;file&quot;;&lt;br style=&quot;font-size: 11px;&quot;&gt;private String preferredNetworks;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-4" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RegistryProperties&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;注册中心的配置属性&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String type = &quot;file&quot;;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 默认File, 线上常用配置中心中间件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String preferredNetworks;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="120" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;TransportProperties&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;通信配置属性&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String type = &quot;TCP&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String server = &quot;NIO&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean heartbeat = DEFAULT_TRANSPORT_HEARTBEAT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String serialization = &quot;seata&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private String compressor = &quot;none&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean enableClientBatchSendRequest = DEFAULT_ENABLE_CLIENT_BATCH_SEND_REQUEST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean enableTmClientBatchSendRequest = DEFAULT_ENABLE_TM_CLIENT_BATCH_SEND_REQUEST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean enableRmClientBatchSendRequest = DEFAULT_ENABLE_RM_CLIENT_BATCH_SEND_REQUEST;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private boolean enableTcServerBatchSendResponse = DEFAULT_ENABLE_TC_SERVER_BATCH_SEND_RESPONSE;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long rpcRmRequestTimeout = DEFAULT_RPC_RM_REQUEST_TIMEOUT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long rpcTmRequestTimeout = DEFAULT_RPC_TM_REQUEST_TIMEOUT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private long rpcTcRequestTimeout = DEFAULT_RPC_TC_REQUEST_TIMEOUT;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="120" width="400" height="360" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="760" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-6" target="4g4Tmo7ESNFW7hSOMNtd-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-6" value="一组配置属性&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;包括会话配置、持久化配置、服务端配置、服务端Raft协议配置、服务端恢复配置、服务端Undo配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-8" value="SeataServerEnvironmentPostProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-12" value="ServerProperties" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-13" value="StoreDBProperties" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-2" target="4g4Tmo7ESNFW7hSOMNtd-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="150" as="sourcePoint" />
            <mxPoint x="520" y="230" as="targetPoint" />
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-14" target="4g4Tmo7ESNFW7hSOMNtd-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-14" value="seata-spring-autoconfigure-server" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-17" target="4g4Tmo7ESNFW7hSOMNtd-20" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="310" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-17" target="4g4Tmo7ESNFW7hSOMNtd-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-17" value="seata-spring-autoconfigure-&lt;b&gt;core&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;由seata-spring-autoconfigure-server引入&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-20" target="4g4Tmo7ESNFW7hSOMNtd-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-20" target="4g4Tmo7ESNFW7hSOMNtd-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-20" target="4g4Tmo7ESNFW7hSOMNtd-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-20" target="4g4Tmo7ESNFW7hSOMNtd-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-20" value="一组配置属性&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置中心配置、注册中心配置、日志配置、关机配置、线程工厂配置、通信配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-21" value="ConfigProperties&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置前缀seata.config&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-23" value="ConfigNacosProperties&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置前缀seata.config.nacos&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-27" value="RegistryProperties&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置前缀seata.registry&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-29" value="RegistryNacosProperties&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;配置前缀seata.registry.nacos&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-31" value="SeataCoreEnvironmentPostProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-33" value="&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="220" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-34" value="&lt;font color=&quot;#007fff&quot;&gt;主要就是从配置文件加载一些配置&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;span style=&quot;border-color: var(--border-color); font-size: 11px;&quot;&gt;并注册到 StarterConstants.&lt;/span&gt;&lt;span style=&quot;border-color: var(--border-color); font-size: 11px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;PROPERTY_BEAN_MAP&lt;/b&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;代码调试时可以通过这个常量查看实际加载的配置&lt;/span&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="200" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-35" value="Http Controller 对外接口&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;主要是为了支持 Console 查询&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-38" target="Yp0WvUKOWmrbdsE2uwG8-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-38" target="Yp0WvUKOWmrbdsE2uwG8-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-38" target="Yp0WvUKOWmrbdsE2uwG8-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-38" target="Yp0WvUKOWmrbdsE2uwG8-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-49" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="4g4Tmo7ESNFW7hSOMNtd-38" target="Yp0WvUKOWmrbdsE2uwG8-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4g4Tmo7ESNFW7hSOMNtd-38" value="&lt;div&gt;public void &lt;b&gt;channelRead&lt;/b&gt;(final ChannelHandlerContext ctx, Object msg) &lt;br&gt;&amp;nbsp; &amp;nbsp; throws Exception {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;processMessage&lt;/b&gt;(ctx, (RpcMessage) msg);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="280" y="1640" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-1" target="Yp0WvUKOWmrbdsE2uwG8-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-1" value="ServerRunner" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-2" target="Yp0WvUKOWmrbdsE2uwG8-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-2" value="CommandLineRunner#run(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-4" target="Yp0WvUKOWmrbdsE2uwG8-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-4" value="Server.start(args);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;启动Netty服务端&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-6" target="Yp0WvUKOWmrbdsE2uwG8-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="920" />
              <mxPoint x="1450" y="780" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-31" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-30" vertex="1" connectable="0">
          <mxGeometry x="0.9141" y="3" relative="1" as="geometry">
            <mxPoint x="-12" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-6" target="Yp0WvUKOWmrbdsE2uwG8-34" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="920" />
              <mxPoint x="1450" y="1060" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-36" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-35" vertex="1" connectable="0">
          <mxGeometry x="0.8444" y="-2" relative="1" as="geometry">
            <mxPoint x="-6" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-6" value="&lt;div&gt;public static void start(String[] args) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 命令行参数解析&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ParameterParser parameterParser = new ParameterParser(args);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MetricsManager.get().init();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 默认：50, 500, 500s, 20000,&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ThreadPoolExecutor &lt;b&gt;workingThreads&lt;/b&gt; = new ThreadPoolExecutor(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; NettyServerConfig.getMinServerPoolSize(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; NettyServerConfig.getMaxServerPoolSize(),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; NettyServerConfig.getKeepAliveTime(), TimeUnit.SECONDS,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new LinkedBlockingQueue&amp;lt;&amp;gt;(NettyServerConfig.getMaxTaskQueueSize()),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new NamedThreadFactory(&quot;ServerHandlerThread&quot;, NettyServerConfig.getMaxServerPoolSize()),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new ThreadPoolExecutor.CallerRunsPolicy()); &lt;font color=&quot;#007fff&quot;&gt;//任务队列满后使用调用线程执行&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //127.0.0.1 and 0.0.0.0 are not valid here.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (NetUtil.&lt;b&gt;isValidIp&lt;/b&gt;(parameterParser.getHost(), false)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; XID.setIpAddress(parameterParser.getHost());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 默认走这里， 使用文件、配置配置中心的配置&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String preferredNetworks = ConfigurationFactory.getInstance().&lt;b&gt;getConfig&lt;/b&gt;(REGISTRY_PREFERED_NETWORKS);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (StringUtils.isNotBlank(preferredNetworks)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; XID.setIpAddress(NetUtil.getLocalIp(preferredNetworks.split(REGEX_SPLIT_CHAR)));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; XID.setIpAddress(NetUtil.&lt;b&gt;getLocalIp&lt;/b&gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; NettyRemotingServer nettyRemotingServer = new &lt;b&gt;NettyRemotingServer&lt;/b&gt;(workingThreads);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; XID.&lt;b&gt;setPort&lt;/b&gt;(nettyRemotingServer.getListenPort());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; UUIDGenerator.init(parameterParser.getServerNode());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ConfigurableListableBeanFactory beanFactory =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;((GenericWebApplicationContext)ObjectHolder.INSTANCE&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.getObject(OBJECT_KEY_SPRING_APPLICATION_CONTEXT)).getBeanFactory();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 默认的事务协调器实现&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;DefaultCoordinator&lt;/b&gt; &lt;b&gt;coordinator&lt;/b&gt; = DefaultCoordinator.getInstance(&lt;b&gt;nettyRemotingServer&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (coordinator instanceof ApplicationListener) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beanFactory.&lt;b&gt;registerSingleton&lt;/b&gt;(NettyRemotingServer.class.getName(), nettyRemotingServer);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; beanFactory.&lt;b&gt;registerSingleton&lt;/b&gt;(DefaultCoordinator.class.getName(), coordinator);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ((GenericWebApplicationContext)&lt;b&gt;ObjectHolder&lt;/b&gt;.INSTANCE.getObject(OBJECT_KEY_SPRING_APPLICATION_CONTEXT))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addApplicationListener((ApplicationListener&amp;lt;?&amp;gt;)coordinator);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1 会话管理，存储方式: file, db, redis&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SessionHolder.&lt;b&gt;init&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; LockerManagerFactory.&lt;b&gt;init&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 2 事务协调器初始化&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; coordinator.&lt;b&gt;init&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; nettyRemotingServer.&lt;b&gt;setHandler&lt;/b&gt;(coordinator);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // let ServerRunner do destroy instead ShutdownHook, see https://github.com/seata/seata/issues/4028&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ServerRunner.addDisposable(coordinator);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 3 启动TC Netty Server&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; nettyRemotingServer.init();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;arcSize=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="600" width="680" height="640" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;XID&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;Seata RPC 服务IP、端口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//端口默认是 HTTP端口 + 1000&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static int &lt;b style=&quot;font-size: 11px;&quot;&gt;port&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static String &lt;b style=&quot;font-size: 11px;&quot;&gt;ipAddress&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="320" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-9" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;TransactionMessageHandler&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RPC 消息处理器&lt;br&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;AbstractResultMessage &lt;b&gt;onRequest&lt;/b&gt;(AbstractMessage request, RpcContext context);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;void &lt;b&gt;onResponse&lt;/b&gt;(AbstractResultMessage response, RpcContext context);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-440" y="520" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-10" target="Yp0WvUKOWmrbdsE2uwG8-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-10" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractTCInboundHandler&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;抽象的事务协调器请求处理器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//端口默认是 HTTP端口 + 1000&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static int &lt;b&gt;port&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static String &lt;b&gt;ipAddress&lt;/b&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="680" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-11" target="Yp0WvUKOWmrbdsE2uwG8-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.002;exitY=0.83;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-11" target="Yp0WvUKOWmrbdsE2uwG8-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;DefaultCoordinator&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;事务协调器实现&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;private static final int TIMED_TASK_SHUTDOWN_MAX_WAIT_MILLS = 5000;&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final String TIME_FORMAT_PATTERN = &quot;yyyy-MM-dd HH:mm:ss.SSS&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long COMMITTING_RETRY_PERIOD = CONFIG.getLong(&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConfigurationKeys.COMMITING_RETRY_PERIOD,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DEFAULT_COMMITING_RETRY_PERIOD);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long ASYNC_COMMITTING_RETRY_PERIOD = CONFIG.getLong(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConfigurationKeys.ASYNC_COMMITING_RETRY_PERIOD, &lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DEFAULT_ASYNC_COMMITTING_RETRY_PERIOD);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long ROLLBACKING_RETRY_PERIOD = CONFIG.getLong(&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConfigurationKeys.ROLLBACKING_RETRY_PERIOD,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DEFAULT_ROLLBACKING_RETRY_PERIOD);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long TIMEOUT_RETRY_PERIOD = CONFIG.getLong(&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConfigurationKeys.TIMEOUT_RETRY_PERIOD,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DEFAULT_TIMEOUT_RETRY_PERIOD);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long UNDO_LOG_DELETE_PERIOD = CONFIG.getLong(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConfigurationKeys.TRANSACTION_UNDO_LOG_DELETE_PERIOD, &lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DEFAULT_UNDO_LOG_DELETE_PERIOD);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final long UNDO_LOG_DELAY_DELETE_PERIOD = 3 * 60 * 1000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int ALWAYS_RETRY_BOUNDARY = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int DEFAULT_BRANCH_ASYNC_QUEUE_SIZE = 5000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final int BRANCH_ASYNC_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final long MAX_COMMIT_RETRY_TIMEOUT = ConfigurationFactory.getInstance().getLong(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConfigurationKeys.MAX_COMMIT_RETRY_TIMEOUT, DEFAULT_MAX_COMMIT_RETRY_TIMEOUT);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final long MAX_ROLLBACK_RETRY_TIMEOUT = ConfigurationFactory.getInstance().getLong(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConfigurationKeys.MAX_ROLLBACK_RETRY_TIMEOUT, &lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DEFAULT_MAX_ROLLBACK_RETRY_TIMEOUT);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final boolean ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE = &lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConfigurationFactory.getInstance().getBoolean(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ConfigurationKeys.ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE, &lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;DEFAULT_ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ScheduledThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;retryRollbacking&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(RETRY_ROLLBACKING, 1));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ScheduledThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;retryCommitting&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(RETRY_COMMITTING, 1));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ScheduledThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;asyncCommitting&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(ASYNC_COMMITTING, 1));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ScheduledThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;timeoutCheck&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(TX_TIMEOUT_CHECK, 1));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ScheduledThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;undoLogDelete&lt;/b&gt; =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(UNDOLOG_DELETE, 1));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final GlobalStatus[] &lt;b style=&quot;font-size: 11px;&quot;&gt;rollbackingStatuses&lt;/b&gt; = new GlobalStatus[] {GlobalStatus.TimeoutRollbacking,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; GlobalStatus.TimeoutRollbackRetrying, GlobalStatus.RollbackRetrying, GlobalStatus.Rollbacking};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final GlobalStatus[] &lt;b style=&quot;font-size: 11px;&quot;&gt;retryCommittingStatuses&lt;/b&gt; = new GlobalStatus[] {GlobalStatus.Committing, GlobalStatus.CommitRetrying, GlobalStatus.Committed};&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final ThreadPoolExecutor &lt;b style=&quot;font-size: 11px;&quot;&gt;branchRemoveExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;// Netty Server 实例&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private &lt;b style=&quot;font-size: 11px;&quot;&gt;RemotingServer&lt;/b&gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b style=&quot;font-size: 11px;&quot;&gt;DefaultCore&lt;/b&gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;core&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;// 单例模式&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static volatile DefaultCoordinator &lt;b style=&quot;font-size: 11px;&quot;&gt;instance&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;重要方法：&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;// 处理事务消息请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public AbstractResultMessage &lt;b style=&quot;font-size: 11px;&quot;&gt;onRequest&lt;/b&gt;(AbstractMessage request, RpcContext context)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-640" y="840" width="600" height="840" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-14" target="Yp0WvUKOWmrbdsE2uwG8-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RaftCoordinator&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;基于 Raft 协议的事务协调器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected static final Map&amp;lt;String, Boolean&amp;gt; GROUP_PREVENT = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-640" y="1720" width="600" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-17" target="Yp0WvUKOWmrbdsE2uwG8-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-17" target="Yp0WvUKOWmrbdsE2uwG8-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-17" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Core&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;事务协调器核心接口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean &lt;b&gt;doGlobalCommit&lt;/b&gt;(GlobalSession globalSession, boolean retrying) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;boolean &lt;b&gt;doGlobalRollback&lt;/b&gt;(GlobalSession globalSession, boolean retrying) throws TransactionException;&lt;br&gt;void &lt;b&gt;doGlobalReport&lt;/b&gt;(GlobalSession globalSession, String xid, GlobalStatus param) throws TransactionException;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="920" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-18" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;事务管理器，负责向全局事务参与者发送事务控制请求，&lt;/b&gt;不是事务的容器，事务实例都是存储在线程本地的；&lt;br&gt;&lt;b&gt;事务管理器也是通过 SPI 机制加载的，静态内部类实现的单例模式。&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String &lt;b&gt;begin&lt;/b&gt;(String applicationId, String transactionServiceGroup, String name, int timeout)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;throws TransactionException;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;GlobalStatus &lt;b&gt;commit&lt;/b&gt;(String xid) throws TransactionException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;GlobalStatus &lt;b&gt;rollback&lt;/b&gt;(String xid) throws TransactionException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;GlobalStatus getStatus(String xid) throws TransactionException;&lt;br&gt;GlobalStatus globalReport(String xid, GlobalStatus globalStatus) throws TransactionException;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-880" y="520" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-19" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ResourceManagerOutbound&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于资源管理器向TC发送Outbound请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Long &lt;b&gt;branchRegister&lt;/b&gt;(BranchType branchType, String resourceId, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;String clientId, String xid, String applicationData, String lockKeys) throws&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; TransactionException;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;branchReport&lt;/b&gt;(BranchType branchType, String xid, long branchId, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;BranchStatus status, String applicationData) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean &lt;b&gt;lockQuery&lt;/b&gt;(BranchType branchType, String resourceId, String xid, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;String lockKeys)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;throws TransactionException;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="520" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-20" target="Yp0WvUKOWmrbdsE2uwG8-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-20" target="Yp0WvUKOWmrbdsE2uwG8-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionCoordinatorInbound&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="760" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-21" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;TransactionCoordinatorOutbound&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;事务协调器向资源管理器发送 Outbound&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;BranchStatus &lt;b&gt;branchCommit&lt;/b&gt;(GlobalSession globalSession, BranchSession &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;branchSession) throws TransactionException;&lt;br&gt;BranchStatus &lt;b&gt;branchRollback&lt;/b&gt;(GlobalSession globalSession, BranchSession&lt;br&gt;&amp;nbsp; &amp;nbsp; branchSession) throws TransactionException;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="760" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;dashed=1;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-26" target="Yp0WvUKOWmrbdsE2uwG8-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-26" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DefaultCore&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;事务协调器请求处理核心实现&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//端口默认是 HTTP端口 + 1000&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;private static final int RETRY_XAER_NOTA_TIMEOUT = ConfigurationFactory.getInstance().getInt(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;XAER_NOTA_RETRY_TIMEOUT,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;DefaultValues.DEFAULT_XAER_NOTA_RETRY_TIMEOUT);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static Map&amp;lt;&lt;b&gt;BranchType&lt;/b&gt;, &lt;b&gt;AbstractCore&lt;/b&gt;&amp;gt; &lt;b&gt;coreMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final boolean PARALLEL_HANDLE_BRANCH =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ConfigurationFactory.getInstance().getBoolean(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ENABLE_PARALLEL_HANDLE_BRANCH_KEY, false);&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1440" y="1120" width="640" height="200" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-29" value="&lt;font color=&quot;#007fff&quot;&gt;// 启动5个定时任务&lt;/font&gt;&lt;br&gt;&lt;div&gt;&lt;b&gt;retryRollbacking&lt;/b&gt;.scheduleAtFixedRate(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt; SessionHolder.distributedLockAndExecute(RETRY_ROLLBACKING, this::handleRetryRollbacking), 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ROLLBACKING_RETRY_PERIOD, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;retryCommitting&lt;/b&gt;.scheduleAtFixedRate(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt; SessionHolder.distributedLockAndExecute(RETRY_COMMITTING, this::handleRetryCommitting), 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; COMMITTING_RETRY_PERIOD, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;asyncCommitting&lt;/b&gt;.scheduleAtFixedRate(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt; SessionHolder.distributedLockAndExecute(ASYNC_COMMITTING, this::handleAsyncCommitting), 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ASYNC_COMMITTING_RETRY_PERIOD, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 4 超时检查，检查所有 Begin 状态的全局会话是否超时&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;timeoutCheck&lt;/b&gt;.scheduleAtFixedRate(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt; SessionHolder.distributedLockAndExecute(TX_TIMEOUT_CHECK, this::timeoutCheck), 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; TIMEOUT_RETRY_PERIOD, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;undoLogDelete&lt;/b&gt;.scheduleAtFixedRate(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt; SessionHolder.distributedLockAndExecute(UNDOLOG_DELETE, this::undoLogDelete),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; UNDO_LOG_DELAY_DELETE_PERIOD, UNDO_LOG_DELETE_PERIOD, TimeUnit.MILLISECONDS);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;arcSize=2;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="600" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-34" target="Yp0WvUKOWmrbdsE2uwG8-37" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1930" y="1060" />
              <mxPoint x="1930" y="1200" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-54" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-38" vertex="1" connectable="0">
          <mxGeometry x="0.8" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-34" target="Yp0WvUKOWmrbdsE2uwG8-50" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1930" y="1060" />
              <mxPoint x="1930" y="1520" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-55" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-53" vertex="1" connectable="0">
          <mxGeometry x="0.92" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-59" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-53" vertex="1" connectable="0">
          <mxGeometry x="0.444" y="-4" relative="1" as="geometry">
            <mxPoint x="4" y="69" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-34" value="&lt;div&gt;public void init() {&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1 注册RPC处理器，5种处理器&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;registerProcessor&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (initialized.compareAndSet(false, true)) {&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;// 和 RocketMQ Netty Server 差不多，不详细分析了&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;// 2 监听连接的端口通过 server.servicePort 配置指定&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.&lt;b&gt;init&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;arcSize=7;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1000" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1.002;entryY=0.664;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryPerimeter=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-37" target="QYUXZyDFh2rJFv0anni3-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2660" y="1200" />
              <mxPoint x="2660" y="1610" />
              <mxPoint x="2190" y="1610" />
              <mxPoint x="2190" y="1786" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-37" value="&lt;div&gt;private void registerProcessor() {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1. registry on request message processor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ServerOnRequestProcessor &lt;b&gt;onRequestProcessor&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ServerOnRequestProcessor&lt;/b&gt;(this, getHandler());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ShutdownHook.getInstance().addDisposable(onRequestProcessor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_BRANCH_REGISTER&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_BRANCH_STATUS_REPORT&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_BEGIN&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_COMMIT&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_LOCK_QUERY&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_REPORT&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_ROLLBACK&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_GLOBAL_STATUS&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_SEATA_MERGE&lt;/b&gt;, onRequestProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 2. registry on response message processor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ServerOnResponseProcessor &lt;b&gt;onResponseProcessor&lt;/b&gt; =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new &lt;b&gt;ServerOnResponseProcessor&lt;/b&gt;(getHandler(), getFutures());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_BRANCH_COMMIT_RESULT&lt;/b&gt;, onResponseProcessor, branchResultMessageExecutor);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_BRANCH_ROLLBACK_RESULT&lt;/b&gt;, onResponseProcessor, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;branchResultMessageExecutor);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 3. registry rm message processor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RegRmProcessor &lt;b&gt;regRmProcessor&lt;/b&gt; = new &lt;b&gt;RegRmProcessor&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_REG_RM&lt;/b&gt;, regRmProcessor, messageExecutor);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 4. registry tm message processor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RegTmProcessor &lt;b&gt;regTmProcessor&lt;/b&gt; = new &lt;b&gt;RegTmProcessor&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_REG_CLT&lt;/b&gt;, regTmProcessor, null);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 5. registry heartbeat message processor&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ServerHeartbeatProcessor &lt;b&gt;heartbeatMessageProcessor&lt;/b&gt; = new &lt;b&gt;ServerHeartbeatProcessor&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; super.registerProcessor(MessageType.&lt;b&gt;TYPE_HEARTBEAT_MSG&lt;/b&gt;, heartbeatMessageProcessor, null);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;arcSize=2;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1000" width="680" height="400" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-73" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-39" target="Yp0WvUKOWmrbdsE2uwG8-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-39" value="&lt;b&gt;ServerOnRequestProcessor&lt;br&gt;#process(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;事务操作相关请求处理&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-41" target="9im45_5cZYxTOmNjTaqy-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-41" value="ServerOnResponseProcessor&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分支事务提交或回滚结果响应处理&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-43" target="9im45_5cZYxTOmNjTaqy-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-43" value="RegRmProcessor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;注册客户端RM资源管理器，用于全局事务的提交或回滚回调&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-44" value="RegTmProcessor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;注册客户端TM事务管理器，用于全局事务的提交或回滚回调, &lt;/b&gt;主要也是存储一下连接&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="2100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-45" value="ServerHeartbeatProcessor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;处理客户端心跳请求，不需要处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-50" value="&lt;div&gt;.childHandler(new ChannelInitializer&amp;lt;SocketChannel&amp;gt;() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; public void initChannel(SocketChannel ch) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ch.&lt;b&gt;pipeline&lt;/b&gt;().addLast(new &lt;b&gt;IdleStateHandler&lt;/b&gt;(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;nettyServerConfig.getChannelMaxReadIdleSeconds(), 0, 0))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addLast(new &lt;b&gt;ProtocolV1Decoder&lt;/b&gt;())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addLast(new &lt;b&gt;ProtocolV1Encoder&lt;/b&gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (channelHandlers != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addChannelPipelineLast(ch, &lt;b&gt;channelHandlers&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;arcSize=4;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1440" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-56" value="&lt;b&gt;Pipeline&lt;/b&gt;:&amp;nbsp;&lt;br&gt;IdleStateHandler ---&amp;gt; ProtocolV1Decoder ---&amp;gt; ServerHandler&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ProtocolV1Encoder" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2415" y="1473" width="350" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-57" value="NettyRemotingServer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1630" y="970" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-58" value="&lt;b&gt;AbstractNettyRemotingServer&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2205" y="970" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-60" value="NettyServerBootstrap" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2110" y="1410" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-61" value="&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;请求编码后数据格式：&lt;br&gt;&lt;/b&gt;2bytes: magic code&lt;br&gt;1bytes: ProtocolVer&lt;br&gt;4bytes: Full length,（head + body）的长度&lt;br&gt;2bytes: Head Length, 消息头的长度&lt;br&gt;1bytes: Msg Type,&amp;nbsp;&lt;br&gt;1bytes: Serializer, 序列化类型&lt;br&gt;1bytes: Compress, 压缩类型&lt;br&gt;4bytes: RequestId, 请求ID&lt;br&gt;Mbytes: HeadMap&lt;br&gt;Nbytes: body&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="1720" width="230" height="170" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-62" target="Yp0WvUKOWmrbdsE2uwG8-68" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1120" y="1680" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-62" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;AbstractNettyRemotingServer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;private final NettyServerBootstrap serverBootstrap;&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="1720" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-64" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-63" target="Yp0WvUKOWmrbdsE2uwG8-62" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-63" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;NettyRemotingServer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;Netty服务器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private TransactionMessageHandler transactionMessageHandler;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 11px;&quot;&gt;private final AtomicBoolean initialized = new AtomicBoolean(false);&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="1840" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-68" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;AbstractNettyRemotingServer&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ScheduledExecutorService &lt;b&gt;timerExecutor&lt;/b&gt; = new&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; ScheduledThreadPoolExecutor(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 1, new NamedThreadFactory(&quot;timeoutChecker&quot;, 1, true));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ThreadPoolExecutor &lt;b&gt;messageExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final PositiveAtomicCounter &lt;b&gt;idGenerator&lt;/b&gt; = new&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; PositiveAtomicCounter();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final ConcurrentHashMap&amp;lt;Integer, MessageFuture&amp;gt; &lt;b&gt;futures&lt;/b&gt; = new&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long NOT_WRITEABLE_CHECK_MILLS = 10L;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile long &lt;b&gt;nowMills&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int TIMEOUT_CHECK_INTERVAL = 3000;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Object &lt;b&gt;lock&lt;/b&gt; = new Object();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected volatile boolean &lt;b&gt;isSending&lt;/b&gt; = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String group = &quot;DEFAULT&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// MessageType (事务消息类型) -&amp;gt; &amp;lt;消息处理器， 执行消息处理的线程池&amp;gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final HashMap&amp;lt;Integer/*MessageType*/, Pair&amp;lt;RemotingProcessor,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; ExecutorService&amp;gt;&amp;gt; &lt;b&gt;processorTable&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;(32);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final List&amp;lt;RpcHook&amp;gt; &lt;b&gt;rpcHooks&lt;/b&gt; = EnhancedServiceLoader.loadAll(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; RpcHook.class);&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="1360" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-70" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-69" target="4g4Tmo7ESNFW7hSOMNtd-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-69" value="ServerHandler RPC对外接口&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过消息类型分发给对应处理器处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-71" value="AbstractNettyRemotingServer$ServerHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="365" y="1610" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-12" target="Yp0WvUKOWmrbdsE2uwG8-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-2" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Yp0WvUKOWmrbdsE2uwG8-79" vertex="1" connectable="0">
          <mxGeometry x="-0.1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-72" value="&lt;div&gt;private void onRequestMessage(ChannelHandlerContext ctx, RpcMessage rpcMessage) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Object message = rpcMessage.getBody();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RpcContext rpcContext = ChannelManager.getContextFromIdentified(ctx.channel());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 批量请求消息，遍历内部请求消息借助 CompletableFuture 异步处理，所有请求处理完成后，最后一起返回&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (message instanceof MergedWarpMessage) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final AbstractMessage msg = (AbstractMessage) message;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 记录日志 ...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// 默认是调用 DefaultCoordinator#onRequest&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp;处理事务消息请求&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AbstractResultMessage result = &lt;b&gt;transactionMessageHandler&lt;/b&gt;.&lt;b&gt;onRequest&lt;/b&gt;(msg, rpcContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; remotingServer.&lt;b&gt;sendAsyncResponse&lt;/b&gt;(rpcMessage, ctx.channel(), result);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 记录日志 ...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1640" width="680" height="240" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.002;exitY=0.199;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-74" target="Yp0WvUKOWmrbdsE2uwG8-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-74" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ServerOnRequestProcessor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RemotingServer &lt;b&gt;remotingServer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//默认是DefaultCoordinator&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final TransactionMessageHandler &lt;b&gt;transactionMessageHandler&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService &lt;b&gt;batchResponseExecutorService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Channel, BlockingQueue&amp;lt;QueueItem&amp;gt;&amp;gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; basketMap&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Object batchResponseLock = new Object();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean isResponding = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MAX_BATCH_RESPONSE_MILLS = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int MAX_BATCH_RESPONSE_THREAD = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final long KEEP_ALIVE_TIME = Integer.MAX_VALUE;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final String BATCH_RESPONSE_THREAD_PREFIX = &lt;br&gt;&amp;nbsp; &amp;nbsp; &quot;rpcBatchResponse&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final boolean PARALLEL_REQUEST_HANDLE =&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; ConfigurationFactory.getInstance().getBoolean(&lt;br&gt;&amp;nbsp; &amp;nbsp; ConfigurationKeys.ENABLE_PARALLEL_REQUEST_HANDLE_KEY, true);&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="2000" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-78" target="Yp0WvUKOWmrbdsE2uwG8-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-78" value="&lt;span style=&quot;background-color: initial;&quot;&gt;public GlobalBeginResponse &lt;b&gt;handle&lt;/b&gt;(GlobalBeginRequest request, final RpcContext rpcContext) {&lt;/span&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; GlobalBeginResponse response = new GlobalBeginResponse();&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 执行处理逻辑，已经对结果进行处理最后向客户端发送响应&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;exceptionHandleTemplate&lt;/b&gt;(new AbstractCallback&amp;lt;GlobalBeginRequest, GlobalBeginResponse&amp;gt;() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void &lt;b&gt;execute&lt;/b&gt;(GlobalBeginRequest request, GlobalBeginResponse response) throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;doGlobalBegin&lt;/b&gt;(request, response, rpcContext);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (StoreException e) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new TransactionException(...);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }, request, response);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2440" y="1640" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-81" value="AbstractTCInboundHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2575" y="1610" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-82" target="Yp0WvUKOWmrbdsE2uwG8-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-82" value="&lt;div&gt;protected void &lt;b&gt;doGlobalBegin&lt;/b&gt;(GlobalBeginRequest request, GlobalBeginResponse response, RpcContext rpcContext)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; response.&lt;b&gt;setXid&lt;/b&gt;(&lt;b&gt;core&lt;/b&gt;.&lt;b&gt;begin&lt;/b&gt;(rpcContext.getApplicationId(), &lt;br&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; rpcContext.getTransactionServiceGroup(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request.getTransactionName(), request.getTimeout()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="2920" y="1700" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-84" value="DefaultCoordinator" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3080" y="1670" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-85" target="QYUXZyDFh2rJFv0anni3-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-85" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public String &lt;b&gt;begin&lt;/b&gt;(String applicationId, String transactionServiceGroup, String name, int timeout)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 创建 GlobalSession&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; GlobalSession session = GlobalSession.&lt;b&gt;createGlobalSession&lt;/b&gt;(applicationId, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;transactionServiceGroup, name, timeout);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; MDC.put(RootContext.MDC_KEY_XID, session.getXid());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 修改全局会话状态为 Begin、记录开始事件、活跃状态、全局会话存储&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;session&lt;/b&gt;.&lt;b&gt;begin&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // transaction start event&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; MetricsPublisher.&lt;b&gt;postSessionDoingEvent&lt;/b&gt;(session, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return session.&lt;b&gt;getXid&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3400" y="1680" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Yp0WvUKOWmrbdsE2uwG8-87" value="DefaultCore" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3575" y="1650" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;GlobalSession&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;全局会话，主要就是记录事务全局的状态&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static final int MAX_GLOBAL_SESSION_SIZE = &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; StoreConfig.getMaxGlobalSessionSize();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static ThreadLocal&amp;lt;ByteBuffer&amp;gt; byteBufferThreadLocal = &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ThreadLocal.withInitial(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; () -&amp;gt; ByteBuffer.allocate(MAX_GLOBAL_SESSION_SIZE));&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static final ThreadLocal&amp;lt;GlobalStatus&amp;gt;&amp;nbsp; &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; EXPECTED_STATUS_THREAD_LOCAL = new ThreadLocal&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static final int RETRY_DEAD_THRESHOLD = ConfigurationFactory&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .getInstance()&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;.getInt(ConfigurationKeys.RETRY_DEAD_THRESHOLD, &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;DefaultValues.DEFAULT_RETRY_DEAD_THRESHOLD);&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 带上事务发起者（TM）IP端口的事务ID, 比如&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;// 172.17.0.1:8091:7260406644107100161&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;xid&lt;/b&gt;;&lt;/p&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;// 事务ID， 比如 7260406644107100161&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long &lt;b style=&quot;font-size: 10px;&quot;&gt;transactionId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务状态&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private volatile GlobalStatus &lt;b style=&quot;font-size: 10px;&quot;&gt;status&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务发起者服务ID, 如 order-service&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;applicationId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务服务分组，不同分组可以使用不同的Seata Server节点和连接&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;transactionServiceGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务名，默认用方法和参数命名，比如 createOrder(java.lang.Long, java.lang.Long, java.lang.Integer)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;transactionName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务超时时间，超时的话TC会发起回滚&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private int &lt;b style=&quot;font-size: 10px;&quot;&gt;timeout&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务开始时间，即创建 Session 的时间点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private long &lt;b style=&quot;font-size: 10px;&quot;&gt;beginTime&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private String applicationData;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private final boolean lazyLoadBranch;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务是否活跃&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private volatile boolean &lt;b style=&quot;font-size: 10px;&quot;&gt;active&lt;/b&gt; = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 分支事务列表，即参与者的本地事务&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private List&amp;lt;&lt;b style=&quot;font-size: 10px;&quot;&gt;BranchSession&lt;/b&gt;&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;branchSessions&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private GlobalSessionLock globalSessionLock = new GlobalSessionLock();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private Set&amp;lt;SessionLifecycleListener&amp;gt; lifecycleListeners = new HashSet&amp;lt;&amp;gt;(2);&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="-880" y="2000" width="400" height="520" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-2" target="9im45_5cZYxTOmNjTaqy-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-2" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;public void begin() throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;status&lt;/b&gt; = &lt;b&gt;GlobalStatus.Begin&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;beginTime&lt;/b&gt; = System.currentTimeMillis();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;active&lt;/b&gt; = true;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // onBegin() 方法就是将 GlobalSession 实例存储到 SessionManager 对象&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;SessionHolder&lt;/b&gt;.&lt;b&gt;getRootSessionManager&lt;/b&gt;().&lt;b&gt;onBegin&lt;/b&gt;(this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (SessionLifecycleListener lifecycleListener : lifecycleListeners) { &lt;font color=&quot;#007fff&quot;&gt;// 预留的拓展点&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lifecycleListener.onBegin(this);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3880" y="1700" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-4" value="GlobalSession" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4050" y="1670" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SessionManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Session 容器，有多种实现 File、DB、Redis、Raft(基于jraft-core实现的分布式一致性文件系统)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void addGlobalSession(GlobalSession session) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GlobalSession findGlobalSession(String xid) ;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;GlobalSession findGlobalSession(String xid, boolean withBranchSessions);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void updateGlobalSessionStatus(GlobalSession session, GlobalStatus status) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void removeGlobalSession(GlobalSession session) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void addBranchSession(GlobalSession globalSession, BranchSession session) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void updateBranchSessionStatus(BranchSession session, BranchStatus status) throws TransactionException;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void removeBranchSession(GlobalSession globalSession, BranchSession session) throws TransactionException;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="2000" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-6" target="QYUXZyDFh2rJFv0anni3-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SessionHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;GlobalSession 存储器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected static final Configuration CONFIG = &lt;br&gt;&amp;nbsp; &amp;nbsp; ConfigurationFactory.getInstance();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final String ROOT_SESSION_MANAGER_NAME = &quot;root.data&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static long DISTRIBUTED_LOCK_EXPIRE_TIME = CONFIG.getLong(&lt;br&gt;&amp;nbsp; &amp;nbsp; ConfigurationKeys.DISTRIBUTED_LOCK_EXPIRE_TIME, &lt;br&gt;&amp;nbsp; &amp;nbsp; DEFAULT_DISTRIBUTED_LOCK_EXPIRE_TIME);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static &lt;b&gt;SessionManager&lt;/b&gt; &lt;b&gt;ROOT_SESSION_MANAGER&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile &lt;b&gt;Map&lt;/b&gt;&amp;lt;&lt;b&gt;String&lt;/b&gt;, &lt;b&gt;SessionManager&lt;/b&gt;&amp;gt; &lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; SESSION_MANAGER_MAP&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static DistributedLocker DISTRIBUTED_LOCKER;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="2000" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Yp0WvUKOWmrbdsE2uwG8-72" target="QYUXZyDFh2rJFv0anni3-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1680" y="1760" as="sourcePoint" />
            <mxPoint x="2200" y="1760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-18" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-7" value="&lt;div&gt;public AbstractResultMessage &lt;b&gt;onRequest&lt;/b&gt;(AbstractMessage request, RpcContext context) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AbstractTransactionRequestToTC transactionRequest = &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;(AbstractTransactionRequestToTC) request;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; transactionRequest.setTCInboundHandler(this);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 这里会调用对应的事务请求的请求处理方法&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return transactionRequest.&lt;b&gt;handle&lt;/b&gt;(context);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1680" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-10" value="&lt;b&gt;DefaultCoordinator&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1875" y="1650" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-7" target="QYUXZyDFh2rJFv0anni3-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2160" y="1720" as="sourcePoint" />
            <mxPoint x="2440" y="1760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-12" value="&lt;b&gt;GlobalBeginRequest&lt;/b&gt;#handle()&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;1 分布式事务开启&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-14" target="QYUXZyDFh2rJFv0anni3-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-14" value="&lt;b&gt;GlobalCommitRequest&lt;/b&gt;#handle()&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;5 所有分支事务执行完成，全局事务提交，其实是向各个参与者发送&lt;/b&gt;&lt;br&gt;&lt;b&gt;BranchCommitResponse&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-15" value="&lt;b&gt;消息第一级分发，&lt;br&gt;借助 ProtocolConstants 中定义的消息类型&lt;/b&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="680" y="1560" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-17" target="QYUXZyDFh2rJFv0anni3-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-17" value="&lt;b&gt;GlobalRollbackRequest&lt;/b&gt;#handle()&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;存在分支事务执行异常或超时，全局事务回滚，其实是向各个参与者发送&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;BranchRollbackResponse&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-19" target="QYUXZyDFh2rJFv0anni3-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-4" value="...." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="QYUXZyDFh2rJFv0anni3-28" vertex="1" connectable="0">
          <mxGeometry x="-0.2" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-19" value="&lt;b&gt;BranchRegisterRequest&lt;/b&gt;#handle()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;2 分支事务注册，分支事务执行正常的话在提交前注册分支事务&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2010" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-21" target="QYUXZyDFh2rJFv0anni3-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-22" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;处理流程和上面类似，省略一些步骤&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="QYUXZyDFh2rJFv0anni3-33" vertex="1" connectable="0">
          <mxGeometry x="-0.922" y="-1" relative="1" as="geometry">
            <mxPoint x="91" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-21" value="&lt;b&gt;BranchReportRequest&lt;/b&gt;&lt;br&gt;#handle()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;3 分支事务状态上报注册，在分支事务提交后上报分支事务状态&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-23" value="&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;... 4 其他分支事务注册和状态上报...&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-25" target="9im45_5cZYxTOmNjTaqy-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-25" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public GlobalCommitResponse handle(GlobalCommitRequest request, final RpcContext rpcContext) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; GlobalCommitResponse response = new GlobalCommitResponse();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; response.setGlobalStatus(GlobalStatus.Committing);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;exceptionHandleTemplate&lt;/b&gt;(new AbstractCallback&amp;lt;GlobalCommitRequest, &lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;GlobalCommitResponse&amp;gt;() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void &lt;b style=&quot;font-size: 10px;&quot;&gt;execute&lt;/b&gt;(GlobalCommitRequest request, GlobalCommitResponse &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; response)&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;throws TransactionException {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 全局事务提交&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;doGlobalCommit&lt;/b&gt;(request, response, rpcContext);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (StoreException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new TransactionException(&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; TransactionExceptionCode.FailedStore,&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;..., e.getMessage()),&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;e);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void &lt;b style=&quot;font-size: 10px;&quot;&gt;onTransactionException&lt;/b&gt;(GlobalCommitRequest request, GlobalCommitResponse response,&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;TransactionException tex) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.onTransactionException(request, response, tex);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 后面步骤可能会抛出异常，这里将异常转成全局事务会话的状态并更新到全局事务会话&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;checkTransactionStatus&lt;/b&gt;(request, response);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void &lt;b style=&quot;font-size: 10px;&quot;&gt;onException&lt;/b&gt;(GlobalCommitRequest request, GlobalCommitResponse response, Exception rex) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.onException(request, response, rex);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; checkTransactionStatus(request, response);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }, request, response);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2440" y="2440" width="440" height="420" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-27" target="9im45_5cZYxTOmNjTaqy-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-27" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public BranchRegisterResponse handle(BranchRegisterRequest request, final RpcContext rpcContext) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BranchRegisterResponse response = new BranchRegisterResponse();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;exceptionHandleTemplate&lt;/b&gt;(new AbstractCallback&amp;lt;BranchRegisterRequest, BranchRegisterResponse&amp;gt;() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void execute(BranchRegisterRequest request, BranchRegisterResponse response)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;doBranchRegister&lt;/b&gt;(request, response, rpcContext);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (StoreException e) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new TransactionException(TransactionExceptionCode.FailedStore, String&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .format(&quot;branch register request failed. xid=%s, msg=%s&quot;, request.getXid(), e.getMessage()), e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }, request, response);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return response;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2440" y="1920" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-29" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;右边这些请求按分布式事务实际处理顺序排列&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1910" y="1880" width="260" height="30" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-30" target="9im45_5cZYxTOmNjTaqy-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-39" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="9im45_5cZYxTOmNjTaqy-38" vertex="1" connectable="0">
          <mxGeometry x="-0.1842" y="-2" relative="1" as="geometry">
            <mxPoint x="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-30" value="&lt;b&gt;和全局事务提交处理流程类似,&lt;br&gt;流程不详细列举了&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2440" y="2900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="QYUXZyDFh2rJFv0anni3-32" target="9im45_5cZYxTOmNjTaqy-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QYUXZyDFh2rJFv0anni3-32" value="&lt;b&gt;getCore&lt;/b&gt;(branchType).&lt;b&gt;branchReport&lt;/b&gt;(branchType, xid, branchId, status, applicationData);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3400" y="2280" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-3" value="AbstractTCInboundHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2570" y="1890" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-5" target="9im45_5cZYxTOmNjTaqy-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-10" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="9im45_5cZYxTOmNjTaqy-8" vertex="1" connectable="0">
          <mxGeometry x="-0.1" y="3" relative="1" as="geometry">
            <mxPoint y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-5" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;protected void doBranchRegister(BranchRegisterRequest request, BranchRegisterResponse &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;RpcContext rpcContext) throws TransactionException {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; MDC.put(RootContext.MDC_KEY_XID, request.getXid());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; response.&lt;b&gt;setBranchId&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;core&lt;/b&gt;.&lt;b&gt;branchRegister&lt;/b&gt;(request.getBranchType(), &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;request.getResourceId(), rpcContext.getClientId(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; request.getXid(), request.getApplicationData(), request.getLockKey()));&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=7;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2920" y="1980" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-7" target="9im45_5cZYxTOmNjTaqy-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-7" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;getCore&lt;/b&gt;(branchType).&lt;b&gt;branchRegister&lt;/b&gt;(branchType, resourceId, clientId, xid,&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; applicationData, lockKeys);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=7;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3400" y="2010" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-9" value="DefaultCore" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3575" y="1980" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-12" target="9im45_5cZYxTOmNjTaqy-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-12" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public Long branchRegister(BranchType branchType, String resourceId, String clientId, String xid,&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;String applicationData, String lockKeys) throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; GlobalSession globalSession = assertGlobalSessionNotNull(xid, false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return SessionHolder.&lt;b&gt;lockAndExecute&lt;/b&gt;(globalSession, () -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSessionStatusCheck(globalSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BranchSession &lt;b&gt;branchSession&lt;/b&gt; = &lt;b&gt;SessionHelper&lt;/b&gt;.&lt;b&gt;newBranchByGlobal&lt;/b&gt;(globalSession, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; branchType, resourceId,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;applicationData, lockKeys, clientId);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MDC.put(RootContext.MDC_KEY_BRANCH_ID, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; String.valueOf(branchSession.getBranchId()));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; branchSessionLock(globalSession, branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;globalSession&lt;/b&gt;.&lt;b&gt;addBranch&lt;/b&gt;(branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (RuntimeException ex) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; branchSessionUnlock(branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new BranchTransactionException(FailedToAddBranch, String&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .format(&quot;Failed to store branch xid = %s branchId = %s&quot;, globalSession.getXid(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; branchSession.getBranchId()), ex);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 日志&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return branchSession.getBranchId();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3880" y="1900" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-62" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="9im45_5cZYxTOmNjTaqy-14" target="9im45_5cZYxTOmNjTaqy-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-14" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void &lt;b&gt;addBranch&lt;/b&gt;(BranchSession branchSession) throws TransactionException {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // onAddBranch() 方法就是将 BranchSession 实例存储到 SessionManager GlobalSession对象&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;SessionHolder&lt;/b&gt;.&lt;b&gt;getRootSessionManager&lt;/b&gt;().&lt;b&gt;onAddBranch&lt;/b&gt;(this, branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lifecycleListener.onAddBranch(this, branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!RaftServerFactory.getInstance().isRaftMode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; add(branchSession);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4360" y="1970" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-16" value="GlobalSession" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4530" y="2220" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="9im45_5cZYxTOmNjTaqy-17" target="9im45_5cZYxTOmNjTaqy-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-17" value="&lt;div&gt;public void &lt;b&gt;branchReport&lt;/b&gt;(BranchType branchType, String xid, long branchId, BranchStatus status,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;String applicationData) throws TransactionException {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; GlobalSession globalSession = assertGlobalSessionNotNull(xid, true);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; BranchSession branchSession = globalSession.&lt;b&gt;getBranch&lt;/b&gt;(branchId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (branchSession == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new BranchTransactionException(BranchTransactionNotExist,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String.format(&quot;Could not found branch session xid = %s branchId = %s&quot;, xid, branchId));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; branchSession.&lt;b&gt;setApplicationData&lt;/b&gt;(applicationData);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; globalSession.&lt;b&gt;changeBranchStatus&lt;/b&gt;(branchSession, status);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ....&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3880" y="2230" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-64" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="9im45_5cZYxTOmNjTaqy-19" target="9im45_5cZYxTOmNjTaqy-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-19" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void changeBranchStatus(BranchSession branchSession, BranchStatus status) throws TransactionException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;SessionHolder.getRootSessionManager&lt;/b&gt;().&lt;b&gt;onBranchStatusChange&lt;/b&gt;(this, branchSession, status);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lifecycleListener.onBranchStatusChange(this, branchSession, status);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4360" y="2250" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-20" value="GlobalSession" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4530" y="1940" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-23" value="&lt;b&gt;GlobalReportRequest&lt;/b&gt;#handle()&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="3000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-24" value="&lt;b&gt;GlobalStatusRequest&lt;/b&gt;#handle()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-25" target="9im45_5cZYxTOmNjTaqy-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-25" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;protected void doGlobalCommit(GlobalCommitRequest request, GlobalCommitResponse response, RpcContext rpcContext)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; MDC.put(RootContext.MDC_KEY_XID, request.getXid());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; response.&lt;b style=&quot;font-size: 10px;&quot;&gt;setGlobalStatus&lt;/b&gt;(core.&lt;b style=&quot;font-size: 10px;&quot;&gt;commit&lt;/b&gt;(request.getXid()));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=7;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2920" y="2600" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-27" target="9im45_5cZYxTOmNjTaqy-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-27" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public GlobalStatus commit(String xid) throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; GlobalSession globalSession = SessionHolder.findGlobalSession(xid);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ... 全局会话是否为空、是否超时检查 ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // just lock changeStatus&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean &lt;b style=&quot;font-size: 10px;&quot;&gt;shouldCommit&lt;/b&gt; = SessionHolder.&lt;b style=&quot;font-size: 10px;&quot;&gt;lockAndExecute&lt;/b&gt;(globalSession, &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; () -&amp;gt;&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean shouldCommitNow = false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (globalSession.getStatus() == GlobalStatus.Begin) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Highlight: Firstly, close the session, then no more branch can be registered.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.close();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (globalSession.&lt;b&gt;canBeCommittedAsync&lt;/b&gt;()) { &lt;font color=&quot;#007fff&quot;&gt;//可以异步提交&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.asyncCommit();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetricsPublisher.postSessionDoneEvent(globalSession, GlobalStatus.Committed, false, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//不可以异步提交&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.&lt;b&gt;changeGlobalStatus&lt;/b&gt;(GlobalStatus.Committing);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; shouldCommitNow = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //clean session after changing status successfully.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.clean();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return shouldCommitNow;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (shouldCommit) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; boolean success = &lt;b style=&quot;font-size: 10px;&quot;&gt;doGlobalCommit&lt;/b&gt;(globalSession, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //If successful and all remaining branches can be committed asynchronously, do async commit.&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (success &amp;amp;&amp;amp; globalSession.hasBranch() &amp;amp;&amp;amp; globalSession.canBeCommittedAsync()) {&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.&lt;b style=&quot;font-size: 10px;&quot;&gt;asyncCommit&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return GlobalStatus.Committed;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return globalSession.getStatus();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return globalSession.getStatus() == GlobalStatus.AsyncCommitting ? GlobalStatus.Committed : globalSession.getStatus();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3400" y="2440" width="440" height="500" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-29" target="9im45_5cZYxTOmNjTaqy-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-29" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public boolean doGlobalCommit(GlobalSession globalSession, boolean retrying) throws TransactionException {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean success = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; MetricsPublisher.postSessionDoingEvent(globalSession, retrying);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (globalSession.isSaga()) {&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//Saga事务全局提交&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; success = getCore(BranchType.SAGA).doGlobalCommit(globalSession, retrying);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 非Saga模式的事务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;BranchSession&amp;gt; branchSessions = globalSession.getSortedBranches();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Boolean result = &lt;b style=&quot;font-size: 10px;&quot;&gt;SessionHelper&lt;/b&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;forEach&lt;/b&gt;(branchSessions, branchSession -&amp;gt; { &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 遍历所有分支事务会话&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // if not retrying, skip the canBeCommittedAsync branches&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!retrying &amp;amp;&amp;amp; branchSession.canBeCommittedAsync()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CONTINUE;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BranchStatus currentStatus = branchSession.getStatus();&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (currentStatus == BranchStatus.PhaseOne_Failed) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SessionHelper.removeBranch(globalSession, branchSession, !retrying);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CONTINUE;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //提交分支事务（第二阶段）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; BranchStatus branchStatus = &lt;b style=&quot;font-size: 10px;&quot;&gt;getCore&lt;/b&gt;(branchSession.getBranchType()).&lt;b style=&quot;font-size: 10px;&quot;&gt;branchCommit&lt;/b&gt;(globalSession, &lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre; font-size: 10px;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; branchSession);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (isXaerNotaTimeout(globalSession,branchStatus)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; branchStatus = BranchStatus.&lt;b&gt;PhaseTwo_Committed&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch (branchStatus) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b style=&quot;font-size: 10px;&quot;&gt;PhaseTwo_Committed&lt;/b&gt;:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 删除分支会话&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SessionHelper.&lt;b&gt;removeBranch&lt;/b&gt;(globalSession, branchSession, !retrying);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CONTINUE;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;b style=&quot;font-size: 10px;&quot;&gt;PhaseTwo_CommitFailed_Unretryable&lt;/b&gt;: &lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//多次重试后仍然提交失败&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SessionHelper.&lt;b&gt;endCommitFailed&lt;/b&gt;(globalSession, retrying); &lt;font color=&quot;#007fff&quot;&gt;//设置全局事务失败&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!retrying) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.queueToRetryCommit();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (globalSession.canBeCommittedAsync()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CONTINUE;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Exception ex) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String commitInfo = retrying ? &quot;Global commit continue&quot; : &quot;Global commit failed&quot;;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; StackTraceLogger.error(LOGGER, ex, &quot;Committing branch transaction exception:retrying={}, {}, {}&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new String[] {String.valueOf(retrying), branchSession.toString(), commitInfo});&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!retrying) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; globalSession.&lt;b&gt;queueToRetryCommit&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new TransactionException(ex);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CONTINUE;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }, PARALLEL_HANDLE_BRANCH &amp;amp;&amp;amp; branchSessions.size() &amp;gt;= 2);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // Return if the result is not null&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (result != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return result;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //If has branch and not all remaining branches can be committed asynchronously,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //do print log and return false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (globalSession.hasBranch() &amp;amp;&amp;amp; !globalSession.canBeCommittedAsync()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.info(&quot;Committing global transaction is NOT done, xid = {}.&quot;, globalSession.getXid());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp; // if it succeeds and there is no branch, retrying=true is the asynchronous state when retrying. EndCommitted is&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // executed to improve concurrency performance, and the global transaction ends..&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (success &amp;amp;&amp;amp; globalSession.getBranchSessions().isEmpty()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SessionHelper.&lt;b&gt;endCommitted&lt;/b&gt;(globalSession, retrying); &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 事务成功结束，内部会删除全局会话 GlobalSession&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.info(&quot;Committing global transaction is successfully done, xid = {}.&quot;, globalSession.getXid());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return success;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=2;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3880" y="2440" width="680" height="920" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-31" target="9im45_5cZYxTOmNjTaqy-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-31" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// 向各个事务参与者（Netty Client）发送分支提交请求 BranchCommitRequest&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;BranchCommitResponse response = (BranchCommitResponse) &lt;b style=&quot;font-size: 10px;&quot;&gt;remotingServer&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; .&lt;b style=&quot;font-size: 10px;&quot;&gt;sendSyncRequest&lt;/b&gt;(&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;branchSession.getResourceId(),&amp;nbsp; &amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; branchSession.getClientId(),request, branchSession.isAT());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;return response.getBranchStatus();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=7;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="4600" y="2440" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-33" target="9im45_5cZYxTOmNjTaqy-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-33" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;// 向各个事务参与者（Netty Client）发送分支提交响应 Request&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;public Object sendSyncRequest(String resourceId, String clientId, Object msg, boolean tryOtherApp)&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;throws TimeoutException {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; // 获取事务参与者客户端连接&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Channel channel = &lt;b style=&quot;font-size: 10px;&quot;&gt;ChannelManager&lt;/b&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;getChannel&lt;/b&gt;(resourceId, clientId, tryOtherApp);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (channel == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RuntimeException(...);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; RpcMessage rpcMessage = &lt;b&gt;buildRequestMessage&lt;/b&gt;(msg, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ProtocolConstants.&lt;b&gt;MSGTYPE_RESQUEST_SYNC&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return super.&lt;b style=&quot;font-size: 10px;&quot;&gt;sendSync&lt;/b&gt;(channel, rpcMessage, NettyServerConfig.getRpcRequestTimeout());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="5080" y="2440" width="440" height="180" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-35" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;doBeforeRpcHooks&lt;/b&gt;(remoteAddr, rpcMessage);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;channel.&lt;b&gt;writeAndFlush&lt;/b&gt;(rpcMessage).addListener((ChannelFutureListener) future -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!future.isSuccess()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MessageFuture messageFuture1 = futures.remove(rpcMessage.getId());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (messageFuture1 != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; messageFuture1.setResultMessage(future.cause());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; destroyChannel(future.channel());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Object result = messageFuture.&lt;b&gt;get&lt;/b&gt;(timeoutMillis, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;doAfterRpcHooks&lt;/b&gt;(remoteAddr, rpcMessage, result);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return result;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} catch (Exception exx) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (exx instanceof TimeoutException) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw (TimeoutException) exx;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RuntimeException(exx);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=3;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="5560" y="2440" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-37" value="&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 向各个事务参与者（Netty Client）发送分支回滚请求 BranchRollbackRequest&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;BranchRollbackResponse&lt;/b&gt; response = (BranchRollbackResponse) &lt;b&gt;remotingServer&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;sendSyncRequest&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;branchSession.getResourceId(), branchSession.getClientId(), request, &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;branchSession.isAT());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;return response.getBranchStatus();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2680" y="2900" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-40" value="BatchLogHandler&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;异步打印日志，内部启动了线程池，线程任务阻塞读取日志队列中的日志并打印&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="2240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-42" target="QYUXZyDFh2rJFv0anni3-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-42" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractSessionManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected TransactionStoreManager transactionStoreManager;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected String name;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="2280" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="9im45_5cZYxTOmNjTaqy-43" target="9im45_5cZYxTOmNjTaqy-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-43" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;FileSessionManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;使用文件存储Session, 业务中不会使用这种实现因为无法支持HA&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int &lt;b&gt;READ_SIZE&lt;/b&gt; = ConfigurationFactory.getInstance().getInt(&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&amp;nbsp; &amp;nbsp; ConfigurationKeys.SERVICE_SESSION_RELOAD_READ_SIZE,&amp;nbsp; &amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; DEFAULT_SERVICE_SESSION_RELOAD_READ_SIZE);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Session Map, 持久化时将此Map内容存储到 sessionStore/&amp;lt;port&amp;gt;/root.data&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;String, GlobalSession&amp;gt; &lt;b&gt;sessionMap&lt;/b&gt; = &lt;br&gt;&amp;nbsp; &amp;nbsp; new ConcurrentHashMap&amp;lt;&amp;gt;(64);&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="2440" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" source="9im45_5cZYxTOmNjTaqy-47" target="9im45_5cZYxTOmNjTaqy-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-47" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DataBaseSessionManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;使用数据库存储Session&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2200" y="2440" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-49" value="" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-51" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;从客户端实现看处理 GlobalCommitRequest&lt;br style=&quot;font-size: 10px;&quot;&gt;只是删除撤销日志&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2200" y="2545" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-52" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;StoreDBProperties&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;全局会话存储配置属性：seata.store.db&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;常用 DB 模式，如果要求高性能可以使用 Redis 模式&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String datasource = &quot;druid&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String dbType = &quot;mysql&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;driverClassName&lt;/b&gt; = &quot;com.mysql.jdbc.Driver&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;url&lt;/b&gt; = &quot;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;user&lt;/b&gt; = &quot;mysql&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;password&lt;/b&gt; = &quot;mysql&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer minConn = DEFAULT_DB_MIN_CONN;&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 默认最小连接数10&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer maxConn = DEFAULT_DB_MAX_CONN; &lt;font color=&quot;#007fff&quot;&gt;// 默认最大连接数 100&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;globalTable&lt;/b&gt; = &quot;global_table&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;branchTable&lt;/b&gt; = &quot;branch_table&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String lockTable = &quot;lock_table&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String distributedLockTable = &quot;distributed_lock&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer queryLimit = DEFAULT_QUERY_LIMIT;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Long maxWait = 5000L;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="120" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-53" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;private void onRegRmMessage(ChannelHandlerContext ctx, RpcMessage rpcMessage) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; RegisterRMRequest message = (RegisterRMRequest) rpcMessage.getBody();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String ipAndPort = NetUtil.toStringAddress(ctx.channel().remoteAddress());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean isSuccess = false;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String errorInfo = StringUtils.EMPTY;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (null == checkAuthHandler || &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;checkAuthHandler.regResourceManagerCheckAuth(message)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 注册RM, 其实主要就是存储一下连接&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;ChannelManager&lt;/b&gt;.&lt;b&gt;registerRMChannel&lt;/b&gt;(&lt;b&gt;message&lt;/b&gt;, &lt;b&gt;ctx.channel()&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Version.putChannelVersion(ctx.channel(), message.getVersion());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; isSuccess = true;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... 日志&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Exception exx) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; RegisterRMResponse response = new RegisterRMResponse(isSuccess);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (StringUtils.isNotEmpty(errorInfo)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.setMsg(errorInfo);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; remotingServer.sendAsyncResponse(rpcMessage, ctx.channel(), response);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2020" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-55" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ChannelManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;管理Seata客户端的连接&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// Channel -&amp;gt; RpcContext&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ConcurrentMap&amp;lt;Channel, RpcContext&amp;gt; &lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;IDENTIFIED_CHANNELS&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// RM连接:&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ConcurrentMap&amp;lt;String, ConcurrentMap&amp;lt;String, &lt;br&gt;&amp;nbsp; &amp;nbsp; ConcurrentMap&amp;lt;String,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;ConcurrentMap&amp;lt;Integer, RpcContext&amp;gt;&amp;gt;&amp;gt;&amp;gt; &lt;br&gt;&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; RM_CHANNELS&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// TM连接:&amp;nbsp;&amp;nbsp;服务名IP -&amp;gt; 端口 -&amp;gt; RpcContext&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final ConcurrentMap&amp;lt;String, ConcurrentMap&amp;lt;Integer,&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; RpcContext&amp;gt;&amp;gt; &lt;b&gt;TM_CHANNELS&lt;/b&gt;&amp;nbsp;= new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-440" y="2560" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-56" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;当注册订单服务后，ChannelManager中的连接数据：&lt;br&gt;&lt;br&gt;IDENTIFIED_CHANNELS:&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;result = {ConcurrentHashMap@12365}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;{NioSocketChannel@12369} &quot;[id: 0xd7296da5, L:/127.0.0.1:8091 - R:/127.0.0.1:35644]&quot; -&amp;gt; {RpcContext@12370}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; key = {&lt;b&gt;NioSocketChannel&lt;/b&gt;@12369} &quot;[id: 0xd7296da5, L:/127.0.0.1:8091 - R:/127.0.0.1:35644]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; value = {&lt;b&gt;RpcContext&lt;/b&gt;@12370}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;clientRole&lt;/b&gt; = {NettyPoolKey$TransactionRole@12375} &quot;TMROLE&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;version = &quot;2.0.0&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;applicationId&lt;/b&gt; = &quot;order-service&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;transactionServiceGroup&lt;/b&gt; = &quot;order-service-group&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;clientId&lt;/b&gt; = &quot;order-service:127.0.0.1:35644&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;channel&lt;/b&gt; = {NioSocketChannel@12369} &quot;[id: 0xd7296da5, L:/127.0.0.1:8091 - R:/127.0.0.1:35644]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;resourceSets = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;clientIDHolderMap = {ConcurrentHashMap@12365}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;clientTMHolderMap&lt;/b&gt; = {ConcurrentHashMap@12380}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; {Integer@12386} 35644 -&amp;gt; {RpcContext@12370}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;clientRMHolderMap = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RM_CHANNELS:&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;result = {ConcurrentHashMap@12432}&amp;nbsp; size = 3&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp;&quot;jdbc:mysql://127.0.0.1:13306/seata_order&quot; -&amp;gt; {ConcurrentHashMap@12441}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; key = &quot;jdbc:mysql://127.0.0.1:13306/seata_order&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; value = {ConcurrentHashMap@12441}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;&quot;order-service&quot; -&amp;gt; {ConcurrentHashMap@12450}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; key = &quot;order-service&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; value = {ConcurrentHashMap@12450}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&quot;127.0.0.1&quot; -&amp;gt; {ConcurrentHashMap@12455}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; key = &quot;127.0.0.1&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; value = {ConcurrentHashMap@12455}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;{Integer@12459} 43908 -&amp;gt; {RpcContext@12460}&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;TM_CHANNELS:&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;result = {ConcurrentHashMap@12395}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp;&quot;order-service:127.0.0.1&quot; -&amp;gt; {ConcurrentHashMap@12380}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; key = &quot;order-service:127.0.0.1&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; value = {ConcurrentHashMap@12380}&amp;nbsp; size = 1&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp;{Integer@12386} 35644 -&amp;gt; {RpcContext@12370}&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; key = {Integer@12386} 35644&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; value = {RpcContext@12370}&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-30" y="2560" width="630" height="590" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-57" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RpcContext&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RPC连接上下文信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Channel -&amp;gt; RpcContext&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="2560" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-59" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;全局会话的持久化存储有多种实现，这里展示 DataBaseSessionManager 使用 MySQL 存储的SQL:&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;b&gt;insert into&amp;nbsp;#global_table#&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;( &amp;lt;全局会话数据表的字段&amp;gt; )&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;values (?, ?, ?, ?, ?, ?, ?, ?, ?, now(), now())&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=15;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="4360" y="1730" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-61" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;分支事务会话的持久化存储有多种实现，这里展示 DataBaseSessionManager 使用 MySQL 存储的SQL:&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;insert into&amp;nbsp;#branch_table#&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;font-size: 10px; font-weight: bold; background-color: initial;&quot;&gt;( &amp;lt;分支会话数据表的字段&amp;gt; )&lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;values (&lt;/b&gt;&lt;b style=&quot;background-color: initial; border-color: var(--border-color);&quot;&gt;?, ?, ?, ?, ?, ?, ?, ?, ?&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;, now(), now())&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=15;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="4840" y="2010" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9im45_5cZYxTOmNjTaqy-63" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;分支事务会话的持久化存储有多种实现，这里展示 DataBaseSessionManager 使用 MySQL 存储的SQL:&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;update&amp;nbsp; #branch_table#&amp;nbsp; &amp;nbsp; set status = ?,&amp;nbsp; application_data = ?,&amp;nbsp; gmt_modified = now(6) where xid = ?&amp;nbsp; &amp;nbsp;and branch_id = ?&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=15;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="4840" y="2280" width="440" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
