<mxfile host="Electron" modified="2025-01-14T09:06:06.673Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="UomV0mzu3B6R-7i6lZqz" version="21.6.5" type="device">
  <diagram name="第 1 页" id="OzL5vhix6b4W479FO7lD">
    <mxGraphModel dx="4503" dy="733" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="AZ33C6kLGZou72CWeF7D-1" value="&lt;h1 style=&quot;font-size: 16px;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Sa-Token OAuth2 工作原理 (v2.0.0)&lt;/font&gt;&lt;/h1&gt;&lt;div&gt;源码参考 sa-token-demo-oauth2；先使用 SwitchHost 添加两条host信息；&lt;br&gt;此Demo包含两个模块 sa-token-demo-oauth2-client 代表第三方应用、 sa-token-demo-oauth2-server 代表认证服务器和资源服务器。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="620" height="90" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-2" target="AZ33C6kLGZou72CWeF7D-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-2" value="sa-token-demo-oauth2-client&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;第三方应用&lt;br style=&quot;font-size: 11px;&quot;&gt;端口：8002&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-3" target="AZ33C6kLGZou72CWeF7D-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="140" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-3" target="AZ33C6kLGZou72CWeF7D-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-81" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-3" target="AZ33C6kLGZou72CWeF7D-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-3" target="AZ33C6kLGZou72CWeF7D-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-3" value="HTTP 页面" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-5" target="AZ33C6kLGZou72CWeF7D-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-5" value="sa-token-demo-oauth2-server&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;认证服务器、资源服务器&lt;br style=&quot;font-size: 11px;&quot;&gt;端口：8000&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1200" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-6" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-6" value="HTTP 接口" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1200" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-7" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-12" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;http://sa-oauth-server.com:&lt;b style=&quot;font-size: 10px;&quot;&gt;8000&lt;/b&gt;/&lt;b style=&quot;font-size: 10px;&quot;&gt;oauth2/authorize&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;?response_type=code&amp;amp;client_id=1001&amp;amp;redirect_uri=http://sa-oauth-client.com:8002/&lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;amp;scope=openid,userinfo&lt;br style=&quot;font-size: 10px;&quot;&gt;response_type=code: 授权码模式；&lt;br style=&quot;font-size: 10px;&quot;&gt;client_id=1001: 客户端应用的ID;&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;scope=openid,userinfo: 请求授权的资源范围&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="AZ33C6kLGZou72CWeF7D-11" vertex="1" connectable="0">
          <mxGeometry x="-0.5464" y="4" relative="1" as="geometry">
            <mxPoint x="-98" y="-11" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-7" value="&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;1 授权码模式-显示授权请求&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;假设尚未登录&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-9" target="AZ33C6kLGZou72CWeF7D-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-9" value="&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;b&gt;/oauth2/*&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;登录、授权码请求等等，认证服务器接口&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1440" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-14" target="AZ33C6kLGZou72CWeF7D-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-92" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-14" target="AZ33C6kLGZou72CWeF7D-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-122" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-14" target="AZ33C6kLGZou72CWeF7D-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="AZ33C6kLGZou72CWeF7D-14" target="bTc-rjDV2wfI3Pu5nD6s-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-14" value="HTTP 接口" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="40" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-15" target="AZ33C6kLGZou72CWeF7D-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-15" value="&lt;b&gt;SaPathCheckFilterForServlet&lt;/b&gt;#doFilter()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;SaStrategy&lt;/b&gt;路径校验&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1680" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-17" value="&lt;div style=&quot;text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;SaTokenContextForSpring&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;implements SaTokenContext&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-starter/sa-token-spring-boot-starter&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;本质是对 Spring 请求上下文&amp;nbsp;RequestContextHolder&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;的封装，通过 RequestContextHolder获取请求、响应信息，判断路由是否匹配等等&lt;/span&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public SaRequest getRequest()&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SaResponse getResponse()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SaStorage getStorage()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public boolean matchPath(String pattern, String path)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public boolean isValid()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-520" y="120" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-18" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;省略了服务初始化过程分析， 参考&amp;nbsp;sa-token-spring-boot-starter ，这种代码看得很多了，原理都一样；&lt;br style=&quot;font-size: 11px;&quot;&gt;自动配置类是&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;SaTokenContextRegister&lt;/b&gt;， 注册了两个Bean&amp;nbsp;&lt;b style=&quot;font-size: 11px;&quot;&gt;SaTokenContext&lt;/b&gt; (实现类是&lt;b style=&quot;font-size: 11px;&quot;&gt;SaTokenContextForSpring&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;)&lt;b style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;&lt;/b&gt;、&lt;b style=&quot;font-size: 11px;&quot;&gt;SaPathCheckFilterForServlet&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="320" y="125" width="600" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-21" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaPathCheckFilterForServlet&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;: sa-token-starter/sa-token-spring-boot-starter&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;通过 SaStrategy 校验请求 path 是否合法&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="120" width="480" height="90" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-22" target="AZ33C6kLGZou72CWeF7D-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-22" value="SaOAuth2ServerController#request()&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;请求参数等这里不解析，在后面的处理器中需要什么直接从Spring请求上下文中读&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1920" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-24" target="AZ33C6kLGZou72CWeF7D-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-64" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-24" target="AZ33C6kLGZou72CWeF7D-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-24" target="AZ33C6kLGZou72CWeF7D-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-132" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-24" target="AZ33C6kLGZou72CWeF7D-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="AZ33C6kLGZou72CWeF7D-24" target="bTc-rjDV2wfI3Pu5nD6s-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-24" value="&lt;b&gt;SaOAuth2ServerProcessor&lt;/b&gt;.instance&lt;br style=&quot;font-size: 11px;&quot;&gt;.dister()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="2160" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-26" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2ServerProcessor&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于OAuth2请求的处理，提供了所有四种模式各步骤的处理方法&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 请求路由分发处理，一堆 if 根据路由信息选择对应的处理方法处理&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object dister()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 授权码模式，请求授权码请求处理（/oauth2/authorize&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object authorize()&amp;nbsp;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-520" y="320" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-27" target="AZ33C6kLGZou72CWeF7D-39" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2850" y="620" />
              <mxPoint x="2850" y="400" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-41" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-40" vertex="1" connectable="0">
          <mxGeometry x="0.8091" relative="1" as="geometry">
            <mxPoint x="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-61" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-27" target="AZ33C6kLGZou72CWeF7D-60" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2850" y="620" />
              <mxPoint x="2850" y="550" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-62" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-61" vertex="1" connectable="0">
          <mxGeometry x="0.5877" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-98" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-27" target="AZ33C6kLGZou72CWeF7D-97" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2850" y="620" />
              <mxPoint x="2850" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-99" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-98" vertex="1" connectable="0">
          <mxGeometry x="0.5478" y="3" relative="1" as="geometry">
            <mxPoint x="7" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-27" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;public Object &lt;b&gt;authorize&lt;/b&gt;() {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; SaRequest req = SaHolder.getRequest();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; SaResponse res = SaHolder.getResponse();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; SaOAuth2ServerConfig cfg = SaOAuth2Manager.getServerConfig();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; SaOAuth2DataGenerate dataGenerate = SaOAuth2Manager.getDataGenerate();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Template oauth2Template = SaOAuth2Manager.getTemplate();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; String responseType = req.getParamNotNull(Param.response_type);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1、先判断是否开启了指定的授权模式&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;checkAuthorizeResponseType&lt;/b&gt;(responseType, req, cfg);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 2、如果尚未登录, 则先去登录, 用户需要先登陆才能给第三方应用授权&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if( ! SaOAuth2Manager.getStpLogic().&lt;b&gt;isLogin&lt;/b&gt;()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return cfg.notLoginView.get();&amp;nbsp; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//未登陆则跳转到登陆页面 login.html&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 3、构建请求 Model，用于后续的处理&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; RequestAuthModel ra = SaOAuth2Manager.&lt;b&gt;getDataResolver&lt;/b&gt;().&lt;b&gt;readRequestAuthModel&lt;/b&gt;(req, SaOAuth2Manager.getStpLogic().&lt;b&gt;getLoginId&lt;/b&gt;()); &lt;font color=&quot;#007fff&quot;&gt;//第2步已经查过loginId了，这又查了一次，可以优化&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 4、校验：重定向域名是否合法(正则匹配、@字符检查、url 是否在允许的地址列表)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; oauth2Template.checkRedirectUri(ra.clientId, ra.redirectUri);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 5、校验：此次申请的Scope，该Client是否已经签约&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; oauth2Template.checkContractScope(ra.clientId, ra.scopes);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 6、判断：如果此次申请的Scope，该用户尚未授权，则转到授权页面 confirm.html&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 历史授权记录默认存储在Redis, key 为 satoken:oauth2:grant-scope:&amp;lt;clientId&amp;gt;:&amp;lt;loginId&amp;gt;&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean isNeedCarefulConfirm = oauth2Template.isNeedCarefulConfirm(ra.loginId, ra.clientId, &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ra.scopes);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if(isNeedCarefulConfirm) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return cfg.confirmView.apply(ra.clientId, ra.scopes); &lt;font color=&quot;#007fff&quot;&gt;//向用户展示第三方用用ID和授权资源范围&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 7、判断授权类型，重定向到不同地址&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // &lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;如果是 授权码式，则：开始重定向授权，下放code&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if(ResponseType.code.equals(ra.responseType)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CodeModel codeModel = dataGenerate.generateCode(ra);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String redirectUri = dataGenerate.buildRedirectUri(ra.redirectUri, codeModel.code, ra.state);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return res.&lt;b&gt;redirect&lt;/b&gt;(redirectUri);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // &lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;如果是 隐藏式，则：开始重定向授权，下放 token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if(ResponseType.token.equals(ra.responseType)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AccessTokenModel at = dataGenerate.generateAccessToken(ra, false);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String redirectUri = dataGenerate.buildImplicitRedirectUri(ra.redirectUri, at.accessToken, ra.state);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return res.&lt;b&gt;redirect&lt;/b&gt;(redirectUri);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 默认返回&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;无效 response_type: &quot; + ra.responseType).setCode(SaOAuth2ErrorCode.CODE_30125);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="2400" y="320" width="440" height="600" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-29" value="SaOAuth2ServerProcessor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2535" y="290" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-30" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;和认证服务器一起的资源服务器&lt;br style=&quot;font-size: 11px;&quot;&gt;通常指用户资源&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1410" y="130" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-31" target="AZ33C6kLGZou72CWeF7D-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-31" target="AZ33C6kLGZou72CWeF7D-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-31" target="AZ33C6kLGZou72CWeF7D-44" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-550" y="1320" />
              <mxPoint x="-550" y="1300" />
              <mxPoint x="-1060" y="1300" />
              <mxPoint x="-1060" y="1060" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-31" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2Manager&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// OAuth2服务端配置，比如是否开启某种模式、code、token有效时间等&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2ServerConfig &lt;b&gt;serverConfig&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2DataLoader &lt;b&gt;dataLoader&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2DataResolver &lt;b&gt;dataResolver&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2DataConverter &lt;b&gt;dataConverter&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2DataGenerate &lt;b&gt;dataGenerate&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2Dao &lt;b&gt;dao&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile SaOAuth2Template &lt;b&gt;template&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static volatile StpLogic &lt;b&gt;stpLogic&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1200" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-32" target="AZ33C6kLGZou72CWeF7D-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-32" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataGenerateDefaultImpl&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1200" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-33" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataGenerate&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;用于生成四种模式中的各种凭据：code access_token refresh_access_token client_token redirect_uri&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;CodeModel &lt;b&gt;generateCode&lt;/b&gt;(RequestAuthModel ra);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AccessTokenModel &lt;b&gt;generateAccessToken&lt;/b&gt;(String code);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AccessTokenModel &lt;b&gt;refreshAccessToken&lt;/b&gt;(String refreshToken);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AccessTokenModel &lt;b&gt;generateAccessToken&lt;/b&gt;(RequestAuthModel ra, boolean isCreateRt);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;ClientTokenModel &lt;b&gt;generateClientToken&lt;/b&gt;(String clientId, List&amp;lt;String&amp;gt; scopes);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String &lt;b&gt;buildRedirectUri&lt;/b&gt;(String redirectUri, String code, String state);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String &lt;b&gt;buildImplicitRedirectUri&lt;/b&gt;(String redirectUri, String token, String state);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void checkState(String state);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="960" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-35" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2Template&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;可以理解为 SaOAuth2Dao 的上一层，可以当作 Service 层，提供了 OAuth2 核心逻辑的实现&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1320" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-39" target="AZ33C6kLGZou72CWeF7D-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-39" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;if(responseType.equals(ResponseType.code)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(!cfg.enableAuthorizationCode) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throwErrorSystemNotEnableModel();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 先从请求上下文读取clientId, 然后通过DAO接口查询为此客户端设置的客户端配置&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 读取其中允许的认证类型是否包含授权码类型&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(!&lt;b&gt;currClientModel&lt;/b&gt;().getAllowGrantTypes().contains(GrantType.authorization_code)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throwErrorClientNotEnableModel();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2880" y="320" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-42" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;public SaClientModel currClientModel() {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Template oauth2Template = SaOAuth2Manager.getTemplate();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 读取参数 client_id client_secret, 这里并没有指定 client_secret 所以这个值为 null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ClientIdAndSecretModel clientIdAndSecret = SaOAuth2Manager.getDataResolver()&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;.&lt;b&gt;readClientIdAndSecret&lt;/b&gt;(SaHolder.getRequest());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 此Demo中内部通过&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;SaOAuth2DataLoaderImpl 获取客户端的配置，是写死的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return oauth2Template.&lt;b&gt;checkClientModel&lt;/b&gt;(clientIdAndSecret.clientId);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="3360" y="350" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-44" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataResolver&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;用于从请求中读取特定数据，以及按某种格式输出返回值&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;ClientIdAndSecretModel readClientIdAndSecret(SaRequest request);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String readAccessToken(SaRequest request);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String readClientToken(SaRequest request);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;RequestAuthModel readRequestAuthModel(SaRequest req, Object loginId);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Map&amp;lt;String, Object&amp;gt; buildAccessTokenReturnValue(AccessTokenModel at);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default Map&amp;lt;String, Object&amp;gt; buildRefreshTokenReturnValue(AccessTokenModel at)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default Map&amp;lt;String, Object&amp;gt; buildRevokeTokenReturnValue()&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Map&amp;lt;String, Object&amp;gt; buildClientTokenReturnValue(ClientTokenModel ct)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="960" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-45" target="AZ33C6kLGZou72CWeF7D-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-45" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataResolverDefaultImpl&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1200" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-48" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaRequest&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-core&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;定义从SaRequest中读取请求信息的一些方法，不同的通信方式有不同的实现，Sa-Token 支持Servlet、GRPC、Dubbo、Reactor 请求&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="320" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-51" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-50" target="AZ33C6kLGZou72CWeF7D-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-50" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;div&gt;&lt;b&gt;SaRequestForServlet&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;: sa-token-starter/sa-token-jakarta-servlet&lt;/div&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;支持的 Servlet 类型请求实现，本质还是 HttpServletRequest&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;&quot;&gt;&lt;br&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;&quot;&gt;protected HttpServletRequest request;&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="440" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-52" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataLoader&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;用于从请求中读取特定数据，以及按某种格式输出返回值&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认实现是从服务端配置客户端Map中查询客户端配置，企业服务中需要重写这个方法改为从数据库中查询&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default SaClientModel &lt;b&gt;getClientModel&lt;/b&gt;(String clientId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default SaClientModel getClientModelNotNull(String clientId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default String getOpenid(String clientId, Object loginId)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1320" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-53" target="AZ33C6kLGZou72CWeF7D-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-53" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2DataLoaderDefaultImpl&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;默认实现是空的，即执行默认实现&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1520" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-55" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;Demo 中为 1001客户端写死的配置：&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;clientModel = {&lt;b style=&quot;font-size: 10px;&quot;&gt;SaClientModel&lt;/b&gt;@8696}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;clientId&lt;/b&gt; = &quot;1001&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;clientSecret&lt;/b&gt; = &quot;aaaa-bbbb-cccc-dddd-eeee&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;contractScopes&lt;/b&gt; = {ArrayList@8700}&amp;nbsp; size = 4&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = &quot;openid&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 1 = &quot;userid&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 2 = &quot;userinfo&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 3 = &quot;oidc&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;allowRedirectUris&lt;/b&gt; = {ArrayList@8701}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = &quot;*&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;allowGrantTypes&lt;/b&gt; = {ArrayList@8702}&amp;nbsp; size = 6&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = &quot;authorization_code&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 1 = &quot;implicit&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 2 = &quot;refresh_token&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 3 = &quot;password&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 4 = &quot;client_credentials&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 5 = &quot;phone_code&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;isNewRefresh&lt;/b&gt; = {Boolean@8500} false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;accessTokenTimeout&lt;/b&gt; = 7200&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;refreshTokenTimeout&lt;/b&gt; = 2592000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;clientTokenTimeout&lt;/b&gt; = 7200&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b style=&quot;font-size: 10px;&quot;&gt;lowerClientTokenTimeout&lt;/b&gt; = -1&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3810" y="345" width="240" height="290" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-56" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaClientModel&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;应用OAuth2配置&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String clientId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String clientSecret;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; contractScopes;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; allowRedirectUris;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public List&amp;lt;String&amp;gt; allowGrantTypes = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean isNewRefresh;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long accessTokenTimeout;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long refreshTokenTimeout;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long clientTokenTimeout;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long lowerClientTokenTimeout;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="960" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-57" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;StpLogic&lt;/b&gt; : sa-token-core&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;权限认证逻辑实现层&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String loginType;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private SaTokenConfig config;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1480" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-58" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaHolder&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-core&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;通过此类快速获取当前环境下的 SaRequest、SaResponse、SaStorage、SaApplication 对象, 前三种通过 SaManager 实现&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-520" y="600" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-59" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaManager&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-core&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;管理所有全局组件&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public volatile static SaTokenConfig config;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaTokenDao saTokenDao;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static StpInterface stpInterface;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaTokenContext &lt;b&gt;saTokenContext&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaTokenSecondContext &lt;b&gt;saTokenSecondContext&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaTempInterface saTemp;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaJsonTemplate saJsonTemplate;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaSignTemplate saSignTemplate;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile static SaSameTemplate saSameTemplate;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public volatile static SaLog log = new SaLogForConsole();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static Map&amp;lt;String, StpLogic&amp;gt; stpLogicMap = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="600" width="480" height="240" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-60" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;判断用户是否登录，首先是确认用户的token是否存在，是通过三种方式确认：Storage 中是否有存储(对于Servlet就是看属性中有没有token)、请求体、请求头、cookie 中是否有token；&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;token 存在的话需要通过 token 获取 loginId（其实就是用户ID）， loginId 为null 可能token是伪造的也视为未登陆; &lt;br&gt;最后校验token是否有效&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2880" y="520" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-63" target="AZ33C6kLGZou72CWeF7D-65" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-63" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;public Object &lt;b&gt;doLogin&lt;/b&gt;() {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; SaRequest req = SaHolder.getRequest();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; SaOAuth2ServerConfig cfg = SaOAuth2Manager.getServerConfig();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // SaOAuth2ServerConfig 通过函数式接口定义登陆逻辑&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;cfg&lt;/b&gt;.&lt;b&gt;doLoginHandle&lt;/b&gt;.apply(req.getParam(Param.name), req.getParam(Param.pwd));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2400" y="960" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-65" target="AZ33C6kLGZou72CWeF7D-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-71" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-69" vertex="1" connectable="0">
          <mxGeometry x="-0.0522" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-65" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;oauth2Server.doLoginHandle = (name, pwd) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(&quot;sa&quot;.equals(name) &amp;amp;&amp;amp; &quot;123456&quot;.equals(pwd)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; StpUtil.&lt;b&gt;login&lt;/b&gt;(10001);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return SaResult.ok();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return SaResult.error(&quot;账号名或密码错误&quot;);&lt;/div&gt;&lt;div&gt;};&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2880" y="960" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-67" value="SaOAuth2ServerController" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3015" y="930" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-73" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-68" target="AZ33C6kLGZou72CWeF7D-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-68" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void login(Object id, SaLoginModel loginModel) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1、创建会话&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String token = createLoginSession(id, loginModel);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 2、在当前客户端注入 token&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; setTokenValue(token, loginModel);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3360" y="960" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-70" value="StpLogic" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3545" y="930" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-72" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;TODO: 内部细节&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;" parent="1" vertex="1">
          <mxGeometry x="3840" y="970" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-111" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-74" target="AZ33C6kLGZou72CWeF7D-110" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2850" y="1380" />
              <mxPoint x="2850" y="1140" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-112" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-111" vertex="1" connectable="0">
          <mxGeometry x="0.8641" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-119" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-74" target="AZ33C6kLGZou72CWeF7D-118" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2850" y="1380" />
              <mxPoint x="2850" y="1470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-120" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-119" vertex="1" connectable="0">
          <mxGeometry x="0.7375" y="4" relative="1" as="geometry">
            <mxPoint y="4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-74" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 用户确认为第三方应用授权&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;public Object &lt;b&gt;doConfirm&lt;/b&gt;() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaRequest req = SaHolder.getRequest();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String clientId = req.getParamNotNull(Param.client_id);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Object loginId = SaOAuth2Manager.getStpLogic().getLoginId();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String scope = req.getParamNotNull(Param.scope);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;String&amp;gt; scopes = SaOAuth2Manager.getDataConverter().convertScopeStringToList(scope);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2DataGenerate dataGenerate = SaOAuth2Manager.getDataGenerate();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Template oauth2Template = SaOAuth2Manager.getTemplate();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 此请求只允许 POST 方式&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(!req.isMethod(SaHttpMethod.POST)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;无效请求方式：&quot; + req.getMethod()).setCode(SaOAuth2ErrorCode.CODE_30151);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 1 确认授权&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; oauth2Template.&lt;b&gt;saveGrantScope&lt;/b&gt;(clientId, loginId, scopes);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 判断所需的返回结果模式&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; boolean buildRedirectUri = req.isParam(Param.build_redirect_uri, &quot;true&quot;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // -------- 情况1：只返回确认结果即可&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if( ! buildRedirectUri ) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oauth2Template.saveGrantScope(clientId, loginId, scopes);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return SaResult.ok();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp; // -------- 情况2：需要返回最终的 redirect_uri 地址&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // s3、构建请求 Model&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RequestAuthModel ra = SaOAuth2Manager.getDataResolver().readRequestAuthModel(req, loginId);&lt;/div&gt;&lt;div&gt;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; &amp;nbsp;&lt;b&gt; // 判断授权类型，构建不同的重定向地址&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // &lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;如果是 授权码式，则：开始重定向授权，下放code&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(ResponseType.code.equals(ra.responseType)) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 2 删除旧的授权码，生成新的授权码并保存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CodeModel codeModel = dataGenerate.&lt;b&gt;generateCode&lt;/b&gt;(ra);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 将 code state 作为参数拼接到 redirectUri 后面，比如：&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;http://sa-oauth-client.com:8002/?code=Z1QkqED1XdIhGfIqJa8UqQROrd1qFBInXPyzSn8qHd6TRfQsZHvSkJQsz6N9&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String redirectUri = dataGenerate.buildRedirectUri(ra.redirectUri, codeModel.code, ra.state);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return SaResult.ok().set(Param.&lt;b&gt;redirect_uri&lt;/b&gt;, &lt;b&gt;redirectUri&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;如果是 隐藏式，则：开始重定向授权，下放 token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(ResponseType.token.equals(ra.responseType)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AccessTokenModel at = dataGenerate.generateAccessToken(ra, false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String redirectUri = dataGenerate.buildImplicitRedirectUri(ra.redirectUri, at.accessToken, ra.state);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return SaResult.ok().set(Param.&lt;b&gt;redirect_uri&lt;/b&gt;, redirectUri);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 默认返回&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;无效response_type: &quot; + ra.responseType).setCode(SaOAuth2ErrorCode.CODE_30125);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="2400" y="1080" width="440" height="600" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-76" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1300" y="430" />
              <mxPoint x="1300" y="365" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-78" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;用户名密码&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="AZ33C6kLGZou72CWeF7D-77" vertex="1" connectable="0">
          <mxGeometry x="-0.7594" y="1" relative="1" as="geometry">
            <mxPoint x="-3" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-76" value="&lt;b style=&quot;font-size: 11px;&quot;&gt;2 用户如果未登录需要先登录&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-107" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-80" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1360" y="410" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1300" y="510" />
              <mxPoint x="1300" y="365" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-109" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;请求头会额外带上 satoken&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];fontSize=10;" parent="AZ33C6kLGZou72CWeF7D-107" vertex="1" connectable="0">
          <mxGeometry x="-0.7756" y="1" relative="1" as="geometry">
            <mxPoint x="-4" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-80" value="&lt;b style=&quot;font-size: 11px;&quot;&gt;3 授权码模式-显示授权请求&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-106" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-82" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1300" y="590" />
              <mxPoint x="1300" y="365" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-108" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;http://sa-oauth-server.com:8000/oauth2/doConfirm&lt;br&gt;&lt;div&gt;cookie:&lt;/div&gt;&lt;div&gt;satoken=e20035ac-d5fc-4180-a177-36949e37c276&lt;br&gt;&lt;div&gt;client_id: 1001&lt;br&gt;payload:&lt;/div&gt;&lt;div&gt;scope: openid,userinfo&lt;/div&gt;&lt;div&gt;build_redirect_uri: true&lt;/div&gt;&lt;div&gt;response_type: code&lt;/div&gt;&lt;div&gt;redirect_uri: http://sa-oauth-client.com:8002/&lt;/div&gt;&lt;div&gt;state:&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-106" vertex="1" connectable="0">
          <mxGeometry x="-0.7907" y="-1" relative="1" as="geometry">
            <mxPoint x="-4" y="39" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-123" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-82" target="AZ33C6kLGZou72CWeF7D-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-125" value="&lt;font color=&quot;#007fff&quot;&gt;H5重定向&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-123" vertex="1" connectable="0">
          <mxGeometry x="-0.761" relative="1" as="geometry">
            <mxPoint x="10" y="6" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-82" value="&lt;b style=&quot;font-size: 11px;&quot;&gt;4 用户确认授权&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;授权服务器返回 redirect_uri 后，confirm.html 中重定向到此地址&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-88" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="AZ33C6kLGZou72CWeF7D-128" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1300" y="960" />
              <mxPoint x="1300" y="365" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-130" value="&lt;font color=&quot;#007fff&quot;&gt;http://sa-oauth-server.com:8000/oauth2/token&lt;br&gt;payload:&lt;br&gt;grant_type: authorization_code&lt;br&gt;code: xxx&lt;br&gt;client_id: xxx&lt;br&gt;client_secret: xxx&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-88" vertex="1" connectable="0">
          <mxGeometry x="-0.92" y="1" relative="1" as="geometry">
            <mxPoint x="-3" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-84" value="&lt;b&gt;/codeLogin&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;接受认证服务器的授权码然后结合client_id请求获取token (包括access_token 和 refresh_token)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="bTc-rjDV2wfI3Pu5nD6s-4" target="AZ33C6kLGZou72CWeF7D-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1300" y="1170" />
              <mxPoint x="1300" y="365" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-7" value="&lt;font color=&quot;#007fff&quot;&gt;http://sa-oauth-server.com:8000/oauth2/refresh?grant_type=refresh_token&lt;br&gt;&amp;amp;client_id={value}&amp;amp;client_secret={value}&amp;amp;refresh_token={value}&lt;/font&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="AZ33C6kLGZou72CWeF7D-93">
          <mxGeometry x="-0.9397" y="-1" relative="1" as="geometry">
            <mxPoint x="-6" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-91" value="&lt;b&gt;/refresh&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过 refresh_token 刷新 access_token&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="AZ33C6kLGZou72CWeF7D-94" target="bTc-rjDV2wfI3Pu5nD6s-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-94" value="&lt;b style=&quot;font-size: 11px;&quot;&gt;/oauth2/&lt;/b&gt;&lt;b&gt;userinfo&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;获取用户信息，资源服务器接口&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1440" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-95" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;用户登录Token的key : satoken:login:token:xxxxxx&lt;br style=&quot;font-size: 10px;&quot;&gt;值是登录ID, 默认存储在 Redis&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;比如： satoken:login:token:e20035ac-d5fc-4180-a177-36949e37c276 -&amp;gt; 10001&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3330" y="525" width="370" height="50" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-96" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;ra = {&lt;b&gt;RequestAuthModel&lt;/b&gt;@9275}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;clientId = &quot;1001&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;scopes = {ArrayList@9282}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; 0 = &quot;openid&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; 1 = &quot;userinfo&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;loginId = &quot;10001&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;redirectUri = &quot;http://sa-oauth-client.com:8002/&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;responseType = &quot;code&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;state = null&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3330" y="610" width="230" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-97" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 从请求参数构建 RequestAuthModel 对象&lt;/font&gt;&lt;/div&gt;&lt;div&gt;public RequestAuthModel readRequestAuthModel(SaRequest req, Object loginId) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RequestAuthModel ra = new RequestAuthModel();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.clientId = req.getParamNotNull(Param.&lt;b&gt;client_id&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.responseType = req.getParamNotNull(Param.&lt;b&gt;response_type&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.redirectUri = req.getParamNotNull(Param.&lt;b&gt;redirect_uri&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.state = req.getParam(Param.&lt;b&gt;state&lt;/b&gt;);&lt;font color=&quot;#007fff&quot;&gt; // 请求参数还有 state&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.scopes = SaOAuth2Manager.getDataConverter().convertScopeStringToList(&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; req.getParam(Param.&lt;b&gt;scope&lt;/b&gt;));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ra.loginId = loginId;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return ra;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2880" y="600" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-100" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2ServerConfig&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-oauth2&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;// 是否打开模式：授权码（Authorization Code）&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean enableAuthorizationCode = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是否打开模式：隐藏式（Implicit）&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean enableImplicit = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是否打开模式：密码式（Password）&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean enablePassword = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是否打开模式：凭证式（Client Credentials）&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean enableClientCredentials = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是否在每次 Refresh-Token 刷新 Access-Token 时，产生一个新的 Refresh-Token&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean isNewRefresh = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Code授权码 保存的时间(单位：秒) 默认五分钟&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long codeTimeout = 60 * 5;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Access-Token 保存的时间(单位：秒) 默认两个小时&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long accessTokenTimeout = 60 * 60 * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Refresh-Token 保存的时间(单位：秒) 默认30 天&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long refreshTokenTimeout = 60 * 60 * 24 * 30;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Client-Token 保存的时间(单位：秒) 默认两个小时&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long clientTokenTimeout = 60 * 60 * 2;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Lower-Client-Token 保存的时间(单位：秒) 默认为 -1，代表延续 Client-Token 有效期&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public long lowerClientTokenTimeout = -1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认 openid 生成算法中使用的摘要前缀&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String openidDigestPrefix = SaOAuth2Consts.OPENID_DEFAULT_DIGEST_PREFIX;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 指定高级权限，多个用逗号隔开，高级权限必须经过用户手动授权&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String higherScope;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 指定低级权限，多个用逗号隔开，低级权限不需要用户手动授权，&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 其实还有一种中级权限，即既不包含在高级权限列表也不包含在低级权限列表，结合历史授权记录判断是否需要用户手动授权&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public String lowerScope;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 模式4是否返回 AccessToken 字段&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean mode4ReturnAccessToken = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 是否在返回值中隐藏默认的状态字段 (code、msg、data)&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Boolean hideStatusField = false;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// oidc 相关配置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;SaOAuth2OidcConfig oidc = new SaOAuth2OidcConfig();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// client 列表，默认在此处存储支持的客户端 APP&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Map&amp;lt;String, SaClientModel&amp;gt; &lt;b&gt;clients&lt;/b&gt; = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// OAuth-Server端：未登录时返回的View&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SaOAuth2NotLoginViewFunction notLoginView = () -&amp;gt; &quot;当前会话在 OAuth-Server 认证中心尚未登录&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// OAuth-Server端：确认授权时返回的View&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SaOAuth2ConfirmViewFunction confirmView = (clientId, scopes) -&amp;gt; &quot;本次操作需要用户授权&quot;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// OAuth-Server端：登录函数&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public SaOAuth2DoLoginHandleFunction doLoginHandle = (name, pwd) -&amp;gt; SaResult.error();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="1640" width="480" height="680" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-102" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;endArrow=block;endFill=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-101" target="AZ33C6kLGZou72CWeF7D-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-101" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;xxx&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;业务中应该重新实现此接口，配置支持的客户端应用&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="1520" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-103" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2Dao&lt;/b&gt; : sa-token-core&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1640" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-104" target="AZ33C6kLGZou72CWeF7D-103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-104" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaTokenDaoRedisJackson&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;: sa-token-plugin/sa-token-redis-jackson&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1760" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-110" target="AZ33C6kLGZou72CWeF7D-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-110" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;SaOAuth2Manager.getDao().&lt;b&gt;saveGrantScope&lt;/b&gt;(clientId, loginId, scopes);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1110" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-113" value="SaOAuth2Template" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3035" y="1079" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-114" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;default void saveGrantScope(String clientId, Object loginId, List&amp;lt;String&amp;gt; scopes) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if( ! SaFoxUtil.isEmpty(scopes)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long ttl = checkClientModel(clientId).getAccessTokenTimeout();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String value = SaOAuth2Manager.getDataConverter().convertScopeListToString(scopes);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 默认保存在Redis, key 为&amp;nbsp;satoken:oauth2:grant-scope:&amp;lt;clientId&amp;gt;:&amp;lt;loginId&amp;gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // value 为授权资源范围，如： openid,userinfo&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getSaTokenDao().&lt;b&gt;set&lt;/b&gt;(splicingGrantScopeKey(clientId, loginId), value, ttl);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="3360" y="1080" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-116" value="SaOAuth2Dao" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3530" y="1050" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-117" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ra = {RequestAuthModel@9957}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;clientId = &quot;1001&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;scopes = {ArrayList@9963}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 0 = &quot;openid&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; 1 = &quot;userinfo&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;loginId = &quot;10001&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;redirectUri = &quot;http://sa-oauth-client.com:8002/&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;responseType = &quot;code&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;state = &quot;&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1280" width="230" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-118" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public void setObject(String key, Object object, long timeout) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(timeout == 0 || timeout &amp;lt;= SaTokenDao.NOT_VALUE_EXPIRE)&amp;nbsp; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(timeout == SaTokenDao.NEVER_EXPIRE) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; objectRedisTemplate.opsForValue().set(key, object);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// key 为&amp;nbsp;satoken:oauth2:code:&amp;lt;code&amp;gt;, value 为 CodeModel 序列化后的字符串&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; objectRedisTemplate.opsForValue().set(key, object, timeout, TimeUnit.SECONDS);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1400" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-126" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-121" target="AZ33C6kLGZou72CWeF7D-84" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="500" y="750" />
              <mxPoint x="500" y="790" />
              <mxPoint x="260" y="790" />
              <mxPoint x="260" y="815" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-127" value="&lt;font color=&quot;#007fff&quot;&gt;js中判断 code 参数不为空调用&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AZ33C6kLGZou72CWeF7D-126" vertex="1" connectable="0">
          <mxGeometry x="-0.7855" y="1" relative="1" as="geometry">
            <mxPoint x="59" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-121" value="&lt;b&gt;/&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;读取用户登录ID, 保存到请求uid属性，然后返回 index.html&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-129" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#330033;" parent="1" source="AZ33C6kLGZou72CWeF7D-84" target="AZ33C6kLGZou72CWeF7D-128" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="830" as="sourcePoint" />
            <mxPoint x="1440" y="365" as="targetPoint" />
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-128" value="&lt;div&gt;public SaResult codeLogin(String code) throws JsonProcessingException {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 调用Server端接口，获取 Access-Token 以及其他信息&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String str = OkHttps.&lt;b&gt;sync&lt;/b&gt;(serverUrl + &quot;/oauth2/&lt;b&gt;token&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addBodyPara(&quot;grant_type&quot;, &quot;authorization_code&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addBodyPara(&quot;code&quot;, code)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addBodyPara(&quot;client_id&quot;, clientId)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .addBodyPara(&quot;client_secret&quot;, clientSecret)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .post()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .getBody()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .toString();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SoMap so = SoMap.getSoMap().setJsonString(str);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; System.out.println(&quot;返回结果: &quot; + new ObjectMapper().writeValueAsString(so));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // code不等于200&amp;nbsp; 代表请求失败&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(so.getInt(&quot;code&quot;) != 200) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return SaResult.error(so.getString(&quot;msg&quot;));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 根据openid获取其对应的userId&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long uid = getUserIdByOpenid(so.getString(&quot;openid&quot;));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; so.set(&quot;uid&quot;, uid);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 返回相关参数&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; StpUtil.&lt;b&gt;login&lt;/b&gt;(uid);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return SaResult.data(so);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="520" y="800" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-131" target="AZ33C6kLGZou72CWeF7D-133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-131" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 授权码模式使用code换access_token || 密码模式使用用户名或密码换access_token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;public Object &lt;b&gt;token&lt;/b&gt;() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AccessTokenModel accessTokenModel = SaOAuth2Strategy.instance.&lt;b&gt;grantTypeAuth&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .apply(SaHolder.getRequest());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return SaOAuth2Manager.getDataResolver()&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;buildAccessTokenReturnValue&lt;/b&gt;(accessTokenModel);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="2400" y="1720" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-148" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-133" target="AZ33C6kLGZou72CWeF7D-147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="AZ33C6kLGZou72CWeF7D-133" target="bTc-rjDV2wfI3Pu5nD6s-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-133" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public SaOAuth2GrantTypeAuthFunction &lt;b&gt;grantTypeAuth&lt;/b&gt; = (req) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String grantType = req.getParamNotNull(SaOAuth2Consts.Param.&lt;b&gt;grant_type&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 每种模式有对应的处理器&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2GrantTypeHandlerInterface grantTypeHandler = &lt;b&gt;grantTypeHandlerMap&lt;/b&gt;.get(&lt;b&gt;grantType&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(grantTypeHandler == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;无效 grant_type: &quot; + grantType).setCode(SaOAuth2ErrorCode.CODE_30126);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 看看全局是否开启了此 grantType&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2ServerConfig config = SaOAuth2Manager.getServerConfig();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(grantType.equals(GrantType.authorization_code) &amp;amp;&amp;amp; !config.getEnableAuthorizationCode() ) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;系统未开放的 grant_type: &quot; + grantType).setCode(SaOAuth2ErrorCode.CODE_30126);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(grantType.equals(GrantType.password) &amp;amp;&amp;amp; !config.getEnablePassword() ) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;系统未开放的 grant_type: &quot; + grantType).setCode(SaOAuth2ErrorCode.CODE_30126);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 校验 clientSecret 和 scope&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ClientIdAndSecretModel clientIdAndSecretModel = SaOAuth2Manager.getDataResolver().&lt;b&gt;readClientIdAndSecret&lt;/b&gt;(req);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; /&lt;b&gt;/ 请求中还隐藏了一个参数 scope&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;String&amp;gt; scopes = SaOAuth2Manager.getDataConverter().convertScopeStringToList(req.getParam(SaOAuth2Consts.Param.&lt;b&gt;scope&lt;/b&gt;));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaClientModel clientModel = SaOAuth2Manager.getTemplate().checkClientSecretAndScope(clientIdAndSecretModel.getClientId(), clientIdAndSecretModel.getClientSecret(), scopes);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 检测应用是否开启此 grantType&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(!clientModel.getAllowGrantTypes().&lt;b&gt;contains&lt;/b&gt;(grantType)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new SaOAuth2Exception(&quot;应用未开放的 grant_type: &quot; + grantType).setCode(SaOAuth2ErrorCode.CODE_30141);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 调用 处理器&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;grantTypeHandler&lt;/b&gt;.&lt;b&gt;getAccessToken&lt;/b&gt;(req, clientIdAndSecretModel.getClientId(), scopes);&lt;/div&gt;&lt;div&gt;};&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="2880" y="1720" width="680" height="360" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-135" value="SaOAuth2Strategy" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="3160" y="1690" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-137" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2Strategy&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;: sa-token-plugin/sa-token-redis-jackson&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;OAuth2 工作模式策略&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final SaOAuth2Strategy &lt;b style=&quot;&quot;&gt;instance&lt;/b&gt; = new SaOAuth2Strategy();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于给Token添加用户信息（userid openid jwt）的处理器 Map&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Map&amp;lt;String, &lt;b&gt;SaOAuth2ScopeHandlerInterface&lt;/b&gt;&amp;gt; &lt;b&gt;scopeHandlerMap&lt;/b&gt; = &lt;br&gt;&amp;nbsp; &amp;nbsp; new LinkedHashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 授权模式处理器 Map , SaOAuth2GrantTypeHandlerInterface&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;用于生成 Token 对象&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Map&amp;lt;String, SaOAuth2GrantTypeHandlerInterface&amp;gt; &lt;b&gt;grantTypeHandlerMap&lt;/b&gt; = &lt;br&gt;&amp;nbsp; &amp;nbsp; new LinkedHashMap&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1560" y="1880" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-138" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;SaOAuth2GrantTypeHandlerInterface&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&amp;nbsp;: sa-token-plugin/sa-token-redis-jackson&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String getHandlerGrantType();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 获取 AccessToken 和 RefreshToken&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;AccessTokenModel &lt;b&gt;getAccessToken&lt;/b&gt;(SaRequest req, String clientId, List&amp;lt;String&amp;gt; scopes);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-2080" y="1880" width="480" height="80" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-141" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-140" target="AZ33C6kLGZou72CWeF7D-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-140" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;AuthorizationCodeGrantTypeHandler&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;: sa-token-plugin/sa-token-redis-jackson&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;授权码模式，authorization_code&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1920" y="2000" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-144" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-142" target="AZ33C6kLGZou72CWeF7D-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-142" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;PasswordGrantTypeHandler&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;: sa-token-plugin/sa-token-redis-jackson&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;密码模式，password&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2280" y="2000" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-145" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-143" target="AZ33C6kLGZou72CWeF7D-138" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1860" y="1970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-143" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;RefreshTokenGrantTypeHandler&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/b&gt;: sa-token-plugin/sa-token-redis-jackson&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Token刷新，refresh_token&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2640" y="2000" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-146" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;另外两种模式在 SaOAuth2ServerProcessor 中直接实现&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="-1920" y="2128" width="290" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-151" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AZ33C6kLGZou72CWeF7D-147" target="AZ33C6kLGZou72CWeF7D-150" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-147" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public AccessTokenModel &lt;b&gt;getAccessToken&lt;/b&gt;(SaRequest req, String clientId, List&amp;lt;String&amp;gt; scopes) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 从请求参数或请求头中获取 clientId 和 client_secret&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ClientIdAndSecretModel clientIdAndSecret = SaOAuth2Manager.getDataResolver()&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;readClientIdAndSecret&lt;/b&gt;(req);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; // String clientId = clientIdAndSecret.clientId;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String clientSecret = clientIdAndSecret.clientSecret;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String code = req.getParamNotNull(SaOAuth2Consts.Param.&lt;b&gt;code&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String redirectUri = req.getParam(SaOAuth2Consts.Param.&lt;b&gt;redirect_uri&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 校验参数: code 是否存在、client_id 和 client_secret 是否一致、&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;如果提供了redirectUri还需要校验其是否与请求Code时提供的一致&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Manager.getTemplate().checkGainTokenParam(code, clientId, clientSecret, &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;redirectUri);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 构建 Access-Token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 内部又校验了一次code、删除旧的 AccessTokenModel, 生成新对象并保存&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AccessTokenModel accessTokenModel = SaOAuth2Manager.getDataGenerate()&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .&lt;b&gt;generateAccessToken&lt;/b&gt;(code);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return accessTokenModel;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="3600" y="1780" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-149" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;code Redis Key:&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;satoken:oauth2:code:Z1QkqED1XdIhGfIqJa8UqQROrd1qFBInXPyzSn8qHd6TRfQsZHvSkJQsz6N9&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="3600" y="2020" width="470" height="40" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-156" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-150" target="AZ33C6kLGZou72CWeF7D-153" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-157" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-150" target="AZ33C6kLGZou72CWeF7D-154" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-158" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="AZ33C6kLGZou72CWeF7D-150" target="AZ33C6kLGZou72CWeF7D-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-150" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public AccessTokenModel generateAccessToken(String code) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Dao dao = SaOAuth2Manager.getDao();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2DataConverter dataConverter = SaOAuth2Manager.getDataConverter();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 1、先校验，默认存储在 Redis&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CodeModel cm = dao.getCode(code);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2AuthorizationCodeException.throwBy(cm == null, &quot;无效 code: &quot; + code, code, SaOAuth2ErrorCode.CODE_30110);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 2、删除旧Token，默认存在 Redis, KEY 为 satoken:o&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;auth2:access-token-index:&amp;lt;clientId&amp;gt;:&amp;lt;loginId&amp;gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.deleteAccessToken(dao.getAccessTokenValue(cm.clientId, cm.loginId));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.deleteRefreshToken(dao.getRefreshTokenValue(cm.clientId, cm.loginId));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // 3、生成token, 默认 access_token 是借助 ThreadLocalRandom 随机生成60位长的字符串&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AccessTokenModel at = dataConverter.&lt;b&gt;convertCodeToAccessToken&lt;/b&gt;(cm);&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 根据授权范围处理器，为令牌对象at extraData添加额外信息&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 比如&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;openid、&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;userid、id_token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Strategy.instance.workAccessTokenByScope.&lt;b&gt;accept&lt;/b&gt;(at);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // refresh_token 也是借助 ThreadLocalRandom 随机生成60位长的字符串&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RefreshTokenModel rt = dataConverter.&lt;b&gt;convertAccessTokenToRefreshToken&lt;/b&gt;(at);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; at.refreshToken = rt.refreshToken;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; at.refreshExpiresTime = rt.expiresTime;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt; &amp;nbsp; // 4、保存token，默认保存在 Redis,&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // access_token：&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp; &amp;nbsp;satoken:oauth2:access-token:{accessToken} -&amp;gt; at对象&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;border-color: var(--border-color); color: rgb(0, 127, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp; &amp;nbsp;satoken:oauth2:access-token-index:&amp;lt;clientId&amp;gt;:&amp;lt;loginId&amp;gt;&amp;nbsp; -&amp;gt; {accessToken}&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; // refresh_token: &lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp; &amp;nbsp;satoken:oauth2:refresh-token:{refreshToken} -&amp;gt; rt对象&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; &amp;nbsp; &amp;nbsp;satoken:oauth2:refresh-token-index:&amp;lt;clientId&amp;gt;:&amp;lt;loginId&amp;gt; -&amp;gt; {&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;background-color: initial; border-color: var(--border-color); color: rgb(0, 127, 255);&quot;&gt;refreshToken&lt;/b&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial; border-color: var(--border-color);&quot;&gt;}&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.saveAccessToken(at);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.saveAccessTokenIndex(at);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.saveRefreshToken(rt);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.saveRefreshTokenIndex(rt);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 5、删除此Code&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.deleteCode(code);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; dao.deleteCodeIndex(cm.clientId, cm.loginId);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 6、返回 Access-Token&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return at;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="4080" y="1650" width="440" height="500" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-152" value="SaOAuth2DataGenerateDefaultImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="4195" y="1620" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-153" value="OpenIdScopeHandler&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;在 extraData 中额外添加 openid,&amp;nbsp;&lt;br&gt;openid由&quot;摘要前缀_clientId_loginId&quot; MD5摘要获取&lt;/font&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4560" y="1790" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-154" value="UserIdScopeHandler&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;在 extraData 中额外添加 userid,&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;userid 就是 loginid&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4560" y="1870" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AZ33C6kLGZou72CWeF7D-155" value="OidcScopeHandler&lt;br&gt;&lt;div&gt;在 extraData 中额外添加 id_token,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;id_token 是 JWT&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="4560" y="1950" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;/oauth2/token 返回值：&lt;br&gt;{&quot;code&quot;:200,&quot;msg&quot;:&quot;ok&quot;,&quot;data&quot;:null,&quot;token_type&quot;:&quot;bearer&quot;,&lt;br&gt;&quot;access_token&quot;:&quot;krjdehZ1dXXQjXZ7XQCyIo7aEfMMwk2WSvRK4pBFdZGL4rSM1bwfeht5j3Rg&quot;,&lt;br&gt;&quot;refresh_token&quot;:&quot;vMzEcFYNkqEt7eai4dD3BJe3VrzTYOUeQaVWwNToJB5IUXuP80Mhr5MSAGgj&quot;,&lt;br&gt;&quot;expires_in&quot;:7199,&quot;refresh_expires_in&quot;:2591999,&quot;client_id&quot;:&quot;1001&quot;,&lt;br&gt;&quot;scope&quot;:&quot;openid,userinfo&quot;,&quot;openid&quot;:&quot;ded91dc189a437dd1bac2274be167d50&quot;}&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="970" y="1020" width="460" height="100" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="bTc-rjDV2wfI3Pu5nD6s-2" target="bTc-rjDV2wfI3Pu5nD6s-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-2" value="&lt;b&gt;/getUserinfo&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;请求资源服务器获取用户信息&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="1240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#330033;" edge="1" parent="1" source="AZ33C6kLGZou72CWeF7D-91" target="bTc-rjDV2wfI3Pu5nD6s-4">
          <mxGeometry relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="480" y="1170" as="sourcePoint" />
            <mxPoint x="1440" y="365" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-4" value="HTTP 请求 /oauth2/refresh" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="bTc-rjDV2wfI3Pu5nD6s-8" target="AZ33C6kLGZou72CWeF7D-94">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1320" y="1270" />
              <mxPoint x="1320" y="470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-13" value="&lt;font color=&quot;#007fff&quot;&gt;http://sa-oauth-server.com:8000/oauth2/userinfo?access_token={value}&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="bTc-rjDV2wfI3Pu5nD6s-12">
          <mxGeometry x="-0.9422" y="1" relative="1" as="geometry">
            <mxPoint x="163" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-8" value="HTTP 请求 /oauth2/userinfo" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="1240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="bTc-rjDV2wfI3Pu5nD6s-14" target="AZ33C6kLGZou72CWeF7D-133">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-14" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 使用 refresh_token 刷新 access_token&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;public Object refresh() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaRequest req = SaHolder.getRequest();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String grantType = req.getParamNotNull(Param.grant_type);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2Exception.throwBy(!grantType.equals(GrantType.refresh_token), &quot;无效 grant_type：&quot; &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + grantType, SaOAuth2ErrorCode.CODE_30126);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AccessTokenModel accessTokenModel = SaOAuth2Strategy.instance&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;grantTypeAuth&lt;/b&gt;.apply(req);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return SaOAuth2Manager.getDataResolver()&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .buildRefreshTokenReturnValue(accessTokenModel);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="2400" y="2120" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-17" value="AuthorizationCodeGrantTypeHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3710" y="1750" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-18" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;public AccessTokenModel &lt;b&gt;getAccessToken&lt;/b&gt;(SaRequest req, String clientId, List&amp;lt;String&amp;gt; scopes) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; String refreshToken = req.getParamNotNull(SaOAuth2Consts.Param.refresh_token);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 校验：Refresh-Token 是否存在&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RefreshTokenModel rt = SaOAuth2Manager.getDao().getRefreshToken(refreshToken);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2RefreshTokenException.throwBy(rt == null, &quot;无效refresh_token: &quot; + refreshToken, &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;refreshToken, SaOAuth2ErrorCode.CODE_30111);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 校验：Refresh-Token 代表的 ClientId 与提供的 ClientId 是否一致&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SaOAuth2ClientModelException.throwBy( ! rt.clientId.equals(clientId), &quot;无效client_id: &quot; + clientId, clientId, SaOAuth2ErrorCode.CODE_30122);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 获取新 Access-Token&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AccessTokenModel accessTokenModel = SaOAuth2Manager.getDataGenerate()&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;refreshAccessToken&lt;/b&gt;(refreshToken);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return accessTokenModel;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="3600" y="2120" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-20" value="RefreshTokenGrantTypeHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3735" y="2090" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="bTc-rjDV2wfI3Pu5nD6s-21" value="&lt;font color=&quot;#007fff&quot;&gt;...&lt;br&gt;// 即检查access_token是否还存在，以及这个令牌授予的资源范围是否包含 userinfo&lt;br&gt;&lt;/font&gt;SaOAuth2Util.&lt;b&gt;checkAccessTokenScope&lt;/b&gt;(accessToken, &quot;userinfo&quot;);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;... 返回用户信息 ...&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;" vertex="1" parent="1">
          <mxGeometry x="1680" y="440" width="440" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
