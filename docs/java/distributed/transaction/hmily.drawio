<mxfile host="Electron" modified="2024-05-22T06:51:47.260Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="gSk5xuZ3THxorFIbDKeI" version="21.6.5" type="device" pages="2">
  <diagram name="hmily" id="uB3T4hW82Nwa9GDvWSnv">
    <mxGraphModel dx="3682" dy="702" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="ILePiL2lHhwXlFeLtQY4-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-14" target="YnnrP53jlHVHSCE78MQg-6">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3100" y="3000" />
              <mxPoint x="3100" y="1940" />
              <mxPoint x="1220" y="1940" />
              <mxPoint x="1220" y="1485" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="YnnrP53jlHVHSCE78MQg-2" target="b_DPwCItqDpnZili3_qI-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="2480" />
              <mxPoint x="1450" y="1920" />
              <mxPoint x="500" y="1920" />
              <mxPoint x="500" y="830" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-1" value="&lt;h1 style=&quot;font-size: 18px;&quot;&gt;&lt;font style=&quot;font-size: 18px;&quot;&gt;Hmily TCC 模式工作原理流程&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;源码版本：2.1.2&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;测试DEMO: hmily/hmily-demo/hmily-demo-tcc/hmily-demo-tcc-grpc （源码下载下来调下参数就可以执行，直接在源码中调试吧）&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;前置知识：&lt;/span&gt;&lt;b style=&quot;font-size: 12px;&quot;&gt;TCC理论&lt;/b&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;、&lt;/span&gt;&lt;b style=&quot;font-size: 12px;&quot;&gt;Disruptor、&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;LogNet/grpc-spring-boot-starter、JUC&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;ConcurrentSkipListMap、common-lang3 MethodUtils&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;这是一个 SpringBoot 项目；创建了&lt;b&gt;3个数据库，分别有一张表&lt;/b&gt;, 使用Mybatis访问数据表；系统包含3个服务（订单、库存、账户，服务间通过 grpc 通信，订单服务是前台服务），模拟购买商品下单、扣库存、支付扣款流程。&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=16;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="820" height="130" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-2" target="b_DPwCItqDpnZili3_qI-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-2" value="业务事务处理" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-3" value="OrderController" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="330" y="530" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-4" target="b_DPwCItqDpnZili3_qI-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-4" value="Hmily事务管理器初始化" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="1" source="b_DPwCItqDpnZili3_qI-5" target="b_DPwCItqDpnZili3_qI-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-5" value="orderService.orderPay(count, amount)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;count 是商品数量，amount是支付金额&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="280" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="1" source="b_DPwCItqDpnZili3_qI-7" target="b_DPwCItqDpnZili3_qI-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-88" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-7" target="b_DPwCItqDpnZili3_qI-86" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="620" y="660" />
              <mxPoint x="380" y="660" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-143" value="&lt;font color=&quot;#007fff&quot;&gt;切面代理类&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-88" vertex="1" connectable="0">
          <mxGeometry x="-0.9512" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-7" value="Order order = saveOrder(count, amount);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="520" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-9" value="@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;confirmOrderStatus&quot;, cancelMethod = &quot;cancelOrderStatus&quot;)&lt;br&gt;paymentService.&lt;b&gt;makePayment&lt;/b&gt;(order);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-11" value="&lt;b&gt;orderMapper&lt;/b&gt;.&lt;b&gt;save&lt;/b&gt;(order);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="760" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-13" value="OrderServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="565" y="530" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-14" target="b_DPwCItqDpnZili3_qI-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-14" value="order.setStatus(orderStatus.getCode());&lt;br&gt;&lt;b&gt;orderMapper&lt;/b&gt;.&lt;b&gt;update&lt;/b&gt;(order);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;订单服务本地修改订单&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-16" target="b_DPwCItqDpnZili3_qI-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-16" target="b_DPwCItqDpnZili3_qI-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-16" value="accountClient.&lt;b&gt;payment&lt;/b&gt;(&lt;br&gt;String.valueOf(order.getUserId()), String.valueOf(order.getTotalAmount()&lt;br&gt;.doubleValue()));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;RPC调用扣减账户余额&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="880" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-18" target="b_DPwCItqDpnZili3_qI-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-18" value="inventoryClient.&lt;b&gt;decrease&lt;/b&gt;(&lt;br&gt;order.getProductId(), order.getCount());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;RPC调用扣减库存，事务的处理和&lt;br&gt;账户服务扣减余额一样，不细讲了&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="759.75" y="1110" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-20" target="b_DPwCItqDpnZili3_qI-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-28" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-27" vertex="1" connectable="0">
          <mxGeometry x="-0.0244" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-20" target="YnnrP53jlHVHSCE78MQg-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="935" />
              <mxPoint x="1220" y="1470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-20" value="AccountResponse response = &lt;b style=&quot;font-size: 10px;&quot;&gt;grpcHmilyClient&lt;/b&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;syncInvoke&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;accountServiceBlockingStub&lt;/b&gt;, &quot;payment&quot;, request, AccountResponse.class);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1000" y="890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-24" value="InventoryResponse response = &lt;b&gt;grpcHmilyClient&lt;/b&gt;.&lt;b&gt;syncInvoke&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;inventoryServiceBlockingStub&lt;/b&gt;, &quot;decrease&quot;, request, InventoryResponse.class);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="999.75" y="1110" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-26" target="b_DPwCItqDpnZili3_qI-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-4" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-35" vertex="1" connectable="0">
          <mxGeometry x="-0.0873" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-26" value="accountServiceBeanImpl&lt;br style=&quot;font-size: 11px;&quot;&gt;.&lt;b&gt;payment&lt;/b&gt;(accountDTO)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480.75" y="890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-24" target="b_DPwCItqDpnZili3_qI-32" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1209.75" y="1139.5" as="sourcePoint" />
            <mxPoint x="1250.75" y="1139.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-31" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-30" vertex="1" connectable="0">
          <mxGeometry x="-0.0244" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-32" target="b_DPwCItqDpnZili3_qI-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-10" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-48" vertex="1" connectable="0">
          <mxGeometry x="-0.2521" y="-1" relative="1" as="geometry">
            <mxPoint x="5" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-32" value="inventoryServiceBean&lt;br&gt;.&lt;b&gt;decrease&lt;/b&gt;(inventoryDTO)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1110" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-33" value="AccountServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1520.75" y="860" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-34" target="b_DPwCItqDpnZili3_qI-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-34" target="b_DPwCItqDpnZili3_qI-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-34" value="&lt;div&gt;@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;&lt;b&gt;confirm&lt;/b&gt;&quot;, cancelMethod = &quot;&lt;b&gt;cancel&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;public boolean payment(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return accountMapper.&lt;b&gt;update&lt;/b&gt;(accountDTO) &amp;gt; 0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;扣减账户余额, balance 扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1719.75" y="880" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-36" value="@Transactional(rollbackFor = Exception.class) &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;div&gt;&lt;div&gt;public boolean &lt;b&gt;confirm&lt;/b&gt;(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; accountMapper.&lt;b&gt;confirm&lt;/b&gt;(accountDTO);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; return Boolean.TRUE;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;确认付款，将freeze_amount（用于回滚）也进行扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="2199.75" y="880" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-39" value="&lt;div&gt;@Transactional(rollbackFor = Exception.class)&lt;/div&gt;&lt;div&gt;public boolean &lt;b&gt;cancel&lt;/b&gt;(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final AccountDO accountDO = accountMapper.&lt;b&gt;findByUserId&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;accountDTO.getUserId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; accountMapper.&lt;b&gt;cancel&lt;/b&gt;(accountDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return Boolean.TRUE;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;取消付款，将 balance 加回去，freeze_amount 减掉&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2199.75" y="980" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-42" value="&lt;font color=&quot;#007fff&quot;&gt;这一步其实是控制的&lt;b&gt;修改订单&lt;/b&gt;操作，&lt;br&gt;后面扣款、扣库存其实管不到&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="520" y="865" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-43" value="&lt;div style=&quot;&quot;&gt;public void &lt;b&gt;confirmOrderStatus&lt;/b&gt;(Order order) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; updateOrderStatus(order, OrderStatusEnum.&lt;b&gt;PAY_SUCCESS&lt;/b&gt;);&lt;/div&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Confirm阶段，确认订单支付成功&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="759.75" y="640" width="440.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-44" value="&lt;div&gt;public void &lt;b&gt;cancelOrderStatus&lt;/b&gt;(Order order) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; updateOrderStatus(order, OrderStatusEnum.&lt;b&gt;PAY_FAIL&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;Cancel阶段，取消订单支付成功（支付失败）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="720" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-52" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-47" target="b_DPwCItqDpnZili3_qI-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-47" target="b_DPwCItqDpnZili3_qI-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-47" value="&lt;div&gt;@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;&lt;b&gt;confirmMethod&lt;/b&gt;&quot;, cancelMethod = &quot;&lt;b&gt;cancelMethod&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; public boolean decrease(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return inventoryMapper.&lt;b&gt;decrease&lt;/b&gt;(inventoryDTO) &amp;gt; 0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;扣减库存， total_inventory 扣减&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="1719.75" y="1100" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-49" value="InventoryServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="1515.75" y="1080" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-50" value="&lt;div&gt;public Boolean &lt;b&gt;confirmMethod&lt;/b&gt;(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; inventoryMapper.confirm(inventoryDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;确认扣减库存， 将 lock_inventory （用于回滚） 也进行扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="2199.75" y="1100" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-51" value="&lt;div&gt;&lt;div&gt;public Boolean &lt;b&gt;cancelMethod&lt;/b&gt;(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; inventoryMapper.cancel(inventoryDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;取消扣减库存，将 total_inventory 加回去，lock_inventory 减掉&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2199.75" y="1200" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-54" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;insert into `order` (create_time,number,status,product_id,total_amount,count,user_id)&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&quot; values ( #{createTime},#{number},#{status},#{productId},#{totalAmount},#{count},#{userId})&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="970" y="570" width="510" height="40" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-55" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1210" y="655" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-56" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="960" y="815" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-57" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1210" y="735" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-87" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-58" target="b_DPwCItqDpnZili3_qI-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-58" value="Hmily事务管理器协调" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-59" target="b_DPwCItqDpnZili3_qI-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-72" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-59" target="b_DPwCItqDpnZili3_qI-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-59" value="&lt;b&gt;hmily-spring-boot-starter-grpc&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是引入的核心组件&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-61" target="b_DPwCItqDpnZili3_qI-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-61" value="继承：&lt;br&gt;&lt;b&gt;hmily-spring-boot-starter&lt;br&gt;&lt;/b&gt;依赖：&lt;br&gt;&lt;b&gt;hmily-spring-boot-starter-parent&lt;br&gt;&lt;/b&gt;hmily-grpc" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="150" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-69" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-64" target="b_DPwCItqDpnZili3_qI-68" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-64" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span&gt;GrpcHmilyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;font color=&quot;#007fff&quot;&gt;自动配置类，仅仅创建一个Bean&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-68" value="&lt;b&gt;@Bean&amp;nbsp;GrpcHmilyClient&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Grpc客户端&lt;/font&gt;&lt;/b&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; background-color: rgb(43, 43, 43); color: rgb(169, 183, 198);&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-70" value="HmilyAutoConfiguration&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;hmily-spring-boot-starter-parent&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;中的自动配置类&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-85" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-73" target="b_DPwCItqDpnZili3_qI-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-73" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean &lt;br&gt;SpringHmilyTransactionAspect&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-75" target="b_DPwCItqDpnZili3_qI-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-75" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;b&gt;RefererAnnotationBeanPostProcessor&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;这是一个BeanPostProcessor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-96" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-78" target="b_DPwCItqDpnZili3_qI-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-78" target="Jgbx7IJgLmi5tVRdjDKV-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-78" target="Jgbx7IJgLmi5tVRdjDKV-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-78" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;b&gt;HmilyApplicationContextAware&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;实现 ApplicationContextAware, BeanFactoryPostProcessor&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="999.75" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="1" source="b_DPwCItqDpnZili3_qI-81" target="b_DPwCItqDpnZili3_qI-107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-81" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;AbstractHmilyTransactionAspect (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;Hmily切面抽象类，&lt;/b&gt;实现了Hmily切面注解（@HmilyTCC、@HmilyTAC）拦截的全部逻辑&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;切点&lt;/b&gt;为 @HmilyTCC 或 @HmilyTAC 注解的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//切面拦截器，拦截逻辑都在这里面定义&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyTransactionInterceptor&lt;/b&gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;interceptor&lt;/b&gt; = new HmilyGlobalInterceptor();&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//只定义了一个环绕通知,内部调用 inteceptor.invoke() 执行切面拦截逻辑&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;@Around(&quot;hmilyInterceptor()&quot;)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public Object &lt;b style=&quot;font-size: 11px;&quot;&gt;interceptTccMethod&lt;/b&gt;(final ProceedingJoinPoint proceedingJoinPoint) throws Throwable&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="160" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="b_DPwCItqDpnZili3_qI-82" target="b_DPwCItqDpnZili3_qI-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-82" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;SpringHmilyTransactionAspect&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;只是额外实现了Ordered接口，并定义了Bean实例化的最高优先级&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-480" y="400" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-84" value="&lt;b&gt;HmilyGlobalInterceptor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个类的逻辑后面讲事务协调时细说&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1240.25" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-86" target="b_DPwCItqDpnZili3_qI-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-86" value="&lt;b&gt;HmilyGlobalInterceptor#invoke&lt;/b&gt;(&lt;br&gt;final ProceedingJoinPoint pjp)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-92" value="&lt;b&gt;SingletonHolder.INST&lt;/b&gt;&lt;br&gt;&lt;b&gt;.register(field.getType(), ref);&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;后面用到再细看&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-95" value="&lt;div style=&quot;&quot;&gt;SpringBeanUtils.INSTANCE.setCfgContext(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;(ConfigurableApplicationContext) applicationContext);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-100" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-97" target="b_DPwCItqDpnZili3_qI-99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-103" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-100" vertex="1" connectable="0">
          <mxGeometry x="0.5603" y="-1" relative="1" as="geometry">
            <mxPoint x="1" y="-11" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-148" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-97" target="b_DPwCItqDpnZili3_qI-147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-97" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyTransactionContext context = parameterLoader.load();&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="520" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-106" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-99" target="b_DPwCItqDpnZili3_qI-105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-99" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;MethodSignature signature = (MethodSignature) point.getSignature();&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="519.75" y="2039.9999999999998" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-104" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;代码很容易理解，这里就省略一些不重要的细节&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="280" y="2020" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-113" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-105" target="b_DPwCItqDpnZili3_qI-112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-105" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;return &lt;/span&gt;getRegistry&lt;span style=&quot;font-weight: normal;&quot;&gt;(signature.getMethod())&lt;br&gt;.&lt;/span&gt;select&lt;span style=&quot;font-weight: normal;&quot;&gt;(context)&lt;br&gt;.&lt;/span&gt;handleTransaction(point, context);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;根据事务模式选择对应的 HmilyTransactionHandlerRegistry，再根据上下文选择对应事务处理器，最后处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="519.75" y="2120" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-107" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyGlobalInterceptor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;只是额外实现了Ordered接口，并定义了Bean实例化的最高优先级&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//参数加载器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static RpcParameterLoader &lt;b&gt;parameterLoader&lt;/b&gt;&amp;nbsp;= (RpcParameterLoader)Optional.ofNullable(&lt;br&gt;&amp;nbsp; &amp;nbsp; ExtensionLoaderFactory.load(&lt;b&gt;RpcParameterLoader&lt;/b&gt;.class)).orElse(new LocalParameterLoader());&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//Hmily支持 TCC TAC XA三种模式，每种模式对应一种分布式事务管理器实现（HmilyTransactionHandlerRegistry）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final EnumMap&amp;lt;TransTypeEnum, &lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyTransactionHandlerRegistry&lt;/b&gt;&amp;gt; &lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;REGISTRY&lt;/b&gt; = new EnumMap&amp;lt;&amp;gt;(TransTypeEnum.class);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public Object invoke(final ProceedingJoinPoint pjp) throws Throwable&amp;nbsp;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="160" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-112" target="b_DPwCItqDpnZili3_qI-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-116" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;TransTypeEnum&lt;br&gt;.TCC&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="b_DPwCItqDpnZili3_qI-115" vertex="1" connectable="0">
          <mxGeometry x="-0.0774" y="-3" relative="1" as="geometry">
            <mxPoint x="5" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-112" value="&lt;span style=&quot;font-weight: 400;&quot;&gt;工作模式&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;代理模式&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="2130" width="120.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-151" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-114" target="b_DPwCItqDpnZili3_qI-150" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-114" value="HmilyTccTransactionHandlerRegistry#&lt;br&gt;select(context)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="999.74" y="2130" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-117" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionHandlerRegistry (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务注册器接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取Hmily事务处理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;HmilyTransactionHandler select(HmilyTransactionContext context);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="160" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-120" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-118" target="b_DPwCItqDpnZili3_qI-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-122" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="b_DPwCItqDpnZili3_qI-118" target="b_DPwCItqDpnZili3_qI-121" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1020" y="380" />
              <mxPoint x="-1020" y="940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-118" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractHmilyTransactionHandlerRegistry (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定义了6种角色&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TCC用到4种角色，每种角色对应一种事务处理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;&lt;b&gt;HmilyRoleEnum&lt;/b&gt;, &lt;b&gt;HmilyTransactionHandler&lt;/b&gt;&amp;gt; &lt;b&gt;handlers&lt;/b&gt; = new EnumMap&amp;lt;&amp;gt;(HmilyRoleEnum.class);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="320" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-123" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="b_DPwCItqDpnZili3_qI-119" target="b_DPwCItqDpnZili3_qI-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-119" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTccTransactionHandlerRegistry&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;TCC模式的分布式事务注册器实现，通过&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;@HmilySPI(&quot;tcc&quot;) 加载&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-121" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionHandler&amp;nbsp;&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务处理器接口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Object &lt;b&gt;handleTransaction&lt;/b&gt;(ProceedingJoinPoint point, HmilyTransactionContext hmilyTransactionContext) throws Throwable;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="880" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-133" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-128" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420" y="2440" />
              <mxPoint x="420" y="2730" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-134" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-129" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420" y="2440" />
              <mxPoint x="420" y="2830" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-135" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-131" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420" y="2440" />
              <mxPoint x="420" y="2930" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-124" value="上下文角色" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="279.75" y="2410" width="120.01" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-154" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="b_DPwCItqDpnZili3_qI-126" target="b_DPwCItqDpnZili3_qI-153" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-126" value="StarterHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;br&gt;&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;事务发起者发起事务&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="519.5" y="2280" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-128" target="_u3hFmiMN6U5vcW2F68K-15" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="740" y="2730" />
              <mxPoint x="740" y="3070" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-128" value="ParticipantHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/span&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="2700" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-129" value="ConsumeHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;方法实现是空的&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="519.9999999999998" y="2800" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-131" value="LocalHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;方法实现是空的&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520.2599999999995" y="2900" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-127" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-126" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="419.76" y="2440" />
              <mxPoint x="419.76" y="2310" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-140" value="HmilyRoleEnum&lt;br&gt;.START" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="b_DPwCItqDpnZili3_qI-127" vertex="1" connectable="0">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-138" value="HmilyRoleEnum&lt;br&gt;.CONSUMER" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="b_DPwCItqDpnZili3_qI-127" vertex="1" connectable="0">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="518" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-139" value="HmilyRoleEnum&lt;br&gt;.LOCAL" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="b_DPwCItqDpnZili3_qI-127" vertex="1" connectable="0">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="618" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-137" value="HmilyRoleEnum&lt;br&gt;.PARTICIPANT" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" parent="b_DPwCItqDpnZili3_qI-127" vertex="1" connectable="0">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="418" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-144" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;RpcParameterLoader&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RPC参数加载器接口，这里的参数是 HmilyTransactionContext&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取Hmily事务处理器（从源码可以看到是从&lt;b&gt;线程本地&lt;/b&gt;获取 HmilyTransactionContext）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;HmilyTransactionContext load();&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="640" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-146" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-145" target="b_DPwCItqDpnZili3_qI-144" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-145" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;GrpcParameterLoader&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Grpc 参数加载器，&lt;/b&gt;通过&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;@HmilySPI(&quot;grpc&quot;) 加载, 获取 HmilyTranactionContext时，先尝试从 GrpcHmilyContext 获取再尝试从 HmilyTransationHolder 获取&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="760" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-147" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return (HmilyTransactionContext)Optional.ofNullable(&lt;/span&gt;RpcMediator&lt;span style=&quot;font-weight: normal;&quot;&gt;.getInstance().acquire((key) -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //key:&amp;nbsp; _HMILY_TRANSACTION_CONTEXT, HmilyContext 是 ThreadLocal&amp;lt;String&amp;gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这一句是获取 ThreadLocal&amp;lt;String&amp;gt; 中的字符串&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return (String)&lt;/span&gt;GrpcHmilyContext&lt;span style=&quot;font-weight: normal;&quot;&gt;.getHmilyContext().get();&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;})).orElse(HmilyContextHolder.get());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-weight: normal;&quot; color=&quot;#007fff&quot;&gt;RpcMediator 获取线程本地的字符串后如果字符串不为空则反序列化为 HmilyTransactionContext 并返回，如果字符串为空则从 HmilyContextHolder 获取&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fontStyle=1;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="760" y="1950" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-149" value="GrpcParameterLoader" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="909.75" y="1920" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-152" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-150" target="b_DPwCItqDpnZili3_qI-124" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1620" y="2160" />
              <mxPoint x="1620" y="2240" />
              <mxPoint x="260" y="2240" />
              <mxPoint x="260" y="2440" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-150" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;if (Objects.&lt;/span&gt;isNull&lt;span style=&quot;font-weight: normal;&quot;&gt;(context)) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return getHandler(HmilyRoleEnum.&lt;/span&gt;START&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;} else {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; if (context.getRole() == HmilyRoleEnum.LOCAL.getCode()) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return getHandler(HmilyRoleEnum.&lt;/span&gt;LOCAL&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; } else if (context.getRole() == HmilyRoleEnum.PARTICIPANT.getCode()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; || context.getRole() == HmilyRoleEnum.START.getCode()) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return getHandler(HmilyRoleEnum.&lt;/span&gt;PARTICIPANT&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return getHandler(HmilyRoleEnum.&lt;/span&gt;CONSUMER&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=5;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1239.74" y="2090" width="360.26" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-153" target="Jgbx7IJgLmi5tVRdjDKV-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-16" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Jgbx7IJgLmi5tVRdjDKV-11" vertex="1" connectable="0">
          <mxGeometry x="0.8729" y="-3" relative="1" as="geometry">
            <mxPoint x="-2" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-153" target="YnnrP53jlHVHSCE78MQg-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-4" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="YnnrP53jlHVHSCE78MQg-3" vertex="1" connectable="0">
          <mxGeometry x="0.2242" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-62" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-153" target="_u3hFmiMN6U5vcW2F68K-60" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-65" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-62" vertex="1" connectable="0">
          <mxGeometry x="0.7888" y="-2" relative="1" as="geometry">
            <mxPoint x="-3" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="b_DPwCItqDpnZili3_qI-153" target="_u3hFmiMN6U5vcW2F68K-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-77" value="4|5" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-76" vertex="1" connectable="0">
          <mxGeometry x="0.8789" y="-1" relative="1" as="geometry">
            <mxPoint x="-7" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-153" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;Object returnValue;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//1 事务发起者Try阶段处理（核心就是创建事务实例并持久化）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyTransaction hmilyTransaction = this.&lt;/span&gt;executor&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;preTry&lt;span style=&quot;font-weight: normal;&quot;&gt;(point);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;    &lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&amp;nbsp;继续执行业务代码，内部“递归”调用各个参与者 TRY 阶段（TRYING状态&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;）处理&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; returnValue = &lt;/span&gt;point&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;proceed&lt;span style=&quot;font-weight: normal;&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hmilyTransaction.&lt;/span&gt;setStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyActionEnum.&lt;/span&gt;TRYING&lt;span style=&quot;font-weight: normal;&quot;&gt;.getCode()); &lt;/span&gt;&lt;font color=&quot;#cc0000&quot;&gt;//TRYING 状态&lt;/font&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp;//3&amp;nbsp;&lt;span style=&quot;font-weight: normal;&quot;&gt;通过 HmilyRepositoryEventPublish&lt;/span&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;er 发布 &lt;/span&gt;UPDATE_HMILY_PARTICIPANT_STATUS&lt;span style=&quot;font-weight: normal;&quot;&gt;、&lt;/span&gt;&lt;span style=&quot;font-weight: normal; white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;font style=&quot;font-weight: normal; font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;UPDATE_HMILY_PARTICIPANT_STATUS&lt;/font&gt;&lt;font style=&quot;font-weight: normal; font-size: 9px;&quot; color=&quot;#007fff&quot;&gt; 事件（分别更新事务和发起者的状态）&lt;/font&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;this.&lt;/span&gt;executor&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;updateStartStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable var11) { &lt;font color=&quot;#007fff&quot;&gt;//业务抛出异常&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .getCurrentTransaction();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;font style=&quot;background-color: initial; border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;//4 取消，内部“递归”调用各个参与者 CANCEL 阶段（CANCELING状态）处理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.disruptor.getProvider().&lt;/span&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;(() -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executor.globalCancel(currentTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw var11;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: 400;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //5 确认提交，内部“递归”调用各个参与者 CONFIRM 阶段（CONFIRMING状态）处理&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getCurrentTransaction();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; this.disruptor.getProvider().&lt;/span&gt;onData&lt;span style=&quot;font-weight: normal;&quot;&gt;(() -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executor.&lt;/span&gt;globalConfirm&lt;span style=&quot;font-weight: normal;&quot;&gt;(currentTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;} finally {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyContextHolder.remove();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; this.executor.remove();&lt;font color=&quot;#007fff&quot;&gt; //线程因为是复用的，退出先需要先remove() 防止内存泄漏，因为已经持久化了，这里也就没有存在的必要了&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return returnValue;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="759.75" y="2280" width="440" height="400" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-158" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-156" target="b_DPwCItqDpnZili3_qI-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.003;exitY=0.283;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="1" source="b_DPwCItqDpnZili3_qI-156" target="Jgbx7IJgLmi5tVRdjDKV-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-540" y="1131" />
              <mxPoint x="-540" y="1580" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-156" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;StarterHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务启动处理器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//里面定义了&lt;b&gt;基于TCC协议的事务处理器流程方法&lt;/b&gt;（虽然名字带着Executor但并没有线程池）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HmilyTccTransactionExecutor&lt;/b&gt; &lt;b&gt;executor&lt;/b&gt; = HmilyTccTransactionExecutor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getInstance();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private HmilyDisruptor&amp;lt;HmilyTransactionTask&amp;gt; &lt;b&gt;disruptor&lt;/b&gt;;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyTransaction &lt;b&gt;preTry&lt;/b&gt;(ProceedingJoinPoint point)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyParticipant &lt;b&gt;preTryParticipant&lt;/b&gt;(HmilyTransactionContext context, ProceedingJoinPoint point)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalConfirm&lt;/b&gt;(HmilyTransaction currentTransaction) throws HmilyRuntimeException&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantConfirm&lt;/b&gt;(List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipantList, Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalCancel&lt;/b&gt;(HmilyTransaction currentTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantCancel&lt;/b&gt;(List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipants, Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;updateStartStatus&lt;/b&gt;(HmilyTransaction hmilyTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void remove()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1040" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-162" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-159" target="b_DPwCItqDpnZili3_qI-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-159" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ParticipantHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务参与者处理器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HmilyTccTransactionExecutor&lt;/b&gt; &lt;b&gt;executor&lt;/b&gt; = HmilyTccTransactionExecutor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getInstance();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-163" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-160" target="b_DPwCItqDpnZili3_qI-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-160" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;分布式事务消费者处理器，&lt;/b&gt;看源码只是调用切点 proceed() 方法，继续执行业务方法&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-164" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="b_DPwCItqDpnZili3_qI-161" target="b_DPwCItqDpnZili3_qI-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-161" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;LocalHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;分布式事务本地处理器，&lt;/b&gt;看源码只是调用切点 proceed() 和 ConsumeHmilyTccTransactionHandler 一样&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1960" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-1" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;SingletonHolder.INST.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;register&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;ObjectProvide.class, new SpringBeanProvide());&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fOvBRnHRea66At2AQrMF-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-2" target="fOvBRnHRea66At2AQrMF-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-2" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;HmilyBootstrap.getInstance().&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;start&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;后面用到再细看&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-5" value="&lt;font color=&quot;#007fff&quot;&gt;Registry 怎么加载的？在哪里注册的事务处理器&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="240" y="2145" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-6" value="&lt;font color=&quot;#007fff&quot;&gt;上下文角色哪里分配的？怎么分配的&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="2420" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-9" target="Jgbx7IJgLmi5tVRdjDKV-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-9" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyTransaction hmilyTransaction = this.executor.&lt;/span&gt;preTry&lt;span style=&quot;font-weight: normal;&quot;&gt;(point);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1239.99" y="2280" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-10" value="HmilyTccTransactionExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1610" y="2760" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontColor=#007FFF;dashed=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-12" target="Jgbx7IJgLmi5tVRdjDKV-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-20" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Jgbx7IJgLmi5tVRdjDKV-19" vertex="1" connectable="0">
          <mxGeometry x="0.7943" y="1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-28" value="订阅&lt;br&gt;回调" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#007FFF;" parent="Jgbx7IJgLmi5tVRdjDKV-19" vertex="1" connectable="0">
          <mxGeometry x="0.0023" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-12" value="&lt;div&gt;&lt;span style=&quot;background-color: initial; font-weight: normal;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//创建Hmily事务对象（事务ID、事务类型、事务状态）&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;HmilyTransaction hmilyTransaction = &lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;createHmilyTransaction&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;(); &lt;/span&gt;&lt;font style=&quot;&quot; color=&quot;#cc0000&quot;&gt;//PRE_TRY状态&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//1 通过 HmilyRepositoryEventPublisher 发布 CREATE_HMILY_TRANSACTION 事件&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage.&lt;/span&gt;createHmilyTransaction&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//创建事务参与者并注册到事务参与者列表&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyParticipant hmilyParticipant = &lt;/span&gt;buildHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(point, null, null, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;HmilyRoleEnum.START.getCode(), hmilyTransaction.getTransId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage.createHmilyParticipant(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;hmilyTransaction.&lt;/span&gt;registerParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;//保存Hmily事务对象到ThreadLocal&amp;lt;HmilyTransaction&amp;gt;&lt;/font&gt;&lt;div&gt;HmilyTransactionHolder&lt;span style=&quot;font-weight: normal;&quot;&gt;.getInstance().&lt;/span&gt;set&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;//创建 Hmily 事务上下文保存在HmilyContextHolder 中的 HmilyContext&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyTransactionContext context = new &lt;/span&gt;HmilyTransactionContext&lt;span style=&quot;font-weight: normal;&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;context.setAction(HmilyActionEnum.TRYING.getCode());&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;context.setTransId(hmilyTransaction.getTransId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;context.setRole(HmilyRoleEnum.START.getCode());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;context.setTransType(TransTypeEnum.TCC.name());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;HmilyContextHolder&lt;span style=&quot;font-weight: normal;&quot;&gt;.set(context);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return hmilyTransaction;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2280" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTccTransactionExecutor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;分布式事务处理执行器，&lt;/b&gt;单例模式，内部定义 Tcc 事务各种角色各阶段（Try-Confirm-Cancel）的流程方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务发起者Try阶段（预留）执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyTransaction &lt;b&gt;preTry&lt;/b&gt;(final ProceedingJoinPoint point)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者Try阶段执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyParticipant &lt;b&gt;preTryParticipant&lt;/b&gt;(final HmilyTransactionContext context, final ProceedingJoinPoint point)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务发起者Confirm阶段（确认）执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalConfirm&lt;/b&gt;(final HmilyTransaction currentTransaction) throws HmilyRuntimeException&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者participantConfirm阶段执行&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantConfirm&lt;/b&gt;(final List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipantList, final Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务发起者Cancel阶段（撤销）执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalCancel&lt;/b&gt;(final HmilyTransaction currentTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者Cancel阶段执行&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantCancel&lt;/b&gt;(final List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipants, final Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;updateStartStatus&lt;/b&gt;(final HmilyTransaction hmilyTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void remove()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1400" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-18" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-17" target="_u3hFmiMN6U5vcW2F68K-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-17" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTransaction&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务定义&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;事务ID&lt;/b&gt;，看上去是雪花算法实现的UUID&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Long &lt;b&gt;transId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务发起者应用名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;appName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;事务的状态&lt;/b&gt;，有6种状态：PRE_TRY TRYING CONFIRMING CANCELING DELETE DEATH&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;status&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务类型：TCC TAC XA 等&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;transType&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//重试次数，默认0，事务异常不重试&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer &lt;b&gt;retry&lt;/b&gt; = 0;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//版本号用于mysql优化锁控制？&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer &lt;b&gt;version&lt;/b&gt; = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务创建时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Date &lt;b&gt;createTime&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务更新时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Date &lt;b&gt;updateTime&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者集合，包括发起者（START）和参与者（PARTICIPANT）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private List&amp;lt;HmilyParticipant&amp;gt; &lt;b&gt;hmilyParticipants&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="1400" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-18" target="Jgbx7IJgLmi5tVRdjDKV-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-18" value="HmilyRepositoryEventConsumer#&lt;br&gt;execute&lt;span style=&quot;font-weight: normal;&quot;&gt;(final HmilyRepositoryEvent event)&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过 Disruptor 实现的事件发布订阅&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1960" y="2460" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-21" target="Jgbx7IJgLmi5tVRdjDKV-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-21" value="HmilyRepositoryEventDispatcher&lt;br&gt;.getInstance().doDispatch(event);" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2199.7400000000002" y="2460" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-23" target="Jgbx7IJgLmi5tVRdjDKV-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2560" y="2490" />
              <mxPoint x="2560" y="2310" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-27" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;CREATE_HMILY_TRANSACTION&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Jgbx7IJgLmi5tVRdjDKV-26" vertex="1" connectable="0">
          <mxGeometry x="-0.087" y="-2" relative="1" as="geometry">
            <mxPoint x="78" y="-47" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-23" target="_u3hFmiMN6U5vcW2F68K-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2560" y="2490" />
              <mxPoint x="2560" y="2390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-29" value="CREATE_HMILY_PARTICIPANT" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;" parent="_u3hFmiMN6U5vcW2F68K-28" vertex="1" connectable="0">
          <mxGeometry x="0.4249" y="-3" relative="1" as="geometry">
            <mxPoint x="6" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-23" target="_u3hFmiMN6U5vcW2F68K-43" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2560" y="2490" />
              <mxPoint x="2560" y="2470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-48" value="&lt;font style=&quot;font-size: 8px;&quot;&gt;UPDATE_HMILY_PARTICIPANT_STATUS&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-47" vertex="1" connectable="0">
          <mxGeometry x="0.2711" y="-3" relative="1" as="geometry">
            <mxPoint x="-10" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-23" target="_u3hFmiMN6U5vcW2F68K-54" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2560" y="2490" />
              <mxPoint x="2560" y="2550" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-59" value="UPDATE_HMILY_TRANSACTION_STATUS" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=8;" parent="_u3hFmiMN6U5vcW2F68K-58" vertex="1" connectable="0">
          <mxGeometry x="0.2932" y="-1" relative="1" as="geometry">
            <mxPoint x="2" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-73" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-23" target="_u3hFmiMN6U5vcW2F68K-69" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2560" y="2490" />
              <mxPoint x="2560" y="2630" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-23" value="事件类型" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2440" y="2460" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lziyc9L5DbaSJwhcojb9-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Jgbx7IJgLmi5tVRdjDKV-25" target="Lziyc9L5DbaSJwhcojb9-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jgbx7IJgLmi5tVRdjDKV-25" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryFacade.getInstance()&lt;br&gt;.&lt;/span&gt;createHmilyTransaction&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;event.getHmilyTransaction());&lt;/span&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepository 有多种实现，这里以&lt;/span&gt;MySQLRepository&lt;span style=&quot;font-weight: normal;&quot;&gt;为例&lt;/span&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2720" y="2280" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="fOvBRnHRea66At2AQrMF-1" target="Jgbx7IJgLmi5tVRdjDKV-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2170" y="545" />
              <mxPoint x="2170" y="2260" />
              <mxPoint x="1700" y="2260" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="fOvBRnHRea66At2AQrMF-1" target="ILePiL2lHhwXlFeLtQY4-26">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="510" />
              <mxPoint x="1940" y="280" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="fOvBRnHRea66At2AQrMF-1" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;ConfigLoaderServer.load();&lt;/div&gt;&lt;div&gt;HmilyConfig hmilyConfig = ConfigEnv.getInstance().getConfig(HmilyConfig.class);&lt;/div&gt;&lt;div&gt;check(hmilyConfig);&lt;/div&gt;&lt;div&gt;registerProvide();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//初始化一些hmily的数据表等等（Hmily支持多种事务存储方式）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;loadHmilyRepository(hmilyConfig);&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//启动一些自恢复线程池、基于Disruptor的&lt;b&gt;事件发布器（这是生产者，消费者是注册&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;HmilyTransactionHandlerRegistry时启动的&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;）&lt;/b&gt;&lt;/div&gt;&lt;div&gt;registerAutoCloseable(new &lt;b&gt;HmilyTransactionSelfRecoveryScheduled&lt;/b&gt;(), &lt;br&gt;&amp;nbsp; &amp;nbsp; HmilyRepositoryEventPublisher.getInstance());&lt;/div&gt;&lt;div&gt;initMetrics();&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="1480" y="440" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="fOvBRnHRea66At2AQrMF-3" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;HmilyRepositoryEventPublisher&amp;nbsp;&lt;br&gt;HmilyRepositoryEventConsumer&lt;br&gt;是一组单例模式对象&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1960" y="2520" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lziyc9L5DbaSJwhcojb9-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="Lziyc9L5DbaSJwhcojb9-1" target="Lziyc9L5DbaSJwhcojb9-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Lziyc9L5DbaSJwhcojb9-1" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;checkRows(hmilyRepository&lt;br&gt;.&lt;/span&gt;createHmilyTransaction&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyTransaction));&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2960" y="2280" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Lziyc9L5DbaSJwhcojb9-3" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyRepositoryFacade&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务持久化门面，支持多种持久化存储&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final HmilyRepositoryFacade INSTANCE = new HmilyRepositoryFacade();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HmilyConfig hmilyConfig = &lt;br&gt;&amp;nbsp; &amp;nbsp; ConfigEnv.getInstance().getConfig(HmilyConfig.class);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//Hmily事务的状态等数据需要持久化存储，这个是持久化接口实例，提供有多种实现，比如MySQL、Redis、ETCD、MongoDB、ZK&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyRepository &lt;b&gt;hmilyRepository&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1800" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Lziyc9L5DbaSJwhcojb9-5" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;INSERT INTO &lt;/span&gt;hmily_transaction_global&lt;span style=&quot;font-weight: normal;&quot;&gt; (trans_id, app_name, status, trans_type,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;retry, version, create_time, update_time) VALUES(?, ?, ?, ?, ?, ?, ?, ?)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="3200" y="2280" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-2" value="returnValue = point.proceed();" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="2450" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="YnnrP53jlHVHSCE78MQg-6" target="YnnrP53jlHVHSCE78MQg-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="YnnrP53jlHVHSCE78MQg-6" target="YnnrP53jlHVHSCE78MQg-11" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1450" y="1470" />
              <mxPoint x="1450" y="1470" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-6" value="GrpcHmilyTransactionFilter&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Grpc&lt;b&gt;客户端&lt;/b&gt;拦截器，实现ClientInterceptor接口，发起RPC调用前执行&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1239.74" y="1440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="YnnrP53jlHVHSCE78MQg-7" target="YnnrP53jlHVHSCE78MQg-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-7" value="Grpc Socket 通道" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;gradientColor=#97d077;" parent="1" vertex="1">
          <mxGeometry x="1239.74" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-11" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;public &amp;lt;R, P&amp;gt; ClientCall&amp;lt;R, P&amp;gt; interceptCall(MethodDescriptor&amp;lt;R, P&amp;gt; methodDescriptor, CallOptions callOptions, Channel channel) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; final HmilyTransactionContext &lt;b&gt;context&lt;/b&gt; = HmilyContextHolder.get();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!Objects.isNull(context) &amp;amp;&amp;amp; !Objects.isNull(GrpcHmilyContext.getHmilyClass().get())) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String[] clazzNameAndMethod = methodDescriptor.getFullMethodName().split(&quot;/&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //通过反射从 clazzNameAndMethod 中解析要调用的类 clazz（Stub类）和方法 method&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (method != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Long participantId = context.getParticipantId();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //创建事务参与者实例，这个不是完整的实例，主要是里面的参与者ID，用于查找持久化后参与者完整的信息&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final HmilyParticipant hmilyParticipant = this.&lt;b&gt;buildParticipant&lt;/b&gt;(context);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Optional.ofNullable(hmilyParticipant).ifPresent((participant) -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context.&lt;b&gt;setParticipantId&lt;/b&gt;(participant.getParticipantId());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (context.getRole() == HmilyRoleEnum.PARTICIPANT.getCode()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; context.setParticipantRefId(participantId);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //调用，TODO&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;return&lt;/b&gt; new ForwardingClientCall.SimpleForwardingClientCall&amp;lt;R, P&amp;gt;(channel.newCall(methodDescriptor, callOptions)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void start(ClientCall.Listener&amp;lt;P&amp;gt; responseListener, Metadata headers) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RpcMediator.getInstance().transmit((key, value) -&amp;gt; {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//这里用于&lt;b&gt;将&amp;nbsp;HmilyTransactionContext 序列化为字符串&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;headers&lt;/b&gt;.put(GrpcHmilyContext.&lt;b&gt;HMILY_META_DATA&lt;/b&gt;, value); &lt;font color=&quot;#007fff&quot;&gt;//事务上下文序列化后存入了&lt;b&gt;请求头&lt;/b&gt;进行传输&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }, &lt;b&gt;context&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//注册回调并发起调用&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.&lt;b&gt;start&lt;/b&gt;(new ForwardingClientCallListener.SimpleForwardingClientCallListener&amp;lt;P&amp;gt;(responseListener) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void &lt;b&gt;onClose&lt;/b&gt;(Status status, Metadata trailers) { &lt;font color=&quot;#007fff&quot;&gt;//TODO 响应回调？&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (status.getCode().value() == Code.OK.value()) { &lt;font color=&quot;#007fff&quot;&gt;//成功&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (context.getRole() == HmilyRoleEnum.PARTICIPANT.getCode()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyTransactionHolder.getInstance().&lt;b&gt;registerParticipantByNested&lt;/b&gt;(participantId, hmilyParticipant);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//保存一下这个半成品参与者实例到事务对象的参与者集合&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyTransactionHolder.getInstance().&lt;b style=&quot;font-size: 9px;&quot;&gt;registerStarterParticipant&lt;/b&gt;(hmilyParticipant);&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else { &lt;font color=&quot;#007fff&quot;&gt;//失败&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; GrpcHmilyContext.getHmilyFailContext().set(true);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; GrpcHmilyContext.removeAfterInvoke();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.onClose(status, trailers);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }, &lt;b&gt;headers&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; };&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Exception var13) {...}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return channel.newCall(methodDescriptor, callOptions);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return channel.newCall(methodDescriptor, callOptions);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;" parent="1" vertex="1">
          <mxGeometry x="1481.25" y="1200" width="560.01" height="540" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="YnnrP53jlHVHSCE78MQg-13" target="_u3hFmiMN6U5vcW2F68K-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YnnrP53jlHVHSCE78MQg-13" value="GrpcHmilyServerFilter&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Grpc&lt;b&gt;服务端&lt;/b&gt;拦截器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1239.74" y="1810" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="_u3hFmiMN6U5vcW2F68K-1" target="b_DPwCItqDpnZili3_qI-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="1840" />
              <mxPoint x="1940" y="1750" />
              <mxPoint x="1460" y="1750" />
              <mxPoint x="1460" y="935" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-1" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;public &amp;lt;R, P&amp;gt; ServerCall.Listener&amp;lt;R&amp;gt; interceptCall(ServerCall&amp;lt;R, P&amp;gt; serverCall, Metadata&amp;nbsp; &lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;metadata, ServerCallHandler&amp;lt;R, P&amp;gt; serverCallHandler) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这里保存的字符串格式，在HmilyGlobalInterceptor 由 GrpcParameterLoader 反序列化为事务上下文&lt;/font&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px; background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;GrpcHmilyContext&lt;/b&gt;.getHmilyContext().&lt;b&gt;set&lt;/b&gt;(metadata.get(GrpcHmilyContext.&lt;b&gt;HMILY_META_DATA&lt;/b&gt;));&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return serverCallHandler.&lt;b&gt;startCall&lt;/b&gt;(new ForwardingServerCall.SimpleForwardingServerCall&amp;lt;R, P&amp;gt;(serverCall) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void sendMessage(P message) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//响应&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; GrpcHmilyContext.getHmilyContext().remove();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; super.sendMessage(message);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }, &lt;b&gt;metadata&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1481.25" y="1760" width="440.01" height="160" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="_u3hFmiMN6U5vcW2F68K-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1701.363636363636" y="930" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="_u3hFmiMN6U5vcW2F68K-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1701.363636363636" y="1130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-7" value="&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;这中间同样先经过切面代理处理&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;HmilyGlobalInterceptor#invoke(final ProceedingJoinPoint pjp)&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1521.26" y="1000" width="360" height="30" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-11" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily 应用的 6 种角色&lt;/b&gt;：&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;START(1, &quot;发起者&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;CONSUMER(2, &quot;消费者&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;PARTICIPANT(3, &quot;参与者&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;LOCAL(4, &quot;本地调用&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;INLINE(5, &quot;内嵌RPC调用&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;SPRING_CLOUD(6, &quot;SpringCloud&quot;);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;TCC模式实际也就只用到 &lt;b&gt;START&lt;/b&gt;、&lt;b&gt;PARTICIPANT&lt;/b&gt; 两种角色；&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="400" width="400" height="140" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-12" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;这里的角色判定规则：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;事务上下文是由发起者创建的，事务上下文为null， 当前应用一定是发起者（START）；&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;事务上下文不为空，此事务上下文是传递过来，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;如果上下文中角色是 START（发起者调用当前服务）、PARTICIPANT（参与者调用当前服务，即多次嵌套），&lt;br&gt;当前应用一定是参与者（PARTICIPANT）；&lt;br&gt;LOCAL -&amp;gt; LOCAL&amp;nbsp; (LOCAL CONSUMER 貌似TCC也并没有用到，看对应的事务处理器实现都是空的)&lt;br&gt;CONSUMER -&amp;gt; CONSUMER&lt;br&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1620" y="2090" width="510" height="110" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="_u3hFmiMN6U5vcW2F68K-15" target="_u3hFmiMN6U5vcW2F68K-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-20" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-19" vertex="1" connectable="0">
          <mxGeometry x="0.8975" y="-3" relative="1" as="geometry">
            <mxPoint x="-7" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="_u3hFmiMN6U5vcW2F68K-15" target="_u3hFmiMN6U5vcW2F68K-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-36" value="3" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-35" vertex="1" connectable="0">
          <mxGeometry x="0.7756" y="-1" relative="1" as="geometry">
            <mxPoint x="-12" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-39" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="_u3hFmiMN6U5vcW2F68K-15" target="_u3hFmiMN6U5vcW2F68K-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-40" value="4" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="_u3hFmiMN6U5vcW2F68K-39" vertex="1" connectable="0">
          <mxGeometry x="0.2139" relative="1" as="geometry">
            <mxPoint x="5" y="27" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-15" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyParticipant hmilyParticipant = null;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;switch (HmilyActionEnum.acquireByCode(context.getAction())) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;/span&gt;TRYING&lt;span style=&quot;font-weight: normal;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //1 事务参与者Try阶段处理&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hmilyParticipant = executor.&lt;/span&gt;preTryParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(context, point);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //2 继续执行参与者业务代码&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final Object proceed = point.&lt;/span&gt;proceed&lt;span style=&quot;font-weight: normal;&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hmilyParticipant.&lt;/span&gt;setStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyActionEnum.&lt;/span&gt;TRYING&lt;span style=&quot;font-weight: normal;&quot;&gt;.getCode()); &lt;/span&gt;&lt;font color=&quot;#cc0000&quot;&gt;//TRYING状态&lt;/font&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//3 通过 HmilyRepositoryEventPublisher 发布UPDATE_HMILY_PARTICIPANT_STATUS&amp;nbsp;事件&lt;/font&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;HmilyRepositoryStorage.&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;updateHmilyParticipantStatus&lt;/span&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;(hmilyParticipant);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return proceed;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } catch (Throwable throwable) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //if exception ,delete log.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (Objects.nonNull(hmilyParticipant)) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyParticipantCacheManager.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.&lt;/span&gt;removeByKey&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant.getParticipantId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;//4 通过 HmilyRepositoryEventPublisher 发布 REMOVE_HMILY_PARTICIPANT&amp;nbsp;事件&lt;/font&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyRepositoryStorage.&lt;/span&gt;removeHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;throw throwable&lt;span style=&quot;font-weight: normal;&quot;&gt;; &lt;font color=&quot;#007fff&quot;&gt;//如果发生异常，先清理再继续抛异常&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } finally {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyContextHolder.remove();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;/span&gt;CONFIRMING&lt;span style=&quot;font-weight: normal;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetricsReporter.counterIncrement(LabelNames.TRANSACTION_STATUS, new String[]&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;{TransTypeEnum.TCC.name(), HmilyRoleEnum.PARTICIPANT.name(), &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;HmilyActionEnum.CONFIRMING.name()});&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HmilyParticipant&amp;gt; confirmList = HmilyParticipantCacheManager.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.get(context.getParticipantId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return executor.participantConfirm(confirmList, context.getParticipantId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; case &lt;/span&gt;CANCELING&lt;span style=&quot;font-weight: normal;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetricsReporter.counterIncrement(LabelNames.TRANSACTION_STATUS, new String[]&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;{TransTypeEnum.TCC.name(), HmilyRoleEnum.PARTICIPANT.name(),&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;HmilyActionEnum.CANCELING.name()});&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; List&amp;lt;HmilyParticipant&amp;gt; cancelList = HmilyParticipantCacheManager.getInstance()&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.get(context.getParticipantId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return executor.participantCancel(cancelList, context.getParticipantId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; default:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;Method method = ((MethodSignature) (point.getSignature())).getMethod();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return DefaultValueUtils.getDefaultValue(method.getReturnType());&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="2700" width="440" height="540" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-18" target="_u3hFmiMN6U5vcW2F68K-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-18" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;hmilyParticipant = executor.&lt;/span&gt;preTryParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(context, point);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1240.24" y="2830" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-21" target="Jgbx7IJgLmi5tVRdjDKV-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-21" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//创建Hmily参与者对象（内部包含事务的基本信息和当前参与者事务控制类和方法以及确认和撤销方法）&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#cc0000&quot; size=&quot;1&quot;&gt;//PRE_TRY状态&lt;/font&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;final HmilyParticipant hmilyParticipant = &lt;/span&gt;buildHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(point, context.getParticipantId(),&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; context.getParticipantRefId(), HmilyRoleEnum.PARTICIPANT.getCode(), context.getTransId());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//缓存 参与者ID -&amp;gt; 参与者对象 到 HmilyParticipantCacheManager&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyTransactionHolder.getInstance().&lt;/span&gt;cacheHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 通过 HmilyRepositoryEventPublisher 发布 CREATE_HMILY_PARTICIPANT&amp;nbsp;事件&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage.&lt;/span&gt;createHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;context.setRole(HmilyRoleEnum.PARTICIPANT.getCode());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;HmilyContextHolder&lt;span style=&quot;font-weight: normal;&quot;&gt;.set(context);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return hmilyParticipant;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2790" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.923;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="_u3hFmiMN6U5vcW2F68K-23" target="ILePiL2lHhwXlFeLtQY4-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-23" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyParticipant&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务参与者定义，发起者也使用此实例表示&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者应用ID&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private Long &lt;b&gt;participantId&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// ？？？&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Long participantRefId;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Long &lt;b&gt;transId&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务协议类型，比如TCC&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;transType&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer &lt;b&gt;status&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务参与者应用名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;appName&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;role&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int retry;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务控制的目标类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;targetClass&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事务控制的目标方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;targetMethod&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;confirmMethod&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String &lt;b&gt;cancelMethod&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer version = 1;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Date createTime;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Date updateTime;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于后面Confirm Cancel阶段 本地调用、RPC调用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyInvocation &lt;b&gt;confirmHmilyInvocation&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyInvocation &lt;b&gt;cancelHmilyInvocation&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1480" y="1400" width="440" height="400" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionHolder&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final HmilyTransactionHolder &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;INSTANCE&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new HmilyTransactionHolder();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private static final ThreadLocal&amp;lt;HmilyTransaction&amp;gt; &lt;b&gt;CURRENT&lt;/b&gt; = new ThreadLocal&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="560" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-25" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyParticipantCacheManager&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;本质是个Guava 本地缓存，存储 &lt;b&gt;参与者ID -&amp;gt; 参与者对象&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final HmilyParticipantCacheManager &lt;b&gt;INSTANCE&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; HmilyParticipantCacheManager();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final LoadingCache&amp;lt;Long, List&amp;lt;HmilyParticipant&amp;gt;&amp;gt; &lt;b&gt;LOADING_CACHE&lt;/b&gt; = ...;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-480" y="680" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-27" target="_u3hFmiMN6U5vcW2F68K-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-27" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryFacade.getInstance()&lt;br&gt;.&lt;/span&gt;createHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;event.getHmilyParticipant());&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2720" y="2360" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-30" target="_u3hFmiMN6U5vcW2F68K-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-30" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;checkRows(hmilyRepository&lt;br&gt;.&lt;/span&gt;createHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyParticipant));&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2960" y="2360" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-32" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;INSERT INTO &lt;/span&gt;hmily_transaction_participant&lt;span style=&quot;font-weight: normal;&quot;&gt; (participant_id, participant_ref_id, trans_id, trans_type, status, app_name,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;role, retry, target_class, target_method, confirm_method, cancel_method, confirm_invocation, cancel_invocation, version, create_time, update_time)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ,? , ? , ?, ?)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3200" y="2360" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-34" target="Jgbx7IJgLmi5tVRdjDKV-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="2970" />
              <mxPoint x="1940" y="2490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-34" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;updateHmilyParticipantStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;font-weight: 400;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px;&quot;&gt;发布UPDATE_HMILY_PARTICIPANT_STATUS 事件&lt;/font&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="2940" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-38" target="Jgbx7IJgLmi5tVRdjDKV-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="3050" />
              <mxPoint x="1940" y="2490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-38" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;removeHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-weight: normal;&quot;&gt;发布REMOVE_HMILY_PARTICIPANT&amp;nbsp;事件&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="3020" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-43" target="_u3hFmiMN6U5vcW2F68K-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-43" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryFacade.getInstance()&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;updateHmilyParticipantStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;hmilyParticipant.getParticipantId(), hmilyParticipant.getStatus());&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2720" y="2440" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-45" target="_u3hFmiMN6U5vcW2F68K-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-45" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;checkRows(hmilyRepository&lt;br&gt;.&lt;/span&gt;updateHmilyParticipantStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;transId, status));&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2960" y="2440" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-46" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;update &lt;/span&gt;hmily_transaction_participant&lt;span style=&quot;font-weight: normal;&quot;&gt; set status=? where participant_id = ?&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3200" y="2440" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-49" value="&lt;font color=&quot;#007fff&quot;&gt;参与者事务控制的代码发生异常，&lt;br&gt;怎么向事务发起者反馈以及触发撤销操作的？&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="2710" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-51" value="HmilyTccTransactionExecutor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1611.26" y="2250" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-54" target="_u3hFmiMN6U5vcW2F68K-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-54" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryFacade.getInstance()&lt;br&gt;.&lt;/span&gt;updateHmilyTransactionStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;hmilyTransaction.getTransId(), hmilyTransaction.getStatus());&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2720" y="2520" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-55" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-56" target="_u3hFmiMN6U5vcW2F68K-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-56" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;checkRows(hmilyRepository&lt;br&gt;.updateHmilyTransactionStatus(&lt;br&gt;transId, status));&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2960" y="2520" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-57" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;update &lt;/span&gt;hmily_transaction_global&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; set status=?&amp;nbsp; where trans_id = ?&amp;nbsp;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3200" y="2520" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-60" target="_u3hFmiMN6U5vcW2F68K-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-60" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;this.executor.&lt;/span&gt;updateStartStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;hmilyTransaction);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1241.26" y="2540" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-63" target="Jgbx7IJgLmi5tVRdjDKV-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="2570" />
              <mxPoint x="1940" y="2490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-63" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage&lt;br&gt;.updateHmilyTransactionStatus(hmilyTransaction);&lt;br&gt;HmilyRepositoryStorage&lt;br&gt;.updateHmilyParticipantStatus(hmilyParticipant);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="1479.74" y="2540" width="240.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-67" value="REMOVE_HMILY_PARTICIPANT" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;" parent="1" vertex="1" connectable="0">
          <mxGeometry x="2639.7481310172366" y="2629.9970370370365" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-69" target="_u3hFmiMN6U5vcW2F68K-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-69" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryFacade.getInstance()&lt;br&gt;.&lt;/span&gt;removeHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;hmilyParticipant.getParticipantId());&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2719.6" y="2600" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-71" target="_u3hFmiMN6U5vcW2F68K-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-71" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;checkRows(hmilyRepository&lt;br&gt;.&lt;/span&gt;removeHmilyParticipant&lt;span style=&quot;font-weight: normal;&quot;&gt;(participantId));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;默认是物理删除&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2959.6" y="2600" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-72" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;delete from &lt;/span&gt;hmily_transaction_participant&lt;span style=&quot;font-weight: normal;&quot;&gt; where participant_id = ?&amp;nbsp;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="3199.6" y="2600" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-80" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-74" target="_u3hFmiMN6U5vcW2F68K-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-74" value="HmilyTransactionEventConsumer#&lt;br&gt;execute&lt;span style=&quot;font-weight: normal;&quot;&gt;(final HmilyTransactionTask task)&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过 Disruptor 实现的事件发布订阅&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="1960" y="2620" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-78" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-75" target="_u3hFmiMN6U5vcW2F68K-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-75" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;this.disruptor.getProvider().&lt;/span&gt;onData(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;这里其实是相当于发布了一个 &lt;/span&gt;&lt;span style=&quot;font-weight: 400;&quot;&gt;HmilyTransactionTask&lt;/span&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=center;" parent="1" vertex="1">
          <mxGeometry x="1239.48" y="2620" width="200.52" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="_u3hFmiMN6U5vcW2F68K-79" target="_u3hFmiMN6U5vcW2F68K-81" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2420" y="2650" />
              <mxPoint x="2420" y="2700" />
              <mxPoint x="1950" y="2700" />
              <mxPoint x="1950" y="2900" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="_u3hFmiMN6U5vcW2F68K-79" target="ILePiL2lHhwXlFeLtQY4-5">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2420" y="2650" />
              <mxPoint x="2420" y="2700" />
              <mxPoint x="1950" y="2700" />
              <mxPoint x="1950" y="3150" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-79" value="task.run()" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="2199.75" y="2620" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-84" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="_u3hFmiMN6U5vcW2F68K-81" target="_u3hFmiMN6U5vcW2F68K-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-81" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp;this.executor.&lt;/span&gt;globalConfirm&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;currentTransaction);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960.0000000000002" y="2870" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="_u3hFmiMN6U5vcW2F68K-83" target="ILePiL2lHhwXlFeLtQY4-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="_u3hFmiMN6U5vcW2F68K-83" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;currentTransaction.setStatus(HmilyActionEnum.&lt;/span&gt;&lt;font style=&quot;&quot; color=&quot;#cc0000&quot;&gt;CONFIRMING&lt;/font&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;.getCode());&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;font style=&quot;font-weight: normal; font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//通过 HmilyRepositoryEventPublisher 发布 UPDATE_HMILY_TRANSACTION_STATUS&amp;nbsp;事件&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyRepositoryStorage.&lt;/span&gt;updateHmilyTransactionStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(currentTransaction);&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipants = currentTransaction.getHmilyParticipants();&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;List&amp;lt;Boolean&amp;gt; successList = new ArrayList&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;for (HmilyParticipant hmilyParticipant : &lt;/span&gt;hmilyParticipants&lt;span style=&quot;font-weight: normal;&quot;&gt;) { &lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//通知所有参与者确认提交&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (hmilyParticipant.getRole() == HmilyRoleEnum.START.getCode()) {&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //说明是事务发起者应用自己，本地调用（获取服务实例反射调用）&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;HmilyReflector&lt;span style=&quot;font-weight: normal;&quot;&gt;.executor(HmilyActionEnum.CONFIRMING, &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;ExecutorTypeEnum.&lt;/span&gt;LOCAL&lt;span style=&quot;font-weight: normal;&quot;&gt;, hmilyParticipant);&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyRepositoryStorage.removeHmilyParticipant(hmilyParticipant);&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;//其他参与者，远程调用（获取服务实例封装后的Stub实例反射调用）&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;HmilyReflector&lt;span style=&quot;font-weight: normal;&quot;&gt;.executor(HmilyActionEnum.CONFIRMING, &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;ExecutorTypeEnum.&lt;/span&gt;RPC&lt;span style=&quot;font-weight: normal;&quot;&gt;, hmilyParticipant);&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; successList.add(true);&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; successList.add(false);&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.error(...);&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyContextHolder.remove();&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;if (successList.stream().allMatch(e -&amp;gt; e)) { &lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;//&lt;/span&gt;如果有参与者确认提交失败&lt;span style=&quot;font-weight: normal;&quot;&gt;（确认和撤销会有重试，这里是指重试之后还是失败）&lt;/span&gt;，不会删除事务记录，但是也不会继续处理&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyRepositoryStorage.removeHmilyTransaction(currentTransaction);&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="2199.74" y="2720" width="400.25" height="360" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-5" target="ILePiL2lHhwXlFeLtQY4-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-5" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp;this.executor.&lt;/span&gt;globalCancel&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;currentTransaction);&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1960" y="3120" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-8" target="ILePiL2lHhwXlFeLtQY4-10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-8" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;currentTransaction.setStatus(HmilyActionEnum.&lt;/span&gt;&lt;font color=&quot;#cc0000&quot;&gt;CANCELING&lt;/font&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;.getCode());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal; background-color: initial;&quot;&gt;HmilyRepositoryStorage.updateHmilyTransactionStatus(currentTransaction);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;final List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipants = currentTransaction.getHmilyParticipants();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;for (HmilyParticipant hmilyParticipant : hmilyParticipants) {&lt;/span&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt; //通知所有参与者撤销&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (hmilyParticipant.getRole() == HmilyRoleEnum.START.getCode()) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;HmilyReflector&lt;span style=&quot;font-weight: normal;&quot;&gt;.executor(HmilyActionEnum.CANCELING, &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ExecutorTypeEnum.LOCAL, hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyRepositoryStorage.removeHmilyParticipant(hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;HmilyReflector&lt;span style=&quot;font-weight: normal;&quot;&gt;.executor(HmilyActionEnum.CANCELING,&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ExecutorTypeEnum.RPC, hmilyParticipant);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable e) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LOGGER.error(&quot;HmilyParticipant cancel exception :{}&quot;, hmilyParticipant.toString(), e);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; } finally {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyContextHolder.remove();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="2199.75" y="3120" width="400.25" height="240" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-10" target="ILePiL2lHhwXlFeLtQY4-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-10" target="ILePiL2lHhwXlFeLtQY4-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-10" value="HmilyReflector&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;/span&gt;executor&lt;span style=&quot;font-weight: normal;&quot;&gt;(&lt;br&gt;final HmilyActionEnum action, &lt;br&gt;final ExecutorTypeEnum executorType, &lt;br&gt;final HmilyParticipant hmilyParticipant)&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="2639.75" y="2870" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-12" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;Object &lt;/span&gt;executeLocal&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyInvocation hmilyInvocation, String className, String methodName)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;反射调用本地服务类实例&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="2880" y="2870" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-14" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;Object &lt;/span&gt;executeRpc&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyInvocation hmilyInvocation)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;反射调用远程服务在本地的客户端实例&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="2880" y="2970" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-16" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyInvocation&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于Confirm、Cancel阶段 本地调用、RPC调用&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//本地调用就是保存Confirm 或 Cancel 方法所属类的封装类（ObjectProvide），通过类去容器类SingletonHolder找到真正的实例反射调用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//RPC调用和本地调用类似，不过存储的是RPC客户端类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private Class&amp;lt;?&amp;gt; &lt;b&gt;targetClass&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private String methodName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Class&amp;lt;?&amp;gt;[] parameterTypes;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Object[] args;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-1960" y="1400" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-22" value="&lt;b&gt;抛出些重要问题（&lt;/b&gt;Markdown中详细说明&lt;b&gt;）&lt;/b&gt;：&lt;br&gt;1. 事务参与应用的角色有哪些怎么分配的？事务状态有哪些是怎么切换？&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;看下面流程图中红色字体，不过搜索了全部代码没看到哪里有设置 DELETE状态&lt;/font&gt;&lt;br&gt;2. 事务的生命周期&lt;br&gt;3. Try阶段异常（指重试后还是异常）会撤销，如果Confirm、Cancel阶段异常呢，Hmily怎么处理的？" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="880.25" y="10" width="639.75" height="130" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-23" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;result = {ConcurrentHashMap@12555}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;org.dromara.hmily.grpc.client.GrpcHmilyClient&quot; -&amp;gt; {GrpcHmilyClient@12530}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; key = &quot;org.dromara.hmily.grpc.client.GrpcHmilyClient&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; value = {GrpcHmilyClient@12530}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;org.dromara.hmily.core.provide.ObjectProvide&quot; -&amp;gt; {SpringBeanProvide@12564}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; key = &quot;org.dromara.hmily.core.provide.ObjectProvide&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; value = {SpringBeanProvide@12564}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-1960" y="1600" width="460" height="110" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-25" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;SingletonHolder.INST.SINGLES：&lt;/b&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;result = {ConcurrentHashMap@12555}&amp;nbsp; size = 2&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;org.dromara.hmily.grpc.client.GrpcHmilyClient&quot; -&amp;gt; {GrpcHmilyClient@12530}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; key = &quot;org.dromara.hmily.grpc.client.GrpcHmilyClient&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; value = {GrpcHmilyClient@12530}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;org.dromara.hmily.core.provide.ObjectProvide&quot; -&amp;gt; {SpringBeanProvide@12564}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; key = &quot;org.dromara.hmily.core.provide.ObjectProvide&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; value = {SpringBeanProvide@12564}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3110" y="2870" width="460" height="130" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="ILePiL2lHhwXlFeLtQY4-26" target="ILePiL2lHhwXlFeLtQY4-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-26" value="&lt;div style=&quot;&quot;&gt;new HmilyTransactionSelfRecoveryScheduled()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建了4个定时任务&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1960" y="250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-28" value="HmilyBootstrap" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1649.74" y="410" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-29" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;hmilyRepository = ExtensionLoaderFactory.load(HmilyRepository.class,&amp;nbsp; &amp;nbsp;&lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; hmilyConfig.getRepository());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b style=&quot;font-size: 9px;&quot;&gt;selfTccRecoveryExecutor&lt;/b&gt; = new ScheduledThreadPoolExecutor(1,&amp;nbsp;&lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyThreadFactory.create(&quot;hmily-tcc-self-recovery&quot;, true));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.selfTacRecoveryExecutor = new ScheduledThreadPoolExecutor(1,&amp;nbsp; &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyThreadFactory.create(&quot;hmily-tac-self-recovery&quot;, true));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;this.&lt;b style=&quot;font-size: 9px;&quot;&gt;cleanHmilyTransactionExecutor&lt;/b&gt; = new ScheduledThreadPoolExecutor(1, &lt;br style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyThreadFactory.create(&quot;hmily-transaction-clean&quot;, true));&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;hmilyTransactionRecoveryService = new HmilyTransactionRecoveryService();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;color: rgb(0, 127, 255);&quot;&gt;//1 提交TCC自我恢复定时任务&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;（找出当前应用发起的非完成、非失败且距上次修改超过60s(默认)的事务参与者，遍历判断重试次数，已重试次数大于最大重试次数就直接&lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;修改为失败状态 &lt;/font&gt;&lt;font color=&quot;#cc0000&quot;&gt;DEATH&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;，否则如果是 TRYING CONFIRMING CANCELING状态先加乐观锁，加锁成功后，根据状态继续执行Confirm （CONFIRMING状态）或 Cancel （TRYLING、CANCELING） 操作）&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;selfTccRecovery&lt;/b&gt;();&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//2&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;selfTacRecovery();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;//3 提交事务清理任务&lt;/b&gt;(60s执行一次，筛选最后修改距今180s的事务，如果&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;hmily_transaction_participant为空则删除事务记录&lt;/font&gt;&lt;span style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;cleanHmilyTransaction&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;//4 定时（默认600s检查一次）删除已经完成的事务相关数据&lt;/b&gt;，这里可以看到非物理删除的事务不是不删除而是定时批量删除；另外&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;已经完成的事务默认会额外保存3天&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;phyDeleted&lt;/b&gt;();&lt;span style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=3;" vertex="1" parent="1">
          <mxGeometry x="2199.2299999999996" y="160" width="440.26" height="240" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-31" value="&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;1 &lt;/b&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;提交TCC自我恢复定时任务SQL&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;select ... from &lt;b style=&quot;font-size: 10px;&quot;&gt;hmily_transaction_participant&lt;/b&gt;&amp;nbsp;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;where update_time &amp;lt; ? and app_name = ?&amp;nbsp; and trans_type = ? and status not in (4, 8) limit ?&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;update &lt;b style=&quot;font-size: 10px;&quot;&gt;hmily_transaction_participant&lt;/b&gt; set version =?, retry =? where participant_id = ? and version = ?&amp;nbsp; //乐观锁&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;3 提交事务清理任务SQL&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;select trans_id, app_name, status, trans_type, retry, version from &lt;b&gt;hmily_transaction_global&lt;/b&gt; where update_time &amp;lt; ? and app_name = ? limit ?&lt;br&gt;&lt;/font&gt;select count(*) as count_total from &lt;b&gt;hmily_transaction_participant&lt;/b&gt; where trans_id = ?&lt;br&gt;delete from &lt;b&gt;hmily_transaction_global&lt;/b&gt; where trans_id = ?&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;4 phyDeleted 定时任务SQL&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;（status == 4 即 DELETE 状态）：&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;delete from &lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;hmily_transaction_global&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt; where update_time &amp;lt; ? and status = 4&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;delete from &lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;hmily_transaction_participant&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt; where update_time &amp;lt; ? and status = 4&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;delete from &lt;b style=&quot;font-size: 10px;&quot;&gt;hmily_participant_undo&lt;/b&gt; where update_time &amp;lt; ? and status = 4&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2199.5" y="400" width="640.25" height="140" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-32" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyActionEnum&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务状态&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;PRE_TRY(0, &quot;开始执行try&quot;),&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;TRYING(1, &quot;try阶段完成&quot;),&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;CONFIRMING(2, &quot;confirm阶段&quot;),&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;CANCELING(3, &quot;cancel阶段&quot;),&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;DELETE(4, &quot;删除状态&quot;),&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;DEATH(8, &quot;超过最大重试次数状态&quot;);&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1000" y="1800" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-33" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;Hmily分布式事务状态&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;PRE_TRY(0, &quot;开始执行try&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;TRYING(1, &quot;try阶段完成&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;CONFIRMING(2, &quot;confirm阶段&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;CANCELING(3, &quot;cancel阶段&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;DELETE(4, &quot;删除状态&quot;),&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;DEATH(8, &quot;超过最大重试次数状态&quot;);&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2679.74" y="300" width="180" height="100" as="geometry" />
        </mxCell>
        <mxCell id="ILePiL2lHhwXlFeLtQY4-34" value="HmilyTransactionSelfRecoveryScheduled" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="2314.49" y="130" width="210" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="i737AeyZ1UvvoL_7sYwF" name="producer-consumer">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="VKt300fsJwFLvDc-qWOP-1" value="&lt;h1 style=&quot;font-size: 18px;&quot;&gt;&lt;font style=&quot;font-size: 18px;&quot;&gt;Hmily 事件发布订阅工作原理流程&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;源码版本：2.1.2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;这部分源码主要位于 hmily-core/src/main/java/org/dromara/hmily/core/&lt;b&gt;disruptor&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;Hmily对Disruptor 进行了简单的封装，仅仅500多行。&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=16;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="720" height="90" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.002;exitY=0.45;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" edge="1" parent="1" source="FDoHXz8YMTC5YHLJsqAl-1" target="FDoHXz8YMTC5YHLJsqAl-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-1" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyDisruptor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily 事件发布订阅核心类&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final Integer DEFAULT_SIZE = 4096 &amp;lt;&amp;lt; 1 &amp;lt;&amp;lt; 1; //默认的RingBuffer大小&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Integer DEFAULT_CONSUMER_SIZE = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;Runtime.getRuntime().availableProcessors() &amp;lt;&amp;lt; 1; //默认的消费者队列大小&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//RingBuffer 大小&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Integer &lt;b&gt;size&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private DisruptorProvider&amp;lt;T&amp;gt; &lt;b&gt;provider&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//消费者队列大小&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Integer &lt;b&gt;consumerSize&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyDisruptorConsumer&amp;lt;T&amp;gt; &lt;b&gt;consumer&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public &lt;b&gt;HmilyDisruptor&lt;/b&gt;(final HmilyDisruptorConsumer&amp;lt;T&amp;gt; consumer, final Integer&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; ringBufferSize)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public &lt;b&gt;HmilyDisruptor&lt;/b&gt;(final HmilyDisruptorConsumer&amp;lt;T&amp;gt; consumer)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public &lt;b&gt;HmilyDisruptor&lt;/b&gt;(final HmilyDisruptorConsumer&amp;lt;T&amp;gt; consumer,&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; final int consumerSize,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final int ringBufferSize)&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;startup&lt;/b&gt;()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public DisruptorProvider&amp;lt;T&amp;gt; &lt;b&gt;getProvider&lt;/b&gt;()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-480" y="120" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyDisruptorConsumer&amp;lt;T&amp;gt; (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily事件消费者接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String fixName();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void execute(T data);&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-960" y="120" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-3" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;ExecutorSubscriber&lt;/b&gt;&amp;lt;T&amp;gt;&amp;nbsp;&lt;b style=&quot;background-color: initial;&quot;&gt;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily事件订阅者接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void executor(Collection&amp;lt;? extends T&amp;gt; collections);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1440" y="120" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DataEvent&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;事件数据类，T是事件数据的原始类型&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private T t;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-480" y="480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DisruptorEventFactory&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;事件数据类实例工厂，T是事件数据的原始类型&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public DataEvent&amp;lt;T&amp;gt; newInstance()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-960" y="480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-7" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DisruptorProvider&amp;lt;T&amp;gt;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final RingBuffer&amp;lt;DataEvent&amp;lt;T&amp;gt;&amp;gt; &lt;b&gt;ringBuffer&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Disruptor&amp;lt;DataEvent&amp;lt;T&amp;gt;&amp;gt; &lt;b&gt;disruptor&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//发布事件数据到Disruptor的队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;onData&lt;/b&gt;(final T t)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void shutdown()&amp;nbsp;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-480" y="640" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyDisruptorWorkHandler&amp;lt;T&amp;gt;&amp;nbsp;&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;div style=&quot;text-align: center;&quot;&gt;implements &lt;b&gt;WorkHandler&lt;/b&gt;&amp;lt;DataEvent&amp;lt;T&amp;gt;&amp;gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;事件处理器（消费者）&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyDisruptorConsumer&amp;lt;T&amp;gt; consumer;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//重写 Disruptor WorkHandler onEvent() 方法实现回调 HmilyDisruptorConsumer execute() 方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;onEvent&lt;/b&gt;(final DataEvent&amp;lt;T&amp;gt; t)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-480" y="840" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="FDoHXz8YMTC5YHLJsqAl-9" target="FDoHXz8YMTC5YHLJsqAl-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyRepositoryEventConsumer &lt;/b&gt;implements HmilyDisruptorConsumer&amp;lt;&lt;b&gt;HmilyRepositoryEvent&lt;/b&gt;&amp;gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConsistentHashSelector &lt;b&gt;executor&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-960" y="280" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="FDoHXz8YMTC5YHLJsqAl-11" target="FDoHXz8YMTC5YHLJsqAl-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="FDoHXz8YMTC5YHLJsqAl-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionEventConsumer &lt;/b&gt;implements HmilyDisruptorConsumer&amp;lt;&lt;b&gt;HmilyTransactionTask&lt;/b&gt;&amp;gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1440" y="280" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i8KfzOOk-wb2cdejwPXp-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="PlJd90hxTdh_YZXVRV4U-1" target="i8KfzOOk-wb2cdejwPXp-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="PlJd90hxTdh_YZXVRV4U-1" value="HmilyRepositoryEventPublisher&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;单例模式，&lt;br style=&quot;font-size: 11px;&quot;&gt;静态初始化阶段会创建对象&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="PlJd90hxTdh_YZXVRV4U-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyRepositoryEventPublisher&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final HmilyRepositoryEventPublisher &lt;b&gt;INSTANCE&lt;/b&gt; = new &lt;br&gt;&amp;nbsp; &amp;nbsp; HmilyRepositoryEventPublisher();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private HmilyDisruptor&amp;lt;HmilyRepositoryEvent&amp;gt; &lt;b&gt;disruptor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final HmilyConfig &lt;b&gt;hmilyConfig&lt;/b&gt; =&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; ConfigEnv.getInstance().getConfig(HmilyConfig.class);&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;publishEvent&lt;/b&gt;(...)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;syncPublishEvent&lt;/b&gt;(final Collection&amp;lt;HmilyLock&amp;gt; hmilyLocks, final int type)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;asyncPublishEvent&lt;/b&gt;(final HmilyTransaction hmilyTransaction, final int type)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-480" y="1040" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="i8KfzOOk-wb2cdejwPXp-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="i8KfzOOk-wb2cdejwPXp-1" target="i8KfzOOk-wb2cdejwPXp-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i8KfzOOk-wb2cdejwPXp-1" value="private static final HmilyRepositoryEventPublisher &lt;b style=&quot;font-size: 11px;&quot;&gt;INSTANCE&lt;/b&gt; = new HmilyRepositoryEventPublisher();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i8KfzOOk-wb2cdejwPXp-3" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyBootstrap start() 最终会执行到这里&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="220" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="i8KfzOOk-wb2cdejwPXp-4" target="HqclxQq9rGhgqHs_6nvA-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i8KfzOOk-wb2cdejwPXp-4" value="start();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="HqclxQq9rGhgqHs_6nvA-1" target="IMOijTsNdvq_BZ3CCSnY-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-6" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="IMOijTsNdvq_BZ3CCSnY-5">
          <mxGeometry x="0.284" y="2" relative="1" as="geometry">
            <mxPoint y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-1" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;List&amp;lt;SingletonExecutor&amp;gt; selects = new ArrayList();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;for(int i = 0; i &amp;lt; this.hmilyConfig.getConsumerThreads(); ++i) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; //SingletonExecutor 是单线程线程池，任务队列容量5000，即selects 是一组单线程线程池&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;selects&lt;/b&gt;.add(new &lt;b style=&quot;font-size: 10px;&quot;&gt;SingletonExecutor&lt;/b&gt;(&quot;hmily-log-disruptor&quot; + i));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//单线程线程池选择器，内部使用跳表Map保存 线程池名字hash值 -&amp;gt; SingletonExecutor&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//处理事务事件时通过对事务ID进行hash然后通过一致性hash选择 SingletonExecutor&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ConsistentHashSelector &lt;b style=&quot;font-size: 10px;&quot;&gt;selector&lt;/b&gt; = new &lt;b style=&quot;font-size: 10px;&quot;&gt;ConsistentHashSelector&lt;/b&gt;(selects);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.disruptor = new &lt;b style=&quot;font-size: 10px;&quot;&gt;HmilyDisruptor&lt;/b&gt;(new &lt;b style=&quot;font-size: 10px;&quot;&gt;HmilyRepositoryEventConsumer&lt;/b&gt;(selector), 1, &lt;br style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.hmilyConfig.getBufferSize());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 1&amp;nbsp;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;this.disruptor.&lt;b&gt;startup&lt;/b&gt;();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=5;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="760" y="120" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="HqclxQq9rGhgqHs_6nvA-3" target="HqclxQq9rGhgqHs_6nvA-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-3" value="HmilyTransactionHandlerRegistry&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;HmilyTransactionHandlerRegistry 注册Start阶段的事务处理器时会创建对象&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="HqclxQq9rGhgqHs_6nvA-4" target="HqclxQq9rGhgqHs_6nvA-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-4" value="getHandlers().put(&lt;br&gt;HmilyRoleEnum.START, new &lt;b&gt;StarterHmilyTccTransactionHandler&lt;/b&gt;());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;以TCC为例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HqclxQq9rGhgqHs_6nvA-6" value="&lt;div&gt;disruptor = new &lt;b&gt;HmilyDisruptor&lt;/b&gt;&amp;lt;&amp;gt;(new &lt;b&gt;HmilyTransactionEventConsumer&lt;/b&gt;(),&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; Runtime.getRuntime().availableProcessors() &amp;lt;&amp;lt; 1, HmilyDisruptor.DEFAULT_SIZE);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;disruptor.startup();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="280" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6qxSD2ziMsxlfAs5DSOV-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="qZWgkc3TDnwwQkEVw790-1" target="6qxSD2ziMsxlfAs5DSOV-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qZWgkc3TDnwwQkEVw790-1" value="&lt;font style=&quot;&quot;&gt;HmilyRepositoryEventPublisher#&lt;br&gt;publishEvent(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;发布事务事件&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="6qxSD2ziMsxlfAs5DSOV-1" target="IMOijTsNdvq_BZ3CCSnY-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="6qxSD2ziMsxlfAs5DSOV-1" value="&lt;font style=&quot;&quot;&gt;push(event);&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IMOijTsNdvq_BZ3CCSnY-1" target="IMOijTsNdvq_BZ3CCSnY-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-1" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (Objects.nonNull(hmilyConfig) &amp;amp;&amp;amp; hmilyConfig.&lt;b&gt;isAsyncRepository&lt;/b&gt;()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; disruptor.getProvider().&lt;b&gt;onData&lt;/b&gt;(event); &lt;font color=&quot;#007fff&quot;&gt;//默认配置会走这个分支&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyRepositoryEventDispatcher.getInstance().&lt;b&gt;doDispatch&lt;/b&gt;(event);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="380" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IMOijTsNdvq_BZ3CCSnY-4" target="IMOijTsNdvq_BZ3CCSnY-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-4" value="this.disruptor.startup();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1240.5" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-7" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;Disruptor&amp;lt;DataEvent&amp;lt;T&amp;gt;&amp;gt; disruptor = new &lt;b style=&quot;font-size: 10px;&quot;&gt;Disruptor&lt;/b&gt;&amp;lt;&amp;gt;(new DisruptorEventFactory&amp;lt;&amp;gt;(),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; size,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyThreadFactory.create(&quot;disruptor_consumer_&quot; + consumer.fixName(), false),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ProducerType.MULTI,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; new BlockingWaitStrategy());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//事件处理器对象池&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;HmilyDisruptorWorkHandler&amp;lt;T&amp;gt;[] &lt;b&gt;workerPool&lt;/b&gt; = new HmilyDisruptorWorkHandler[consumerSize];&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;for (int i = 0; i &amp;lt; consumerSize; i++) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; workerPool[i] = new HmilyDisruptorWorkHandler&amp;lt;&amp;gt;(consumer);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;disruptor.handleEventsWithWorkerPool(&lt;b&gt;workerPool&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;disruptor.setDefaultExceptionHandler(new IgnoreExceptionHandler());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;disruptor.start();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;RingBuffer&amp;lt;DataEvent&amp;lt;T&amp;gt;&amp;gt; ringBuffer = disruptor.getRingBuffer();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;provider = new &lt;b&gt;DisruptorProvider&lt;/b&gt;&amp;lt;&amp;gt;(ringBuffer, disruptor);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1480" y="90" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="IMOijTsNdvq_BZ3CCSnY-9" target="IMOijTsNdvq_BZ3CCSnY-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-9" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;long position = ringBuffer.next();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;DataEvent&amp;lt;T&amp;gt; de = ringBuffer.get(position);&lt;/div&gt;&lt;div&gt;de.setT(t);&lt;/div&gt;&lt;div&gt;ringBuffer.&lt;b&gt;publish&lt;/b&gt;(position);&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=12;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1000.5" y="380" width="199.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="IMOijTsNdvq_BZ3CCSnY-11" target="izfb4TK0SdplKcawu0hd-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="IMOijTsNdvq_BZ3CCSnY-11" value="&lt;font style=&quot;&quot;&gt;HmilyDisruptorWorkHandler#&lt;br&gt;&lt;b&gt;onEvent&lt;/b&gt;(final DataEvent&amp;lt;T&amp;gt; t)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="izfb4TK0SdplKcawu0hd-1" target="izfb4TK0SdplKcawu0hd-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-1" value="&lt;font style=&quot;&quot;&gt;HmilyRepositoryEventConsumer#&lt;br&gt;&lt;b&gt;execute&lt;/b&gt;(final HmilyRepositoryEvent event)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="520" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-5" value="&lt;font color=&quot;#007fff&quot;&gt;Disruptor 内部机制&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1230" y="420" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="izfb4TK0SdplKcawu0hd-6" target="izfb4TK0SdplKcawu0hd-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-6" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;Long transId = event.getTransId();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//根据事务ID通过ConsistentHashSelector选择一个 SingletonExecutor 并执行任务分发逻辑&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;executor.select(String.valueOf(transId)).execute(() -&amp;gt; {&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyRepositoryEventDispatcher.getInstance().&lt;b&gt;doDispatch&lt;/b&gt;(event);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; event.clear();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" vertex="1" parent="1">
          <mxGeometry x="760" y="470" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="izfb4TK0SdplKcawu0hd-8" value="&lt;font style=&quot;&quot;&gt;根据事务事件类型选择不同的处理器处理&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1240.5" y="480" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
