<mxfile host="Electron" modified="2024-05-17T16:21:17.720Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="3iPUEwxLdQpYb13hrRIp" version="21.6.5" type="device">
  <diagram name="第 1 页" id="uB3T4hW82Nwa9GDvWSnv">
    <mxGraphModel dx="3599" dy="676" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="b_DPwCItqDpnZili3_qI-1" value="&lt;h1 style=&quot;font-size: 18px;&quot;&gt;&lt;font style=&quot;font-size: 18px;&quot;&gt;Hmily TCC 模式工作原理流程&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;源码版本：2.1.2&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;测试DEMO: hmily/hmily-demo/hmily-demo-tcc/hmily-demo-tcc-grpc （源码下载下来调下参数就可以执行，直接在源码中调试吧）&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;这是一个 SpringBoot 项目；创建了&lt;b&gt;3个数据库，分别有一张表&lt;/b&gt;, 使用Mybatis访问数据表；系统包含3个服务（订单、库存、账户，服务间通过 grpc 通信，订单服务是前台服务），模拟购买商品下单、扣库存、支付扣款流程。&lt;/div&gt;&lt;div style=&quot;font-size: 12px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=16;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="720" height="110" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-2" target="b_DPwCItqDpnZili3_qI-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-2" value="业务事务处理" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="40" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-3" value="OrderController" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="370" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-4" target="b_DPwCItqDpnZili3_qI-59">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-4" value="Hmily事务管理器初始化" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-5" target="b_DPwCItqDpnZili3_qI-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-5" value="orderService.orderPay(count, amount)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;count 是商品数量，amount是支付金额&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-7" target="b_DPwCItqDpnZili3_qI-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-88" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-7" target="b_DPwCItqDpnZili3_qI-86">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="620" y="500" />
              <mxPoint x="380" y="500" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-143" value="&lt;font color=&quot;#007fff&quot;&gt;切面代理类&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-88">
          <mxGeometry x="-0.9512" y="1" relative="1" as="geometry">
            <mxPoint x="-1" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-7" value="Order order = saveOrder(count, amount);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-45" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-9" target="b_DPwCItqDpnZili3_qI-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-9" value="@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;confirmOrderStatus&quot;, cancelMethod = &quot;cancelOrderStatus&quot;)&lt;br&gt;paymentService.&lt;b&gt;makePayment&lt;/b&gt;(order);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-11" value="&lt;b&gt;orderMapper&lt;/b&gt;.&lt;b&gt;save&lt;/b&gt;(order);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-13" value="OrderServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="565" y="370" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-14" target="b_DPwCItqDpnZili3_qI-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-14" value="order.setStatus(orderStatus.getCode());&lt;br&gt;&lt;b&gt;orderMapper&lt;/b&gt;.&lt;b&gt;update&lt;/b&gt;(order);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;订单服务本地修改订单&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-16" target="b_DPwCItqDpnZili3_qI-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-16" target="b_DPwCItqDpnZili3_qI-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-16" value="accountClient.&lt;b&gt;payment&lt;/b&gt;(&lt;br&gt;String.valueOf(order.getUserId()), String.valueOf(order.getTotalAmount()&lt;br&gt;.doubleValue()));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;RPC调用扣减账户余额&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="720" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-18" target="b_DPwCItqDpnZili3_qI-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-18" value="inventoryClient.&lt;b&gt;decrease&lt;/b&gt;(&lt;br&gt;order.getProductId(), order.getCount());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;RPC调用扣减库存&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="759.75" y="950" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-20" target="b_DPwCItqDpnZili3_qI-26">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-28" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-27">
          <mxGeometry x="-0.0244" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-20" value="AccountResponse response = &lt;b style=&quot;font-size: 10px;&quot;&gt;grpcHmilyClient&lt;/b&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;syncInvoke&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;accountServiceBlockingStub&lt;/b&gt;, &quot;payment&quot;, request, AccountResponse.class);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1000" y="730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-24" value="InventoryResponse response = &lt;b&gt;grpcHmilyClient&lt;/b&gt;.&lt;b&gt;syncInvoke&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;inventoryServiceBlockingStub&lt;/b&gt;, &quot;decrease&quot;, request, InventoryResponse.class);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="999.75" y="950" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-26" target="b_DPwCItqDpnZili3_qI-34">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-26" value="accountServiceBeanImpl&lt;br style=&quot;font-size: 11px;&quot;&gt;.&lt;b&gt;payment&lt;/b&gt;(accountDTO)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1241" y="730" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-24" target="b_DPwCItqDpnZili3_qI-32">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1209.75" y="979.5" as="sourcePoint" />
            <mxPoint x="1250.75" y="979.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-31" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-30">
          <mxGeometry x="-0.0244" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-32" target="b_DPwCItqDpnZili3_qI-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-32" value="inventoryServiceBean&lt;br&gt;.&lt;b&gt;decrease&lt;/b&gt;(inventoryDTO)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240.25" y="950" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-33" value="AccountServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1281" y="700" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-34" target="b_DPwCItqDpnZili3_qI-36">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-34" target="b_DPwCItqDpnZili3_qI-39">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-34" value="&lt;div&gt;@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;&lt;b&gt;confirm&lt;/b&gt;&quot;, cancelMethod = &quot;&lt;b&gt;cancel&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;public boolean payment(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return accountMapper.&lt;b&gt;update&lt;/b&gt;(accountDTO) &amp;gt; 0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;扣减账户余额, balance 扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1480" y="720" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-36" value="@Transactional(rollbackFor = Exception.class) &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;div&gt;&lt;div&gt;public boolean &lt;b&gt;confirm&lt;/b&gt;(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; accountMapper.&lt;b&gt;confirm&lt;/b&gt;(accountDTO);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; return Boolean.TRUE;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;确认付款，将freeze_amount（用于回滚）也进行扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1960" y="720" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-39" value="&lt;div&gt;@Transactional(rollbackFor = Exception.class)&lt;/div&gt;&lt;div&gt;public boolean &lt;b&gt;cancel&lt;/b&gt;(AccountDTO accountDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final AccountDO accountDO = accountMapper.&lt;b&gt;findByUserId&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;accountDTO.getUserId());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; accountMapper.&lt;b&gt;cancel&lt;/b&gt;(accountDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return Boolean.TRUE;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;取消付款，将 balance 加回去，freeze_amount 减掉&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="820" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-42" value="&lt;font color=&quot;#007fff&quot;&gt;这一步其实是控制的&lt;b&gt;修改订单&lt;/b&gt;操作，&lt;br&gt;后面扣款、扣库存其实管不到&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="520" y="705" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-43" value="&lt;div style=&quot;&quot;&gt;public void &lt;b&gt;confirmOrderStatus&lt;/b&gt;(Order order) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; updateOrderStatus(order, OrderStatusEnum.&lt;b&gt;PAY_SUCCESS&lt;/b&gt;);&lt;/div&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;确认订单支付成功&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="759.75" y="480" width="440.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-44" value="&lt;div&gt;public void &lt;b&gt;cancelOrderStatus&lt;/b&gt;(Order order) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; updateOrderStatus(order, OrderStatusEnum.&lt;b&gt;PAY_FAIL&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;取消订单支付成功（支付失败）&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="760" y="560" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-52" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-47" target="b_DPwCItqDpnZili3_qI-50">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-47" target="b_DPwCItqDpnZili3_qI-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-47" value="&lt;div&gt;@&lt;b&gt;HmilyTCC&lt;/b&gt;(confirmMethod = &quot;&lt;b&gt;confirmMethod&lt;/b&gt;&quot;, cancelMethod = &quot;&lt;b&gt;cancelMethod&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; public boolean decrease(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return inventoryMapper.&lt;b&gt;decrease&lt;/b&gt;(inventoryDTO) &amp;gt; 0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;扣减库存， total_inventory 扣减&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" vertex="1" parent="1">
          <mxGeometry x="1480" y="940" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-49" value="InventoryServiceImpl" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1276" y="920" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-50" value="&lt;div&gt;public Boolean &lt;b&gt;confirmMethod&lt;/b&gt;(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; inventoryMapper.confirm(inventoryDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;确认扣减库存， 将 lock_inventory （用于回滚） 也进行扣减&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="1960" y="940" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-51" value="&lt;div&gt;&lt;div&gt;public Boolean &lt;b&gt;cancelMethod&lt;/b&gt;(InventoryDTO inventoryDTO) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; inventoryMapper.cancel(inventoryDTO);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;取消扣减库存，将 total_inventory 加回去，lock_inventory 减掉&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="1960" y="1040" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-54" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;insert into `order` (create_time,number,status,product_id,total_amount,count,user_id)&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&quot; values ( #{createTime},#{number},#{status},#{productId},#{totalAmount},#{count},#{userId})&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="970" y="410" width="510" height="40" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-55" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1210" y="495" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-56" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="960" y="655" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-57" value="&lt;font color=&quot;#007fff&quot;&gt;update `order` set status = #{status}&amp;nbsp; where number = #{number}&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1210" y="575" width="370" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-87" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-58" target="b_DPwCItqDpnZili3_qI-86">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-58" value="Hmily事务管理器协调" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="40" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-59" target="b_DPwCItqDpnZili3_qI-61">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-72" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-59" target="b_DPwCItqDpnZili3_qI-64">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-59" value="&lt;b&gt;hmily-spring-boot-starter-grpc&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个是引入的核心组件&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-71" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-61" target="b_DPwCItqDpnZili3_qI-70">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-61" value="继承：&lt;br&gt;&lt;b&gt;hmily-spring-boot-starter&lt;br&gt;&lt;/b&gt;依赖：&lt;br&gt;&lt;b&gt;hmily-spring-boot-starter-parent&lt;br&gt;&lt;/b&gt;hmily-grpc" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=left;" vertex="1" parent="1">
          <mxGeometry x="520" y="150" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-69" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-64" target="b_DPwCItqDpnZili3_qI-68">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-64" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span&gt;GrpcHmilyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;font color=&quot;#007fff&quot;&gt;自动配置类，仅仅创建一个Bean&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-68" value="&lt;b&gt;@Bean&amp;nbsp;GrpcHmilyClient&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Grpc客户端&lt;/font&gt;&lt;/b&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; background-color: rgb(43, 43, 43); color: rgb(169, 183, 198);&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-75">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-80" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-70" target="b_DPwCItqDpnZili3_qI-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-70" value="HmilyAutoConfiguration&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;hmily-spring-boot-starter-parent&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;中的自动配置类&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-76" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-73" target="b_DPwCItqDpnZili3_qI-75">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-85" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-73" target="b_DPwCItqDpnZili3_qI-84">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-73" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean &lt;br&gt;SpringHmilyTransactionAspect&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-75" target="b_DPwCItqDpnZili3_qI-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-75" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;b&gt;RefererAnnotationBeanPostProcessor&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;这是一个BeanPostProcessor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-96" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-78" target="b_DPwCItqDpnZili3_qI-95">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-78" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;@Bean&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;b&gt;HmilyApplicationContextAware&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;实现 ApplicationContextAware, BeanFactoryPostProcessor&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="999.75" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-108" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-81" target="b_DPwCItqDpnZili3_qI-107">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-81" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;AbstractHmilyTransactionAspect (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;Hmily切面抽象类，&lt;/b&gt;实现了Hmily切面注解（@HmilyTCC、@HmilyTAC）拦截的全部逻辑&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;切点&lt;/b&gt;为 @HmilyTCC 或 @HmilyTAC 注解的方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//切面拦截器，拦截逻辑都在这里面定义&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private final &lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyTransactionInterceptor&lt;/b&gt; &lt;b style=&quot;font-size: 11px;&quot;&gt;interceptor&lt;/b&gt; = new HmilyGlobalInterceptor();&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//只定义了一个环绕通知,内部调用 inteceptor.invoke() 执行切面拦截逻辑&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;@Around(&quot;hmilyInterceptor()&quot;)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public Object &lt;b style=&quot;font-size: 11px;&quot;&gt;interceptTccMethod&lt;/b&gt;(final ProceedingJoinPoint proceedingJoinPoint) throws Throwable&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-480" y="160" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-82" target="b_DPwCItqDpnZili3_qI-81">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-82" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;SpringHmilyTransactionAspect&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;只是额外实现了Ordered接口，并定义了Bean实例化的最高优先级&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-480" y="400" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-84" value="&lt;b&gt;HmilyGlobalInterceptor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个类的逻辑后面讲事务协调时细说&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1240.25" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-86" target="b_DPwCItqDpnZili3_qI-97">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-86" value="&lt;b&gt;HmilyGlobalInterceptor#invoke&lt;/b&gt;(&lt;br&gt;final ProceedingJoinPoint pjp)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="280" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-92" value="&lt;b&gt;SingletonHolder.INST&lt;/b&gt;&lt;br&gt;&lt;b&gt;.register(field.getType(), ref);&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;后面用到再细看&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-95" value="&lt;div style=&quot;&quot;&gt;SpringBeanUtils.INSTANCE.setCfgContext((ConfigurableApplicationContext) applicationContext);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;SingletonHolder.INST.&lt;b&gt;register&lt;/b&gt;(ObjectProvide.class, new SpringBeanProvide());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;HmilyBootstrap.getInstance().&lt;b&gt;start&lt;/b&gt;();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;后面用到再细看&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1240" y="320" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-100" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-97" target="b_DPwCItqDpnZili3_qI-99">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-103" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-100">
          <mxGeometry x="0.5603" y="-1" relative="1" as="geometry">
            <mxPoint x="1" y="-11" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-148" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-97" target="b_DPwCItqDpnZili3_qI-147">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-97" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;HmilyTransactionContext context = parameterLoader.load();&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="520" y="1080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-106" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-99" target="b_DPwCItqDpnZili3_qI-105">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-99" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;MethodSignature signature = (MethodSignature) point.getSignature();&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="519.75" y="1159.9999999999998" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-104" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;代码很容易理解，这里就省略一些不重要的细节&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="280" y="1140" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-113" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-105" target="b_DPwCItqDpnZili3_qI-112">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-105" value="&lt;span style=&quot;font-weight: normal;&quot;&gt;return &lt;/span&gt;getRegistry&lt;span style=&quot;font-weight: normal;&quot;&gt;(signature.getMethod())&lt;br&gt;.&lt;/span&gt;select&lt;span style=&quot;font-weight: normal;&quot;&gt;(context)&lt;br&gt;.&lt;/span&gt;handleTransaction(point, context);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;根据事务模式选择对应的 HmilyTransactionHandlerRegistry，再根据上下文选择对应事务处理器，最后处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="519.75" y="1240" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-107" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyGlobalInterceptor&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;只是额外实现了Ordered接口，并定义了Bean实例化的最高优先级&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//参数加载器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private static RpcParameterLoader &lt;b&gt;parameterLoader&lt;/b&gt;&amp;nbsp;= (RpcParameterLoader)Optional.ofNullable(&lt;br&gt;&amp;nbsp; &amp;nbsp; ExtensionLoaderFactory.load(&lt;b&gt;RpcParameterLoader&lt;/b&gt;.class)).orElse(new LocalParameterLoader());&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;//Hmily支持 TCC TAC XA三种模式，每种模式对应一种分布式事务管理器实现（HmilyTransactionHandlerRegistry）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;private static final EnumMap&amp;lt;TransTypeEnum, &lt;b style=&quot;font-size: 11px;&quot;&gt;HmilyTransactionHandlerRegistry&lt;/b&gt;&amp;gt; &lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;REGISTRY&lt;/b&gt; = new EnumMap&amp;lt;&amp;gt;(TransTypeEnum.class);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;public Object invoke(final ProceedingJoinPoint pjp) throws Throwable&amp;nbsp;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1000" y="160" width="480" height="200" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-112" target="b_DPwCItqDpnZili3_qI-114">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-116" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;TransTypeEnum&lt;br&gt;.TCC&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-115">
          <mxGeometry x="-0.0774" y="-3" relative="1" as="geometry">
            <mxPoint x="5" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-112" value="&lt;span style=&quot;font-weight: 400;&quot;&gt;工作模式&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;代理模式&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="760" y="1250" width="120.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-151" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-114" target="b_DPwCItqDpnZili3_qI-150">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-114" value="HmilyTccTransactionHandlerRegistry#&lt;br&gt;select(context)" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="999.74" y="1250" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-117" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionHandlerRegistry (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Hmily分布式事务注册器接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取Hmily事务处理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;HmilyTransactionHandler select(HmilyTransactionContext context);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="160" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-120" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-118" target="b_DPwCItqDpnZili3_qI-117">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-122" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-118" target="b_DPwCItqDpnZili3_qI-121">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1020" y="380" />
              <mxPoint x="-1020" y="940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-118" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractHmilyTransactionHandlerRegistry (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//定义了6种角色&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//TCC用到4种角色，每种角色对应一种事务处理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;&lt;b&gt;HmilyRoleEnum&lt;/b&gt;, &lt;b&gt;HmilyTransactionHandler&lt;/b&gt;&amp;gt; &lt;b&gt;handlers&lt;/b&gt; = new EnumMap&amp;lt;&amp;gt;(HmilyRoleEnum.class);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="320" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-123" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-119" target="b_DPwCItqDpnZili3_qI-118">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-119" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;HmilyTccTransactionHandlerRegistry&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;TCC模式的分布式事务注册器实现，通过&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;@HmilySPI(&quot;tcc&quot;) 加载&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="480" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-121" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;HmilyTransactionHandler&amp;nbsp;&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务处理器接口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Object &lt;b&gt;handleTransaction&lt;/b&gt;(ProceedingJoinPoint point, HmilyTransactionContext hmilyTransactionContext) throws Throwable;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1000" y="880" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-133" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-128">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420.01" y="1520" />
              <mxPoint x="420.01" y="1490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-134" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-129">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420.01" y="1520" />
              <mxPoint x="420.01" y="1590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-135" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-131">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420.01" y="1520" />
              <mxPoint x="420.01" y="1690" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-124" value="上下文角色" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="1490" width="120.01" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-154" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-126" target="b_DPwCItqDpnZili3_qI-153">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-126" value="StarterHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;br&gt;&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="519.75" y="1360" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-128" value="ParticipantHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/span&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="519.49" y="1460" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-129" value="ConsumeHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="519.4899999999998" y="1560" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-131" value="LocalHmilyTccTransactionHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;#&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;handleTransaction(point, context)&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="519.7499999999995" y="1660" width="200.26" height="60" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-127" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-124" target="b_DPwCItqDpnZili3_qI-126">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="420.01" y="1520" />
              <mxPoint x="420.01" y="1390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-140" value="HmilyRoleEnum&lt;br&gt;.START" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-127">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-138" value="HmilyRoleEnum&lt;br&gt;.CONSUMER" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-127">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="198" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-139" value="HmilyRoleEnum&lt;br&gt;.LOCAL" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-127">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="298" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-137" value="HmilyRoleEnum&lt;br&gt;.PARTICIPANT" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#007FFF;" vertex="1" connectable="0" parent="b_DPwCItqDpnZili3_qI-127">
          <mxGeometry x="0.5421" y="-2" relative="1" as="geometry">
            <mxPoint x="7" y="98" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-144" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;RpcParameterLoader&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;RPC参数加载器接口，这里的参数是 HmilyTransactionContext&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取Hmily事务处理器（从源码可以看到是从&lt;b&gt;线程本地&lt;/b&gt;获取 HmilyTransactionContext）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;HmilyTransactionContext load();&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="640" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-146" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-145" target="b_DPwCItqDpnZili3_qI-144">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-145" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;GrpcParameterLoader&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Grpc 参数加载器，&lt;/b&gt;通过&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;@HmilySPI(&quot;grpc&quot;) 加载, 获取 HmilyTranactionContext时，先尝试从 GrpcHmilyContext 获取再尝试从 HmilyTransationHolder 获取&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="760" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-147" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return (HmilyTransactionContext)Optional.ofNullable(&lt;/span&gt;RpcMediator&lt;span style=&quot;font-weight: normal;&quot;&gt;.getInstance().acquire((key) -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //key:&amp;nbsp; _HMILY_TRANSACTION_CONTEXT, HmilyContext 是 ThreadLocal&amp;lt;String&amp;gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这一句是获取 ThreadLocal&amp;lt;String&amp;gt; 中的字符串&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return (String)&lt;/span&gt;GrpcHmilyContext&lt;span style=&quot;font-weight: normal;&quot;&gt;.getHmilyContext().get();&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;})).orElse(HmilyContextHolder.get());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-weight: normal;&quot; color=&quot;#007fff&quot;&gt;RpcMediator 获取线程本地的字符串后如果字符串不为空则反序列化为 HmilyTransactionContext 并返回，如果字符串为空则从 HmilyContextHolder 获取&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fontStyle=1;arcSize=4;" vertex="1" parent="1">
          <mxGeometry x="760" y="1070" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-149" value="GrpcParameterLoader" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="910" y="1040" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-152" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-150" target="b_DPwCItqDpnZili3_qI-124">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1701" y="1280" />
              <mxPoint x="1701" y="1350" />
              <mxPoint x="260" y="1350" />
              <mxPoint x="260" y="1520" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-150" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;if (Objects.&lt;/span&gt;isNull&lt;span style=&quot;font-weight: normal;&quot;&gt;(context)) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;/span&gt;getHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyRoleEnum.&lt;/span&gt;START&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;} else if (context.getRole() == HmilyRoleEnum.&lt;/span&gt;LOCAL&lt;span style=&quot;font-weight: normal;&quot;&gt;.getCode()) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;/span&gt;getHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyRoleEnum.&lt;/span&gt;LOCAL&lt;span style=&quot;font-weight: normal;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;} else {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; return context.getRole() != HmilyRoleEnum.PARTICIPANT.getCode()&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;amp;&amp;amp; context.getRole() != HmilyRoleEnum.START.getCode() ? this.&lt;/span&gt;getHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyRoleEnum.CONSUMER) : this.&lt;/span&gt;getHandler&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyRoleEnum.PARTICIPANT);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1220" width="440.26" height="120" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-153" value="&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;Object returnValue;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyTransaction hmilyTransaction = this.executor.&lt;/span&gt;preTry&lt;span style=&quot;font-weight: normal;&quot;&gt;(point);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; returnValue = &lt;/span&gt;point&lt;span style=&quot;font-weight: normal;&quot;&gt;.&lt;/span&gt;proceed&lt;span style=&quot;font-weight: normal;&quot;&gt;(); &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//继续执行业务代码&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hmilyTransaction.&lt;/span&gt;setStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(HmilyActionEnum.TRYING.getCode());&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executor.&lt;/span&gt;updateStartStatus&lt;span style=&quot;font-weight: normal;&quot;&gt;(hmilyTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (Throwable var11) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .getCurrentTransaction();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;font style=&quot;font-weight: normal; background-color: initial; border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.disruptor.getProvider().onData(() -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executor.globalCancel(currentTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw var11;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: 400;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getCurrentTransaction();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; this.disruptor.getProvider().onData(() -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.executor.globalConfirm(currentTransaction);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;} finally {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; HmilyContextHolder.remove();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&amp;nbsp; &amp;nbsp; this.executor.remove();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;return returnValue;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;fontStyle=1;align=left;arcSize=2;" vertex="1" parent="1">
          <mxGeometry x="760" y="1360" width="440" height="400" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-158" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-156" target="b_DPwCItqDpnZili3_qI-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-156" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;StarterHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务启动处理器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//里面定义了&lt;b&gt;基于TCC协议的事务处理器流程方法&lt;/b&gt;（虽然名字带着Executor但并没有线程池）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HmilyTccTransactionExecutor&lt;/b&gt; &lt;b&gt;executor&lt;/b&gt; = HmilyTccTransactionExecutor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getInstance();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private HmilyDisruptor&amp;lt;HmilyTransactionTask&amp;gt; &lt;b&gt;disruptor&lt;/b&gt;;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyTransaction &lt;b&gt;preTry&lt;/b&gt;(ProceedingJoinPoint point)&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public HmilyParticipant &lt;b&gt;preTryParticipant&lt;/b&gt;(HmilyTransactionContext context, ProceedingJoinPoint point)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalConfirm&lt;/b&gt;(HmilyTransaction currentTransaction) throws HmilyRuntimeException&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantConfirm&lt;/b&gt;(List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipantList, Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;globalCancel&lt;/b&gt;(HmilyTransaction currentTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Object &lt;b&gt;participantCancel&lt;/b&gt;(List&amp;lt;HmilyParticipant&amp;gt; hmilyParticipants, Long selfParticipantId)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void &lt;b&gt;updateStartStatus&lt;/b&gt;(HmilyTransaction hmilyTransaction)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public void remove()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-520" y="1040" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-162" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-159" target="b_DPwCItqDpnZili3_qI-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-159" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ParticipantHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;分布式事务参与者处理器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;HmilyTccTransactionExecutor&lt;/b&gt; &lt;b&gt;executor&lt;/b&gt; = HmilyTccTransactionExecutor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.getInstance();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1000" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-163" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-160" target="b_DPwCItqDpnZili3_qI-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-160" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConsumeHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;分布式事务消费者处理器，&lt;/b&gt;看源码只是调用切点 proceed() 方法，继续执行业务方法&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1480" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-164" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" edge="1" parent="1" source="b_DPwCItqDpnZili3_qI-161" target="b_DPwCItqDpnZili3_qI-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="b_DPwCItqDpnZili3_qI-161" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;LocalHmilyTccTransactionHandler&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;分布式事务本地处理器，&lt;/b&gt;看源码只是调用切点 proceed() 和 ConsumeHmilyTccTransactionHandler 一样&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="-1960" y="1040" width="440" height="160" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
