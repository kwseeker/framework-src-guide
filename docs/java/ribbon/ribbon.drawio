<mxfile host="Electron" modified="2024-11-27T06:07:57.736Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="mtUyiQqSUOm6v0sGsE8I" version="21.6.5" type="device">
  <diagram name="第 1 页" id="s7ftlZovgMCbnuo22AY1">
    <mxGraphModel dx="3341" dy="991" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="8GXi-stoHSAcCtSXBaf--1" value="&lt;b&gt;URLConnectionLoadBalancerExample&lt;/b&gt;&lt;br&gt;使用LoadBalancerCommand通过固定Server列表的负载均衡器和HttpURLConnection发送请求的示例。" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="480" height="50" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--3" target="8GXi-stoHSAcCtSXBaf--6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--3" value="List&amp;lt;Server&amp;gt; servers =&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;Lists.newArrayList(new Server(...), ...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;获取服务节点列表&lt;/b&gt;，企业级应用一般是从注册中心通过服务名获取的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--6" target="8GXi-stoHSAcCtSXBaf--10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--6" target="8GXi-stoHSAcCtSXBaf--93" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--6" value="URLConnectionLoadBalancer &lt;b&gt;urlLoadBalancer&lt;/b&gt; = new URLConnectionLoadBalancer(servers);&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--7" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;font-size: 10px; color: rgb(0, 0, 0); background-color: initial;&quot;&gt;Server&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;服务端服务实例描述对象&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;private String &lt;b&gt;host&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;private int &lt;b&gt;port&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private String &lt;b&gt;scheme&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private volatile String &lt;b&gt;id&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private volatile boolean isAliveFlag;&lt;/div&gt;&lt;div&gt;private String zone;&lt;/div&gt;&lt;div&gt;private volatile boolean readyToServe;&lt;/div&gt;&lt;div&gt;private MetaInfo simpleMetaInfo;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-320" y="80" width="280" height="240" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--10" target="8GXi-stoHSAcCtSXBaf--16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--10" target="8GXi-stoHSAcCtSXBaf--13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--10" value="loadBalancer = LoadBalancerBuilder.newBuilder()&lt;br&gt;.&lt;b&gt;buildFixedServerListLoadBalancer&lt;/b&gt;(&lt;br&gt;serverList);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--13" target="8GXi-stoHSAcCtSXBaf--33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--13" target="8GXi-stoHSAcCtSXBaf--42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--13" value="&lt;div&gt;if (rule == null) {&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; rule = createRuleFromConfig(config, factory);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建负载均衡规则，根据实际加载的配置&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;NFLoadBalancerRuleClassName&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;创建&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--14" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;font-size: 10px; color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerBuilder&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;服务端服务实例描述对象&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//负载均衡器配置&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IClientConfig &lt;b&gt;config&lt;/b&gt; = ClientConfigFactory&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.findDefaultConfigFactory().newConfig();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerListFilter &lt;b&gt;serverListFilter&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;//配置中定义的负载均衡规则&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IRule &lt;b&gt;rule&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IPing ping = new DummyPing();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerList &lt;b&gt;serverListImpl&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerListUpdater serverListUpdater;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;//传入类名，根据客户端配置config 实例化类&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IClientConfigAware.Factory &lt;b&gt;factory&lt;/b&gt; =&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ClientFactory::instantiateInstanceWithClientConfig;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-720" y="80" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--16" target="8GXi-stoHSAcCtSXBaf--21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--16" value="IClientConfig config = ClientConfigFactory&lt;br&gt;.findDefaultConfigFactory().newConfig();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如过没其他提名默认加载配置 &lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--17" value="LoadBalancerBuilder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="555" y="130" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--18" value="&lt;b&gt;FeignOptionsClientConfig&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SpringCloudFeign中重写了ribbon-core中默认配置类DefaultClientConfigImpl，参考 spring-cloud-openfeign-core&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--21" target="8GXi-stoHSAcCtSXBaf--26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--21" target="8GXi-stoHSAcCtSXBaf--28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--21" value="&lt;b&gt;SPI机制&lt;/b&gt;加载&amp;nbsp;&lt;b&gt;ClientConfigFactory&lt;/b&gt;.class&lt;br&gt;并按&amp;nbsp;getPriority() 方法返回的优先级排序，返回优先级最高的" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--22" value="&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;如果引入了ribbon-archaius，会提名com.netflix.client.config.ArchaiusClientConfigFactory&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;(&lt;b&gt;注意&lt;/b&gt;创建的配置类名字也是DefaultClientConfigImpl&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;但是和ribbon-core中的类不是同一个类)&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;如果没有提名，默认使用 DefaultClientConfigFactory&lt;/span&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1440.5" y="160" width="490" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=diamondThin;endFill=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--24" target="8GXi-stoHSAcCtSXBaf--14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--24" value="&lt;div style=&quot;text-align: center; font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#000000&quot;&gt;ribbon-&lt;b style=&quot;&quot;&gt;archaius&lt;/b&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;background-color: initial; font-size: 11px;&quot; color=&quot;#000000&quot;&gt;com.netflix.client.config&lt;/font&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 0, 0);&quot;&gt;.&lt;/span&gt;&lt;b style=&quot;background-color: initial; color: rgb(0, 0, 0);&quot;&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;默认的负载均衡器配置&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;propertyNameSpace = &quot;ribbon&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;vipResolver = null&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;internalProperties = {ConcurrentHashMap@1071}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;dynamicProperties = {ConcurrentHashMap@1072}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;changeActions = {ConcurrentHashMap@1073}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;refreshCounter = {AtomicLong@1074} &quot;0&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;resolver = {ArchaiusPropertyResolver@1075}&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;clientName = &quot;&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;namespace = &quot;ribbon&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;isDynamic = false&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;cachedToString = &quot;ClientConfig:&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="80" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--26" target="8GXi-stoHSAcCtSXBaf--29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--26" value="&lt;b&gt;ArchaiusClientConfigFactory&lt;/b&gt;#&lt;br&gt;newConfig()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--28" target="8GXi-stoHSAcCtSXBaf--30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--28" value="&lt;b&gt;DefaultClientConfigFactory&lt;/b&gt;#&lt;br&gt;newConfig()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--29" value="&lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;br&gt;extends AbstractDefaultClientConfigImpl&lt;br&gt;extends ReloadableClientConfig&lt;br&gt;implements IClientConfig&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;测试DEMO中加载的这个配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--30" value="&lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;br&gt;implements IClientConfig" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--33" target="8GXi-stoHSAcCtSXBaf--34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--33" target="8GXi-stoHSAcCtSXBaf--36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--33" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;String ruleClassName = config.getOrDefault(IClientConfigKey.Keys.&lt;br&gt;NFLoadBalancerRuleClassName);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--34" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;NFLoadBalancerRuleClassName = new &lt;b&gt;CommonClientConfigKey&lt;/b&gt;&amp;lt;String&amp;gt;(&quot;NFLoadBalancerRuleClassName&quot;, &quot;com.netflix.loadbalancer.&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;AvailabilityFilteringRule&lt;/b&gt;&quot;) {&lt;span style=&quot;background-color: initial;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="990" y="400" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--36" target="8GXi-stoHSAcCtSXBaf--38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--36" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;rule = (IRule) factory.create(ruleClassName, config);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--38" target="8GXi-stoHSAcCtSXBaf--135" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--38" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;AvailabilityFilteringRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#3333ff&quot; size=&quot;1&quot;&gt;继承&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#3333ff&quot; size=&quot;1&quot;&gt;ClientConfigEnabledRoundRobinRule&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--39" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;BestAvailableRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;align=center;" parent="1" source="8GXi-stoHSAcCtSXBaf--42" target="8GXi-stoHSAcCtSXBaf--43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--42" target="8GXi-stoHSAcCtSXBaf--89" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--42" value="&lt;div&gt;&lt;/div&gt;BaseLoadBalancer lb = new BaseLoadBalancer(config, rule, ping);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--43" value="&lt;div&gt;&lt;/div&gt;lb.&lt;b&gt;setServersList&lt;/b&gt;(servers);&lt;br&gt;return lb;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--44" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ClientConfigEnabledRoundRobinRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--45" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RandomRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--46" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ResponseTimeWeightedRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--47" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RetryRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--49" target="8GXi-stoHSAcCtSXBaf--145" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--49" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RoundRobinRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;轮询&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--50" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;WeightedResponseTimeRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--51" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ZoneAvoidanceRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--52" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;NacosRule&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--53" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="980" y="480" width="10" height="700" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--54" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ribbon-core&lt;br&gt;定义的负载均衡规则&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="880" y="810" width="110" height="40" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--55" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLoadBalancerRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-665" y="441" width="235" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--56" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AvailabilityFilteringRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-954" y="684" width="214" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--57" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BestAvailableRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-842" y="620" width="174" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--58" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ClientConfigEnabledRoundRobinRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;RoundRobinRule &lt;b&gt;roundRobinRule&lt;/b&gt; = new RoundRobinRule();&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1006" y="522" width="310" height="58" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--59" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br/&gt;&lt;b&gt;IRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-590" y="360" width="85" height="39" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--60" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;PredicateBasedRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1052" y="620" width="190" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--61" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RandomRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-537" y="522" width="140" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--62" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ResponseTimeWeightedRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-556" y="603" width="248" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--63" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RetryRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-676" y="522" width="119" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--64" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RoundRobinRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-377" y="522" width="168" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--65" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;WeightedResponseTimeRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-288" y="603" width="248" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--66" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ZoneAvoidanceRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1162" y="684" width="188" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--67" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=#008200;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--55" target="8GXi-stoHSAcCtSXBaf--59" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--68" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--56" target="8GXi-stoHSAcCtSXBaf--60" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-847" y="670" />
              <mxPoint x="-957" y="670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--69" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--57" target="8GXi-stoHSAcCtSXBaf--58" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-755" y="600" />
              <mxPoint x="-851" y="600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--70" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--58" target="8GXi-stoHSAcCtSXBaf--55" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-851" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--71" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--60" target="8GXi-stoHSAcCtSXBaf--58" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-957" y="600" />
              <mxPoint x="-851" y="600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--72" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--61" target="8GXi-stoHSAcCtSXBaf--55" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-467" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--73" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--62" target="8GXi-stoHSAcCtSXBaf--64" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-432" y="578" />
              <mxPoint x="-293" y="578" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--74" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--63" target="8GXi-stoHSAcCtSXBaf--55" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-617" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--75" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--64" target="8GXi-stoHSAcCtSXBaf--55" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-293" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--76" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--65" target="8GXi-stoHSAcCtSXBaf--64" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-164" y="578" />
              <mxPoint x="-293" y="578" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--77" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--66" target="8GXi-stoHSAcCtSXBaf--60" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1068" y="670" />
              <mxPoint x="-957" y="670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--78" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-466" y="762" width="204" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--79" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BaseLoadBalancer (核心类)&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认RoundRobinRule&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected &lt;b&gt;IRule&lt;/b&gt; &lt;b&gt;rule&lt;/b&gt; = DEFAULT_RULE;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认SerialPingStrategy&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected IPingStrategy &lt;b&gt;pingStrategy&lt;/b&gt; = DEFAULT_PING_STRATEGY;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected IPing &lt;b&gt;ping&lt;/b&gt; = null;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;@Monitor(name = PREFIX + &quot;AllServerList&quot;, type = DataSourceType.INFORMATIONAL)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//所有服务实例列表&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected volatile List&amp;lt;Server&amp;gt; &lt;b&gt;allServerList&lt;/b&gt; = Collections&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.synchronizedList(new ArrayList&amp;lt;Server&amp;gt;());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;@Monitor(name = PREFIX + &quot;UpServerList&quot;, type = DataSourceType.INFORMATIONAL)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//可用的服务实例列表&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected volatile List&amp;lt;Server&amp;gt; &lt;b&gt;upServerList&lt;/b&gt; = Collections&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.synchronizedList(new ArrayList&amp;lt;Server&amp;gt;());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected ReadWriteLock &lt;b&gt;allServerLock&lt;/b&gt; = new ReentrantReadWriteLock();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected ReadWriteLock &lt;b&gt;upServerLock&lt;/b&gt; = new ReentrantReadWriteLock();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认default&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected String &lt;b&gt;name&lt;/b&gt; = DEFAULT_NAME;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected Timer &lt;b&gt;lbTimer&lt;/b&gt; = null;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected int &lt;b&gt;pingIntervalSeconds&lt;/b&gt; = 10;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected int &lt;b&gt;maxTotalPingTimeSeconds&lt;/b&gt; = 5;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected Comparator&amp;lt;Server&amp;gt; &lt;b&gt;serverComparator&lt;/b&gt; = new ServerComparator();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected AtomicBoolean &lt;b&gt;pingInProgress&lt;/b&gt; = new AtomicBoolean(false);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected LoadBalancerStats &lt;b&gt;lbStats&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private volatile Counter &lt;b&gt;counter&lt;/b&gt; = Monitors.newCounter(&quot;LoadBalancer_ChooseServer&quot;);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private PrimeConnections &lt;b&gt;primeConnections&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private volatile boolean &lt;b&gt;enablePrimingConnections&lt;/b&gt; = false;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private IClientConfig &lt;b&gt;config&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private List&amp;lt;ServerListChangeListener&amp;gt; &lt;b&gt;changeListeners&lt;/b&gt; = new CopyOnWriteArrayList&amp;lt;ServerListChangeListener&amp;gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private List&amp;lt;ServerStatusChangeListener&amp;gt; &lt;b&gt;serverStatusListeners&lt;/b&gt; =&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new CopyOnWriteArrayList&amp;lt;ServerStatusChangeListener&amp;gt;();&lt;/font&gt;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-570" y="841" width="530" height="379" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--80" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DynamicServerListLoadBalancer&lt;T&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-456.5" y="1240" width="303" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--81" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br/&gt;&lt;b&gt;ILoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-438" y="681" width="149" height="39" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--82" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;NoOpLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-800" y="840" width="185" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--83" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ZoneAwareLoadBalancer&lt;T&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-430" y="1310" width="250" height="33" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--84" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=#008200;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--78" target="8GXi-stoHSAcCtSXBaf--81" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--85" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--79" target="8GXi-stoHSAcCtSXBaf--78" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-305" y="818" />
              <mxPoint x="-364" y="818" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--86" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--80" target="8GXi-stoHSAcCtSXBaf--79" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="-305" y="1230" as="sourcePoint" />
            <mxPoint x="-295" y="1340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--87" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--82" target="8GXi-stoHSAcCtSXBaf--78" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-707" y="818" />
              <mxPoint x="-364" y="818" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--88" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;entryX=0.500;entryY=1.001;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--83" target="8GXi-stoHSAcCtSXBaf--80" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="-305" y="1330" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--89" value="&lt;div&gt;&lt;/div&gt;initWithConfig(config, rule, ping, createLoadBalancerStatsFromConfig(config, ClientFactory&lt;br&gt;::instantiateInstanceWithClientConfig));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--90" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;rule = {AvailabilityFilteringRule@1239}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingStrategy = {BaseLoadBalancer$SerialPingStrategy@1255}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;ping = {DummyPing@1082}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;allServerList = {ArrayList@1962}&amp;nbsp; size = 3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;upServerList = {ArrayList@1962}&amp;nbsp; size = 3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;allServerLock = {ReentrantReadWriteLock@1267} &quot;java.util.concurrent.locks.ReentrantReadWriteLock@473b46c3[Write locks = 0, Read locks = 0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;upServerLock = {ReentrantReadWriteLock@1270} &quot;java.util.concurrent.locks.ReentrantReadWriteLock@516be40f[Write locks = 0, Read locks = 0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;name = &quot;&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;lbTimer = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingIntervalSeconds = 30&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;maxTotalPingTimeSeconds = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;serverComparator = {ServerComparator@1283}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingInProgress = {AtomicBoolean@1287} &quot;false&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;lbStats = {LoadBalancerStats@1402} &quot;Zone stats: {},Server stats: []&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;counter = {BasicCounter@1311} &quot;BasicCounter{config=MonitorConfig{name=LoadBalancer_ChooseServer, tags=COUNTER, policy=DefaultPublishingPolicy}, count=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;primeConnections = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;enablePrimingConnections = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;config = {DefaultClientConfigImpl@1039} &quot;ClientConfig:&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;changeListeners = {CopyOnWriteArrayList@1317}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;serverStatusListeners = {CopyOnWriteArrayList@1320}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="740" y="1360" width="770" height="250" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--93" target="8GXi-stoHSAcCtSXBaf--94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--92" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--93" target="8GXi-stoHSAcCtSXBaf--99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--93" value="urlLoadBalancer.call(&quot;/&quot;)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--94" value="urlLoadBalancer.getLoadBalancerStats()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--99" target="8GXi-stoHSAcCtSXBaf--100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--96" value="选取服务节点后回调" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="8GXi-stoHSAcCtSXBaf--95" vertex="1" connectable="0">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--97" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--99" target="8GXi-stoHSAcCtSXBaf--104" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--98" value="submit() 实现" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="8GXi-stoHSAcCtSXBaf--97" vertex="1" connectable="0">
          <mxGeometry x="0.05" y="-4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--99" value="LoadBalancerCommand.&amp;lt;String&amp;gt;builder()&lt;br&gt;.withLoadBalancer(loadBalancer)&lt;br&gt;.build().&lt;b&gt;submit&lt;/b&gt;(new ServerOperation&amp;lt;String&amp;gt;() {...})&lt;br&gt;.toBlocking().&lt;b&gt;first&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--100" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;url = new URL(&quot;http://&quot; + server.getHost() + &quot;:&quot; + server.getPort() + path);&lt;br&gt;HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;return Observable.just(conn.getResponseMessage());&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1620" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--101" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerCommand&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;每个对象表示一次负载均衡调用执行&lt;br&gt;选择Sever -&amp;gt; 调用call(Server) -&amp;gt; 调用ExecutionListener &lt;br&gt;(如果有的话) -&amp;gt; call异常重试 -&amp;gt; 提供反馈信息到LoadBalancerStats&lt;br&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;private final URI&amp;nbsp; &amp;nbsp; loadBalancerURI;&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final Object loadBalancerKey;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//里面主要是LoadBalancer实例&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final LoadBalancerContext &lt;b&gt;loadBalancerContext&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final RetryHandler &lt;b&gt;retryHandler&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private volatile ExecutionInfo executionInfo;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//如果没有手动指定server就为null, 通过selectServer()选取一个服务实例&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final Server &lt;b&gt;server&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//监听Command执行生命周期：onExecutionStart()&amp;nbsp;onStartWithServer()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//onExceptionWithServer()&amp;nbsp;onExecutionSuccess()&amp;nbsp;onExecutionFailed()&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final ExecutionContextListenerInvoker&amp;lt;?, T&amp;gt; &lt;b&gt;listenerInvoker&lt;/b&gt;;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1200" y="760" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--102" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;响应式回调，这里并没有异步调用&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="775" y="1680" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--103" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--104" target="8GXi-stoHSAcCtSXBaf--106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--104" value="final ExecutionInfoContext context = new ExecutionInfoContext();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--105" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--106" target="8GXi-stoHSAcCtSXBaf--108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--106" value="if (listenerInvoker != null) {&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;listenerInvoker&lt;/b&gt;.onExecutionStart();&lt;br&gt;}" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--108" target="8GXi-stoHSAcCtSXBaf--112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--108" value="&lt;div&gt;final int maxRetrysSame = retryHandler.getMaxRetriesOnSameServer();&lt;/div&gt;&lt;div&gt;final int maxRetrysNext = retryHandler.getMaxRetriesOnNextServer();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="1860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--112" target="8GXi-stoHSAcCtSXBaf--114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--110" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--112" target="8GXi-stoHSAcCtSXBaf--116" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--111" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--112" target="8GXi-stoHSAcCtSXBaf--118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--112" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;Observable&amp;lt;T&amp;gt; &lt;b&gt;o&lt;/b&gt; =&amp;nbsp;(server == null ? &lt;b&gt;selectServer&lt;/b&gt;() : Observable.just(server))&lt;br&gt;.&lt;b&gt;concatMap&lt;/b&gt;(new Func1&amp;lt;Server, Observable&amp;lt;T&amp;gt;&amp;gt;() {...})&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--113" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--114" target="8GXi-stoHSAcCtSXBaf--124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--114" value="&lt;font size=&quot;1&quot;&gt;selectServer()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--115" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--116" target="8GXi-stoHSAcCtSXBaf--100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--116" value="operation.call(server)&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;核心是调用请求，另外还有一些请求次数记录、监听通知、状态记录等操作，略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="760" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--117" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--118" target="8GXi-stoHSAcCtSXBaf--120" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--118" value="&lt;div&gt;if (maxRetrysNext &amp;gt; 0 &amp;amp;&amp;amp; server == null)&amp;nbsp;&lt;/div&gt;&lt;div&gt;o = o.&lt;b&gt;retry&lt;/b&gt;(retryPolicy(maxRetrysNext, false));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#3333ff&quot;&gt;通过RxJava接口设置重试策略&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="510" y="2100" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--120" target="8GXi-stoHSAcCtSXBaf--151" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--120" value="return o.&lt;b&gt;onErrorResumeNext&lt;/b&gt;(new Func1&amp;lt;Throwable, Observable&amp;lt;T&amp;gt;&amp;gt;() {...});&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;如果前面发生错误，会执行这里面的逻辑&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--121" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;如果没有指定LoadBalancerCommand server&lt;br&gt;就通过selectServer() 选择一个&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="300" y="1950" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--122" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;ExecutionContextListenerInvoker &lt;br&gt;用于监听Command执行生命周期：onExecutionStart() &lt;br&gt;onStartWithServer()&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;onExceptionWithServer() &lt;br&gt;onExecutionSuccess() onExecutionFailed()&lt;/span&gt;&amp;nbsp;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="260" y="1775" width="260" height="70" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--123" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--124" target="8GXi-stoHSAcCtSXBaf--128" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--124" value="&lt;font size=&quot;1&quot;&gt;Server server = loadBalancerContext&lt;br&gt;.getServerFromLoadBalancer(&lt;br&gt;loadBalancerURI, loadBalancerKey);&lt;br&gt;...&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--125" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--126" target="8GXi-stoHSAcCtSXBaf--101" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--126" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerContext&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;负载均衡器上下文，来自于&amp;nbsp;LoadBalancerCommand$Builder&lt;br&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected String clientName = &quot;default&quot;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected String vipAddresses;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected int maxAutoRetriesNextServer = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.MaxAutoRetriesNextServer.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected int maxAutoRetries = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.MaxAutoRetries.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected RetryHandler defaultRetryHandler =&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new DefaultLoadBalancerRetryHandler();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected boolean okToRetryOnAllOperations = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.OkToRetryOnAllOperations.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;private ILoadBalancer &lt;b&gt;lb&lt;/b&gt;;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;private volatile Timer tracer;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1600" y="760" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--127" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--128" target="8GXi-stoHSAcCtSXBaf--131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--128" value="&lt;font size=&quot;1&quot;&gt;Server svc = lb.chooseServer(loadBalancerKey);&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--129" value="BaseLoadBalancer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1281" y="1910" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--131" target="8GXi-stoHSAcCtSXBaf--133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--131" value="&lt;div&gt;if (counter == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; counter = createCounter();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;counter.increment();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--132" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--133" target="8GXi-stoHSAcCtSXBaf--135" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="2050" />
              <mxPoint x="1700" y="1270" />
              <mxPoint x="1221" y="1270" />
              <mxPoint x="1221" y="525" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--133" value="return rule.choose(key);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;具体参考各种负载均衡规则的实现&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--135" target="8GXi-stoHSAcCtSXBaf--138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--135" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&lt;b&gt;choose&lt;/b&gt;(Object key)&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--138" target="8GXi-stoHSAcCtSXBaf--140" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--137" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="8GXi-stoHSAcCtSXBaf--138" target="8GXi-stoHSAcCtSXBaf--145" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="510" />
              <mxPoint x="1700" y="650" />
              <mxPoint x="1230" y="650" />
              <mxPoint x="1230" y="1005" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--138" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;int count = 0;&lt;/div&gt;&lt;div&gt;Server server = &lt;b&gt;roundRobinRule&lt;/b&gt;.choose(key);&lt;/div&gt;&lt;div&gt;while (count++ &amp;lt;= 10) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (server != null &amp;amp;&amp;amp; &lt;b&gt;predicate&lt;/b&gt;.apply(new PredicateKey(server))) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return server;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; server = roundRobinRule.choose(key);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1480" y="460" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--140" target="8GXi-stoHSAcCtSXBaf--142" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--140" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;return super.choose(key);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;使用 PredicateBasedRule 选择Server&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1480" y="581" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--141" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即先使用RoundRobinRule选择一个Server, &lt;/font&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 127, 255);&quot;&gt;然后使用服务可用性断言进行校验，校验失败重试（最多10次）&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 127, 255);&quot;&gt;经过10次还是失败则使用 PredicateBasedRule 选择Server&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#3333ff&quot;&gt;&lt;b&gt;之所以这么实现主要是因为服务不可用是小概率事件，异常的服务实例往往占据很小一部分&lt;br&gt;而直接对所有服务进行可用性校验是很耗费性能的事&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1690" y="465" width="420" height="90" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--142" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ILoadBalancer lb = getLoadBalancer();&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;Optional&amp;lt;Server&amp;gt; server = getPredicate()&lt;br&gt;.chooseRoundRobinAfterFiltering(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;lb.getAllServers(), key);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1720" y="581" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--143" value="PredicateBasedRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1755" y="551" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--144" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8GXi-stoHSAcCtSXBaf--145" target="8GXi-stoHSAcCtSXBaf--146" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--145" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;choose(Object key)&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--146" value="&lt;div style=&quot;&quot;&gt;while循环（最多10次）从&amp;nbsp;lb.getAllServers()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;中用RoundRobin算法选择一个Server实例&lt;br&gt;如果&amp;nbsp;server.&lt;b&gt;isAlive&lt;/b&gt;() &amp;amp;&amp;amp; (server.&lt;b&gt;isReadyToServe&lt;/b&gt;()) 就返回否则重试&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--147" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;先对所有服务进行可用性校验，过滤出&lt;br&gt;合格的Server列表再用RoundRobin算法选择&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1920" y="590.5" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--148" value="AvailabilityFilteringRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1505" y="430" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--149" value="RoundRobinRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1524" y="930" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--150" value="TODO" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1690" y="975" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="8GXi-stoHSAcCtSXBaf--151" value="只是额外封装些错误信息，通知监听器&lt;br&gt;listenerInvoker.onExecutionFailed(...)&lt;br&gt;最后&amp;nbsp;return Observable.error(e);&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;这部分不需要关注&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="760" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
