<mxfile host="Electron" modified="2024-05-13T12:43:31.215Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="fyy5hws4vc_kQXEadvAJ" version="21.6.5" type="device">
  <diagram id="C5RBs43oDa-KdzZeNtuy" name="Redisson订阅发布">
    <mxGraphModel dx="5569" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="04FaCHAl2gqULPaclR8Y-38" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-34" target="04FaCHAl2gqULPaclR8Y-96" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4200" y="2881.25" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="4220" y="2881" />
              <mxPoint x="4220" y="2000" />
              <mxPoint x="1801" y="2000" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-13" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2760" y="1090" width="160" height="140" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-118" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-87" target="wK_E6LMROi6GtL9PwVPp-117" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4729.95" y="890" as="sourcePoint" />
            <mxPoint x="1750.0026315789476" y="1420" as="targetPoint" />
            <Array as="points">
              <mxPoint x="4720" y="890" />
              <mxPoint x="2120" y="890" />
              <mxPoint x="2120" y="1150" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="I3S7IV9glcu-AFgagqgy-0" value="&lt;h1&gt;Redisson 订阅/发布原理（3.29.0）&lt;/h1&gt;&lt;div&gt;Redisson 订阅/发布封装原理实现其实很简单，下面逻辑看上去复杂，其实大部分篇幅是在讲Redisson客户端连接管理逻辑&lt;/div&gt;&lt;p&gt;前置知识：&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Netty 工作流程&lt;/span&gt;&lt;br&gt;&lt;/li&gt;&lt;li&gt;Redisson Future 模式（下面代码可以看到所有操作都是&lt;b&gt;异步非阻塞&lt;/b&gt;的），&lt;font color=&quot;#007fff&quot;&gt;RFuture、RPromise， 依赖 Netty Promise、JDK CompletableFuture&lt;/font&gt;&lt;/li&gt;&lt;li&gt;Redis RESP 协议（是客户端与服务器交互数据的序列化协议）&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;单纯看RESP官方文档有点难理解（例子太少），结合源码看会发现RESP协议很简单&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="19" width="920" height="181" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-6" target="1BqWvLZb_9bfCdM7f6yn-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;fontSize=11;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-6" target="1BqWvLZb_9bfCdM7f6yn-17" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-340" y="1500" />
              <mxPoint x="-620" y="1500" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RedissonExpirable (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;拓展超时方法实现，由于Redisson大部分对象都需要支持超时方法，&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;Redisson大部分对象类都继承此类&lt;/span&gt;&lt;/p&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="1520" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-9" target="1BqWvLZb_9bfCdM7f6yn-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-9" target="1BqWvLZb_9bfCdM7f6yn-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-460" y="1360" />
              <mxPoint x="-460" y="1000" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RedissonObject (A)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//命令异步执行器，其实封装了&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final &lt;b&gt;CommandAsyncExecutor&lt;/b&gt; &lt;b&gt;commandExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象名字&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected String &lt;b&gt;name&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象使用的编解码器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;protected final Codec &lt;b&gt;codec&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="1320" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-11" target="1BqWvLZb_9bfCdM7f6yn-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RObject (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;定义Redisson对象的基本方法（这里定义同步方法），Redisson对象的核心接口，Redisson所有对象都实现此接口&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取对象空闲时间（s），即从上次读写到现在的秒数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Long getIdleTime();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//更新对象最后访问时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean touch();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象在Redis中占用内存大小（按bytes计算）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long sizeInMemory();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Redisson对象的一些序列化和反序列化方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void restore(byte[] state);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;byte[] dump();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象迁移、复制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void migrate(String host, int port, int database, long timeout);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void copy(String host, int port, int database, long timeout);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean move(int database);&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象基本操作方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;String getName();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean delete();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean unlink();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void rename(String newName);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean renamenx(String newName);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean isExists();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Codec getCodec();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对象监听器相关，具体参考各种监听器实现类&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int addListener(ObjectListener listener);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void removeListener(int listenerId);&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="880" width="400" height="400" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-12" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RObjectAsync (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;拓展 RObject&amp;nbsp;&lt;b&gt;异步&lt;/b&gt;接口方法，返回 RFuture&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="760" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-14" target="1BqWvLZb_9bfCdM7f6yn-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RExpirableAsync (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;拓展 RExpirable 异步接口方法，返回 RFuture&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-760" y="880" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-17" target="1BqWvLZb_9bfCdM7f6yn-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-17" target="1BqWvLZb_9bfCdM7f6yn-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-17" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RExpirable (I)&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;为对象定义超时方法（TTL）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean expire(Instant time);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean expireIfSet(Instant time);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean expire(Duration duration);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;boolean clearExpire();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long remainTimeToLive();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getExpireTime();&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-760" y="1320" width="280" height="160" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-18" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CommandAsyncExecutor&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Redis命令异步执行器，Redisson提供了异步、批量异步、响应式（基于Reactor、RxJava）多种实现&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1120" y="960" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-23" target="1BqWvLZb_9bfCdM7f6yn-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-1000" y="1080" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-20" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;ConnectionManager&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;连接管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//部分关键接口方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//其实是启动Netty客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;connect&lt;/b&gt;();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void shutdown();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//获取发布订阅服务&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;PublishSubscribeService getSubscribeService();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//集群模式计算槽位&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;int calcSlot(String key);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主从服务节点Entry集合&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Collection&amp;lt;MasterSlaveEntry&amp;gt; getEntrySet();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//创建Redis连接（RedisClient）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;RedisClient &lt;b&gt;createClient&lt;/b&gt;(NodeType type, InetSocketAddress address, RedisURI uri, String sslHostname);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;RedisClient &lt;b&gt;createClient&lt;/b&gt;(NodeType type, RedisURI address, String sslHostname);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;b&gt;ServiceManager&lt;/b&gt;(Netty客户端 + ExecutorService + Redis Server 配置)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;ServiceManager&lt;/b&gt; getServiceManager();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//创建命令执行器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;CommandAsyncExecutor &lt;b&gt;createCommandExecutor&lt;/b&gt;(RedissonObjectBuilder objectBuilder,&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;RedissonObjectBuilder.ReferenceType referenceType);&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1640" y="160" width="400" height="360" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-21" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ServiceManager&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Netty 服务器配置等信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接事件中心，可以在这里面注册连接事件监听器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConnectionEventsHub &lt;b&gt;connectionEventsHub&lt;/b&gt; = new &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConnectionEventsHub();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final String &lt;b&gt;id&lt;/b&gt; = UUID.randomUUID().toString();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端事件循环线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final EventLoopGroup &lt;b&gt;group&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Class&amp;lt;? extends SocketChannel&amp;gt; &lt;b&gt;socketChannelClass&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AddressResolverGroup&amp;lt;InetSocketAddress&amp;gt; &lt;b&gt;resolverGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty客户端工作者线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExecutorService &lt;b&gt;executor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Config &lt;b&gt;cfg&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MasterSlaveServersConfig &lt;b&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于重试的定时器，本质还是线程+队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;HashedWheelTimer&lt;/b&gt; &lt;b&gt;timer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//向EventLoopGroup中注册监视空闲连接的定时任务，用于自动释放超时的空闲连接&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private IdleConnectionWatcher &lt;b&gt;connectionWatcher&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean shutdownLatch = new AtomicBoolean();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ElementsSubscribeService &lt;b&gt;elementsSubscribeService&lt;/b&gt; = new &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ElementsSubscribeService(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NatMapper &lt;b&gt;natMapper&lt;/b&gt; = NatMapper.direct();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Map&amp;lt;InetSocketAddress, Set&amp;lt;String&amp;gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;SCRIPT_SHA_CACHE&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Map&amp;lt;String, String&amp;gt; &lt;b&gt;SHA_CACHE&lt;/b&gt; =&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;new LRUCacheMap&amp;lt;&amp;gt;(500, 0, 0);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String, ResponseEntry&amp;gt; &lt;b&gt;responses&lt;/b&gt; = new &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final QueueTransferService &lt;b&gt;queueTransferService&lt;/b&gt; = new &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;QueueTransferService();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2080" y="480" width="400" height="470" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-23" target="1BqWvLZb_9bfCdM7f6yn-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-23" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CommandAsyncService&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;异步执行器实现，其他几种执行器全都继承这个类，说明所有执行器都是异步的&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final Codec codec;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;//连接管理器，就是保存连接的容器类对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;ConnectionManager&lt;/b&gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;connectionManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final RedissonObjectBuilder objectBuilder;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final RedissonObjectBuilder.ReferenceType referenceType;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final int retryAttempts;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final int retryInterval;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final int responseTimeout;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final boolean trackChanges;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1200" y="1080" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-25" target="1BqWvLZb_9bfCdM7f6yn-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-25" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CommandBatchService&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;批量执行器实现（也是异步的）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger index = new AtomicInteger();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;NodeSource, Entry&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;commands&lt;/b&gt;&amp;nbsp;= new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Map&amp;lt;MasterSlaveEntry, Entry&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;aggregatedCommands&lt;/b&gt;&amp;nbsp;= Collections.emptyMap();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;MasterSlaveEntry, ConnectionEntry&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;connections&lt;/b&gt;&amp;nbsp;= new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final BatchOptions options;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;CompletableFuture&amp;lt;?&amp;gt;, List&amp;lt;CommandBatchService&amp;gt;&amp;gt; nestedServices = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean executed = new AtomicBoolean();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final long retryInterval;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final int retryAttempts;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1200" y="1320" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;dashed=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-27" target="1BqWvLZb_9bfCdM7f6yn-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-57" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.003;exitY=0.604;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-27" target="1BqWvLZb_9bfCdM7f6yn-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.003;exitY=0.412;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-27" target="wK_E6LMROi6GtL9PwVPp-65" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1660" y="675" />
              <mxPoint x="-1660" y="380" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-27" target="ydMWs6PtdbeCtb3DKnso-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-27" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MasterSlaveConnectionManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;连接管理器基本实现，其他实现类都继承此实现，包括单机、主从复制&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;、哨兵、集群4种实现&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected DNSMonitor dnsMonitor;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected MasterSlaveServersConfig &lt;b&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//连接到Redis服务节点的对象，里面保存连接到某个节点的所有连接对象&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private MasterSlaveEntry &lt;b&gt;masterSlaveEntry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//发布订阅服务&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final PublishSubscribeService &lt;b&gt;subscribeService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//Netty服务器配置等&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final ServiceManager &lt;b&gt;serviceManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;RedisURI, RedisConnection&amp;gt; &lt;b&gt;nodeConnections&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final AtomicReference&amp;lt;CompletableFuture&amp;lt;Void&amp;gt;&amp;gt; lazyConnectLatch = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean lastAttempt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1640" y="560" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-29" target="1BqWvLZb_9bfCdM7f6yn-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-29" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SingleConnectionManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Redis单机模式连接管理器&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1640" y="1000" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="1BqWvLZb_9bfCdM7f6yn-31" target="1BqWvLZb_9bfCdM7f6yn-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1880" y="980" />
              <mxPoint x="-1440" y="980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="1BqWvLZb_9bfCdM7f6yn-31" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClusterConnectionManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Redis集群模式连接管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Integer, ClusterPartition&amp;gt; lastPartitions = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;RedisURI, ClusterPartition&amp;gt; lastUri2Partition = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile Timeout monitorFuture;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile RedisURI lastClusterNode;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private RedisStrictCommand&amp;lt;List&amp;lt;ClusterNodeInfo&amp;gt;&amp;gt; clusterNodesCommand;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private String configEndpointHostName;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//slot对应的服务节点&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReferenceArray&amp;lt;MasterSlaveEntry&amp;gt; slot2entry = new AtomicReferenceArray&amp;lt;&amp;gt;(MAX_SLOT);&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//服务节点也是多个&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;RedisClient, MasterSlaveEntry&amp;gt; &lt;b&gt;client2entry&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private ClusterServersConfig cfg;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final long seed = ThreadLocalRandom.current().nextLong();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2080" y="1000" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-0" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;Config&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//几种服务器模式配置&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//哨兵模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;SentinelServersConfig&lt;/b&gt; sentinelServersConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主从&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private MasterSlaveServersConfig masterSlaveServersConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//单机模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;SingleServerConfig&lt;/b&gt; &lt;b&gt;singleServerConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//集群模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;ClusterServersConfig&lt;/b&gt; &lt;b&gt;clusterServersConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主从复制&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ReplicatedServersConfig replicatedServersConfig;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private &lt;b&gt;ConnectionManager&lt;/b&gt; &lt;b&gt;connectionManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int threads = 16;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty事件循环线程数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int nettyThreads = 32;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Netty工作者线程池，不指定的话默认使用&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;Executors.newFixedThreadPool 创建（2*CPU核心数个线程）&lt;/font&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Executor &lt;b&gt;nettyExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Codec &lt;b&gt;codec&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService &lt;b&gt;executor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean referenceEnabled = true;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//通信模式，NIO（默认）、EPOLL、KQUEUE、IO_URING&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;，Linux系统下设置NIO、EPOLL本质相同&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private TransportMode &lt;b&gt;transportMode&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Redisson客户端（本质是Netty客户端）的事件循环线程池&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private EventLoopGroup &lt;b&gt;eventLoopGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//锁看门狗的超时时间ms&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;lockWatchdogTimeout&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;checkLockSyncedSlaves&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;slavesSyncTimeout&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private long &lt;b&gt;reliableTopicWatchdogTimeout&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;keepPubSubOrder&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;useScriptCache&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;minCleanUpDelay&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;maxCleanUpDelay&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;cleanUpKeysAmount&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private NettyHook &lt;b&gt;nettyHook&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private ConnectionListener &lt;b&gt;connectionListener&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean useThreadClassLoader;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private AddressResolverGroupFactory addressResolverGroupFactory;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean lazyInitialization;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//使用的数据序列化协议（不是网络通信协议），RESP2(默认)、RESP3&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private Protocol &lt;b&gt;protocol&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="40" width="400" height="680" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-1" target="wK_E6LMROi6GtL9PwVPp-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-1" target="wK_E6LMROi6GtL9PwVPp-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-1" value="Config配置对象初始化" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-2" value="new Config()&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;包括服务器、连接的很多配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-4" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-830" y="210" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-5" target="wK_E6LMROi6GtL9PwVPp-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-116" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-5" target="wK_E6LMROi6GtL9PwVPp-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-5" value="创建客户端连接" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-7" target="wK_E6LMROi6GtL9PwVPp-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-7" value="RedissonClient redisson&amp;nbsp; = Redisson.create(config);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-9" target="wK_E6LMROi6GtL9PwVPp-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-9" value="return new Redisson(config);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-11" target="wK_E6LMROi6GtL9PwVPp-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-20" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="wK_E6LMROi6GtL9PwVPp-19" vertex="1" connectable="0">
          <mxGeometry x="0.7871" y="-2" relative="1" as="geometry">
            <mxPoint x="-10" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-11" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;Redisson(Config config) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.config = config;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Config configCopy = new Config(config);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1 创建连接管理器，每种服务器模式都有对应的连接管理器实现&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;connectionManager&lt;/b&gt; = ConfigSupport&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;createConnectionManager&lt;/b&gt;(configCopy);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; RedissonObjectBuilder objectBuilder = null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (config.isReferenceEnabled()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;objectBuilder&lt;/b&gt; = new &lt;b&gt;RedissonObjectBuilder&lt;/b&gt;(this);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//3&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;commandExecutor&lt;/b&gt; = this.connectionManager&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;createCommandExecutor&lt;/b&gt;(&lt;span style=&quot;background-color: initial;&quot;&gt;objectBuilder, ReferenceType.DEFAULT);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;evictionScheduler&lt;/b&gt; = new EvictionScheduler(this.commandExecutor);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; this.&lt;b&gt;writeBehindService&lt;/b&gt; = new WriteBehindService(this.commandExecutor);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=3;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="230" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-13" target="wK_E6LMROi6GtL9PwVPp-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-13" target="wK_E6LMROi6GtL9PwVPp-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-13" target="1BqWvLZb_9bfCdM7f6yn-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b&gt;Redisson&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Redisson客户端实现类&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final EvictionScheduler &lt;b&gt;evictionScheduler&lt;/b&gt;;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final WriteBehindService &lt;b&gt;writeBehindService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接管理器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConnectionManager &lt;b&gt;connectionManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CommandAsyncExecutor &lt;b&gt;commandExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;Class&amp;lt;?&amp;gt;, Class&amp;lt;?&amp;gt;&amp;gt; &lt;b&gt;liveObjectClassCache&lt;/b&gt; = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Config &lt;b&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1120" y="160" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-14" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;Config默认值：&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;sentinelServersConfig = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;masterSlaveServersConfig = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;singleServerConfig = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;clusterServersConfig = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;replicatedServersConfig = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;connectionManager = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;threads = 16&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;nettyThreads = 32&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;nettyExecutor = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;codec = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;executor = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;referenceEnabled = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;transportMode = {TransportMode@3456} &quot;NIO&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;eventLoopGroup = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;lockWatchdogTimeout = 30000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;checkLockSyncedSlaves = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;slavesSyncTimeout = 1000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;reliableTopicWatchdogTimeout = 600000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;keepPubSubOrder = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;useScriptCache = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;minCleanUpDelay = 5&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;maxCleanUpDelay = 1800&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;cleanUpKeysAmount = 100&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;nettyHook = {DefaultNettyHook@3457}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;connectionListener = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;useThreadClassLoader = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;addressResolverGroupFactory = {SequentialDnsAddressResolverFactory@3458}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;lazyInitialization = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;protocol = {Protocol@3452} &quot;RESP2&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-680" y="40" width="240" height="400" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-15" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;RedissonClient&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;包括创建连接、关闭连接、获取服务节点信息，以及获取各种&lt;b&gt;Redisson对象&lt;/b&gt;的方法。&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-1040" y="40" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-18" target="wK_E6LMROi6GtL9PwVPp-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-23" value="单机" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="wK_E6LMROi6GtL9PwVPp-22" vertex="1" connectable="0">
          <mxGeometry x="-0.5494" y="-3" relative="1" as="geometry">
            <mxPoint x="3" y="-23" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-18" target="wK_E6LMROi6GtL9PwVPp-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-26" value="集群" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="wK_E6LMROi6GtL9PwVPp-25" vertex="1" connectable="0">
          <mxGeometry x="0.1035" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-18" target="wK_E6LMROi6GtL9PwVPp-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-18" value="创建连接管理器&lt;br&gt;共有5种" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1159" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-21" target="wK_E6LMROi6GtL9PwVPp-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-21" value="cm = new &lt;b&gt;SingleConnectionManager&lt;/b&gt;(&lt;br&gt;configCopy.getSingleServerConfig(), configCopy);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-24" value="cm = new &lt;b&gt;ClusterConnectionManager&lt;/b&gt;(&lt;br&gt;configCopy.getClusterServersConfig(), configCopy);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-27" target="wK_E6LMROi6GtL9PwVPp-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-27" target="wK_E6LMROi6GtL9PwVPp-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-42" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-27" target="wK_E6LMROi6GtL9PwVPp-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-27" value="实例化过程中初始化的一些重要组件" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1640" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-59" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-30" target="wK_E6LMROi6GtL9PwVPp-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-30" value="&lt;div&gt;if (!configCopy.isLazyInitialization()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ((ConnectionManager)cm).&lt;b&gt;connect&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return (ConnectionManager)cm;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;非懒初始化，就立即执行连接，最多重试3次&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1159" y="680" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-33" value="private LoadBalancer loadBalancer = new RoundRobinLoadBalancer();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Redisson#config 中的loadBalancer&lt;/font&gt;&amp;nbsp;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1880" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-37" value="Redisson" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="905" y="200" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-38" target="wK_E6LMROi6GtL9PwVPp-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-38" value="this.&lt;b&gt;serviceManager&lt;/b&gt; = new &lt;b&gt;ServiceManager&lt;/b&gt;(this.config, configCopy);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1880" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-40" value="&lt;b&gt;subscribeService&lt;/b&gt; = new &lt;b&gt;PublishSubscribeService&lt;/b&gt;(this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1880" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-43" target="wK_E6LMROi6GtL9PwVPp-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-43" target="wK_E6LMROi6GtL9PwVPp-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-43" value="&lt;b&gt;Netty客户端初始化&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2120" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-45" value="this.&lt;b&gt;group&lt;/b&gt; = new NioEventLoopGroup(cfg.getNettyThreads(), new DefaultThreadFactory(&quot;&lt;b&gt;redisson-netty&lt;/b&gt;&quot;));&lt;br&gt;...&lt;br&gt;this.&lt;b&gt;socketChannelClass&lt;/b&gt; = NioSocketChannel.class;&lt;br&gt;this.&lt;b&gt;resolverGroup&lt;/b&gt; = cfg.getAddressResolverGroupFactory()&lt;br&gt;.create(NioDatagramChannel.class, socketChannelClass, DnsServerAddressStreamProviders.platformDefault());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2360" y="300" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-47" target="wK_E6LMROi6GtL9PwVPp-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-47" value="&lt;b&gt;initTimer&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;创建用于执行重试任务的定时器&lt;/b&gt;，&lt;br&gt;”线程+事件轮队列“实现&lt;br&gt;以及&lt;b&gt;提交空闲超时连接监视任务&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2120" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-49" value="ServiceManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2160" y="290" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-50" target="wK_E6LMROi6GtL9PwVPp-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-50" value="timer timer = new &lt;b&gt;HashedWheelTimer&lt;/b&gt;(new DefaultThreadFactory(&quot;redisson-timer&quot;), minTimeout, TimeUnit.MILLISECONDS, 1024, false);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2360" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-52" value="connectionWatcher = new &lt;b&gt;IdleConnectionWatcher&lt;/b&gt;(group, config);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;往Netty事件循环线程池中注册了一个定时任务，默认每隔10s检查一下空闲超时的连接并执行关闭&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2360" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-56" value="&lt;font color=&quot;#007fff&quot;&gt;连接并不是空闲超时后就直接关闭，而是有一个规则&lt;br&gt;不细说了&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2570" y="530" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-61" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-58" target="wK_E6LMROi6GtL9PwVPp-60" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-58" value="doConnect(new HashSet&amp;lt;&amp;gt;(), u -&amp;gt; null);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="690" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-67" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-60" target="wK_E6LMROi6GtL9PwVPp-66" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-68" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="wK_E6LMROi6GtL9PwVPp-67" vertex="1" connectable="0">
          <mxGeometry x="0.8608" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-60" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (config.isSlaveNotUsed()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; masterSlaveEntry = new &lt;b&gt;SingleEntry&lt;/b&gt;(this, config); &lt;font color=&quot;#007fff&quot;&gt;//单机模式，用于存储RedisConnection&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; masterSlaveEntry = new &lt;b&gt;MasterSlaveEntry&lt;/b&gt;(this, config); &lt;font color=&quot;#007fff&quot;&gt;//其他模式，&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;用于存储RedisConnection&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//从配置中解析Redis节点的连接uri&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; RedisURI uri = new RedisURI(config.getMasterAddress());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; String hostname = hostnameMapper.apply(uri);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;//1 创建到Redis Master节点的连接&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;&lt;b&gt;RedisClient&lt;/b&gt;&amp;gt; &lt;b&gt;masterFuture&lt;/b&gt; = masterSlaveEntry.&lt;b&gt;setupMasterEntry&lt;/b&gt;(uri, hostname);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; try {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//同步等待连接建立&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (config.getMasterConnectionMinimumIdleSize() == 0) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;masterFuture.join()&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;masterFuture&lt;/b&gt;.&lt;b&gt;get&lt;/b&gt;(config.getConnectTimeout()*config.getMasterConnectionMinimumIdleSize(), TimeUnit.MILLISECONDS);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (InterruptedException e) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Thread.currentThread().interrupt();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; } catch (ExecutionException | TimeoutException e) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new RedisConnectionException(e);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!config.isSlaveNotUsed()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;//创建到Redis Slave节点的连接&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;Void&amp;gt; &lt;b&gt;fs&lt;/b&gt; = masterSlaveEntry.&lt;b&gt;initSlaveBalancer&lt;/b&gt;(disconnectedSlaves, hostnameMapper);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... &lt;font color=&quot;#007fff&quot;&gt;// 和Master节点处理相同&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; //&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; startDNSMonitoring(masterFuture.getNow(null));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;} catch (Exception e) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; internalShutdown();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; throw e;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1640" y="590" width="440" height="500" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-62" value="MasterSlaveConnectionManager" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="660" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.001;exitY=0.271;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-65" target="wK_E6LMROi6GtL9PwVPp-93" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2100" y="236" />
              <mxPoint x="-2100" y="760" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.005;exitY=0.73;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-65" target="wK_E6LMROi6GtL9PwVPp-80" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2080" y="379" />
              <mxPoint x="-2080" y="380" />
              <mxPoint x="-2110" y="380" />
              <mxPoint x="-2110" y="360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.568;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-65" target="04FaCHAl2gqULPaclR8Y-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2110" y="330" />
              <mxPoint x="-2110" y="140" />
              <mxPoint x="-3200" y="140" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-65" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MasterSlaveEntry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;当前客户端（Redisson）连接到Redis各服务节点的状态对象，保存各节点信息以及到这个节点的连接对象（主要保存在连接池）&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;volatile &lt;b&gt;ClientConnectionsEntry&lt;/b&gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;masterEntry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;int references;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final MasterSlaveServersConfig&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final ConnectionManager&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;connectionManager&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//连接池本质是 ClientConnectionsEntry 的队列&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//存储规则：每个客户端可能连接多个节点，连接的每个节点又分为普通连接、发布订阅连接，每种连接又可能有个连接实例&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final MasterConnectionPool&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;masterConnectionPool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final MasterPubSubConnectionPool&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;masterPubSubConnectionPool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final PubSubConnectionPool&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;slavePubSubConnectionPool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final SlaveConnectionPool&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;slaveConnectionPool&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final Map&amp;lt;&lt;b&gt;RedisClient&lt;/b&gt;, &lt;b&gt;ClientConnectionsEntry&lt;/b&gt;&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;client2Entry&lt;/b&gt;&amp;nbsp;= new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final AtomicBoolean active = new AtomicBoolean(true);&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final AtomicBoolean noPubSubSlaves = new AtomicBoolean();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;volatile int availableSlaves = -1;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2080" y="160" width="400" height="300" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-66" target="wK_E6LMROi6GtL9PwVPp-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-66" value="CompletableFuture&amp;lt;RedisClient&amp;gt; masterFuture = masterSlaveEntry.&lt;b&gt;setupMasterEntry&lt;/b&gt;(&lt;br&gt;uri, hostname);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2120" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-72" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-69" target="wK_E6LMROi6GtL9PwVPp-71" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-74" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-69" target="wK_E6LMROi6GtL9PwVPp-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-69" value="RedisClient client = connectionManager.&lt;b&gt;createClient&lt;/b&gt;(&lt;br&gt;NodeType.MASTER, address, sslHostname);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;创建Netty客户端(bootstrap channels 等)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2360" y="630" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-71" target="wK_E6LMROi6GtL9PwVPp-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-71" value="return setupMasterEntry(client);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;真正的建立连接（Chanel），并缓存连接到连接池中&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2360" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-76" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-73" target="wK_E6LMROi6GtL9PwVPp-75" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-73" value="&lt;b&gt;RedisClient&lt;/b&gt; client = &lt;b&gt;createClient&lt;/b&gt;(type, address, config.getConnectTimeout(), config.getTimeout(), sslHostname);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2600" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-78" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-75" target="wK_E6LMROi6GtL9PwVPp-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-75" value="RedisClientConfig &lt;b&gt;redisConfig&lt;/b&gt; = createRedisConfig(type, address, timeout, commandTimeout, sslHostname);&lt;br&gt;return &lt;b&gt;RedisClient&lt;/b&gt;.&lt;b&gt;create&lt;/b&gt;(redisConfig);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2840" y="630" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-77" target="wK_E6LMROi6GtL9PwVPp-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-77" value="return new RedisClient(config);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3080" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-80" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RedisClient&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;客户端连接服务节点的信息(包括连接地址、两组通信服务Bootstrap)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于异步回调获取解析后的地址&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicReference&amp;lt;CompletableFuture&amp;lt;InetSocketAddress&amp;gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;resolvedAddrFuture&lt;/b&gt; = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//除pubsub外其他命令使用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Bootstrap &lt;b&gt;bootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//pubsub命令使用&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Bootstrap &lt;b&gt;pubSubBootstrap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final RedisURI &lt;b&gt;uri&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//解析后的连接地址&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private InetSocketAddress &lt;b&gt;resolvedAddr&lt;/b&gt;;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接的通道集合，可用于批处理、广播（已经关闭的通道会从这里自动删除）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final ChannelGroup &lt;b&gt;channels&lt;/b&gt;; &lt;font color=&quot;#007fff&quot;&gt;//看下哪里执行的 channels.add()&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private ExecutorService &lt;b&gt;executor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;commandTimeout&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Timer &lt;b&gt;timer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private RedisClientConfig &lt;b&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;hasOwnTimer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;hasOwnExecutor&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;hasOwnGroup&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private boolean &lt;b&gt;hasOwnResolver&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean &lt;b&gt;shutdown&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2520" y="160" width="400" height="400" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-84" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-81" target="wK_E6LMROi6GtL9PwVPp-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-81" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;RedisClientConfig &lt;b&gt;copy&lt;/b&gt; = new &lt;b&gt;RedisClientConfig&lt;/b&gt;(config);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//如果 timer group executor resolverGroup 为空则创建默认的&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;this.config = copy;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;this.executor = copy.&lt;b&gt;getExecutor&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;this.timer = copy.&lt;b&gt;getTimer&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;uri = copy.&lt;b&gt;getAddress&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;resolvedAddr = copy.&lt;b&gt;getAddr&lt;/b&gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;if (resolvedAddr != null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; resolvedAddrFuture.set(CompletableFuture.completedFuture(resolvedAddr));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//调用Netty接口创建客户端连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;channels = new &lt;b&gt;DefaultChannelGroup&lt;/b&gt;(copy.getGroup().next());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//向每个Redis节点创建了两个Bootstrap,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;bootstrap = &lt;b&gt;createBootstrap&lt;/b&gt;(copy, Type.PLAIN); &lt;font color=&quot;#007fff&quot;&gt;//对应RedisConnectionHandler&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;pubSubBootstrap = &lt;b&gt;createBootstrap&lt;/b&gt;(copy, Type.PUBSUB); &lt;font color=&quot;#007fff&quot;&gt;//对应RedisPubSubConnectionHandler&amp;nbsp;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;this.commandTimeout = copy.getCommandTimeout();&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3320" y="540" width="440" height="260" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-92" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-83" target="wK_E6LMROi6GtL9PwVPp-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-83" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Bootstrap bootstrap = new &lt;b&gt;Bootstrap&lt;/b&gt;()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .resolver(config.&lt;b&gt;getResolverGroup&lt;/b&gt;()) &lt;font color=&quot;#007fff&quot;&gt;//命名地址解析&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .channel(config.&lt;b&gt;getSocketChannelClass&lt;/b&gt;())&lt;font color=&quot;#007fff&quot;&gt; //Channel类型&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; .group(config.getGroup()); &lt;font color=&quot;#007fff&quot;&gt;//事件循环线程池&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;bootstrap.&lt;b&gt;handler&lt;/b&gt;(new &lt;b&gt;RedisChannelInitializer&lt;/b&gt;(bootstrap, config, this, channels, type));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, config.getConnectTimeout());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;bootstrap.option(ChannelOption.SO_KEEPALIVE, config.isKeepAlive());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;bootstrap.option(ChannelOption.TCP_NODELAY, config.isTcpNoDelay());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//应用通过&amp;nbsp;ExtendedSocketOptions 设置的选项&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;applyChannelOptions(config, bootstrap);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;config.getNettyHook().afterBoostrapInitialization(bootstrap);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;bootstrap&lt;/b&gt;;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3800" y="575" width="440" height="190" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-88" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-85" target="wK_E6LMROi6GtL9PwVPp-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-85" value="RedisChannelInitializer#initChannel()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4280" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-87" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;initSsl(config, ch);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (type == Type.PLAIN) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;RedisConnectionHandler&lt;/b&gt;(redisClient));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;RedisPubSubConnectionHandler&lt;/b&gt;(redisClient));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ch.pipeline().addLast(&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;connectionWatchdog&lt;/b&gt;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; new &lt;b style=&quot;font-size: 10px;&quot;&gt;CommandEncoder&lt;/b&gt;(config.getCommandMapper()),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 10px;&quot;&gt;CommandBatchEncoder&lt;/b&gt;.INSTANCE);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (type == Type.PLAIN) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;CommandsQueue&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;CommandsQueuePubSub&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (pingConnectionHandler != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(&lt;b style=&quot;font-size: 10px;&quot;&gt;pingConnectionHandler&lt;/b&gt;);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (type == Type.PLAIN) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new&lt;b style=&quot;font-size: 10px;&quot;&gt;CommandDecoder&lt;/b&gt;(config.getAddress().getScheme()));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;CommandPubSubDecoder&lt;/b&gt;(config));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;ch.pipeline().addLast(new &lt;b style=&quot;font-size: 10px;&quot;&gt;ErrorsLoggingHandler&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;config.getNettyHook().afterChannelInitialization(ch);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4520" y="470" width="400" height="400" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-96" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-90" target="wK_E6LMROi6GtL9PwVPp-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-90" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步解析Redis Server 地址&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;CompletableFuture&amp;lt;InetSocketAddress&amp;gt; addrFuture = client.&lt;b&gt;resolveAddr&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;return addrFuture.thenCompose(res -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;masterEntry&lt;/b&gt; = new &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;ClientConnectionsEntry&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; client,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; config.getMasterConnectionMinimumIdleSize(),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; config.getMasterConnectionPoolSize(),&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connectionManager,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; NodeType.MASTER,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; config);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!config.isSlaveNotUsed()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addSlaveEntry(masterEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (masterEntry.isFreezed()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(null);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//创建连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;CompletableFuture&amp;lt;Void&amp;gt;&amp;gt; futures = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//初始会创建最小空闲数量的连接，默认24&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;CompletableFuture&amp;lt;Void&amp;gt; writeFuture = masterEntry.initConnections(config.getMasterConnectionMinimumIdleSize());&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; futures.add(writeFuture);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (config.getSubscriptionMode() == SubscriptionMode.MASTER) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//发布订阅连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;CompletableFuture&amp;lt;Void&amp;gt; pubSubFuture&lt;/b&gt; = masterEntry.&lt;b&gt;initPubSubConnections&lt;/b&gt;(config.getSubscriptionConnectionMinimumIdleSize());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; futures.add(pubSubFuture);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;//这里说明前面 join() get() 会同步等待 Master Connection 和 Subscription Connection 都创建完成&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}).whenComplete((r, e) -&amp;gt; {&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//当调用 completeXxx 等方法时会回调到这里&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; client.shutdownAsync();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}).thenApply(r -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//注册到连接池&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; masterConnectionPool.&lt;b&gt;addEntry&lt;/b&gt;(masterEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; masterPubSubConnectionPool.addEntry(masterEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return client;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2600" y="920" width="440" height="500" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.279;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-93" target="ydMWs6PtdbeCtb3DKnso-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2550" y="689" />
              <mxPoint x="-2550" y="740" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.532;exitDx=0;exitDy=0;exitPerimeter=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-93" target="wK_E6LMROi6GtL9PwVPp-80" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2530" y="770" />
              <mxPoint x="-2530" y="360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-93" target="N1br0pmU6nb31XVEtK6O-30" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-2550" y="680" />
              <mxPoint x="-2550" y="300" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-93" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ClientConnectionsEntry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;保存某个客户端连接的容器，客户端会向每个服务节点创建两个通信服务（Bootstrap）,&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;每个通信服务中又分别会创建一组连接&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;ConnectionsHolder&lt;/b&gt;&amp;lt;&lt;b&gt;RedisConnection&lt;/b&gt;&amp;gt; &lt;b&gt;connectionsHolder&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;ConnectionsHolder&lt;/b&gt;&amp;lt;&lt;b&gt;RedisPubSubConnection&lt;/b&gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;pubSubConnectionsHolder&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final TrackedConnectionsHolder trackedConnectionsHolder;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;public enum FreezeReason {MANAGER, RECONNECT, SYSTEM}&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile FreezeReason freezeReason;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接所属的客户端&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final &lt;b&gt;RedisClient client&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final NodeType nodeType;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final IdleConnectionWatcher idleConnectionWatcher;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final ConnectionManager connectionManager;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile boolean initialized = false;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final WrappedLock lock = new WrappedLock();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;RedisConnection, ConnectionsHolder&amp;lt;?&amp;gt;&amp;gt; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;connection2holder&amp;nbsp;&lt;/b&gt;= new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2520" y="600" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-94" target="ydMWs6PtdbeCtb3DKnso-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-94" target="ydMWs6PtdbeCtb3DKnso-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-94" value="创建Topic&lt;br&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;只是创建 RedissonTopic 实例，并没有与服务端的交互&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-95" target="wK_E6LMROi6GtL9PwVPp-97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-95" value="return connectionsHolder.initConnections(&lt;br&gt;minimumIdleSize);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3080" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-100" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-97" target="wK_E6LMROi6GtL9PwVPp-99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-97" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//这里可以看到是通过 thenCompse()&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;顺序创建&amp;nbsp;minimumIdleSize 个连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;CompletableFuture&amp;lt;Void&amp;gt; f =&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;createConnection&lt;/b&gt;(minimumIdleSize, 1);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;for (int i = 2; i &amp;lt;= minimumIdleSize; i++) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; int k = i;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; f = f.&lt;b&gt;thenCompose&lt;/b&gt;(r -&amp;gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;createConnection&lt;/b&gt;(minimumIdleSize, k));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;return f.thenAccept(r -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; log.info(&quot;{} connections initialized for {}&quot;, minimumIdleSize, client.getAddr());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=4;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3320" y="1110" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-99" target="wK_E6LMROi6GtL9PwVPp-106" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4280" y="1160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-99" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;CompletableFuture&amp;lt;Void&amp;gt; f = acquireConnection();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return f.thenCompose(r -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;T&amp;gt; promise = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;createConnection&lt;/b&gt;(promise);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;promise&lt;/b&gt;.handle((conn, e) -&amp;gt; { &lt;font color=&quot;#007fff&quot;&gt;//正常或异常完成时回调&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (e == null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (changeUsage) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; conn.decUsage();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;addConnection&lt;/b&gt;(conn);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; releaseConnection();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (RedisConnection connection : getAllConnections()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!connection.isClosed()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connection.closeAsync();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; getAllConnections().clear();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int totalInitializedConnections = index - 1;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; String errorMsg;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (totalInitializedConnections == 0) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; errorMsg = &quot;Unable to connect to Redis server: &quot; + client.getAddr();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; errorMsg = &quot;Unable to init enough connections amount! Only &quot; +&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;totalInitializedConnections&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;+ &quot; of &quot; + minimumIdleSize +&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&quot; were initialized. Redis server: &quot; + client.getAddr();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Exception cause = new RedisConnectionException(errorMsg, e);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new CompletionException(cause);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return null;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=2;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3800" y="930" width="440" height="480" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-101" value="MasterSlaveEntry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2770" y="890" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-102" value="ClientConnectionsEntry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3110" y="1100" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-103" value="ConnectionsHolder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3475" y="1080" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-108" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-106" target="wK_E6LMROi6GtL9PwVPp-109" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4670" y="1160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-112" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.001;exitY=0.341;exitDx=0;exitDy=0;entryX=0.999;entryY=0.167;entryDx=0;entryDy=0;entryPerimeter=0;exitPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-106" target="wK_E6LMROi6GtL9PwVPp-99" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-106" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;CompletionStage&amp;lt;T&amp;gt; connFuture = &lt;b&gt;connectionCallback&lt;/b&gt;.&lt;b&gt;apply&lt;/b&gt;(client);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;connFuture.whenComplete((conn, e) -&amp;gt; { &lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;//conn 即&amp;nbsp;RedisConnection 实例&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (e != null) { &lt;font color=&quot;#007fff&quot;&gt;//异常结束&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; releaseConnection(); &lt;font color=&quot;#007fff&quot;&gt;//释放信号量&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;freeConnectionsCounter&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//回调前面的 promise.handle()&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; promise.completeExceptionally(e);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//正常结束&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; log.debug(&quot;new connection created: {}&quot;, conn);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //存储连接到 ConnectionsHolder&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;allConnections.add(conn);&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (changeUsage) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; promise.thenApply(c -&amp;gt; c.incUsage());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; connectedSuccessful(promise, conn);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4280" y="1060" width="320" height="220" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-111" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-109" target="wK_E6LMROi6GtL9PwVPp-110" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-109" value="RedisClient#connectAsync()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4640" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-113" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.004;exitY=0.483;exitDx=0;exitDy=0;exitPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-110" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4600" y="1090" as="targetPoint" />
            <Array as="points">
              <mxPoint x="4860" y="1160" />
              <mxPoint x="4860" y="1090" />
              <mxPoint x="4600" y="1090" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-114" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.002;exitY=0.667;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-110" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="4880.32" y="1316.9999999999998" as="sourcePoint" />
            <mxPoint x="4600" y="1090" as="targetPoint" />
            <Array as="points">
              <mxPoint x="4860" y="1267" />
              <mxPoint x="4860" y="1090" />
              <mxPoint x="4600" y="1090" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-110" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;CompletableFuture&amp;lt;InetSocketAddress&amp;gt; addrFuture = resolveAddr();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;CompletableFuture&amp;lt;RedisConnection&amp;gt; &lt;b&gt;f&lt;/b&gt; = addrFuture.&lt;b&gt;thenCompose&lt;/b&gt;(&lt;b&gt;res&lt;/b&gt; -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;RedisConnection&amp;gt; r = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //调用Netty接口建立连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; ChannelFuture channelFuture = bootstrap.connect(res);&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; channelFuture.&lt;b&gt;addListener&lt;/b&gt;(new ChannelFutureListener() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void operationComplete(final &lt;b&gt;ChannelFuture future&lt;/b&gt;) throws Exception {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/font&gt;if (isShutdown()) { &lt;font color=&quot;#007fff&quot;&gt;//判断RedisClient shutdown 以及 bootstrap.config().group() 状态&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RedisConnectionException cause = new RedisConnectionException(&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&quot;RedisClient is shutdown&quot;);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r.completeExceptionally(cause);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (future.isSuccess()) {&amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//即 connect() 成功&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;   &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//连接成功后从连接通道Channel里面获取connection属性（pipeline handler中设置的）&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;RedisConnection&lt;/b&gt; c = RedisConnection.getFrom(future.&lt;b&gt;channel&lt;/b&gt;());&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;    &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//connect() 成功后给RedisConnection的&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;connectionPromise&lt;/font&gt;&lt;span style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;注册结束回调：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 9px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;        &lt;/span&gt;&lt;/span&gt;//&lt;b&gt;当连接被complete（比如：c.getConnectionPromise().compelete(null)）后回调，用于关闭连接&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; c.getConnectionPromise().whenComplete((res, e) -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bootstrap.config().group().execute(new Runnable() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @Override&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void run() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (e == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!r.&lt;b&gt;complete&lt;/b&gt;(c)) { &lt;font color=&quot;#007fff&quot;&gt;//正常回调前面的 connFuture.whenComplete()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; c.closeAsync(); &lt;font color=&quot;#007fff&quot;&gt;//内部会调用 channel.close()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;executor&lt;/b&gt;.execute(() -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (config.getConnectedListener() != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; config.getConnectedListener().accept(getAddr());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r.completeExceptionally(e); &lt;font color=&quot;#007fff&quot;&gt;//异常回调前面的 connFuture.whenComplete()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; c.closeAsync();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;b&gt; &lt;font color=&quot;#007fff&quot;&gt;//即 connect() 失败&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bootstrap.config().group().execute(new Runnable() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public void run() {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r.completeExceptionally(future.cause());&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return r; &lt;font color=&quot;#007fff&quot;&gt;即 f == r&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return new CompletableFutureWrapper&amp;lt;&amp;gt;(f);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;glass=0;strokeWidth=1;shadow=0;fillColor=#d5e8d4;strokeColor=#82b366;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4880" y="880" width="400" height="580" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-117" target="ydMWs6PtdbeCtb3DKnso-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1500" y="1190" />
              <mxPoint x="1260" y="1190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-100" value="Type.PLAIN" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-74" vertex="1" connectable="0">
          <mxGeometry x="0.3278" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-99" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="wK_E6LMROi6GtL9PwVPp-117" target="04FaCHAl2gqULPaclR8Y-77" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1500" y="1190" />
              <mxPoint x="1801" y="1190" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-101" value="Type.PUBSUB" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-99" vertex="1" connectable="0">
          <mxGeometry x="-0.1428" y="-2" relative="1" as="geometry">
            <mxPoint x="22" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="wK_E6LMROi6GtL9PwVPp-117" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;b&gt;Netty ChannelHandler Pipeline&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;普通命令和发布订阅命令&lt;br&gt;是两套不同的管道&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="1120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-0" target="ydMWs6PtdbeCtb3DKnso-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-0" value="RTopic topic = redisson.getTopic(&quot;topic-1&quot;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-2" target="N1br0pmU6nb31XVEtK6O-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-34" value="存储" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#007FFF;" parent="N1br0pmU6nb31XVEtK6O-33" vertex="1" connectable="0">
          <mxGeometry x="-0.2652" y="-1" relative="1" as="geometry">
            <mxPoint x="-1" y="39" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConnectionsHolder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;保存连接的容器&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;ConnectionsHolder 由 ConcurrentLinkedQueue + AsyncSemaphore 实现&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所有连接&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Queue&amp;lt;T&amp;gt; allConnections = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//空闲连接&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Queue&amp;lt;T&amp;gt; freeConnections = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//空闲连接的数量&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AsyncSemaphore freeConnectionsCounter;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接所属RedisClient对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final RedisClient client;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Function&amp;lt;RedisClient, CompletionStage&amp;lt;T&amp;gt;&amp;gt; connectionCallback;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final ServiceManager serviceManager;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final boolean changeUsage;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2960" y="600" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-6" target="ydMWs6PtdbeCtb3DKnso-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1210" y="1320" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-30" value="&lt;font color=&quot;#007fff&quot;&gt;InBound&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ydMWs6PtdbeCtb3DKnso-17" vertex="1" connectable="0">
          <mxGeometry x="-0.5143" y="-1" relative="1" as="geometry">
            <mxPoint x="-59" y="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-6" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;DefaultChannelPipeline$HeadContext&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1160" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-7" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;RedisConnectionHandler&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;通道&lt;b&gt;注册&lt;/b&gt;、&lt;b&gt;激活&lt;/b&gt;时回调&lt;br&gt;创建RedisConnection实例, 异步执行auth认证、hello、select、readonly、ping等操作&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1060" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-8" target="ydMWs6PtdbeCtb3DKnso-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-8" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;ConectionWatchdog&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通道&lt;b&gt;激活&lt;/b&gt;、&lt;b&gt;失活&lt;/b&gt;时回调，失活时根据连接状态进行处理，比如重连&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1060" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-29" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-9" target="ydMWs6PtdbeCtb3DKnso-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-9" value="&lt;font style=&quot;&quot;&gt;CommandEncoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于给单个命令进行编码&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1260" y="1440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-28" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-10" target="ydMWs6PtdbeCtb3DKnso-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-10" value="&lt;font style=&quot;&quot;&gt;CommandBatchEncoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于给批量的命令进行编码&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1260" y="1520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-11" target="ydMWs6PtdbeCtb3DKnso-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-11" target="ydMWs6PtdbeCtb3DKnso-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-11" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;CommandsQueue&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将命令和ChannelPromise封装后注册到通道的属性Map, 用于异步等待命令执行完成&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1160" y="1600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-12" target="ydMWs6PtdbeCtb3DKnso-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-12" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;PingConnectionHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Channel&lt;b&gt;激活&lt;/b&gt;时回调&lt;br&gt;发送Ping指令，并重新设置定时任务发送Ping用于维持心跳&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1060" y="1680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-13" target="ydMWs6PtdbeCtb3DKnso-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-13" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;CommandDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;读消息时回调，对消息进行解码&lt;br&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1060" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-14" target="ydMWs6PtdbeCtb3DKnso-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-14" target="ydMWs6PtdbeCtb3DKnso-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-14" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;ErrorsLoggingHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;打印异常、错误日志&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1160" y="1840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-15" target="ydMWs6PtdbeCtb3DKnso-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-15" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;DefaultChannelPipeline$TailContext&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1160" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-31" value="&lt;font color=&quot;#007fff&quot;&gt;OutBound&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1" connectable="0">
          <mxGeometry x="1360" y="1270.0014285714287" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-32" value="&lt;font color=&quot;#007fff&quot;&gt;封装成 QueueCommandHolder,&amp;nbsp;&lt;br&gt;然后加入到Channel 属性Map中的&amp;nbsp;&amp;nbsp;Queue&amp;lt;QueueCommandHolder&amp;gt;&lt;br&gt;键是 COMMANDS_QUEUE&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="769" y="1600" width="390" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-33" value="return new &lt;b style=&quot;font-size: 11px;&quot;&gt;RedissonTopic&lt;/b&gt;(&lt;br style=&quot;font-size: 11px;&quot;&gt;commandExecutor, name);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="2280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-35" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;subscribeService = {PublishSubscribeService@4270}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;commandExecutor = {CommandAsyncService@3506}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;name = &quot;topic-1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;channelName = {ChannelName@3526} &quot;topic-1&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;codec = {Kryo5Codec@3520} &quot;org.redisson.codec.Kryo5Codec&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="730" y="2280" width="340" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-36" target="ydMWs6PtdbeCtb3DKnso-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-49" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-36" target="ydMWs6PtdbeCtb3DKnso-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-36" value="注册订阅&lt;br&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;最终是通过RedisClient 发送 subscribe 或 psubscribe 命令并注册监听器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-38" target="ydMWs6PtdbeCtb3DKnso-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-163" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-38" target="04FaCHAl2gqULPaclR8Y-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-38" value="topic.addListener(String.class, new MessageListener&amp;lt;String&amp;gt;{...});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-40" target="ydMWs6PtdbeCtb3DKnso-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-40" target="ydMWs6PtdbeCtb3DKnso-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-40" value="RFuture&amp;lt;&lt;b&gt;Integer&lt;/b&gt;&amp;gt; future = addListenerAsync(type, listener);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;异步注册监听器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-42" value="return commandExecutor.get(&lt;br style=&quot;font-size: 11px;&quot;&gt;future.toCompletableFuture());&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;同步等待订阅注册完成&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="2480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-44" value="RedissonTopic" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="570" y="2370" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-45" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 11px;&quot;&gt;&lt;b style=&quot;font-size: 11px;&quot;&gt;RedissonTopic&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final PublishSubscribeService subscribeService;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final CommandAsyncExecutor commandExecutor;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题名称&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final String name;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//和主题名称一样，只不过保存了String byte[] 两种形式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final ChannelName channelName;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final Codec codec;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-440" y="1680" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-46" target="ydMWs6PtdbeCtb3DKnso-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-46" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;PubSubMessageListener&amp;lt;M&amp;gt; pubSubListener = new &lt;b style=&quot;font-size: 10px;&quot;&gt;PubSubMessageListener&lt;/b&gt;&amp;lt;&amp;gt;(type, (MessageListener&amp;lt;M&amp;gt;) listener, name);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;return &lt;b style=&quot;font-size: 10px;&quot;&gt;addListenerAsync&lt;/b&gt;(pubSubListener);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;将MessageListener重新封装PubSubMessageListener&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;再注册&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="2390" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-48" target="04FaCHAl2gqULPaclR8Y-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-48" value="发布消息&lt;br&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;最终是通过发送 publish 命令&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="2800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-50" target="ydMWs6PtdbeCtb3DKnso-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-50" value="&lt;div style=&quot;&quot;&gt;CompletableFuture&amp;lt;List&amp;lt;PubSubConnectionEntry&amp;gt;&amp;gt; future = &lt;b&gt;subscribeService&lt;/b&gt;.&lt;b&gt;subscribe&lt;/b&gt;(codec, channelName, pubSubListener);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;订阅完成后 System.identityHashCode(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;pubSubListener); 并重新封装&amp;nbsp;return new CompletableFutureWrapper&amp;lt;&amp;gt;(f);&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1040" y="2390" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-55" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-52" target="ydMWs6PtdbeCtb3DKnso-54" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-52" value="&lt;font style=&quot;&quot;&gt;MasterSlaveEntry entry = getEntry(channelName);&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;根据主题名计算slot，再获取对应的Redis服务节点，用于集群模式&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1320.5" y="2400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-54" target="ydMWs6PtdbeCtb3DKnso-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-54" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;CompletableFuture&amp;lt;PubSubConnectionEntry&amp;gt; f = &lt;b style=&quot;font-size: 11px;&quot;&gt;subscribe&lt;/b&gt;(PubSubType.SUBSCRIBE, codec, channelName, entry, null, listeners);&lt;br style=&quot;font-size: 11px;&quot;&gt;return f.thenApply(res -&amp;gt; Collections.singletonList(res));&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1300.5" y="2480" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-56" value="PublishSubscribeService" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2110" y="2080" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-57" target="ydMWs6PtdbeCtb3DKnso-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-57" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;CompletableFuture&amp;lt;PubSubConnectionEntry&amp;gt; &lt;b&gt;promise&lt;/b&gt; = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//对主题名进行哈希取模选择一个信号量，PublishSubscribeSevice 中创建了一组信号量&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//50个，每个信号量 permit = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;AsyncSemaphore lock = getSemaphore(channelName);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;int timeout = config.getSubscriptionTimeout();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;long start = System.nanoTime();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//注册一个定时任务，如果超时还没有获取到信号量，就异常结束&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;Timeout lockTimeout = connectionManager.getServiceManager().newTimeout(t -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; promise.&lt;b&gt;completeExceptionally&lt;/b&gt;(new RedisTimeoutException(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;Unable to acquire subscription lock after &quot; + timeout + &quot;ms. &quot; +&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;Try to increase &#39;subscriptionTimeout&#39;, &#39;subscriptionsPerConnection&#39;, &#39;subscriptionConnectionPoolSize&#39; parameters.&quot;));&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}, timeout, TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//信号量获取成功，就取消上面定时任务&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;lock.acquire().thenAccept(r -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!lockTimeout.&lt;b&gt;cancel&lt;/b&gt;() || promise.isDone()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lock.release();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //计算剩余时间（超时时间 - 获取信号量的时间）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; long newTimeout = timeout - TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;subscribeNoTimeout&lt;/b&gt;(codec, channelName, entry, clientEntry, &lt;b&gt;promise&lt;/b&gt;, type, lock, new AtomicInteger(), listeners);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//再注册一个定时任务，剩余时间内promise没有结束就异常结束promise&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; timeout(promise, newTimeout);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return promise;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1600.5" y="2400" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-43" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-59" target="ydMWs6PtdbeCtb3DKnso-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-59" value="&lt;font style=&quot;&quot;&gt;&lt;b&gt;subscribeNoTimeout&lt;/b&gt;(codec, channelName, &lt;b&gt;entry&lt;/b&gt;, &lt;b&gt;clientEntry&lt;/b&gt;, &lt;b&gt;promise&lt;/b&gt;, type, lock, new AtomicInteger(), &lt;b&gt;listeners&lt;/b&gt;);&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2080.5" y="2550" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-61" target="04FaCHAl2gqULPaclR8Y-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-5" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-3" vertex="1" connectable="0">
          <mxGeometry x="0.163" y="-2" relative="1" as="geometry">
            <mxPoint y="-94" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-61" target="04FaCHAl2gqULPaclR8Y-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-26" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-25" vertex="1" connectable="0">
          <mxGeometry x="0.904" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-61" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//先从本地缓存（Map）获取主题（channelName）对应的 PubSubConnectionEntry 连接实例&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;PubSubConnectionEntry connEntry;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (clientEntry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; connEntry = &lt;b&gt;key2connection&lt;/b&gt;.get(new PubSubClientKey(channelName, clientEntry));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;} else {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; connEntry = &lt;b&gt;name2PubSubConnection&lt;/b&gt;.get(new PubSubKey(channelName, entry));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;if (connEntry != null) {&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//说明之前创建过这个连接实例，也创建过这个主题&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (clientEntry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; clientEntry.getTrackedConnectionsHolder().incUsage();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //这里可以看到监听器是注册到了&amp;nbsp;PubSubConnectionEntry 实例里面 (&lt;/b&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;channelListeners&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;font-size: 10px; color: rgb(0, 127, 255); background-color: initial;&quot;&gt;)&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; connEntry.&lt;b&gt;addListeners&lt;/b&gt;(channelName, promise, type, lock, listeners);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//走到这说明主题的&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;PubSubConnectionEntry 连接实例还没创建过&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//就创建连接实例并缓存，注册主题监听器，最后通过连接发送订阅命令&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;//使用 AsyncSemaphore 同步创建连接实例（AsyncSemphore permits==1 就相当于锁）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;freePubSubLock&lt;/b&gt;.acquire().thenAccept(c -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (promise.isDone()) { &lt;font color=&quot;#007fff&quot;&gt;//检查一下，防止万一外部取消&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lock.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freePubSubLock.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //根据连接的节点信息查看获取已有的发布订阅连接集合（PubSubConnectionEntry队列）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //DCL思想，再检查一下本地缓存中是否有创建连接，防止并发重复创建&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; PubSubEntry freePubSubConnections = entry2PubSubConnection.getOrDefault(entry, new PubSubEntry());&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; PubSubConnectionEntry &lt;b&gt;freeEntry&lt;/b&gt; = freePubSubConnections.getEntries().peek();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (freeEntry != null &amp;amp;&amp;amp; clientEntry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!clientEntry.getClient().equals(freeEntry.getConnection().getRedisClient())) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freeEntry = null;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//确实没有创建发布订阅连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (freeEntry == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freePubSubLock.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;//1 首次执行会从连接池获取连接（里面还记录此新连接为此主题的发布订阅连接）&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;connect&lt;/b&gt;(codec, channelName, entry, &lt;b&gt;clientEntry&lt;/b&gt;, promise, type, lock, attempts, listeners);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//后面尝试获取可用订阅并记录主题使用的连接对象到本地&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //尝试获取可用订阅（Redisson默认规定每个连接最多5个订阅）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; int remainFreeAmount = freeEntry.tryAcquire();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (remainFreeAmount == -1) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; throw new IllegalStateException();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; PubSubConnectionEntry oldEntry = null;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (clientEntry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; PubSubClientKey key = new PubSubClientKey(channelName, clientEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//记录获取到的空闲连接，本地缓存起来（本质是 主题 -&amp;gt; PubSubConnectionEntry 的映射）&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;//并增加连接的占用数量&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oldEntry = key2connection.putIfAbsent(key, freeEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; clientEntry.getTrackedConnectionsHolder().incUsage();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; PubSubKey key = new PubSubKey(channelName, entry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; PubSubConnectionEntry oe = name2PubSubConnection.putIfAbsent(key, freeEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (clientEntry == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oldEntry = oe;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (oldEntry != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freeEntry.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freePubSubLock.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//可能存在旧的连接也有订阅这个主体，需要将监听器也往这个连接中注册一下&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; oldEntry.addListeners(channelName, promise, type, lock, listeners);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; Collection&amp;lt;PubSubConnectionEntry&amp;gt; coll = name2entry.computeIfAbsent(&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;channelName, k -&amp;gt; Collections.newSetFromMap(new ConcurrentHashMap&amp;lt;&amp;gt;()));&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; coll.add(freeEntry);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (remainFreeAmount == 0) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freePubSubConnections.getEntries().poll();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; freePubSubLock.release();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //2 通过发送订阅命令创建主题，注册监听器&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; freeEntry.&lt;b&gt;subscribe&lt;/b&gt;(codec, channelName, promise, type, lock, listeners);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2320" y="2041.25" width="440" height="1080" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-66" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.006;exitY=0.298;exitDx=0;exitDy=0;endArrow=open;endFill=0;exitPerimeter=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-63" target="ydMWs6PtdbeCtb3DKnso-65" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-63" target="04FaCHAl2gqULPaclR8Y-0" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-63" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PublishSubscribeService&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;类似 MasterSlaveEntry 保存了一组用于发布订阅的连接, 通过 Map 存储连接，只不过KEY是发布订阅相关的&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConnectionManager connectionManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MasterSlaveServersConfig config;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AsyncSemaphore[] locks = new AsyncSemaphore[50];&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AsyncSemaphore freePubSubLock = new AsyncSemaphore(1);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题名 -&amp;gt; 连接集合&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;&lt;b&gt;ChannelName&lt;/b&gt;, Collection&amp;lt;&lt;b&gt;PubSubConnectionEntry&lt;/b&gt;&amp;gt;&amp;gt; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;name2entry&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//PubSubKey -&amp;gt; 连接集合&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//PubSubKey 是 &quot;主题名 + MasterSlaveEntry&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;&lt;b&gt;PubSubKey&lt;/b&gt;, PubSubConnectionEntry&amp;gt; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;name2PubSubConnection&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//MasterSlaveEntry -&amp;gt;&amp;nbsp;PubSubEntry&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;MasterSlaveEntry, &lt;b&gt;PubSubEntry&lt;/b&gt;&amp;gt; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;entry2PubSubConnection&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;&lt;b&gt;PubSubClientKey&lt;/b&gt;, PubSubConnectionEntry&amp;gt;&amp;nbsp;&lt;br&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; key2connection&lt;/b&gt; =&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final SemaphorePubSub semaphorePubSub = new SemaphorePubSub(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CountDownLatchPubSub countDownLatchPubSub = new CountDownLatchPubSub(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final LockPubSub lockPubSub = new LockPubSub(this);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;PubSubConnectionEntry&amp;gt; trackedEntries = Collections.newSetFromMap(new ConcurrentHashMap&amp;lt;&amp;gt;());&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private boolean shardingSupported = false;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2080" y="1360" width="400" height="480" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-32" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.226;exitDx=0;exitDy=0;exitPerimeter=0;endArrow=open;endFill=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-65" target="04FaCHAl2gqULPaclR8Y-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ydMWs6PtdbeCtb3DKnso-65" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PubSubConnectionEntry&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;本身并不创建连接，而是通过 MasterSlaveEntry 获取连接的&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//可订阅数量，Redisson默认限制每个发布订阅连接最多5个订阅&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger &lt;b&gt;subscribedChannelsAmount&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;RedisPubSubConnection&lt;/b&gt; &lt;b&gt;conn&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题名 -&amp;gt; SubscribeListener&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;ChannelName, SubscribeListener&amp;gt; &lt;b&gt;subscribeChannelListeners&lt;/b&gt; = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//主题名 -&amp;gt; Queue&amp;lt;RedisPubSubListener&amp;lt;?&amp;gt;&amp;gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;ChannelName, Queue&amp;lt;RedisPubSubListener&amp;lt;?&amp;gt;&amp;gt;&amp;gt; &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;channelListeners&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;ChannelName, WrappedLock&amp;gt; &lt;b&gt;channelLocks&lt;/b&gt; = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Queue&amp;lt;RedisPubSubListener&amp;lt;?&amp;gt;&amp;gt; EMPTY_QUEUE = new &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;LinkedList&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ServiceManager serviceManager;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属 PublishSubscribeService&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PublishSubscribeService &lt;b&gt;subscribeService&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//这里可以看到其实也是通过 MasterSlaveEntry 获取连接的&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MasterSlaveEntry &lt;b&gt;entry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final Map&amp;lt;PubSubType, PubSubType&amp;gt; SUBSCRIBE2UNSUBSCRIBE = &lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2560" y="1360" width="440" height="400" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;订阅者通过 RedisClient 发送 subscribe 或 psubscribe 命令在 Redis Server 中注册主题，并注册监听器；&lt;br style=&quot;font-size: 11px;&quot;&gt;发布者通过&amp;nbsp;RedisClient 发送 publish 命令发布数据到 Redis Server, Redis Server 再将发布的数据发给订阅者，订阅者客户端再回调监听器&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="2200" width="400" height="70" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-3" value="&lt;font color=&quot;#007fff&quot;&gt;这里重点关注：&lt;br&gt;1）订阅命令发送流程；&lt;br&gt;2）监听器注册到了哪里；（&lt;b&gt;PubSubConnectionEntry.channelListeners、RedisPubSubConnection.listeners&lt;/b&gt;）&lt;br&gt;3）RedisServer发送发布的数据给订阅者并回调的过程。&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="40" y="2475" width="400" height="70" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-4" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;RedisClient、ConnectionsEntry、MasterSlaveEntry 的关系&lt;/b&gt;：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;一个 RedisClient 只连接一个 MasterSlaveEntry, 但是RedisClient中&lt;/font&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;可能有多个连接：&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;比如每个RedisClient 都有两组通信服务Bootstrap, 每组通信服务又可能创建&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;多个连接；&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;ConnectionsEntry 是 RedisClient 到 MasterSlaveEntry 的连接的容器，&lt;br&gt;每组通信服务都有一个连接队列；&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;MasterSlaveEntry是客户端对象，但是里面可能有多个RedisClient, &lt;br&gt;也即一个客户端可以创建多个RedisClient&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2960" y="940" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-5" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2960" y="1090" width="160" height="200" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="N1br0pmU6nb31XVEtK6O-7" target="N1br0pmU6nb31XVEtK6O-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="N1br0pmU6nb31XVEtK6O-7" target="N1br0pmU6nb31XVEtK6O-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-7" value="RedisClient" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2940" y="1110" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-8" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2560" y="1090" width="160" height="140" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-9" value="MasterSlaveEntry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2940" y="1060" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-11" value="RedisClient" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2940" y="1170" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-12" value=",,," style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2940" y="1230" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="N1br0pmU6nb31XVEtK6O-14" target="N1br0pmU6nb31XVEtK6O-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-29" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="N1br0pmU6nb31XVEtK6O-14" target="N1br0pmU6nb31XVEtK6O-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-14" value="connectionsHolder" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2740" y="1110" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-15" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;pubSubConnectionsHolder&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2740" y="1170" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-18" value="ClientConnectionsEntry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2755" y="1060" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="N1br0pmU6nb31XVEtK6O-21" target="N1br0pmU6nb31XVEtK6O-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-2360" y="1130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-21" value="allConnections" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2540" y="1110" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-22" value="freeConnections" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2540" y="1170" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-24" value="ConnectionsHolder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2540" y="1060" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-27" value="" style="rounded=0;whiteSpace=wrap;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2360" y="1090" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-28" value="RedisConnection" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2330" y="1060" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-30" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RedisConnection&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;连接对象，本质就是Netty的Channel&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final AttributeKey&amp;lt;RedisConnection&amp;gt; CONNECTION = AttributeKey.valueOf(&quot;connection&quot;);&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接所属客户端对象&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final RedisClient &lt;b&gt;redisClient&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//用于重连的回调接口&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile CompletableFuture&amp;lt;Void&amp;gt; &lt;b&gt;fastReconnect&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile Status status = Status.OPEN;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接的Channel, 本质是操作系统的管道文件&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;volatile Channel &lt;b&gt;channel&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private CompletableFuture&amp;lt;?&amp;gt; &lt;b&gt;connectionPromise&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile long lastUsageTime;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Runnable connectedListener;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Runnable disconnectedListener;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicInteger usage = new AtomicInteger();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2960" y="160" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="N1br0pmU6nb31XVEtK6O-36" value="&lt;font color=&quot;#007fff&quot;&gt;后面可以看到创建了两批连接&lt;br&gt;创建成功后将连接存储到 MasterSlaveEntry&amp;nbsp;&lt;br&gt;后面发送命令需要获取连接就从MasterSlaveEntry取&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2320" y="1200" width="300" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-0" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PubSubEntry&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;是 PubSubConnectionEntry 的 ConcurrentLinkedQueue 队列&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;Queue&amp;lt;PubSubConnectionEntry&amp;gt; entries = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Queue&amp;lt;PubSubConnectionEntry&amp;gt; getEntries();&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-2560" y="1800" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-2" target="04FaCHAl2gqULPaclR8Y-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-2" value="&lt;font style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;connect&lt;/b&gt;(codec, channelName, entry, clientEntry, promise, type, lock, attempts, listeners);&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;这里只关注从连接池获取发布订阅&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;连接&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2800" y="2318.75" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-4" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;从后面可以看到：&lt;br&gt;1）先看之前有没有订阅过，&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;订阅过直接使用之前的发布订阅连接；&lt;br&gt;2）没订阅过，就看当前客户端有没有空闲的发布订阅连接，&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;有直接使用空闲的发布订阅连接；&lt;br&gt;3）没有空闲的发布订阅连接则从连接池获取一个发布订阅连接&lt;br&gt;，然后使用此连接发送subscribe命令。&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;clientEntry可能不为null, 表示使用指定的连接集合中的连接&lt;br&gt;做订阅&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2050" y="2630" width="300" height="160" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-6" target="04FaCHAl2gqULPaclR8Y-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-6" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;CompletableFuture&amp;lt;RedisPubSubConnection&amp;gt; connFuture = msEntry.&lt;b&gt;nextPubSubConnection&lt;/b&gt;(clientEntry);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;左边第2步，通过connFuture.thenAccept()执行&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3030" y="2318.75" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-8" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;1）从连接池获取发布订阅连接&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;2）新连接创建成功后，尝试获取新连接可用订阅&lt;br style=&quot;font-size: 10px;&quot;&gt;并使用新连接作为当前主题的发布订阅连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;3）还注册了一个超时任务，超时后检查订阅是否成功&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;未成功则重试（再次调用 subscribeNoTimeout()&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;）&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2800" y="2388.75" width="260" height="70" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ConnectionPool (A)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;连接池实现，就是连接对象的CLQ队列&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//连接队列&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final Queue&amp;lt;ClientConnectionsEntry&amp;gt; &lt;b&gt;entries&lt;/b&gt; = new &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final ConnectionManager connectionManager;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final MasterSlaveServersConfig config;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//所属MasterSlaveEntry&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;final MasterSlaveEntry &lt;b&gt;masterSlaveEntry&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-3400" y="160" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-11" target="04FaCHAl2gqULPaclR8Y-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-16" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-15" vertex="1" connectable="0">
          <mxGeometry x="-0.0976" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-11" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;if (entry != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return slavePubSubConnectionPool.get(entry); &lt;font color=&quot;#007fff&quot;&gt;//优先从Slave节点连接池获取连接&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//订阅模式，默认是订阅到Master节点&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (config.getSubscriptionMode() == SubscriptionMode.&lt;b&gt;MASTER&lt;/b&gt;) {&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return &lt;b&gt;masterPubSubConnectionPool&lt;/b&gt;.&lt;b&gt;get&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;//创建发布订阅连接并返回&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (noPubSubSlaves.get()) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return masterPubSubConnectionPool.get(); &lt;font color=&quot;#007fff&quot;&gt;//没有从节点就订阅到主节点&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;CompletableFuture&amp;lt;RedisPubSubConnection&amp;gt; future = slavePubSubConnectionPool.get();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return future.handle((r, e) -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (noPubSubSlaves.compareAndSet(false, true)) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.warn(&quot;No slaves for master: {} PubSub connections established with the master node.&quot;,&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; masterEntry.getClient().getAddr(), e);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return masterPubSubConnectionPool.get();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return CompletableFuture.completedFuture(r);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}).thenCompose(f -&amp;gt; f);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=2;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3280" y="2208.75" width="440" height="280" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-13" value="MasterSlaveEntry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3440" y="2178.75" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-14" target="04FaCHAl2gqULPaclR8Y-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-14" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//以发布订阅为例，这里是从发布订阅连接池获取一个节点的ConnetionsEntry中的&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;pubSubConnectionsHolder，初始化时默认为每个节点创建了24个发布订阅连接，所以这里不会为空&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;ConnectionsHolder&amp;lt;T&amp;gt; handler = &lt;b&gt;getConnectionHolder&lt;/b&gt;(entry, trackChanges);&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//AsyncSemaphore 信号量控制下同步获取空闲连接，这里可以看到并没有新建&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;CompletableFuture&amp;lt;T&amp;gt; result = handler.&lt;b&gt;acquireConnection&lt;/b&gt;(command);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;CompletableFuture&amp;lt;T&amp;gt; cancelableFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;result.whenComplete((r, e) -&amp;gt; {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (entry.getNodeType() == NodeType.SLAVE) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; FailedNodeDetector detector = entry.getClient().getConfig().getFailedNodeDetector();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; detector.onConnectFailed();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (detector.isNodeFailed()) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log.error(&quot;Redis node {} has been marked as failed according to the detection logic defined in {}&quot;,&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry.getClient().getAddr(), detector);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; masterSlaveEntry.shutdownAndReconnectAsync(entry.getClient(), e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; cancelableFuture.completeExceptionally(e);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; entry.addHandler(r, handler);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (entry.getNodeType() == NodeType.SLAVE) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry.getClient().getConfig().getFailedNodeDetector().onConnectSuccessful();&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!cancelableFuture.complete(r)) {&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry.returnConnection(r);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;});&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;return cancelableFuture;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3760" y="2146.25" width="440" height="405" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-17" value="ConnectionPool#acquireConnection" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3880" y="2116.25" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-18" value="&lt;font color=&quot;#007fff&quot;&gt;客户端 &lt;br style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; -&amp;gt; 主/从发布订阅连接池 （发布订阅连接有两种连接池）&lt;br style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -&amp;gt; 每种类型可能有多个节点，每个节点一个ConnectionsEntry&lt;br style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -&amp;gt; ConnectionsEntry 中有两种 ConnectionsHolder, 这只关注发布订阅的&lt;br style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -&amp;gt; ConnectionsHolder 中可能有多个发布订阅连接实例RedisPubSubConnection&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3760" y="2038.75" width="460" height="80" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-19" target="wK_E6LMROi6GtL9PwVPp-106" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4460" y="2349" />
              <mxPoint x="4460" y="1940" />
              <mxPoint x="4260" y="1940" />
              <mxPoint x="4260" y="1170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-23" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-22" vertex="1" connectable="0">
          <mxGeometry x="-0.9787" y="-5" relative="1" as="geometry">
            <mxPoint x="6" y="-5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-19" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//1 先从连接池（队列）获取可用连接&lt;/font&gt;&lt;/div&gt;&lt;div&gt;T conn = &lt;b&gt;pollConnection&lt;/b&gt;(command);&lt;/div&gt;&lt;div&gt;if (conn != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; connectedSuccessful(promise, conn);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 没有可用连接，再创建新连接&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;createConnection&lt;/b&gt;(promise);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#fff2cc;strokeColor=#d6b656;align=left;arcSize=5;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4239.999999999999" y="2298.75" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-21" value="ConnectionsHolder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="4274.999999999999" y="2268.75" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-24" target="04FaCHAl2gqULPaclR8Y-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-24" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; freeEntry.&lt;b style=&quot;font-size: 10px;&quot;&gt;subscribe&lt;/b&gt;(codec,channelName, &lt;br style=&quot;font-size: 10px;&quot;&gt;promise, type, lock, listeners);&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;注册订阅监听器，发送订阅命令到Redis Server&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2800" y="2851.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-30" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-27" target="04FaCHAl2gqULPaclR8Y-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-33" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-30" vertex="1" connectable="0">
          <mxGeometry x="-0.0417" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-27" value="&lt;font style=&quot;&quot;&gt;&lt;div&gt;&lt;div style=&quot;&quot;&gt;CompletableFuture&amp;lt;PubSubConnectionEntry&amp;gt; &lt;b&gt;pp&lt;/b&gt; = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;pp.whenComplete((r, e) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (e != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... //异常处理&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pm.complete(r);&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//异步注册监听器到 PubSubConnectionEntry.channelListeners&lt;/font&gt;&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;Void&amp;gt; subscribeFuture = &lt;b&gt;addListeners&lt;/b&gt;(channelName, &lt;b&gt;pp&lt;/b&gt;, type, lock, listeners);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;CompletableFuture&amp;lt;Void&amp;gt; promise = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;promise.whenComplete((r, ex) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;ChannelFuture future;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//订阅的3种类型 subscribe、psubscribe、ssubscribe (Redis7.0新增)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (PubSubType.SUBSCRIBE == type) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; future = conn.&lt;b&gt;subscribe&lt;/b&gt;(promise, codec, channelName);&lt;/div&gt;&lt;div&gt;} else if (PubSubType.SSUBSCRIBE == type) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; future = conn.&lt;b&gt;ssubscribe&lt;/b&gt;(promise, codec, channelName); &lt;font color=&quot;#007fff&quot;&gt;//分片通道，&lt;/font&gt;&lt;font color=&quot;#cc0000&quot;&gt;TODO原理&lt;/font&gt;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; future = conn.&lt;b&gt;psubscribe&lt;/b&gt;(promise, codec, channelName); &lt;font color=&quot;#007fff&quot;&gt;//基于pattern的订阅&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;future.addListener((ChannelFutureListener) future1 -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!future1.isSuccess()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; subscribeFuture.completeExceptionally(future1.cause());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; serviceManager.newTimeout(t -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ... &lt;font color=&quot;#007fff&quot;&gt;//超时异常结束&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }, serviceManager.getConfig().getTimeout(), TimeUnit.MILLISECONDS);&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=2;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3040" y="2641.25" width="440" height="480" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-29" target="04FaCHAl2gqULPaclR8Y-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-29" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return async(promise, new PubSubMessageDecoder(&lt;br&gt;codec.getValueDecoder()), RedisCommands.SUBSCRIBE, channels);&lt;br&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3520" y="2851.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-31" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;RedisPubSubConnection&lt;/b&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;发布订阅连接实例&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//发布订阅监听器列表&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;final Queue&amp;lt;RedisPubSubListener&amp;lt;Object&amp;gt;&amp;gt; &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;listeners&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt; = new &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//普通发布订阅的通道，主题名 -&amp;gt; Codec&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final Map&amp;lt;ChannelName, Codec&amp;gt; &lt;b&gt;channels&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//分片通道&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final Map&amp;lt;ChannelName, Codec&amp;gt; &lt;b&gt;shardedChannels&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final Map&amp;lt;ChannelName, Codec&amp;gt; &lt;b&gt;patternChannels&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;final Map&amp;lt;ChannelName, PubSubType&amp;gt; unsubscribedChannels = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;hr style=&quot;font-size: 11px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 11px;&quot;&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=11;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="-3040" y="1360" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-34" value="&lt;font style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return &lt;b&gt;channel&lt;/b&gt;.&lt;b&gt;writeAndFlush&lt;/b&gt;(new CommandData&amp;lt;&amp;gt;(promise, messageDecoder, null, command, params));&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里的channel是Netty的Channel&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;glass=0;strokeWidth=1;shadow=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3760" y="2851.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-36" value="RedisPubSubConenction" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3540" y="2821.25" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-37" value="RedisConnection" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="3805" y="2821.25" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-39" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;redisson-netty 开头是工作者线程&lt;br&gt;默认会创建32个线程&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2720" y="330" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="ydMWs6PtdbeCtb3DKnso-7" target="ydMWs6PtdbeCtb3DKnso-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1210" y="1340" as="sourcePoint" />
            <mxPoint x="1210" y="1360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-77" target="04FaCHAl2gqULPaclR8Y-78" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1750.5" y="1320" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-76" value="&lt;font color=&quot;#007fff&quot;&gt;InBound&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-75" vertex="1" connectable="0">
          <mxGeometry x="-0.5143" y="-1" relative="1" as="geometry">
            <mxPoint x="-59" y="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-77" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;DefaultChannelPipeline$HeadContext&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1700.5" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-78" value="&lt;font style=&quot;&quot;&gt;RedisPubSubConnectionHandler&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;建立与服务端连接通道&lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;注册&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;、&lt;/span&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;激活&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;时回调&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;创建RedisPubSubConnection实例, 异步执行auth认证、hello、select、readonly、ping等操作&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1600.5" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-80" target="04FaCHAl2gqULPaclR8Y-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-80" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;ConectionWatchdog&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;通道&lt;b style=&quot;&quot;&gt;激活&lt;/b&gt;、&lt;b style=&quot;&quot;&gt;失活&lt;/b&gt;时回调，&lt;br&gt;通道激活时记录channel到ConectionWatchdog&lt;br&gt;本地，失活时根据&lt;b&gt;连接状态&lt;/b&gt;进行处理，比如重连&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1600.5" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-81" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-82" target="04FaCHAl2gqULPaclR8Y-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-82" value="&lt;font style=&quot;&quot;&gt;CommandEncoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于给单个命令（CommandData）进行编码&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1800.5" y="1440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-83" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-84" target="04FaCHAl2gqULPaclR8Y-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-84" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;CommandBatchEncoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于给批量的命令(CommandsData)进行编码&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1800.5" y="1520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-87" target="04FaCHAl2gqULPaclR8Y-89" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-86" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-87" target="04FaCHAl2gqULPaclR8Y-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-87" value="&lt;font style=&quot;&quot;&gt;CommandsQueuePubSub&lt;br&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#007fff&quot;&gt;write()&amp;nbsp; 使用&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;ConcurrentLinkedQueue保存命令对象，排队发送&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1700.5" y="1600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-88" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-89" target="04FaCHAl2gqULPaclR8Y-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-89" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;PingConnectionHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Channel&lt;b&gt;激活&lt;/b&gt;时回调&lt;br&gt;发送Ping指令，并重新设置定时任务发送Ping用于维持心跳&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1600.5" y="1680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-90" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-91" target="04FaCHAl2gqULPaclR8Y-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-91" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;CommandPubSubDecoder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;读消息时回调，对RESP协议消息进行解码，以及对解码结果进行进一步处理&lt;br&gt;解码借助 CommandDecoder 实现&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1600.5" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-92" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-94" target="04FaCHAl2gqULPaclR8Y-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#000000;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-94" target="04FaCHAl2gqULPaclR8Y-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-94" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;ErrorsLoggingHandler&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;打印异常、错误日志(如果有的话)&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1700.5" y="1840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-96" target="04FaCHAl2gqULPaclR8Y-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-96" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;DefaultChannelPipeline$TailContext&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1700.5" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-97" value="&lt;font color=&quot;#007fff&quot;&gt;OutBound&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1" connectable="0">
          <mxGeometry x="1900.5" y="1270.0014285714287" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-78" target="04FaCHAl2gqULPaclR8Y-80" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1750.5" y="1340" as="sourcePoint" />
            <mxPoint x="1750.5" y="1360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-110" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;实际调用ChannelHandler时并非一个个地顺序执行，而是通过&lt;b&gt;掩码过滤&lt;/b&gt;跳着执行，可以减少调用深度&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_EXCEPTION_CAUGHT = 1;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_REGISTERED = 1 &amp;lt;&amp;lt; 1;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_UNREGISTERED = 1 &amp;lt;&amp;lt; 2;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_ACTIVE = 1 &amp;lt;&amp;lt; 3;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_INACTIVE = 1 &amp;lt;&amp;lt; 4;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_READ = 1 &amp;lt;&amp;lt; 5;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_READ_COMPLETE = 1 &amp;lt;&amp;lt; 6;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_USER_EVENT_TRIGGERED = 1 &amp;lt;&amp;lt; 7;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CHANNEL_WRITABILITY_CHANGED = 1 &amp;lt;&amp;lt; 8;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_BIND = 1 &amp;lt;&amp;lt; 9;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CONNECT = 1 &amp;lt;&amp;lt; 10;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_DISCONNECT = 1 &amp;lt;&amp;lt; 11;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_CLOSE = 1 &amp;lt;&amp;lt; 12;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_DEREGISTER = 1 &amp;lt;&amp;lt; 13;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_READ = 1 &amp;lt;&amp;lt; 14;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_WRITE = 1 &amp;lt;&amp;lt; 15;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;static final int MASK_FLUSH = 1 &amp;lt;&amp;lt; 16;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1960" y="1710" width="550" height="270" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-112" value="&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2010" y="1455" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-113" value="&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;编码器内部根据RESP协议，对命令进行编码&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;比如：&quot;&lt;b&gt;subscribe topic-1&lt;/b&gt;&quot;, RESP2编码后为(以 char[] 数组展示)：&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;[*, 2, \r, \n, $, 9, \r, \n, S, U, B, S, C, R, I, B, E, \r, \n, $, 7, \r, \n, t, o, p, i, c, -, 1, \r, \n]&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;数组格式：&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;*&amp;lt;number-of-elements&amp;gt;\r\n&amp;lt;element-1&amp;gt;...&amp;lt;element-n&amp;gt;&lt;br&gt;即 * 表示这是个数组，2表示有两个元素，\r\n 分隔数组头部和元素，&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;$, 9, \r, \n, S, U, B, S, C, R, I, B, E, \r, \n, 是第一个元素，$ 表示它是个字符串，9表示字符串长度，\r\n 分隔字符串头部和字符串的值（SUBSCRIBE), 字符串以r\n\结束。&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="2011" y="1400" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-117" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-114" target="04FaCHAl2gqULPaclR8Y-116" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-114" value="topic.publish(&quot;Msg:&quot; + i);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="2800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-116" target="04FaCHAl2gqULPaclR8Y-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-116" value="return &lt;b&gt;commandExecutor&lt;/b&gt;.get(&lt;br&gt;&lt;b&gt;publishAsync&lt;/b&gt;(message));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;commandExecutor 包含连接管理器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="2800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-123" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-118" target="04FaCHAl2gqULPaclR8Y-120" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-118" value="return &lt;b&gt;commandExecutor&lt;/b&gt;.writeAsync(&lt;br&gt;name, StringCodec.INSTANCE, RedisCommands.PUBLISH, name, commandExecutor.encode(codec, message));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="2790" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-122" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-120" target="04FaCHAl2gqULPaclR8Y-121" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-120" value="NodeSource source = getNodeSource(key);&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;计算key对应目标节点，用于集群模式&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1041" y="2800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-126" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-121" target="04FaCHAl2gqULPaclR8Y-125" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-121" value="return async(false, source, codec, command, params, false, false);" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1039" y="2881.25" width="201" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-128" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-125" target="04FaCHAl2gqULPaclR8Y-127" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1740" y="2880" />
              <mxPoint x="1740" y="2980" />
              <mxPoint x="260" y="2980" />
              <mxPoint x="260" y="3220" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-125" value="&lt;div&gt;CompletableFuture&amp;lt;R&amp;gt; mainPromise = createPromise();&lt;/div&gt;&lt;div&gt;RedisExecutor&amp;lt;V, R&amp;gt; executor = new RedisExecutor&amp;lt;&amp;gt;(readOnlyMode, source, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;codec, command, params, mainPromise,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;ignoreRedirect, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;connectionManager&lt;/b&gt;, objectBuilder, referenceType, noRetry,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;retryAttempts, &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;retryInterval, responseTimeout, trackChanges);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;executor.&lt;b&gt;execute&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return new CompletableFutureWrapper&amp;lt;&amp;gt;(mainPromise);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=4;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1281" y="2800" width="439.5" height="160" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-132" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-127" target="04FaCHAl2gqULPaclR8Y-131" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="740" y="3220" />
              <mxPoint x="740" y="3100" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-143" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-132" vertex="1" connectable="0">
          <mxGeometry x="0.0176" y="-1" relative="1" as="geometry">
            <mxPoint x="9" y="-59" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-145" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-127" target="04FaCHAl2gqULPaclR8Y-144" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-146" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-145" vertex="1" connectable="0">
          <mxGeometry x="0.8888" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-127" value="...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;br&gt;CompletableFuture&amp;lt;RedisConnection&amp;gt; connectionFuture = &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;getConnection(attemptPromise);&lt;br&gt;...&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;br&gt;sendCommand(attemptPromise, connection);&lt;br&gt;..." style="rounded=1;whiteSpace=wrap;html=1;arcSize=4;align=left;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="3160" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-130" value="CommandAsyncService" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1064.5" y="2770" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-135" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-131" target="04FaCHAl2gqULPaclR8Y-134" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-141" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-135" vertex="1" connectable="0">
          <mxGeometry x="-0.1588" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-137" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-131" target="04FaCHAl2gqULPaclR8Y-136" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-140" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="04FaCHAl2gqULPaclR8Y-137" vertex="1" connectable="0">
          <mxGeometry x="0.1137" y="4" relative="1" as="geometry">
            <mxPoint x="-4" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-131" value="entry = getEntry(false);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="3070" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-134" value="&lt;div&gt;&lt;b&gt;MasterSlaveEntry&lt;/b&gt; entry = source.getEntry();&lt;/div&gt;&lt;div&gt;if (source.getRedisClient() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; entry = connectionManager.getEntry(source.getRedisClient());&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (entry == null &amp;amp;&amp;amp; source.getSlot() != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (read) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry = connectionManager.&lt;b&gt;getReadEntry&lt;/b&gt;(source.&lt;b&gt;getSlot&lt;/b&gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//非集群模式直接返回连接管理器中的 MasterSlaveEntry&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//集群模式根据slot从连接管理器的 slot2entry 中获取MasterSlaveEntry&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entry = connectionManager.&lt;b&gt;getWriteEntry&lt;/b&gt;(source.&lt;b&gt;getSlot&lt;/b&gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return entry;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=5;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1000" y="3000" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-136" target="04FaCHAl2gqULPaclR8Y-138" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-136" value="return &lt;b&gt;masterConnectionPool&lt;/b&gt;&lt;br&gt;.get(command, false);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;获取MasterSlaveEntry之后根据左边的UML再获取连接思路就很清晰了&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="3220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-142" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-138" target="04FaCHAl2gqULPaclR8Y-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3740" y="3250" />
              <mxPoint x="3740" y="2450" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-138" value="return &lt;b&gt;acquireConnection&lt;/b&gt;(command, entries.peek(), trackChanges);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1000" y="3220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-148" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-144" target="04FaCHAl2gqULPaclR8Y-147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-144" value="&lt;div&gt;if (source.getRedirect() == Redirect.ASK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;CommandData&amp;lt;?, ?&amp;gt;&amp;gt; list = new ArrayList&amp;lt;&amp;gt;(2);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;Void&amp;gt; promise = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; list.add(new CommandData&amp;lt;&amp;gt;(promise, codec, RedisCommands.ASKING, new Object[]{}));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; list.add(new CommandData&amp;lt;&amp;gt;(attemptPromise, codec, command, params));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CompletableFuture&amp;lt;Void&amp;gt; main = new CompletableFuture&amp;lt;&amp;gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; writeFuture = connection.&lt;b&gt;send&lt;/b&gt;(new CommandsData(main, list, false, false));&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; writeFuture = connection.&lt;b&gt;send&lt;/b&gt;(new CommandData&amp;lt;&amp;gt;(attemptPromise, codec, command, params));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;align=left;arcSize=3;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="3320" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-149" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-147" target="04FaCHAl2gqULPaclR8Y-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-147" value="return channel.&lt;b&gt;writeAndFlush&lt;/b&gt;(data);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1241" y="3410" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-150" value="&lt;font color=&quot;#007fff&quot;&gt;这里发布消息居然不是用的 masterPubSubConnectionPool&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="395" y="3290" width="330" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-153" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-152" target="04FaCHAl2gqULPaclR8Y-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-154" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-152" target="ydMWs6PtdbeCtb3DKnso-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-152" value="connect()" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1400" y="1295" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-158" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-155" target="04FaCHAl2gqULPaclR8Y-157" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-155" value="订阅消息回调&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;还是先经过Pipeline inbound，主要就是&lt;br&gt;经过CommandPubSubDecoder这个解码器&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="280" y="2610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-156" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;连接状态：OPEN | CLOSED| CLOSED_IDLE&lt;br&gt;连接失活时 OPEN CLOSED_IDLE 状态的连接&lt;br&gt;可以重连，&lt;b&gt;重连就是获取连接信息重新调用 bootstrap.connect()&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1290" y="1360" width="310" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-160" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-157" target="04FaCHAl2gqULPaclR8Y-159" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-157" value="CommandPubSubDecoder#&lt;br&gt;&lt;b&gt;decodeResult&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="520" y="2610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-159" target="04FaCHAl2gqULPaclR8Y-161" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-159" value="enqueueMessage(result, pubSubConnection, entry);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="760" y="2610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-165" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="04FaCHAl2gqULPaclR8Y-161" target="04FaCHAl2gqULPaclR8Y-164" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-161" value="config.getExecutor().execute(() -&amp;gt; {&lt;br&gt;&amp;nbsp; &amp;nbsp; pubSubConnection.&lt;b&gt;onMessage&lt;/b&gt;(&lt;br&gt;(PubSubStatusMessage) result);&lt;br&gt;})" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1000" y="2610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-164" value="&lt;div&gt;for (RedisPubSubListener&amp;lt;Object&amp;gt; redisPubSubListener : listeners) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //这里 redisPubSubListener 是用户重写的监听器&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; redisPubSubListener.&lt;b&gt;onMessage&lt;/b&gt;(message.getChannel(), message.getValue());&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=11;glass=0;strokeWidth=1;shadow=0;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=7;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1241" y="2600" width="319" height="80" as="geometry" />
        </mxCell>
        <mxCell id="04FaCHAl2gqULPaclR8Y-166" value="RedisPubSubConnection" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1340.5" y="2570" width="160" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
