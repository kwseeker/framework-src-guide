<mxfile host="Electron" modified="2024-10-10T08:15:22.706Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="a59n98DwqC3zGTN5ST6P" version="21.6.5" type="device">
  <diagram name="第 1 页" id="73nSp15eY7MdyeOj_1DI">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="faGJ94Eg3teacLBYdmBA-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;micrometer-registry-prometheus 工作原理（1.9.11）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;测试代码: SpringBoot-Labs/micrometer。&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;这里只分析核心模块（micrometer-core）的工作原理。&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="480" height="110" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-2" target="faGJ94Eg3teacLBYdmBA-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-2" target="faGJ94Eg3teacLBYdmBA-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-26" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-2" target="faGJ94Eg3teacLBYdmBA-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-2" value="&lt;b&gt;监控组件初始化&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;包括指标注册表 MeterRegistry、各种指标类型&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-3" target="faGJ94Eg3teacLBYdmBA-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-3" target="faGJ94Eg3teacLBYdmBA-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-111" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-3" target="faGJ94Eg3teacLBYdmBA-110" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-3" value="&lt;b&gt;业务中统计&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-4" target="faGJ94Eg3teacLBYdmBA-38" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="280" y="1670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-128" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-4" target="faGJ94Eg3teacLBYdmBA-126" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-4" value="&lt;b&gt;上报时读取&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-5" target="faGJ94Eg3teacLBYdmBA-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-5" target="faGJ94Eg3teacLBYdmBA-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-5" value="&lt;b&gt;创建注册表&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-7" value="&lt;b&gt;CompositeMeterRegistry&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-9" target="faGJ94Eg3teacLBYdmBA-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-9" value="&lt;b&gt;SimpleMeterRegistry&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-12" target="faGJ94Eg3teacLBYdmBA-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-85" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-12" target="faGJ94Eg3teacLBYdmBA-84" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-12" value="&lt;b&gt;创建指标类型&lt;br&gt;以及注册&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-14" target="faGJ94Eg3teacLBYdmBA-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-14" value="&lt;b&gt;Counter&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-16" target="faGJ94Eg3teacLBYdmBA-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-16" value="&lt;b&gt;Counter&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-21" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MeterRegistry (A)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;指标注册表的核心实现，不仅仅是指标注册表，还是指标实例Builder(由其实现类创建)&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final Clock&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;clock&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Object meterMapLock = new Object();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile MeterFilter[]&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;filters&lt;/b&gt;&amp;nbsp;= new MeterFilter[0];&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 埋的用于拓展的钩子&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;Consumer&amp;lt;Meter&amp;gt;&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;meterAddedListeners&lt;/b&gt;&amp;nbsp;= new CopyOnWriteArrayList();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;Consumer&amp;lt;Meter&amp;gt;&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;meterRemovedListeners&lt;/b&gt;&amp;nbsp;= new CopyOnWriteArrayList();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;BiConsumer&amp;lt;Meter.Id, String&amp;gt;&amp;gt;&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;meterRegistrationFailedListeners&lt;/b&gt;&amp;nbsp;= new CopyOnWriteArrayList();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Config&amp;nbsp;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;config&lt;/b&gt;&amp;nbsp;= new Config();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final More more = new More();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// Meter.Id -&amp;gt; Meter&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Meter.Id, Meter&amp;gt; &lt;b&gt;meterMap&lt;/b&gt; = new ConcurrentHashMap();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Meter.Id, Set&amp;lt;Meter.Id&amp;gt;&amp;gt; syntheticAssociations = new HashMap();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean closed = new AtomicBoolean();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private PauseDetector pauseDetector = new NoPauseDetector();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;//&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private NamingConvention namingConvention;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;提供了一批各种类型指标的创建、删除方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Counter counter(String name, String... tags)&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-440" y="160" width="400" height="360" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-22" target="faGJ94Eg3teacLBYdmBA-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-22" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;SimpleMeterRegistry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;指标注册表的简单实现&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final SimpleConfig &lt;b&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="560" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-24" target="faGJ94Eg3teacLBYdmBA-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CompositeMeterRegistry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;指标注册表的聚合实现&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean registriesLock;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;MeterRegistry&amp;gt; &lt;b&gt;registries&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;MeterRegistry&amp;gt; &lt;b&gt;unmodifiableRegistries&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;volatile Set&amp;lt;MeterRegistry&amp;gt; &lt;b&gt;nonCompositeDescendants&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicBoolean parentLock;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile Set&amp;lt;CompositeMeterRegistry&amp;gt; &lt;b&gt;parents&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="560" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-28" target="faGJ94Eg3teacLBYdmBA-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-28" value="SimpleMeterRegistry simpleMeterRegistry = new SimpleMeterRegistry();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-30" target="faGJ94Eg3teacLBYdmBA-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-43" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="faGJ94Eg3teacLBYdmBA-42" vertex="1" connectable="0">
          <mxGeometry x="-0.3" y="-2" relative="1" as="geometry">
            <mxPoint y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-30" value="Counter counter1 = simpleMeterRegistry.&lt;b&gt;counter&lt;/b&gt;(&quot;counter_1&quot;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-32" target="faGJ94Eg3teacLBYdmBA-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-32" value="counter1.&lt;b&gt;increment&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-38" target="faGJ94Eg3teacLBYdmBA-36" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="1670" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-36" target="faGJ94Eg3teacLBYdmBA-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-36" value="double count = counter1.count();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-38" value="&lt;b&gt;Counter&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-39" value="this(SimpleConfig.&lt;b&gt;DEFAULT&lt;/b&gt;, Clock.&lt;b&gt;SYSTEM&lt;/b&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-41" target="faGJ94Eg3teacLBYdmBA-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-41" value="return Counter.builder(name).tags(tags)&lt;br&gt;.&lt;b&gt;register&lt;/b&gt;(this);&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-45" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Counter.builder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;Counter类型指标的Builder（说是Counter配置更合适）, 其实本身不提供build()方法而是通过 MeterRegistry创建 Counter 指标实例的&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final String name;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标的标签&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Tags tags = Tags.empty();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标描述信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private String description;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标值的单位&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private String baseUnit;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 重要方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个方法就是创建Counter的方法，又是将Counter注册到注册表的方法，&lt;br&gt;// 内部通过调用 MeterRegistry 实现创建 Counter实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Counter &lt;b&gt;register&lt;/b&gt;(MeterRegistry registry)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="760" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-46" value="MeterRegistry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1050" y="850" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-47" target="faGJ94Eg3teacLBYdmBA-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-47" value="return Counter.builder(name).tags(tags)&lt;br&gt;.&lt;b&gt;register&lt;/b&gt;(this);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-49" target="faGJ94Eg3teacLBYdmBA-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-49" value="return registry.&lt;b&gt;counter&lt;/b&gt;(new Meter.Id(name, tags, baseUnit, description, Type.COUNTER));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即还是通过 MeterRegistry 创建的监控指标实例&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-51" value="Counter" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1306" y="850" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-52" value="MeterRegistry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1770" y="850" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-53" target="faGJ94Eg3teacLBYdmBA-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-53" value="return &lt;b&gt;registerMeterIfNecessary&lt;/b&gt;(Counter.class, id, this::&lt;b&gt;newCounter&lt;/b&gt;, NoopCounter::new);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-55" target="faGJ94Eg3teacLBYdmBA-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-55" value="&lt;div&gt;Id mappedId = &lt;b&gt;getMappedId&lt;/b&gt;(id);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 此Id对应的指标不存在就创建，存在直接返回&lt;/font&gt;&lt;/div&gt;&lt;div&gt;Meter m = &lt;b&gt;getOrCreateMeter&lt;/b&gt;(config, builder, id, mappedId, noopBuilder);&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;return meterClass.cast(m);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="1960" y="880" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-63" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.575;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-57" target="faGJ94Eg3teacLBYdmBA-61" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2880" y="1180" />
              <mxPoint x="2900" y="1180" />
              <mxPoint x="2900" y="950" />
              <mxPoint x="740" y="950" />
              <mxPoint x="740" y="990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-57" value="&lt;div&gt;Meter m = meterMap.get(mappedId);&lt;/div&gt;&lt;div&gt;if (m == null) { &lt;font color=&quot;#007fff&quot;&gt;// 不存在则创建 Meter&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (isClosed()) { &lt;font color=&quot;#007fff&quot;&gt;// 注册表关闭的话，就直接返回一个 NoopCounter (是个空壳)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return noopBuilder.apply(mappedId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;synchronized&lt;/b&gt; (meterMapLock) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; m = meterMap.get(mappedId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (m == null) {&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// DCL 防止并发重复创建&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 下面是指标创建逻辑&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp; accept() 遍历注册表内部的 MeterFilter 的 accept()，如果指标被拒绝同样返回 NoopCounter&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (!&lt;b&gt;accept&lt;/b&gt;(mappedId)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return noopBuilder.apply(mappedId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (config != null) {&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt; // 这段代码说明可以通过配置类配置 MeterFilter&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (MeterFilter filter : filters) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;DistributionStatisticConfig&lt;/b&gt; filteredConfig = filter.&lt;b&gt;configure&lt;/b&gt;(mappedId, config);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (filteredConfig != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; config = filteredConfig;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // builder 其实是 MeterRegistry 中创建指标的 newXxx 方法，比如 newCounter()&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; m = &lt;b&gt;builder&lt;/b&gt;.&lt;b&gt;apply&lt;/b&gt;(mappedId, config);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Id synAssoc = mappedId.syntheticAssociation(); &lt;font color=&quot;#007fff&quot;&gt;// TODO&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (synAssoc != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Set&amp;lt;Id&amp;gt; associations = syntheticAssociations.computeIfAbsent(synAssoc, k -&amp;gt; new HashSet&amp;lt;&amp;gt;());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; associations.add(mappedId);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 调用拓展钩子&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (Consumer&amp;lt;Meter&amp;gt; onAdd : meterAddedListeners) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; onAdd.accept(m);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;// 指标注册&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;meterMap&lt;/b&gt;.put(mappedId, m);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;return m;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2440" y="880" width="440" height="520" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-59" value="目标：&lt;br&gt;&lt;ul&gt;&lt;li&gt;工作流程&lt;/li&gt;&lt;li&gt;里面各种组件的作用和用法&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;比如： 各种MeterRegistry指标注册表实现、各种指标类型Meter实现（包括Meter.Id）、指标过滤器MeterFilter的工作原理&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="560" y="10" width="720" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-60" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MeterFilter (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;MeterFileter的功能（从接口方法上看）包括：&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;1 修改标签Tag: 包括为指标添加公共标签、重命名标签&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;2 指标注册时过滤：可以接受或拒绝指标的注册、限制注册的指标的数量&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;具体参考其过滤方法实现&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 默认提供的一批 MeterFileter 过滤器的创建方法&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;static MeterFilter commonTags(Iterable&amp;lt;Tag&amp;gt; tags)&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter renameTag(String meterNamePrefix, String fromTagKey, String toTagKey)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter ignoreTags(String... tagKeys)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter replaceTagValues(String tagKey, Function&amp;lt;String, String&amp;gt; replacement, String... exceptions)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter denyUnless(Predicate&amp;lt;Meter.Id&amp;gt; iff)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter accept(Predicate&amp;lt;Meter.Id&amp;gt; iff)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter deny(Predicate&amp;lt;Meter.Id&amp;gt; iff)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;static MeterFilter maximumAllowableMetrics(int maximumTimeSeries)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-440" y="1080" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-65" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-61" target="faGJ94Eg3teacLBYdmBA-66" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1000" y="750" as="targetPoint" />
            <Array as="points">
              <mxPoint x="970" y="990" />
              <mxPoint x="970" y="860" />
              <mxPoint x="740" y="860" />
              <mxPoint x="740" y="300" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-61" value="MeterRegistry#&lt;b&gt;newCounter&lt;/b&gt;(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;指标实例的创建是调用的这个方法&lt;br&gt;这个方法在 MeterRegistry 中是抽象方法&lt;br&gt;&lt;/b&gt;由具体的实现类提供实现&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-66" target="faGJ94Eg3teacLBYdmBA-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-66" value="protected Counter &lt;b&gt;newCounter&lt;/b&gt;(Meter.Id id)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="270" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-67" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//共有两种模式: CumulativeCounter、Step&lt;/font&gt;&lt;/div&gt;&lt;div&gt;switch (config.mode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;CUMULATIVE&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;// 默认&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new &lt;b&gt;CumulativeCounter&lt;/b&gt;(id);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;STEP&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;//TODO&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return new &lt;b&gt;StepCounter&lt;/b&gt;(id, clock, config.step().toMillis());&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1000" y="240" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-69" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Counter (I)&lt;/b&gt;&amp;nbsp;extends &lt;b&gt;Meter&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;Counter类型指标的接口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot;&gt;static Builder builder(String name)&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default void &lt;b&gt;increment&lt;/b&gt;()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void &lt;b&gt;increment&lt;/b&gt;(double amount)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;double &lt;b&gt;count&lt;/b&gt;();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default Iterable&amp;lt;Measurement&amp;gt; measure()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-440" y="1360" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-71" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-72" target="faGJ94Eg3teacLBYdmBA-69" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-240" y="1560" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-73" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-72" target="faGJ94Eg3teacLBYdmBA-74" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-240" y="1680" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-72" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CumulativeCounter&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends AbstractMeter&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;累积的计数器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 计数类型还是用的 DoubleAdder, 提高并发计算效率&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;DoubleAdder&lt;/b&gt; &lt;b&gt;value&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="1560" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-74" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;AbstractMeter&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 只是实现ID表示&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final Meter.Id &lt;b&gt;id&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-880" y="1400" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-75" target="faGJ94Eg3teacLBYdmBA-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-77" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;dashed=1;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-75" target="faGJ94Eg3teacLBYdmBA-69" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-580" y="1550" />
              <mxPoint x="-240" y="1550" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-79" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-75" target="faGJ94Eg3teacLBYdmBA-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-75" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;StepCounter&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;步进计数器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;// 计数类型还是用的 DoubleAdder, 提高并发计算效率&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;StepDouble&lt;/b&gt; &lt;b&gt;value&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="1560" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-78" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;StepMeter&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="1400" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-80" value="以 CumulativeCounter 为例，就是&lt;br&gt;value.add(amount);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-82" value="&lt;div&gt;以 CumulativeCounter 为例，就是&lt;/div&gt;&lt;div&gt;return value.sum();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-84" target="faGJ94Eg3teacLBYdmBA-86" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-84" value="&lt;b&gt;Timer&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-89" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-86" target="faGJ94Eg3teacLBYdmBA-88" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-86" value="Timer timer = simpleMeterRegistry.timer(&quot;some-service.http.requests&quot;, &quot;/login&quot;, &quot;POST&quot;);&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-88" target="faGJ94Eg3teacLBYdmBA-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-93" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="faGJ94Eg3teacLBYdmBA-91" vertex="1" connectable="0">
          <mxGeometry x="-0.1707" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-88" value="省略和 Counter 类似的流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-90" target="faGJ94Eg3teacLBYdmBA-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-90" value="&lt;div&gt;return registry.&lt;b&gt;timer&lt;/b&gt;(new Meter.Id(name, tags, null, description, Type.TIMER),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;distributionConfigBuilder&lt;/b&gt;.build(), &lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 这个用于创建累积直方图和百分位直方图的统计配置&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;pauseDetector&lt;/b&gt; == null ? registry.config().pauseDetector() : pauseDetector);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1040" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-97" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-94" target="faGJ94Eg3teacLBYdmBA-96" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2179" y="1070" />
              <mxPoint x="2179" y="1130" />
              <mxPoint x="740" y="1130" />
              <mxPoint x="740" y="1170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-94" value="&lt;div&gt;return registerMeterIfNecessary(Timer.class, id, distributionStatisticConfig,&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// Timer 指标创建逻辑&lt;/font&gt;&amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;b&gt;(id2, filteredConfig) -&amp;gt; {&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; Meter.Id withUnit = id2.withBaseUnit(getBaseTimeUnitStr());&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; return newTimer(withUnit, filteredConfig.merge(defaultHistogramConfig()), pauseDetectorOverride);&lt;/b&gt;&lt;/div&gt;&lt;div&gt;}, NoopTimer::new);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1020" width="439" height="100" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-99" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-96" target="faGJ94Eg3teacLBYdmBA-98" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="980" y="1170" />
              <mxPoint x="980" y="850" />
              <mxPoint x="750" y="850" />
              <mxPoint x="750" y="500" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-96" value="MeterRegistry#&lt;b&gt;newTimer&lt;/b&gt;(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;指标实例的创建是调用的这个方法&lt;br&gt;这个方法在 MeterRegistry 中是抽象方法&lt;br&gt;&lt;/b&gt;由具体的实现类提供实现&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-98" target="faGJ94Eg3teacLBYdmBA-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-98" value="&lt;div&gt;protected Timer &lt;b&gt;newTimer&lt;/b&gt;(Meter.Id id, &lt;b&gt;DistributionStatisticConfig&lt;/b&gt; distributionStatisticConfig,&lt;/div&gt;&lt;div&gt;&lt;b&gt;PauseDetector&lt;/b&gt; pauseDetector)&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="470" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-100" target="faGJ94Eg3teacLBYdmBA-108" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-100" value="&lt;div&gt;DistributionStatisticConfig merged = distributionStatisticConfig&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .merge(DistributionStatisticConfig.builder().expiry(config.step()).build());&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Timer timer;&lt;/div&gt;&lt;div&gt;switch (config.mode()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;CUMULATIVE&lt;/b&gt;: &lt;font color=&quot;#007fff&quot;&gt;// 默认&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;// 1&amp;nbsp;&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; timer = new &lt;b&gt;CumulativeTimer&lt;/b&gt;(id, clock, merged, pauseDetector, getBaseTimeUnit(), false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; case &lt;b&gt;STEP&lt;/b&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; default:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; timer = new &lt;b&gt;StepTimer&lt;/b&gt;(id, clock, merged, pauseDetector, getBaseTimeUnit(), config.step().toMillis(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; false);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;HistogramGauges.registerWithCommonFormat(timer, this);&lt;/div&gt;&lt;div&gt;return timer;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1001" y="380" width="440" height="240" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-107" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-102" target="faGJ94Eg3teacLBYdmBA-103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-124" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=-0.002;exitY=0.714;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="faGJ94Eg3teacLBYdmBA-102" target="faGJ94Eg3teacLBYdmBA-123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-102" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CumulativeTimer&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;累积计时器&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 统计次数&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong &lt;b&gt;count&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 所有统计总时间&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong &lt;b&gt;total&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 统计时间窗口内最大值，max() 方法获取从180s前到现在record()记录的最大值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;TimeWindowMax&lt;/b&gt; &lt;b&gt;max&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="2280" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-106" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-103" target="faGJ94Eg3teacLBYdmBA-104" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-103" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;AbstractTimer&lt;/b&gt; extends AbstractMeter implements &lt;b&gt;Timer&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private static final Map&amp;lt;PauseDetector, Object&amp;gt; &lt;b&gt;pauseDetectorCache&lt;/b&gt; = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// Clock 就是用于获取时间的，Clock.SYSTEM&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;简单封装了 currentTimeMillis() nanoTime()&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final Clock &lt;b&gt;clock&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 用于统计百分比直方图、累积直方图，不设置直方图配置这里就是&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;font color=&quot;#007fff&quot;&gt;NoopHistogram.INSTANCE&lt;/font&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;protected final Histogram &lt;b&gt;histogram&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final TimeUnit &lt;b&gt;baseTimeUnit&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//区间估计？ TODO&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//Only used when pause detection is enabled&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Object &lt;b&gt;intervalEstimator&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private org.LatencyUtils.PauseDetector &lt;b&gt;pauseDetector&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-880" y="2000" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-104" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Timer &lt;/b&gt;extends Meter, &lt;b&gt;HistogramSupport&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;Timer 继承 HistogramSupport 即支持百分位直方图统计&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;static Sample start()&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;static Sample start(MeterRegistry registry)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;static Sample start(Clock clock)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;void record(long amount, TimeUnit unit)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;default void record(Duration duration)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;...&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;long count()&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;//stop() 方法被调用的次数&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;double totalTime(TimeUnit unit)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;default double mean(TimeUnit unit)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;double max(TimeUnit unit)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 百分位、直方图统计配置方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;default double percentile(double percentile, TimeUnit unit)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;TimeUnit baseTimeUnit()&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-880" y="1720" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-105" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Timer.builder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;Counter类型指标的Builder（说是Counter配置更合适）, 其实本身不提供build()方法而是通过 MeterRegistry创建 Counter 指标实例的&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标名&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final String name;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标的标签&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private Tags tags = Tags.empty();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标描述信息&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private String description;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;// 指标值的单位&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private String baseUnit;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 重要方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这个方法就是创建Counter的方法，又是将Counter注册到注册表的方法，&lt;br&gt;// 内部通过调用 MeterRegistry 实现创建 Counter实例&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public Counter &lt;b&gt;register&lt;/b&gt;(MeterRegistry registry)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="1720" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-108" value="&lt;div&gt;if (distributionStatisticConfig.&lt;b&gt;isPublishingPercentiles&lt;/b&gt;()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.histogram = new &lt;b&gt;TimeWindowPercentileHistogram&lt;/b&gt;(clock, distributionStatisticConfig,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; supportsAggregablePercentiles);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;else if (distributionStatisticConfig.&lt;b&gt;isPublishingHistogram&lt;/b&gt;()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.histogram = new &lt;b&gt;TimeWindowFixedBoundaryHistogram&lt;/b&gt;(clock, distributionStatisticConfig,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; supportsAggregablePercentiles);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.histogram = NoopHistogram.INSTANCE;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="1480" y="430" width="440" height="140" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-113" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-110" target="faGJ94Eg3teacLBYdmBA-112" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-110" value="&lt;b&gt;Timer&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-112" target="faGJ94Eg3teacLBYdmBA-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-112" value="timer.&lt;b&gt;record&lt;/b&gt;(() -&amp;gt; {...});" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-117" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-114" target="faGJ94Eg3teacLBYdmBA-116" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-114" value="以 CumulativeTimer 为例" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-116" target="faGJ94Eg3teacLBYdmBA-118" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-116" value="&lt;div&gt;final long s = clock.&lt;b&gt;monotonicTime&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;try {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; f.run();&lt;/div&gt;&lt;div&gt;}&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;finally {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; final long e = clock.&lt;b&gt;monotonicTime&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;record&lt;/b&gt;(e - s, TimeUnit.NANOSECONDS);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1001" y="1480" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-121" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-118" target="faGJ94Eg3teacLBYdmBA-120" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-143" value="&lt;font&gt;2&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" parent="faGJ94Eg3teacLBYdmBA-121" vertex="1" connectable="0">
          <mxGeometry x="0.2574" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-141" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=#000000;fontColor=#FEFAE0;fillColor=#BC6C25;" parent="1" source="faGJ94Eg3teacLBYdmBA-118" target="faGJ94Eg3teacLBYdmBA-140" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-142" value="&lt;font&gt;1&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#000000;" parent="faGJ94Eg3teacLBYdmBA-141" vertex="1" connectable="0">
          <mxGeometry x="0.8236" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-118" value="&lt;div&gt;if (amount &amp;gt;= 0) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; //1 直方图数据统计，如果没设置直方图配置，里面不会做任何事&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; histogram.&lt;b&gt;recordLong&lt;/b&gt;(TimeUnit.NANOSECONDS.convert(amount, unit));&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//2 计时器本身的统计，统计次数、总的时间、时间窗统计&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;recordNonNegative&lt;/b&gt;(amount, unit);&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 区间估计? TODO&lt;/font&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (intervalEstimator != null) {&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ((IntervalEstimator) intervalEstimator).&lt;b&gt;recordInterval&lt;/b&gt;(clock.monotonicTime());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1470" width="439" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-120" target="faGJ94Eg3teacLBYdmBA-133" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-120" value="&lt;div&gt;protected void recordNonNegative(long amount, TimeUnit unit) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long nanoAmount = (long) TimeUtils.convert(amount, unit, TimeUnit.NANOSECONDS);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;count&lt;/b&gt;.getAndAdd(1);&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;total&lt;/b&gt;.getAndAdd(nanoAmount);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //&amp;nbsp;TimeWindowMax&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;max&lt;/b&gt;.&lt;b&gt;record&lt;/b&gt;(nanoAmount, TimeUnit.NANOSECONDS);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1480" width="439" height="100" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-122" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;max = {TimeWindowMax@1859}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;clock = {Clock$1@1815}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;durationBetweenRotatesMillis = 60000&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;ringBuffer = {AtomicLong[3]@1888}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;currentBucket = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;lastRotateTimestampMillis = 1726222571108&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 11px;&quot;&gt;&amp;nbsp;rotating = 0&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1580" width="250" height="110" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-123" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;TimeWindowMax&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;An implementation of a decaying maximum for a distribution based on a configurable ring buffer. 这是官方注释，不知道说的啥&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;分析源码实现其实这个类用于&lt;b&gt;记录一个时间窗口内最大值，&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;TimeWindowMax 默认存储3个元素、时间窗长度 60s×3，通过 max() 可以读取从180s前到现在 record() 记录的最大值&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;private final Clock clock;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 轮换时间，默认60s, 其实是设置 RingBuffer中数据的有效期 ringBuffer.length *&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;span style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;durationBetweenRotatesMillis，就是每个值最长有效器，rotate() 方法会清除 ringBuffer中过期数据&lt;/font&gt;&lt;/span&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;durationBetweenRotatesMillis&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private final AtomicLong[] &lt;b&gt;ringBuffer&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 总是指向最旧的Bucket&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private int &lt;b&gt;currentBucket&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile long &lt;b&gt;lastRotateTimestampMillis&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 轮换状态&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin: 0px 0px 0px 4px;&quot;&gt;private volatile int &lt;b&gt;rotating&lt;/b&gt;; // 0 - not rotating, 1 - rotating&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="2280" width="400" height="240" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-125" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-126" target="faGJ94Eg3teacLBYdmBA-127" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-126" value="&lt;b&gt;Timer&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-127" target="faGJ94Eg3teacLBYdmBA-129" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-127" value="double count = timer.count();&lt;br&gt;double totalTime = timer.totalTime(TimeUnit.MILLISECONDS);&lt;br&gt;double max = timer.&lt;b&gt;max&lt;/b&gt;(TimeUnit.MILLISECONDS);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-129" target="faGJ94Eg3teacLBYdmBA-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-129" value="以 CumulativeTimer 为例&lt;br&gt;这里只展示 max() 方法" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-131" target="faGJ94Eg3teacLBYdmBA-135" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-131" value="return max.poll(unit);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1001" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-138" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="faGJ94Eg3teacLBYdmBA-133" target="faGJ94Eg3teacLBYdmBA-137" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-133" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 看代码此方法用于重置&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;ringBuffer中过期数据，&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;rotate&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//比较更新ringBuffer中所有值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;for (AtomicLong max : ringBuffer) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; updateMax(max, sample);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1490" width="439" height="80" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-135" value="&lt;div&gt;&lt;b&gt;rotate&lt;/b&gt;(); &lt;font color=&quot;#007fff&quot;&gt;//先清除过期数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;synchronized (this) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //提取ringBuffer中最大值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return maxSupplier.&lt;b&gt;getAsDouble&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-137" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// rotate() 中关键代码&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;// 这个if条件满足的话说明ringBuffer中所有值都过期了，全部重置&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (timeSinceLastRotateMillis &amp;gt;= durationBetweenRotatesMillis * ringBuffer.length) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; // time since last rotation is enough to clear whole ring buffer&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (AtomicLong bufferItem : ringBuffer) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bufferItem.set(0);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; currentBucket = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; lastRotateTimestampMillis = wallTime - timeSinceLastRotateMillis % durationBetweenRotatesMillis;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;// 说明未全部过期，只清除过期的数据，currentBucket总是指向最旧的数据&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int iterations = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;do {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; ringBuffer[currentBucket].set(0);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (++currentBucket &amp;gt;= ringBuffer.length) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; currentBucket = 0;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; timeSinceLastRotateMillis -= durationBetweenRotatesMillis;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; lastRotateTimestampMillis += durationBetweenRotatesMillis;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;while (timeSinceLastRotateMillis &amp;gt;= durationBetweenRotatesMillis &amp;amp;&amp;amp; ++iterations &amp;lt; ringBuffer.length);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1490" width="439" height="270" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-139" value="&lt;font color=&quot;#007fff&quot;&gt;rotate() 的逻辑举个例子更好理解：&lt;br&gt;&lt;b&gt;ringBuffer初始：&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;currentBucket = 0, 数组 [0,0,0]&lt;br&gt;&lt;b&gt;假设第0秒插入一个值 200:&lt;br&gt;&lt;/b&gt;rotate() 后 ringBuffer 不变，currentBucket = 0&lt;br&gt;updateMax() 后&amp;nbsp;currentBucket = 0, 数组 [200,200,200]&lt;br&gt;&lt;/font&gt;&lt;b style=&quot;border-color: var(--border-color); color: rgb(0, 127, 255);&quot;&gt;假设第60秒插入一个值 100:&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;rotate() 后 currentBucket = 1, 数组 [0,200,200]&lt;br&gt;&lt;/font&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;updateMax() 后&amp;nbsp;currentBucket = 1, 数组 [100,200,200]&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/font&gt;&lt;b style=&quot;border-color: var(--border-color); color: rgb(0, 127, 255);&quot;&gt;假设第120秒插入一个值 50:&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/b&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;rotate() 后 currentBucket = 2, 数组 [100,0,200]&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;updateMax() 后 currentBucket = 2, 数组 [100,50,200]&lt;br&gt;在第 30, 90, 150, 210, 270, 330 秒时通过 max 拿到的值分别是：&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 200, 200, 200, 100, 50, 0&amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="2320" y="1580" width="310" height="180" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-140" value="" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1360" width="439" height="100" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-145" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=#000000;fontColor=#FEFAE0;fillColor=#BC6C25;" parent="1" source="faGJ94Eg3teacLBYdmBA-144" target="faGJ94Eg3teacLBYdmBA-96" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1220" y="1280" />
              <mxPoint x="1220" y="1210" />
              <mxPoint x="740" y="1210" />
              <mxPoint x="740" y="1170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-146" value="&lt;font color=&quot;#000000&quot;&gt;...&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#FEFAE0;" parent="faGJ94Eg3teacLBYdmBA-145" vertex="1" connectable="0">
          <mxGeometry x="-0.9534" y="4" relative="1" as="geometry">
            <mxPoint x="6" y="-6" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-144" value="&lt;div&gt;Timer timer = Timer.builder(&quot;some-service.http.requests&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .tags(&quot;/login&quot;, &quot;POST&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .publishPercentileHistogram()&amp;nbsp; &amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;//启用百分位直方图统计&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .publishPercentiles(0.5, 0.9, 0.99) &lt;font color=&quot;#007fff&quot;&gt;// 只要有配置这个就会启用百分位直方图统计&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //累积直方图配置&lt;/font&gt;&lt;/div&gt;&amp;nbsp; &amp;nbsp; .serviceLevelObjectives(Duration.ofMillis(100), Duration.ofMillis(300), Duration.ofMillis(500))&lt;div&gt;&amp;nbsp; &amp;nbsp; .minimumExpectedValue(Duration.ofMillis(1))&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .maximumExpectedValue(Duration.ofMillis(1000))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .register(simpleMeterRegistry);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;累积直方图和百分比直方图统计&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;" parent="1" vertex="1">
          <mxGeometry x="760" y="1220" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="faGJ94Eg3teacLBYdmBA-147" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;HistogramSnapshot 两种直方图结果&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;percentileValues = {ValueAtPercentile[3]@2145}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 0 = {ValueAtPercentile@2155} &quot;(9.961472E7 at 50.0%)&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 1 = {ValueAtPercentile@2156} &quot;(5.02267904E8 at 90.0%)&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 2 = {ValueAtPercentile@2157} &quot;(5.69376768E8 at 99.0%)&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;histogramCounts = {CountAtBucket[3]@2146}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 0 = {CountAtBucket@2150} &quot;(5.0 at 1.0E8)&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 1 = {CountAtBucket@2151} &quot;(8.0 at 3.0E8)&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 2 = {CountAtBucket@2152} &quot;(9.0 at 5.0E8)&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#FEFAE0;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1210" width="340" height="140" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
