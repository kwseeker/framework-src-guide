<mxfile host="Electron" modified="2024-10-06T08:39:05.302Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="RQGHJTbuvLirPLulYSIP" version="21.6.5" type="device">
  <diagram name="第 1 页" id="bCxN-LvEiLH-SmEH9Oog">
    <mxGraphModel dx="3915" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Prometheus client java 工作原理（1.3.1）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;测试代码: prometheus/prometheus-client-01。&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;这个Demo中注册了两种监控指标，JvmMetrics 和 自定义的 Counter 类型监控指标。&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="420" height="90" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=10;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-2" target="ZjhWudJOdr6Pg1GAmp3d-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-2" target="ZjhWudJOdr6Pg1GAmp3d-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-2" value="&lt;b&gt;JvmMetrics 监控指标注册&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;JvmMetrics内部向 PrometheusRegistry 注册了一组监控指标&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=10;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-3" target="ZjhWudJOdr6Pg1GAmp3d-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-3" target="ZjhWudJOdr6Pg1GAmp3d-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-3" value="&lt;b&gt;自定义 Counter 类型监控指标注册&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;向 PrometheusRegistry 注册了一个自定义监控指标&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-5" target="ZjhWudJOdr6Pg1GAmp3d-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-5" value="&lt;b&gt;HTTPServer&lt;/b&gt; 启动 HTTP 服务&lt;br style=&quot;font-size: 10px;&quot;&gt;提供监控接口&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;HttpServer 只是四种 Exporter 中的其中一种&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-18" target="ZjhWudJOdr6Pg1GAmp3d-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-33" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-7" target="ZjhWudJOdr6Pg1GAmp3d-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-34" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-33" vertex="1" connectable="0">
          <mxGeometry x="0.2667" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-7" value="JvmMetrics&lt;br&gt;.&lt;b&gt;builder&lt;/b&gt;() //1&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;register&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;(); //2&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-9" target="ZjhWudJOdr6Pg1GAmp3d-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-9" target="ZjhWudJOdr6Pg1GAmp3d-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-9" value="&lt;div&gt;&lt;div&gt;&lt;div&gt;Counter counter = Counter.builder()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .name(&quot;my_count_total&quot;) &lt;font color=&quot;#007fff&quot;&gt;//写到元数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .help(&quot;example counter&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .labelNames(&quot;status&quot;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;register&lt;/b&gt;();&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-11" value="&lt;div&gt;counter.labelValues(&quot;ok&quot;).inc();&lt;/div&gt;&lt;div&gt;counter.labelValues(&quot;ok&quot;).inc();&lt;/div&gt;&lt;div&gt;counter.labelValues(&quot;error&quot;).inc();&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;这里写死了两条监控数据&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-13" target="ZjhWudJOdr6Pg1GAmp3d-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-13" value="&lt;div&gt;HTTPServer server = HTTPServer.builder()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .port(9400)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;buildAndStart&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;HTTPServer 是借助JDK &lt;b&gt;HTTPServer&lt;/b&gt; 实现的简单 HTTP服务器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-15" target="ZjhWudJOdr6Pg1GAmp3d-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;JvmMetrics$&lt;/b&gt;&lt;b style=&quot;background-color: initial; font-size: 10px;&quot;&gt;Builder&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 通过 PrometheusPropertiesLoader.load() 加载的属性&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;private final &lt;b style=&quot;font-size: 10px;&quot;&gt;PrometheusProperties&lt;/b&gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;config&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="120" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-16" target="ZjhWudJOdr6Pg1GAmp3d-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-16" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 根据后面的代码这里面实际就是向 PrometheusRegistry 单例对象中注册了多组监控指标，每组监控指标有多个监控指标（采集器），基本每种 &lt;b&gt;Metrics&lt;/b&gt; 类型对应一种 &lt;b&gt;MXBean&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;public void register(PrometheusRegistry registry) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmThreadsMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmBufferPoolMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmClassLoadingMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmCompilationMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmGarbageCollectorMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmMemoryPoolAllocationMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmMemoryMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmNativeMemoryMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;JvmRuntimeInfoMetric&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;ProcessMetrics&lt;/b&gt;.builder(this.config).register(registry);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="340" width="440" height="180" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-7" target="ZjhWudJOdr6Pg1GAmp3d-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="270" as="sourcePoint" />
            <mxPoint x="800" y="320" as="targetPoint" />
            <Array as="points">
              <mxPoint x="500" y="270" />
              <mxPoint x="500" y="430" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-35" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-19" vertex="1" connectable="0">
          <mxGeometry x="0.8978" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-18" target="ZjhWudJOdr6Pg1GAmp3d-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-18" value="this.&lt;b&gt;register&lt;/b&gt;(PrometheusRegistry&lt;br&gt;.&lt;b&gt;defaultRegistry&lt;/b&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-20" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PrometheusRegistry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;单例模式，Prometheus监控指标注册列表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public &lt;b&gt;static&lt;/b&gt; final PrometheusRegistry &lt;b&gt;defaultRegistry&lt;/b&gt; = new PrometheusRegistry();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 指标名称集合&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Set&amp;lt;String&amp;gt; prometheusNames = ConcurrentHashMap.newKeySet();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;// 注册的数据采集器&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;Collector&amp;gt; collectors = new CopyOnWriteArrayList();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// MultiCollector, todo&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final List&amp;lt;MultiCollector&amp;gt; multiCollectors = new CopyOnWriteArrayList();&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-440" y="240" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-21" target="ZjhWudJOdr6Pg1GAmp3d-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-21" value="&lt;div&gt;&lt;b&gt;ThreadMXBean&lt;/b&gt; threadBean = this.threadBean != null ? this.threadBean : &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ManagementFactory.getThreadMXBean();&lt;/div&gt;&lt;div&gt;boolean isNativeImage = this.isNativeImage != null ? this.isNativeImage : &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;NativeImageChecker.isGraalVmNativeImage;&lt;/div&gt;&lt;div&gt;(new &lt;b&gt;JvmThreadsMetrics&lt;/b&gt;(isNativeImage, threadBean, this.config)).&lt;b&gt;register&lt;/b&gt;(registry);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="390" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-23" target="ZjhWudJOdr6Pg1GAmp3d-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-23" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;注册一组监控指标，这里举一个例子, jvm_threads_current 这个监控指标查询当前JVM线程数量&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;((GaugeWithCallback.Builder)((GaugeWithCallback.Builder)GaugeWithCallback.builder(this.config)&lt;/div&gt;&lt;div&gt;.name(&quot;jvm_threads_current&quot;)).help(&quot;Current thread count of a JVM&quot;))&lt;br&gt;.callback((callback) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; callback.call((double)this.threadBean.getThreadCount(), new String[0]);&lt;/div&gt;&lt;div&gt;}).&lt;b&gt;register&lt;/b&gt;(registry);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1720" y="390" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-26" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 构建的是 Metric 类型，也即数据采集器&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;M metric = this.&lt;b&gt;build&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;registry.&lt;b&gt;register&lt;/b&gt;(metric);&lt;/div&gt;&lt;div&gt;return metric;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-28" target="ZjhWudJOdr6Pg1GAmp3d-26" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2180" y="590" />
              <mxPoint x="2180" y="430" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-59" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-28" target="ZjhWudJOdr6Pg1GAmp3d-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-28" value="return this.&lt;b&gt;register&lt;/b&gt;(&lt;br&gt;PrometheusRegistry.&lt;b&gt;defaultRegistry&lt;/b&gt;);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-30" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PrometheusProperties&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;单例模式，Prometheus 配置属性&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final PrometheusProperties &lt;b&gt;instance&lt;/b&gt; = PrometheusPropertiesLoader.load();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MetricsProperties defaultMetricsProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String, MetricsProperties&amp;gt; metricProperties = new HashMap();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExemplarsProperties exemplarProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExporterProperties exporterProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExporterFilterProperties exporterFilterProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExporterHttpServerProperties exporterHttpServerProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExporterOpenTelemetryProperties exporterOpenTelemetryProperties;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExporterPushgatewayProperties exporterPushgatewayProperties;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="120" width="400" height="200" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-32" value="return new Builder(&lt;b&gt;PrometheusProperties&lt;/b&gt;.get());" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-36" target="ZjhWudJOdr6Pg1GAmp3d-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-36" value="PrometheusProperties instance = PrometheusPropertiesLoader.&lt;b&gt;load&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;左边获取的配置属性来源于load()方法，加载逻辑参考方法实现，包括从ClassPath、文件、系统属性等&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-91" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-38" target="ZjhWudJOdr6Pg1GAmp3d-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-38" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Collector (I)&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;监控数据采集器接口&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;MetricSnapshot collect();&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-440" y="440" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-39" value="&lt;font color=&quot;#007fff&quot;&gt;JVM监控数据都是通过 MXBean 查询的&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="160" y="320" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-41" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;dashed=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-42" target="ZjhWudJOdr6Pg1GAmp3d-38" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-240" y="560" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-42" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;Metric（A）&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;监控指标&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 监控指标的标签列表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final Labels &lt;b&gt;constLabels&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="560" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-43" target="ZjhWudJOdr6Pg1GAmp3d-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-43" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MetricWithFixedMetadata&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;（A）&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;带者元数据的监控指标&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 元数据包括指标名称、prometheusName、帮助信息、unit （单位，比如s, 可选）&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;MetricMetadata&lt;/b&gt; metadata;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 指标下标签名称，可以当作是子指标&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final String[] &lt;b&gt;labelNames&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="720" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-46" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-45" target="ZjhWudJOdr6Pg1GAmp3d-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-45" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CallbackMetric&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;子类都会有一个回调方法（Consumer&amp;lt;Callback&amp;gt;），通过这个方法采集监控数据&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;此类型包含多种实现，下面只列了两种&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="880" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-48" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-47" target="ZjhWudJOdr6Pg1GAmp3d-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-47" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;GaugeWithCallback&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Consumer&amp;lt;Callback&amp;gt; &lt;b&gt;callback&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="1000" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-50" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-49" target="ZjhWudJOdr6Pg1GAmp3d-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-49" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CounterWithCallback&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Consumer&amp;lt;Callback&amp;gt; &lt;b&gt;callback&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-880" y="1000" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-52" target="ZjhWudJOdr6Pg1GAmp3d-43" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-240" y="840" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-100" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-52" target="ZjhWudJOdr6Pg1GAmp3d-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-52" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;StatefulMetric&amp;lt;D extends DataPoint, T extends D&amp;gt;&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 存储指标数据的容器，有状态的指标数据需要存储起来，后面在此基础上增量修改&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentHashMap&amp;lt;List&amp;lt;String&amp;gt;, T&amp;gt; &lt;b&gt;data&lt;/b&gt; = new ConcurrentHashMap();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile T &lt;b&gt;noLabels&lt;/b&gt;;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="880" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-55" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-54" target="ZjhWudJOdr6Pg1GAmp3d-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-54" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;Counter&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean &lt;b&gt;exemplarsEnabled&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExemplarSamplerConfig &lt;b&gt;exemplarSamplerConfig&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="1000" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-57" value="&lt;font color=&quot;#007fff&quot;&gt;将采集器注册到 &lt;br&gt;&lt;b&gt;PrometheusRegistry&lt;/b&gt; 单例对象&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="525" y="495" width="190" height="40" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-61" target="ZjhWudJOdr6Pg1GAmp3d-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-61" value="&lt;font color=&quot;#007fff&quot;&gt;// 创建 JDK HttpServer 实例&lt;/font&gt;&lt;br&gt;httpServer = HttpServer.&lt;b&gt;create&lt;/b&gt;(this.makeInetSocketAddress(), 3);&lt;br&gt;&lt;div&gt;ExecutorService executorService = this.makeExecutorService();&lt;/div&gt;&lt;div&gt;((HttpServer)httpServer).setExecutor(executorService);&lt;/div&gt;&lt;div&gt;return new &lt;b&gt;HTTPServer&lt;/b&gt;(this.config, executorService, (HttpServer)httpServer, this.registry, this.authenticator, this.defaultHandler);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="730" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-68" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-63" target="ZjhWudJOdr6Pg1GAmp3d-65" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="770" />
              <mxPoint x="1460" y="870" />
              <mxPoint x="260" y="870" />
              <mxPoint x="260" y="910" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-69" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-63" target="ZjhWudJOdr6Pg1GAmp3d-66" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="770" />
              <mxPoint x="1460" y="870" />
              <mxPoint x="260" y="870" />
              <mxPoint x="260" y="990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-70" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-63" target="ZjhWudJOdr6Pg1GAmp3d-67" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="770" />
              <mxPoint x="1460" y="870" />
              <mxPoint x="260" y="870" />
              <mxPoint x="260" y="1070" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-63" value="&lt;div&gt;this.server = httpServer;&lt;/div&gt;&lt;div&gt;this.executorService = executorService;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 注册了3个请求路由&lt;/font&gt;&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;registerHandler&lt;/b&gt;(&quot;&lt;b&gt;/&lt;/b&gt;&quot;, (HttpHandler)(defaultHandler == null ? new DefaultHandler() : defaultHandler), authenticator);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;registerHandler&lt;/b&gt;(&quot;&lt;b&gt;/metrics&lt;/b&gt;&quot;, new MetricsHandler(config, registry), authenticator);&lt;/div&gt;&lt;div&gt;this.&lt;b&gt;registerHandler&lt;/b&gt;(&quot;&lt;b&gt;/-/healthy&lt;/b&gt;&quot;, new HealthyHandler(), authenticator);&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;ExecutorService var10000 = this.executorService;&lt;/div&gt;&lt;div&gt;HttpServer var10001 = this.server;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// HTTPServer 启动&lt;/font&gt;&lt;/div&gt;&lt;div&gt;var10000.&lt;b&gt;submit&lt;/b&gt;(var10001::&lt;b&gt;start&lt;/b&gt;).get();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="690" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-65" value="&lt;div&gt;“/” -&amp;gt; &lt;b&gt;DefaultHandler&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;DefaultHandler 是默认的处理器, 处理逻辑只是返回一个固定的静态页面&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-73" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-66" target="ZjhWudJOdr6Pg1GAmp3d-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-66" value="&lt;div&gt;&lt;/div&gt;“/metrics” -&amp;gt;&amp;nbsp;&lt;b&gt;MetricsHandler&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="280" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-67" value="&lt;div&gt;“/-/healthy” -&amp;gt; &lt;b&gt;HealthyHandler&lt;/b&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-72" target="ZjhWudJOdr6Pg1GAmp3d-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-72" value="&lt;div&gt;&lt;/div&gt;this.&lt;b&gt;prometheusScrapeHandler&lt;/b&gt;&lt;br&gt;.&lt;b&gt;handleRequest&lt;/b&gt;(&lt;br&gt;new HttpExchangeAdapter(t));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;内部借助&amp;nbsp;PrometheusScrapeHandler 处理请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-74" target="ZjhWudJOdr6Pg1GAmp3d-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-74" value="&lt;div&gt;&lt;/div&gt;&lt;div&gt;PrometheusHttpRequest request = exchange.getRequest();&lt;/div&gt;&lt;div&gt;PrometheusHttpResponse response = exchange.getResponse();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 通过上面配置的收集器抓取监控数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;MetricSnapshots snapshots = this.&lt;b&gt;scrape&lt;/b&gt;(request);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 写响应&lt;/font&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;div&gt;ByteArrayOutputStream responseBuffer = new ByteArrayOutputStream(&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;this.lastResponseSize.get() + 1024);&lt;/div&gt;&lt;div&gt;String acceptHeader = request.getHeader(&quot;Accept&quot;);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// writer 写时执行序列化&lt;/font&gt;&lt;/div&gt;&lt;div&gt;ExpositionFormatWriter writer = this.expositionFormats.&lt;b&gt;findWriter&lt;/b&gt;(acceptHeader);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;writer.&lt;b&gt;write&lt;/b&gt;(responseBuffer, snapshots); &lt;font color=&quot;#007fff&quot;&gt;//后面再将Buffer数据写到 Response&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="760" y="910" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-76" value="PrometheusScrapeHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="895" y="880" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-82" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-78" target="ZjhWudJOdr6Pg1GAmp3d-81" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-78" value="&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;抓取流程添加一个名称过滤器，这说明&lt;b&gt;可以通过在请求中设置设个参数进行过滤数据&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;Predicate&amp;lt;String&amp;gt; filter = this.makeNameFilter(request.getParameterValues(&quot;name[]&quot;));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;遍历注册的所有数据采集器，抓取监控数据&lt;/font&gt;&lt;/div&gt;&lt;div&gt;return filter != null ? this.registry.&lt;b&gt;scrape&lt;/b&gt;(filter, request) : this.registry.&lt;b&gt;scrape&lt;/b&gt;(request);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1241" y="950" width="439" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-81" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;if (includedNames == null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return scrape(scrapeRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;MetricSnapshots.Builder &lt;b&gt;result&lt;/b&gt; = MetricSnapshots.builder();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;for&lt;/b&gt; (Collector collector : &lt;b&gt;collectors&lt;/b&gt;) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; String prometheusName = collector.getPrometheusName();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // prometheusName == null 采集器是通用采集器，即不需要通过 includedNames 过滤&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; if (prometheusName == null || includedNames.test(prometheusName)) {&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 调用各个采集器的监控数据采集方法&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetricSnapshot snapshot = scrapeRequest == null ? collector.&lt;b&gt;collect&lt;/b&gt;(includedNames) : &lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&amp;nbsp; &amp;nbsp; collector.&lt;b&gt;collect&lt;/b&gt;(includedNames, scrapeRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (snapshot != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result.metricSnapshot(snapshot);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;for&lt;/b&gt; (MultiCollector collector : &lt;b&gt;multiCollectors&lt;/b&gt;) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; List&amp;lt;String&amp;gt; prometheusNames = collector.getPrometheusNames();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // prometheusName == null 采集器是通用采集器，即不需要通过 includedNames 过滤&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; boolean excluded = !prometheusNames.isEmpty();&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; for (String prometheusName : prometheusNames) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (includedNames.test(prometheusName)) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; excluded = false;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (!excluded) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MetricSnapshots snapshots = scrapeRequest == null ? collector.&lt;b&gt;collect&lt;/b&gt;(includedNames) : &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; collector.&lt;b&gt;collect&lt;/b&gt;(includedNames, scrapeRequest);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (MetricSnapshot snapshot : snapshots) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (snapshot != null) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result.metricSnapshot(snapshot);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;return result.build();&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1720" y="950" width="440" height="410" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-86" value="重要概念说明：&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;ul style=&quot;&quot;&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;Exporter&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;即输出者，更准确地说是被封装的通信组件，负责数据上报，业务服务收集监控数据需要通过某种通信方式传给数据中心，client_java 中现在支持 HttpServer、Servlet、Pushgateway、Opentelemetry 四种方式。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;Instrumentation&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;封装了监控指标(Metric)的组件，负责数据采集。&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;Metric&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;监控指标，还是数据采集器（内部实现了 Collector 接口），定义指标类型、指标数据结构、以及采集方法。&lt;br&gt;关于指标类型测试参考 prometheus-client-01 中的单元测试。&lt;br&gt;&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;PrometheusRegistry&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;一系列监控指标的注册表，Instruemntation 组件中的监控指标或自定义的监控指标都要注册到这个单例对象，在数据采集时遍历所有监控指标（也是数据采集器）进行数据采集。&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="480" y="10" width="720" height="190" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-87" value="&lt;b&gt;Servlet Exporter&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-88" value="&lt;b&gt;Pushgateway&amp;nbsp;Exporter&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-89" value="&lt;b&gt;Opentelemetry&amp;nbsp;Exporter&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-90" target="ZjhWudJOdr6Pg1GAmp3d-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-90" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;MetricSnapshot (&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;A)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;指标数据快照&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;// 指标元数据信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MetricMetadata &lt;b&gt;metadata&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 监控指标数据列表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final List&amp;lt;? extends DataPointSnapshot&amp;gt; &lt;b&gt;dataPoints&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="440" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-92" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;DataPointSnapshot&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;A)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;指标数据点快照&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 指标标签&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Labels &lt;b&gt;labels&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;createdTimestampMillis&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final long &lt;b&gt;scrapeTimestampMillis&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="440" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-95" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-94" target="ZjhWudJOdr6Pg1GAmp3d-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-94" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CounterSnapshot&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;Counter指标数据快照&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;// 指标元数据信息&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final MetricMetadata &lt;b&gt;metadata&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;// 监控指标数据列表&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;protected final List&amp;lt;? extends DataPointSnapshot&amp;gt; &lt;b&gt;dataPoints&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-880" y="600" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-97" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-96" target="ZjhWudJOdr6Pg1GAmp3d-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-96" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CounterSnapshot$CounterDataPointSnapshot&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;b&gt;指标数据点快照&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;// 实际是用 double 存储的递增数据值&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final double &lt;b&gt;value&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Exemplar &lt;b&gt;exemplar&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1320" y="600" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-98" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;DataPoint&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;指标数据容器接口&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="880" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-101" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-99" target="ZjhWudJOdr6Pg1GAmp3d-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-99" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;CounterDataPoint&lt;/b&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;(I)&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;就是计数器&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void inc(double amount);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void incWithExemplar(double amount, Labels labels);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;double get();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;long getLongValue();&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-1760" y="1000" width="400" height="100" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-103" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=block;endFill=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-102" target="ZjhWudJOdr6Pg1GAmp3d-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-102" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b&gt;GaugeDataPoint&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;void inc(double amount);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void incWithExemplar(double amount, Labels labels);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default void dec(double amount);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;default void decWithExemplar(double amount, Labels labels);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void set(double value);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;void setWithExemplar(double value, Labels labels);&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;double get();&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-2200" y="1000" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-106" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-104" target="ZjhWudJOdr6Pg1GAmp3d-108" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="280" y="1490" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-104" value="&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp;Summary&amp;nbsp;&lt;/b&gt;&lt;b&gt;指标类型的数据收集原理&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里其实是涉及到一个&lt;b&gt;目标分位数问题，&lt;/b&gt;使用 CKMS 算法解决的&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-107" value="&lt;font color=&quot;#007fff&quot;&gt;这个算法直接看代码有点难以理解，&lt;br style=&quot;font-size: 10px;&quot;&gt;建议先看下目标分位数问题&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="1520" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-110" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-108" target="ZjhWudJOdr6Pg1GAmp3d-109" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-108" value="&lt;div&gt;这里通过源码 CKMSQuantilesTest#&lt;b&gt;testGet&lt;/b&gt;()&lt;/div&gt;&lt;div&gt;分析 CKMS 算法原理&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;为了方便测试，将 compresInterval 从128改为了8, 将误差设置为0.1&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="280" y="1460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-109" target="ZjhWudJOdr6Pg1GAmp3d-111" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-113" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-112" vertex="1" connectable="0">
          <mxGeometry x="0.1583" y="-1" relative="1" as="geometry">
            <mxPoint x="-1" y="-9" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-117" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.935;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-109" target="ZjhWudJOdr6Pg1GAmp3d-116" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-118" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-117" vertex="1" connectable="0">
          <mxGeometry x="0.808" y="-1" relative="1" as="geometry">
            <mxPoint x="1" y="55" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-109" value="&lt;font color=&quot;#007fff&quot;&gt;//注册1个0.5分位数，误差 0.1 （误差值越大，压缩程度越高）&lt;br&gt;&lt;/font&gt;&lt;div&gt;Quantile q50 = new Quantile(0.5, 0.1);&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;CKMSQuantiles ckms = new CKMSQuantiles(q50);&lt;/div&gt;CKMSQuantiles ckms = new CKMSQuantiles(q50, q95, q99);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//使用随机源打乱 1-16 对应的双精度浮点数列表，然后分两批插入 ckms&lt;/font&gt;&lt;br&gt;&lt;div&gt;Random random = new Random(0);&lt;/div&gt;&lt;div&gt;List&amp;lt;Double&amp;gt; input = shuffledValues(16, random);&lt;/div&gt;&lt;div&gt;for (int i = 0; i &amp;lt; 8; i++) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ckms.insert(input.get(i));&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;for (int i = 8; i &amp;lt; 16; i++) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ckms.insert(input.get(i));&lt;/div&gt;&lt;div&gt;}&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//校验每个分位数对应的观测值是否在允许的范围内&lt;/font&gt;&lt;/div&gt;&lt;div&gt;validateResults(ckms);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="520" y="1460" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-111" target="ZjhWudJOdr6Pg1GAmp3d-114" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-6" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-115" vertex="1" connectable="0">
          <mxGeometry x="0.3" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.003;entryY=0.59;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-111" target="4s08r3_KoatAhovvTcsq-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1460" y="1520" />
              <mxPoint x="1460" y="2052" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-12" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4s08r3_KoatAhovvTcsq-11" vertex="1" connectable="0">
          <mxGeometry x="0.8229" y="-2" relative="1" as="geometry">
            <mxPoint x="3" y="27" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-111" value="&lt;span style=&quot;background-color: initial;&quot;&gt;buffer[bufferPos++] = value;&lt;/span&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;// buffer 是固定大小的数组，默认size为128,即buffer 存满后会 flush()&lt;/font&gt;&lt;div&gt;if (bufferPos == buffer.length) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;flush&lt;/b&gt;();&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;//1 将 buffer 中的数据转移到 samples&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// 从上次压缩后插入观测值数量达到&amp;nbsp;compressInterval（默认128）执行压缩&lt;/font&gt;&lt;/div&gt;&lt;div&gt;if (++insertsSinceLastCompress == compressInterval) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;compress&lt;/b&gt;(); &lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//2 将差值不超过误差百分比的元素合并，这样可以减少samples中存储的元素个数&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; insertsSinceLastCompress = 0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1460" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-114" target="4s08r3_KoatAhovvTcsq-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-114" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//将数组中元素进行排序&lt;/font&gt;&lt;/div&gt;&lt;div&gt;Arrays.&lt;b&gt;sort&lt;/b&gt;(buffer, 0, bufferPos);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//批量合并到 samples&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;insertBatch&lt;/b&gt;(buffer, bufferPos);&lt;/div&gt;&lt;div&gt;bufferPos = 0;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=14;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1490" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1.003;exitY=0.111;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="ZjhWudJOdr6Pg1GAmp3d-116" target="ZjhWudJOdr6Pg1GAmp3d-119" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-121" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="ZjhWudJOdr6Pg1GAmp3d-120" vertex="1" connectable="0">
          <mxGeometry x="0.4923" y="3" relative="1" as="geometry">
            <mxPoint y="19" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-116" value="&lt;div&gt;for (Quantile q : ckms.quantiles) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; double actual = ckms.&lt;b&gt;get&lt;/b&gt;(q.quantile);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; double lowerBound, upperBound;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (q.quantile == 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lowerBound = 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; upperBound = 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else if (q.quantile == 1) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; lowerBound = ckms.n;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; upperBound = ckms.n;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;lowerBound = Math.floor(ckms.n * (q.quantile - 2 * q.epsilon));&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; upperBound = Math.ceil(ckms.n * (q.quantile + 2 * q.epsilon));&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; boolean ok =&lt;b&gt; actual &amp;gt;= lowerBound &amp;amp;&amp;amp; actual &amp;lt;= upperBound&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!ok) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (CKMSQuantiles.Sample sample : ckms.samples) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; System.err.println(sample);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; String errorMessage = q + &quot;: &quot; + actual + &quot; not in [&quot; + lowerBound + &quot;, &quot; + upperBound + &quot;], n=&quot; + ckms.n + &quot;, &quot; +&amp;nbsp; q.quantile + &quot;*&quot; + ckms.n + &quot;=&quot; + (q.quantile*ckms.n);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; assertTrue(errorMessage, ok);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2240" width="440" height="300" as="geometry" />
        </mxCell>
        <mxCell id="ZjhWudJOdr6Pg1GAmp3d-119" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;// 即get()前先执行一下flush操作，将buffer中的数据批量转移到 samples&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;flush&lt;/b&gt;();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 一些边界值的特殊处理，比如 0分位 1分位 samples为空&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int r = 0; // sum of g&#39;s left of the current sample&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 期望的观测值索引，比如 0.95 百分位，如果 samples 中有100个元素，就是取第95个观测值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 期望索引：如果有 50个元素就取第48个元素&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int &lt;b style=&quot;font-size: 9px;&quot;&gt;desiredRank&lt;/b&gt; = (int) Math.ceil(q * n);&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;// 上边界索引&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;int upperBound = desiredRank + &lt;b style=&quot;font-size: 9px;&quot;&gt;f(desiredRank) / 2&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;ListIterator&amp;lt;Sample&amp;gt; iterator = samples.listIterator();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;while (iterator.hasNext()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; Sample sample = iterator.next();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (&lt;b style=&quot;font-size: 9px;&quot;&gt;r + sample.g + sample.delta&lt;/b&gt; &amp;gt; upperBound) {&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//超过上边界索引就取前一个观测值&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iterator.previous(); // roll back the item.next() above&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (iterator.hasPrevious()) {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Sample result = iterator.previous();&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 9px;&quot;&gt;return&lt;/b&gt; result.value;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 9px;&quot;&gt;return&lt;/b&gt; sample.value;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b style=&quot;font-size: 9px;&quot;&gt;r += sample.g;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;}&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;return&lt;/b&gt; samples.getLast().value; &lt;font color=&quot;#007fff&quot;&gt;// 逻辑上应该获取 Sample 的 r 值，但是由于 r 值没有接口，且由于此测试的特殊性 r 和&amp;nbsp; value 相等，所以返回 value&amp;nbsp;代替 r&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=9;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2240" width="440" height="300" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4s08r3_KoatAhovvTcsq-1" target="4s08r3_KoatAhovvTcsq-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-1" value="&lt;div&gt;void &lt;b&gt;insertBatch&lt;/b&gt;(double[] sortedBuffer, int toIndex) { &lt;font color=&quot;#007fff&quot;&gt;// toIndex 即buffer中元素个数&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (toIndex == 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ListIterator&amp;lt;Sample&amp;gt; iterator = samples.listIterator();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int i = 0; // position in buffer&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int r = 0; // sum of g&#39;s left of the current sample&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 这里合并逻辑就是最常规能想到的合并方式&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; while (iterator.hasNext() &amp;amp;&amp;amp; i &amp;lt; toIndex) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Sample item = iterator.next();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; while (i &amp;lt; toIndex) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (sortedBuffer[i] &amp;gt; item.value) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 插入到旧值前面的新值的 delta = f(r) - 1&lt;/font&gt;&amp;nbsp;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; // 比如前面的例子 buffer 中的 2.0 插入到 5.0之前，此时r=1, delta =f(1)-1&lt;/font&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;insertBefore&lt;/b&gt;(iterator, sortedBuffer[i], &lt;b&gt;r&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r++; // new item with g=1 was inserted before, so increment r&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; i++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; n++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;r += item.g;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; while (i &amp;lt; toIndex) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; samples.add(new Sample(sortedBuffer[i], 0));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; i++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; n++;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1460" width="440" height="360" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="4s08r3_KoatAhovvTcsq-4" target="4s08r3_KoatAhovvTcsq-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-4" value="&lt;div&gt;private void insertBefore(ListIterator&amp;lt;Sample&amp;gt; iterator, double value, int r) {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; //被插入目标sample值前面没有更小的值，就直接插入链表头部即可&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!iterator.hasPrevious()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; samples.addFirst(new Sample(value, 0));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#007fff&quot;&gt;//找到上一个值，在其后面插入新值，&lt;b&gt;关键是这个 f(r) -1 是做什么的？&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iterator.previous();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iterator.add(new Sample(value, &lt;b&gt;f(r) - 1)&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iterator.next();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1560" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-7" value="&lt;font color=&quot;#007fff&quot;&gt;CKMS 算法直接从源码看不太容易理解数据结构中某些字段的含义，所以这里从测试数据入手，&lt;br&gt;对比这两批数据分别 flush() compress() 之后数据变化；&lt;br&gt;&lt;br&gt;&lt;b&gt;第一批数据 flush() 后，samples：&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;0 = {CKMSQuantiles$Sample@1427} &quot;Sample{val=1.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;1 = {CKMSQuantiles$Sample@1428} &quot;Sample{val=5.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;2 = {CKMSQuantiles$Sample@1429} &quot;Sample{val=6.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;3 = {CKMSQuantiles$Sample@1430} &quot;Sample{val=7.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;4 = {CKMSQuantiles$Sample@1431} &quot;Sample{val=8.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;5 = {CKMSQuantiles$Sample@1432} &quot;Sample{val=10.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;6 = {CKMSQuantiles$Sample@1433} &quot;Sample{val=11.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;7 = {CKMSQuantiles$Sample@1434} &quot;Sample{val=13.000, g=1, delta=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;第一批数据 compress() 后，samples：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;和上面一组数据比没有变化。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;第二批数据 flush() 后， samples：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;div&gt;&lt;div&gt;0 = {CKMSQuantiles$Sample@1206} &quot;Sample{val=1.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;1 = {CKMSQuantiles$Sample@1438} &quot;Sample{val=2.000, g=1, delta=1}&quot;&lt;/div&gt;&lt;div&gt;2 = {CKMSQuantiles$Sample@1439} &quot;Sample{val=3.000, g=1, delta=1}&quot;&lt;/div&gt;&lt;div&gt;3 = {CKMSQuantiles$Sample@1440} &quot;Sample{val=4.000, g=1, delta=1}&quot;&lt;/div&gt;&lt;div&gt;4 = {CKMSQuantiles$Sample@1207} &quot;Sample{val=5.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;5 = {CKMSQuantiles$Sample@1208} &quot;Sample{val=6.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;6 = {CKMSQuantiles$Sample@1209} &quot;Sample{val=7.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;7 = {CKMSQuantiles$Sample@1210} &quot;Sample{val=8.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;8 = {CKMSQuantiles$Sample@1441} &quot;Sample{val=9.000, g=1, delta=2}&quot;&lt;/div&gt;&lt;div&gt;9 = {CKMSQuantiles$Sample@1211} &quot;Sample{val=10.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;10 = {CKMSQuantiles$Sample@1212} &quot;Sample{val=11.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;11 = {CKMSQuantiles$Sample@1442} &quot;Sample{val=12.000, g=1, delta=3}&quot;&lt;/div&gt;&lt;div&gt;12 = {CKMSQuantiles$Sample@1213} &quot;Sample{val=13.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;13 = {CKMSQuantiles$Sample@1443} &quot;Sample{val=14.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;14 = {CKMSQuantiles$Sample@1444} &quot;Sample{val=15.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div&gt;15 = {CKMSQuantiles$Sample@1445} &quot;Sample{val=16.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;第二批数据 compress() 后，samples：&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;&quot;&gt;0 = {CKMSQuantiles$Sample@1206} &quot;Sample{val=1.000, g=1, delta=0}&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;1 = {CKMSQuantiles$Sample@1207} &quot;Sample{val=5.000, g=4, delta=0}&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;2 = {CKMSQuantiles$Sample@1210} &quot;Sample{val=8.000, g=3, delta=0}&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;3 = {CKMSQuantiles$Sample@1211} &quot;Sample{val=10.000, g=2, delta=0}&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;4 = {CKMSQuantiles$Sample@1213} &quot;Sample{val=13.000, g=3, delta=0}&quot;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;5 = {CKMSQuantiles$Sample@1442} &quot;Sample{val=16.000, g=3, delta=0}&quot;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1680" width="450" height="480" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-8" value="&lt;div&gt;&lt;b&gt;int f(int r)&lt;/b&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int minResult = Integer.MAX_VALUE;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; for (Quantile q : quantiles) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (q.quantile == 0 || q.quantile == 1) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; continue;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int result;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 以前面的例子第二批数据flush()，当 2.0 插入到 5.0 前面，r=1, quantile=0.5, n=8&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//delta 的计算方式：&lt;span style=&quot;&quot;&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //对于 r &amp;gt;= q.quantile * n 的元素， 即 &amp;gt;= 期望元素索引的元素&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // delta = (int) 2*epsilon*r/quantile - 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //对于 r &amp;lt; q.quantile * n 的元素&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // delta = (int) 2*epsilon*(n-r)/(1-quantile) - 1， 当前例子就是 delta = 1&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (r &amp;gt;= q.quantile * n) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = (int) (q.v * r + 0.00000000001);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result = (int) (q.u * (n - r) + 0.00000000001);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (result &amp;lt; minResult) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; minResult = result;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return Math.max(minResult, 1);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1480" width="440" height="320" as="geometry" />
        </mxCell>
        <mxCell id="4s08r3_KoatAhovvTcsq-10" value="&lt;div&gt;void &lt;b&gt;compress&lt;/b&gt;() {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (samples.size() &amp;lt; 3) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Iterator&amp;lt;Sample&amp;gt; descendingIterator = samples.descendingIterator();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 假设 1 2 3 4 5，从未压缩过，初始 r= 5&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int r = n; // n is equal to the sum of the g&#39;s of all samples&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Sample right; &lt;font color=&quot;#007fff&quot;&gt;//右值，即大值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Sample left = descendingIterator.next(); &lt;font color=&quot;#007fff&quot;&gt;//挨着右值的小值&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; r -= left.g;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt;// &lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;r 其实是元素在历史中所有被统计的元素中的索引，这里 r 指 left 元素的历史索引&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 倒序遍历，即从大值开始压缩&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; while (descendingIterator.hasNext()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; right = left;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; left = descendingIterator.next();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; r = r - left.g;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (left == samples.getFirst()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // The min sample must never be merged.&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 压缩条件：left.g + right.g + right.delta &amp;lt; f(r)&lt;/font&gt;&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;// 小值删除，大值的g加上小值的g，&amp;nbsp;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (&lt;b&gt;left.g + right.g + right.delta &amp;lt; f(r)&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; right.g += left.g;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; descendingIterator.remove();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; left = right;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1840" width="440" height="360" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
