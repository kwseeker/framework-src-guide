<mxfile host="Electron" modified="2024-09-24T16:24:43.705Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="tEpETI_pDL8f7fyQqOek" version="21.6.5" type="device">
  <diagram name="第 1 页" id="3BCMg9rv7oAUg7TkVLX5">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-1" value="&lt;h1&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;micrometer-registry-prometheus 工作原理（1.9.11）&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;测试代码: prometheus/spring-boot-prometheus-01。&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;SpringBoot 项目中只需要引入 `spring-boot-starter-actuator` 和 `micrometer-registry-prometheus` 就可以完成添加 `/actuator/prometheus` 端点，请求这个端点时就可以根据服务配置的组件抓取对应组件监控指标的数据。&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;代码太多，这里省略不重要的细节。&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="10" width="580" height="120" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-3" value="&lt;font style=&quot;font-size: 11px;&quot;&gt;研究目标：&lt;br&gt;&lt;/font&gt;&lt;ul style=&quot;border-color: var(--border-color); box-sizing: border-box; margin: 0.8em 0px; padding-left: 30px; position: relative; font-size: 10px;&quot; data-mark=&quot;+&quot; class=&quot;ul-list&quot;&gt;&lt;li style=&quot;border-color: var(--border-color); box-sizing: border-box; margin: 0px; position: relative;&quot; class=&quot;md-list-item md-focus-container&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); box-sizing: border-box; line-height: inherit; orphans: 4; margin: 0px 0px 0.5rem; position: relative;&quot; class=&quot;md-end-block md-p md-focus&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;code style=&quot;color: rgb(51, 51, 51); font-family: var(--monospace); font-size: 11px; border: 1px solid rgb(231, 234, 237); box-sizing: border-box; vertical-align: initial; background-color: rgb(243, 244, 244); border-radius: 3px; padding: 0px 2px;&quot;&gt;/actuator/prometheus&lt;/code&gt;&lt;font face=&quot;Open Sans, Clear Sans, Helvetica Neue, Helvetica, Arial, Segoe UI Emoji, sans-serif&quot; color=&quot;#333333&quot;&gt;&amp;nbsp;端点怎么注册的？&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; face=&quot;Open Sans, Clear Sans, Helvetica Neue, Helvetica, Arial, Segoe UI Emoji, sans-serif&quot;&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;是在 PrometheusScrapeEndpoint 中通过 @WebEndpoint 注册的，注册了一个 GET 请求接口。&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;/li&gt;&lt;li style=&quot;border-color: var(--border-color); box-sizing: border-box; margin: 0px; position: relative;&quot; class=&quot;md-list-item&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); box-sizing: border-box; line-height: inherit; orphans: 4; margin: 0px 0px 0.5rem; position: relative;&quot; class=&quot;md-end-block md-p&quot;&gt;&lt;span style=&quot;font-family: &amp;quot;Open Sans&amp;quot;, &amp;quot;Clear Sans&amp;quot;, &amp;quot;Helvetica Neue&amp;quot;, Helvetica, Arial, &amp;quot;Segoe UI Emoji&amp;quot;, sans-serif; font-size: 11px; border-color: var(--border-color); box-sizing: border-box;&quot; class=&quot;md-plain&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#333333&quot;&gt;Micrometer 怎么判断服务中有配置哪些组件以及怎么注册对应的数据采集器(MicrometerCollector)的？&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;不会主动判断有配置哪些组件，而是由spring-boot-actuator-autoconfigure 配置上所有组件的监控指标类，&lt;b&gt;通过自动配置类的条件注解判断是否加载这些组件的监控指标(采集器)Bean&lt;/b&gt;，&lt;br&gt;&lt;/font&gt;&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; face=&quot;Open Sans, Clear Sans, Helvetica Neue, Helvetica, Arial, Segoe UI Emoji, sans-serif&quot; color=&quot;#007fff&quot;&gt;然后通过 Spring ObjectProvider 获取这些监控指标类 Bean 实例，然后遍历依次注册到 Micrometer 监控指标注册表（CollectorRegistry）中。&lt;/font&gt;&lt;/p&gt;&lt;/li&gt;&lt;li style=&quot;font-family: &amp;quot;Open Sans&amp;quot;, &amp;quot;Clear Sans&amp;quot;, &amp;quot;Helvetica Neue&amp;quot;, Helvetica, Arial, &amp;quot;Segoe UI Emoji&amp;quot;, sans-serif; border-color: var(--border-color); box-sizing: border-box; margin: 0px; position: relative;&quot; class=&quot;md-list-item md-focus-container&quot;&gt;&lt;p style=&quot;border-color: var(--border-color); box-sizing: border-box; line-height: inherit; orphans: 4; margin: 0px 0px 0.5rem; position: relative;&quot; class=&quot;md-end-block md-p md-focus&quot;&gt;&lt;span style=&quot;border-color: var(--border-color); box-sizing: border-box;&quot; class=&quot;md-plain md-expand&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;监控数据抓取流程？&lt;font color=&quot;#007fff&quot;&gt;看下面请求处理流程&lt;/font&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="640" y="10" width="960" height="130" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-4" target="2RJNCP_tvgVEBhOXMB3c-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-4" target="2RJNCP_tvgVEBhOXMB3c-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="250" y="410" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-4" target="2RJNCP_tvgVEBhOXMB3c-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-4" value="&lt;b&gt;PrometheusMetricsExport&lt;/b&gt;&lt;br&gt;&lt;b&gt;AutoConfiguration&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;starter 本身是基于 Spring SPI 机制，直接搜索 Prometheus、Micrometer 的自动配置类可以找到这个自动配置类入口&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-52" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-5" target="2RJNCP_tvgVEBhOXMB3c-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-5" value="&lt;div&gt;@AutoConfiguration(&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这三个配置类用到再看&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; before = {&lt;b&gt;CompositeMeterRegistryAutoConfiguration&lt;/b&gt;.class, &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;SimpleMetricsExportAutoConfiguration&lt;/b&gt;.class},&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; after = {&lt;b&gt;MetricsAutoConfiguration&lt;/b&gt;.class}&lt;/div&gt;&lt;div&gt;)&lt;/div&gt;&lt;div&gt;@ConditionalOnBean({&lt;b&gt;Clock&lt;/b&gt;.class})&lt;/div&gt;&lt;div&gt;@ConditionalOnClass({&lt;b&gt;PrometheusMeterRegistry&lt;/b&gt;.class})&lt;/div&gt;&lt;div&gt;@&lt;b&gt;ConditionalOnEnabledMetricsExport&lt;/b&gt;(&quot;&lt;b&gt;prometheus&lt;/b&gt;&quot;)&lt;/div&gt;&lt;div&gt;@EnableConfigurationProperties({PrometheusProperties.class})&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-7" value="&lt;div&gt;&lt;b&gt;PrometheusMetricsExport&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;AutoConfiguration 的启用条件&lt;/b&gt;：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;创建了 Clock Bean，加载了 PrometheusMeterRegistry 类，&lt;/div&gt;&lt;div style=&quot;&quot;&gt;设置了 &#39;&lt;span style=&quot;background-color: initial;&quot;&gt;management.metrics.export.prometheus.enabled&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&#39; 配置项为 true&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="730" y="160" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-9" target="2RJNCP_tvgVEBhOXMB3c-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-9" target="2RJNCP_tvgVEBhOXMB3c-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-9" target="2RJNCP_tvgVEBhOXMB3c-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-9" target="2RJNCP_tvgVEBhOXMB3c-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-9" target="2RJNCP_tvgVEBhOXMB3c-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-9" value="&lt;b&gt;配置的Bean&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-10" value="&lt;b&gt;PrometheusConfig&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;实际是对 PrometheusProperties&lt;br&gt;做了一层适配&amp;nbsp;&lt;br&gt;PrometheusPropertiesConfigAdapter&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-63" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-12" target="2RJNCP_tvgVEBhOXMB3c-61" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1100" y="410" />
              <mxPoint x="1100" y="370" />
              <mxPoint x="1460" y="370" />
              <mxPoint x="1460" y="360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-12" value="&lt;b&gt;PrometheusMeterRegistry&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-14" value="&lt;b&gt;CollectorRegistry&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="460" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-16" value="&lt;b&gt;ExemplarSampler&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="540" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-17" value="&lt;b&gt;ExemplarSampler&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-18" value="&lt;b&gt;PrometheusPushGatewayConfiguration&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于支持短时任务的主动推送，用到再看&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-19" target="2RJNCP_tvgVEBhOXMB3c-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-19" target="2RJNCP_tvgVEBhOXMB3c-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-19" value="&lt;b&gt;内部配置类&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-24" target="2RJNCP_tvgVEBhOXMB3c-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-24" value="&lt;b&gt;PrometheusScrapeEndpointConfiguration&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;用于配置 prometheus 监控数据抓取端点&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="520" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-26" target="2RJNCP_tvgVEBhOXMB3c-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-26" value="&lt;b&gt;配置的Bean&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-28" target="2RJNCP_tvgVEBhOXMB3c-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-28" value="&lt;span&gt;&lt;b&gt;PrometheusScrapeEndpoint&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;这个Bean解释了 /actuator/prometheus 端点是怎么来的&lt;/font&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fontStyle=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1000" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-30" value="return new &lt;b&gt;PrometheusScrapeEndpoint&lt;/b&gt;(&lt;br&gt;&lt;b&gt;collectorRegistry&lt;/b&gt;);&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;内部通过 @WebEndpoint 定义了一个 支持 HTTP 请求的 “prometheus” 的端点，借助 @ReadOperation 注册了一个Get请求方法 scrape&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fontStyle=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-32" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PrometheusScrapeEndpoint&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Prometheus监控数据抓取端点&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private static final int METRICS_SCRAPE_CHARS_EXTRA = 1024;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CollectorRegistry &lt;b&gt;collectorRegistry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private volatile int nextMetricsScrapeSize = 16;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public WebEndpointResponse&amp;lt;String&amp;gt; &lt;b&gt;scrape&lt;/b&gt;(TextOutputFormat format, @Nullable Set&amp;lt;String&amp;gt; includedNames)&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="160" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-33" value="&lt;font color=&quot;#007fff&quot;&gt;关于 Actuator 平时用的很少，&lt;br&gt;关于&lt;b&gt;自定义端点&lt;/b&gt;，参考官方文档：&amp;nbsp;https://docs.spring.io/spring-boot/docs/2.7.12/reference/html/actuator.html#actuator.endpoints.implementing-custom&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1450" y="790" width="820" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-34" target="2RJNCP_tvgVEBhOXMB3c-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-34" value="请求 /actuator/prometheus&lt;br&gt;的处理流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-35" target="2RJNCP_tvgVEBhOXMB3c-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-35" value="从调用栈看也是借助 Servlet Web容器&lt;br&gt;处理请求，只不过处理器定义和 Controller有些差异" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-37" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;scrape:58, &lt;b&gt;PrometheusScrapeEndpoint&lt;/b&gt; (org.springframework.boot.actuate.metrics.export.prometheus)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;invoke:74, ReflectiveOperationInvoker (org.springframework.boot.actuate.endpoint.invoke.reflect)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;invoke:60, AbstractDiscoveredOperation (org.springframework.boot.actuate.endpoint.annotation)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handle:357, AbstractWebMvcEndpointHandlerMapping$ServletWebOperationAdapter (org.springframework.boot.actuate.endpoint.web.servlet)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handle:464, AbstractWebMvcEndpointHandlerMapping$&lt;b&gt;OperationHandler&lt;/b&gt; (org.springframework.boot.actuate.endpoint.web.servlet)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handleInternal:808, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handle:87, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;doDispatch:1072, DispatcherServlet (org.springframework.web.servlet)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;doService:965, &lt;b&gt;DispatcherServlet&lt;/b&gt; (org.springframework.web.servlet)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;service:623, HttpServlet (javax.servlet.http)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;doFilter:117, OncePerRequestFilter (org.springframework.web.filter)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;internalDoFilter:178, ApplicationFilterChain (org.apache.catalina.core)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;doFilter:153, &lt;b&gt;ApplicationFilterChain&lt;/b&gt; (org.apache.catalina.core)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;run:659, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;run:833, Thread (java.lang)&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="280" y="1280" width="660" height="270" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-38" target="2RJNCP_tvgVEBhOXMB3c-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-38" value="PrometheusScrapeEndpoint#&lt;b&gt;scrape&lt;/b&gt;(&lt;br&gt;TextOutputFormat format, @Nullable Set&amp;lt;String&amp;gt; includedNames)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;参数解析类似 Controller 的处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-40" target="2RJNCP_tvgVEBhOXMB3c-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-40" value="Enumeration&amp;lt;Collector.&lt;b&gt;MetricFamilySamples&lt;/b&gt;&amp;gt; samples = includedNames != null ? this.collectorRegistry.&lt;b&gt;filteredMetricFamilySamples&lt;/b&gt;(includedNames) : this.collectorRegistry.&lt;b&gt;metricFamilySamples&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如果有传递指标名称按指标名称选择抓取数据，否则抓取所有数据&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1200" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-42" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MetricFamilySamples&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;Prometheus监控指标样本数据&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final String name;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final String unit;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final Type type;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final String help;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public final List&amp;lt;Sample&amp;gt; samples;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="880" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-43" target="2RJNCP_tvgVEBhOXMB3c-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-47" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="2RJNCP_tvgVEBhOXMB3c-46" vertex="1" connectable="0">
          <mxGeometry x="-0.15" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-43" value="return new MetricFamilySamplesEnumeration();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个类本质是样本数据的迭代器, 后面只展示抓取所有指标类型数据的逻辑，忽略抓取特定类型指标&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1200" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-45" target="2RJNCP_tvgVEBhOXMB3c-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-45" value="return CollectorRegistry.this.collectors().iterator();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;先获取采集器注册列表的迭代器，&lt;br&gt;&lt;b&gt;反向搜索发现这些 MicrometerCollector 都是在&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;b style=&quot;border-color: var(--border-color); text-align: center;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;PrometheusMeterRegistry Bean初始化后由&amp;nbsp;MeterRegistryPostProcessor 注册进去的&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1200" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-48" target="AcnWhzOrEoILhtYzEsHf-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1940" y="1310" />
              <mxPoint x="1940" y="1580" />
              <mxPoint x="260" y="1580" />
              <mxPoint x="260" y="1630" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-48" value="while(this.collectorIter.hasNext()) {&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;this.metricFamilySamples = ((Collector)this.collectorIter.next())&lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.&lt;b&gt;collect&lt;/b&gt;(this.sampleNameFilter).iterator();&lt;br&gt;}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;遍历采集器，分别执行采集器的 collect() 方法进行数据采集&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1280" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-50" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;本测试用例中启动的采集器列表，注意有些采集器并不是服务启动时就注册的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;namesToCollectors&lt;/b&gt; = {HashMap@8441}&amp;nbsp; size = 66&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;executor_active_threads&quot; -&amp;gt; {MicrometerCollector@8456}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;tomcat_sessions_created_sessions_total&quot; -&amp;gt; {MicrometerCollector@8579}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;tomcat_sessions_rejected_sessions&quot; -&amp;gt; {MicrometerCollector@8589}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_memory_usage_after_gc_percent&quot; -&amp;gt; {MicrometerCollector@8549}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_gc_memory_promoted_bytes_total&quot; -&amp;gt; {MicrometerCollector@8509}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;executor_pool_max_threads&quot; -&amp;gt; {MicrometerCollector@8553}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;executor_queued_tasks&quot; -&amp;gt; {MicrometerCollector@8571}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_classes_unloaded_classes_total&quot; -&amp;gt; {MicrometerCollector@8573}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;executor_pool_core_threads&quot; -&amp;gt; {MicrometerCollector@8583}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;disk_free_bytes&quot; -&amp;gt; {MicrometerCollector@8541}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_gc_memory_promoted_bytes&quot; -&amp;gt; {MicrometerCollector@8509}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_gc_memory_promoted_bytes_created&quot; -&amp;gt; {MicrometerCollector@8509}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_gc_pause_seconds_bucket&quot; -&amp;gt; {MicrometerCollector@8569}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_gc_pause_seconds_created&quot; -&amp;gt; {MicrometerCollector@8569}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_buffer_count_buffers&quot; -&amp;gt; {MicrometerCollector@8567}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;jvm_classes_unloaded_classes&quot; -&amp;gt; {MicrometerCollector@8573}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;disk_total_bytes&quot; -&amp;gt; {MicrometerCollector@8531}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1200" width="440" height="300" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-54" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-51" target="2RJNCP_tvgVEBhOXMB3c-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-51" value="&lt;b&gt;MetricsAutoConfiguration&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-53" target="2RJNCP_tvgVEBhOXMB3c-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-58" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-53" target="2RJNCP_tvgVEBhOXMB3c-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-60" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-53" target="2RJNCP_tvgVEBhOXMB3c-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-53" value="&lt;b&gt;配置的Bean&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-55" value="&lt;b&gt;Clock&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-57" target="2RJNCP_tvgVEBhOXMB3c-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-57" value="&lt;b&gt;MeterRegistryPostProcessor&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="300" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-59" value="&lt;b&gt;PropertiesMeterFilter&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="380" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-65" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-61" target="2RJNCP_tvgVEBhOXMB3c-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-61" value="&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// MeterRegistry类型Bean后置处理逻辑&lt;/font&gt;&lt;/div&gt;&lt;div&gt;public Object &lt;b&gt;postProcessAfterInitialization&lt;/b&gt;(Object bean, String beanName) throws BeansException {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (bean instanceof &lt;b&gt;MeterRegistry&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;// 这里创建了 MeterRegistryConfigurer, 其 binders 保存了一组配置的监控指标，configure() 中会将这些监控指标绑定（注册）到 MeterRegistry (这里是 PrometheusMeterRegistry),&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;getConfigurer&lt;/b&gt;().&lt;b&gt;configure&lt;/b&gt;((MeterRegistry)&lt;b&gt;bean&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return bean;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="270" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-67" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-64" target="2RJNCP_tvgVEBhOXMB3c-66" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-64" value="&lt;div&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;// binders (ObjectProvider&amp;lt;MeterBinder&amp;gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;) 哪里来的？来自于&amp;nbsp;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;MeterRegistryPostProcessor Bean实例化时由 Spring 注入&lt;/font&gt;&lt;div&gt;this.&lt;b&gt;binders&lt;/b&gt;.orderedStream().forEach((binder) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 通过 binder 可以获取比如 JvmGcMetrics&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 里面并不是只有一个采集器，而是包含多种指标类型的多个采集器&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; binder.&lt;b&gt;bindTo&lt;/b&gt;(registry);&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1960" y="270" width="240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-66" target="2RJNCP_tvgVEBhOXMB3c-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-71" value="..." style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="2RJNCP_tvgVEBhOXMB3c-70" vertex="1" connectable="0">
          <mxGeometry x="0.019" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-66" value="&lt;b&gt;Gauge&lt;/b&gt;.builder(&quot;&lt;b&gt;jvm.gc.max.data.size&lt;/b&gt;&quot;, this.maxDataSize, AtomicLong::get)&lt;br&gt;&amp;nbsp; &amp;nbsp; .tags(this.tags)&lt;br&gt;&amp;nbsp; &amp;nbsp; .description(&quot;Max size of long-lived heap memory pool&quot;)&lt;br&gt;&amp;nbsp; &amp;nbsp; .baseUnit(&quot;bytes&quot;)&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;register&lt;/b&gt;(registry);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里展示的是 JvmGcMetrics 中其中一个采集器的注册方法&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="2240" y="290" width="439" height="80" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-68" value="&lt;font color=&quot;#007fff&quot;&gt;像 Prometheus client_java 中的 XxxMetrics 类中&lt;br&gt;也是基本都不只一个采集器&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1960" y="400" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-69" target="2RJNCP_tvgVEBhOXMB3c-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2939" y="980" />
              <mxPoint x="1700" y="980" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-3" value="&lt;font color=&quot;#007fff&quot;&gt;collector来源&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="2RJNCP_tvgVEBhOXMB3c-75" vertex="1" connectable="0">
          <mxGeometry x="0.9739" y="-1" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-69" value="MicrometerCollector micrometerCollector = new &lt;b&gt;MicrometerCollector&lt;/b&gt;(&lt;br&gt;&amp;nbsp; &amp;nbsp; id, this.config().namingConvention(), this.prometheusConfig);&lt;br&gt;return (MicrometerCollector)micrometerCollector.&lt;b&gt;register&lt;/b&gt;(this.registry);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2720" y="290" width="439" height="80" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-74" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endArrow=open;endFill=0;" parent="1" source="2RJNCP_tvgVEBhOXMB3c-72" target="2RJNCP_tvgVEBhOXMB3c-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-72" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;PrometheusMeterRegistry&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;extends MeterRegistry&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final PrometheusConfig &lt;b&gt;prometheusConfig&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 数据采集器注册表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final CollectorRegistry &lt;b&gt;registry&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 数据采集器列表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ConcurrentMap&amp;lt;String, MicrometerCollector&amp;gt; &lt;b&gt;collectorMap&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;@Nullable&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ExemplarSampler &lt;b&gt;exemplarSampler&lt;/b&gt;;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-440" y="360" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2RJNCP_tvgVEBhOXMB3c-73" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;CollectorRegistry&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 单例模式&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;public static final CollectorRegistry &lt;b&gt;defaultRegistry&lt;/b&gt; = new CollectorRegistry(true);&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Object namesCollectorsLock;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;Collector, List&amp;lt;String&amp;gt;&amp;gt; &lt;b&gt;collectorsToNames&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final Map&amp;lt;String, Collector&amp;gt; &lt;b&gt;namesToCollectors&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean autoDescribe;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-880" y="360" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-1" value="MeterRegistryConfigurer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2005" y="240" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-2" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;MeterRegistryConfigurer&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ObjectProvider&amp;lt;MeterRegistryCustomizer&amp;lt;?&amp;gt;&amp;gt; customizers;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final ObjectProvider&amp;lt;MeterFilter&amp;gt; filters;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// 监控指标类 XxxMetrics 均实现 MeterBinder&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;接口表示将指标类注册到指标列表&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final &lt;b&gt;ObjectProvider&lt;/b&gt;&amp;lt;&lt;b&gt;MeterBinder&lt;/b&gt;&amp;gt; &lt;b&gt;binders&lt;/b&gt;;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean addToGlobalRegistry;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;private final boolean hasCompositeMeterRegistry;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-440" y="560" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" target="M3NdE1Tfr5OQvT6ozvzQ-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="910" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-3" target="M3NdE1Tfr5OQvT6ozvzQ-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-27" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-3" target="M3NdE1Tfr5OQvT6ozvzQ-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-3" value="&lt;b&gt;XxxMetrics&lt;/b&gt;&lt;b&gt;AutoConfiguration&lt;br&gt;&lt;/b&gt;&lt;font color=&quot;#007fff&quot;&gt;通过调试可以发现实际项目中 micrometer-registry-prometheus&amp;nbsp;监控指标可能有很多，比如 Jvm、Cache、连接池、Mongo、Kafka 等等，它们都拥有自己的自动配置类&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-4" target="M3NdE1Tfr5OQvT6ozvzQ-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-4" value="&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;JvmMetricsAutoConfiguration&lt;/b&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;不太典型，只要启动 acutatuor 这个监控一定会配置进去&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=-0.004;entryY=0.398;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;entryPerimeter=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-6" target="2RJNCP_tvgVEBhOXMB3c-64" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-6" value="&lt;b&gt;binders 来源&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1720" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-8" value="&lt;div&gt;@AutoConfiguration(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; after = {CompositeMeterRegistryAutoConfiguration.class}&lt;/div&gt;&lt;div&gt;)&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;//条件： Web应用、两个类被加载、引入Micrometer采集器&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;@&lt;b&gt;ConditionalOnWebApplication&lt;/b&gt;&lt;/div&gt;&lt;div&gt;@&lt;b&gt;ConditionalOnClass&lt;/b&gt;({&lt;b&gt;JettyServerThreadPoolMetrics&lt;/b&gt;.class, &lt;b&gt;Server&lt;/b&gt;.class})&lt;/div&gt;&lt;div&gt;@&lt;b&gt;ConditionalOnBean&lt;/b&gt;({&lt;b&gt;MeterRegistry&lt;/b&gt;.class})&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="950" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-10" target="M3NdE1Tfr5OQvT6ozvzQ-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-10" target="M3NdE1Tfr5OQvT6ozvzQ-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-10" value="&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;JettyMetricsAutoConfiguration&lt;/b&gt;&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#007fff&quot;&gt;以 Jetty 监控指标为例，分析它是怎么整合到项目中的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-16" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-14" target="M3NdE1Tfr5OQvT6ozvzQ-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1680" y="910" />
              <mxPoint x="1680" y="510" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-17" value="&lt;font color=&quot;#007fff&quot;&gt;配置了5组 MetricsBinder&lt;br&gt;每组中可能不只注册一个监控指标&lt;br&gt;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="M3NdE1Tfr5OQvT6ozvzQ-16" vertex="1" connectable="0">
          <mxGeometry x="-0.9325" y="-1" relative="1" as="geometry">
            <mxPoint x="63" y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-14" value="JvmGcMetrics&amp;nbsp;&lt;br&gt;JvmHeapPressureMetrics&lt;br&gt;JvmMemoryMetrics&lt;br&gt;JvmThreadMetrics&lt;br&gt;ClassLoaderMetrics" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-18" target="M3NdE1Tfr5OQvT6ozvzQ-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-18" value="&lt;span style=&quot;border-color: var(--border-color);&quot;&gt;JettyServerThreadPoolMetricsBinder&lt;br&gt;&lt;/span&gt;JettyConnectionMetricsBinder&lt;br&gt;JettySslHandshakeMetricsBinder&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;注入3组监控指标注册器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1050" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-20" value="&lt;font color=&quot;#007fff&quot;&gt;这些类额外实现了 Spring ApplicationListener 接口，&lt;br&gt;为了实现&lt;b&gt;延迟注册监控&lt;/b&gt;： Jetty Server 启动后才真正注册监控&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="520" y="1120" width="350" height="40" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" source="M3NdE1Tfr5OQvT6ozvzQ-22" target="M3NdE1Tfr5OQvT6ozvzQ-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1240" y="1080" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1680" y="1080" />
              <mxPoint x="1680" y="510" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-22" value="&lt;div&gt;public void onApplicationEvent(ApplicationStartedEvent event) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Server server = this.findServer(event.getApplicationContext());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (server != null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this.&lt;b&gt;bindMetrics&lt;/b&gt;(server);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1040" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="M3NdE1Tfr5OQvT6ozvzQ-26" value="&lt;b&gt;...&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-1" target="AcnWhzOrEoILhtYzEsHf-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-1" target="AcnWhzOrEoILhtYzEsHf-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-1" value="以 http_server_requests_secods&lt;br&gt;为例分析对应的采集器注册与数据采集原理" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="280" y="1600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-2" value="CollectorRegistry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1285" y="1170" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-5" value="&lt;font color=&quot;#007fff&quot;&gt;application.yml 中的配置：（开启百分数累积直方图统计）&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; metrics:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; export:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; prometheus:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; enabled: true&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; distribution:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; percentiles-histogram:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; http:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; server:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requests: true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; percentiles:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; http:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; server:&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; requests: 0.5,0.9,0.99&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="150" y="1660" width="330" height="230" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-6" target="AcnWhzOrEoILhtYzEsHf-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-6" value="对应的 MicrometerCollector &lt;br&gt;&lt;b&gt;注册&lt;/b&gt;以及&lt;b&gt;数据记录&lt;/b&gt;流程" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="1600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-8" target="iqQxOjer_wQQzseKLDAx-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-8" value="对应的 MicrometerCollector &lt;br&gt;数据采集流程&lt;br&gt;MicrometerCollector#&lt;b&gt;collect&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="2000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-10" target="AcnWhzOrEoILhtYzEsHf-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-15" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-10" target="AcnWhzOrEoILhtYzEsHf-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-10" value="&lt;b&gt;WebMvcMetricsAutoConfiguration&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;通过此自动配置类加载&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="760" y="1600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-12" value="&lt;b&gt;@EnableConfigurationProperties(MetricsProperties.class)&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;将前面的配置加载到此自动配置类的&amp;nbsp;&lt;b&gt;MetricsProperties&lt;/b&gt; &lt;b&gt;properties&lt;/b&gt;;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1600" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-14" target="AcnWhzOrEoILhtYzEsHf-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-21" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-14" target="AcnWhzOrEoILhtYzEsHf-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-22" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-14" target="AcnWhzOrEoILhtYzEsHf-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-23" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-14" target="AcnWhzOrEoILhtYzEsHf-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-14" value="&lt;b&gt;配置创建4个Bean&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-16" value="&lt;b&gt;DefaultWebMvcTagsProvider&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-18" target="AcnWhzOrEoILhtYzEsHf-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-18" value="&lt;b&gt;FilterRegistrationBean&amp;lt;&lt;br&gt;WebMvcMetricsFilter&amp;gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;注意这个Filter是拦截请求的过滤器，不是MeterFilter&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-19" value="&lt;b&gt;MeterFilter&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-20" value="&lt;b&gt;MetricsWebMvcConfigurer&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过拦截器的方式注册了一个LongTaskTimer 类型监控指标&lt;/font&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-24" value="&lt;font color=&quot;#007fff&quot;&gt;这个采集器的注册有点隐秘，&lt;br&gt;找了好久（jar包反编译源码IDEA好像无法搜索），&lt;br&gt;其实如果能把源码下载下来直接&lt;br&gt;搜源码应该很好找&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="740" y="1660" width="290" height="70" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-25" target="AcnWhzOrEoILhtYzEsHf-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-25" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;filterChain&lt;/b&gt;.doFilter(request, response);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;...&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.&lt;b&gt;record&lt;/b&gt;(timingContext, request, response, exception);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;拦截请求进行请求耗时记录&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-27" value="WebMvcMetricsFilter" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1510" y="1730" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-28" target="AcnWhzOrEoILhtYzEsHf-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-32" value="1" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AcnWhzOrEoILhtYzEsHf-31" vertex="1" connectable="0">
          <mxGeometry x="0.1" y="-3" relative="1" as="geometry">
            <mxPoint x="8" y="-3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-34" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="AcnWhzOrEoILhtYzEsHf-28" target="AcnWhzOrEoILhtYzEsHf-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-35" value="2" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="AcnWhzOrEoILhtYzEsHf-34" vertex="1" connectable="0">
          <mxGeometry x="0.75" y="-2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-28" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;Object handler = this.getHandler(request);&lt;/div&gt;&lt;div&gt;Set&amp;lt;Timed&amp;gt; &lt;b&gt;annotations&lt;/b&gt; = this.getTimedAnnotations(handler);&lt;/div&gt;&lt;div&gt;Timer.Sample &lt;b&gt;timerSample&lt;/b&gt; = timingContext.getTimerSample();&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// autoTimer 是 AutoTimerProperties 实例， apply() 方法中通过 Timer.builder 创建&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;AutoTimer&lt;/b&gt;.&lt;b&gt;apply&lt;/b&gt;(this.autoTimer, this.metricName, annotations, (builder) -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; // 不存在则创建了一个 Timer 指标类型&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; timerSample.&lt;b&gt;stop&lt;/b&gt;(this.&lt;b&gt;getTimer&lt;/b&gt;(builder, handler, request, response, exception));&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1740" width="440" height="100" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="AcnWhzOrEoILhtYzEsHf-30" target="iqQxOjer_wQQzseKLDAx-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-30" value="&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;// builder 是&amp;nbsp;&amp;nbsp;Timer.builder(name) 创建&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;return builder.&lt;b&gt;description&lt;/b&gt;(&quot;Duration of HTTP server request handling&quot;)&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;tags&lt;/b&gt;(this.tagsProvider.getTags(request, response, handler, exception))&lt;br&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;register&lt;/b&gt;(this.registry);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;创建一个 Timer指标类型并注册到&amp;nbsp;MeterRegistry，这里实际类型是 PrometheusMeterRegistry&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1760" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="AcnWhzOrEoILhtYzEsHf-33" value="&lt;div style=&quot;&quot;&gt;&lt;div&gt;public long stop(Timer timer) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; long durationNs = this.clock.monotonicTime() - this.startTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; timer.&lt;b&gt;record&lt;/b&gt;(durationNs, TimeUnit.NANOSECONDS);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return durationNs;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1840" width="440" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-2" value="&lt;font color=&quot;#007fff&quot;&gt;代码有点乱：&lt;br&gt;1 先通过 AutoTimer builder() 创建 Timer.Builder (Micrometer 的类)&lt;br&gt;2 调用 Consumer 方法，&lt;br&gt;3 Consumer 方法中分为两部分，&lt;br&gt;getTimer 方法中通过 MeterRegistry 调用 PrometheusMeterRegistry 创建 PrometheusTimer, &lt;br&gt;stop 方法则向 PrometheusTimer 中记录接口耗时&amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;background-color: initial;&quot; color=&quot;#007fff&quot;&gt;PrometheusTimer 和 Micrometer&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;b&gt;CumulativeTimer &lt;/b&gt;实现类似。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;统计的数据中有5种标签都是这个 &lt;b&gt;PrometheusTimer&lt;/b&gt; 指标记录的：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;http_server_requests_seconds&lt;br style=&quot;border-color: var(--border-color); color: rgb(0, 0, 0);&quot;&gt;http_server_requests_seconds_bucket&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;http_server_requests_seconds_count&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;http_server_requests_seconds_sum&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;span style=&quot;border-color: var(--border-color); background-color: initial;&quot;&gt;http_server_requests_seconds_max&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1850" width="510" height="230" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-3" value="" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="2000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-5" value="&lt;div style=&quot;&quot;&gt;MicrometerCollector micrometerCollector = new &lt;b&gt;MicrometerCollector&lt;/b&gt;(id, this.config().namingConvention(), this.prometheusConfig);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;还会创建 MicrometerCollector 注册到&amp;nbsp;PrometheusMeterRegistry CollectorRegistry&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1760" width="439" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iqQxOjer_wQQzseKLDAx-7" value="PrometheusMeterRegistry" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="2819.5" y="1730" width="160" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
